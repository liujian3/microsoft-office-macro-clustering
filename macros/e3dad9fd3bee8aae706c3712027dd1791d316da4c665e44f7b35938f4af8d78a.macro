Attribute VB_Name = "DieseArbeitsmappe"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

Attribute VB_Name = "Modul1"

'der Tabelle vorgeschaltet
Public Function vortab(vz As Single, heirat As Single, zve As Double, ek34 As Single, progek As Single, art As Single) As Double
Dim zve1 As Double, ges_st As Double, runder As Double
'
zve_eingabe = zve       'man kann nie wissen wof|fffd|r
zve_1 = zve
If vz <= 2001 Then
    runder = heirat * 54  'ggf 108
End If
If vz = 2002 Then
    runder = heirat * 36
End If
If progek = 0 And ek34 = 0 Then
    If vz <= 2000 Then
        abnachtab1 = Fix(zve_1 / runder) * runder
    End If
    If vz = 2001 Then  'DM
        abnachtab1 = Fix(zve_1 / runder) * runder + heirat * 27
    End If
    If vz = 2002 Then  'Euro !!
        abnachtab1 = Fix(zve_1 / runder) * runder + heirat * 18
    End If
    If vz >= 2003 Then       'Keine Rundung mehr
      abnachtab1 = Fix(zve_1)
    End If
    zve = abnachtab1
    erg1 = esttab(vz, heirat, zve)
    'Ergebnis:
    vortab = erg1
    If art <> 1 Then  'wenn weder Progression oder |fffd| 34
            vortab = 0
    End If
    'vortab = 1111
Else
'Mit Progressionseink|fffd|nften - Mit beg|fffd|nstigtem Steuersatz
    If vz < 1999 Then                      'hier noch halber Steuersatz
        su1 = zve_1 + progek               'zve + Progressionseink|fffd|nfte
        abnachtab1 = Fix(su1 / runder) * runder '
        zve = abnachtab1
        erg1 = esttab(vz, heirat, zve)
        stsatz1# = erg1 / abnachtab1 * 100   'Steuersatz mit Progressionseink
        st1_2satz# = stsatz1# / 2           ' = halber Steuersatz
        st1_2 = Fix(st1_2satz * ek34 / 100) ' = halbe Steuer
    '
        'If ek34 <> 0 Then
        su2 = zve_1 + progek - ek34                  'abz|fffd|glich Eink. mit halben steuersatz
        abnachtab = Fix(su2 / runder) * runder '
        zve = abnachtab
        erg2 = esttab(vz, heirat, zve)
        stsatz2# = erg2 / abnachtab * 100   '= Steuersatz f|fffd|r normale Eink|fffd|nfte
        'End If
        rest_ek = zve_1 - ek34
        ogr = Fix(rest_ek / runder) * runder '
        st_rest = Fix(ogr * stsatz2# / 100)
        '=Steuer f|fffd|r normale Eink|fffd|nfte
    
        steuer = st_rest + st1_2       '= Steuer gesamt
        If st1_2 <> 0 Then
            steuer = steuer - st1_2     'f|fffd|r getrennte ausgabe ganze u, erm|fffd||fffd|. Steuer
        End If
        ges_st = st_rest + st1_2
    '
        Select Case art
        Case 1
                vortab = steuer
        Case 2
                vortab = st1_2
        Case 3
            vortab = stsatz1#
        Case 4
            vortab = st1_2satz#
        Case 5
            vortab = stsatz2#
        Case 6
            vortab = ges_st   ' f|fffd|r st_mj_v99
        Case Else
        End Select
        
    'vortab = abnachtab1
    'vortab = stsatz2#
    'vortab = runder
    'vortab = rest_ek
    'vortab = erg1
    'vortab = st_rest
     'vortab = ogr * stsatz2 / 100
    End If  'vz<1999
    '
    'Steuer auf ek34 = eink|fffd|nfte / 5---Steuer*5
    If vz >= 1999 Then
        su1 = zve_1 + progek - ek34             'zve + Progressionseink|fffd|nfte - ek34
        If vz <= 2000 Then
            abnachtab = Fix(su1 / runder) * runder '
            'test = abnachtab
        End If
        If vz = 2001 Then      'DM
            abnachtab = Fix(su1 / runder) * runder + (heirat * 27) 'Steuer in der Mitte der Tabellenstufe
        test = abnachtab
        End If
        If vz = 2002 Then    'Euro
            abnachtab = Fix(su1 / runder) * runder + (heirat * 18) 'Steuer in der Mitte der Tabellenstufe
        test = abnachtab
        End If
      
        If vz >= 2003 Then
            abnachtab = su1  'wegen unter ! auch abnachtab
        End If
        zve = abnachtab
        erg1 = esttab(vz, heirat, zve)
        stsatz1# = erg1 / abnachtab * 100        'Steuersatz mit Progressionseink
        '
        su2 = su1 + Fix(ek34 / 5)             'eink|fffd|nfte ggf. mit Progr zuz|fffd|glich 1/5 ek34
        If vz <= 2000 Then
            abnachtab = Fix(su2 / runder) * runder '
        End If
        If vz = 2001 Then
            abnachtab = Fix(su2 / runder) * runder + (heirat * 27) 'Steuer in der Mitte der Tabellenstufe
        End If
        If vz = 2002 Then  'Euro
            abnachtab = Fix(su2 / runder) * runder + (heirat * 18) 'Steuer in der Mitte der Tabellenstufe
        End If
        If vz >= 2003 Then
            abnachtab = su2  'wegen unter ! auch abnachtab
        End If
        zve = abnachtab
        erg2 = esttab(vz, heirat, zve)
        stsatz2# = erg2 / abnachtab * 100       'steuersatz mit ek34/5
        '
        su3 = zve_1 - ek34
        'bem1 = Fix(su3 / runder) * runder
        If vz <= 2000 Then
            bem1 = Fix(su3 / runder) * runder
        End If
        If vz = 2001 Then
            bem1 = Fix(su3 / runder) * runder + (heirat * 27) 'Steuer in der Mitte der Tabellenstufe
        End If
        If vz = 2002 Then 'Euro !!!
            bem1 = Fix(su3 / runder) * runder + (heirat * 18) 'Steuer in der Mitte der Tabellenstufe
        End If
        If vz >= 2003 Then
            bem1 = su3
        End If
        steuer1 = Fix(bem1 * stsatz1 / 100) 'Steuer ohne ek34
        '
        su4 = su3 + Fix(ek34 / 5)
        'bem2 = Fix(su4 / runder) * runder '
        If vz <= 2000 Then
            bem2 = Fix(su4 / runder) * runder
        End If
        If vz = 2001 Then
            bem2 = Fix(su4 / runder) * runder + (heirat * 27) 'Steuer in der Mitte der Tabellenstufe
        End If
        If vz = 2002 Then  'euro!!
            bem2 = Fix(su4 / runder) * runder + (heirat * 18) 'Steuer in der Mitte der Tabellenstufe
        End If
        
        If vz >= 2003 Then
            bem2 = su4
        End If
        steuer2 = Fix(bem2 * stsatz2 / 100) 'Steuer + ek34/5
        '
        diff = steuer2 - steuer1
        st_auf_ek34 = diff * 5              '
    
        steuer = steuer1 + st_auf_ek34       '= Steuer gesamt
    
        If st_auf_ek34 <> 0 Then
            steuer = steuer1      'f|fffd|r getrennte ausgabe ganze u, erm|fffd||fffd|. Steuer
        End If
    
        'vortab = steuer
        Select Case art
            Case 1
                vortab = steuer
            Case 2
                vortab = st_auf_ek34
            Case 3
                vortab = stsatz1#               'Steuersatz mit Progressionseink
            Case 4
                vortab = stsatz2#           'steuersatz mit ek34/5
            Case 5
        '
            Case 6
                vortab = steuer + st_auf_ek34
        Case Else
        End Select
    
        'testen:
    'vortab = st_auf_ek34
    'vortab = st_auf_ek34
    'vortab = stsatz1
    'vortab = stsatz2
    'vortab = test
    'vortab = 100
    End If  'vz>=1999
End If    'If progek = 0 And ek34 = 0 Then
End Function
'
Private Function esttab(vz As Single, heirat As Single, zve As Double) As Double
'
Dim Rund As Double, zve1 As Double, zve2 As Double, zve3 As Double, ergebnis As Double
Dim x As Double, st As Double, y1 As Double, y2 As Double, rw As Double, z As Double
Dim y As Double


zve1 = zve
If heirat = 2 Then
    zve1 = Fix(zve / 2)
End If
'
zve2 = zve1
'
Select Case vz
Case 1996 To 1997
    ergebnis = uptab1996(zve2)
Case 1998
    ergebnis = uptab1998(zve2)
Case 1999
    ergebnis = uptab1999(zve2)
Case 2000
    ergebnis = uptab2000(zve2)
Case 2001
    ergebnis = uptab2001(zve2)
Case 2002                       'EURO !!
    ergebnis = uptab2002(zve2)
Case 2003 To 2004               'EURO !!
    ergebnis = uptab2003(zve2)
 Case Is >= 2005                'EURO !!
    ergebnis = uptab2005(zve2)
Case Else
End Select
If heirat = 2 Then
   ergebnis = ergebnis * 2
End If

esttab = ergebnis

End Function

Private Function uptab1999(zve2 As Double) As Double
'Dim x As Double, st As Double, y1 As Double, y2 As Double, rw As Double, z As Double

  x = zve2
  If x <= 13067 Then
    st = 0
  End If
  If x >= 13068 And x <= 17063 Then
    y1 = (x - 13014) / 10000
    rw = Fix(y1 * 350.35 * 1000) / 1000
    rw = rw + 2390
    rw = Fix(rw * y1 * 1000) / 1000
    st = Fix(rw + 0)
   End If
  'uptab1999 = st
  '
  If x >= 17064 And x <= 66365 Then
    y2 = (x - 17010) / 10000
    rw = Fix(y2 * 101.31 * 1000) / 1000
    rw = rw + 2670
    rw = Fix(rw * y2 * 1000) / 1000
    st = Fix(rw + 1011)
  End If
  '
  If x >= 66366 And x <= 120041 Then
    z = (x - 66312) / 10000
    rw = Fix(z * 151.93 * 1000) / 1000
    rw = rw + 3669
    rw = Fix(rw * z * 1000) / 1000
    st = Fix(rw + 16637)
  End If
  '
  If x >= 120042 Then
    st = Fix(x * 0.53 - 22886)
  End If
  '
  uptab1999 = st
  
    
End Function

Private Function uprund54(zve1 As Double) As Double
    Rund = Fix(zve1 / 54)
    Rund = Rund * 54
    uprund54 = Rund
End Function


Private Function uptab1996(zve2 As Double) As Double
  x = zve2
  If x <= 12095 Then
    st = 0
  End If
  If x >= 12096 And x <= 55727 Then
    y = (x - 12042) / 10000
    rw = Fix(y * 86.63 * 1000) / 1000
    rw = rw + 2590
    rw = Fix(rw * y * 1000) / 1000
    st = Fix(rw + 0)
  End If
  '
  If x >= 55728 And x <= 120041 Then
    z = (x - 55674) / 10000
    rw = Fix(z * 151.91 * 1000) / 1000
    rw = rw + 3346
    rw = Fix(rw * z * 1000) / 1000
    st = Fix(rw + 12949)
  End If
  '
  If x >= 120042 Then
    st = Fix(x * 0.53 - 22842)
  End If
  uptab1996 = st
End Function

Private Function uptab1998(zve2 As Double) As Double
  x = zve2
  If x <= 12365 Then
    st = 0
  End If
  If x >= 12366 And x <= 58643 Then
    y = (x - 12312) / 10000
    rw = Fix(y * 91.19 * 1000) / 1000
    rw = rw + 2590
    rw = Fix(rw * y * 1000) / 1000
    st = Fix(rw + 0)
  End If
  '
  If x >= 58644 And x <= 120041 Then
    z = (x - 58590) / 10000
    rw = Fix(z * 151.96 * 1000) / 1000
    rw = rw + 3434
    rw = Fix(rw * z * 1000) / 1000
    st = Fix(rw + 13938)
  End If
  '
  If x >= 120042 Then
    st = Fix(x * 0.53 - 22843)
  End If
  uptab1998 = st
End Function

Private Function uptab2000(zve2 As Double) As Double
  x = zve2
  If x <= 13499 Then
    st = 0
  End If
  If x >= 13500 And x <= 17495 Then
    y = (x - 13446) / 10000
    rw = Fix(y * 262.76 * 1000) / 1000
    rw = rw + 2290
    rw = Fix(rw * y * 1000) / 1000
    st = Fix(rw + 0)
  End If
  '
  If x >= 17496 And x <= 114695 Then
    z = (x - 17442) / 10000
    rw = Fix(z * 133.74 * 1000) / 1000
    rw = rw + 2500
    rw = Fix(rw * z * 1000) / 1000
    st = Fix(rw + 957)
  End If
  '
  If x >= 114696 Then
    st = Fix(x * 0.51 - 20575)
  End If
  uptab2000 = st
End Function

Private Function uptab2001(zve2 As Double) As Double
  x = zve2
  If x <= 14093 Then
    st = 0
  End If
  If x >= 14094 And x <= 18089 Then
    y = (x - 14040) / 10000
    rw = Fix(y * 387.89 * 1000) / 1000
    rw = rw + 1990
    rw = Fix(rw * y * 1000) / 1000
    st = Fix(rw + 0)
  End If
  '
  If x >= 18090 And x <= 107567 Then
    z = (x - 18036) / 10000
    rw = Fix(z * 142.49 * 1000) / 1000
    rw = rw + 2300
    rw = Fix(rw * z * 1000) / 1000
    st = Fix(rw + 857)
  End If
  '
  If x >= 107568 Then
    st = Fix(x * 0.485 - 19299)
  End If
  uptab2001 = st
End Function

Private Function uptab2002(zve2 As Double) As Double
'in Euro !!!
  x = zve2
  If x <= 7235 Then
    st = 0
  End If
  If x >= 7236 And x <= 9251 Then
    y = (x - 7200) / 10000
    rw = Fix(768.85 * y * 1000) / 1000
    rw = rw + 1990
    rw = Fix(rw * y * 1000) / 1000
    st = Fix(rw + 0)
  End If
  '
  If x >= 9252 And x <= 55007 Then
    z = (x - 9216) / 10000
    rw = Fix(278.65 * z * 1000) / 1000
    rw = rw + 2300
    rw = Fix(rw * z * 1000) / 1000
    st = Fix(rw + 432)
  End If
  '
  If x >= 55008 Then
    st = Fix(0.485 * x - 9872)
  End If
  uptab2002 = st
 
 'uptab2002 = x

End Function

Private Function uptab2003(zve2 As Double) As Double
'in Euro !!!
  x = zve2
  If x <= 7426 Then
    st = 0
  End If
  If x >= 7427 And x <= 12755 Then
    y = (x - 7426) / 10000
    rw = Fix(747.8 * y * 1000) / 1000
    rw = rw + 1700
    rw = Fix(rw * y * 1000) / 1000
    st = Fix(rw + 0)
  End If
  '
  If x >= 12756 And x <= 52292 Then
    z = (x - 12755) / 10000
    rw = Fix(278.59 * z * 1000) / 1000
    rw = rw + 2497
    rw = Fix(rw * z * 1000) / 1000
    st = Fix(rw + 1118)
  End If
  '
  If x >= 52293 Then
    st = Fix(0.47 * x - 9232)
  End If
  uptab2003 = st
  'uptab2003 = x
  
End Function

Private Function uptab2005(zve2 As Double) As Double
'in Euro !!!
  x = zve2
  If x <= 7664 Then
    st = 0
  End If
  If x >= 7665 And x <= 12739 Then
    y = (x - 7664) / 10000
    rw = Fix(883.74 * y * 1000) / 1000
    rw = rw + 1500
    rw = Fix(rw * y * 1000) / 1000
    st = Fix(rw + 0)
  End If
  '
  If x >= 12740 And x <= 52151 Then
    z = (x - 12739) / 10000
    rw = Fix(228.74 * z * 1000) / 1000
    rw = rw + 2397
    rw = Fix(rw * z * 1000) / 1000
    st = Fix(rw + 989)
  End If
  '
  If x >= 52152 Then
    st = Fix(0.42 * x - 7914)
  End If
  uptab2005 = st
End Function

Attribute VB_Name = "Modul10"

Public Function kinder1(vz As Single, art As Single, mo1 As Double, mo2 As Double, mo3 As Double, mo4 As Double, mo5 As Double, mo6 As Double, mo7 As Double, mo8 As Double, mosum As String)

'mo1 = c34
'mo2 = c36 usw
'mo5 = c40 halbe kinder
Select Case vz
Case 1996 To 1999
   ' mfb = 576
   ' mfb05 = 288
    fb_est = mo1 * 576 + mo5 * 288
    If mo5 > 0 And mo1 = 0 Then
        fb_kist = 12 * 288     'Kist/Soli
    End If
    If mo1 > 0 Then
        fb_kist = 12 * 576     'Kist/Soli
    End If
Case Is >= 2000
    mfb1 = 576
    mfb2 = 252
    mfb105 = 288
    mfb205 = 126
    fb_est1 = mo2 * (mfb1 + mfb2) + mo3 * mfb1 + mo4 * (mfb1 + mfb2)
    fb_est2 = mo6 * (mfb105 + mfb205) + mo7 * mfb105 + mo8 * (mfb105 + mfb205)
    fb_est = fb_est1 + fb_est2
    If mo2 > 0 Or mo4 > 0 Then
        fb_kist = 12 * 828
    End If
    If mo3 > 0 And mo2 = 0 And mo4 = 0 Then
        fb_kist = 12 * 576
    End If
    If mo6 > 0 And (mo2 + mo3 + mo4) = 0 Then
        fb_kist = 12 * 414
    End If
    If mo8 > 0 And (mo2 + mo3 + mo4) = 0 Then
        fb_kist = 12 * 414
    End If
    If mo7 > 0 And mo6 = 0 And mo8 = 0 And (mo2 + mo3 + mo4) = 0 Then
        fb_kist = 12 * 288
    End If

Case Else
End Select
'
Select Case art
Case 1
    kinder1 = fb_est
Case 2
    kinder1 = fb_kist
Case Else
End Select
If mosum = "FALSCH!" Then
    kinder1 = 0
End If

'
End Function

Attribute VB_Name = "Modul11"

Public Function kinderanzahl(k1 As Single, k2 As Single, k3 As Single, k4 As Single, k5 As Single, k6 As Single)
Dim ka(6)
ka(1) = k1
ka(2) = k2
ka(3) = k3
ka(4) = k4
ka(5) = k5
ka(6) = k6
For i = 1 To 6
    If ka(i) > 0 Then
        anzahlk = anzahlk + 1
    End If
Next i
kinderanzahl = anzahlk
End Function
Attribute VB_Name = "Modul12"
Public Function kapital(vz As Single, heirat As Single, art As Single, z1m As Double, z3m As Double, z1f As Double, z3f As Double)
  '
  zi3_m = z3m     'Werbungskosten Mann
  zi3_f = z3f     'Werbungskosten Frau
  pk2_k = heirat
  vz1 = vz
  arte = art
  '
  su_zi_m = z1m
  su_zi_f = z1f
  su_zi_beide = z1m + z1f
 
  wkkap_p = 100
  If pk2_k > 0 Then
    wkkap_p = 200
  End If
  '
  Select Case vz1
  Case 1993 To 1999
    kap_spfb_m = 6000
    kap_spfb_f = 6000
  Case Is >= 2000 'neu ab 2000 halbiert!
    kap_spfb_m = 3000
    kap_spfb_f = 3000
  End Select

  If pk2_k = 0 Then
    wkkap_m = wkkap_p
    If wkkap_p > su_zi_m Then
      wkkap_m = su_zi_m
    End If
    If zi3_m > wkkap_p Then
      wkkap_m = zi3_m
    End If
    spfb_m = kap_spfb_m
    If kap_spfb_m > (su_zi_m - wkkap_m) Then
      spfb_m = (su_zi_m - wkkap_m)
    End If
    If spfb_m < 0 Then
      spfb_m = 0
    End If
  End If
  '
  If pk2_k > 0 Then
  'Werbungskosten
    If (zi3_m + zi3_f) > (wkkap_p) Then  'eingegebene Wk > Pauschale
      wkkap_p = 0
      wkkap_m = zi3_m
      wkkap_f = zi3_f
      'zz = 1
    Else  'wenn nur Pauschale
    'Aufteilung der Pauschale
      If wkkap_p > 0 And su_zi_beide <> 0 Then     'wenn Pauschale  /Div /0
        wkkap_m = Fix(wkkap_p * su_zi_m / su_zi_beide + 0.5)
        wkkap_f = Fix(wkkap_p * su_zi_f / su_zi_beide + 0.5)
        If wkkap_m > su_zi_m Then
          wkkap_m = su_zi_m
        End If
        If wkkap_f > su_zi_f Then
          wkkap_f = su_zi_f
        End If
      End If  'wkkap_p >0
    End If    'pk2_K >0
    'sparerfreibetrag
    spfb_m = kap_spfb_m   'Pauschale = Abzug
    spfb_f = kap_spfb_f   'Pauschale = Abzug
    If kap_spfb_m > (su_zi_m - wkkap_m) Then      'wenn freibetrag >Eink|fffd|nfte
        spfb_m = (su_zi_m - wkkap_m)    'Abzug
        If (su_zi_m - wkkap_m) < 0 Then
            spfb_m = 0
        End If
        rest_m = kap_spfb_m - spfb_m             'nicht ausgesch|fffd|pfter Fbtr
    End If
    If kap_spfb_f > (su_zi_f - wkkap_f) Then
        spfb_f = (su_zi_f - wkkap_f)
        If (su_zi_f - wkkap_f) < 0 Then
            spfb_f = 0
        End If
        rest_f = kap_spfb_f - spfb_f  'nicht ausgesch|fffd|pfter Fbtr
    End If
    spfb_m = spfb_m + rest_f
    spfb_f = spfb_f + rest_m
    If spfb_m > (su_zi_m - wkkap_m) Then
        spfb_m = (su_zi_m - wkkap_m)
    End If
    If spfb_f > (su_zi_f - wkkap_f) Then
        spfb_f = (su_zi_f - wkkap_f)
    End If
    If spfb_m < 0 Then
        spfb_m = 0
    End If
    If spfb_f < 0 Then
        spfb_f = 0
    End If
 
  End If  'pk2 >0
  'ek(5) = su_zi_m - wkkap_p_m - kap_spfb_m
  'ek(15) = su_zi_f - wkkap_p_f - kap_spfb_f
  '
  Select Case arte
  Case 1
      kapital = wkkap_m
  Case 2
      kapital = spfb_m
  Case 3
      kapital = wkkap_f
  Case 4
      kapital = spfb_f
  End Select
  '
  'kapital = rest_m
  'kapital = su_zi_m
'kapital = 1

End Function

Attribute VB_Name = "Modul2"

Public Function SA_HB(vz, pk2, lohn_m, lohnmj_m, lohn_f, lohnmj_f, zpflv_m, zpflv_f, se_vers1)
' *SA-H|fffd|chstbetragsberechnung*
  ' ****************************
  '
  lohnakt_m = lohn_m + lohnmj_m
  lohnakt_f = lohn_f + lohnmj_f
  '
  'zpflv_m = zelle    'zus|fffd|tzliche freiw. Pflegeversicherung
  'zpflv_f = zelle2
  If zpflv_m >= 360 Then
    zpflv_mhb = 360
    restzpflv_m = zpflv_m - 360
  Else
    zpflv_mhb = zpflv_m
    restzpflv_m = 0
  End If
  If zpflv_f >= 360 Then
    zpflv_fhb = 360
    restzpflv_f = zpflv_f - 360
  Else
    zpflv_fhb = zpflv_f
    restzpflv_f = 0
  End If
  zpflv_hb = zpflv_mhb + zpflv_fhb
  restzpflv = restzpflv_m + restzpflv_f
    '
  se_vers2 = se_vers1 - zpflv_m - zpflv_f
  Max = 2610    'ab 1995 ok
  vw = 6000
  '
  If pk2 > 0 Then
   Max = 5220
   vw = 12000
  End If
   '
   vorsa = se_vers2 + restzpflv
   '
   bas1 = Fix(lohnakt_m * 16 / 100)
   bas2 = Fix(lohnakt_f * 16 / 100)
   '
   vw1 = vw - (bas1 + bas2)             'H|fffd|he des K|fffd|rzungsbetrages
    '
   If vw1 < 0 Then
    vw1 = 0
  End If
  s1 = vorsa - vw1
  If s1 < 0 Then
    s1 = 0
  End If
  abz1 = vw1
  If vw1 > vorsa Then
    abz1 = vorsa
  End If
  abz2 = Max
  If abz2 > s1 Then
    abz2 = s1
  End If
  s2 = s1 - Max
  If s2 < 0 Then
    s2 = 0
  Else
     sx = Fix(s2 / 2 + 0.5)
     sy = Max / 2
     abz3 = sx
     If sx > sy Then
       abz3 = sy
     End If
  End If
  s3 = abz1 + abz2 + abz3
  SA_HB = s3 + zpflv_hb
  
'SA_HB = zpflv_hb
'SA_HB = abz1

  '
End Function
Attribute VB_Name = "Modul3"

Public Function sde_ber(vz As Double, pk2 As Double, art As Double, ek1 As Double, ek2 As Double, ek3 As Double, ek4 As Double, ek5 As Double, ek6 As Double, ek7 As Double, ek11 As Double, ek12 As Double, ek13 As Double, ek14 As Double, ek15 As Double, ek16 As Double, ek17 As Double) As Double
'
Dim ek(1 To 17) As Double
Dim anteil_pos1(1 To 17) As Double, anteil_neg1(1 To 17) As Double, anteil_pos2(1 To 17) As Double, anteil_neg2(1 To 17) As Double
Dim ek_1(1 To 17) As Double
Dim n_abz_verl(1 To 17) As Double
Dim ek_2(1 To 17) As Double
Dim ek_3(1 To 17) As Double
Dim ek_4(1 To 17) As Double
Dim abz1(1 To 17) As Double
Dim abz2(1 To 17) As Double
Dim abz3(1 To 17) As Double
Dim abz4(1 To 17) As Double
Dim sde_pos1 As Double, sde_pos2 As Double, sde_pos_ehel As Double
Dim z As Integer, i As Integer

ek(1) = ek1
ek(2) = ek2
ek(3) = ek3
ek(4) = ek4
ek(5) = ek5
ek(6) = ek6
ek(7) = ek7
ek(11) = ek11
ek(12) = ek12
ek(13) = ek13
ek(14) = ek14
ek(15) = ek15
ek(16) = ek16
ek(17) = ek17
'If heirat = 2 Then
 '  pk2 = 1            'wenn witwensplitting ggf. |fffd|ndern!!!!
'End If
' *Summe der Eink|fffd|nfte*
  ' ********************
  '
  z = 0
  sde_pos1 = 0
  sde_pos2 = 0
  sde_neg1 = 0
  sde_neg2 = 0
  If vz >= 1999 Then
    'summe der positiven eink|fffd|nfte
    z = 0
    For z = 1 To 7
      If ek(z) > 0 Then
        sde_pos1 = sde_pos1 + ek(z)     'Stpfl/Ehemann
      End If
      If ek(z + 10) > 0 Then
        sde_pos2 = sde_pos2 + ek(z + 10)    'Ehegannte
      End If
    Next z
    z = 0
    sde_pos_ehel = sde_pos1 + sde_pos2                    ' ag(1) = sde
    'sde_pos_ehel mu|fffd| korrigert werden, wemm horizontaler Ausgleich in Frage kommt!!!
    '
    'summe der negativen eink|fffd|nfte
    For z = 1 To 7
      If ek(z) < 0 Then
        sde_neg1 = sde_neg1 + ek(z)                'sde negativ ehemann
      End If
      If ek(z + 10) < 0 Then
        sde_neg2 = sde_neg2 + ek(z + 10)       'sde negativ ehrfrau
      End If
      sde_neg_ehel = sde_neg1 + sde_neg2
    Next z
    z = 0
    '
    'wenn pos. sde <100000 und neg. sde>100000, dann keine Berechnung
    keine_ber! = True
    If sde_pos1 > 0 And Abs(sde_neg1) > 0 Then
      keine_ber! = False
      If sde_pos1 < 100000 And Abs(sde_neg1) > 0 Then
        keine_ber! = True
      End If
    End If
    If pk2 > 0 Then
      If sde_pos_ehel > 0 And Abs(sde_neg_ehel) > 0 Then
        keine_ber! = False
        If sde_pos_ehel < 200000 And Abs(sde_neg_ehel) > 0 Then
          keine_ber! = True
        End If
      End If
    End If
    '++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    '3
    For i = 1 To 7
       anteil_pos1(i) = 0
       anteil_neg1(i) = 0
    Next i
    For i = 1 To 17
      anteil_pos2(i) = 0
      anteil_neg2(i) = 0
    Next i
    If keine_ber! = False Then
      'Anteile in v. H. an pos. Eink|fffd|nften
      For z = 1 To 7
        If sde_pos1 > 0 Then                       'wegen Div/0
          If ek(z) > 0 Then
            anteil_pos1(z) = ek(z) / sde_pos1 * 100
          End If
        End If  'sde_pos1>0
        If sde_pos2 > 0 Then                       'wegen Div/0
          If ek(z + 10) > 0 Then
            anteil_pos2(z + 10) = ek(z + 10) / sde_pos2 * 100
          End If
        End If
      Next z
      z = 0
      'Anteile in v. H. an negativen Eink|fffd|nften
      For z = 1 To 7
        If sde_neg1 < 0 Then
          If ek(z) < 0 Then
            anteil_neg1(z) = ek(z) / sde_neg1 * 100                'Ehemann
          End If
        End If
        If sde_neg2 < 0 Then
          If ek(z + 10) < 0 Then
            anteil_neg2(z + 10) = ek(z + 10) / sde_neg2 * 100         'Ehegrau
          End If
        End If
      Next z
      z = 0
      '++++++++++++++++++++++++++++++++++++++++++++++++++++++
      '4
      If Abs(sde_neg1 = 0) Then
        sde_max1 = sde_pos1
        If sde_pos1 > 100000 Then
          sde_max1 = Fix(100000 + (sdePos1 - 100000) / 2 + 0.5)
        End If
      End If
      If Abs(sde_neg1) > 0 Then                          'bei Einzelveranlagung
        sde_ausgl1 = sde_pos1
        sde_max1 = sde_ausgl1
        If Abs(sde_neg1) <= sde_pos1 Then
          sde_ausgl1 = Abs(sde_neg1)
          sde_n_abz1 = 0
        Else
          sde_n_abz1 = Abs(sde_neg1) - sde_pos1   'verbl. abzug nach 10d
        End If
        If sde_pos1 > 100000 Then
          sde_ausgl1 = Fix(100000 + (sde_pos1 - 100000) / 2 + 0.5)         'Maximaler Ausgleich
          sde_max1 = sde_ausgl1
          If Abs(sde_neg1) > sde_ausgl1 Then
            sde_n_abz1 = Abs(sde_neg1) - sde_ausgl1
          Else
            sde_ausgl1 = Abs(sde_neg1)
            sde_n_abz1 = 0
          End If
        End If        'sde_pos1>100000
      End If              'ABS(sde_neg1) > 0
      '++++++++++++++++++++++++++++++++++++++++++++++++
      '5
      'Vertikaler Ausgleich Ehefrau:
      '*****************************
      If pk2 > 0 Then
        If Abs(sde_neg2 = 0) Then
          sde_max2 = sde_pos2
          If sde_pos2 > 100000 Then
            sde_max2 = Fix(100000 + (sde_pos2 - 100000) / 2 + 0.5)
          End If
        End If
      End If
      If pk2 > 0 And Abs(sde_neg2) > 0 Then
        sde_ausgl2 = sde_pos2
        sde_max2 = sde_ausgl2
        If Abs(sde_neg2) <= sde_pos2 Then
          sde_ausgl2 = Abs(sde_neg2)
          sde_n_abz2 = 0
        Else
          sde_n_abz2 = Abs(sde_neg2) - sde_pos2   'verbl. abzug nach 10d
        End If               ' ABS(sde_neg2) <= sde_pos2
        If sde_pos2 > 100000 Then
          sde_ausgl2 = Fix(100000 + (sde_pos2 - 100000) / 2 + 0.5)         'Maximaler Ausgleich
          sde_max2 = sde_ausgl2
          If Abs(sde_neg2) > sde_ausgl2 Then
            sde_n_abz2 = Abs(sde_neg2) - sde_ausgl2
          Else
            sde_ausgl2 = Abs(sde_neg2)
            sde_n_abz2 = 0
          End If      'ABS(sde_neg2) > sde_ausgl2
        End If       'sde_pos2>100000
      End If        'pk2 > 0 AND ABS(sde_neg2)
     
      'Verteilung Verlustausgleich und Verteilung verbleibender 10d Verlust
      '
      For i = 1 To 17
        abz1(i) = 0
        abz2(i) = 0
        abz3(i) = 0
        abz4(i) = 0
        ek_1(i) = 0
        n_abz_verl(i) = 0
        ek_2(i) = 0
        ek_3(i) = 0
        ek_4(i) = 0
      Next i
      For i = 1 To 7
        'verbleibende Eink|fffd|nfte
        If ek(i) > 0 Then
          abz1(i) = Fix(anteil_pos1(i) * sde_ausgl1 / 100 + 0.5)   'Verteilung Verlustausgleich
          ek_1(i) = ek(i) - abz1(i)
        Else
          n_abz_verl(i) = Fix(anteil_neg1(i) * sde_n_abz1 / 100) ' + 0.5)   'Verteilung verbleibender 10d Verlust
          ek_1(i) = -n_abz_verl(i)
          abz1(i) = -ek(i) - n_abz_verl(i)
          '  ? "negative = ";ek_1(i)
        End If
        If pk2 = 0 Then
          ek_4(i) = ek_1(i)            'Endwert f|fffd|r Einzelveranlagung
        End If
        'Endwert f|fffd|r Einzelveranlagung
        If pk2 > 0 Then
          If ek(i + 10) > 0 Then
            abz1(i + 10) = Fix(anteil_pos2(i + 10) * sde_ausgl2 / 100 + 0.5)   'Verteilung Verlustausgleich
            'verbleibende Eink|fffd|nfte
            ek_1(i + 10) = ek(i + 10) - abz1(i + 10)
          Else
            n_abz_verl(i + 10) = Fix(anteil_neg2(i + 10) * sde_n_abz2 / 100)  ' + 0.5)   'Verteilung verbleibender 10d Verlust
            ek_1(i + 10) = -n_abz_verl(i + 10)
            abz1(i + 10) = -ek(i + 10) - n_abz_verl(i + 10)
          End If
        End If
        '
      Next i
     '+++++++++++++++++++++++++++++++++++++++
     '8
      'Horizontaler Verlustausgleich
      abz2_se1 = 0
      abz2_se2 = 0
      If pk2 > 0 Then
        For i = 1 To 7
          If ek_1(i) > 0 And ek_1(i + 10) < 0 Then      ' wenn Ehemann noch positive und ehefrau noch negative Eink
            If ek_1(i) > Abs(ek_1(i + 10)) Then
              abz2(i) = Abs(ek_1(i + 10))
            Else
              abz2(i) = ek_1(i)
            End If
            ek_2(i) = ek_1(i) - abz2(i)   'Ausgleich mit den gleichen Eink|fffd|nften des Ehegatten
            ek_2(i + 10) = ek_1(i + 10) + abz2(i)
            abz2(i + 10) = abz2(i)
            '
            abz2_se1 = abz2_se1 + abz2(i)           ' aufgelaufene abzugsbetr|fffd|ge z|fffd|hlen
          End If
          '
          If ek_1(i + 10) > 0 And ek_1(i) < 0 Then        ' wenn Ehemann noch negative und ehefrau noch positive Eink
            If ek_1(i + 10) > Abs(ek_1(i)) Then
              abz2(i + 10) = Abs(ek_1(i))
            Else
              abz2(i + 10) = ek_1(i + 10)
            End If
            ek_2(i + 10) = ek_1(i + 10) - abz2(i + 10)   'Ausgleich mit den gleichen Eink|fffd|nften des Ehegatten
            ek_2(i) = ek_1(i) + abz2(i + 10)        'Ausgleich mit den gleichen Eink|fffd|nften des Ehegatten
            abz2(i) = abz2(i + 10)
            '
            abz2_se2 = abz2_se2 + abz2(i + 10)           ' aufgelaufene abzugsbetr|fffd|ge z|fffd|hlen
          End If
        Next i
        For i = 1 To 7
          If abz2(i) = 0 Then
            ek_2(i) = ek_1(i)
          End If
          If abz2(i + 10) = 0 Then
            ek_2(i + 10) = ek_1(i + 10)
          End If
        Next i
        '    warte
        abz2_se = abz2_se1 + abz2_se2           'Aufgelaufene Minderung der Pos. Eink. bei horizont.Ausgleich
        
        se_ek_2_posm = 0
        se_ek_2_posf = 0
        se_ek_2_negm = 0
        se_ek_2_negf = 0
        For i = 1 To 7
          If ek_2(i) > 0 Then
            se_ek_2_posm = se_ek_2_posm + ek_2(i)
          Else
            se_ek_2_negm = se_ek_2_negm + ek_2(i)
          End If
          If ek_2(i + 10) > 0 Then
            se_ek_2_posf = se_ek_2_posf + ek_2(i + 10)
          Else
            se_ek_2_negf = se_ek_2_negf + ek_2(i + 10)
          End If
        Next i
'
         '
'+++++++++++++++++++++++++++++++++
'9
'Vertkaler Ausgleich Ehegatten
'
'hier neu !!!!!!!!!!!!!!
sde_max_m = 100000 + Fix((sde_pos1 - abz2_se1 - 100000) / 2 + 0.5) - sde_ausgl1 'max Verlustvolumen
If sde_max_m < 0 Then
  sde_max_m = 0
End If
sde_max_f = 100000 + Fix((sde_pos2 - abz2_se2 - 100000) / 2 + 0.5) - sde_ausgl2 'max Verlustvolumen
If sde_max_f < 0 Then
  sde_max_f = 0
End If
verbl_ausgl_vol1 = sde_max_m
verbl_ausgl_vol2 = sde_max_f
'************************
'
If verbl_ausgl_vol1 > 0 And Abs(se_ek_2_negf) > 0 Then
  If se_ek_2_posm > verbl_ausgl_vol1 Then
    ausgl2 = verbl_ausgl_vol1
  Else
    ausgl2 = se_ek_2_posm
  End If
  If Abs(se_ek_2_negf) < ausgl2 Then
    ausgl2 = Abs(se_ek_2_negf)
  End If
  '
  'Verteilen auf positive des Ehemanns
  abz3_se1 = 0
  abz3_se2 = 0
  For i = 1 To 7
    If ek_2(i) > 0 Then
      ek_3(i) = Fix(ek_2(i) / se_ek_2_posm * (se_ek_2_posm - ausgl2) + 0.5)
      abz3(i) = ek_2(i) - ek_3(i)
    End If
    abz3_se1 = abz3_se1 + abz3(i)       ' aufgelaufene abzugsbetr|fffd|ge z|fffd|hlen
    ' Verteilen der Verlustminderung bei Ehefrau
    If ek_2(i + 10) < 0 Then
      abz3(i + 10) = ek_2(i + 10) - Fix(ek_2(i + 10) / se_ek_2_negf * (se_ek_2_negf - ausgl2))   ' + 0.5)
      ek_3(i + 10) = ek_2(i + 10) + abz3(i + 10)
    End If
  Next i
  'warte
End If    'IF verbl_ausgl_vol1 > 0 AND ABS( se_ek_2_negf ) > 0
'
If verbl_ausgl_vol2 > 0 And Abs(se_ek_2_negm) > 0 Then
  If se_ek_2_posf > verbl_ausgl_vol2 Then
    ausgl2 = verbl_ausgl_vol2
  Else
    ausgl2 = se_ek_2_posf
  End If
  If Abs(se_ek_2_negm) < ausgl2 Then
    ausgl2 = Abs(se_ek_2_negm)
  End If
  '
  'Verteilen auf positive des Ehefrau
  For i = 1 To 7
    If ek_2(i + 10) > 0 Then
      ek_3(i + 10) = Fix(ek_2(i + 10) / se_ek_2_posf * (se_ek_2_posf - ausgl2) + 0.5)
      abz3(i + 10) = ek_2(i + 10) - ek_3(i + 10)
      abz3_se2 = abz3_se2 + abz3(i + 10)       ' aufgelaufene Abzugsbetr|fffd|ge z|fffd|hlen
    End If
    ' Verteilen der Verlustminderung bei Ehemann
    If ek_2(i) < 0 Then
      'abz3(i) = ROUND( ek_2(i) / se_ek_2_negm  * 100) * ausgl2 / 100
      'ek_3(i) = ek_2(i) + abz3(i)
      abz3(i) = ek_2(i) - Fix(ek_2(i) / se_ek_2_negm * (se_ek_2_negm - ausgl2)) ' + 0.5)
      ek_3(i) = ek_2(i) + abz3(i)
    End If
  Next i
End If  'verbl_ausgl_vol2> 0 and ABS( se_ek_2_negm ) > 0
'
For i = 1 To 7
  If abz3(i) = 0 Then
    ek_3(i) = ek_2(i)
  End If
  If abz3(i + 10) = 0 Then
    ek_3(i + 10) = ek_2(i + 10)
  End If
Next i
'
'Vertikaler Ausgleich 2
'++++++++++++++++++++++
se_ek_3_pos1 = 0
se_ek_3_pos2 = 0
se_ek_3_neg1 = 0
se_ek_3_neg2 = 0
'
For i = 1 To 7
  If ek_3(i) > 0 Then
    se_ek_3_pos1 = se_ek_3_pos1 + ek_3(i)      ' summe der verbl. posit Eink|fffd|nfte
  Else
    se_ek_3_neg1 = se_ek_3_neg1 + ek_3(i)      ' Se. der verbl negativen Eink
  End If
  If ek_3(i + 10) > 0 Then
    se_ek_3_pos2 = se_ek_3_pos2 + ek_3(i + 10) ' summe der verbl. posit Eink|fffd|nfte
  Else
    se_ek_3_neg2 = se_ek_3_neg2 + ek_3(i + 10)  ' Se. der verbel negativen Eink
  End If
Next i
se_ek_3_pos_ehel = se_ek_3_pos1 + se_ek_3_pos2
se_ek_3_neg_ehel = se_ek_3_neg1 + se_ek_3_neg2

'Restverteilung, wenn 200000 nicht ausgesch|fffd|pft sind
'****************************************************
'
If se_ek_3_neg_ehel <> 0 Then
  bereits_vertikal = sde_pos_ehel - se_ek_3_pos_ehel - abz2_se  ' abz2_se = horizontal Eheg
  sde_max_ehel = 200000 + Fix((sde_pos_ehel - abz2_se - 200000) / 2 + 0.5) - bereits_vertikal
Else
  sde_max_ehel = 0
End If
'f|fffd|r sp|fffd|tere Verwendung
bereits_vertikal = sde_pos_ehel - se_ek_3_pos_ehel - abz2_se  ' abz2_se = horizontal Eheg
'
verbl_ausgl_vol_ehel2 = sde_max_ehel
If Abs(se_ek_3_pos_ehel) < verbl_ausgl_vol_ehel2 Then
  verbl_ausgl_vol_ehel2 = Abs(se_ek_3_pos_ehel)
End If

If Abs(se_ek_3_neg_ehel) < verbl_ausgl_vol_ehel2 Then
  verbl_ausgl_vol_ehel2 = Abs(se_ek_3_neg_ehel)
End If
'
'Berechnung des Unterschiedbetrages     neu ab 2000 eingef|fffd|gt
' = 100000 - vertikal ausgeglichene Betr|fffd|ge
unt_m = 100000 - (sde_pos1 - se_ek_3_pos1 - abz2_se1)   '= von 100000 verbrauchte Verluste
If unt_m < 0 Then                                           ' ohne Horizontalausgl abz2_se1
  unt_m = 0
End If
unt_f = 100000 - (sde_pos2 - se_ek_3_pos2 - abz2_se2)   '= von 100000 verbrauchte Verluste
If unt_f < 0 Then                                           ' ohne Horizontalausgl abz2_se2
  unt_f = 0
End If
' ENDIF
If unt_m > 0 Then
  If verbl_ausgl_vol_ehel2 > unt_m Then
    verbl_ausgl_vol_ehel2 = unt_m
  End If
End If
If unt_f > 0 Then
  If verbl_ausgl_vol_ehel2 > unt_f Then
    verbl_ausgl_vol_ehel2 = unt_f
  End If
End If
'
abz4_se1 = 0
abz4_se2 = 0
'
For i = 1 To 7
  'Verteilung auf pos. Resteink|fffd|nfte
  If ek_3(i) > 0 Then                                  'wenn noch positive eink|fffd|nfte
    If se_ek_3_pos_ehel <> 0 Then        ' div/0
      abz4(i) = Fix((ek_3(i) / se_ek_3_pos_ehel * 100) * verbl_ausgl_vol_ehel2 / 100 + 0.5)   'Verteilung Verbl vol
    End If
    If abz4(i) < 0 Then
      abz4(i) = 0
    End If
    ek_4(i) = ek_3(i) - abz4(i)
    abz4_se1 = abz4_se1 + abz4(i)       ' aufgelaufene abzugsbetr|fffd|ge z|fffd|hlen
  End If
Next i
'ehefrau:
For i = 1 To 7
  If ek_3(i + 10) > 0 Then
    '        ? "ek_3(i+10) = ";ek_3(i + 10)
    If se_ek_3_pos_ehel <> 0 Then              'div /0
      abz4(i + 10) = Fix((ek_3(i + 10) / se_ek_3_pos_ehel * 100) * verbl_ausgl_vol_ehel2 / 100 + 0.5)
    End If
    If abz4(i + 10) < 0 Then
      abz4(i + 10) = 0
    End If
    ek_4(i + 10) = ek_3(i + 10) - abz4(i + 10)
    abz4_se2 = abz4_se2 + abz4(i + 10)       ' aufgelaufene abzugsbetr|fffd|ge z|fffd|hlen
  End If
Next i
'verteilung der verluste  = ek_4
For i = 1 To 7
  If ek_3(i) < 0 Then                       'wenn noch negative eink|fffd|nfte
    If se_ek_3_neg_ehel <> 0 Then     'Div/0
      abz4(i) = Fix((ek_3(i) / se_ek_3_neg_ehel * 100) * verbl_ausgl_vol_ehel2 / 100) ' + 0.5)   'Verteilung Verbl vol
    End If
    If abz4(i) < 0 Then
      abz4(i) = 0
    End If
    ek_4(i) = ek_3(i) + abz4(i)
  End If
Next i
For i = 1 To 7
  If ek_3(i + 10) < 0 Then                      'wenn noch negative eink|fffd|nfte
    If se_ek_3_neg_ehel <> 0 Then      ' Div/0
      abz4(i + 10) = Fix((ek_3(i + 10) / se_ek_3_neg_ehel * 100) * verbl_ausgl_vol_ehel2 / 100) ' + 0.5)   'Verteilung Verbl vol
    End If
    If abz4(i + 10) < 0 Then
      abz4(i + 10) = 0
    End If
    ek_4(i + 10) = ek_3(i + 10) + abz4(i + 10)
  End If
Next i
'
For i = 1 To 7
  If abz4(i) = 0 Then
    ek_4(i) = ek_3(i)
  End If
  If abz4(i + 10) = 0 Then
    ek_4(i + 10) = ek_3(i + 10)
  End If
Next i
End If      ' IF pk2 > 0
End If   'keine_ber!=false
' IF verlustsa! = FALSE     'Brechnung der Endwerte sde  ---nicht Verlustabzug!!
sde_verbl_m = 0
sde_verbl_f = 0
nichtausgl_m = 0
nichtausgl_f = 0
'
' Verbl. Summe der Eink|fffd|nfte
For i = 1 To 7
If ek_4(i) > 0 Then
    sde_verbl_m = sde_verbl_m + ek_4(i)
End If
If ek_4(i + 10) > 0 Then
    sde_verbl_f = sde_verbl_f + ek_4(i + 10)
End If
'Verbl. nicht ausgleichsf. Verluste
If ek_4(i) < 0 Then
    nichtausgl_m = nichtausgl_m + ek_4(i)
End If
If ek_4(i + 10) < 0 Then
    nichtausgl_f = nichtausgl_f + ek_4(i + 10)
End If
Next i
sde_ehel = sde_verbl_m + sde_verbl_f
'
End If       '>=1999
 
  ' *Summe der Eink|fffd|nfte*
  ' ************************
  z = 0
  For z = 1 To 7
    sde1 = sde1 + ek(z)
    sde2 = sde2 + ek(z + 10)
    sde_ber = sde1 + sde2 ' ag(1) = sde
  Next z
  If vz >= 1999 Then                 ' And keine_ber! = False Then
    Select Case art
      Case 1
        'If keine_ber! = False Then
            sde_ber = sde1 + sde2 - nichtausgl_m - nichtausgl_f
        'Else
        '   sde_ber = 0
       ' End If
      Case 2
        If keine_ber! = False Then
            sde_ber = nichtausgl_m
        Else
            sde_ber = 0
        End If
      Case 3
        If keine_ber! = False Then
            sde_ber = nichtausgl_f
        Else
            sde_ber = 0
        End If
      Case 4
        If keine_ber! = False Then
            sde_ber = Abs(nichtausgl_m + nichtausgl_f)
         Else
            sde_ber = 0
        End If
      Case 5
        If keine_ber! = False Then
            sde_ber = sde_verbl_m
        Else
           sde_ber = 0
        End If
      Case 6
        If keine_ber! = False Then
            sde_ber = sde_verbl_f
           Else
            sde_ber = 0
        End If
      Case 7
        If keine_ber! = False Then
            sde_ber = keine_ber!
        Else
            sde_ber = 0
        End If
      Case 131
      If keine_ber! = False Then
           sde_ber = abz1(1)
      Else
            sde_ber = 0
      End If
      Case 1310
        If keine_ber! = False Then
            sde_ber = abz1(11)
         Else
            sde_ber = 0
        End If
      Case 132
        If keine_ber! = False Then
            sde_ber = abz2(1)
          Else
            sde_ber = 0
        End If
      Case 1320
        If keine_ber! = False Then
            sde_ber = abz2(11)
          Else
            sde_ber = 0
        End If
      Case 133
        If keine_ber! = False Then
            sde_ber = abz3(1)
           Else
            sde_ber = 0
        End If
      Case 1330
        If keine_ber! = False Then
            sde_ber = abz3(11)
           Else
            sde_ber = 0
        End If
      Case 134
        If keine_ber! = False Then
            sde_ber = abz4(1)
          Else
            sde_ber = 0
        End If
      Case 1340
        If keine_ber! = False Then
         sde_ber = abz4(11)
          Else
            sde_ber = 0
        End If
      Case 151
        If keine_ber! = False Then
            sde_ber = abz1(2)
          Else
            sde_ber = 0
        End If
      Case 1510
        If keine_ber! = False Then
            sde_ber = abz1(12)
           Else
            sde_ber = 0
        End If
      Case 152
        If keine_ber! = False Then
            sde_ber = abz2(2)
           Else
            sde_ber = 0
        End If
      Case 1520
        If keine_ber! = False Then
            sde_ber = abz2(12)
        Else
            sde_ber = 0
        End If
      Case 153
        If keine_ber! = False Then
            sde_ber = abz3(2)
        Else
            sde_ber = 0
        End If
      Case 1530
        If keine_ber! = False Then
           sde_ber = abz3(12)
         Else
           sde_ber = 0
        End If
      Case 154
        If keine_ber! = False Then
            sde_ber = abz4(2)
         Else
            sde_ber = 0
        End If
      Case 1540
        If keine_ber! = False Then
            sde_ber = abz4(12)
           Else
            sde_ber = 0
        End If
      Case 181
        If keine_ber! = False Then
            sde_ber = abz1(3)
           Else
            sde_ber = 0
        End If
      Case 1810
        If keine_ber! = False Then
            sde_ber = abz1(13)
           Else
            sde_ber = 0
        End If
      Case 182
        If keine_ber! = False Then
            sde_ber = abz2(3)
          Else
            sde_ber = 0
        End If
      Case 1820
        If keine_ber! = False Then
            sde_ber = abz2(13)
          Else
            sde_ber = 0
        End If
      Case 183
        If keine_ber! = False Then
            sde_ber = abz3(3)
           Else
            sde_ber = 0
        End If
      Case 1830
        If keine_ber! = False Then
            sde_ber = abz3(13)
          Else
            sde_ber = 0
        End If
      Case 184
        If keine_ber! = False Then
             sde_ber = abz4(3)
           Else
            sde_ber = 0
        End If
      Case 1840
        If keine_ber! = False Then
            sde_ber = abz4(13)
           Else
            sde_ber = 0
        End If
      Case 191
        If keine_ber! = False Then
            sde_ber = abz1(4)
         Else
            sde_ber = 0
        End If
      Case 1910
        If keine_ber! = False Then
            sde_ber = abz1(14)
        Else
            sde_ber = 0
        End If
      Case 192
        If keine_ber! = False Then
            sde_ber = abz2(4)
          Else
            sde_ber = 0
        End If
      Case 1920
        If keine_ber! = False Then
           sde_ber = abz2(14)
        Else
           sde_ber = 0
        End If
      Case 193
        If keine_ber! = False Then
            sde_ber = abz3(4)
        Else
            sde_ber = 0
        End If
      Case 1930
        If keine_ber! = False Then
            sde_ber = abz3(14)
           Else
            sde_ber = 0
        End If
      Case 194
        If keine_ber! = False Then
            sde_ber = abz4(4)
         Else
            sde_ber = 0
        End If
      Case 1940
        If keine_ber! = False Then
            sde_ber = abz4(14)
          Else
            sde_ber = 0
        End If
      Case 201
        If keine_ber! = False Then
            sde_ber = abz1(5)
          Else
            sde_ber = 0
        End If
      Case 2010
        If keine_ber! = False Then
            sde_ber = abz1(15)
          Else
            sde_ber = 0
        End If
      Case 202
        If keine_ber! = False Then
            sde_ber = abz2(5)
           Else
            sde_ber = 0
        End If
      Case 2020
        If keine_ber! = False Then
            sde_ber = abz2(15)
         Else
            sde_ber = 0
        End If
      Case 203
        If keine_ber! = False Then
            sde_ber = abz3(5)
        Else
            sde_ber = 0
        End If
      Case 2030
        If keine_ber! = False Then
            sde_ber = abz3(15)
        Else
            sde_ber = 0
        End If
      Case 204
        If keine_ber! = False Then
            sde_ber = abz4(5)
        Else
            sde_ber = 0
        End If
      Case 2040
        If keine_ber! = False Then
            sde_ber = abz4(15)
          Else
            sde_ber = 0
        End If
        
      Case 211
        If keine_ber! = False Then
            sde_ber = abz1(6)
          Else
            sde_ber = 0
        End If
      Case 2110
        If keine_ber! = False Then
            sde_ber = abz1(16)
           Else
            sde_ber = 0
        End If
      Case 212
        If keine_ber! = False Then
            sde_ber = abz2(6)
        Else
            sde_ber = 0
        End If
      Case 2120
        If keine_ber! = False Then
            sde_ber = abz2(16)
        Else
            sde_ber = 0
        End If
      Case 213
        If keine_ber! = False Then
            sde_ber = abz3(6)
           Else
            sde_ber = 0
        End If
      Case 2130
        If keine_ber! = False Then
            sde_ber = abz3(16)
        Else
            sde_ber = 0
        End If
      Case 214
        If keine_ber! = False Then
            sde_ber = abz4(6)
        Else
            sde_ber = 0
        End If
      Case 2140
        If keine_ber! = False Then
            sde_ber = abz4(16)
          Else
            sde_ber = 0
        End If
      Case 221
        If keine_ber! = False Then
            sde_ber = abz1(7)
           Else
            sde_ber = 0
        End If
      Case 2210
        If keine_ber! = False Then
            sde_ber = abz1(17)
           Else
            sde_ber = 0
        End If
      Case 222
        If keine_ber! = False Then
            sde_ber = abz2(7)
           Else
            sde_ber = 0
        End If
      Case 2220
        If keine_ber! = False Then
            sde_ber = abz2(17)
        Else
            sde_ber = 0
        End If
      Case 223
        If keine_ber! = False Then
            sde_ber = abz3(7)
          Else
            sde_ber = 0
        End If
      Case 2230
        If keine_ber! = False Then
            sde_ber = abz3(17)
           Else
            sde_ber = 0
        End If
      Case 224
        If keine_ber! = False Then
            sde_ber = abz4(7)
        Else
            sde_ber = 0
        End If
      Case 2240
        If keine_ber! = False Then
            sde_ber = abz4(17)
        Else
            sde_ber = 0
        End If
      Case Else
    End Select
  End If
 
  'sde_ber = 11111   'sde_pos1

  z = 0

  '
End Function

Attribute VB_Name = "Modul4"

Public Function vorsorge(vz As Single, pk1 As Single, pk2 As Single, aeb1 As Single, aeb2 As Single, lohn_m As Double, lohn_m_vers As Double, lohn_f As Double, lohn_f_vers As Double) As Double
  ' *******************
  ' *Vorsorgepauschale*
  ' *******************
  Dim vspo1 As Double, vspo2 As Double, ae1 As Double, ae2 As Double
  Dim re4o As Double, re4o_1 As Double, vsp As Double, kztab As Single, krv As Single
  Dim vspvor As Double, vspvor1 As Double, vspmax1 As Double, vspmax2 As Double, vspkurz As Double
  Dim lohnakt_m As Double, lohnakt_f As Double, jx As Double
  Dim vspo_merker!
  Dim vsp_1 As Double, vsp_2 As Double, vsp2 As Double, vsp3 As Double, vsp4 As Double, vsp5 As Double, vsp6 As Double
  Dim arund As Double
  Dim vspo As Double
  Dim vspor As Double
  Dim vsp_rest1 As Double, vsp_rest2 As Double

  
  
  lohnakt_m = lohn_m - lohn_m_vers   'lohn_m = alle L|fffd|hne - Versorgungsfreibetrag
  lohnakt_f = lohn_f - lohn_f_vers   'lohn_akt = alle L|fffd|hne - Versorgungsbez|fffd|ge
  
  ae1 = aeb1
  If 0.4 * (lohnakt_m) < aeb1 Then
    ae1 = 0.4 * (lohnakt_m)
  End If
  gx = lohn_m - ae1
  ae2 = aeb2
  If 0.4 * (lohnakt_f) < aeb2 Then
    ae2 = 0.4 * (lohnakt_f)
  End If
  gy = lohn_f - ae2
  jx = gx + gy
  're4o = jx
   '
   '
    If pk1 + pk2 <> 3 Then
      If pk2 = 0 Then
        '
        kztab = 1
        '
        If pk1 = 1 Then     'A-
          krv = 0
        Else
          krv = 1           'B-
        End If
        '
        're4o = jx    '??????????????????????? einegef|fffd|gt - nicht in GFA!!
        vsp = mvsp(vz, kztab, krv, re4o)    '
       Else         'wenn pk2<>0
        kztab = 2
        If pk1 = 1 And pk2 = 1 Then       'AA
          krv = 0
        End If
        If pk2 + pk1 = 4 Then             'BB
          krv = 1
        End If
      End If     'pk2=0
      '
      re4o = jx
      vsp = mvsp(vz, kztab, krv, re4o)
      '
    Else                          'AB/BA  pk1+pk2=3
      re4o = jx
      kztab = 2
      Select Case vz
      Case 1996 To 2010
        vs_f = 20         ' %satz-Faktor
        vs_ba = 2214      ' H|fffd|chstabzug f|fffd|r Beamte
      End Select
      vspo1 = Fix(gx * vs_f / 100 + 0.99)
      vspo2 = Fix(gy * vs_f / 100 + 0.99)
      '
      If pk1 = 2 Then
        'ba! = True         'f|fffd|r die Ausgabe bei gfa
        If vspo1 > vs_ba Then
          vspo1 = vs_ba
        End If
      Else
        If vspo2 > vs_ba Then
          vspo2 = vs_ba
        End If
      End If
      '
      vspo = vspo1 + vspo2
      vspo_ausg = vspo
      vspo_merker! = True
      '
      '
      krv = 0
      vsp = mvsp(vz, kztab, krv, re4o)   'hier wird 1. Alternative berechnet
      vsp_1 = vsp
      '
      vspo_merker! = False
      re4o_1 = re4o           'zwischenspeicher
      '
      If pk1 = 2 Then
        re4o = gx
      Else
        re4o = gy
      End If
      krv = 1
      vsp = mvsp(vz, kztab, krv, re4o)     'hier wird 2. Alternative berechnet
      
      vsp_2 = vsp
      '
      re4o = re4o_1
      re4o_1 = 0
      '
      If vsp_1 > vsp_2 Then
        vsp = vsp_1
      Else
        vsp = vsp_2
      End If
      '
      '
    End If      'pk1+pk2 <> 3
    '
    vorsorge = vsp
    'vorsorge = lohn_m
    'vorsorge = 1
       '

End Function

Public Function mvsp(vz, kztab, krv, re4o) As Double
'

  If vspo_merker! = 0 Then         'wenn merker=1 wird vspo in
      vspo = re4o * 20 / 100        'Vorsorgepauschale 1996 pkz AB berechnet
  End If
  vspo = Fix(vspo + 0.99)
'
  vspkurz = 2214 * kztab
  If vz >= 1993 Then
    vspvor1 = 6000 * kztab
    vspmax1 = 2610 * kztab
    vspmax2 = 1305 * kztab
  End If
  If witw! = True Then
      vspkurz = 4428
      If vz >= 1993 Then
      vspvor1 = 12000
      vspmax1 = 5220
      vspmax2 = 2610
    End If
    '
  End If
  '
  '
  If krv = 1 Then
    If vspo > vspkurz Then
      vsp = vspkurz
    Else
      vsp = vspo
    End If
  Else
    vsp = umvsp(vz, re4o, vspvor1, vspmax1, vspmax2, vspkurz, vspo)
  End If
     '
  arund = vsp
  mvsp = uprund54(arund)
  

End Function

Public Function uprund54(arund) As Double
 '
  arund = Fix(arund / 54)
  uprund54 = arund * 54
 '
End Function


Public Function umvsp(vz, re4o, vspvor1, vspmax1, vspmax2, vspkurz, vspo) As Double
'
  vspvor = vspvor1 - re4o * 12 / 100
  If vz >= 1993 Then
    vspvor = vspvor1 - re4o * 16 / 100
  End If
  
  'Min = Fix(re4o * 12 / 100)      'f|fffd|r ausgabe in GFA - noch
  'If vz >= 1993 Then
    'Min = Fix(re4o * 16 / 100)    'f|fffd|r ausgabe
  'End If
  'If Min > vspvor1 Then
    'Min = vspvor1
  'End If
  '
  If vspvor < 0 Then
    vspvor = 0
  End If
  If vspo <= vspvor Then
    vsp3 = vspo
    vsp = vsp3
  Else
    vsp1 = vspvor
    vsprest1 = vspo - vspvor
    '
    '
    If vsprest1 <= vspmax1 Then
      vsp4 = vsp1 + vsprest1
      vsp = vsp4
    Else
      vsp2 = vsp1 + vspmax1
      vsprest2 = Fix((vsprest1 - vspmax1) / 2 + 0.99)
      '
      If vsprest2 <= vspmax2 Then
        vsp5 = vsp2 + vsprest2
        vsp = vsp5
      Else
        vsp6 = vsp2 + vspmax2
        vsp = vsp6
      End If    ' vsprest<=vspmax2
    End If      ' vsprest<=vspmax1
  End If        ' vspo>vspvor
  '
  umvsp = vsp

End Function
Attribute VB_Name = "Modul5"

Public Function beg32c(jahr As Single, heirat, gew_m1 As Single, gew_m2 As Single, gew_f1 As Single, gew_f2, zve As Double, sde As Double, steuer As Double) As Double
   Dim gew_entl As Double, gew_beg2 As Double, gew_beg1 As Double
  
   gew_beg1 = gew_m1 + gew_m2 + gew_f1 + gew_f2
   
   ' gew_beg1 = ek(2) + ek(12) - INT(VAL(gew3_m$)) - INT(VAL(gew3_f$))
   ' IF gew_beg1 > 0 AND ag(1) <> 0 then                 '  Sonst div durch 0 m|fffd|glich
   '   @beg32c
   ' ENDIF
   
   
   'Beginn der GFA Proc beg32c
  
   
  If heirat = 1 Then
    gew_beg2 = Int(gew_beg1 * zve / sde)             ' ag(1) = sde
  Else
    gew_beg2 = Int(gew_beg1 * zve / sde / 2)
  End If
   gew_beg2 = Int(gew_beg2 / 54) * 54
  '
  Select Case jahr
  Case 1994 To 1998
    min32c = 100278     '=100224 + 54
    stand32c = 100224
    steuerst = 30869      ' Grundtab von 100224
    satz32c = 0.47         '
  Case 1999
    min32c = 93690 + 54     '=93690 + 54
    stand32c = 93690
    steuerst = 27820      ' Grundtab von 93690
    satz32c = 0.45         '
  Case 2000 To 2001
    min32c = 84780 + 54     '
    stand32c = 84780
    steuerst = 23855     ' Grundtab von 84780
    satz32c = 0.43        '
  Case 2002 To 2010
    min32c = 88236 + 54     '
    stand32c = 88236
    steuerst = 24024      ' Grundtab von 88236
    satz32c = 0.43        '
  End Select
  '
  If gew_beg2 < min32c Or steuer < steuerst Then
    gew_entl = 0
  Else
    '
    If gew_beg1 <= sde Then            ' wenn beg|fffd|nst. gewerbl. eink < sde
    '
      '
      'Public Function vortab(vz As Single, heirat As Single, zve As Double, ek34 As Single, progek As Single, art As Single)
       
       zw = gew_beg2 'da bei tabelle/abnachtab ge|fffd|ndert witd
       beg_t = vortab(jahr, 1, gew_beg2, 0, 0, 1)  'immer heirat = 1 Grundtab
      'beg_t = t             'Ergebnis
       gew_beg2 = zw
      '
      a = Fix((gew_beg2 - stand32c) * satz32c)  'nur zur kontrolle
      
      gew_entl = beg_t - steuerst - Fix((gew_beg2 - stand32c) * satz32c)
      If heirat = 2 Then
        gew_entl = 2 * gew_entl
      End If
    Else          'wenn beg|fffd|nstigte eink|fffd|nfte > sde   ggf verlusten aus anderen Eink
      If heirat = 1 Then
        steuer32c_2 = steuerst + Fix(satz32c * (zve - stand32c))
        gew_entl = steuer - steuer32c_2
      Else                                                    'IF heirat = 2 '
        ' ohne |fffd|ber grundtabelle  auch m|fffd|glich:
        ' wenn steuerst (98=2*30869)   verdoppelt und stand32c verdoppelt  (98 = 2*100224)
        steuer32c_2 = steuerst * 2 + Fix(satz32c * (zve - stand32c * 2))
        gew_entl = steuer - steuer32c_2             't = ergebnis tabelle
      End If
    End If
    '
    If gew_entl <= 0 Then
      gew_entl = 0
    End If
   End If
   beg32c = gew_entl
    'beg32c = 1
    
End Function
Attribute VB_Name = "Modul6"
Public Function auswertkinder(a1 As Single, j1 As Single, tabe As Single, ek_aus As Double, hhf_aus As Single, haerte_aus As Single, ee_34 As Single, prog_k As Single, kfb_e As Single, kfb_solz As Single, k_geld As Single)
'hier wird f|fffd|r VZ ab 1996 errechnet ob Kinderfreibetrag oder Kindergeld
  Dim st As Double, st1 As Double, st2 As Double, kg As Double
  Dim e_o_kfb As Double, e_m_kfb As Double, e_m_vol_kfb As Double
  Dim st_ek34_1 As Double, st_ek34_2 As Double, st_ek34 As Double
    
    steuerersp_m_kfb = 0
    diff_st_kg = 0
  If j1 >= 1996 Then
    e_o_kfb = ek_aus - hhf_aus - haerte_aus
    e_m_kfb = ek_aus - hhf_aus - haerte_aus - kfb_e
    e_m_vol_kfb = ek_aus - hhf_aus - haerte_aus - kfb_solz
    If ee_34 <> 0 Or prog_k <> 0 Then
      st1 = Fix(vortab(j1, tabe, e_o_kfb, ee_34, prog_k, 6)) 'Steuer ohne Kinderfreibetrag
                                                             'art 6 bringt ganze Steuer zur|fffd|ck
      st2 = Fix(vortab(j1, tabe, e_m_kfb, ee_34, prog_k, 6))   'Steuer mit Kfb_est
      st3 = Fix(vortab(j1, tabe, e_m_vol_kfb, ee_34, prog_k, 6))   'Steuer mit Kfb_solz
    Else   '|fffd|bergabewert =1
      st1 = Fix(vortab(j1, tabe, e_o_kfb, ee_34, prog_k, 1))   'Steuer ohne Kinderfreibetrag
                                                             'art 6 bringt ganze Steuer zur|fffd|ck
      st2 = Fix(vortab(j1, tabe, e_m_kfb, ee_34, prog_k, 1))   'Steuer mit Kfb_est
      st3 = Fix(vortab(j1, tabe, e_m_vol_kfb, ee_34, prog_k, 1))   'Steuer mit Kfb_solz

    End If
    '
    steuerersp_m_kfb = st1 - st2                            'Steuerersparnis , wenn kfb
    '
    If k_geld >= steuerersp_m_kfb Then                       'Wenn K_Geld > Steuerersparnis
    'If k_geld >= diff_st_kg Then
        st = st1            'Steuer ohne Kfb nicht zur|fffd|ck, da vortab
        st_ek34 = st_ek34_1 'nicht zur|fffd|ck, da vortab
        kfb = 0                                             'Ausgabe KFB
        kg = 0                                              'Ausgabe Kindergeld
    Else                                                    ' sonst
        st = st2             'Steuer mit Kfb nicht zur|fffd|ck, da vortab / aber f|fffd|r KISTSOLZ
        st_ek34 = st_ek34_2  'nicht zur|fffd|ck, da vortab
        kfb = kfb_e                                         'Ausgabe KFB
        kg = k_geld                                         'Ausgabe KGeld
    End If
    'If st_ek34 <> 0 Then
       'st = st - st_ek34     'f|fffd|r getrennte ausgabe ganze u, erm|fffd||fffd|. Steuer
    'End If
    '
    Select Case a1         'art
      Case 1
        auswertkinder = st         'R|fffd|ckgabewert EST wird nicht gebraucht
      Case 2
        auswertkinder = st_ek34    'R|fffd|ckgabewert darin Steuer auf ek34 nicht gebraucht
      Case 3
        auswertkinder = kfb
      Case 4
        auswertkinder = kg
      Case 5
        auswertkinder = st3   'ggf. f|fffd|r Kist/soli
      Case 6
        auswertkinder = steuerersp_m_kfb
      Case 7
        auswertkinder = st1
      Case 8
        auswertkinder = st2
    End Select
    'auswertkinder = 100
    'auswertkinder = st1
      
'Else    'vz<1996
' anders gel|fffd|st - bei Verzeigung nach Auswert
End If

End Function
Attribute VB_Name = "Modul7"

Public Function KistSolZ(a2 As Single, v As Single, hei As Single, pk2n As Single, est1 As Double, ki1 As Single, ki2 As Single, kistsa As Double, sde1_x As Double, sde2_x As Double, st_m_ki As Double, kinderg As Single, anzKst As Single, vergKst As Single) As Double
    Dim kia As Double, kistev As Double, kistrk As Double, kid As Double
    
    If sde1_x >= 1 Then     'sonst kommt #Wert
        ki5 = vortab(v, 1, sde1_x, 0, 0, 1)      'f|fffd|r glaubensversch Eheg. Steuer Grundtabelle
    Else
        ki5 = 0
    End If
    If sde2_x >= 1 Then     'wenn das nicht gemacht wird, kommt Ausgabe #Wert  ?????
        ki6 = vortab(v, 1, sde2_x, 0, 0, 1)
    Else
        ki6 = 0
    End If
      
    'Bemessungsgrundlage ist die Steuer mit Ber|fffd|cksichtigung des vollen Kfb*12 Monate
    kia = st_m_ki - kg    'steuer mit vollen Kinderfreibetr|fffd|gen
    If kia <= 0 Then
        kia = 0
        kistev = 0    'ev ag(33)
        kistrk = 0    'rk ag(36)
    Else            'wenn Kia>0  =Bemessungsgrunl
        If pk2n = 0 Then
            ki2 = ki1
        End If
        If ki1 <> 0 And ki2 <> 0 Then
            If ki1 = ki2 And ki1 = 1 Then
                kistev = kia * kistsa
            End If
            If ki1 = ki2 And ki1 = 2 Then
                kistrk = kia * kistsa
            End If
            If ki1 <> ki2 Then
                'kistev = Fix(kia * kistsa * 0.5 * 100) / 100
                'kistrk = Fix(kia * kistsa * 0.5 * 100) / 100
                kistev = kia * kistsa * 0.5
                kistrk = kia * kistsa * 0.5
            End If
        End If   'ki <> 0 And ki2 <> 0
        If (ki1 <> 0 And ki2 = 0) Or (ki1 = 0 And ki2 <> 0) Then
            kib = ki5
            If ki1 = 0 Then
                kib = ki6
            End If
            kic = ki5 + ki6           'st_m + st_f
            kid = Fix(kia * kib / kic) 'Anteil an Bemessungsgrundlage
            If ki1 = 1 Or ki2 = 1 Then
                kistev = kistsa * kid
            End If
            If ki1 = 2 Or ki2 = 2 Then
                kistrk = kistsa * kid
            End If
        End If     'If (ki1 <> 0 And i2 = 0) Or (ki1 = 0 And ki2 <> 0)
    End If    'Kia<0
    '
    'Solidarit|fffd|tszuschlag
    solisatz = 0.055   ' ab 1996
    bemsoli = st_m_ki - anzKst - vergKst
    soli = bemsoli * solisatz
    Select Case v
    'Case 1995
        'soli_fg = 1332
    Case 1998 To 2010   'ggf anpassen !!!!!!!!!!!!!!!!!!!!!!!!!!
        soli_fg = 1836
    Case Else
    End Select
    
    soli_fg = soli_fg * hei
    
    If bemsoli <= soli_fg Then
        soli = 0
    Else
        If soli > (bemsoli - soli_fg) * 20 / 100 Then
             soli = (bemsoli - soli_fg) * 20 / 100
        End If
    End If
    
    'Ausgabe
    If a2 = 1 Then
        KistSolZ = kistev + kistrk    'solange nicht getrennt ausgewiesen wird
    End If
        If a2 = 2 Then
        KistSolZ = soli   '
    End If

    'KistSolZ = kia
    'KistSolZ = pk2n
    'KistSolZ = kistsa
    'KistSolZ = kia
    
    'KistSolZ = bemsoli
    'KistSolZ = 444

End Function
Attribute VB_Name = "Modul8"

Public Function mj_ber(arte As Single, lohn_m As Double, lohnvb_m As Double, lohnvbmj_m As Double, lohnmj_m As Double, wk As Double, lohn_f As Double, lohnvb_f As Double, lohnvbmj_f As Double, lohnmj_f As Double, wky As Double) As Double

' ***** |fffd| 34 ESTG Eink|fffd|nfte f|fffd|r mehrere Jahre *****   bleibt auch nach 1998 erorderlich


  Dim mj(1 To 17) As Double
  Dim vfbt_m As Double, vfbt_f As Double, vfbtr1_m As Double, vfbtr1_f As Double
  
  
  For i = 1 To 17
     mj(i) = 0
  Next i

  ' *Versorgungs-Freibetrag*

  lohnges_m = lohn_m + lohnvbmj_m + lohnmj_m
  lohnges_f = lohn_f + lohnvbmj_f + lohnmj_f
  lohnpass_m = lohnvb_m + lohnvbmj_m
  lohnpass_f = lohnvb_f + lohnvbmj_f

  vfbt_m = 0.4 * (lohnpass_m)
  vfbt_m = Int(vfbt_m)
 
  vfbt_max = 6000
  
  If vfbt_m > vfbt_max Then
    vfbt_m = vfbt_max
  End If
  
  vfbt_f = 0.4 * (lohnpass_f)
  vfbt_f = Int(vfbt_f)
  If vfbt_f > vfbt_max Then
    vfbt_f = vfbt_max
  End If
  
  vfbt1_m = vfbt_m
  vfbt1_f = vfbt_f
  
  wkp_m = 2000      'Arbeitnehmerfreibetrag
  If lohnges_m - vfb_m < wkp Then
    wkp_m = lohnges_m - vfb_m
  End If
   wkp_f = 2000      'Arbeitnehmerfreibetrag
  If lohnges_f - vfb_f < wkp_f Then
    wkp_f = lohnges_f - vfb_f
  End If
  
  ' ** Versorgungsbez|fffd|ge f|fffd|r mj  (- anteil. Versorgungsfrbt - ant. WK-Pauschb.)
  '
  If lohnvbmj_m > 0 Then
    mj(11) = Fix(lohnvbmj_m / (lohnvb_m + lohnvbmj_m) * vfbt_m + 0.5)   'Anteil Fbt f|fffd|r VersorgBezMJ
    vfbt1_m = vfbt_m - mj(11)   'Anteil Freibetrag f|fffd|r lfde. VersBez_m
    mj(1) = lohnvbmj_m - mj(11) '= verbleib. VersBez mj
    '
    If lohnges_m - vfbt_m > 0 And wk <= wkp_m Then        'wk =tats|fffd|chliche Wk Mann
      mj(12) = Fix(mj(1) / (lohnges_m - vfbt_m) * wkp_m + 0.5)   'anteil WK-Pauschbetr. verbl. VersBez
      mj(3) = mj(1) - mj(12)   ' WK-Pauschbetr./mj(3)= verbl. VersorgBez mj-anteilige WK
    End If
  End If
  If lohnvbmj_f > 0 Then
    mj(13) = Fix(lohnvbmj_f / (lohnvb_f + lohnvbmj_f) * vfbt_f + 0.5)    'Aufteil. Versorg.frbt
    vfbt1_f = vfbt_f - mj(13)   'Anteil f|fffd|r lfde. VersBez_f
    mj(2) = lohnvbmj_f - mj(13)  'Aufteil. Versorg.frbt
    If lohnges_f - vfbt_f > 0 And wky <= wkp_f Then           'wky =tats|fffd|chliche Wk Frau
      mj(14) = Fix(mj(2) / (lohnges_f - vfbt_f) * wkp_f + 0.5)     'WK-Pauschbetr.
      mj(4) = mj(2) - mj(14) '  "     WK-Pauschbetr.
    End If
  End If
  '
  ' ***beg|fffd|nstigte aktive Arbeitslohn f|fffd|r mj(-anteil. Wk-Pauschbtr.)
  '
  If lohnmj_m > 0 And wk <= wkp_m Then
    If lohnges_m - vfbt_m > 0 Then
      mj(15) = Fix(lohnmj_m / (lohnges_m - vfbt_m) * wkp_m + 0.5) 'Auft. WK-Pauschb.
      mj(5) = lohnmj_m - mj(15)
    End If
  End If
  If lohnmj_f > 0 And wky <= wkp_f Then
    If lohnges_f - vfbt_f > 0 Then
      mj(16) = Fix(lohnmj_f / (lohnges_f - vfbt_f) * wkp_f + 0.5)  'Auft. WK-Pauschb.
      mj(6) = lohnmj_f - mj(16)       'Auft. WK-Pauschb.
    End If
  End If
  '
  If mj(3) = 0 Then        'Wenn WK>wkp bleiben die beg|fffd|nstigten ungek|fffd|rzt
    mj(7) = mj(1)          '= verbleib. VersBez mj
  Else
    mj(7) = mj(3)          'mj(3)= verbl. VersorgBez mj-anteilige WK
  End If
  If mj(5) = 0 Then
    mj(9) = lohnmj_m
  Else
    mj(9) = mj(5)           'mj(5) = lohnmj_m - anteilige WK mj(15)
  End If
  '
  If mj(4) = 0 Then
    mj(8) = mj(2)
  Else
    mj(8) = mj(4)
  End If
  If mj(6) = 0 Then
    mj(10) = lohnmj_f
  Else
    mj(10) = mj(6)
  End If
  '
  ' Summe der beg|fffd|nstigten Eink|fffd|nfte f|fffd|r mehrere Jahre
  ' (ekmj= bei besonderen Er|fffd||fffd|igungen)
  emj = mj(7) + mj(8) + mj(9) + mj(10) + ekmj
  '
  Select Case arte
  Case 1
    mj_ber = vfbt1_m 'Anteilig. Versorgungsfbt lohnvb_m
  Case 2
    mj_ber = mj(11)  'Anteilig. Versorgungsfbt lohnvbmj_m
  Case 3
    mj_ber = vfbt1_f 'Anteilig. Versorgungsfbt lohnvb_f
  Case 4
    mj_ber = mj(13)   'Anteilig. Versorgungsfbt lohnvbmj_f
  Case 5
    mj_ber = mj(12) 'Anteil WK-Pauschbetr. lohnvbmj_m
  Case 6
    mj_ber = mj(15) 'Anteil WK-Pauschbetr. lohnmj_m
  Case 7
    mj_ber = mj(14) 'Anteil WK-Pauschbetr. lohnvbmj_f
  Case 8
    mj_ber = mj(16) 'Anteil WK-Pauschbetr. lohnmj_f
  Case Else
  End Select
'RETURN
  
  
 ' mj_ber = vfbt_m
  'mj_ber = arte
  '
  'mj_ber = lohnges_m '- vfbt_m
  ' mj_ber = mj(1)
  
End Function
Attribute VB_Name = "Modul9"

Public Function st_mj_v99(vz_n As Single, heirat_n As Single, zve_n As Double, ek34_n As Single, progek_n As Single, emj_n As Single, art As Single) As Double
'
    Dim zve_mj1 As Double, zve_mj2 As Double, zve_zn As Double, emj_zn As Single, progek_zn As Single
    Dim ek34_zn As Single, ganzeSt As Double
    zve_zn = zve_n ' zve_n |fffd|ndert sich unerkl|fffd|rlich!!
    emj_zn = emj_n
    progek_zn = progek_n
    ek34_zn = ek34_n
       
    If emj_n > 0 Then    'Eink|fffd|nfte f|fffd|r mehrere Jahre
        '
        'Steuer vor Anwendung mj v99
        ganzeSt = Fix(vortab(vz_n, heirat_n, zve_zn, ek34_zn, progek_zn, 6))
        '
        zve_zn = zve_n ' zve_n |fffd|ndert sich unerkl|fffd|rlich!!
        emj_zn = emj_n
        progek_zn = progek_n
        ek34_zn = ek34_n
        zve_mj1 = zve_zn - emj_zn    'ohne mj
        
        st_emj_1 = Fix(vortab(vz_n, heirat_n, zve_mj1, ek34_zn, progek_zn, 6))
        
        zve_zn = zve_n ' zve_n |fffd|ndert sich unerkl|fffd|rlich!!
        emj_zn = emj_n
       
        zve_mj2 = zve_zn - emj_zn + (Fix(emj_zn / 3))    'mit 1/3 * mj
        
        progek_zn = progek_n   'neu, da sich Zahlen |fffd|ndern!!! Warum?????
        ek34_zn = ek34_n
            
        st_emj_2 = Fix(vortab(vz_n, heirat_n, zve_mj2, ek34_zn, progek_zn, 6))
        
        
        mj_unter = st_emj_2 - st_emj_1
        st_mj = mj_unter * 3      'Diff * 3
        '
        erm_mj95 = ganzeSt - st_emj_1 - st_mj
        'normale Steuerberechnung zur Probe
        
        'probe = Fix(vortab(vz_n, heirat_n, zve_zn, ek34_n, progek_n, 1))
        '@tabelle
        '
        If st_mj + st_emj_1 < ganzeSt Then    'pr|fffd|fen ob mj-Brechnung g|fffd|nstiger ist
          'mj! = True
          st_mj_v99 = -erm_mj95
        Else
            st_mj_v99 = 0     'probe - st_emj_1 '= diff ganze St ohne mj zu st ohne mj
        End If
         'st_mj_v99 = zve_n - emj_zn
         'st_mj_v99 = emj_n
         'st_mj_v99 = zve_mj1
        'st_mj_v99 = st_mj
        'st_mj_v99 = ek34_n
        'st_mj_v99 = st_emj_1
        'st_mj_v99 = st_emj_2
        'st_mj_v99 = mj_unter
        'st_mj_v99 = st_emj_1
        'st_mj_v99 = st_emj_2
        'st_mj_v99 = ganzeSt
      
       
      End If 'emj>0
   
End Function
Attribute VB_Name = "Tabelle1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

Attribute VB_Name = "Tabelle10"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

Attribute VB_Name = "Tabelle11"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

Attribute VB_Name = "Tabelle2"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

Attribute VB_Name = "Tabelle3"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

Attribute VB_Name = "Tabelle4"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

Attribute VB_Name = "Tabelle5"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

Attribute VB_Name = "Tabelle6"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

Attribute VB_Name = "Tabelle7"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

Attribute VB_Name = "Tabelle8"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

Attribute VB_Name = "Tabelle9"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True



INQUEST-PP=macro
