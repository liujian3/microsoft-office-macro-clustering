Attribute VB_Name = "AddControl"
Attribute VB_Base = "0{FCFB3D2A-A0FA-1068-A738-08002B3371B5}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Public Tag As String
Public ColumnCount  As Long
Public ColumnWidths As String
Public RowSource As String
Public BoundColumn  As Long
Public ColumnHeads As Boolean
Public AutoSize As Boolean
'Public LeftLabel As Integer
'Public TopLabel As Integer
'Public WidthLabel As Integer
Public MultiSelect  As Long
Public LastHeight  As Long
Public MaxBottom  As Long
Public MaxLength  As Long
Public MaxRight  As Long
Public Visible As Boolean
Private TF As Object


Public Function AddControl(sTypeControl$, Optional name$ = "", Optional Caption, Optional Top As Long, Optional left As Long, Optional Height As Long = 0, Optional Width As Long, Optional Visible As Boolean = True, Optional Enabled As Boolean = True) As Variant
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim Opt As Control
Static iob As Long, icb As Long, icom As Long
Dim s As String
Static iMaxBottom  As Long
Static iMaxRight   As Long

s = "Forms." & Trim$(sTypeControl) & ".1"
On Error Resume Next
Set Opt = UserForm1.Controls.Add(s)
If err <> 0 Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Function

With Opt
    .left = left
    .Top = Top
    .Width = Width
    If Height > 0 Then .Height = Height
    If sTypeControl = "ComboBox" Then .Style = fmStyleDropDownList: .Height = 18
'    If sTypeControl = "ComboBox" Then
'    .Style = fmStyleDropDownCombo: .Height = 18
'    .BoundColumn = 2
'    End If
    .Tag = Tag
    .Visible = Visible
    If Len(name) > 0 Then .name = name
    Select Case sTypeControl
    Case "OptionButton"
         .Caption = Caption: .AutoSize = AutoSize
         ReDim Preserve Options(1 To iob + 1)
         Set Options(iob + 1).OptionGroup = Opt
         iob = iob + 1
    Case "CommandButton"
         .Caption = Caption
         ReDim Preserve Buttons(1 To icb + 1)
         Set Buttons(icb + 1).ButtonGroup = Opt
         icb = icb + 1
            UserForm1.cmdFontSize.Top = .Top
    Case "ComboBox", "ListBox"
        .Font.Size = GetFontSizeElement
        .ColumnCount = ColumnCount
        .ColumnHeads = ColumnHeads
        .ColumnWidths = ColumnWidths
        If EmptyName(RowSource & "1") > 0 Then .RowSource = RowSource & "1" Else .RowSource = RowSource
'        If RowSource = "Data_FKR" Then .RowSource = "Data_FKR1" Else .RowSource = RowSource
'        .RowSource = RowSource
        .BoundColumn = BoundColumn
        .MultiSelect = MultiSelect
         ReDim Preserve Combos(1 To icom + 1)
         Set Combos(icom + 1).ComboGroup = Opt
         icom = icom + 1
    Case "Label"
        .Caption = Caption
        .AutoSize = AutoSize
        .Enabled = Enabled
    Case "TextBox"
         If Caption Like "*GUID*" Then .name = Caption
        .Font.Size = GetFontSizeElement
  'Spiridonova 19.11.2012
        If MaxLength > 49 Then
            .MaxLength = MaxLength  ''254
            .MultiLine = True
            .Height = 60
            .Width = 400
        Else
            .MaxLength = MaxLength
        End If
        '.MaxLength = MaxLength
   'Spiridonova 19.11.2012
        .TextAlign = 2  '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
        .Tag = Caption
        .Enabled = Enabled
        '.AutoSize = AutoSize
'        If Len(Name) > 0 And IsNumeric(Name) Then .Text = Name
        If Len(name) > 0 Then .Text = name
    End Select
'    LastHeight = .Height
    If iMaxBottom < .Top + .Height Then iMaxBottom = .Top + .Height
    If iMaxRight < .left + .Width Then iMaxRight = .left + .Width

    MaxBottom = iMaxBottom
    MaxRight = iMaxRight
End With
End Function

Public Function GetFontSizeElement() As Long
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ComboBox ListBox TextBox
Dim sFont

On Error Resume Next
sFont = GetSetting("Svod", "Forms", "FontSiZe", "9")
GetFontSizeElement = Val(sFont)
End Function

Attribute VB_Name = "ConvertData"
Public Type DataORG
    kodINN As String
    kodKPP As String
    kodORG As String
    kodOKPO As String
    kodOKATO As String
    kodGL As String
    kodSTOPdata As String
End Type

Public Type ReportAttributes
    formRef As String
    formCode As String
    formVDE  As Long
    formVZD  As Long
    formKPL As String
    formACCOUNT As String
    formSGU As String
End Type

Public Function GetConvStr(ByVal pParam As String, ByVal pVersion As String) As String
    Dim strData, pLine, FilePath As String
    Dim ChangeData As Long
    
    FilePath = ThisWorkbook.Path & "\ConvVersion_" & pVersion & ".ini"
    ChangeData = 0
    
    Open FilePath For Input As #2
      
    Do Until EOF(2)
        Line Input #2, strData
        pLine = InStr(1, strData, pParam, vbTextCompare)
        If pLine > 0 Then
            GetConvStr = Right(strData, Len(strData) - InStr(1, strData, "="))
            ChangeData = 1
            Exit Do
        End If
    Loop
    
    If ChangeData = 0 Then GetConvStr = pParam
    
    Close #2
    
End Function

Public Function InputArr(ByVal pCell As String, ByVal pData As String, iData() As Variant)
    Dim SaveData() As Variant
    Dim i As Long, j As Long, k As Long
    Dim repRekvData As String
    
    j = 1
    
    If Not IsEmpty(iData(1, 1)) Then
        j = UBound(iData) + 1
        SaveData = iData
        ReDim iData(1 To j, 1 To 2)
    
        For i = 1 To UBound(SaveData, 1)
            iData(i, 1) = SaveData(i, 1)
            iData(i, 2) = SaveData(i, 2)
        Next i
    End If

    iData(j, 1) = pCell
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "Kod_" + pRekvName |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    repRekvData = ""
    
    For k = 1 To ActiveWorkbook.Names.Count
        If ActiveWorkbook.Names.Item(k).NameLocal = "Kod_" + pCell Then
            repRekvData = Range("Kod_" + pCell).Text
            Exit For
        End If
    Next k
    
    iData(j, 2) = IIf(repRekvData = "", pData, repRekvData)
    InputArr = iData
End Function

Public Function TakeArrData(ByVal StrNum As String, pData As Variant) As String
    Dim s As Long
    
    For s = 1 To UBound(pData, 1)
        If pData(s, 1) = StrNum Then
            TakeArrData = pData(s, 2)
            Exit For
        Else
            TakeArrData = -1
        End If
    Next s
End Function

Public Sub UpdateArrData(ByVal arrName As String, ByVal arrValue As String, pData As Variant)  '<<<!!! new
    Dim s As Long

    For s = 1 To UBound(pData, 1)
        If pData(s, 1) = arrName Then
            pData(s, 2) = arrValue
            Exit For
        End If
    Next s
End Sub

Public Sub AddProtokol(NewSheetName As String, NewStrData As String)
    Dim WS As Worksheet
    Dim r As Long

    For Each WS In Worksheets
        If WS.name = NewSheetName Then
            WS.Activate
            For r = 1 To WS.Rows.Count
                If Application.Cells(r, 1).Value = "" Then
                    fUnProtect (True)
                    Application.Cells(r, 1).Value = NewStrData
                    fUnProtect (False)
                    Exit For
                End If
            Next r
            Exit Sub
        End If
    Next

    fUnProtectAll
    ActiveWorkbook.Sheets.Add
  
    With ActiveSheet
        .Move After:=Worksheets(Worksheets.Count)
        .name = NewSheetName
        .Tab.ColorIndex = 3
    End With
    Application.Cells(1, 1).Value = NewStrData
    fProtectAll
End Sub

Public Function GetDicNameRekv(ByVal pData As String)
    Dim WS As Worksheet
    Dim r As Long
    Dim obj As Object
    Dim pStr As String
    
    Set obj = Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
    For r = 1 To obj.Rows.Count
        pStr = obj.Cells(r, 1).Value
        If InStr(1, pStr, pData) Then GetDicNameRekv = Mid(pStr, InStr(1, pStr, " ") + 1, (InStr(1, pStr, " -") - InStr(1, pStr, " ")))
    Next r
End Function

Function TakeCompositeStr(pStrName As String, pData() As Variant, Optional pStrPart As String = "")
    Dim pFormat, pRekvName As String
    Dim pStep, pPoint, i As Long, j As Long
    
    pFormat = sGetINI("ConversionStrCode", "?")
    
    If pFormat <> "?" Then
        pStep = InStr(1, pStrName, "(")
        If pStep <> 0 Then
            pPoint = InStr(pStep, pStrName, ")")
            pStrName = Mid(pStrName, 1, pStep - 1)
        End If
    
        pStep = 1
        pPoint = InStr(pStep, pFormat, Replace(pStrName, "Data_", "") + IIf(pStrPart = "", "", "x" + pStrPart) + "(")
        pStep = pPoint
        Do While pPoint <> 0
            pPoint = InStr(pStep, pFormat, "(")
            pStep = pPoint + 1
            pPoint = InStr(pStep, pFormat, ")")

            i = 1
            Do While i <> 0
                i = InStr(pStep, pFormat, "+")
                
                If i <> 0 And i < pPoint Then
                    pRekvName = Mid(pFormat, pStep, i - pStep)
                Else
                    pRekvName = Mid(pFormat, pStep, pPoint - pStep)
                End If
                
                '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                j = InStr(1, pRekvName, ":", vbTextCompare)
                If j <> 0 Then
                    pData = InputArr(Mid(pRekvName, 1, j - 1), Mid(pRekvName, j + 1), pData)
                Else
                    pData = InputArr(pRekvName, "", pData)
                End If
                pStep = i + 1
                If i > pPoint Then Exit Do
            Loop
            Exit Do
        Loop
    End If
    
    TakeCompositeStr = pData
End Function

Public Sub CloseProtokol(DeleteSheetName As String)
    Dim WS As Worksheet

    Application.DisplayAlerts = False

    For Each WS In Worksheets
        If WS.name = DeleteSheetName Then
            WS.Delete
            Exit Sub
        End If
    Next
    
    Application.DisplayAlerts = True
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function CheckFileFormat(pXMLDoc As DOMDocument) As Boolean
    Dim xmlFileNode As IXMLDOMNodeList
    Dim isLoad As Boolean
    Dim i  As Long
    
    isLoad = True
    
    Set xmlFileNode = pXMLDoc.SelectNodes("//envelope[@xsi:type='ReportEnvelope']")
    
    With xmlFileNode.Item(0).Attributes
        If .Length > 0 Then
            For i = 0 To .Length - 1
                Select Case .Item(i).nodeName
                    Case "xsi:type"
                        If .Item(i).NodeValue <> "ReportEnvelope" Then isLoad = False
                    Case "version"
                        If .Item(i).NodeValue <> "2.0" Then isLoad = False
                    Case "reportCount"
                        If .Item(i).NodeValue <= 0 Then isLoad = False
                End Select
                
                If Not isLoad Then Exit For
            Next i
        End If
    End With
    
    CheckFileFormat = isLoad
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'   NodeData - |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
'   AttributeName - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

Public Function TakeAttributeValue(pXMLDoc As DOMDocument, NodeData As String, AttributeName As String) As String
    Dim xmlDataNode As IXMLDOMNodeList
    Dim i As Long
    
    Set xmlDataNode = pXMLDoc.SelectNodes(NodeData)
    
    With xmlDataNode.Item(0).Attributes
        If .Length > 0 Then
            For i = 0 To .Length - 1
                If .Item(i).nodeName = AttributeName Then
                    TakeAttributeValue = .Item(i).NodeValue
                    Exit For
                End If
            Next i
        End If
    End With
End Function

' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Sub AddConstDataToReport(pConstData() As Variant, pWorkbookName As String)
    Dim k As Long, iErr As Long
    Dim wf As name
    
    If UBound(pConstData) > 1 Or pConstData(1, 1) <> "" Then
        fUnProtect True

        For k = 1 To UBound(pConstData)
            iErr = 0
            For Each wf In Workbooks(pWorkbookName).Names  'ThisWorkbook.Names
                '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                If wf.name = pConstData(k, 1) Then
                    If IsEmpty(Range(wf.name).Value) Then Range(wf.name).Value = pConstData(k, 2)
                    iErr = 1
                    Exit For
                End If
            Next wf
            If iErr = 0 And Not IsEmpty(pConstData(k, 1)) Then AddProtokol "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| " & pConstData(k, 1) & ", |fffd||fffd||fffd||fffd||fffd| = " & pConstData(k, 2)
        Next k
        
        fUnProtect False
    End If
End Sub

'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function TakeAttributeValueInCurrentNode(xmlAttributeNode As IXMLDOMNamedNodeMap, strNameAttribute As String) As String
    Dim j  As Long
    
    j = 0
    With xmlAttributeNode
        For j = 0 To .Length - 1
            If .Item(j).nodeName = strNameAttribute Then
                TakeAttributeValueInCurrentNode = .Item(j).NodeValue
                Exit Function
            End If
        Next j
    End With
    
    TakeAttributeValueInCurrentNode = ""
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|-|fffd||fffd|-|fffd||fffd||fffd|00:00:00 |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
'   strData - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

Public Function StringFormatToData(strData As String) As String
    If Mid(strData, 5, 1) = "-" And Mid(strData, 8, 1) = "-" Then
        StringFormatToData = Mid(strData, 9, 2) & "." & Mid(strData, 6, 2) & "." & Mid(strData, 1, 4)
    Else
        MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|"
        StringFormatToData = ""
    End If
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| 1|fffd|
Public Function CheckReportPeriod(strPeriod As String) As Boolean
    If Range("Kod_STOPdata").Value = IIf(Month(strPeriod) = 1, CStr(DateAdd("m", 12, strPeriod)), CStr(DateAdd("m", 3, strPeriod))) Then
        CheckReportPeriod = True
    Else
        CheckReportPeriod = False
    End If
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function TakeCharCode(strChar As String) As Long
    TakeCharCode = Asc(strChar)
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Public Function CheckAllRekvRepInserted() As Boolean
    Dim strRekvList, strRekvName As String
    Dim iStep As Long, iPoint As Long
    
    Application.Worksheets(1).Activate
    
    strRekvList = Replace(sGetINI(ActiveSheet.name & "!|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?"), " ", "")
    iStep = 1
    iPoint = 1
    
    If strRekvList <> "?" Then
        
        Do While iPoint <> 0
            iPoint = InStr(iStep, strRekvList, ",")
            strRekvName = Replace(Mid(strRekvList, iStep, IIf(iPoint <> 0, (iPoint - iStep), Len(strRekvList))), "Data", "Kod")
            
            '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| "TXT3_GL(|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|)=438"
            If InStr(strRekvName, "(") > 0 Then
                strRekvName = Mid(strRekvName, 1, InStr(strRekvName, "(") - 1)
            End If
            
            If InStr(strRekvName, "TXT") > 0 Then
                strRekvName = "Kod" + Mid(strRekvName, InStr(strRekvName, "_"))
            End If
            
            If Range(strRekvName).Value = "" Then
                CheckAllRekvRepInserted = False
                Exit Function
            End If
            
            iStep = iPoint + 1
        Loop
    End If
    
    CheckAllRekvRepInserted = True
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| INI
'   pDataSheet - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'   pStrName - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'   pParamName - |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'   pReturnValue - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|

Public Function sGetPartINI(pDataSheet As String, pStrName As String, pParamName As String, pReturnValue As String) As String
    Dim k  As Long
    Dim strData As String
    
    strData = Replace(sGetINI(pStrName, "?"), " ", "")
    k = InStr(strData, "PART:" + pDataSheet)
    
    If k > 0 Then
        k = InStr(k, strData, pParamName)
        
        If k > 0 Then
            sGetPartINI = Mid(strData, k + Len(pParamName), IIf(InStr(k, strData, ",") = 0, Len(strData), InStr(k, strData, ",") - (k + Len(pParamName))))
        End If
    Else
        sGetPartINI = pReturnValue
    End If
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Function PutRepDataToPart(arrData() As Variant, ByVal pStrCode As String, pStrValue As Currency) As Variant
    Dim j As Long
    
    If TakeArrData(pStrCode, arrData) = "-1" Then
        If pStrValue <> 0 Then arrData = InputArr(pStrCode, pStrValue, arrData)       '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Else
        For j = 1 To UBound(arrData)
            If arrData(j, 1) = pStrCode And pStrValue <> 0 Then arrData(j, 2) = arrData(j, 2) + pStrValue '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        Next j
    End If
    
    PutRepDataToPart = arrData
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| xml-|fffd||fffd||fffd||fffd||fffd|
Public Function TakeAllRepRekv(pXMLNodes As IXMLDOMNodeList, ByRef pRepAttr() As ReportAttributes) As ReportAttributes()
    Dim pXMLNode As IXMLDOMNode
    Dim k  As Long
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|
    ReDim pRepAttr(pXMLNodes.Length)
    
    For k = 0 To pXMLNodes.Length - 1
        For Each pXMLNode In pXMLNodes(k).ChildNodes
            TakeReportsRekv pXMLNode, k, pRepAttr
        Next pXMLNode
    Next k
    
    TakeAllRepRekv = pRepAttr
End Function

Public Function TakeReportsRekv(pXMLNode As IXMLDOMNode, iCount As Long, ByRef pRepAttr() As ReportAttributes) As ReportAttributes()

    With pXMLNode.Attributes
        If .Length > 0 Then
            If .Item(0).NodeValue = "urn:entities-1c-ru:reports/form-ref" Then pRepAttr(iCount).formRef = pXMLNode.Text
            If .Item(0).NodeValue = "urn:entities-1c-ru:reports/formCode" Then pRepAttr(iCount).formCode = pXMLNode.Text
                                                   
            If .Item(0).NodeValue = "urn:entities-1c-ru:budget/payment-token" Then
                If pXMLNode.HasChildNodes Then
                    pRepAttr(iCount).formKPL = TakeAttributeValueInCurrentNode(pXMLNode.FirstChild.Attributes, "idString")
                End If
            End If
            
            If .Item(0).NodeValue = "urn:entities-1c-ru:budget/classification/kvd" Then pRepAttr(iCount).formVDE = IIf(pXMLNode.Text = "", 0, pXMLNode.Text)
            
            If .Item(0).NodeValue = "urn:entities-1c-ru:budget/combined-activity-kind" Then
                If pXMLNode.HasChildNodes Then
                    pRepAttr(iCount).formVDE = Replace(TakeAttributeValueInCurrentNode(pXMLNode.FirstChild.Attributes, "idString"), "|fffd||fffd||fffd|_", "")
                End If
            End If
            
            If .Item(0).NodeValue = "urn:entities-1c-ru:budget/liability/kind" Then
                If pXMLNode.HasChildNodes Then
                    pRepAttr(iCount).formVZD = IIf(LCase(TakeAttributeValueInCurrentNode(pXMLNode.FirstChild.Attributes, "idString")) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 1, 2)
                End If
            End If
        End If
    End With
    
    TakeReportsRekv = pRepAttr
End Function

Public Function FindReportIndex(pXMLNodes As IXMLDOMNodeList, pRepAttr() As ReportAttributes, pFormCode As String, pFormRef As String, Optional pFormKVD As Long = 0, Optional pFormVZD As Long = 0) As Long
    Dim pXMLNode As IXMLDOMNode
    Dim pCount As Long, k As Long
                               
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|
    '   pCount - |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    pCount = -1
    For k = 0 To UBound(pRepAttr)

        If pRepAttr(k).formCode <> "" Then
            If pRepAttr(k).formCode = pFormCode And pRepAttr(k).formRef = pFormRef Then
                
                If pRepAttr(k).formACCOUNT = "" And pRepAttr(k).formKPL = "" And pRepAttr(k).formSGU = "" And pRepAttr(k).formVDE = 0 And pRepAttr(k).formVZD = 0 Then
                    pCount = k
                    Exit For
                Else
                    If pRepAttr(k).formVDE <> 0 And pRepAttr(k).formVDE = pFormKVD Then
                        If pRepAttr(k).formVZD = 0 Then
                            pCount = k
                            Exit For
                        End If
                        
                        If pRepAttr(k).formVZD <> 0 And pRepAttr(k).formVZD = pFormVZD Then
                            pCount = k
                            Exit For
                        End If
                    End If
                End If
            End If
        End If
    Next k
    
    FindReportIndex = pCount
End Function


'Ivanov 13/06/2017 ====
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|-|fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Public Function GetFormatUser(ByVal InputData As String, sFormat As String) As String
    GetFormatUser = Format(InputData, sFormat)
End Function
'=================
Attribute VB_Name = "ModAvtoZapolnenie"
Option Explicit

Public Function fAvteZapolnenie() As Long
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| fRasstMain
Dim a, sKod$, sDSName$, iKod As Long
Dim i As Long, j As Long
Dim rData_CollFormat As Range

If fOptions("Option_AvtoLoad") <> 1 Then GoTo A1

'<SPIR> 15.10.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|)
If HasName("Data_CollFormat") Then
    Set rData_CollFormat = ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range("Data_CollFormat")
    With gCollFormat
        If .Count <> rData_CollFormat.Rows.Count Then  ' |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            For i = 1 To rData_CollFormat.Rows.Count
                '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                ReDim arrFormat(1 To rData_CollFormat.Columns.Count - 1)
                For j = 1 To rData_CollFormat.Columns.Count - 1
                    arrFormat(j) = rData_CollFormat.Cells(i, j + 1).Value
                Next j
                '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                .Add arrFormat, rData_CollFormat.Cells(i, 1).Value
            Next i
        End If
    End With
Else
'    gCollFormat.Add Null, "ElNull"
End If

'-----------01.12.2015
fSaveFilterAndFormat

For Each a In ActiveWorkbook.Names
    'If A.Name Like "Data_Sheet*" Then
    If UCase(a.name) Like "DATA_SHEET*" Then
            sKod = sGetINI(a.name & "!Kod", "?")
            If sKod Like "*$*" And StrEl(sKod) = 1 Then
                iKod = Val(Trim$(sReplace(sKod, "$", "")))
                fvstavka a.name, iKod
            End If
    End If
Next
For Each a In ActiveWorkbook.Sheets
 'If Not (A.Name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or A.Name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|") And A.Visible = True Then
 If Not (UCase(a.name) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or UCase(a.name) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|") And a.Visible = True Then
    sKod = sGetINI(a.name & "!Kod", "?")
    If sKod Like "*$*" And StrEl(sKod) = 1 Then
        iKod = Val(Trim$(sReplace(sKod, "$", "")))
        sDSName = "Data_Sheet" & a.Index
        If EmptyName(sDSName) > 0 Then
            If Range(sDSName).Worksheet.name = a.name Then fvstavka sDSName, iKod
        End If
    End If
 End If
Next
fShowCmdInsDelRow
A1:
fAvteZapolnenie = -1
End Function

Function fInsertRow_and_Name(ByVal sDSName$, ByVal sFKod$, ByVal sKod$, ByVal iKod As Long, ByVal sname$, ByVal iName As Long, ByVal k As Long) As Long
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Dim Row As Long, i As Long
On Error Resume Next
With ActiveWorkbook.Worksheets(Range(sDSName).Worksheet.Index)
    Row = Range(sDSName).Row + Range(sDSName).Rows.Count - 1
    .Rows(Row).Insert Shift:=xlDown
    .Cells(Row, iKod) = sFKod
    If iName > 0 Then .Cells(Row, iName) = sname
    fInsertNameStr sDSName, sKod, 0, k
End With
fInsertRow_and_Name = Row
End Function

Public Sub fvstavka(ByVal sDSName$, iKod As Long)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| sData_Sheet
Dim sTipeSp$, sWS$, iName As Long, sSp$, sFKod$, ind As Long
Dim k As Long, j As Long, i As Long, n As Long
Dim R_Data As Range, Row As Long
Dim sKod$, sname$, s1$
On Error Resume Next
Application.ScreenUpdating = False
'sDSName = "Data_Sheet" & ind
ind = Range(sDSName).Worksheet.Index
sWS = ActiveWorkbook.Worksheets(ind).name
fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Index
fUnProtect True, ind

' Spiridonova 10.12.2009
If flgUseDataSheetInCodName = True Then
    s1 = Right(Trim(sDSName), gLenDopKodForCodName)
End If
'

sTipeSp = sGetINI(sDSName & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
If sTipeSp <> "?" Then
    iName = Val(sGetINI(sDSName & "!Name", "?"))
Else
    sTipeSp = sGetINI(sWS & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
    iName = Val(sGetINI(sWS & "!Name", "?"))
End If

If sTipeSp = "?" Then Exit Sub
If iKod > iName Then k = iKod Else k = iName
n = StrEl(sTipeSp)
For j = 1 To n
    sSp = StrEl(sTipeSp, j)
    If sSp Like "*+*" Then fvstavka2 sReplace(sSp, "+", ","), sDSName, iKod, iName: GoTo A1
    Set R_Data = Range(sSp)
    For i = 1 To R_Data.Rows.Count
        sKod = R_Data.Cells(i, 1)
        sFKod = fFormat(sKod, sSp)
        
        If Len(sKod) > 0 Then
            ' Spiridonova 10.12.2009
            If flgUseDataSheetInCodName = True Then
                sKod = s1 & sKod
            End If
            '
            sname = R_Data.Cells(i, 2)
            Row = fInsertRow_and_Name(sDSName, sFKod, sKod, iKod, sname, iName, k)
            fExecProc ind, Row, sKod '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
        End If
    Next i
A1:
Next j
''fUnProtect False, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Index
''fUnProtect False, ind
Set R_Data = Nothing
End Sub

Public Sub fvstavka2(ByVal sTipeSp$, ByVal sDSName$, ByVal iKod As Long, ByVal iName As Long)
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| sData_Sheet c |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim sname$, sSp$, sFKod$, sSp2$, ind As Long
Dim j As Long, sKod$, sKod0$, n As Long, i As Long, k As Long, Row As Long
Dim a() As Variant, r As Range
'On Error Resume Next
Application.ScreenUpdating = False
If StrEl(sTipeSp) <> 2 Then Exit Sub
'sDSName = "Data_Sheet" & ind
ind = Range(sDSName).Worksheet.Index
If iName > iKod Then k = iName Else k = iKod
sSp2 = StrEl(sTipeSp, 2)
Set r = Range(sSp2)
ReDim a(1 To r.Rows.Count, 1 To 2)
For j = 1 To r.Rows.Count
        sKod = Trim$(r.Cells(j, 1))
        If Len(sKod) > 0 Then
            n = n + 1
            a(n, 1) = sKod
            If iName > 0 Then a(n, 2) = r.Cells(j, 2)
        End If
Next j
sSp = StrEl(sTipeSp, 1)
Set r = Range(sSp)
For i = 1 To r.Rows.Count
sKod0 = Trim$(r.Cells(i, 1))
If Len(sKod0) = 0 Then GoTo A1
    For j = 1 To n
        sKod = sKod0 & a(j, 1)
        sFKod = fFormat(sKod0, sSp) & sR & fFormat(a(j, 1), sSp2)
        If iName > 0 Then sname = a(j, 2)
        Row = fInsertRow_and_Name(sDSName, sFKod, sKod, iKod, sname, iName, k)
        fExecProc ind, Row, sKod '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Next j
A1:
Next i
Set r = Nothing
End Sub

Attribute VB_Name = "ModF074"
Public sSelectRange As String
'
'---------------------------------------|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub InsertColumn()
UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
AddFormarekvizit "Data_RCH"
End Sub
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
Public Sub RenameColumn()
Dim r As Range, sKod$
Set r = Selection
sKod = r.Cells(1, 1).Value
sKod = sReplace(sKod, " ", "")
sKod = sReplace(sKod, "'", "")
If Len(sKod) = 0 Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
If HasInSpr(sKod, "Data_RCHGr") Then MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
If HasInSpr(sKod, "Data_RCH") = False Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub

UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
AddFormarekvizit "Data_RCH"
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
Public Sub AddColumn()
Dim sKod(0) As String, s$, idForm$

    idForm = sGetINI("idForm", "?")
    s = UserForm1.Controls("ListBox1").Value
    s = sReplace(s, " ", "")
    s = sReplace(s, "'", "")
    If HasName("rr1" & s) = True Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
    UnProtectBook
    If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then
        sKod(0) = s
        Select Case idForm
            Case "14_179"
                AddColumnList_179 sKod
                CleareFormuls
                InsertFormuls
            Case "14_2018"
                AddColumnList_2018 sKod
                CleareFormuls_2018
                InsertFormuls_2018
            Case "14_86"
                AddColumnList_86 sKod
                CleareFormuls_86
                InsertFormuls_86
            Case Else
                AddColumnList sKod
                CleareFormuls
                InsertFormuls
        End Select
'        If idForm = "14_179" Then
'            AddColumnList_179 sKod
'        Else
'            AddColumnList sKod
'        End If
'        CleareFormuls
'        InsertFormuls
    Else
        Select Case idForm
            Case "14_2018"
               RenameColumns_2018 s
            Case "14_86"
               RenameColumns_86 s
            Case Else
                RenameColumns s
        End Select
'        RenameColumns s
    End If
ProtectBook
'Range(sSelectRange).Select
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub fSelectColumn()
If Len(sSelectRange) > 0 And HasName(sSelectRange) Then Range(sSelectRange).Select
End Sub
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function Rasstanovka014FromArray(a As Variant) As Variant
Dim Val As Variant, sKod(0) As String, sname$, n As Long, err() As Variant
ReDim err(1 To 100, 1 To 2)
n = LBound(err, 1)
UnProtectBook
For i = LBound(a) To UBound(a)
    sname = Trim$(a(i, 1))
    If Len(sname) = 0 Then GoTo a2
'    Val = IIf(A(i, 1) > 0, A(i, 1), A(i, 2))
    Val = a(i, 2)
    If Not sname Like "ss*[a-c]" Then GoTo A1
    If Len(sname) < 23 Then GoTo A1
    sKod(0) = Mid$(sname, 3, Len(sname) - 6)
    If HasName("rr1" & sKod(0)) Then GoTo A1
    AddColumnList sKod
A1:
    If HasName(sname) Then If HasFormula(Range(sname)) = False Then Range(sname) = Val
'    Else
''        err(n, 1) = sName
''        err(n, 2) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
''        n = n + 1
'    End If
a2:
Next i
InsertFormuls
ProtectBook
'If n = LBound(err) Then Rasstanovka014FromArray = 0
'Else
'    ReDim Preserve err(1 To n - 1, 1 To 2)
'    Rasstanovka014FromArray = err
'End If
Rasstanovka014FromArray = 0
End Function
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| fRasstMain - |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Data_Spr1
Public Function fRasstColumns() As Long
'On Error Resume Next
Dim r As Range, i As Long, sKod$, sKod1$, sname$
Dim sKodm(1) As String
'Dim flF074 As String
If EmptyName("Data_Spr1") < 2 Then fRasstColumns = -1: Exit Function  '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
UnProtectBook

Set r = Range("Data_Spr1")
r.Sort Key1:=r.Cells(1, 1), Order1:=xlAscending
For i = 1 To r.Rows.Count
    sname = Trim$(r.Cells(i, 1))   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    If HasName(sname) Then GoTo A1    '|fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    If Not sname Like "ss*[a-c]" Then GoTo A1
    If Len(sname) < 23 Then GoTo A1
    sKod = Mid$(sname, 3, Len(sname) - 6)
'    sKod = Mid$(sKod, 3, 19)
    If (HasInSpr(sKod, "Data_RCHGr")) Then GoTo A1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If HasName("rr1" & sKod) Then GoTo A1
    If sKod <> sKod1 Then
        sKod1 = sKod
        sKodm(0) = sKod
        AddColumnList sKodm
    End If
A1:
Next i
Set r = Nothing
'flF074 = sGetINI("GLRP", "?")
'If HasName("Data_Options") = True Then flF074 = Trim$(Range("Data_Options").Cells(1, 2).value)
'If Len(flF074) > 0 And flF074 <> "?" Then fGroupAdd        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
ProtectBook
fRasstColumns = -1
End Function


'-------------------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function AddColumnList(sKod() As String) As String
Dim r As Range, i As Long, Rv As Range, Rds As Range, Rds4 As Range, j As Long, sp$, sAd$
Dim sAdrv$, sAdds$, sAdds4$ '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'    On Error Resume Next
For j = 1 To 3
    sp = Trim$(str(j))
    Set Rv = Range("Data_" & sp & "3v")
    Rv.Columns.EntireColumn.Hidden = False
    For i = LBound(sKod) To UBound(sKod)
        If Len(sKod(i)) = 0 Then GoTo a2
        Set r = Range("Data_" & sp & "1v").Cells(1, 1)
        If IsEmpty(r.Value) Or Len(r.Value) = 0 Then Set Rds = Range("Data_" & sp & "1"): Set Rds4 = Range("Data_41"): GoTo A1
        Set r = Range("Data_" & sp & "2v").Cells(1, 1)
        If IsEmpty(r.Value) Or Len(r.Value) = 0 Then Set Rds = Range("Data_" & sp & "2"): Set Rds4 = Range("Data_42"): GoTo A1
        
        sAdrv = "='" & Rv.Worksheet.name & "'!" & Rv.Cells.Address
        sAdds = "='" & Rv.Worksheet.name & "'!" & Range("Data_" & sp & "3").Address
        If j = 3 Then sAdds4 = "='" & Rv.Worksheet.name & "'!" & Range("Data_43").Address
        Rv.Copy
        Rv.Insert Shift:=xlToRight
        Application.CutCopyMode = False
        Set Rds = Range(sAdds)
        If j = 3 Then Set Rds4 = Range(sAdds4)
        Set r = Range(sAdrv).Cells(1, 1)
A1:
        r.Value = FormatKod(sKod(i))
        sAd = "='" & r.Worksheet.name & "'!" & r.Address
        ActiveWorkbook.Names.Add name:="rr" & sp & sKod(i), RefersTo:=sAd
        insertName sKod(i), Rds, "Kod" & sp, False
        If j = 3 Then
            insertName sKod(i), Rds4, "Kod4", False
        End If
a2:
    Next i
    fMerge Rv.Worksheet
    Rv.Columns.EntireColumn.Hidden = True
Next j
AddNN
If UBound(sKod) = 0 Then sSelectRange = "rr1" & sKod(0)
Set Rds = Nothing
Set Rv = Nothing
Set r = Nothing
End Function

'----------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub fGroupAdd()
Dim mKodGr() As String, mKod() As String, i As Long, Org$, sKodRrimary$, j As Long, sKodGr$

If MsgBox("|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|?", 4 + 256, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|") = 7 Then Exit Sub
UnProtectBook
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
mKod() = ReturnKods(False)
'If UBound(mKod) = 0 And mKod(0) = "False" Then MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Sub
    
Range("Data_13v").Columns.EntireColumn.Hidden = False
Range("Data_23v").Columns.EntireColumn.Hidden = False
Range("Data_33v").Columns.EntireColumn.Hidden = False

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
For i = 0 To UBound(mKod)
    sKodRrimary = mKod(i)
    Org = Mid$(sKodRrimary, 20, 4)
    mKodGr() = fKodsGr(left(sKodRrimary, 19))
    For j = 0 To UBound(mKodGr)
'            sKodGr = KodGr(j)
            sKodGr = mKodGr(j) & Org
            If Len(sKodGr) > 0 And Not HasName("rg1" & sKodGr) Then AddGRColumn sKodRrimary, sKodGr
            sKodRrimary = sKodGr
    Next j
Next i
AddNN
CleareFormuls
InsertFormuls
Range("Data_13v").Columns.EntireColumn.Hidden = True
Range("Data_23v").Columns.EntireColumn.Hidden = True
Range("Data_33v").Columns.EntireColumn.Hidden = True
ProtectBook
End Sub
'-------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub AddGRColumn(ByVal sKodRrimary$, ByVal sKodGr$)
Dim sNamePrimary$, sGrName$, j As Long, sp$
Dim Rv As Range, r As Range, Rpr As Range
Dim sAdrDS$, Rds As Range, w As Worksheet, sAd$

For j = 1 To 3
    sp = Trim$(str(j))
    sNamePrimary = "rr" & sp & sKodRrimary
    If Not HasName(sNamePrimary) Then sNamePrimary = "rg" & sp & sKodRrimary
    Set Rpr = Range(sNamePrimary)
    sGrName = "rg" & sp & sKodGr
    Set Rv = Range("Data_" & sp & "3v")
    Set w = Rv.Worksheet
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set r = Range(w.Cells(Rv.Row, Rpr.Column), w.Cells(Rv.Row + Rv.Rows.Count - 1, Rpr.Column + Rv.Columns.Count - 1))
    sAdrDS = "='" & Rv.Worksheet.name & "'!" & r.Address
    Rv.Copy
    r.Insert Shift:=xlToRight
    Set r = Range(sAdrDS)
'    If j <> 3 Then R.ColumnWidth = 12.86 Else R.ColumnWidth = 14.29
    r.Cells(1, 1) = FormatKod(sKodGr)
        sAd = "='" & r.Worksheet.name & "'!" & r.Cells(1, 1).Address
        ActiveWorkbook.Names.Add name:=sGrName, RefersTo:=sAd
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| ~ Data_11
Set Rds = Range(w.Cells(Range("Kod" & sp).Row, r.Column), w.Cells(Rv.Row + Rv.Rows.Count - 1, r.Column + r.Columns.Count - 1))
Rds.Interior.ColorIndex = xlNone
Rds.Locked = True
insertName sKodGr, Rds, "Kod" & sp, True
If j = 3 Then
    Set Rds = w.Range(w.Cells(Range("Kod4").Row, r.Column), w.Cells(Range("Kod4").Row + Range("Kod4").Rows.Count - 1, r.Column + r.Columns.Count - 1))
    insertName sKodGr, Rds, "Kod4", True
    Rds.Interior.ColorIndex = xlNone
    Rds.Locked = True
End If
fMerge Rv.Worksheet
Next j
Set r = Nothing
Set Rpr = Nothing
Set Rv = Nothing
Set Rds = Nothing
Set w = Nothing
End Sub

Attribute VB_Name = "ModF074New"
Option Explicit

'---------------------------------|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd|
'TMP |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd|
Public Function DBToArray() As Variant
Dim sFName$, sql$, a() As Variant, i As Long, s$
Dim db As Database, rs As Recordset

sFName = "c:\TMP\" & ActiveWorkbook.name & ".mdb"
Set db = OpenDatabase(sFName, False, False)
sql = "Select * From Data"
Set rs = db.OpenRecordset(sql, dbOpenDynaset, dbReadOnly)
  rs.MoveLast
  rs.MoveFirst
ReDim a(1 To rs.RecordCount, 2)
i = LBound(a)
Do Until rs.EOF
a(i, 1) = rs("Kod")
'A(i, 1) = rs("Value1")
'A(i, 2) = rs("Value2")
a(i, 2) = rs("Value3")
  rs.MoveNext
  i = i + 1
Loop
DBToArray = a
End Function
'TMP  |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub TempUpr1()
Rasstanovka014FromArray DBToArray
End Sub
'---------------------------------------- 14 |fffd||fffd||fffd||fffd||fffd|


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Public Sub CleareFormuls()
Dim j As Long, sp$, r As Range, Col1 As Long, Rds As Range, Col2 As Long, w As Worksheet, s$
'Dim n As Name, sName, iKod%, sKod$
On Error GoTo A1
'UnProtectXlt1
For j = 1 To 4
    sp = Trim$(str(j))
    Set r = Range("Data_" & sp & "3")
    Set w = r.Worksheet

'    Col1 = Range("Kod" & sp).Column + 1 + R.Columns.Count
    Col1 = Range("Kod" & sp).Column + 1
    Col2 = r.Column - 1
    Set Rds = Range(w.Cells(r.Row, Col1), w.Cells(r.Row + r.Rows.Count - 1, Col2))
    For Each r In Rds
        s = r.Formula
        If Len(s) = 0 Or s = "X" Or left$(s, 5) = "=|fffd||fffd||fffd||fffd|" Or left$(s, 4) = "=SUM" Then GoTo A1
        If left$(s, 1) = "=" Then r.Formula = ""
A1:
    Next
Next j
Set r = Nothing
Set Rds = Nothing
Set w = Nothing
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub RenameColumns(sKodNew$)
Dim sKOdOld$, mKodGr() As String, sKodGrOld$, sKodGrNew$, j As Long, s$, sp$, r As Range, Rds As Range, sAd$
Set r = Selection
sKOdOld = r.Cells(1, 1).Value
sKOdOld = sReplace(sKOdOld, "'", "")
sKOdOld = sReplace(sKOdOld, " ", "")
mKodGr() = fKodsGr(sKOdOld)
If UBound(mKodGr) > 0 Then sKodGrOld = mKodGr(0)
If HasName("rg1" & sKodGrOld) Then
    mKodGr() = fKodsGr(sKodNew)
    If UBound(mKodGr) > 0 Then sKodGrNew = mKodGr(0)
    If sKodGrOld <> sKodGrNew Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
End If
Unload UserForm1
DelNamesss sKOdOld  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| "Data_Cells"
For j = 1 To 3
    sp = Trim$(str(j))
    s = "rr" & sp & sKOdOld
    Set r = Range(s)
    Set Rds = Range("Data_" & sp & "1")
    sAd = "='" & r.Worksheet.name & "'!" & Range(Cells(Rds.Row, r.Column), Cells(Rds.Row + Rds.Rows.Count - 1, r.Column + Rds.Columns.Count - 1)).Address
    Set Rds = Range(sAd)
    sAd = "='" & r.Worksheet.name & "'!" & r.Address
    ActiveWorkbook.Names(s).Delete
    r.Value = sKodNew
    ActiveWorkbook.Names.Add name:="rr" & sp & sKodNew, RefersTo:=sAd
    insertName sKodNew, Rds, "Kod" & sp, False
        If j = 3 Then
            Set Rds = Range("Data_41")
            sAd = "='" & r.Worksheet.name & "'!" & Range(Cells(Rds.Row, r.Column), Cells(Rds.Row + Rds.Rows.Count - 1, r.Column + Rds.Columns.Count - 1)).Address
            insertName sKodNew, Rds, "Kod4", False
        End If
Next j
Set r = Nothing
Set Rds = Nothing
End Sub
Public Sub DeleteColumn()
Dim n As name, r As Range, sp$, Rv As Range, sAd$, j As Long, sKod$, Rds As Range, w As Worksheet, sname$, s$
For Each n In ActiveWorkbook.Names
    sname = n.name
    If n.name Like "rg*" Then MsgBox "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
Next

Set r = Selection
sKod = r.Cells(1, 1).Value
sKod = sReplace(sKod, "'", "")
sKod = sReplace(sKod, " ", "")
If Len(sKod) = 0 Or Not HasInSpr(sKod, "Data_RCH") Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
If MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| " & sKod & " ?", 4 + 256, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|") = 7 Then Exit Sub
UnProtectBook
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| c |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
If DelName11(sKod) Then GoTo a2
DelNamesss sKod
For j = 1 To 3
    sp = Trim$(str(j))
    s = "rr" & sp & sKod
    Set r = Range(s)
    Set w = r.Worksheet
    Set Rv = Range("Data_" & sp & "1v")
    sAd = "='" & r.Worksheet.name & "'!" & Range(Cells(Rv.Row, r.Column), Cells(Rv.Row + Rv.Rows.Count - 1, r.Column + Rv.Columns.Count - 1)).Address
    Set Rv = Range(sAd)
    
    If DelName2(Rv, sp) Then GoTo A1
    If DelName1(Rv, sp) Then GoTo A1

    
'    If Rv.Column > Range("Data_" & sp & "2v").Column Then
        Rv.Delete Shift:=xlToLeft
        Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
        
A1:
'    Else
'        R.Value = ""
'        Set Rds = Range("Data_" & sp & "1")
'        sAd = "='" & R.Worksheet.Name & "'!" & Range(Cells(Rds.row, R.Column), Cells(Rds.row + Rds.Rows.Count - 1, R.Column + Rds.Columns.Count - 1)).Address
'        fCleareRange Range(sAd)
'        If j = 3 Then
'            Set Rds = Range("Data_41")
'            sAd = "='" & R.Worksheet.Name & "'!" & Range(Cells(Rds.row, R.Column), Cells(Rds.row + Rds.Rows.Count - 1, R.Column + Rds.Columns.Count - 1)).Address
'            fCleareRange Range(sAd)
'        End If
'    End If
    ActiveWorkbook.Names(s).Delete
    fMerge w
Next j
AddNN
a2:
CleareFormuls
InsertFormuls
ProtectBook
Set r = Nothing
Set Rv = Nothing
Set Rds = Nothing
Set w = Nothing
End Sub
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub fDeleteGroup()
Dim n As name, i As Long, sp$
UnProtectBook
For Each n In ActiveWorkbook.Names
    If n.name Like "rg*" Then fDeleteGroupCol n.name
Next
AddNN
CleareFormuls
InsertFormuls
For i = 1 To 3
    sp = Trim$(str(i))
    fMerge Range("Data_" & sp & "1v").Worksheet
Next i
CleareFormuls
InsertFormuls
ProtectBook
End Sub
Public Sub fDeleteGroupCol(sname$)
Dim r As Range, sAd$, sp$, Rv1 As Range, Rv2 As Range

Set r = Range(sname)
r.Value = ""
sp = Mid$(sname, 3, 1)
Set Rv1 = Range("Data_" & sp & "1v")
Set Rv2 = Range("Data_" & sp & "2v")

sAd = "='" & r.Worksheet.name & "'!" & Range(Cells(Rv1.Row, r.Column), Cells(Rv1.Row + Rv1.Rows.Count - 1, r.Column + Rv1.Columns.Count - 1)).Address
Set r = Range(sAd)

ActiveWorkbook.Names(sname).Delete
If r.Address <> Rv1.Address And r.Address <> Rv2.Address Then
'    Rv.Columns.EntireColumn.Hidden = False
    r.Delete Shift:=xlToLeft
    Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
Else
    fCleareRange r
End If
End Sub

'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| "Data_" & sp & "2v"
Public Function DelName2(Rv As Range, sp$) As Boolean
Dim sAdv$, sAdds$, sAdds4$
If Rv.Address <> Range("Data_" & sp & "2v").Address Then
    DelName2 = False
    Exit Function
End If
sAdv = "='" & Rv.Worksheet.name & "'!" & Rv.Address
sAdds = "='" & Rv.Worksheet.name & "'!" & Range("Data_" & sp & "2").Address
If sp = "3" Then sAdds4 = "='" & Rv.Worksheet.name & "'!" & Range("Data_42").Address
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|
If Rv.Column = Range("Data_" & sp & "3v").Column - Rv.Columns.Count Then
        Rv.Cells(1, 1).Value = ""
        fCleareRange Range("Data_" & sp & "2")
        If sp = "3" Then fCleareRange Range("Data_42")
Else
        Rv.Delete Shift:=xlToLeft
        ActiveWorkbook.Names.Add name:="Data_" & sp & "2v", RefersTo:=sAdv
        ActiveWorkbook.Names.Add name:="Data_" & sp & "2", RefersTo:=sAdds
        If sp = "3" Then ActiveWorkbook.Names.Add name:="Data_42", RefersTo:=sAdds4
        Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
End If
DelName2 = True
End Function

'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| "Data_" & sp & "1v"
Public Function DelName1(Rv1 As Range, sp$) As Boolean
Dim sAdv1$, sAdv2$, sAdds1$, sAdds2$, sAdds41$, sAdds42$
Dim Rv2 As Range
If Rv1.Address <> Range("Data_" & sp & "1v").Address Then
    DelName1 = False
    Exit Function
End If
Set Rv2 = Range("Data_" & sp & "2v")
If Len(Rv2.Cells(1, 1).Value) = 0 Then
    Rv1.Cells(1, 1).Value = ""
    fCleareRange Range("Data_" & sp & "1")
    If sp = "3" Then fCleareRange Range("Data_41")
End If

If Rv2.Column < Range("Data_" & sp & "3v").Column - Rv1.Columns.Count Then
    sAdv1 = "='" & Rv1.Worksheet.name & "'!" & Rv1.Address
    sAdv2 = "='" & Rv2.Worksheet.name & "'!" & Rv2.Address
    sAdds1 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_" & sp & "1").Address
    sAdds2 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_" & sp & "2").Address
    If sp = "3" Then
        sAdds41 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_41").Address
        sAdds42 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_42").Address
    End If
    Rv1.Delete Shift:=xlToLeft
    ActiveWorkbook.Names("Data_" & sp & "2v").Delete
    ActiveWorkbook.Names("Data_" & sp & "2").Delete
    ActiveWorkbook.Names.Add name:="Data_" & sp & "1v", RefersTo:=sAdv1
    ActiveWorkbook.Names.Add name:="Data_" & sp & "1", RefersTo:=sAdds1
    ActiveWorkbook.Names.Add name:="Data_" & sp & "2v", RefersTo:=sAdv2
    ActiveWorkbook.Names.Add name:="Data_" & sp & "2", RefersTo:=sAdds2
    If sp = "3" Then
        ActiveWorkbook.Names("Data_42").Delete
        ActiveWorkbook.Names.Add name:="Data_41", RefersTo:=sAdds41
        ActiveWorkbook.Names.Add name:="Data_42", RefersTo:=sAdds42
    End If

End If

'sAdv = "='" & Rv.Worksheet.Name & "'!" & Rv.Address
'sAdds = "='" & Rv.Worksheet.Name & "'!" & Range("Data_" & sp & "2").Address
'If sp = "3" Then sAdds4 = "='" & Rv.Worksheet.Name & "'!" & Range("Data_42").Address
''|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|
'If Rv.Column = Range("Data_" & sp & "2v").Column - 2 Then
'        Rv.Cells(1, 1).Value = ""
'        fCleareRange Range("Data_" & sp & "2")
'        If sp = "3" Then fCleareRange Range("Data_42")
'Else
'        Rv.Delete Shift:=xlToLeft
'        ActiveWorkbook.Names.Add Name:="Data_" & sp & "2v", RefersTo:=sAdv
'        ActiveWorkbook.Names.Add Name:="Data_" & sp & "2", RefersTo:=sAdds
'        If sp = "3" Then ActiveWorkbook.Names.Add Name:="Data_42", RefersTo:=sAdds4
'        Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
'End If
Set Rv2 = Nothing
DelName1 = True
End Function


Public Function DelName11(sKod) As Boolean
Dim s$, sKod2$, j As Long, sp$
s = Range("Data_11v").Cells(1, 1).Value
s = sReplace(s, "'", "")
s = sReplace(s, " ", "")
sKod2 = Range("Data_12v").Cells(1, 1).Value

If s <> sKod Or Range("Data_12v").Column <> Range("Data_13v").Column - Range("Data_12v").Columns.Count Or _
                                                    Len(sKod2) = 0 Then
    DelName11 = False
    Exit Function
End If
sKod2 = sReplace(sKod2, "'", "")
sKod2 = sReplace(sKod2, " ", "")
DelNames sKod2
For j = 1 To 4
    sp = Trim$(str(j))
    CopyValue Range("Data_" & sp & "2"), Range("Data_" & sp & "1"), True
    If j <> 4 Then Range("Data_" & sp & "2v").Cells(1, 1) = ""
'    Range("Data_" & sp & "2").Copy
'    Range("Data_" & sp & "1").PasteSpecial Paste:=xlPasteValues
'    fCleareRange Range("Data_" & sp & "2")
Next
RenameColumns sKod2
DelName11 = True
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|  - |fffd||fffd||fffd||fffd| |fffd| new
Public Sub deleteNames()
Dim n As name, sname
'On Error Resume Next
For Each n In ActiveWorkbook.Names
    sname = n.name
    If Len(sname) = 29 And left$(sname, 2) = "ss" And sname Like "*[!a-z][a-z]" Then n.Delete
    If sname Like "rr*" Or sname Like "rg*" Then n.Delete
Next
End Sub

Public Sub DelNames(sKod$)
Dim n As name, sFilter1$, sFilter2$, i As Long, sname$
Dim r As Range
sFilter1 = "ss" & sKod & "????"
sFilter2 = "rr?" & sKod

For Each n In ActiveWorkbook.Names
    sname = n.name
    If Len(sname) < 20 Then GoTo A1
    If sname Like sFilter1 Or sname Like sFilter2 Then ActiveWorkbook.Names(sname).Delete
A1:
Next

Set r = Range("Data_Cells")
'fUnProtect True, R.Worksheet.Index
For i = r.Rows.Count To 1 Step -1
    If r.Cells(i, 1) Like sFilter1 Then r.Rows(i).Delete Shift:=xlUp
Next i
Set r = Nothing
End Sub

Public Sub DelNamesss(sKod$)
Dim n As name, sFilter$, sname$, i As Long
Dim r As Range
sFilter = "ss" & sKod & "????"

For Each n In ActiveWorkbook.Names
    sname = n.name
    If Len(sname) < 20 Then GoTo A1
    If sname Like sFilter Then ActiveWorkbook.Names(sname).Delete
A1:
Next

Set r = Range("Data_Cells")
'fUnProtect True, R.Worksheet.Index
For i = r.Rows.Count To 1 Step -1
    If r.Cells(i, 1) Like sFilter Then r.Rows(i).Delete Shift:=xlUp
Next i
Set r = Nothing
End Sub
Public Sub WorkbookNamesDelete(sFilter$)
Dim n As name
For Each n In ActiveWorkbook.Names
    If n.name Like sFilter Then ActiveWorkbook.Names(n.name).Delete
Next
End Sub
Public Sub CopyValue(Rsour As Range, Rtag As Range, flMove As Boolean)
Dim i As Long, j As Long
For j = 1 To Rsour.Columns.Count
    For i = 1 To Rsour.Rows.Count
        Rtag.Cells(i, j).Value = Rsour.Cells(i, j).Value
        If flMove Then Rsour.Cells(i, j).Value = ""
    Next i
Next j
End Sub




Attribute VB_Name = "ModF074Print"

'------------------ |fffd||fffd||fffd||fffd||fffd||fffd|-----------------------------------
Public Sub PrintF074()
Dim PrintVsego As Boolean, u As Variant
PrintVsego = True
If UCase(sGetINI("idForm", "?")) = "14R" Or UCase(sGetINI("idForm", "?")) = "14R_179" Or UCase(sGetINI("idForm", "?")) = "14R_OKTMO" Or UCase(sGetINI("idForm", "?")) = "14R_OKTMO_2018" Then
    u = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|?", vbOKCancel, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|")
    If u = vbNo Or u = vbCancel Then PrintVsego = False
End If
Application.ScreenUpdating = False
Application.Calculation = xlManual
Application.EnableEvents = False

With ActiveSheet.PageSetup
        .Orientation = xlLandscape
        .PaperSize = xlPaperA4
        .FirstPageNumber = xlAutomatic
        .BlackAndWhite = True
        .Zoom = False
        .FitToPagesWide = 10
        .FitToPagesTall = 1
        .TopMargin = Application.InchesToPoints(0.196850393700787)
        .BottomMargin = Application.InchesToPoints(0.196850393700787)
        .RightMargin = Application.InchesToPoints(0.393700787401575)
        .PrintErrors = xlPrintErrorsDisplayed
End With
UnProtectXlt1
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then fPrintList1 PrintVsego
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    ActiveSheet.PageSetup.TopMargin = Application.InchesToPoints(0.393700787401575)
    ActiveSheet.PageSetup.BottomMargin = Application.InchesToPoints(0.393700787401575)
    fPrintList2 PrintVsego
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.196850393700787)
    fPrintList3 PrintVsego
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-4,5" Then
    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.196850393700787)
    fPrintList4 PrintVsego
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-5" Then
'    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.BottomMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.FitToPagesWide = 1
'    ActiveSheet.PageSetup.FitToPagesTall = 1
    ActiveSheet.PrintOut
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-6" Then
'    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.BottomMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.FitToPagesWide = 1
'    ActiveSheet.PageSetup.FitToPagesTall = 1
    ActiveSheet.PrintOut
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-7" Then
    ActiveSheet.PrintOut
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(5)" Then
'    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.BottomMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.FitToPagesWide = 1
'    ActiveSheet.PageSetup.FitToPagesTall = 1
    ActiveSheet.PrintOut
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(6)" Then
'    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.BottomMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.FitToPagesWide = 1
'    ActiveSheet.PageSetup.FitToPagesTall = 1
    ActiveSheet.PrintOut
End If

ProtectXlt1
Application.ScreenUpdating = True
Application.EnableEvents = True
Application.Calculation = xlAutomatic
End Sub


'------------------ |fffd||fffd||fffd||fffd||fffd||fffd|-----------------------------------
Public Sub PrintF074_86()
Dim PrintVsego As Boolean, u As Variant
PrintVsego = True
If UCase(sGetINI("idForm", "?")) = "14R_86" Or UCase(sGetINI("idForm", "?")) = "14R_OKTMO" Then
    u = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|?", vbOKCancel, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|")
    If u = vbNo Or u = vbCancel Then PrintVsego = False
End If
Application.ScreenUpdating = False
Application.Calculation = xlManual
Application.EnableEvents = False

With ActiveSheet.PageSetup
        .Orientation = xlLandscape
        .PaperSize = xlPaperA4
        .FirstPageNumber = xlAutomatic
        .BlackAndWhite = True
        .Zoom = False
        .FitToPagesWide = 10
        .FitToPagesTall = 1
        .TopMargin = Application.InchesToPoints(0.196850393700787)
        .BottomMargin = Application.InchesToPoints(0.196850393700787)
        .RightMargin = Application.InchesToPoints(0.393700787401575)
        .PrintErrors = xlPrintErrorsDisplayed
End With
UnProtectXlt1
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then fPrintList1 PrintVsego
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    ActiveSheet.PageSetup.TopMargin = Application.InchesToPoints(0.393700787401575)
    ActiveSheet.PageSetup.BottomMargin = Application.InchesToPoints(0.393700787401575)
    fPrintList2 PrintVsego
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.196850393700787)
    fPrintList3 PrintVsego
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-4,5" Then
    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.196850393700787)
    fPrintList4 PrintVsego
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-6" Then
'    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.BottomMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.FitToPagesWide = 1
'    ActiveSheet.PageSetup.FitToPagesTall = 1
    ActiveSheet.PrintOut
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-7" Then
'    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.BottomMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.FitToPagesWide = 1
'    ActiveSheet.PageSetup.FitToPagesTall = 1
    ActiveSheet.PrintOut
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(6)" Then
'    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.BottomMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.FitToPagesWide = 1
'    ActiveSheet.PageSetup.FitToPagesTall = 1
    ActiveSheet.PrintOut
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(7)" Then
'    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.BottomMargin = Application.InchesToPoints(0.000000000000005)
'    ActiveSheet.PageSetup.FitToPagesWide = 1
'    ActiveSheet.PageSetup.FitToPagesTall = 1
    ActiveSheet.PrintOut
End If

ProtectXlt1
Application.ScreenUpdating = True
Application.EnableEvents = True
Application.Calculation = xlAutomatic
End Sub

'------------------ |fffd||fffd||fffd||fffd||fffd||fffd|-----------------------------------
Public Sub PrintF074_2018()
Dim PrintVsego As Boolean, u As Variant
PrintVsego = True
If UCase(sGetINI("idForm", "?")) = "14R_86" Or UCase(sGetINI("idForm", "?")) = "14R_OKTMO_2018" Then
    u = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|?", vbOKCancel, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|")
    If u = vbNo Or u = vbCancel Then PrintVsego = False
End If
Application.ScreenUpdating = False
Application.Calculation = xlManual
Application.EnableEvents = False

With ActiveSheet.PageSetup
        .Orientation = xlLandscape
        .PaperSize = xlPaperA4
        .FirstPageNumber = xlAutomatic
        .BlackAndWhite = True
        .Zoom = False
        .FitToPagesWide = 10
        .FitToPagesTall = 1
        .TopMargin = Application.InchesToPoints(0.196850393700787)
        .BottomMargin = Application.InchesToPoints(0.196850393700787)
        .RightMargin = Application.InchesToPoints(0.393700787401575)
        .PrintErrors = xlPrintErrorsDisplayed
End With
UnProtectXlt1
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then fPrintList1 PrintVsego
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    ActiveSheet.PageSetup.TopMargin = Application.InchesToPoints(0.393700787401575)
    ActiveSheet.PageSetup.BottomMargin = Application.InchesToPoints(0.393700787401575)
    fPrintList2 PrintVsego
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|-3" Then
    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.196850393700787)
    fPrintList3_2018 PrintVsego
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|-4" Then
    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.196850393700787)
    fPrintList4_2018 PrintVsego
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-5;6" Then
    ActiveSheet.PageSetup.RightMargin = Application.InchesToPoints(0.196850393700787)
    fPrintList56 PrintVsego
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-7" Then
    ActiveSheet.PrintOut
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-8" Then
    ActiveSheet.PrintOut
End If
If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-9" Then
    ActiveSheet.PrintOut
End If

ProtectXlt1
Application.ScreenUpdating = True
Application.EnableEvents = True
Application.Calculation = xlAutomatic
End Sub


Public Sub fPrintList1(Optional PrintVsego As Boolean = True)
Dim Rv As Range, sValue$, sAdZag$, i As Long, ns As Long, n As Long, kPr1 As Long, kPr2 As Long, w As Worksheet, rowEnd As Long
Dim RP As Range, RMerge As Range, ColumnsCount As Long
'Dim nC%, nR%, kPr%, 'nR -|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| nC - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| kPr - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim rowMerge As Long, colMerge As Long, colMerge1 As Long '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd|
Dim EndColMarge As Long    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Set Rv = Range("Data_13v")
ColumnsCount = Rv.Column - 1
rowMerge = Rv.Row - 1
Set RMerge = Range(Cells(rowMerge, Range("Kod1").Column + 3), Cells(rowMerge, ColumnsCount))
colMerge1 = RMerge.Column
RMerge.UnMerge
sValue = RMerge.Cells(1, 1).Value
kPr1 = 16   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
kPr2 = 12   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
rowEnd = Rv.Row + Rv.Rows.Count - 1
w.PageSetup.PrintTitleColumns = "$A:$D"
ns = 5  '-|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sAdZag = "='" & w.name & "'!" & Range("Data_Zag").Address
If Not PrintVsego Then
    ns = ns + 2
    kPr1 = kPr1 + 2
    DeleteDataZag "Data_Zag"
End If
For i = 0 To 25 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
n = kPr1 + kPr2 * i
If i = 0 Then colMerge = colMerge1 Else colMerge = ns
If i = 1 And PrintVsego Then DeleteDataZag "Data_Zag"
If n > ColumnsCount Then EndColMarge = ColumnsCount Else EndColMarge = n
Set RP = w.Range(Cells(1, ns), Cells(rowEnd, n))
Set RMerge = Range(Cells(rowMerge, colMerge), Cells(rowMerge, EndColMarge))
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
'    RP.PrintOut Copies:=1, Collate:=True
RP.PrintPreview
If Application.Version >= "12.0" Then
    Q = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|?", vbYesNo, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
    If Q = 6 Then RP.PrintOut Copies:=1, Collate:=True
End If

If n >= ColumnsCount Then GoTo A1
ns = n + 1
Next i
A1:
If Len(sAdZag) > 0 Then InsertDataZag "Data_Zag", sAdZag
Set RMerge = Range(Cells(rowMerge, colMerge1), Cells(rowMerge, ColumnsCount))
RMerge.ClearContents
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
Set Rv = Nothing
Set RMerge = Nothing
Set RP = Nothing
Set w = Nothing
End Sub

Public Sub fPrintList2(Optional PrintVsego As Boolean = True)
Dim Rv As Range, sValue$, sAdZag$, i As Long, ns As Long, n As Long, kPr1 As Long, kPr2 As Long, w As Worksheet, rowEnd As Long
Dim RP As Range, RMerge As Range, ColumnsCount As Long
'Dim nC%, nR%, kPr%, 'nR -|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| nC - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| kPr - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim rowMerge As Long, colMerge As Long, colMerge1 As Long '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd|
Dim EndColMarge As Long    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Set Rv = Range("Data_23v")
ColumnsCount = Rv.Column - 1
rowMerge = Rv.Row - 1
Set RMerge = Range(Cells(rowMerge, Range("Kod2").Column + 4), Cells(rowMerge, ColumnsCount))
colMerge1 = RMerge.Column
RMerge.UnMerge
sValue = RMerge.Cells(1, 1).Value
kPr1 = 14   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
kPr2 = 12   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
rowEnd = Rv.Row + Rv.Rows.Count - 1
w.PageSetup.PrintTitleColumns = "$A:$B"
ns = 3  '-|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If Not PrintVsego Then
    ns = ns + 3
    kPr1 = kPr1 + 3
End If
For i = 0 To 25 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
n = kPr1 + kPr2 * i
If i = 0 Then colMerge = colMerge1 Else colMerge = ns
'If i = 1 Then
'    sAdZag = "='" & W.Name & "'!" & Range("Data_Zag").Address
'    DeleteDataZag "Data_Zag"
'End If
If n > ColumnsCount Then EndColMarge = ColumnsCount Else EndColMarge = n
Set RP = w.Range(Cells(1, ns), Cells(rowEnd, n))
Set RMerge = Range(Cells(rowMerge, colMerge), Cells(rowMerge, EndColMarge))
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
'    RP.PrintOut Copies:=1, Collate:=True
RP.PrintPreview
If Application.Version >= "12.0" Then
    Q = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|?", vbYesNo, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
    If Q = 6 Then RP.PrintOut Copies:=1, Collate:=True
End If

If n >= ColumnsCount Then GoTo A1
ns = n + 1
Next i
A1:
'If Len(sAdZag) > 0 Then InsertDataZag ByVal sDS$, sAdZag
Set RMerge = Range(Cells(rowMerge, colMerge1), Cells(rowMerge, ColumnsCount))
RMerge.ClearContents
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
Set Rv = Nothing
Set RMerge = Nothing
Set RP = Nothing
Set w = Nothing
End Sub

Public Sub fPrintList3(Optional PrintVsego As Boolean = True)
Dim Rv As Range, sValue$, sAdZag$, i As Long, ns As Long, n As Long, kPr1 As Long, kPr2 As Long, w As Worksheet, rowEnd As Long
Dim RP As Range, RMerge As Range, ColumnsCount As Long
'Dim nC%, nR%, kPr%, 'nR -|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| nC - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| kPr - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim rowMerge As Long, colMerge As Long, colMerge1 As Long '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd|
Dim EndColMarge As Long    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Set Rv = Range("Data_33v")
ColumnsCount = Rv.Column - 1
rowMerge = Rv.Row - 1
Set RMerge = Range(Cells(rowMerge, Range("Kod3").Column + 3), Cells(rowMerge, ColumnsCount))
colMerge1 = RMerge.Column
RMerge.UnMerge
sValue = RMerge.Cells(1, 1).Value
kPr1 = 10   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
kPr2 = 8   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
rowEnd = Range("Data_Prim").Row + Range("Data_Prim").Rows.Count - 1
w.PageSetup.PrintTitleColumns = "$A:$B"
ns = 3  '-|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sAdZag = "='" & w.name & "'!" & Range("Data_Prim").Address
If Not PrintVsego Then
    ns = ns + 2
    kPr1 = kPr1 + 2
    DeleteDataZag "Data_Prim"
End If
For i = 0 To 25 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
n = kPr1 + kPr2 * i
If i = 0 Then colMerge = colMerge1 Else colMerge = ns
If i = 1 And PrintVsego Then
'    sAdZag = "='" & W.Name & "'!" & Range("Data_Prim").Address
'    HiddenRange Range("Data_Prim")
    DeleteDataZag "Data_Prim"
End If
If n > ColumnsCount Then EndColMarge = ColumnsCount Else EndColMarge = n
Set RP = w.Range(Cells(1, ns), Cells(rowEnd, n))
Set RMerge = Range(Cells(rowMerge, colMerge), Cells(rowMerge, EndColMarge))
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
'    RP.PrintOut Copies:=1, Collate:=True
RP.PrintPreview
If Application.Version >= "12.0" Then
    Q = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|?", vbYesNo, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
    If Q = 6 Then RP.PrintOut Copies:=1, Collate:=True
End If

If n >= ColumnsCount Then GoTo A1
ns = n + 1
Next i
A1:
'HiddenRange Range("Data_Prim")
If Len(sAdZag) > 0 Then InsertDataZag ByVal "Data_Prim", sAdZag
Set RMerge = Range(Cells(rowMerge, colMerge1), Cells(rowMerge, ColumnsCount))
RMerge.ClearContents
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
Set Rv = Nothing
Set RMerge = Nothing
Set RP = Nothing
Set w = Nothing
End Sub
Public Sub fPrintList3_2018(Optional PrintVsego As Boolean = True)
Dim Rv As Range, sValue$, sAdZag$, i As Long, ns As Long, n As Long, kPr1 As Long, kPr2 As Long, w As Worksheet, rowEnd As Long
Dim RP As Range, RMerge As Range, ColumnsCount As Long
'Dim nC%, nR%, kPr%, 'nR -|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| nC - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| kPr - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim rowMerge As Long, colMerge As Long, colMerge1 As Long '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd|
Dim EndColMarge As Long    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|-3")
Set Rv = Range("Data_33v")
ColumnsCount = Rv.Column - 1
rowMerge = Rv.Row - 1
Set RMerge = Range(Cells(rowMerge, Range("Kod3").Column + 3), Cells(rowMerge, ColumnsCount))
colMerge1 = RMerge.Column
RMerge.UnMerge
sValue = RMerge.Cells(1, 1).Value
kPr1 = 10   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
kPr2 = 8   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
rowEnd = Range("Data_Prim").Row + Range("Data_Prim").Rows.Count - 1
w.PageSetup.PrintTitleColumns = "$A:$B"
ns = 3  '-|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sAdZag = "='" & w.name & "'!" & Range("Data_Prim").Address
If Not PrintVsego Then
    ns = ns + 2
    kPr1 = kPr1 + 2
    DeleteDataZag "Data_Prim"
End If
For i = 0 To 25 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
n = kPr1 + kPr2 * i
If i = 0 Then colMerge = colMerge1 Else colMerge = ns
If i = 1 And PrintVsego Then
'    sAdZag = "='" & W.Name & "'!" & Range("Data_Prim").Address
'    HiddenRange Range("Data_Prim")
    DeleteDataZag "Data_Prim"
End If
If n > ColumnsCount Then EndColMarge = ColumnsCount Else EndColMarge = n
Set RP = w.Range(Cells(1, ns), Cells(rowEnd, n))
Set RMerge = Range(Cells(rowMerge, colMerge), Cells(rowMerge, EndColMarge))
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
'    RP.PrintOut Copies:=1, Collate:=True
RP.PrintPreview
If Application.Version >= "12.0" Then
    Q = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|?", vbYesNo, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
    If Q = 6 Then RP.PrintOut Copies:=1, Collate:=True
End If

If n >= ColumnsCount Then GoTo A1
ns = n + 1
Next i
A1:
'HiddenRange Range("Data_Prim")
If Len(sAdZag) > 0 Then InsertDataZag ByVal "Data_Prim", sAdZag
Set RMerge = Range(Cells(rowMerge, colMerge1), Cells(rowMerge, ColumnsCount))
RMerge.ClearContents
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
Set Rv = Nothing
Set RMerge = Nothing
Set RP = Nothing
Set w = Nothing
End Sub



Public Sub fPrintList4_2018(Optional PrintVsego As Boolean = True)
Dim Rv As Range, sValue$, sAdZag$, i As Long, ns As Long, n As Long, kPr1 As Long, kPr2 As Long, w As Worksheet, rowEnd As Long
Dim RP As Range, RMerge As Range, ColumnsCount As Long
'Dim nC%, nR%, kPr%, 'nR -|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| nC - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| kPr - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim rowMerge As Long, colMerge As Long, colMerge1 As Long '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd|
Dim EndColMarge As Long    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|-4")
Set Rv = Range("Data_43v")
ColumnsCount = Rv.Column - 1
rowMerge = Rv.Row - 1
Set RMerge = Range(Cells(rowMerge, Range("Kod4").Column + 3), Cells(rowMerge, ColumnsCount))
colMerge1 = RMerge.Column
RMerge.UnMerge
sValue = RMerge.Cells(1, 1).Value
kPr1 = 10   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
kPr2 = 8   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
rowEnd = Range("Data_Prim").Row + Range("Data_Prim").Rows.Count - 1
w.PageSetup.PrintTitleColumns = "$A:$B"
ns = 3  '-|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sAdZag = "='" & w.name & "'!" & Range("Data_Prim").Address
If Not PrintVsego Then
    ns = ns + 2
    kPr1 = kPr1 + 2
    DeleteDataZag "Data_Prim"
End If
For i = 0 To 25 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
n = kPr1 + kPr2 * i
If i = 0 Then colMerge = colMerge1 Else colMerge = ns
If i = 1 And PrintVsego Then
'    sAdZag = "='" & W.Name & "'!" & Range("Data_Prim").Address
'    HiddenRange Range("Data_Prim")
    DeleteDataZag "Data_Prim"
End If
If n > ColumnsCount Then EndColMarge = ColumnsCount Else EndColMarge = n
Set RP = w.Range(Cells(1, ns), Cells(rowEnd, n))
Set RMerge = Range(Cells(rowMerge, colMerge), Cells(rowMerge, EndColMarge))
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
'    RP.PrintOut Copies:=1, Collate:=True
RP.PrintPreview
If Application.Version >= "12.0" Then
    Q = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|?", vbYesNo, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
    If Q = 6 Then RP.PrintOut Copies:=1, Collate:=True
End If

If n >= ColumnsCount Then GoTo A1
ns = n + 1
Next i
A1:
'HiddenRange Range("Data_Prim")
If Len(sAdZag) > 0 Then InsertDataZag ByVal "Data_Prim", sAdZag
Set RMerge = Range(Cells(rowMerge, colMerge1), Cells(rowMerge, ColumnsCount))
RMerge.ClearContents
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
Set Rv = Nothing
Set RMerge = Nothing
Set RP = Nothing
Set w = Nothing
End Sub


Public Sub fPrintList4(Optional PrintVsego As Boolean = True)
Dim Rv As Range, sValue$, sAdZag$, i As Long, ns As Long, n As Long, kPr1 As Long, kPr2 As Long, w As Worksheet, rowEnd As Long
Dim RP As Range, RMerge As Range, ColumnsCount As Long
'Dim nC%, nR%, kPr%, 'nR -|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| nC - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| kPr - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim rowMerge As Long, colMerge As Long, colMerge1 As Long '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd|
Dim EndColMarge As Long    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-4,5")
Set Rv = Range("Data_43v")
ColumnsCount = Rv.Column - 1
rowMerge = Rv.Row - 1
Set RMerge = Range(Cells(rowMerge, Range("Kod4").Column + 3), Cells(rowMerge, ColumnsCount))
colMerge1 = RMerge.Column
RMerge.UnMerge
sValue = RMerge.Cells(1, 1).Value
kPr1 = 12   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
kPr2 = 14   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
rowEnd = Range("Data_Prim").Row + Range("Data_Prim").Rows.Count - 1
w.PageSetup.PrintTitleColumns = "$A:$B"
ns = 3  '-|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sAdZag = "='" & w.name & "'!" & Range("Data_Prim").Address
If Not PrintVsego Then
    ns = ns + 2
    kPr1 = kPr1 + 2
    DeleteDataZag "Data_Prim"
End If
For i = 0 To 25 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
n = kPr1 + kPr2 * i
If i = 0 Then colMerge = colMerge1 Else colMerge = ns
If i = 1 And PrintVsego Then
'    sAdZag = "='" & W.Name & "'!" & Range("Data_Prim").Address
'    HiddenRange Range("Data_Prim")
    DeleteDataZag "Data_Prim"
End If
If n > ColumnsCount Then EndColMarge = ColumnsCount Else EndColMarge = n
Set RP = w.Range(Cells(1, ns), Cells(rowEnd, n))
Set RMerge = Range(Cells(rowMerge, colMerge), Cells(rowMerge, EndColMarge))
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
'    RP.PrintOut Copies:=1, Collate:=True
RP.PrintPreview
If Application.Version >= "12.0" Then
    Q = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|?", vbYesNo, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
    If Q = 6 Then RP.PrintOut Copies:=1, Collate:=True
End If

If n >= ColumnsCount Then GoTo A1
ns = n + 1
Next i
A1:
'HiddenRange Range("Data_Prim")
If Len(sAdZag) > 0 Then InsertDataZag ByVal "Data_Prim", sAdZag
Set RMerge = Range(Cells(rowMerge, colMerge1), Cells(rowMerge, ColumnsCount))
RMerge.ClearContents
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
Set Rv = Nothing
Set RMerge = Nothing
Set RP = Nothing
Set w = Nothing
End Sub

Public Sub fPrintList56(Optional PrintVsego As Boolean = True)
Dim Rv As Range, sValue$, sAdZag$, i As Long, ns As Long, n As Long, kPr1 As Long, kPr2 As Long, w As Worksheet, rowEnd As Long
Dim RP As Range, RMerge As Range, ColumnsCount As Long
'Dim nC%, nR%, kPr%, 'nR -|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| nC - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| kPr - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim rowMerge As Long, colMerge As Long, colMerge1 As Long '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd|
Dim EndColMarge As Long    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-5;6")
Set Rv = Range("Data_53v")
ColumnsCount = Rv.Column - 1
rowMerge = Rv.Row - 1
Set RMerge = Range(Cells(rowMerge, Range("Kod5").Column + 3), Cells(rowMerge, ColumnsCount))
colMerge1 = RMerge.Column
RMerge.UnMerge
sValue = RMerge.Cells(1, 1).Value
kPr1 = 12   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
kPr2 = 14   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
rowEnd = Range("Data_Prim").Row + Range("Data_Prim").Rows.Count - 1
w.PageSetup.PrintTitleColumns = "$A:$B"
ns = 3  '-|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sAdZag = "='" & w.name & "'!" & Range("Data_Prim").Address
If Not PrintVsego Then
    ns = ns + 2
    kPr1 = kPr1 + 2
    DeleteDataZag "Data_Prim"
End If
For i = 0 To 25 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
n = kPr1 + kPr2 * i
If i = 0 Then colMerge = colMerge1 Else colMerge = ns
If i = 1 And PrintVsego Then
'    sAdZag = "='" & W.Name & "'!" & Range("Data_Prim").Address
'    HiddenRange Range("Data_Prim")
    DeleteDataZag "Data_Prim"
End If
If n > ColumnsCount Then EndColMarge = ColumnsCount Else EndColMarge = n
Set RP = w.Range(Cells(1, ns), Cells(rowEnd, n))
Set RMerge = Range(Cells(rowMerge, colMerge), Cells(rowMerge, EndColMarge))
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
'    RP.PrintOut Copies:=1, Collate:=True
RP.PrintPreview
If Application.Version >= "12.0" Then
    Q = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|?", vbYesNo, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
    If Q = 6 Then RP.PrintOut Copies:=1, Collate:=True
End If

If n >= ColumnsCount Then GoTo A1
ns = n + 1
Next i
A1:
'HiddenRange Range("Data_Prim")
If Len(sAdZag) > 0 Then InsertDataZag ByVal "Data_Prim", sAdZag
Set RMerge = Range(Cells(rowMerge, colMerge1), Cells(rowMerge, ColumnsCount))
RMerge.ClearContents
RMerge.Cells(1, 1) = sValue
RMerge.Merge
RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
Set Rv = Nothing
Set RMerge = Nothing
Set RP = Nothing
Set w = Nothing
End Sub



Public Sub fPrintList7(Optional PrintVsego As Boolean = True)
Dim Rv As Range, sValue$, sAdZag$, i As Long, ns As Long, n As Long, kPr1 As Long, kPr2 As Long, w As Worksheet, rowEnd As Long
Dim RP As Range, RMerge As Range, ColumnsCount As Long
Dim rowMerge As Long, colMerge As Long, colMerge1 As Long '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd|
Dim EndColMarge As Long   ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim Q  As Long

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(7)")
Set Rv = w.Range("Data_R5")
ColumnsCount = Rv.Columns.Count
rowMerge = Rv.Rows.Count
Set RMerge = Range(Cells(3, 1), Cells(rowMerge, ColumnsCount))
'colMerge1 = RMerge.Column
'RMerge.UnMerge
'sValue = RMerge.Cells(1, 1).Value
'kPr1 = 16   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'kPr2 = 12   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'rowEnd = Rv.Row + Rv.Rows.Count - 1
'W.PageSetup.PrintTitleColumns = "$A:$D"
'ns = 5  '-|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'sAdZag = "='" & W.name & "'!" & Range("Data_Zag").Address
'If Not PrintVsego Then
'    ns = ns + 2
'    kPr1 = kPr1 + 2
'    DeleteDataZag "Data_Zag"
'End If
'For i = 0 To 25 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'n = kPr1 + kPr2 * i
'If i = 0 Then colMerge = colMerge1 Else colMerge = ns
'If i = 1 And PrintVsego Then DeleteDataZag "Data_Zag"
'If n > ColumnsCount Then EndColMarge = ColumnsCount Else EndColMarge = n
'Set RP = W.Range(Cells(1, ns), Cells(rowEnd, n))
'Set RMerge = Range(Cells(rowMerge, colMerge), Cells(rowMerge, EndColMarge))
'RMerge.Cells(1, 1) = sValue
'RMerge.Merge
'RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
'    RP.PrintOut Copies:=1, Collate:=True
Rv.PrintPreview
If Application.Version >= "12.0" Then
    Q = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|?", vbYesNo, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
    If Q = 6 Then Rv.PrintOut Copies:=1, Collate:=True
End If

'If n >= ColumnsCount Then GoTo A1
'ns = n + 1
'Next i
'A1:
'If Len(sAdZag) > 0 Then InsertDataZag "Data_Zag", sAdZag
'Set RMerge = Range(Cells(rowMerge, colMerge1), Cells(rowMerge, ColumnsCount))
'RMerge.ClearContents
'RMerge.Cells(1, 1) = sValue
'RMerge.Merge
'RMerge.Borders(xlEdgeTop).LineStyle = xlContinuous
Set Rv = Nothing
Set RMerge = Nothing
Set RP = Nothing
Set w = Nothing
End Sub

Public Sub fPrintList5(Optional PrintVsego As Boolean = True)
Dim Rv As Range, sValue$, sAdZag$, i As Long, ns As Long, n As Long, kPr1 As Long, kPr2 As Long, w As Worksheet, rowEnd As Long
Dim RP As Range, RMerge As Range, ColumnsCount As Long
Dim rowMerge As Long, colMerge As Long, colMerge1 As Long '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd|
Dim EndColMarge As Long    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim Q  As Long

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(6)")
Set Rv = w.Range("Data_R6")
ColumnsCount = Rv.Columns.Count
rowMerge = Rv.Rows.Count
Set RMerge = Range(Cells(3, 1), Cells(rowMerge, ColumnsCount))
Rv.PrintPreview
If Application.Version >= "12.0" Then
    Q = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|?", vbYesNo, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
    If Q = 6 Then Rv.PrintOut Copies:=1, Collate:=True
End If

Set Rv = Nothing
Set RMerge = Nothing
Set RP = Nothing
Set w = Nothing
End Sub


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub DeleteDataZag(ByVal sDS$)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Dim w As Worksheet
Set w = Worksheets("Sluz")
Range(sDS).Cut
w.Paste
Set w = Nothing
End Sub

Public Sub InsertDataZag(ByVal sDS$, ByVal sAdZag$)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Dim r As Range, Rds As Range
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Set r = Range(sAdZag)
Set Rds = Range(sDS)
If Rds.Worksheet.name = r.Worksheet.name Then Exit Sub
Rds.Cut
r.Insert Shift:=xlToRight
Set r = Nothing
End Sub



Attribute VB_Name = "ModF074R"
Option Explicit
Public idForm14r As String ''''  Spiridonova 17.02.2015
Dim db As Database
Dim rs As Recordset
'TMP  |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub TempUpr14r()

idForm14r = UCase(sGetINI("idForm", "?"))
Rasstanovka014rFromArray DBToArray

End Sub


Public Function Rasstanovka014rFromArray(a As Variant) As Variant
Dim sql$, sFName$, i As Long, s$, Row As Long
Dim sDir$, r As Range, Val As Variant, sV1$, sV2$, err() As Variant, n As Long, LenKod As Long
ReDim err(1 To 100, 1 To 2)

idForm14r = UCase(sGetINI("idForm", "?"))
If idForm14r = "14R_OKTMO" Or idForm14r = "14R_OKTMO_2018" Then
    LenKod = 39 ''37
Else
    LenKod = 29
End If

n = 1
n = LBound(err, 1)
sDir = Environ("TEMP") & "\"
UnProtectBook
sFName = sDir & ActiveWorkbook.name & ".mdb"
'|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If Application.UserName <> "Lavrentiev1" Then
    If Len(Dir$(sFName)) > 0 Then Kill sFName
    Set db = DBEngine.CreateDatabase(left$(sFName, Len(sFName) - 4), dbLangCyrillic)
    '|fffd||fffd||fffd||fffd||fffd| |fffd|.|fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| Excel
    db.Close
    Set db = OpenDatabase(sFName, False, False)
    '--------------------|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|--
    If idForm14r = "14R_OKTMO" Or idForm14r = "14R_OKTMO_2018" Then
        sql = "create table Data(Kod string(39), Value1 currency, Value2 text)"
    Else
        sql = "create table Data(Kod string(29), Value1 currency, Value2 text)"
    End If
    db.Execute (sql)
    
    For i = LBound(a) To UBound(a)
        s = Trim$(a(i, 1))
        If HasName(s) Then
'            Val = IIf(A(i, 1) > 0, A(i, 1), A(i, 2))
            Range(s) = a(i, 2): GoTo A1
        End If
'        If Len(s) <> 29 And Not s Like "ss*[a-c]" Then
        If Len(s) <> LenKod And Not s Like "ss*[a-c]" Then
            err(n, 1) = s
            err(n, 2) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
            n = n + 1
            GoTo A1
        End If
    '    sKod = Mid$(s, 3, 23)
    '    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    '    If (HasInSpr(left$(sKod, 19), "Data_RCHGr")) Then GoTo A1
        If IsNumeric(a(i, 2)) Then
            sV1 = a(i, 2)
            sV2 = ""
        Else
            sV1 = 0
            sV2 = a(i, 2)
        End If
        sql = "insert into Data values('" & s & "'," & sV1 & ",'" & sV2 & "')"
        db.Execute (sql)
A1:
    Next i
Else
        Set db = OpenDatabase(sFName, False, False)
End If
'sql = "SELECT Org AS Code, Null AS n2, Count(*) AS NN FROM(" & _
'"SELECT Mid(cell,3,Len(cell)-10) AS Code, Mid(cell,22,4) AS Org FROM cur_ddata " & _
'" WHERE (Len(cell)=29 AND Left(cell, 2) Like 'ss') " & _
'" GROUP BY Mid(cell,3,Len(cell)-10), Mid(cell,22,4) ORDER BY Mid(cell,22,4)" & _
'")GROUP BY Org"

If idForm14r = "14R_OKTMO" Or idForm14r = "14R_OKTMO_2018" Then
    sql = "SELECT Org AS Code, Null AS n2, Count(*) AS NN FROM(" & _
    "SELECT Mid(Kod,3,19) AS Code, Mid(Kod,22,8) AS Org, Mid(Kod,30,4) AS vid FROM Data " & _
    " WHERE (Len(Kod)=39 AND Left(Kod, 2) Like 'ss') " & _
    " GROUP BY Mid(Kod,3,19), Mid(Kod,22,8), Mid(Kod,30,4) ORDER BY Mid(Kod,22,8)" & _
    ")GROUP BY Org"
Else
    sql = "SELECT Org AS Code, Null AS n2, Count(*) AS NN FROM(" & _
    "SELECT Mid(Kod,3,Len(Kod)-10) AS Code, Mid(Kod,22,4) AS Org FROM Data " & _
    " WHERE (Len(Kod)=29 AND Left(Kod, 2) Like 'ss') " & _
    " GROUP BY Mid(Kod,3,Len(Kod)-10), Mid(Kod,22,4) ORDER BY Mid(Kod,22,4)" & _
    ")GROUP BY Org"
End If
Set rs = db.OpenRecordset(sql, dbOpenDynaset, dbReadOnly)
'rs.MoveLast
'If rs.RecordCount = 0 Then MsgBox ""
Set r = Range("Data_ColStr")

Row = r.Row + r.Rows.Count - 1
sql = Row & ":" & (Row + rs.RecordCount - 3)
r.Worksheet.Rows(sql).Insert Shift:=xlDown
'AutoFill(rng);
r.CopyFromRecordset rs
'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| sql
For i = 1 To r.Rows.Count
    If idForm14r = "14R_OKTMO" Or idForm14r = "14R_OKTMO_2018" Then
        r.Cells(i, 2) = SprValue(Format$(r.Cells(i, 1), "00000000"), "Data_OKATO")
    Else
        r.Cells(i, 2) = SprValue(Format$(r.Cells(i, 1), "0000"), "Data_REG")
    End If
Next i
rs.Close
Set rs = Nothing
InsertValuesStatic
ProtectBook
'ShowSelectOrgForm
'If n = LBound(err) Then ReDim Preserve err(1 To 1) Else ReDim Preserve err(1 To n - 1)
'Rasstanovka014rFromArray = err
Rasstanovka014rFromArray = 0
End Function

Public Sub ShowSelectOrgForm()
'Application.Run ActiveWorkbook.Name & "!" & Trim$(s)
Dim Q As New AddControl
Dim sCaption As String
If idForm14r = "14R_OKTMO" Or idForm14r = "14R_OKTMO_2018" Then
   sCaption = "|fffd||fffd||fffd||fffd||fffd| OKTMO"
Else
   sCaption = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
End If

With Q
    .ColumnCount = 3
    UserForm1.Caption = sCaption
    .ColumnWidths = "80;185;45"
    .BoundColumn = 1
    .RowSource = "Data_ColStr"
    .ColumnHeads = True
    .MultiSelect = 2
    .AddControl "ListBox", , , 10, 10, 170, 280
    .AddControl "CommandButton", "cmdOk", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 180, 215, 23, 70
'    .AddControl "CommandButton", "cmdCancel", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 170, 210, 23, 70
End With
With UserForm1
    .Height = 240
    .Width = 300
End With
Application.Visible = True
UserForm1.cmdFontSize.Visible = False
UserForm1.Show
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|
Public Sub form014RShow()
Dim a() As Variant, s As String
Dim i As Long, n As Long, n1 As Long, sFormat$

ReDim a(0 To 100)
If idForm14r = "14R_OKTMO" Or idForm14r = "14R_OKTMO_2018" Then
   sFormat = "00000000"
Else
   sFormat = "0000"
End If
With UserForm1.Controls("ListBox1")
    For i = 0 To .ListCount - 1
        If .Selected(i) Then
            s = Format$(.List(i), sFormat)
            If Len(s) > 0 Then
                a(n) = Format$(.List(i), sFormat)
                n = n + 1
            End If
        End If
    Next i
End With
If n = 0 Then Exit Sub
n1 = Val(sGetINI("CountOrg", "5"))
If n > n1 Then
    MsgBox "|fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 5!"
    Exit Sub
End If
ReDim Preserve a(n - 1)
Unload UserForm1
UnProtectBook
If UCase(sGetINI("idForm", "?")) = "14R_179" Or idForm14r = "14R_OKTMO" Then
    If UCase(sGetINI("Len_CS", "?")) = "10" Then
        CleareColumns_179_CS10
    Else
        CleareColumns_179
    End If
Else
    If idForm14r = "14R_OKTMO_2018" Then
        CleareColumns_2018_CS10
    Else
        CleareColumns
    End If
End If
RasstColumns014R a
ProtectBook
End Sub

Public Sub CleareColumns()
Dim w As Worksheet, r2 As Range, R3 As Range, r As Range, R1 As Range, R0 As Range
Dim sAd$, Col1 As Long, Col2 As Long, i As Long, sp$, a As Variant
If IsEmpty(Range("Data_11v").Cells(1, 1)) Then Exit Sub

For i = 1 To 3
sp = Trim$(str(i))
Set R0 = Range("Kod" & sp)
Set R1 = Range("Data_" & sp & "1v")
Set r2 = Range("Data_" & sp & "2v")
Set R3 = Range("Data_" & sp & "3v")
Set w = r2.Worksheet
Col1 = r2.Column + r2.Columns.Count
Col2 = R3.Column - 1
If Col2 > Col1 Then
    sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
    Range(sAd).Delete Shift:=xlToLeft
End If
Col1 = R0.Column + R0.Columns.Count + R1.Columns.Count
Col2 = R1.Column - 1
If Col2 > Col1 Then
    sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
    Range(sAd).Delete Shift:=xlToLeft
End If
Col1 = R1.Column + R1.Columns.Count
Col2 = r2.Column - 1
If Col2 > Col1 Then
    sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
    Range(sAd).Delete Shift:=xlToLeft
End If

    fMerge w
    R3.Columns.EntireColumn.Hidden = True
    fCleareRange Range("Data_" & sp & "1")
    fCleareRange Range("Data_" & sp & "2")
    If i = 3 Then
        fCleareRange Range("Data_41")
        fCleareRange Range("Data_42")
    End If
     If R1.Cells(1, 1).MergeCells Then R1.Cells(1, 1).MergeArea.ClearContents Else R1.Cells(1, 1).ClearContents
     If r2.Cells(1, 1).MergeCells Then r2.Cells(1, 1).MergeArea.ClearContents Else r2.Cells(1, 1).ClearContents
Next i
deleteNames
Set w = Nothing
Set r2 = Nothing
Set R3 = Nothing
Set r = Nothing
End Sub

'|fffd| - |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub RasstColumns014R(a() As Variant)
Dim sql$, s$, sKode() As String, n As Long, sRegions$
ReDim sKode(0 To 100)

    sRegions = fGetStrFromArray(a)
    If idForm14r = "14R_OKTMO" Or idForm14r = "14R_OKTMO_2018" Then
        sql = "select Mid(Kod,3,33) AS Code from Data WHERE (Len(Kod)=39 AND Left(Kod, 2) Like 'ss') " & _
     " GROUP BY Mid(Kod,3,33), Mid(Kod,22,8) HAVING(Mid(Kod,22,8) In (" & sRegions & ")) ORDER BY Mid(Kod,22,8)"
    Else
        sql = "select Mid(Kod,3,23) AS Code from Data WHERE (Len(Kod)=29 AND Left(Kod, 2) Like 'ss') " & _
     " GROUP BY Mid(Kod,3,23), Mid(Kod,22,4) HAVING(Mid(Kod,22,4) In (" & sRegions & ")) ORDER BY Mid(Kod,22,4)"
    End If
Set rs = db.OpenRecordset(sql, dbOpenDynaset, dbReadOnly)
If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
Do Until rs.EOF
  s = IIf(IsNull(rs("Code")), "", rs("Code"))
    If Len(s) > 0 Then sKode(n) = s: n = n + 1
  rs.MoveNext
Loop
If n = 0 Then Exit Sub
ReDim Preserve sKode(n - 1)
AddColumnsAndValues14r sKode, sRegions

End If
Set rs = Nothing
End Sub

''0013','0014','0015 '
Public Function fGetStrFromArray(a() As Variant) As String
Dim i As Long, s$, sFormat$

If idForm14r = "14R_OKTMO" Or idForm14r = "14R_OKTMO_2018" Then
   sFormat = "00000000"
Else
   sFormat = "0000"
End If
For i = LBound(a) To UBound(a)
    s = s & "'" & Format$(a(i), sFormat) & "'" & ","
Next i
fGetStrFromArray = left$(s, Len(s) - 1)
End Function

Public Sub InsertValuesStatic()
Dim sql$
If idForm14r = "14R_OKTMO" Or idForm14r = "14R_OKTMO_2018" Then
    sql = "SELECT Kod, Value1, Value2 FROM Data WHERE (Len(Kod) < 39)"
Else
    sql = "SELECT Kod, Value1, Value2 FROM Data WHERE (Len(Kod) < 29)"
End If
InsertValues sql
End Sub

Public Sub InsertValuesDinamic(s$)
Dim sql$
If idForm14r = "14R_OKTMO" Or idForm14r = "14R_OKTMO_2018" Then
    sql = "SELECT Kod, Value1, Value2 FROM Data WHERE (Len(Kod) = 39 AND Mid(Kod,22,8) In (" & s & "))"
Else
    sql = "SELECT Kod, Value1, Value2 FROM Data WHERE (Len(Kod) = 29 AND Mid(Kod,22,4) In (" & s & "))"
End If
InsertValues sql
End Sub

Public Sub InsertValues(sql$)
Dim sR$, s$, f As Currency
Set rs = db.OpenRecordset(sql, dbOpenDynaset, dbReadOnly)
If rs.RecordCount > 0 Then
Do Until rs.EOF
  sR = IIf(IsNull(rs("Kod")), "", rs("Kod"))
'  sR = IIf(IsNull(rs("cell")), "", rs("cell"))
  If Len(sR) = 0 Then GoTo A1
'  s = IIf(IsNull(rs("var_c")), "", rs("var_c"))
   s = IIf(IsNull(rs("Value2")), "", rs("Value2"))
  If Len(s) > 0 Then If HasName(sR) Then Range(sR) = s: GoTo A1
'  If HasName(sR) Then Range(sR) = rs("var_f")
  If HasName(sR) Then Range(sR) = rs("Value1")
A1:  rs.MoveNext
Loop
End If
rs.Close
Set rs = Nothing
End Sub
'--------------------------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-----------------------------------------
Public Sub AddColumnsAndValues14r(sKod() As String, sRegions$)
Dim idForm As String
    ' 25.01.2011
    idForm = sGetINI("idForm", "?")
    If idForm = "14r_179" Then AddColumnList_179 sKod
    If idForm = "14r" Then AddColumnList sKod
'    If idForm14r = "14R_OKTMO" Then AddColumnList_179 sKod
    ' 25.01.2011
    '<Spir>10.01.2017
    If idForm14r = "14R_OKTMO" Then
        If UCase(sGetINI("Len_CS", "?")) = "10" Then
            AddColumnList_179_CS10 sKod
        Else
            AddColumnList_179 sKod
        End If
    End If
    '<Spir>10.01.2017
    '<Spir>31.01.2018
    If idForm14r = "14R_OKTMO_2018" Then
        AddColumnList_2018_CS10 sKod
    End If
   InsertValuesDinamic sRegions
End Sub


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub AddNN()
Dim j As Long, sp$, Row As Long, w As Worksheet
Dim r As Range, k As Long, i As Long, Col As Long, n As Long

For j = 1 To 4
    sp = Trim$(str(j))
    Set r = Range("Data_" & sp & "3")
    Set w = r.Worksheet
    Row = r.Row - 1
    Col = Range("Kod" & sp).Column + 1
    k = 3: n = 1
    If j = 3 Then k = 4: n = 2
    For i = Col To r.Column - 1
        If IsFirstCell(w.Cells(Row, i)) Then
            w.Cells(Row, i) = k
            k = k + n
        End If
    Next i
Next j
Set r = Nothing
Set w = Nothing
End Sub

Public Sub InsertFormuls()
Dim n As name, sname$, sKod$, Org$, idForm$
idForm = sGetINI("idForm", "?")
For Each n In ActiveWorkbook.Names
    sname = n.name
    If sname Like "rr1*" Then
        sKod = Mid$(sname, 4, 19)
'        Org = Mid$(sKod, 20, 4)
        If (idForm = "14r" Or idForm = "14r_179") Then Org = Mid$(sname, 23, 4)
        If idForm14r = "14R_OKTMO" Or idForm14r = "14R_OKTMO_2018" Then Org = Mid$(sname, 23, 12)
        AddFormulsofRange sKod, Org, idForm
    End If
Next
End Sub

'|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| DataSheets |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 14r |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub AddFormulsofRange(sKod$, Org$, idForm$)
Dim r As Range, Rds As Range, Rsour As Range, Rtag As Range, n As Long, i As Long, j As Long, k As Long, sp$, Col1 As Long, Col2 As Long, Coltag As Long, Rowtag As Long
Dim w As Worksheet, s$, mKodGr() As String

mKodGr() = fKodsGr(sKod)
For n = 1 To 4
        sp = Trim$(str(n))
        Set r = Range("Data_" & sp & "3")
        Set w = r.Worksheet
        If n = 4 Then sp = "3"
    Col1 = Range("rr" & sp & sKod & Org).Column
    Col2 = Col1 + r.Columns.Count - 1
    Set Rds = Range(w.Cells(r.Row, Col1), w.Cells(r.Row + r.Rows.Count - 1, Col2))
    For i = 1 To Rds.Columns.Count
        For j = 1 To Rds.Rows.Count
         
        Set Rsour = Rds.Cells(j, i)
        If left$(Rsour.Formula, 5) = "=|fffd||fffd||fffd||fffd|" Or left$(Rsour.Formula, 4) = "=SUM" Or Rsour.Value = "X" Or _
                            Rsour.Interior.ColorIndex <> 35 Or Not IsFirstCell(Rsour) Then GoTo A1
        
            For k = LBound(mKodGr) To UBound(mKodGr)
                If Len(mKodGr(k)) = 0 And (idForm = "14" Or idForm = "14_179" Or idForm = "14_86" Or idForm = "14_2018") Then '17.01.2011
                    Coltag = Range("Kod" & sp).Column
                Else
                    s = "rg" & sp & mKodGr(k) & Org
                    If Not HasName(s) Then GoTo a2
                    Coltag = Range(s).Column - 1
                End If
                Rowtag = Rsour.Row
                Set Rtag = w.Cells(Rowtag, Coltag + i)
                        If left$(Rtag.Formula, 1) = "=" Then
                                Rtag.Formula = Rtag.Formula & " + " & Rsour.Address
                        Else
                                Rtag.Formula = "=" & Rsour.Address
                        End If
a2:
            Next k
A1:
        Next j
    Next i
Next n
Set w = Nothing
Set r = Nothing
Set Rds = Nothing
Set Rsour = Nothing
Set Rtag = Nothing
End Sub

Public Sub ProtectBook()
    fProtectAll
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    Application.EnableEvents = True
    Application.Calculation = xlAutomatic
End Sub

Public Sub UnProtectBook()
    Application.Calculation = xlManual
    Application.EnableEvents = False
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    fUnProtectAll
End Sub
Public Function ReturnPrimaryCods() As String()
Dim mKod() As String, n As name, sname$, i As Long
ReDim mKod(0 To 100)
For Each n In ActiveWorkbook.Names
    sname = n.name
    If sname Like "rr1*" Then
        mKod(i) = Mid$(sname, 4)
        i = i + 1
    End If
Next
ReDim Preserve mKod(i - 1)
ReturnPrimaryCods = mKod
End Function






Attribute VB_Name = "ModF074_2"
Option Explicit
Dim FlReneme  As Long
'
' --------------------------    |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|  ---------------------------------------
'

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'False - |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  True |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function ReturnKods(flGroup As Boolean) As String()
Dim mKod() As String, Rv As Range, w As Worksheet, rowKod As Long, sKod$, j As Long, i As Long, Org$

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Set Rv = Range("Data_13v")
'rowKod = Rv.Cells(1, 1).row
rowKod = Rv.Row
ReDim mKod(0 To (Rv.Column - Range("Kod1").Column) \ 2)
For i = Range("Kod1").Column + 3 To Rv.Column - 1
    Org = ""
    sKod = w.Cells(rowKod, i)
    If Len(sKod) = 0 Then GoTo A1
    sKod = sReplace(sKod, "'", "")
    sKod = sReplace(sKod, vbLf, "")
    If Len(sKod) > 19 Then
        Org = Mid$(sKod, 20, 4)
        sKod = left(sKod, 19)
    End If
    If Len(sKod) > 0 Then
        If flGroup = False And HasInSpr(sKod, "Data_RCH") = True Then
            mKod(j) = IIf(Len(Org) = 0, sKod, sKod & Org)
            j = j + 1
        End If
        If flGroup = True And HasInSpr(sKod, "Data_RCHGr") = True Then
            mKod(j) = sKod
            j = j + 1
        End If
    End If
A1:
Next i
If j = 0 Then j = 1: mKod(0) = "False"
ReDim Preserve mKod(0 To j - 1)
Set Rv = Nothing
Set w = Nothing
ReturnKods = mKod()
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
Public Function fKodsGr(sKod As String) As String()
Dim mKodGr() As String, r As Range, i As Long, sGrStr$, k As Long, s$
ReDim mKodGr(0 To 15)
fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index

'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd||fffd| Parent
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd|
Set r = Range("Data_RCH")
r.Sort Key1:=r.Cells(1, 1), Order1:=xlAscending
For i = 1 To r.Rows.Count
    If r.Cells(i, 1) = sKod Then
        If Len(r.Cells(i, 2)) > 0 Then sGrStr = r.Cells(i, 3): GoTo A1
    End If
Next i
A1:
If Len(sGrStr) = 0 Then GoTo a2
Set r = Range("Data_RCHGr")
r.Sort Key1:=r.Cells(1, 1), Order1:=xlAscending
While Len(sGrStr) > 0
    For i = 1 To r.Rows.Count
        s = r.Cells(i, 1)
        If Right$(s, 5) = sGrStr Then
            mKodGr(k) = s
            k = k + 1
            sGrStr = r.Cells(i, 3)
            GoTo A3
        End If
    Next i
    sGrStr = ""
A3:
Wend
a2:
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "" |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
ReDim Preserve mKodGr(0 To k)
'If k = 0 Then k = 1
'ReDim Preserve mKodGr(0 To k - 1)
Set r = Nothing
fKodsGr = mKodGr()
End Function


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| True |fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Function IsFirstCell(r As Range) As Boolean
On Error Resume Next
Dim sAdress$, fl As Boolean
fl = True
sAdress = r.Address
If r.MergeCells = True Then
    If sAdress <> r.MergeArea.Offset(0, 0).Address Then fl = False
End If
IsFirstCell = fl
End Function



Public Sub fCleareRange(r As Range)
Dim i As Long, j As Long, s$, sF$
For j = 1 To r.Columns.Count
    For i = 1 To r.Rows.Count
        s = r.Cells(i, j).Value
        If s = "X" Then GoTo A1
        If left$(r.Cells(i, j).Formula, 1) = "=" Then GoTo A1
        If r.Cells(i, j).MergeCells Then r.Cells(i, j).MergeArea.ClearContents Else r.Cells(i, j).ClearContents
A1:
    Next i
Next j
End Sub


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| "|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
Public Sub fMerge(w As Worksheet, Optional ByVal Col1 As Long = 0, Optional ByVal Col2 As Long = 0)
Dim Row As Long, sAd$, r As Range, Col3 As Long, iw As Single, Rv As Range
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge1").Row
    Set Rv = Range("Data_13v")
    If Col1 = 0 Then Col1 = Range("Data_Kods1").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge2").Row
    Set Rv = Range("Data_23v")
    If Col1 = 0 Then Col1 = Range("Data_Kods2").Cells(1, 4).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 3
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge3").Row
    Set Rv = Range("Data_33v")
    If Col1 = 0 Then Col1 = Range("Data_Kods3").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 14.89
End If
sAd = "='" & w.name & "'!" & Range(Cells(Row, Col1), Cells(Row, Col2)).Address
Set r = Range(sAd)
r.UnMerge
r.Merge
r.ColumnWidth = iw
r.Borders(xlEdgeTop).LineStyle = xlContinuous
Rv.Columns.EntireColumn.Hidden = True

sAd = "='" & w.name & "'!" & Range(Cells(Row, Col3), Cells(Row, 90)).Address
Set r = Range(sAd)
r.Borders(xlEdgeBottom).LineStyle = xlNone
r.Borders(xlEdgeTop).LineStyle = xlNone
Set r = Nothing
Set Rv = Nothing
End Sub
Public Sub insertName(ByVal sKod$, r As Range, ByVal sRKodName$, flGR)
'|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'On Error Resume Next
Dim sAd$, sname$, sCluch$, sParentKode$, KodGr As Variant, s$, j As Long, i As Long

For j = 1 To r.Columns.Count
    For i = 1 To r.Rows.Count
'        If R.Cells(i, j).Interior.ColorIndex <> 35 Or
        If r.Cells(i, j).Value = "X" Then GoTo A1
        If r.Cells(i, j).MergeCells Then
            sAd = r.Cells(i, j).Address
            If sAd <> r.Cells(i, j).MergeArea.Offset(0, 0).Address Then
                GoTo A1
            Else
                If flGR Then r.Cells(i, j).MergeArea.Locked = True
            End If
        End If
    
            sname = "ss" & sKod & Range(sRKodName).Cells(i, 1) & Chr(96 + j)
            sAd = "='" & r.Worksheet.name & "'!" & r.Cells(i, j).Address
            ActiveWorkbook.Names.Add name:=sname, RefersTo:=sAd
'            If R.Cells(i, j).Value = "X" Then GoTo A1
            
            If flGR = False Then fSaveData_Cells sname, Range(sname).NumberFormat
            If flGR Then
                r.Cells(i, j).Interior.ColorIndex = xlNone
                If r.Cells(i, j).MergeCells = False Then r.Cells(i, j).Locked = True
            End If
A1:
    Next i
Next j
End Sub

Public Sub fUnProtectAll()
Dim w As Worksheet
On Error Resume Next
For Each w In ActiveWorkbook.Worksheets
If w.ProtectContents = True Then w.Unprotect "rassvet"
Next
If ActiveWorkbook.ProtectStructure = True Then ActiveWorkbook.Unprotect "rassvet"
Set w = Nothing
End Sub

Public Sub fProtectAll()
Dim w As Object
On Error Resume Next
For Each w In ActiveWorkbook.Worksheets
If w.ProtectContents = False Then
    If Val(Application.Version) < 10 Then
        w.Protect "rassvet"
    Else
        w.Protect "rassvet", AllowFormattingColumns:=True    ', AllowFormattingRows:=True
        'ActiveSheet.EnableSelection = xlUnlockedCells
    End If
End If
Next
If ActiveWorkbook.ProtectStructure = False Then ActiveWorkbook.Protect "rassvet"
Set w = Nothing
End Sub

Public Function FormatKod(sKod As String) As String
Dim s$
If Len(sKod) = 19 Then s = Format(sKod, "0000'0000000'000'00000")
If Len(sKod) = 22 And (UCase(sGetINI("idForm", "?")) = "14_86" Or UCase(sGetINI("idForm", "?")) = "14_2018") Then
    s = Format(sKod, "0000'0000000000'000'00000")
End If
If Len(sKod) = 23 Then
'    s = Format(sKod, "0000'0000000'000'00000'0000")
    s = Format(left$(sKod, 19), "0000'0000000'000'00000") & vbLf & Mid$(sKod, 20, 4)
    s = s & " - " & SprValue(Right$(sKod, 4), "Data_REG")
End If
If Len(sKod) = 33 Then
    ''<Spir> 10.01.2017 |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd| 01012017 (|fffd||fffd||fffd|.|fffd||fffd||fffd||fffd||fffd||fffd| =10|fffd||fffd||fffd|  Len_CS = 10 )
    If UCase(sGetINI("Len_CS", "?")) = "10" Then
        s = Format(left$(sKod, 11) & "000" & Mid$(sKod, 12, 8), "0000'0000000000'000'00000") & vbLf & Mid$(sKod, 20, 8)
    Else
        s = Format(left$(sKod, 19), "0000'0000000'000'00000") & vbLf & Mid$(sKod, 20, 8)
    End If
'    s = Format(left$(sKod, 19), "0000'0000000'000'00000") & vbLf & Mid$(sKod, 20, 8)
    s = s & " - " & SprValue(Mid$(sKod, 20, 8), "Data_OKATO") & vbLf & Mid$(sKod, 28, 4)
End If
If Len(sKod) = 4 And UCase(sGetINI("idForm", "?")) = "14R" Then
    s = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| " & vbLf & SprValue(sKod, "Data_REG")
End If
'25.01.2011
If Len(sKod) = 4 And UCase(sGetINI("idForm", "?")) = "14R_179" Then
    s = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| " & vbLf & SprValue(sKod, "Data_REG")
End If
'25.01.2011
'17.02.2015
If Len(sKod) = 4 And (UCase(sGetINI("idForm", "?")) = "14R_OKTMO" Or UCase(sGetINI("idForm", "?")) = "14R_OKTMO_2018") Then
    s = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| " & vbLf & SprValue(sKod, "Data_OKATO")
End If
'17.02.2015
FormatKod = s
End Function

'Public Sub HiddenRange(R As Range)
'R.EntireRow.Hidden = Not R.EntireRow.Hidden
''R.EntireColumn.Hidden = Not R.EntireColumn.Hidden
'End Sub




Attribute VB_Name = "ModF074_2018"
'
' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 074 |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| 259|fffd| |fffd||fffd| 28.12.2017|fffd|
' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini-|fffd||fffd||fffd||fffd||fffd| -   idForm=14_2018
' |fffd||fffd||fffd| 15.01.2018
'
Option Explicit
Public sSelectRange As String
Dim db As Database
Dim rs As Recordset
Dim FlReneme  As Long
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (mod074_2018)*
Public Sub InsertColumn_2018()

UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"

'AddFormarekvizit "Data_RCH"
AddFormarekvizit gcNameAddRd '13.01.2011
 
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|(mod074_2018)*
Public Sub RenameColumn_2018()
Dim r As Range, sKod$

Set r = Selection
sKod = r.Cells(1, 1).Value
sKod = sReplace(sKod, " ", "")
sKod = sReplace(sKod, "'", "")
If Len(sKod) = 0 Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
If HasInSpr(sKod, "Data_RCHGr") Then MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
'If HasInSpr(sKod, "Data_RCH") = False Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
If HasInSpr(sKod, gcNameAddRd) = False Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub '13.01.2011

UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
'AddFormarekvizit "Data_RCH"2
AddFormarekvizit gcNameAddRd '13.01.2011

End Sub


'-------------------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|(mod074_2018)*
Public Function AddColumnList_2018(sKod() As String) As String
Dim r As Range, i As Long, Rv As Range, Rds As Range, Rds4 As Range, j As Long, sp$, sAd$
Dim sAdrv$, sAdds$, sAdds4$ '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'    On Error Resume Next
For j = 1 To 8
    sp = Trim$(str(j))
    Set Rv = Range("Data_" & sp & "3v")
    Rv.Columns.EntireColumn.Hidden = False
    For i = LBound(sKod) To UBound(sKod)
        If Len(sKod(i)) = 0 Then GoTo a2
        Set r = Range("Data_" & sp & "1v").Cells(1, 1)
        If IsEmpty(r.Value) Or Len(r.Value) = 0 Then Set Rds = Range("Data_" & sp & "1"): Set Rds4 = Range("Data_51"): GoTo A1
        Set r = Range("Data_" & sp & "2v").Cells(1, 1)
        If IsEmpty(r.Value) Or Len(r.Value) = 0 Then Set Rds = Range("Data_" & sp & "2"): Set Rds4 = Range("Data_52"): GoTo A1
        
        sAdrv = "='" & Rv.Worksheet.name & "'!" & Rv.Cells.Address
        sAdds = "='" & Rv.Worksheet.name & "'!" & Range("Data_" & sp & "3").Address
        If (j = 3 Or j = 4) Then sAdds4 = "='" & Rv.Worksheet.name & "'!" & Range("Data_53").Address
        Rv.Copy
        Rv.Insert Shift:=xlToRight
        Application.CutCopyMode = False
        Set Rds = Range(sAdds)
        If (j = 3 Or j = 4) Then Set Rds4 = Range(sAdds4)
        Set r = Range(sAdrv).Cells(1, 1)
A1:
        r.Value = FormatKod(sKod(i))
        sAd = "='" & r.Worksheet.name & "'!" & r.Address
        ActiveWorkbook.Names.Add name:="rr" & sp & sKod(i), RefersTo:=sAd
        insertName sKod(i), Rds, "Kod" & sp, False
a2:
    Next i
    fMerge_2018 Rv.Worksheet
    Rv.Columns.EntireColumn.Hidden = True
Next j
AddNN_2018
If UBound(sKod) = 0 Then sSelectRange = "rr1" & sKod(0)
Set Rds = Nothing
Set Rv = Nothing
Set r = Nothing
End Function

'----------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(mod074_2018)*
Public Sub fGroupAdd_2018()
Dim mKodGr() As String, mKod() As String, i As Long, Org$, sKodRrimary$, j As Long, sKodGr$

If MsgBox("|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|?", 4 + 256, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|") = 7 Then Exit Sub
UnProtectBook
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
mKod() = ReturnKods_2018(False)
'If UBound(mKod) = 0 And mKod(0) = "False" Then MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Sub
    
Range("Data_13v").Columns.EntireColumn.Hidden = False
Range("Data_23v").Columns.EntireColumn.Hidden = False
Range("Data_33v").Columns.EntireColumn.Hidden = False
Range("Data_43v").Columns.EntireColumn.Hidden = False   '13.01.2011

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
For i = 0 To UBound(mKod)
    sKodRrimary = mKod(i)
    Org = Mid$(sKodRrimary, 20, 4)
    mKodGr() = fKodsGr_2018(left(sKodRrimary, 19))
    For j = 0 To UBound(mKodGr)
'            sKodGr = KodGr(j)
            sKodGr = mKodGr(j) & Org
            If Len(sKodGr) > 0 And Not HasName("rg1" & sKodGr) Then AddGRColumn_2018 sKodRrimary, sKodGr
            sKodRrimary = sKodGr
    Next j
Next i
AddNN_2018
CleareFormuls_2018
InsertFormuls_2018
Range("Data_13v").Columns.EntireColumn.Hidden = True
Range("Data_23v").Columns.EntireColumn.Hidden = True
Range("Data_33v").Columns.EntireColumn.Hidden = True
Range("Data_43v").Columns.EntireColumn.Hidden = True      '13.01.2011
ProtectBook
End Sub
'-------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|(mod074_2018)*
Public Sub AddGRColumn_2018(ByVal sKodRrimary$, ByVal sKodGr$)
Dim sNamePrimary$, sGrName$, j As Long, sp$
Dim Rv As Range, r As Range, Rpr As Range
Dim sAdrDS$, Rds As Range, w As Worksheet, sAd$

For j = 1 To 5  '13.01.2011
'For j = 1 To 3
    sp = Trim$(str(j))
    sNamePrimary = "rr" & sp & sKodRrimary
    If Not HasName(sNamePrimary) Then sNamePrimary = "rg" & sp & sKodRrimary
    Set Rpr = Range(sNamePrimary)
    sGrName = "rg" & sp & sKodGr
    Set Rv = Range("Data_" & sp & "3v")
    Set w = Rv.Worksheet
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set r = Range(w.Cells(Rv.Row, Rpr.Column), w.Cells(Rv.Row + Rv.Rows.Count - 1, Rpr.Column + Rv.Columns.Count - 1))
    sAdrDS = "='" & Rv.Worksheet.name & "'!" & r.Address
    Rv.Copy
    r.Insert Shift:=xlToRight
    Set r = Range(sAdrDS)
'    If j <> 3 Then R.ColumnWidth = 12.86 Else R.ColumnWidth = 14.29
    r.Cells(1, 1) = FormatKod(sKodGr)
        sAd = "='" & r.Worksheet.name & "'!" & r.Cells(1, 1).Address
        ActiveWorkbook.Names.Add name:=sGrName, RefersTo:=sAd
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| ~ Data_11
Set Rds = Range(w.Cells(Range("Kod" & sp).Row, r.Column), w.Cells(Rv.Row + Rv.Rows.Count - 1, r.Column + r.Columns.Count - 1))
Rds.Interior.ColorIndex = xlNone
Rds.Locked = True
insertName sKodGr, Rds, "Kod" & sp, True

'13.01.2011
'If j = 3 Then
'    Set Rds = W.Range(W.Cells(Range("Kod4").Row, r.Column), W.Cells(Range("Kod4").Row + Range("Kod4").Rows.Count - 1, r.Column + r.Columns.Count - 1))
'    insertName sKodGr, Rds, "Kod4", True
'    Rds.Interior.ColorIndex = xlNone
'    Rds.Locked = True
'End If
'13.01.2011

fMerge_2018 Rv.Worksheet
Next j
Set r = Nothing
Set Rpr = Nothing
Set Rv = Nothing
Set Rds = Nothing
Set w = Nothing
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (mod074_2018_2)*
'False - |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  True |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function ReturnKods_2018(flGroup As Boolean) As String()
Dim mKod() As String, Rv As Range, w As Worksheet, rowKod As Long, sKod$, j As Long, i As Long, Org$

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Set Rv = Range("Data_13v")
'rowKod = Rv.Cells(1, 1).row
rowKod = Rv.Row
ReDim mKod(0 To (Rv.Column - Range("Kod1").Column) \ 2)
For i = Range("Kod1").Column + 3 To Rv.Column - 1
    Org = ""
    sKod = w.Cells(rowKod, i)
    If Len(sKod) = 0 Then GoTo A1
    sKod = sReplace(sKod, "'", "")
    sKod = sReplace(sKod, vbLf, "")
    If Len(sKod) > 19 Then
        Org = Mid$(sKod, 20, 4)
        sKod = left(sKod, 19)
    End If
    If Len(sKod) > 0 Then
'        If flGroup = False And HasInSpr(sKod, "Data_RCH") = True Then
        If flGroup = False And HasInSpr(sKod, gcNameAddRd) = True Then '13.01.2011
           mKod(j) = IIf(Len(Org) = 0, sKod, sKod & Org)
            j = j + 1
        End If
        If flGroup = True And HasInSpr(sKod, "Data_RCHGr") = True Then
            mKod(j) = sKod
            j = j + 1
        End If
    End If
A1:
Next i
If j = 0 Then j = 1: mKod(0) = "False"
ReDim Preserve mKod(0 To j - 1)
Set Rv = Nothing
Set w = Nothing
ReturnKods_2018 = mKod()
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| (mod074_2018_2)*
Public Function fKodsGr_2018(sKod As String) As String()
Dim mKodGr() As String, r As Range, i As Long, sGrStr$, k As Long, s$
ReDim mKodGr(0 To 15)
fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index

'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd||fffd| Parent
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd|
'Set r = Range("Data_RCH")
Set r = Range(gcNameAddRd) '13.01.2011

r.Sort Key1:=r.Cells(1, 1), Order1:=xlAscending
For i = 1 To r.Rows.Count
    If r.Cells(i, 1) = sKod Then
        If Len(r.Cells(i, 2)) > 0 Then sGrStr = r.Cells(i, 3): GoTo A1
    End If
Next i
A1:
If Len(sGrStr) = 0 Then GoTo a2
Set r = Range("Data_RCHGr")
r.Sort Key1:=r.Cells(1, 1), Order1:=xlAscending
While Len(sGrStr) > 0
    For i = 1 To r.Rows.Count
        s = r.Cells(i, 1)
        If Right$(s, 5) = sGrStr Then
            mKodGr(k) = s
            k = k + 1
            sGrStr = r.Cells(i, 3)
            GoTo A3
        End If
    Next i
    sGrStr = ""
A3:
Wend
a2:
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "" |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
ReDim Preserve mKodGr(0 To k)
'If k = 0 Then k = 1
'ReDim Preserve mKodGr(0 To k - 1)
Set r = Nothing
fKodsGr_2018 = mKodGr()
End Function

' (mod074_2018_2)*
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| "|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
Public Sub fMerge_2018(w As Worksheet, Optional ByVal Col1 As Long = 0, Optional ByVal Col2 As Long = 0)
Dim Row As Long, sAd$, r As Range, Col3 As Long, iw As Single, Rv As Range
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge1").Row
    Set Rv = Range("Data_13v")
    If Col1 = 0 Then Col1 = Range("Data_Kods1").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge2").Row
    Set Rv = Range("Data_23v")
    If Col1 = 0 Then Col1 = Range("Data_Kods2").Cells(1, 4).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 3
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|-3" Then
    Row = Range("Data_Merge3").Row
    Set Rv = Range("Data_33v")
    If Col1 = 0 Then Col1 = Range("Data_Kods3").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.89
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|-4" Then
    Row = Range("Data_Merge4").Row
    Set Rv = Range("Data_43v")
    If Col1 = 0 Then Col1 = Range("Data_Kods4").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.89
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-5;6" Then
    Row = Range("Data_Merge5").Row
    Set Rv = Range("Data_53v")
    If Col1 = 0 Then Col1 = Range("Data_Kods5").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-5;6" Then
    Row = Range("Data_Merge6").Row
    Set Rv = Range("Data_63v")
    If Col1 = 0 Then Col1 = Range("Data_Kods6").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-5;6" Then
    Row = Range("Data_Merge7").Row
    Set Rv = Range("Data_73v")
    If Col1 = 0 Then Col1 = Range("Data_Kods7").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-5;6" Then
    Row = Range("Data_Merge8").Row
    Set Rv = Range("Data_83v")
    If Col1 = 0 Then Col1 = Range("Data_Kods8").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
sAd = "='" & w.name & "'!" & Range(Cells(Row, Col1), Cells(Row, Col2)).Address
Set r = Range(sAd)
r.UnMerge
r.Merge
r.ColumnWidth = iw
r.Borders(xlEdgeTop).LineStyle = xlContinuous
Rv.Columns.EntireColumn.Hidden = True

sAd = "='" & w.name & "'!" & Range(Cells(Row, Col3), Cells(Row, 90)).Address
Set r = Range(sAd)
r.Borders(xlEdgeBottom).LineStyle = xlNone
r.Borders(xlEdgeTop).LineStyle = xlNone
Set r = Nothing
Set Rv = Nothing
End Sub

' (modF074new)*
Public Sub DeleteColumn_2018()
Dim n As name, r As Range, sp$, Rv As Range, sAd$, j As Long, sKod$, Rds As Range, w As Worksheet, sname$, s$
For Each n In ActiveWorkbook.Names
    sname = n.name
    If n.name Like "rg*" Then MsgBox "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
Next

Set r = Selection
sKod = r.Cells(1, 1).Value
sKod = sReplace(sKod, "'", "")
sKod = sReplace(sKod, " ", "")
'If Len(sKod) = 0 Or Not HasInSpr(sKod, "Data_RCH") Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
If Len(sKod) = 0 Or Not HasInSpr(sKod, gcNameAddRd) Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub  '13.01.2011
If MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| " & sKod & " ?", 4 + 256, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|") = 7 Then Exit Sub
UnProtectBook
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| c |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
If DelName11(sKod) Then GoTo a2
DelNamesss sKod
For j = 1 To 8
    sp = Trim$(str(j))
    s = "rr" & sp & sKod
    Set r = Range(s)
    Set w = r.Worksheet
    Set Rv = Range("Data_" & sp & "1v")
    sAd = "='" & r.Worksheet.name & "'!" & Range(Cells(Rv.Row, r.Column), Cells(Rv.Row + Rv.Rows.Count - 1, r.Column + Rv.Columns.Count - 1)).Address
    Set Rv = Range(sAd)
    
    If DelName2_2018(Rv, sp) Then GoTo A1
    If DelName1_2018(Rv, sp) Then GoTo A1

    
'    If Rv.Column > Range("Data_" & sp & "2v").Column Then
        Rv.Delete Shift:=xlToLeft
        Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
        
A1:
'    Else
'        R.Value = ""
'        Set Rds = Range("Data_" & sp & "1")
'        sAd = "='" & R.Worksheet.Name & "'!" & Range(Cells(Rds.row, R.Column), Cells(Rds.row + Rds.Rows.Count - 1, R.Column + Rds.Columns.Count - 1)).Address
'        fCleareRange Range(sAd)
'        If j = 3 Then
'            Set Rds = Range("Data_41")
'            sAd = "='" & R.Worksheet.Name & "'!" & Range(Cells(Rds.row, R.Column), Cells(Rds.row + Rds.Rows.Count - 1, R.Column + Rds.Columns.Count - 1)).Address
'            fCleareRange Range(sAd)
'        End If
'    End If
    ActiveWorkbook.Names(s).Delete
    fMerge_2018 w
Next j
AddNN_2018
a2:
CleareFormuls_2018
InsertFormuls_2018
ProtectBook
Set r = Nothing
Set Rv = Nothing
Set Rds = Nothing
Set w = Nothing
End Sub
' (modF074new)*
'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| "Data_" & sp & "2v"
Public Function DelName2_2018(Rv As Range, sp$) As Boolean
Dim sAdv$, sAdds$, sAdds4$
If Rv.Address <> Range("Data_" & sp & "2v").Address Then
    DelName2_2018 = False
    Exit Function
End If
sAdv = "='" & Rv.Worksheet.name & "'!" & Rv.Address
sAdds = "='" & Rv.Worksheet.name & "'!" & Range("Data_" & sp & "2").Address
If (sp = "3" Or sp = "4") Then sAdds4 = "='" & Rv.Worksheet.name & "'!" & Range("Data_52").Address
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|
If Rv.Column = Range("Data_" & sp & "3v").Column - Rv.Columns.Count Then
        Rv.Cells(1, 1).Value = ""
        fCleareRange Range("Data_" & sp & "2")
        'If sp = "3" Then fCleareRange Range("Data_42") '13.01.2011
Else
        Rv.Delete Shift:=xlToLeft
        ActiveWorkbook.Names.Add name:="Data_" & sp & "2v", RefersTo:=sAdv
        ActiveWorkbook.Names.Add name:="Data_" & sp & "2", RefersTo:=sAdds
        'If sp = "3" Then ActiveWorkbook.Names.Add Name:="Data_42", RefersTo:=sAdds4    '13.01.2011
        Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
End If
DelName2_2018 = True
End Function
' (modF074new)*
'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| "Data_" & sp & "1v"
Public Function DelName1_2018(Rv1 As Range, sp$) As Boolean
Dim sAdv1$, sAdv2$, sAdds1$, sAdds2$, sAdds41$, sAdds42$
Dim Rv2 As Range
If Rv1.Address <> Range("Data_" & sp & "1v").Address Then
    DelName1_2018 = False
    Exit Function
End If
Set Rv2 = Range("Data_" & sp & "2v")
If Len(Rv2.Cells(1, 1).Value) = 0 Then
    Rv1.Cells(1, 1).Value = ""
    fCleareRange Range("Data_" & sp & "1")
    If (sp = "3" Or sp = "4") Then fCleareRange Range("Data_51")
End If

If Rv2.Column < Range("Data_" & sp & "3v").Column - Rv1.Columns.Count Then
    sAdv1 = "='" & Rv1.Worksheet.name & "'!" & Rv1.Address
    sAdv2 = "='" & Rv2.Worksheet.name & "'!" & Rv2.Address
    sAdds1 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_" & sp & "1").Address
    sAdds2 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_" & sp & "2").Address
    If (sp = "3" Or sp = "4") Then
        sAdds41 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_51").Address
        sAdds42 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_52").Address
    End If
    Rv1.Delete Shift:=xlToLeft
    ActiveWorkbook.Names("Data_" & sp & "2v").Delete
    ActiveWorkbook.Names("Data_" & sp & "2").Delete
    ActiveWorkbook.Names.Add name:="Data_" & sp & "1v", RefersTo:=sAdv1
    ActiveWorkbook.Names.Add name:="Data_" & sp & "1", RefersTo:=sAdds1
    ActiveWorkbook.Names.Add name:="Data_" & sp & "2v", RefersTo:=sAdv2
    ActiveWorkbook.Names.Add name:="Data_" & sp & "2", RefersTo:=sAdds2
    '13.01.2011
'    If sp = "3" Then
'        ActiveWorkbook.Names("Data_42").Delete
'        ActiveWorkbook.Names.Add Name:="Data_41", RefersTo:=sAdds41
'        ActiveWorkbook.Names.Add Name:="Data_42", RefersTo:=sAdds42
'    End If
    '13.01.2011
End If

'sAdv = "='" & Rv.Worksheet.Name & "'!" & Rv.Address
'sAdds = "='" & Rv.Worksheet.Name & "'!" & Range("Data_" & sp & "2").Address
'If sp = "3" Then sAdds4 = "='" & Rv.Worksheet.Name & "'!" & Range("Data_42").Address
''|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|
'If Rv.Column = Range("Data_" & sp & "2v").Column - 2 Then
'        Rv.Cells(1, 1).Value = ""
'        fCleareRange Range("Data_" & sp & "2")
'        If sp = "3" Then fCleareRange Range("Data_42")
'Else
'        Rv.Delete Shift:=xlToLeft
'        ActiveWorkbook.Names.Add Name:="Data_" & sp & "2v", RefersTo:=sAdv
'        ActiveWorkbook.Names.Add Name:="Data_" & sp & "2", RefersTo:=sAdds
'        If sp = "3" Then ActiveWorkbook.Names.Add Name:="Data_42", RefersTo:=sAdds4
'        Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
'End If
Set Rv2 = Nothing
DelName1_2018 = True
End Function
'   (ModF074R)*
Public Sub CleareColumns_2018()
Dim w As Worksheet, r2 As Range, R3 As Range, r As Range, R1 As Range, R0 As Range
Dim sAd$, Col1 As Long, Col2 As Long, i As Long, sp$, a As Variant
If IsEmpty(Range("Data_11v").Cells(1, 1)) Then Exit Sub

For i = 1 To 8
sp = Trim$(str(i))
Set R0 = Range("Kod" & sp)
Set R1 = Range("Data_" & sp & "1v")
Set r2 = Range("Data_" & sp & "2v")
Set R3 = Range("Data_" & sp & "3v")
Set w = r2.Worksheet
Col1 = r2.Column + r2.Columns.Count
Col2 = R3.Column - 1
If Col2 > Col1 Then
    sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
    Range(sAd).Delete Shift:=xlToLeft
End If
Col1 = R0.Column + R0.Columns.Count + R1.Columns.Count
Col2 = R1.Column - 1
If Col2 > Col1 Then
    sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
    Range(sAd).Delete Shift:=xlToLeft
End If
Col1 = R1.Column + R1.Columns.Count
Col2 = r2.Column - 1
If Col2 > Col1 Then
    sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
    Range(sAd).Delete Shift:=xlToLeft
End If

    fMerge_2018 w
    R3.Columns.EntireColumn.Hidden = True
    fCleareRange Range("Data_" & sp & "1")
    fCleareRange Range("Data_" & sp & "2")
     If R1.Cells(1, 1).MergeCells Then R1.Cells(1, 1).MergeArea.ClearContents Else R1.Cells(1, 1).ClearContents
     If r2.Cells(1, 1).MergeCells Then r2.Cells(1, 1).MergeArea.ClearContents Else r2.Cells(1, 1).ClearContents
Next i
deleteNames
Set w = Nothing
Set r2 = Nothing
Set R3 = Nothing
Set r = Nothing
End Sub

'   (ModF074R)*
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub AddNN_2018()
Dim j As Long, sp$, Row As Long, w As Worksheet
Dim r As Range, k As Long, i As Long, Col As Long, n As Long

For j = 1 To 8
    sp = Trim$(str(j))
    Set r = Range("Data_" & sp & "3")
    Set w = r.Worksheet
    Row = r.Row - 1
    Col = Range("Kod" & sp).Column + 1
    k = 3: n = 1
    For i = Col To r.Column - 1
        If IsFirstCell(w.Cells(Row, i)) Then
            w.Cells(Row, i) = k
            k = k + n
        End If
    Next i
Next j
Set r = Nothing
Set w = Nothing
End Sub
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (modF074)*
Public Function Rasstanovka014FromArray_2018(a As Variant) As Variant
Dim Val As Variant, sKod(0) As String, sname$, n As Long, err() As Variant
Dim i As Long

ReDim err(1 To 100, 1 To 2)
n = LBound(err, 1)
UnProtectBook
For i = LBound(a) To UBound(a)
    sname = Trim$(a(i, 1))
    If Len(sname) = 0 Then GoTo a2
'    Val = IIf(A(i, 1) > 0, A(i, 1), A(i, 2))
    Val = a(i, 2)
    If Not sname Like "ss*[a-c]" Then GoTo A1
    If Len(sname) < 23 Then GoTo A1
    sKod(0) = Mid$(sname, 3, Len(sname) - 6)
    If HasName("rr1" & sKod(0)) Then GoTo A1
    AddColumnList_2018 sKod
A1:
    If HasName(sname) Then If HasFormula(Range(sname)) = False Then Range(sname) = Val
'    Else
''        err(n, 1) = sName
''        err(n, 2) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
''        n = n + 1
'    End If
a2:
Next i
InsertFormuls_2018
ProtectBook
'If n = LBound(err) Then Rasstanovka014FromArray = 0
'Else
'    ReDim Preserve err(1 To n - 1, 1 To 2)
'    Rasstanovka014FromArray = err
'End If
Rasstanovka014FromArray_2018 = 0
End Function


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Public Sub CleareFormuls_2018()
Dim j As Long, sp$, r As Range, Col1 As Long, Rds As Range, Col2 As Long, w As Worksheet, s$
'Dim n As Name, sName, iKod%, sKod$
On Error GoTo A1
'UnProtectXlt1
For j = 1 To 8
    sp = Trim$(str(j))
    Set r = Range("Data_" & sp & "3")
    Set w = r.Worksheet

'    Col1 = Range("Kod" & sp).Column + 1 + R.Columns.Count
    Col1 = Range("Kod" & sp).Column + 1
    Col2 = r.Column - 1
    Set Rds = Range(w.Cells(r.Row, Col1), w.Cells(r.Row + r.Rows.Count - 1, Col2))
    For Each r In Rds
        s = r.Formula
        If Len(s) = 0 Or s = "X" Or left$(s, 5) = "=|fffd||fffd||fffd||fffd|" Or left$(s, 4) = "=SUM" Then GoTo A1
        If left$(s, 1) = "=" Then r.Formula = ""
A1:
    Next
Next j
Set r = Nothing
Set Rds = Nothing
Set w = Nothing
End Sub


Public Sub InsertFormuls_2018()
Dim n As name, sname$, sKod$, Org$, idForm$
idForm = sGetINI("idForm", "?")
For Each n In ActiveWorkbook.Names
    sname = n.name
    If sname Like "rr1*" Then
        sKod = Mid$(sname, 4, 22)
'        Org = Mid$(sKod, 20, 4)
'        If (idForm = "14r" Or idForm = "14r_86") Then Org = Mid$(sName, 23, 4)
        If idForm14r = "14R_OKTMO_2018" Then Org = Mid$(sname, 26, 12)
        AddFormulsofRange_2018 sKod, Org, idForm
    End If
Next
End Sub


'|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| DataSheets |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 14r |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub AddFormulsofRange_2018(sKod$, Org$, idForm$)
Dim r As Range, Rds As Range, Rsour As Range, Rtag As Range, n As Long, i As Long, j As Long, k As Long, sp$, Col1 As Long, Col2 As Long, Coltag As Long, Rowtag As Long
Dim w As Worksheet, s$, mKodGr() As String

mKodGr() = fKodsGr(sKod)
For n = 1 To 8
    sp = Trim$(str(n))
    Set r = Range("Data_" & sp & "3")
    Set w = r.Worksheet
'    If n = 4 Then sp = "3"
Col1 = Range("rr" & sp & sKod & Org).Column
Col2 = Col1 + r.Columns.Count - 1
Set Rds = Range(w.Cells(r.Row, Col1), w.Cells(r.Row + r.Rows.Count - 1, Col2))
For i = 1 To Rds.Columns.Count
 For j = 1 To Rds.Rows.Count
 
Set Rsour = Rds.Cells(j, i)
If left$(Rsour.Formula, 5) = "=|fffd||fffd||fffd||fffd|" Or left$(Rsour.Formula, 4) = "=SUM" Or Rsour.Value = "X" Or _
                    Rsour.Interior.ColorIndex <> 35 Or Not IsFirstCell(Rsour) Then GoTo A1

For k = LBound(mKodGr) To UBound(mKodGr)
    If Len(mKodGr(k)) = 0 And (idForm = "14" Or idForm = "14_179" Or idForm = "14_86" Or idForm = "14_2018") Then '17.01.2011
        Coltag = Range("Kod" & sp).Column
    Else
        s = "rg" & sp & mKodGr(k) & Org
        If Not HasName(s) Then GoTo a2
        Coltag = Range(s).Column - 1
    End If
    Rowtag = Rsour.Row
    Set Rtag = w.Cells(Rowtag, Coltag + i)
            If left$(Rtag.Formula, 1) = "=" Then
                    Rtag.Formula = Rtag.Formula & " + " & Rsour.Address
            Else
                    Rtag.Formula = "=" & Rsour.Address
            End If
a2:
Next k
A1:
Next j
Next i
Next n
Set w = Nothing
Set r = Nothing
Set Rds = Nothing
Set Rsour = Nothing
Set Rtag = Nothing
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub RenameColumns_2018(sKodNew$)
Dim sKOdOld$, mKodGr() As String, sKodGrOld$, sKodGrNew$, j As Long, s$, sp$, r As Range, Rds As Range, sAd$
Set r = Selection
sKOdOld = r.Cells(1, 1).Value
sKOdOld = sReplace(sKOdOld, "'", "")
sKOdOld = sReplace(sKOdOld, " ", "")
mKodGr() = fKodsGr_2018(sKOdOld)
If UBound(mKodGr) > 0 Then sKodGrOld = mKodGr(0)
If HasName("rg1" & sKodGrOld) Then
    mKodGr() = fKodsGr_2018(sKodNew)
    If UBound(mKodGr) > 0 Then sKodGrNew = mKodGr(0)
    If sKodGrOld <> sKodGrNew Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
End If
Unload UserForm1
DelNamesss sKOdOld  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| "Data_Cells"
For j = 1 To 8
    sp = Trim$(str(j))
    s = "rr" & sp & sKOdOld
    Set r = Range(s)
    Set Rds = Range("Data_" & sp & "1")
    sAd = "='" & r.Worksheet.name & "'!" & Range(Cells(Rds.Row, r.Column), Cells(Rds.Row + Rds.Rows.Count - 1, r.Column + Rds.Columns.Count - 1)).Address
    Set Rds = Range(sAd)
    sAd = "='" & r.Worksheet.name & "'!" & r.Address
    ActiveWorkbook.Names(s).Delete
'    r.Value = sKodNew
    r.Value = FormatKod(sKodNew)
    ActiveWorkbook.Names.Add name:="rr" & sp & sKodNew, RefersTo:=sAd
    insertName sKodNew, Rds, "Kod" & sp, False
'        If j = 3 Then
'            Set Rds = Range("Data_41")
'            sAd = "='" & r.Worksheet.name & "'!" & Range(Cells(Rds.Row, r.Column), Cells(Rds.Row + Rds.Rows.Count - 1, r.Column + Rds.Columns.Count - 1)).Address
'            insertName sKodNew, Rds, "Kod4", False
'        End If
Next j
Set r = Nothing
Set Rds = Nothing
End Sub

'-------------------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|(mod074)*
'<Spir>31.01.2018 |fffd||fffd||fffd| |fffd||fffd| 01012010  idForm=14R_OKTMO_2018 |fffd| Len_CS = 10
'-------------------------------------
Public Function AddColumnList_2018_CS10(sKod() As String) As String
Dim r As Range, i As Long, Rv As Range, Rds As Range, Rds4 As Range, j As Long, sp$, sAd$
Dim sAdrv$, sAdds$, sAdds4$ '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'    On Error Resume Next
For j = 1 To 8
    sp = Trim$(str(j))
    Set Rv = Range("Data_" & sp & "3v")
    Rv.Columns.EntireColumn.Hidden = False
    For i = LBound(sKod) To UBound(sKod)
        If Len(sKod(i)) = 0 Then GoTo a2
        Set r = Range("Data_" & sp & "1v").Cells(1, 1)
        If IsEmpty(r.Value) Or Len(r.Value) = 0 Then Set Rds = Range("Data_" & sp & "1"): Set Rds4 = Range("Data_41"): GoTo A1
        Set r = Range("Data_" & sp & "2v").Cells(1, 1)
        If IsEmpty(r.Value) Or Len(r.Value) = 0 Then Set Rds = Range("Data_" & sp & "2"): Set Rds4 = Range("Data_42"): GoTo A1
        
        sAdrv = "='" & Rv.Worksheet.name & "'!" & Rv.Cells.Address
        sAdds = "='" & Rv.Worksheet.name & "'!" & Range("Data_" & sp & "3").Address
'        If j = 3 Then sAdds4 = "='" & Rv.Worksheet.name & "'!" & Range("Data_43").Address
        Rv.Copy
        Rv.Insert Shift:=xlToRight
        Application.CutCopyMode = False
        Set Rds = Range(sAdds)
'        If j = 3 Then Set Rds4 = Range(sAdds4)
        Set r = Range(sAdrv).Cells(1, 1)
A1:
        r.Value = FormatKod(sKod(i))
        sAd = "='" & r.Worksheet.name & "'!" & r.Address
        ActiveWorkbook.Names.Add name:="rr" & sp & sKod(i), RefersTo:=sAd
        insertName sKod(i), Rds, "Kod" & sp, False
a2:
    Next i
    fMerge_2018_CS10 Rv.Worksheet, sp
'    fMerge_179_CS10 Rv.Worksheet, sp
    Rv.Columns.EntireColumn.Hidden = True
Next j
AddNN_2018
If UBound(sKod) = 0 Then sSelectRange = "rr1" & sKod(0)
Set Rds = Nothing
Set Rv = Nothing
Set r = Nothing
End Function


'   (ModF074R)*
'<Spir>31.01.2018 |fffd||fffd||fffd| |fffd||fffd| 01012018  idForm=14R_OKTMO_2018 |fffd| Len_CS = 10

Public Sub CleareColumns_2018_CS10()
Dim w As Worksheet, r2 As Range, R3 As Range, r As Range, R1 As Range, R0 As Range
Dim sAd$, Col1 As Long, Col2 As Long, i As Long, sp$, a As Variant
If IsEmpty(Range("Data_11v").Cells(1, 1)) Then Exit Sub

For i = 1 To 8
    sp = Trim$(str(i))
    Set R0 = Range("Kod" & sp)
    Set R1 = Range("Data_" & sp & "1v")
    Set r2 = Range("Data_" & sp & "2v")
    Set R3 = Range("Data_" & sp & "3v")
    Set w = r2.Worksheet
    Col1 = r2.Column + r2.Columns.Count
    Col2 = R3.Column - 1
    If Col2 > Col1 Then
        sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
        Range(sAd).Delete Shift:=xlToLeft
    End If
    Col1 = R0.Column + R0.Columns.Count + R1.Columns.Count
    Col2 = R1.Column - 1
    If Col2 > Col1 Then
        sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
        Range(sAd).Delete Shift:=xlToLeft
    End If
    Col1 = R1.Column + R1.Columns.Count
    Col2 = r2.Column - 1
    If Col2 > Col1 Then
        sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
        Range(sAd).Delete Shift:=xlToLeft
    End If
    
    fMerge_2018_CS10 w, sp
'    fMerge_179_CS10 w, sp
    R3.Columns.EntireColumn.Hidden = True
    fCleareRange Range("Data_" & sp & "1")
    fCleareRange Range("Data_" & sp & "2")
     If R1.Cells(1, 1).MergeCells Then R1.Cells(1, 1).MergeArea.ClearContents Else R1.Cells(1, 1).ClearContents
     If r2.Cells(1, 1).MergeCells Then r2.Cells(1, 1).MergeArea.ClearContents Else r2.Cells(1, 1).ClearContents
Next i
deleteNames
Set w = Nothing
Set r2 = Nothing
Set R3 = Nothing
Set r = Nothing
End Sub

' (mod074_2)*
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| "|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
'<Spir>31.01.2018 |fffd||fffd||fffd| |fffd||fffd| 01012018  idForm=14R_OKTMO_2018 |fffd| Len_CS = 10
'-------------------------------------
Public Sub fMerge_2018_CS10(w As Worksheet, NomRange As String, Optional ByVal Col1 As Long = 0, Optional ByVal Col2 As Long = 0)
Dim Row As Long, sAd$, r As Range, Col3 As Long, iw As Single, Rv As Range
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge1").Row
    Set Rv = Range("Data_13v")
    If Col1 = 0 Then Col1 = Range("Data_Kods1").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge2").Row
    Set Rv = Range("Data_23v")
    If Col1 = 0 Then Col1 = Range("Data_Kods2").Cells(1, 4).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 3
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|-3" Then
    Row = Range("Data_Merge3").Row
    Set Rv = Range("Data_33v")
    If Col1 = 0 Then Col1 = Range("Data_Kods3").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.89
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|-4" Then
    Row = Range("Data_Merge4").Row
    Set Rv = Range("Data_43v")
    If Col1 = 0 Then Col1 = Range("Data_Kods4").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.89
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-5;6" Then
    Row = Range("Data_Merge" & NomRange).Row
    Set Rv = Range("Data_" & NomRange & "3v")
    If Col1 = 0 Then Col1 = Range("Data_Kods" & NomRange).Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
sAd = "='" & w.name & "'!" & Range(Cells(Row, Col1), Cells(Row, Col2)).Address
Set r = Range(sAd)
r.UnMerge
r.Merge
r.ColumnWidth = iw
r.Borders(xlEdgeTop).LineStyle = xlContinuous
Rv.Columns.EntireColumn.Hidden = True

sAd = "='" & w.name & "'!" & Range(Cells(Row, Col3), Cells(Row, 90)).Address
Set r = Range(sAd)
r.Borders(xlEdgeBottom).LineStyle = xlNone
r.Borders(xlEdgeTop).LineStyle = xlNone
Set r = Nothing
Set Rv = Nothing
End Sub






Attribute VB_Name = "ModF125169"
Option Explicit

Function CreateInsertsql(fArr, str As String, sn As String) As String
Dim j  As Long
Dim i  As Long
Dim sqlInsert  As String
Dim fArr1()

 sqlInsert = ""
  fArr = DelimitedLineToArray(str, sn)
  
  For i = 0 To UBound(fArr)
    j = InStr(fArr(i), "MID")
    If j > 0 Then
      fArr1 = DelimitedLineToArray(fArr(i), ",")
      sqlInsert = sqlInsert & Mid(fArr1(0), j + 4) & ","
    Else
      If InStr(UCase(fArr(i)), "COL") > 0 Then
        sqlInsert = sqlInsert & fArr(i) & ","
      End If
    End If
  Next i

sqlInsert = left(sqlInsert, Len(sqlInsert) - 1)

CreateInsertsql = sqlInsert

Exit Function

End Function

Function CreateInsertsql128(fArr, str As String, sn As String) As String
Dim j  As Long
Dim i  As Long
Dim l  As Long
Dim sqlInsert  As String
Dim fArr1()
Dim fArr2()
Dim sql As String
Dim db As Database
Dim rs As Recordset
Dim TempPath As String

 sqlInsert = ""
 For i = LBound(fArr) To UBound(fArr)
   fArr1 = DelimitedLineToArray(fArr(i), "&") '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| ,|fffd||fffd||fffd||fffd|:MID(RC6,1,7) + '0000000000' + MID(RC6,18,9)
     For j = LBound(fArr1) To UBound(fArr1)
       l = InStr(fArr1(j), "MID")
       If l > 0 Then
         fArr2 = DelimitedLineToArray(fArr1(j), ",")
         sqlInsert = sqlInsert & Mid(fArr2(0), l + 4) & ","
       Else
         If InStr(UCase(fArr1(j)), "COL") > 0 Then
           sqlInsert = sqlInsert & fArr1(j) & ","
         End If
       End If
       
     Next j
   
  Next i
TempPath = Environ("Temp")
sqlInsert = left(sqlInsert, Len(sqlInsert) - 1)
fArr1 = DelimitedLineToArray(sqlInsert, ",") '|fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Set db = OpenDatabase(TempPath & "\SvTemp.mdb", False, False)
Call drop_table(db, "Tcol")
sql = "Create table Tcol(col text,Ord integer,id counter)"
db.Execute (sql)
 For i = LBound(fArr1) To UBound(fArr1)
  sql = "insert into Tcol(col,Ord) "
  sql = sql & "select '" & fArr1(i) & "',0"
  db.Execute (sql)
Next i

sql = "insert into Tcol(col,Ord) "
sql = sql & "select col,1 from Tcol "
sql = sql & "group by col"
db.Execute (sql)

db.Execute ("delete * from Tcol where Ord=0")


sqlInsert = ""
sql = "select * from Tcol order by id"
Set rs = db.OpenRecordset(sql)
If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
  Do Until rs.EOF
    sqlInsert = sqlInsert & rs("col") & ","
    rs.MoveNext
  Loop
  sqlInsert = left(sqlInsert, Len(sqlInsert) - 1)
Else
  sqlInsert = ""
End If

On Error Resume Next
rs.Close
db.Close

CreateInsertsql128 = sqlInsert

End Function
Function CreateJoinsql128(fArr, str As String) As String
'Dim fArr1()
'Dim sqlJoin As String
'Dim sql As String
'Dim sql1 As String
'Dim i As Integer
'Dim j As Integer
'
' sqlJoin = ""
' For i = LBound(fArr) To UBound(fArr)
'    fArr1 = DelimitedLineToArray(fArr(i), "&") '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| ,|fffd||fffd||fffd||fffd|:MID(RC6,1,7) + '0000000000' + MID(RC6,18,9)
'     For j = LBound(fArr1) To UBound(fArr1)
'       If InStr(fArr1(j), "MID") > 0 Or InStr(fArr1(j), "col") > 0 Then
'        sql = sReplace(fArr1(j), "col", "Result.col")
'        sql1 = sReplace(fArr1(j), "col", "Result_1.col")
'        'sqlJoin = sqlJoin & "(Result." & fArr1(j) & "=Result_1." & fArr1(j) & ") and "
'        sqlJoin = sqlJoin & "(" & sql & "=" & sql1 & ") and "
'      End If
'    Next j
'Next i
'
'sqlJoin = Trim(sqlJoin)
'sqlJoin = left(sqlJoin, Len(sqlJoin) - 4)
'
'CreateJoinsql128 = sqlJoin

Dim fArr1()
Dim sqlJoin As String
Dim sql As String
Dim sql1 As String
Dim i  As Long
Dim j  As Long
Dim k  As Long
Dim l  As Long

 sqlJoin = ""
  For i = LBound(fArr) To UBound(fArr)
    fArr1 = DelimitedLineToArray(fArr(i), "&") '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| ,|fffd||fffd||fffd||fffd|:MID(RC6,1,7) + '0000000000' + MID(RC6,18,9)
     If LBound(fArr1) = UBound(fArr1) Then
     
       For j = LBound(fArr1) To UBound(fArr1)
         
         'If InStr(fArr1(j), "col") > 0 And InStr(fArr1(j), "MID") = 0 Then
         If InStr(fArr1(j), "MID") = 0 Then
            sql = sReplace(fArr1(j), "col", "Result.col")
            sql1 = sReplace(fArr1(j), "col", "Result_1.col")
            'sqlJoin = sqlJoin & "(Result." & fArr1(j) & "=Result_1." & fArr1(j) & ") and "
            sqlJoin = sqlJoin & "(" & sql & "=" & sql1 & ") and "
         ElseIf InStr(fArr1(j), "MID") > 0 Then
           sql = sReplace(fArr1(j), "col", "Result.col")
           k = InStr(1, fArr1(j), "col")
            If k > 0 Then
              l = InStr(k, fArr1(j), ",")
              If l > 0 Then
                sql1 = "Result_1." & Mid(fArr1(j), k, l - k)
                sqlJoin = sqlJoin & "(" & sql & "=" & sql1 & ") and "
              Else
                GoTo a
              End If
            Else
              GoTo a
            End If
         End If
          
a:
       Next j
     ElseIf UBound(fArr1) > 0 Then '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
      sql = ""
        
        For j = LBound(fArr1) To UBound(fArr1)
           If InStr(fArr1(j), "MID") > 0 Or InStr(fArr1(j), "col") > 0 Then
                     
              sql = sReplace(fArr1(j), "col", "Result.col")
              sql1 = sReplace(fArr1(j), "col", "Result_1.col")
              'sqlJoin = sqlJoin & "(Result." & fArr1(j) & "=Result_1." & fArr1(j) & ") and "
              sqlJoin = sqlJoin & "(" & sql & "=" & sql1 & ") and "
           End If
            
          
         Next j
      
      
     End If
Next i

sqlJoin = Trim(sqlJoin)
sqlJoin = left(sqlJoin, Len(sqlJoin) - 4)
CreateJoinsql128 = sqlJoin
End Function

Public Sub F169_newItogo()

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 169|fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|,
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|.

'|fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|:
'|fffd||fffd||fffd||fffd|1!|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| = Data_DK, Data_VDE, Data_VZD
'|fffd||fffd||fffd||fffd|1!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|=Data_PLS0, Data_TXT4(|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - 2007), Data_TXT3(Kod_GUID)
'|fffd||fffd||fffd||fffd|1!Kod =1,4, 7
'IdForm = 169
'Calculate = 5
'DSItog1.Group1 = RC1
'DSItog1.Group2 = RC1 & RC4
'DSItog1.Sum = RC2 & RC3
'DSItog2.Group1 = RC4
'DSItog2.Sum = RC3
'|fffd| |fffd||fffd||fffd||fffd||fffd||fffd| DSItog1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(Group1 |fffd| Group2).|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|.
'|fffd||fffd||fffd||fffd||fffd||fffd| DSItog1.Group2 = RC1 & RC4 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 4-|fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd| DSItog1.Sum = RC2 & RC3 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ,|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|(Itog1,Itog2,Itog3)
'|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|) |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|.



Dim Row  As Long
Dim row_Itog1  As Long
Dim row_Itog2  As Long
Dim row_Itog3  As Long
Dim row_Itog4  As Long
Dim db As Database
Dim sql As String
Dim sql1 As String
Dim k1, k2, k3, k4
Dim rs As Recordset
Dim fArr
Dim fArr1
Dim lnFrm  As Long
Dim i  As Long
Dim j  As Long
Dim l  As Long
Dim nm As String
Dim n  As Long
Dim sGr1_1 As String
Dim sGr1_2 As String
Dim sGr2 As String
Dim sqlJoin1 As String
Dim sqlJoin3 As String
Dim sqlInsert As String
Dim sqlInsert1 As String
Dim sqlInsert3 As String
Dim m  As Long
Dim sqlSelect As String
Dim sSum1 As String
Dim sSum2 As String
Dim sqlUpdate1 As String
Dim sqlUpdate2 As String
Dim r As Range, R1 As Range, r2 As Range, R3 As Range, R4 As Range

Dim p  As Long
Dim delta  As Long

Dim flgUseCod As Boolean
Dim Nds As String
Dim TempPath As String

On Error GoTo err169

If Not HasName("DSItog1") Then Exit Sub
If Not HasName("DSItog2") Then Exit Sub

sqlJoin1 = ""
sqlJoin3 = ""

sql = sGetINI("UseDataSheetInCodName", "?")
sql = UCase(Trim(sql))
If sql = "ON" Then
  flgUseCod = True
Else
  flgUseCod = False
End If
sql = ""
sGr1_1 = sGetINI("DSItog1.Group1", "?")
sGr1_2 = sGetINI("DSItog1.Group2", "?")
sSum1 = sGetINI("DSItog1.Sum", "?")

sGr2 = sGetINI("DSItog2.Group1", "?")
sSum2 = sGetINI("DSItog2.sum", "?")
TempPath = Environ("Temp")

If sGr1_1 = "?" And sGr1_2 = "?" And sGr2 = "?" Then Exit Sub


'fArr = 0
'fArr1 = 0
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Set r = Range("DSItog1")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

Set r = Range("DSItog2")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Set r = Range("Itog1")
nm = r.Worksheet.name
i = r.Column
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

Set r = Range("Itog2")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

Set r = Range("Itog3")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone


Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp", dbLangCyrillic)
GoNext:

sql = "create table Result("

If flgUseCod = True Then
   Nds = fGetNumberDataSheet("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|")
Else
  Nds = ""
End If
Set r = Range("Data_Sheet" & Nds)
    
   For i = r.Column To r.Column + r.Columns.Count - 1
    
    If r.Cells(2, i).NumberFormat Like "*0.0*" Then '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
      sql = sql & "col" & i & " memo,"
    Else
      sql = sql & "col" & i & " text,"
    End If
  Next i
    
  sql = sql & "Ord integer) "
  db.Execute (sql)

 If r.Rows.Count <= 2 Then Exit Sub
  
  For j = 2 To r.Rows.Count - 1
    sqlInsert = "insert into Result("
    sql = "values('"
    For i = r.Column To r.Column + r.Columns.Count - 1
      sqlInsert = sqlInsert & "col" & i & ","
      If r.Cells(j, i).NumberFormat Like "*0.0*" Then '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        sql = sql & r.Cells(j, i).Address & "','"
      Else
        sql = sql & r.Cells(j, i).Value & "','"
      End If
    Next i
    sqlInsert = sqlInsert & "Ord) "
    sql = left(sql, Len(sql) - 1)
    sql = sql & "0)"
    db.Execute (sqlInsert + sql)
  Next j


'DsItog1(Ord=1)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If sGr1_1 <> "?" Then
  sGr1_1 = GetSubStrItogo(sGr1_1, "-", "0", "&")
  fArr = DelimitedLineToArray(sGr1_1, ";")
  sqlInsert1 = CreateInsertsql(fArr, sGr1_1, ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert1, ",")
  sqlJoin1 = CreateJoinsql(fArr, sqlInsert1)
  sqlSelect = sReplace(sGr1_1, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert1 & ",Ord) "
  sql = sql & "SELECT " & sqlSelect & ", 1 "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 "
  sql = sql & "GROUP BY " & sqlSelect
  db.Execute (sql)
End If
  
If sSum1 <> "?" Then
  sSum1 = UCase(sSum1)
  sSum1 = sReplace(sSum1, "&", ";")
  sSum1 = sReplace(sSum1, "RC", "col")
  fArr = DelimitedLineToArray(sSum1, ";")
  sqlUpdate1 = "set "
    For i = LBound(fArr) To UBound(fArr)
      sqlUpdate1 = sqlUpdate1 & "Result_1." & fArr(i) & "=trim(Result_1." & fArr(i) & ") & '+' & trim(Result." & fArr(i) & ") ,"
    Next i
    sqlUpdate1 = left(sqlUpdate1, Len(sqlUpdate1) - 1)
  
  sql = "update Result inner join Result as Result_1 on " & sqlJoin1
  sql = sql & " " & sqlUpdate1
  sql = sql & "where Result_1.Ord =1 And Result.Ord = 0"
  db.Execute (sql)
End If

'--------------------
If sGr1_2 <> "?" Then
   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd|
  sGr1_2 = GetSubStrItogo(sGr1_2, "-", "0", "&")
  fArr = DelimitedLineToArray(sGr1_2, ";")
  sqlInsert1 = CreateInsertsql(fArr, sGr1_2, ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert1, ",")
  sqlJoin1 = CreateJoinsql(fArr, sqlInsert1)
  sqlSelect = sReplace(sGr1_2, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert1 & ",Ord) "
  sql = sql & "SELECT " & sqlSelect & ", 2 "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 "
  sql = sql & "GROUP BY " & sqlSelect
  db.Execute (sql)
End If
If sSum1 <> "?" Then
  sSum1 = UCase(sSum1)
  
  sSum1 = sReplace(sSum1, "&", ";")
  sSum1 = sReplace(sSum1, "RC", "col")
  fArr = DelimitedLineToArray(sSum1, ";")
  sqlUpdate1 = "set "
  For i = LBound(fArr) To UBound(fArr)
    sqlUpdate1 = sqlUpdate1 & "Result_1." & fArr(i) & "=trim(Result_1." & fArr(i) & ") & '+' & trim(Result." & fArr(i) & ") ,"
  Next i
   sqlUpdate1 = left(sqlUpdate1, Len(sqlUpdate1) - 1)
  
  sql = "update Result inner join Result as Result_1 on " & sqlJoin1
  sql = sql & " " & sqlUpdate1
  sql = sql & "where Result_1.Ord =2 And Result.Ord = 0"
  db.Execute (sql)
  
  sql = "update Result set "
  For i = LBound(fArr) To UBound(fArr)
    sql = sql & fArr(i) & "=mid(" & fArr(i) & ",2),"
  Next i
  sql = left(sql, Len(sql) - 1)
  sql = sql & " where Ord in(1,2)"
  db.Execute (sql)
End If


'DsItog2(Ord=2)
If sGr2 <> "?" Then
  sGr2 = UCase(sGr2)
  sGr2 = GetSubStrItogo(sGr2, "-", "0", "&")
  
  fArr = DelimitedLineToArray(sGr2, ";")
  sqlInsert3 = CreateInsertsql(fArr, sGr2, ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert3, ",")
  sqlJoin3 = CreateJoinsql(fArr, sqlInsert3)
  
  sqlSelect = sReplace(sGr2, ";", ",")
  
  
  sql = "INSERT INTO Result(" & sqlInsert3 & ",Ord) "
  sql = sql & "SELECT " & sqlSelect & ",3 "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 "
  sql = sql & "GROUP BY " & sqlSelect
  db.Execute (sql)
End If
If sSum2 <> "?" Then
  sSum2 = UCase(Trim(sSum2))
  sSum2 = sReplace(sSum2, "&", ";")
  sSum2 = sReplace(sSum2, "RC", "col")
  fArr = DelimitedLineToArray(sSum2, ";")
   sqlUpdate2 = "set "
   For i = LBound(fArr) To UBound(fArr)
     sqlUpdate2 = sqlUpdate2 & "Result_1." & fArr(i) & "=trim(Result_1." & fArr(i) & ") & '+' & trim(Result." & fArr(i) & ") ,"
   Next i
  sqlUpdate2 = left(sqlUpdate2, Len(sqlUpdate2) - 1)
  sql = "update Result inner join Result as Result_1 on " & sqlJoin3
  sql = sql & " " & sqlUpdate2
  sql = sql & "where Result_1.Ord =3 And Result.Ord = 0"
  db.Execute (sql)
  
  sql = "update Result set "
  For i = LBound(fArr) To UBound(fArr)
    sql = sql & fArr(i) & "=mid(" & fArr(i) & ",2),"
  Next i
  sql = left(sql, Len(sql) - 1)
  sql = sql & " where Ord=3"
  db.Execute (sql)
  sql = ""
 

End If

'Ord=0-|fffd||fffd||fffd||fffd||fffd||fffd|
'Ord=1-DsItog1(|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|)
'Ord=2-DsItog1(|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd|)
'Ord=3-DsItog2
  

  
  sql = "select * from Result where Ord in(1,2) "
  sql = sql & "order by " & sReplace(sGr1_2, ";", ",") & ",Ord"
  Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
  
 If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
  
  Set R1 = Range("Itog1")
  nm = R1.Worksheet.name
  k1 = R1.Column
  row_Itog1 = 0
  Set r2 = Range("Itog2")
  k2 = r2.Column
  row_Itog2 = 0


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
  Set r = Range("DSItog1")
  Do Until rs.EOF

 
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown

  Row = r.Rows.Count - 1
  row_Itog1 = row_Itog1 + 1
  row_Itog2 = row_Itog2 + 1
 
  For i = r.Column To r.Column + r.Columns.Count - 1
   If r.Columns(i).Hidden = False Then
     
     If i = 1 Then
        If rs("Ord") = 1 Then
          'R.Cells(row, i) = IIf(IsNull(rs("col" & i)), "", sReplace(rs("col" & i), " ", "")) & "000"
          r.Cells(Row, i) = IIf(IsNull(rs("col" & i)), "", sReplace(rs("col" & i), " ", ""))
        End If
     Else
       If r.Cells(Row, i).NumberFormat = "@" Or r.Cells(Row, i).NumberFormat = "General" Then
         r.Cells(Row, i) = IIf(IsNull(rs("col" & i)), "", rs("col" & i))
       End If
     End If
     
   End If
 Next i

 fArr1 = DelimitedLineToArray(sSum1, ";")
 n = 1
  
 For i = LBound(fArr1) To UBound(fArr1)
 fArr1(i) = UCase(fArr1(i))
 
 m = Val(sReplace(fArr1(i), "COL", ""))
 p = r.Columns(1).Column '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 delta = p - 1
  lnFrm = Len(IIf(IsNull(Trim(rs(fArr1(i)))), "", Trim(rs(fArr1(i))))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
       fArr = CreateArrayFromStoka(Trim(rs(fArr1(i))), 500)
      
        If IsArray(fArr) Then
          
          If n = 1 Then
              If row_Itog1 < R1.Row Then
                row_Itog1 = R1.Row
              End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
                          
             r.Cells(Row, m - delta).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
             
          ElseIf n = 2 Then

             If row_Itog2 < r2.Row Then
               row_Itog2 = r2.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog2 = row_Itog2 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog2, k2).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog2, k2).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog2 = row_Itog2 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog2, k2).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog2, k2).Interior.ColorIndex = 38
                          
             r.Cells(Row, m - delta).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog2, k2).Address & ")"

          End If
        n = n + 1
        End If
    
    Else
          r.Cells(Row, m - delta).Formula = "=(" & rs(fArr1(i)) & ")"
    
    End If
    'n = n + 1
  End If
    
 Next i
  
 
   
  
  rs.MoveNext

Loop

End If


'----------------------------------------------------

'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
  sql = "select * from Result where Ord=3 "
  sql = sql & "order by " & sReplace(sGr2, ";", ",")
  Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
  
  If rs.RecordCount = 0 Then Exit Sub
  rs.MoveLast
  rs.MoveFirst
  
  Set R3 = Range("Itog3")
  nm = R3.Worksheet.name
  k3 = R3.Column
  row_Itog3 = 0
  
'-------------------------------------------------------
Set r = Range("DSItog2")
Do Until rs.EOF
 
   Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown

  Row = r.Rows.Count - 1
  row_Itog3 = row_Itog3 + 1
  j = r.Column - 1
  
 For i = 1 To r.Columns.Count
   j = j + 1
   If r.Columns(i).Hidden = False Then
       If r.Cells(Row, i).NumberFormat = "@" Or r.Cells(Row, i).NumberFormat = "General" Then
         r.Cells(Row, i) = IIf(IsNull(rs("col" & j)), "", rs("col" & j))
       End If
   End If
 Next i

 fArr1 = DelimitedLineToArray(sSum2, ";")
 n = 1
  
 For i = LBound(fArr1) To UBound(fArr1)
 fArr1(i) = UCase(fArr1(i))
 
 m = Val(sReplace(fArr1(i), "COL", "")) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
 p = r.Columns(1).Column '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 delta = p - 1
  lnFrm = Len(IIf(IsNull(Trim(rs(fArr1(i)))), "", Trim(rs(fArr1(i))))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
       fArr = CreateArrayFromStoka(Trim(rs(fArr1(i))), 500)
     
        If IsArray(fArr) Then
          
          If n = 1 Then
              If row_Itog3 < R3.Row Then
                row_Itog3 = R3.Row
              End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog3 = row_Itog3 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog3, k3).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog3, k3).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog3 = row_Itog3 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog3, k3).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog3, k3).Interior.ColorIndex = 38
                          
             r.Cells(Row, m - delta).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog3, k3).Address & ")"
             
          ElseIf n = 2 Then

             If row_Itog4 < R4.Row Then
               row_Itog4 = R4.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog4 = row_Itog4 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog4, k4).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog4, k4).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog4 = row_Itog4 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog4, k4).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog4, k4).Interior.ColorIndex = 38
                          
              r.Cells(Row, m - delta).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog4, k4).Address & ")"

          End If
        n = n + 1
        End If
    
    Else
          r.Cells(Row, m - delta).Formula = "=(" & rs(fArr1(i)) & ")"
    End If
  End If
    
 Next i
  
  rs.MoveNext

Loop


finnally:
On Error GoTo 0
On Error Resume Next
'ProtectXlt1
'ActiveSheet.OLEObjects("CmdRecalcItog").Object.Enabled = False
Set R1 = Nothing
Set r = Nothing
Set r2 = Nothing
Set R3 = Nothing
Set R4 = Nothing
'rs.Close
'db.Close
Set rs = Nothing
Set db = Nothing
Exit Sub
err169:
If err = 3204 Then
  Kill TempPath & "\SvTemp.mdb"
  Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp", dbLangCyrillic)
  err.Clear
  GoTo GoNext
Else
'  MsgBox Error(err)
'  Resume
  err.Clear
  GoTo finnally
End If

End Sub

Function GetCountRows125New(DArr) As Long
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|.
Dim db As Database
Dim r As Range
Dim sql As String
Dim i  As Long
Dim j  As Long
Dim sKod As String
Dim rs As Recordset
Dim Result  As Long
Dim TempPath As String

On Error GoTo c
TempPath = Environ("Temp")
Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp.mdb", dbLangCyrillic)
  
c:
If err = 3204 Then
  'Kill "c:\SvTemp.mdb"
  Kill TempPath & "\SvTemp.mdb"
  Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp.mdb", dbLangCyrillic)
  err.Clear
End If
j = 0

On Error GoTo 0
On Error GoTo err_count
'Set db = DBEngine.CreateDatabase("c:\SvTemp", dbLangCyrillic)


sql = "create table Result(cod text,Ord integer)"
db.Execute (sql)

'Set r = Range("Data_spr1")
If Not IsArray(DArr) Then
  Result = 0
  GoTo finally
End If

  For i = LBound(DArr) To UBound(DArr)
    sKod = Trim$(DArr(i, 1))  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    If left$(sKod, 2) = "ss" And (sKod Like "*[!a-z][a-z]") Then
      If sEmptyName(sKod) = 0 Then '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        sql = "insert into Result(cod,Ord) "
        sql = sql & "values('" & IIf(IsEmpty(DArr(i, 1)), "", DArr(i, 1)) & "',0 )"
        db.Execute (sql)
      End If
    End If
      
  Next i

sql = "Update Result Set cod = Mid(cod, 3)"
db.Execute (sql)

sql = "Update Result "
sql = sql & "Set cod = left(cod, Len(cod) - 1)"
db.Execute (sql)


sql = "INSERT INTO result ( cod, Ord ) "
sql = sql & "SELECT Result.cod, 1 "
sql = sql & "FROM Result "
sql = sql & "GROUP BY Result.cod"
db.Execute (sql)

sql = "delete * from result "
sql = sql & "where Ord=0"
db.Execute (sql)

sql = "select count(Ord) as cn "
sql = sql & "from Result"


Set rs = db.OpenRecordset(sql)
If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
  j = IIf(IsNull(rs!cn), 0, rs!cn)
End If

Result = j


finally:
On Error Resume Next
Set r = Nothing
Set rs = Nothing
Set db = Nothing
'rs.Close
'db.Close
GetCountRows125New = Result

Kill TempPath & "\SvTemp.mdb"
Exit Function

err_count:
'MsgBox Error(err)
' Resume
Result = 0

GoTo finally

End Function

'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| AddRow(|fffd||fffd| |fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|), fDeleteRow(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|), DataEndInsert(|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd|)
Public Sub itogi()
Dim s$
s = sGetINI("idForm", "?")
'If s = "169" Then F169Itogo
'----------------------------------------------31.10.2008
If s = "169" Then
  If HasName("Itog1") = False Then
    F169Itogo
  End If
End If
'----------------------------------------------31.10.2008
'----------------------------------------------27.12.2010
'If s = "169N" Then
'  If HasName("Itog1") = False Then
'    F169Itogo
'  End If
'End If
'----------------------------------------------27.12.2010

End Sub

'**************************               |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| Data_Account Data_PLS0 |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub F1251VDE(Optional svd$ = "")
    
    Dim r As Range, i As Long, a As Variant, j As Long, s$
    If Len(svd) = 0 And UserForm1.Visible = True Then
        UserForm1.Controls("ListBox1").BoundColumn = 1
        svd = UserForm1.Controls("ListBox1").Value
    End If
    If Len(svd) = 0 Then Exit Sub
    a = Array("Data_Account", "Data_Account1", "Data_PLS0", "Data_PLS01")
    Application.ScreenUpdating = False
    fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
    
    For j = LBound(a) To UBound(a)
        s = a(j)
        If EmptyName(s) > 1 Then
            Set r = Range(s)
            For i = 1 To r.Rows.Count
                If Len(Trim$(r.Cells(i, 1).Value)) > 0 Then r.Cells(i, 1).Value = svd & Mid(r.Cells(i, 1).Value, 2)
            Next i
        End If
    Next j
    fUnProtect False, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
    Application.ScreenUpdating = True
    Set r = Nothing
End Sub
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
Public Sub DataEndInsert125()
Dim s As String
    F1251VDE Range("Kod_VDE").Cells(1, 1)
    Application.ScreenUpdating = False
    fUnProtect True
    
    'F1251Itogo "FromForm"
        
'    Dim t1 As Date
'    Dim t2 As Date
'    t1 = Time
'    Debug.Print "start |fffd||fffd||fffd||fffd|"; t1
    
    If HasName("Total_Debet") = True Then
      
      s = sGetINI("flKod", "?")
      If s <> "?" Then '128|fffd|
        Call F1251_Itogo128
      Else
        Call F1251_newItogo
      End If
    
    Else
      fAddAccount
      F1251Itogo "FromForm"
    End If

'    t2 = Time
'    Debug.Print "finish |fffd||fffd||fffd||fffd|"; t2
'    'MsgBox "|fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & DateDiff("n", t2, t1) & " |fffd||fffd||fffd||fffd||fffd|(|fffd|)"
'    Debug.Print "|fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| "; DateDiff("n", t2, t1); " |fffd||fffd||fffd||fffd||fffd|(|fffd|)"
    
    Application.ScreenUpdating = True
    fUnProtect False
    HideDSBeforePrint
End Sub

Public Function fRasstF1251_new() As Long
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd| ,|fffd||fffd||fffd| |fffd| |fffd|-|fffd||fffd| fRasstF1251
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| data_sheet1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd|,|fffd| |fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)

Dim r As Range, i As Long, sKod$, sKod1$, n As Long ' - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| ss |fffd| |fffd|..
Dim vd$, Rds As Range, k As Long, iAK As Long

Dim sKodNew As String
Dim j  As Long
Dim db As Database
Dim sql As String
Dim rs As Recordset

If sEmptyName("Data_Spr1") < 2 Then fRasstF1251_new = 0: Exit Function  '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Application.Calculation = xlManual
Application.EnableEvents = False

Call fUnProtect(True)

Set r = Range("Data_Spr1")
Set Rds = Range("Data_Sheet1")
r.Sort Key1:=r.Cells(1, 1), Order1:=xlAscending
'N = Len(Trim$(R.Cells(1, 1))) - 3 '07.07.2008

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| Data_Sheet1
j = 0
'For i = 1 To r.Rows.Count
'sKod = Trim$(r.Cells(i, 1))   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'  If left$(sKod, 2) = "ss" And (sKod Like "*[!a-z][a-z]") Then
'    On Error Resume Next
'      If Not Range(sKod).HasFormula Then
'        If UCase(Right(sKod, 1)) = "A" Then
'          j = j + 1
'        End If
'      End If
'  End If
'Next i

'Dim t1 As Date
'Dim t2 As Date
't1 = Time
'Debug.Print "start |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"; t1

j = GetCountRows125

't2 = Time
'Debug.Print "finish |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"; t2
'MsgBox "|fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & DateDiff("n", t2, t1) & " |fffd||fffd||fffd||fffd||fffd|(|fffd|)"




If j = 0 Then GoTo finally

i = 0
i = Rds.Row + Rds.Rows.Count - 1
Rows(i & ":" & i + j - 1).Insert Shift:=xlDown

'For j = 1 To RDS.Rows.Count
'j = RDS.row + 1
j = 2

iAK = Val(sGetINI("OKATO", "11"))
For i = 1 To r.Rows.Count
    sKod = Trim$(r.Cells(i, 1))   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    sKodNew = sKod
    n = Len(Trim$(sKodNew)) - 3
   
    If sEmptyName(sKod) > 0 Then GoTo A1    '|fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    If left$(sKod, 2) <> "ss" And Not (sKod Like "*[!a-z][a-z]") Then GoTo A1
    sKod = Mid$(sKod, 3, n)
    If sKod <> sKod1 Then
        
        sKod1 = sKod
        addRowF1251_New sKod, Rds, iAK, " ", j
        j = j + 1
        '-----------------------------------------07.07.2008
        '''''F1251Itogo
        '-----------------------------------------07.07.2008
        'addNewRow RDS
        'fInsertKodstr RDS, sKod
        'fInsertNameStr "Data_Sheet1", sKod
    End If
A1:


If Not IsEmpty(r.Cells(i, 2)) Or Trim(r.Cells(i, 2)) <> "" Then
   If sEmptyName(sKodNew) > 0 Then
     On Error GoTo b
    If Range(sKodNew).HasFormula = False Then
      Range(sKodNew).Value = Trim(r.Cells(i, 2)) '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| Data_spr1
    End If
b:
      If err <> 0 Then
        err.Clear
      End If
    End If
 End If


Next i

finally:
Call fUnProtect(False)
fShowCmdInsDelRow True
On Error Resume Next
Set r = Nothing
Set Rds = Nothing
rs.Close
db.Close
Application.EnableEvents = True
Application.Calculation = xlAutomatic
fRasstF1251_new = -1

'Exit Function
'err1251:
'MsgBox Error
'Resume

End Function

Public Function GetCountRows125() As Long
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|.
Dim db As Database
Dim r As Range
Dim sql As String
Dim i  As Long
Dim j  As Long
Dim sKod As String
Dim rs As Recordset
Dim Result  As Long
Dim TempPath As String

On Error GoTo c
TempPath = Environ("Temp")
'Set db = DBEngine.CreateDatabase("c:\SvTemp", dbLangCyrillic)
Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp.mdb", dbLangCyrillic)
  
c:
If err = 3204 Then
  'Kill "c:\SvTemp.mdb"
  Kill TempPath & "\SvTemp.mdb"
  err.Clear
  Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp.mdb", dbLangCyrillic)
End If
j = 0
On Error GoTo 0
On Error GoTo err_count

sql = "create table Result(cod text,Ord integer)"
db.Execute (sql)

Set r = Range("Data_spr1")
If r.Rows.Count > 2 Then
  For i = 1 To r.Rows.Count
    sKod = Trim$(r.Cells(i, 1).Value)   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    If left$(sKod, 2) = "ss" And (sKod Like "*[!a-z][a-z]") Then
      If sEmptyName(sKod) = 0 Then '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        sql = "insert into Result(cod,Ord) "
        sql = sql & "values('" & IIf(IsEmpty(r.Cells(i, 1).Value), "", r.Cells(i, 1).Value) & "',0 )"
        db.Execute (sql)
      End If
    End If
      
  Next i
Else
  'Exit Function
  Result = 0
  GoTo finally
End If

 db.Close
 Set db = OpenDatabase(TempPath & "\SvTemp.mdb", False, False)
sql = "Update Result Set cod = Mid(cod, 3)"
db.Execute (sql)


sql = "Update Result "
sql = sql & "Set cod = left(cod, Len(cod) - 1)"
db.Execute (sql)


sql = "INSERT INTO result ( cod, Ord ) "
sql = sql & "SELECT Result.cod, 1 "
sql = sql & "FROM Result "
'sql = sql & "where IsNumeric(cod) "
sql = sql & "GROUP BY Result.cod"
db.Execute (sql)

sql = "delete * from result "
'sql = sql & "where IsNumeric(cod) and Ord=0"
sql = sql & "where Ord=0"
db.Execute (sql)

'sql = "Update Result "
'sql = sql & "Set cod = left(cod, Len(cod) - 1) "
'sql = sql & "where Ord=0 "
'db.Execute (sql)
'
'sql = "INSERT INTO result ( cod, Ord ) "
'sql = sql & "SELECT Result.cod, 1 "
'sql = sql & "FROM Result "
'sql = sql & "where IsNumeric(cod) and Ord=0 "
'sql = sql & "GROUP BY Result.cod"
'db.Execute (sql)

'sql = "delete * from result "
'sql = sql & "where Ord=0"
'db.Execute (sql)
'
'sql = "INSERT INTO result ( cod, Ord ) "
'sql = sql & "SELECT Result.cod, 2 "
'sql = sql & "FROM Result "
'sql = sql & "GROUP BY Result.cod"
'db.Execute (sql)
'
'sql = "delete * from result "
'sql = sql & "where Ord=1"
'db.Execute (sql)
'sql = ""
sql = "select count(Ord) as cn "
sql = sql & "from Result"


Set rs = db.OpenRecordset(sql)
If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
  j = IIf(IsNull(rs!cn), 0, rs!cn)
End If

Result = j


finally:
On Error Resume Next
Set r = Nothing
Set rs = Nothing
Set db = Nothing
'rs.Close
'db.Close
GetCountRows125 = Result

Kill TempPath & "\SvTemp.mdb"
Exit Function

err_count:
'MsgBox Error(err)
'Resume
Result = 0
GoTo finally

End Function

Public Sub addRowF1251_new_old(sKod$, r As Range, iAK As Long, Optional newNameOrg$, Optional rw As Long)
Dim Row  As Long, s$ ','sValue$
'Dim iAK%

Row = rw

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
's = Mid$(sKod, 1, 6)
'r.Cells(row, 1) = s
'If left$(s, 1) = "1" Then
'    r.Cells(row, 2) = NameinSpr(Right$(s, 5), "Data_Org")
''Else
''    If frmAddRow1.Visible And Len(newNameOrg) = 0 Then r.Cells(row, 2) = Data_ORG.Value Else r.Cells(row, 2) = newNameOrg
'End If

If r.Cells(1, 3) <> "X" Then r.Cells(Row, 3) = Mid$(sKod, 7, 3) Else r.Cells(Row, 3) = "X"
'|fffd||fffd||fffd||fffd||fffd|
'iAK = Val(sGetINI("OKATO", "11"))
If r.Cells(1, 4) <> "X" Then r.Cells(Row, 4) = Mid$(sKod, 10, iAK) Else r.Cells(Row, 4) = "X"
If r.Cells(1, 5) <> "X" Then r.Cells(Row, 5) = Mid$(sKod, 10 + iAK, 2) Else r.Cells(Row, 5) = "X"
r.Cells(Row, 6) = Mid$(sKod, 12 + iAK, 17) & left$(Range("Kod_Account").Cells(1, 1).Value, 6) & Mid$(sKod, 29 + iAK, 3)
If r.Cells(1, 9) <> "X" Then r.Cells(Row, 9) = Right$(sKod, 9) Else r.Cells(Row, 9) = "X"
'fInsertNameStr "Data_Sheet1", sKod
fInsertNameStr "Data_Sheet1", sKod, rw
'F1251Itogo
'fShowCmdInsDelRow True
'fExecProc , row, sKod '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'A1:
'UnProt False
'Set R = Nothing

End Sub

Sub addRowF1251_New(sKod$, r As Range, iAK As Long, Optional newNameOrg$, Optional rw As Long)
Dim Row  As Long, s$ ','sValue$
Dim arr() As Variant
Dim i  As Long

Row = rw
'ReDim arr(1)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
s = Mid$(sKod, 3, 6)

'r.Cells(row, 1) = s
i = -1
ReDim Preserve arr(i + 1)
i = i + 1
arr(i) = 1

'|fffd||fffd||fffd|
If r.Cells(1, 3) <> "X" Then
   r.Cells(Row, 3) = Mid$(sKod, 9, 3)
Else
  r.Cells(Row, 3) = "X"
  ReDim Preserve arr(i + 1)
  i = i + 1
  arr(i) = 3
End If

'|fffd||fffd||fffd||fffd||fffd|
iAK = Val(sGetINI("OKATO", "11"))
If r.Cells(1, 4) <> "X" Then
  'r.Cells(row, 4) = Mid$(sKod, 10, iAK)
  r.Cells(Row, 4) = Mid$(sKod, 12, iAK)
Else
  r.Cells(Row, 4) = "X"
  ReDim Preserve arr(i + 1)
  i = i + 1
  arr(i) = 4
End If
'|fffd||fffd|-|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If r.Cells(1, 5) <> "X" Then
   r.Cells(Row, 5) = Mid$(sKod, 12 + iAK, 2)
Else
  r.Cells(Row, 5) = "X"
  ReDim Preserve arr(i + 1)
  i = i + 1
  arr(i) = 5
End If

'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'r.Cells(row, 6) = Mid$(sKod, 7, 17) & left$(Range("Kod_Account").Cells(1, 1).Value, 6) & Mid$(sKod, 24, 3)
r.Cells(Row, 6) = Mid$(sKod, 9, 17) & left$(Range("Kod_Account").Cells(1, 1).Value, 6) & Mid$(sKod, 26, 3)
If r.Cells(1, 9) <> "X" Then
   r.Cells(Row, 9) = Right$(sKod, 9)
Else
  r.Cells(Row, 9) = "X"
  ReDim Preserve arr(i + 1)
  i = i + 1
  arr(i) = 9
End If

fInsertNameStr r.name.name, sKod, rw, , arr()

End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd|.|fffd|. |fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub fAddAccount()
Dim r As Range, i As Long, s$
Set r = Range("Data_Sheet1")
If r.Rows.Count < 3 Then Exit Sub
For i = 2 To r.Rows.Count - 1
    s = r.Cells(i, 6)
    r.Cells(i, 6) = left$(s, 17) & left(Range("Kod_Account").Cells(1, 1).Value, 6) & Right$(s, 3)
Next i
Set r = Nothing
End Sub

'****************************        |fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| ModRows.fDeleteRow |fffd| addRowF1251 |fffd||fffd||fffd||fffd||fffd| |fffd| DataEndInsert |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'Public Sub F1251ItogoOld()
'Dim R As Range, R1 As Range, i%, sKodAcc$, row0%, row%
'Dim sFormula$, RName$, s$, sKod$, sKodAccDt$, sAD$, sAdKt$, sAdDt$
'Dim sGr$, sGr1$, sGr2$, sGr3$, sAccCode$
'Dim fl125new As Boolean
''|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd|
'fl125new = HasName("dsF")
'If Not HasName("DSItog1") Then Exit Sub
'If Not HasName("DSItog2") Then Exit Sub
'If Not HasName("DSItog3") Then Exit Sub
'
'Set R = Range("Data_Sheet1")
'
'sKodAcc = Range("Kod_Account").Cells(1, 1)
'sGr1 = sGetINI("DSItog1.Group", "?")
'sGr2 = sGetINI("DSItog2.Group", "?")
'sGr3 = sGetINI("DSItog3.Group", "?")
'
'
'For i = 2 To R.Rows.Count - 1
''|fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd|
'row0 = R.row + i - 1 ' |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| Data_Sheet1
'If sGr1 = "?" Then GoTo A1
's = "= " & sReplace(sGr1, "R", "R" & Trim$(Str(row0)))
''|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'ActiveSheet.Cells(1, 10).Clear
'ActiveSheet.Cells(1, 10).Formula = s
'sKod = "ww" & ActiveSheet.Cells(1, 10).Value     ' sKod = "w" & R.Cells(i, 3) & R.Cells(i, 4) & sKodAcc
'    If HasName(sKod) = False Then
'        Set R1 = Range("DSItog1")
'        row = R1.row + R1.Rows.Count - 1    '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| DSItog1
'        Rows(row).Insert Shift:=xlDown
'        row = R1.Rows.Count - 1
'        If R1.Cells(1, 1) <> "X" Then R1.Cells(row, 1) = R.Cells(i, 3) Else R1.Cells(row, 1) = "X"
'        If R1.Cells(1, 2) <> "X" Then R1.Cells(row, 2) = R.Cells(i, 4) Else R1.Cells(row, 2) = "X"
'        If R1.Cells(1, 3) <> "X" Then R1.Cells(row, 3) = R.Cells(i, 5) Else R1.Cells(row, 3) = "X"
'        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'        sAccCode = fAccItogKode(sGr1, row0)
'        R1.Cells(row, 4) = IIf(Len(sAccCode) = 0, sKodAcc, sAccCode)
'        sAD = "='" & R.Worksheet.Name & "'!" & R1.Cells(row, 4).Address
'        ActiveWorkbook.Names.Add Name:=sKod, RefersTo:=sAD
'        sAdDt = R1.Cells(row, 8).Address
'        sAdKt = R1.Cells(row, 9).Address
'        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'        sFormula = sGetINI("DSItog1.Dt", "0")
'        If sFormula <> "0" Then R1.Cells(row, 5).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
'        sFormula = sGetINI("DSItog1.Kt", "0")
'        If sFormula <> "0" Then R1.Cells(row, 6).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
'        R1.Cells(row, 7) = "X"
'        If fl125new Then AddColumn125 sKod
'    End If
'If fl125new Then
'    InsFormula125 sKod, i, R.Cells(i, 7)
'Else
'    InsFormula Range(sKod).Cells(1, 1).Offset(0, 4), R.Cells(i, 7)
'    InsFormula Range(sKod).Cells(1, 1).Offset(0, 5), R.Cells(i, 8)
'End If
'A1:
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'If IfMoney(R.Cells(i, 9)) Then RName = "DSItog2" Else RName = "DSItog3"
'If RName = "DSItog2" Then If sGr2 = "?" Then GoTo A2 Else sGr = sGr2
'If RName = "DSItog3" Then If sGr3 = "?" Then GoTo A2 Else sGr = sGr3
'
's = "= " & sReplace(sGr, "R", "R" & Trim$(Str(row0)))
'ActiveSheet.Cells(1, 10).Clear
'ActiveSheet.Cells(1, 10).Formula = s
'sKod = "ww" & ActiveSheet.Cells(1, 10).Value 'sKod = sKod & R.Cells(i, 9)
'If HasName(sKod) = False Then
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|-|fffd||fffd|
'    If IfMoney(R.Cells(i, 9)) Then RName = "DSItog2" Else RName = "DSItog3"
'    Set R1 = Range(RName)
'    row = R1.row + R1.Rows.Count - 1
'    Rows(row).Insert Shift:=xlDown
'    row = R1.Rows.Count - 1
'        If R1.Cells(1, 1) <> "X" Then R1.Cells(row, 1) = R.Cells(i, 3) Else R1.Cells(row, 1) = "X"
'        If R1.Cells(1, 2) <> "X" Then R1.Cells(row, 2) = R.Cells(i, 4) Else R1.Cells(row, 2) = "X"
'        If R1.Cells(1, 3) <> "X" Then R1.Cells(row, 3) = R.Cells(i, 5) Else R1.Cells(row, 3) = "X"
'    sAccCode = fAccItogKode(sGr, row0)
'    R1.Cells(row, 4) = IIf(Len(sAccCode) = 0, sKodAcc, sAccCode)
'    R1.Cells(row, 7) = R.Cells(i, 9) '|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'    sAD = "='" & R.Worksheet.Name & "'!" & R1.Cells(row, 4).Address
'    ActiveWorkbook.Names.Add Name:=sKod, RefersTo:=sAD
'    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'    sAdDt = R1.Cells(row, 8).Address
'    sAdKt = R1.Cells(row, 9).Address
'    sFormula = sGetINI(RName & ".Dt", "0")
'    If sFormula <> "0" Then R1.Cells(row, 5).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
'    sFormula = sGetINI(RName & ".Kt", "0")
'    If sFormula <> "0" Then R1.Cells(row, 6).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
'    If fl125new Then AddColumn125 sKod
'End If
'If fl125new Then
'    InsFormula125 sKod, i, R.Cells(i, 7)
'Else
'    InsFormula Range(sKod).Cells(1, 1).Offset(0, 4), R.Cells(i, 7)
'    InsFormula Range(sKod).Cells(1, 1).Offset(0, 5), R.Cells(i, 8)
'End If
'A2:
'Next i
''R1.Cells(R1.row + 1, 1).Offset(0, -1) = "|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd|:"
'Set R1 = Nothing
'Set R = Nothing
'End Sub
'1 - |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 2 - |fffd||fffd||fffd||fffd||fffd||fffd|
Public Function InsFormula(r2 As Range, r As Range)
Dim sF$
sF = r2.Formula
If left$(sF, 1) = "=" Then
    If Not sF Like "*" & r.Address & "*" Then r2.Formula = sF & " + " & r.Address
Else
    r2.Formula = "=" & r.Address
End If
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub F1251deleteFormuls()
Dim r As Range, i As Long, a, j As Long, k As Long, s$
'Application.ScreenUpdating = False
'fUnProtect True
a = Array("DSItog1", "DSItog2", "DSItog3")
For j = LBound(a) To UBound(a)
s = a(j)
If HasName(s) = False Then GoTo A1
Set r = Range(s)
If r.Rows.Count < 3 Then GoTo A1
For i = r.Rows.Count - 1 To 2 Step -1
        k = r.Row + i - 1
        Rows(k).Delete Shift:=xlUp
'        R.Rows(i).Delete Shift:=xlUp
Next i
A1:
Next j
Set r = Nothing
'Application.ScreenUpdating = True
'fUnProtect False

End Sub

' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
Public Function IfMoney(sKod$) As Boolean
Dim s$, r As Range, i As Long
sKod = Trim$(Mid$(sKod, 2, 5))
Set r = Range("Data_PLS5")
For i = 1 To r.Rows.Count
    If r.Cells(i, 1) = sKod Then s = r.Cells(i, 3): GoTo A1
Next i
A1:
Set r = Nothing
IfMoney = IIf(s = "1", True, False)
End Function

Public Function fRepFormula(sFormula, sAccDt$, sAccKt$) As String
sFormula = "= " & sFormula
sFormula = sReplace(sFormula, "AccDt", sAccDt)
fRepFormula = sReplace(sFormula, "AccKt", sAccKt)
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Public Function fAccItogKode(sGr$, Row As Long) As String
Dim n As Long, sF$, j As Long
n = StrEl(sGr, 0, "&")
For j = 1 To n
    sF = StrEl(sGr, j, "&")
    If sF Like "*RC6*" Then GoTo A1
Next j
fAccItogKode = ""
Exit Function
A1:
sF = "= " & sReplace(sF, "R", "R" & Trim$(str(Row)))
ActiveSheet.Cells(1, 10).Clear
ActiveSheet.Cells(1, 10).Formula = sF
fAccItogKode = Cells(1, 10).Value
End Function

'Public Sub F169Itogo()
'Dim R As Range, i%, row0%, R1 As Range, R2 As Range, sKod$, row%, sAD$ ', sKodAcc$
'Dim n As Name, s$, row1%, row2%
'Dim fl As Boolean
'
'If Not HasName("DSItog1") Then Exit Sub
'If Not HasName("DSItog2") Then Exit Sub
'
'If Application.ScreenUpdating Then Application.ScreenUpdating = False
''fUnProtect True
'F1251deleteFormuls
'
'Set R = Range("Data_Sheet1")
'If R.Rows.Count < 3 Then Exit Sub
'row1 = R.row + 1
'row2 = row1 + R.Rows.Count - 3
'sAD = "='" & ActiveSheet.Name & "'!" & Range(Cells(row1, 1), Cells(row2, 7)).Address
'Set R = Range(sAD)
'R.Sort Key1:=R.Cells(1, 1), Key2:=R.Cells(1, 4), Order1:=xlAscending
'Set R2 = Range("DSItog2")
'Set R1 = Range("DSItog1")
'
'For i = 1 To R.Rows.Count
'    sKod = "ww" & R.Cells(i, 4).Value
'    fl = sKod = "ww" Or sKod = "wwX"
'    If Not fl Then
'        row = AddRowItog(sKod, R2)
'        If row > 0 Then R2.Cells(row, 2) = Mid$(sKod, 3)
'        InsFormula Range(sKod).Cells(1, 1), R.Cells(i, 3)
'    End If
'    sKod = "ww" & left$(fDelFormat(R.Cells(i, 1).Value), 6) & "000" & "0000"
'    '|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'    row = AddRowItog(sKod, R1)
'    If row > 0 Then
'        R1.Cells(row, 1) = Mid$(sKod, 3, 9)
'        R1.Cells(row, 4) = "0000"
'    End If
'    InsFormula Range(sKod).Cells(1, 1).Offset(0, 1), R.Cells(i, 2)
'    InsFormula Range(sKod).Cells(1, 1).Offset(0, 2), R.Cells(i, 3)
'    If Not fl Then
'        sKod = "ww" & left$(fDelFormat(R.Cells(i, 1).Value), 6) & "000" & R.Cells(i, 4).Value
'        row = AddRowItog(sKod, R1)
'        If row > 0 Then
'            R1.Cells(row, 1) = Mid$(sKod, 3, 9)
'            R1.Cells(row, 4) = Right$(sKod, 4)
'        End If
'        InsFormula Range(sKod).Cells(1, 1).Offset(0, 2), R.Cells(i, 3)
'    End If
'    'A1:
'Next i
'
'row1 = R2.row + 1
'row2 = row1 + R2.Rows.Count - 3
'sAD = "='" & ActiveSheet.Name & "'!" & Range(Cells(row1, 3), Cells(row2, 4)).Address
'Set R2 = Range(sAD)
'R2.Sort Key1:=R2.Cells(1, 2), Order1:=xlAscending
'
'row1 = R1.row + 1
'row2 = row1 + R1.Rows.Count - 3
'sAD = "='" & ActiveSheet.Name & "'!" & Range(Cells(row1, 1), Cells(row2, 4)).Address
'Set R1 = Range(sAD)
'R1.Sort Key1:=R1.Cells(1, 1), Key2:=R1.Cells(1, 4), Order1:=xlAscending
'For i = 1 To R1.Rows.Count
' If R1.Cells(i, 4) = "0000" Then R1.Cells(i, 4) = "" Else R1.Cells(i, 1) = ""
'Next
'Set R2 = Nothing
'Set R1 = Nothing
'Set R = Nothing
''fUnProtect False
'If Not Application.ScreenUpdating Then Application.ScreenUpdating = True
'End Sub



'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function AddColumn125(ByVal sKod0$) As String
Dim row1DS As Long, row2DS As Long, w As Worksheet, sAd$, Col As Long, sKod$
On Error Resume Next
Set w = Worksheets("|fffd||fffd||fffd||fffd|1")
row1DS = Range("Data_Sheet1").Row
row2DS = Range("Data_Sheet1").Row + Range("Data_Sheet1").Rows.Count - 1

Col = Range("dsF").Column + Range("dsF").Columns.Count - 1
Columns(Col).Insert Shift:=xlToRight
sAd = "='" & w.name & "'!" & Range(Cells(row1DS, Col), Cells(row2DS, Col)).Address
sKod = "f" & Mid$(sKod0, 3)
ActiveWorkbook.Names.Add name:=sKod & "Dt", RefersTo:=sAd

Col = Range("dsF").Column + Range("dsF").Columns.Count - 1
Columns(Col).Insert Shift:=xlToRight
sAd = "='" & w.name & "'!" & Range(Cells(row1DS, Col), Cells(row2DS, Col)).Address
ActiveWorkbook.Names.Add name:=sKod & "Kt", RefersTo:=sAd
Range(sKod0).Cells(1, 1).Offset(0, 4).Formula = "=SUM(" & sKod & "Dt)"
Range(sKod0).Cells(1, 1).Offset(0, 5).Formula = "=SUM(" & sKod & "Kt)"
Range("dsF").Columns.EntireColumn.Hidden = True
'Set W = Nothing
End Function
Public Sub F1251_newItogo()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 125|fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd||fffd||fffd|),|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|.
Dim r As Range, R1 As Range, i As Long, Row As Long
Dim rd As Range, RK As Range
Dim db As Database
Dim sql As String
Dim sql1 As String
Dim k, k1
Dim rs As Recordset
Dim fArr
Dim lnFrm  As Long
Dim j  As Long
Dim l  As Long
Dim row_Itog  As Long
Dim row_Itog1  As Long
Dim nm As String
Dim sGr$, sGr1$, sGr2$, sGr3$, sKodAcc$, sAccDt1$, sAccKt1$, sAccDt2$, sAccKt2$, sAccDt3$, sAccKt3$
Dim sn As String
Dim ColArr
Dim flGR  As Long
Dim fArr1()
Dim sqlJoin1 As String
Dim sqlJoin3 As String
Dim sqlJoin5 As String
Dim sqlInsert As String
Dim sqlInsert1 As String
Dim sqlInsert3 As String
Dim sqlInsert5 As String
Dim sqlSelect As String
Dim Nds As String
Dim TempPath As String
On Error GoTo err125

'UnProtectXlt1


If Not HasName("DSItog1") Then Exit Sub
If Not HasName("DSItog2") Then Exit Sub
If Not HasName("DSItog3") Then Exit Sub

sqlJoin1 = ""
sqlJoin3 = ""
sqlJoin5 = ""


sKodAcc = Range("Kod_Account").Cells(1, 1)
sGr1 = sGetINI("DSItog1.Group", "?")
sGr2 = sGetINI("DSItog2.Group", "?")
sGr3 = sGetINI("DSItog3.Group", "?")


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Set r = Range("DSItog1")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

Set r = Range("DSItog2")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

Set r = Range("DSItog3")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Set r = Range("Total_Debet")
'nm = R.Worksheet.Name
'i = R.Column
'ActiveWorkbook.Sheets(nm).Columns(i).ClearContents
'ActiveWorkbook.Sheets(nm).Columns(i).Interior.ColorIndex = xlNone
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone
Set r = Range("Total_Kredit")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

Set r = Range("TotaLItogD2")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone
Set r = Range("TotaLItogK2")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

Set r = Range("TotaLItogD3")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone
Set r = Range("TotaLItogK3")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

TempPath = Environ("Temp")
 Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp", dbLangCyrillic)
  
GoNext:
'Set db = DBEngine.CreateDatabase(ThisWorkbook.Path & "\SvTemp", dbLangCyrillic)

sql = "create table Result(col2 text,col3 text,col4 text,col5 text,col6 currency,col7 currency,col8 text,Ord integer,AccPls text,Adr_Dt memo,Adr_Kt memo)"
db.Execute (sql)

Nds = fGetNumberDataSheet("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|")
If Nds = "" Then
  Set r = Range("Data_Sheet1")
Else
  Set r = Range("Data_Sheet" & Nds)
End If


If r.Rows.Count > 2 Then
  For i = 2 To r.Rows.Count - 1
    sql = "insert into Result(col2,col3,col4,col5,col6,col7,col8,Ord,Adr_Dt,Adr_Kt) "
    sql = sql & "values('" & r.Cells(i, 3).Value & "','" & r.Cells(i, 4).Value & "','" & r.Cells(i, 5).Value & "','" & r.Cells(i, 6).Value & "','" & IIf(IsEmpty(r.Cells(i, 7).Value), 0, r.Cells(i, 7).Value) & "','" & IIf(IsEmpty(r.Cells(i, 8).Value), 0, r.Cells(i, 8).Value) & "','" & r.Cells(i, 9).Value & "',0,'" & r.Cells(i, 7).Address & "','" & r.Cells(i, 8).Address & "')"
    db.Execute (sql)
  Next i
Else
  Exit Sub
End If

'db.Close
'Set db = OpenDatabase("c:\SvTemp")

'|fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(Ord=1)
'sGr1="RC6"

sGr1 = GetSubStrItogo(sGr1, "-", "1", "&")
fArr = DelimitedLineToArray(sGr1, ";")
'sqlInsert = CreateInsertsql(fArr, sGr1, ";")
sqlInsert1 = CreateInsertsql(fArr, sGr1, ";")

fArr1 = DelimitedLineToArray(sqlInsert1, ",")
sqlJoin1 = CreateJoinsql(fArr, sqlInsert1)
sqlSelect = sReplace(sGr1, ";", ",")




 'sql = "INSERT INTO Result(col5,col6,col7,Ord) "
sql = "INSERT INTO Result(" & sqlInsert1 & ",col6,col7,Ord) "
'sql = sql & "SELECT col5, Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),1 "
sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),1 "
sql = sql & "FROM Result "
sql = sql & "where Ord=0 "
sql = sql & "GROUP BY " & sqlSelect
'sql = sql & "GROUP BY col5"
db.Execute (sql)

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|\Ord=3
'sGr2="RC6 & RC9"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sGr2 = UCase(sGr2)
sGr2 = GetSubStrItogo(sGr2, "-", "1", "&")

fArr = DelimitedLineToArray(sGr2, ";")
sqlInsert3 = CreateInsertsql(fArr, sGr2, ";")

fArr1 = DelimitedLineToArray(sqlInsert3, ",")
sqlJoin3 = CreateJoinsql(fArr, sqlInsert3)

sqlSelect = sReplace(sGr2, ";", ",")


'sql = "INSERT INTO Result(col5,col6,col7,col8,Ord) "
sql = "INSERT INTO Result(" & sqlInsert3 & ",col6,col7,Ord) "
'sql = sql & "SELECT col5, Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),col8,2 "
sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),2 "
sql = sql & "FROM Result "
sql = sql & "where Ord=0 "
sql = sql & "GROUP BY " & sqlSelect
'sql = sql & "GROUP BY col5,col8"
db.Execute (sql)

sql = "update Result set AccPls=mid(col8,2,5) where Ord=2"
db.Execute (sql)


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sql = "create table Data_PLS5(Cod text,CodName text,sgn integer)"
db.Execute (sql)

Set R1 = Range("Data_PLS5")

  If R1.Rows.Count > 2 Then
  For i = 1 To R1.Rows.Count - 1
    sql = "insert into Data_PLS5(Cod,CodName,sgn) "
    sql = sql & "values('" & R1.Cells(i, 1).Value & "','" & R1.Cells(i, 2).Value & "'," & IIf(IsNumeric(R1.Cells(i, 3).Value), R1.Cells(i, 3).Value, 0) & ")"
    db.Execute (sql)
  Next i
End If


sql = "update Result inner join Data_PLS5 on trim(Result.AccPls)=trim(Data_PLS5.Cod) "
sql = sql & "set Result.Ord=3 "
sql = sql & "where Ord=2 and Data_PLS5.sgn<>0"
db.Execute (sql)
 
sql = "delete * from Result where ord=2"
db.Execute (sql)

 
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'sGr3="RC6 & RC9"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sGr3 = UCase(sGr3)
sGr3 = GetSubStrItogo(sGr3, "-", "1", "&")

fArr = DelimitedLineToArray(sGr3, ";")
sqlInsert5 = CreateInsertsql(fArr, sGr3, ";")

fArr1 = DelimitedLineToArray(sqlInsert5, ",")
sqlJoin5 = CreateJoinsql(fArr, sqlInsert5)

sqlSelect = sReplace(sGr3, ";", ",")

'sql = "INSERT INTO Result(col5,col6,col7,col8,Ord) "
sql = "INSERT INTO Result(" & sqlInsert5 & ",col6,col7,Ord) "
'sql = sql & "SELECT col5, Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),col8,4 "
sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),4 "
sql = sql & "FROM Result "
sql = sql & "where Ord=0 "
sql = sql & "GROUP BY " & sqlSelect
'sql = sql & "GROUP BY col5,col8"
db.Execute (sql)


sql = "update Result set AccPls=mid(col8,2,5) where Ord=4"
db.Execute (sql)

sql = "update Result inner join Data_PLS5 on trim(Result.AccPls)=trim(Data_PLS5.Cod) "
sql = sql & "set Result.Ord=5 "
sql = sql & "where Ord=4 and Data_PLS5.sgn=0"
db.Execute (sql)
 
sql = "delete * from Result where ord=4"
db.Execute (sql)


'Ord=0-|fffd||fffd||fffd||fffd||fffd||fffd|
'Ord=1-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'Ord=3-|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'Ord=5-|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sAccDt1 = sGetINI("DSItog1.Dt", "?")
sAccKt1 = sGetINI("DSItog1.Kt", "?")
sAccDt2 = sGetINI("DSItog2.Dt", "?")
sAccKt2 = sGetINI("DSItog2.Kt", "?")
sAccDt3 = sGetINI("DSItog3.Dt", "?")
sAccKt3 = sGetINI("DSItog3.Kt", "?")
 
sAccDt1 = sReplace(sAccDt1, " ", "")
sAccKt1 = sReplace(sAccKt1, " ", "")

sAccDt2 = sReplace(sAccDt2, " ", "")
sAccKt2 = sReplace(sAccKt2, " ", "")

sAccDt3 = sReplace(sAccDt3, " ", "")
sAccKt3 = sReplace(sAccKt3, " ", "")



  'DsItog1
  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd|.|fffd|1251_6)
  If sAccDt1 <> "?" And sAccKt1 <> "?" Then
     flGR = 0
  ElseIf sAccDt1 <> "?" And sAccKt1 = "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1254_6)
    flGR = 1
    sn = Mid(sAccDt1, 6, 1)
  ElseIf sAccDt1 = "?" And sAccKt1 <> "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1256_6)
    flGR = 2
    sn = Mid(sAccKt1, 6, 1)
  End If
Call CreateFormula_Ostatok(db, flGR, sqlJoin1, 1, sn)

'DsItog2
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sAccDt2 <> "?" And sAccKt2 <> "?" Then
   flGR = 0
ElseIf sAccDt2 <> "?" And sAccKt2 = "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1254_6)
  flGR = 1
  sn = Mid(sAccDt2, 6, 1)
ElseIf sAccDt2 = "?" And sAccKt2 <> "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1256_6)
  flGR = 2
  sn = Mid(sAccKt2, 6, 1)
End If
Call CreateFormula_Ostatok(db, flGR, sqlJoin3, 3, sn)


'DsItog3
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|

If sAccDt3 <> "?" And sAccKt3 <> "?" Then
   flGR = 0
ElseIf sAccDt3 <> "?" And sAccKt3 = "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1254_6)
  flGR = 1
  sn = Mid(sAccDt3, 6, 1)
ElseIf sAccDt3 = "?" And sAccKt3 <> "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1256_6)
  flGR = 2
  sn = Mid(sAccKt3, 6, 1)
End If
Call CreateFormula_Ostatok(db, flGR, sqlJoin5, 5, sn)

  sql = "update Result set Adr_Dt=mid(Adr_Dt,2),Adr_Kt=mid(Adr_Kt,2) "
  sql = sql & "where Ord<>0"
  db.Execute (sql)
  
  db.Execute ("update Result set col6=null,col7=null where Ord<>0")
  
  
  sql = "select * from Result where Ord=1 "
  Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
  If rs.RecordCount = 0 Then Exit Sub
  rs.MoveLast
  rs.MoveFirst
  
  Set rd = Range("Total_Debet")
  nm = rd.Worksheet.name
  k = rd.Column
  row_Itog = 0
  Set RK = Range("Total_Kredit")
  k1 = RK.Column
  row_Itog1 = 0

'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Set r = Range("DSItog1")
Do Until rs.EOF
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown
  Row = r.Rows.Count - 1
  row_Itog = row_Itog + 1
  row_Itog1 = row_Itog1 + 1
  
'  sql = sqlInsert1
'  sql = sReplace(sql, "col", "")
'  fArr = DelimitedLineToArray(sql, ",")
'  sql = ""
'  For i = LBound(fArr) To UBound(fArr)
'
'  Next i

'  r.Cells(row, 1) = "X"
'  r.Cells(row, 2) = "X"
'  r.Cells(row, 3) = "X"
  
  r.Cells(Row, 1) = IIf(IsNull(rs("col2")), "X", rs("col2"))
  r.Cells(Row, 2) = IIf(IsNull(rs("col3")), "X", rs("col3"))
  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), "X", rs("col4"))
  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), "X", rs("col5"))
  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), 0, rs("col6"))
  r.Cells(Row, 6) = IIf(IsNull(rs("col7")), 0, rs("col7"))
  'r.Cells(row, 7) = "X"
  r.Cells(Row, 7) = IIf(IsNull(rs("col8")), "X", rs("col8"))
  
  
  lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Dt"))), "", Trim(rs("Adr_Dt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
       fArr = Empty
       fArr = CreateArrayFromStoka(Trim(rs("Adr_Dt")), 500)
      
        If IsArray(fArr) Then
           
             If row_Itog < rd.Row Then
               row_Itog = rd.Row
             End If
          '    Rn.Rows(Rn.Rows.Count & ":" & UBound(fArr) + 2).Insert shift:=xlDown
             sql = "=("
             For j = 0 To UBound(fArr)
              If Trim(fArr(j)) <> "" Then
                row_Itog = row_Itog + 1
                ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = "=(" & fArr(j) & ")"
                sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & "+"
              End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog = row_Itog + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Interior.ColorIndex = 38
             
             'sAD = "='" & R.Worksheet.Name & "'!" & R1.Cells(row, 4).Address
             'ActiveWorkbook.Names.Add Name:="End", RefersTo:=sAD
             
             r.Cells(Row, 5).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
        End If
    
    Else
      r.Cells(Row, 5).Formula = "=(" & rs("Adr_Dt") & ")"
    End If
  End If
    
  
  
 lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Kt"))), "", Trim(rs("Adr_Kt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Kt")), 500)
      
        If IsArray(fArr) Then
    
             
             If row_Itog1 < RK.Row Then
               row_Itog1 = RK.Row
             End If

             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
             
             r.Cells(Row, 6).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
        End If
    
    Else
      r.Cells(Row, 6).Formula = "=(" & rs("Adr_Kt") & ")"
    End If
  End If
   
  
  rs.MoveNext

Loop


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sql = "select * from Result where Ord=3 "

Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
  
  Set rd = Range("TotaLItogD2")
  nm = rd.Worksheet.name
  k = rd.Column
  row_Itog = 0
  Set RK = Range("TotaLItogK2")
  k1 = RK.Column
  row_Itog1 = 0

  
  Set r = Range("DSItog2")
  Do Until rs.EOF
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown
  Row = r.Rows.Count - 1
  row_Itog = row_Itog + 1
  row_Itog1 = row_Itog1 + 1
     
  r.Cells(Row, 1) = IIf(IsNull(rs("col2")), "X", rs("col2"))
  r.Cells(Row, 2) = IIf(IsNull(rs("col3")), "X", rs("col3"))
  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), "X", rs("col4"))
  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), "X", rs("col5"))
  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), 0, rs("col6"))
  r.Cells(Row, 6) = IIf(IsNull(rs("col7")), 0, rs("col7"))
  r.Cells(Row, 7) = IIf(IsNull(rs("col8")), "X", rs("col8"))
  
  
  
  
  lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Dt"))), "", Trim(rs("Adr_Dt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Dt")), 500)
      
        If IsArray(fArr) Then
           
             If row_Itog < rd.Row Then
               row_Itog = rd.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog = row_Itog + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog = row_Itog + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Interior.ColorIndex = 38
             
             r.Cells(Row, 5).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
        End If
    
    Else
      r.Cells(Row, 5).Formula = "=(" & rs("Adr_Dt") & ")"
    End If
  End If


lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Kt"))), "", Trim(rs("Adr_Kt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Kt")), 500)
      
        If IsArray(fArr) Then
    
             
             If row_Itog1 < RK.Row Then
               row_Itog1 = RK.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
             
             r.Cells(Row, 6).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
        End If
    
    Else
      r.Cells(Row, 6).Formula = "=(" & rs("Adr_Kt") & ")"
    End If
  End If

      rs.MoveNext
    Loop
End If


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sql = "select * from Result where Ord=5 "
Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
  
  Set rd = Range("TotaLItogD3")
  nm = rd.Worksheet.name
  k = rd.Column
  row_Itog = 0
  Set RK = Range("TotaLItogK3")
  k1 = RK.Column
  row_Itog1 = 0
  
  Set r = Range("DSItog3")
  Do Until rs.EOF
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown
  Row = r.Rows.Count - 1
  row_Itog = row_Itog + 1
  row_Itog1 = row_Itog1 + 1
  r.Cells(Row, 1) = IIf(IsNull(rs("col2")), "X", rs("col2"))
  r.Cells(Row, 2) = IIf(IsNull(rs("col3")), "X", rs("col3"))
  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), "X", rs("col4"))
  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), "X", rs("col5"))
  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), 0, rs("col6"))
  r.Cells(Row, 6) = IIf(IsNull(rs("col7")), 0, rs("col7"))
  r.Cells(Row, 7) = IIf(IsNull(rs("col8")), "X", rs("col8"))
  
  lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Dt"))), "", Trim(rs("Adr_Dt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Dt")), 500)
      
        If IsArray(fArr) Then
           
             If row_Itog < rd.Row Then
               row_Itog = rd.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog = row_Itog + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog = row_Itog + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Interior.ColorIndex = 38
             
             r.Cells(Row, 5).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
        End If
    
    Else
      r.Cells(Row, 5).Formula = "=(" & rs("Adr_Dt") & ")"
    End If
  End If

lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Kt"))), "", Trim(rs("Adr_Kt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Kt")), 500)
      
        If IsArray(fArr) Then
    
             
             If row_Itog1 < RK.Row Then
               row_Itog1 = RK.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
             
             r.Cells(Row, 6).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
        End If
    
    Else
      r.Cells(Row, 6).Formula = "=(" & rs("Adr_Kt") & ")"
    End If
  End If

      rs.MoveNext
    Loop
End If

'db.Close


finnally:
On Error GoTo 0
On Error Resume Next
'ProtectXlt1
'ActiveSheet.OLEObjects("CmdRecalcItog").Object.Enabled = False
Set R1 = Nothing
Set r = Nothing
Set rd = Nothing
Set RK = Nothing
rs.Close
db.Close
Set rs = Nothing
Set db = Nothing
Kill TempPath & "\SvTemp.mdb"
Exit Sub
err125:
If err = 3204 Then
  'Kill "c:\SvTemp.mdb"
  Kill TempPath & "\SvTemp.mdb"
  Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp", dbLangCyrillic)
  err.Clear
  GoTo GoNext
Else
  'MsgBox Error(err)
  'Resume
  err.Clear
  GoTo finnally
End If


End Sub

Public Sub F1251_Itogo128()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 125|fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd||fffd||fffd|),|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|.
Dim r As Range, R1 As Range, i As Long, Row As Long
Dim rd As Range, RK As Range
Dim db As Database
Dim sql As String
Dim sql1 As String
Dim k, k1
Dim rs As Recordset
Dim fArr
Dim lnFrm  As Long
Dim j  As Long
Dim l  As Long
Dim row_Itog  As Long
Dim row_Itog1  As Long
Dim nm As String
Dim sGr$, sGr1$, sGr2$, sGr3$, sKodAcc$, sAccDt1$, sAccKt1$, sAccDt2$, sAccKt2$, sAccDt3$, sAccKt3$
Dim sn As String
Dim ColArr
Dim flGR  As Long
Dim fArr1()
Dim sqlJoin1 As String
Dim sqlJoin2 As String
Dim sqlJoin3 As String
Dim sqlJoin4 As String
Dim sqlJoin5 As String
Dim sqlJoin6 As String
Dim sqlJoin7 As String
Dim sqlJoin8 As String
Dim sqlJoin9 As String
Dim sqlInsert As String
Dim sqlInsert1 As String
Dim sqlInsert2 As String
Dim sqlInsert3 As String
Dim sqlInsert4 As String
Dim sqlInsert5 As String
Dim sqlInsert6 As String
Dim sqlInsert7 As String
Dim sqlInsert8 As String
Dim sqlInsert9 As String
Dim sqlSelect As String
Dim Nds As String
Dim sGr11 As String, sGr12 As String, sGr13 As String
Dim sGr21 As String, sGr22 As String, sGr23 As String
Dim sGr31 As String, sGr32 As String, sGr33 As String
Dim TempPath As String
On Error GoTo err125

'UnProtectXlt1


If Not HasName("DSItog1") Then Exit Sub
If Not HasName("DSItog2") Then Exit Sub
If Not HasName("DSItog3") Then Exit Sub

sqlJoin1 = ""
sqlJoin2 = ""
sqlJoin3 = ""
sqlJoin4 = ""
sqlJoin5 = ""
sqlJoin6 = ""
sqlJoin7 = ""
sqlJoin8 = ""
sqlJoin9 = ""


sKodAcc = Range("Kod_Account").Cells(1, 1)
sGr11 = sGetINI("DSItog11.Group", "?")
sGr12 = sGetINI("DSItog12.Group", "?")
sGr13 = sGetINI("DSItog13.Group", "?")

sGr21 = sGetINI("DSItog21.Group", "?")
sGr22 = sGetINI("DSItog22.Group", "?")
sGr23 = sGetINI("DSItog23.Group", "?")

sGr31 = sGetINI("DSItog31.Group", "?")
sGr32 = sGetINI("DSItog32.Group", "?")
sGr33 = sGetINI("DSItog33.Group", "?")


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Set r = Range("DSItog1")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

Set r = Range("DSItog2")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

Set r = Range("DSItog3")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Set r = Range("Total_Debet")
'nm = R.Worksheet.Name
'i = R.Column
'ActiveWorkbook.Sheets(nm).Columns(i).ClearContents
'ActiveWorkbook.Sheets(nm).Columns(i).Interior.ColorIndex = xlNone
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone
Set r = Range("Total_Kredit")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

Set r = Range("TotaLItogD2")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone
Set r = Range("TotaLItogK2")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

Set r = Range("TotaLItogD3")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone
Set r = Range("TotaLItogK3")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

TempPath = Environ("Temp")
'Set db = DBEngine.CreateDatabase(ThisWorkbook.Path & "\SvTemp", dbLangCyrillic)
Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp", dbLangCyrillic)
  
GoNext:
'Set db = DBEngine.CreateDatabase(ThisWorkbook.Path & "\SvTemp", dbLangCyrillic)

sql = "create table Result(col2 text,col3 text,col4 text,col5 text,col6 currency,col7 currency,col8 text,Ord integer,AccPls text,Adr_Dt memo,Adr_Kt memo,KodSpr text)"
db.Execute (sql)

Nds = fGetNumberDataSheet("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|")
If Nds = "" Then
  Set r = Range("Data_Sheet01")
Else
  Set r = Range("Data_Sheet" & Nds)
End If


 If r.Rows.Count > 2 Then
  For i = 2 To r.Rows.Count - 1
    sql = "insert into Result(col2,col3,col4,col5,col6,col7,col8,Ord,Adr_Dt,Adr_Kt,KodSpr) "
    sql = sql & "values('" & r.Cells(i, 3).Value & "','" & r.Cells(i, 4).Value & "','" & r.Cells(i, 5).Value & "','" & r.Cells(i, 6).Value & "','" & IIf(IsEmpty(r.Cells(i, 7).Value), 0, r.Cells(i, 7).Value) & "','" & IIf(IsEmpty(r.Cells(i, 8).Value), 0, r.Cells(i, 8).Value) & "','" & r.Cells(i, 9).Value & "',0,'" & r.Cells(i, 7).Address & "','" & r.Cells(i, 8).Address & "','" & r.Cells(i, 7).name.name & "')"
    db.Execute (sql)
  Next i
Else
  Exit Sub
End If

db.Close
Set db = OpenDatabase(TempPath & "\SvTemp")
sql = "update Result set KodSpr =mid(KodSpr,5,1)"
db.Execute (sql)


'|fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(Ord=1)|fffd||fffd||fffd||fffd||fffd||fffd|
'sGr1="RC6"

If sGr11 <> "?" Then
  sGr11 = GetSubStrItogo(sGr11, "-", "1", "&")
  fArr = DelimitedLineToArray(sGr11, ";")
  sqlInsert1 = CreateInsertsql(fArr, sGr11, ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert1, ",")
  'sqlJoin1 = CreateJoinsql(fArr, sqlInsert1)
  sqlJoin1 = CreateJoinsql128(fArr, sqlInsert1)
  sqlSelect = sReplace(sGr11, ";", ",")
  
   'sql = "INSERT INTO Result(col5,col6,col7,Ord) "
  sql = "INSERT INTO Result(" & sqlInsert1 & ",col6,col7,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),1,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='1' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  'sql = sql & "GROUP BY col5"
  db.Execute (sql)
End If

'|fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(Ord=2)|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'sGr2="RC6 & RC9"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sGr12 <> "?" Then
  sGr12 = UCase(sGr12)
  sGr12 = GetSubStrItogo(sGr12, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr12, ";")
  'sqlInsert2 = CreateInsertsql(fArr, sGr12, ";")
  sqlInsert2 = CreateInsertsql128(fArr, "", ";")
  fArr1 = DelimitedLineToArray(sqlInsert2, ",")
  sqlJoin2 = CreateJoinsql128(fArr, "")
  
  sqlSelect = sReplace(sGr12, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert2 & ",col6,col7,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),2,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='2' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If
'|fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(Ord=3)|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'sGr2="RC6 & RC9"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sGr13 <> "?" Then
  sGr13 = UCase(sGr13)
  sGr13 = GetSubStrItogo(sGr13, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr13, ";")
  sqlInsert3 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert3, ",")
  sqlJoin3 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr13, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert3 & ",col6,col7,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),3,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='3' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If


 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd|
If sGr21 <> "?" Then
  sGr21 = UCase(sGr21)
  sGr21 = GetSubStrItogo(sGr21, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr21, ";")
  sqlInsert4 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert4, ",")
  sqlJoin4 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr21, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert4 & ",col6,col7,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),4,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='1' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd||fffd|
If sGr22 <> "?" Then
  sGr22 = UCase(sGr22)
  sGr22 = GetSubStrItogo(sGr22, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr22, ";")
  sqlInsert5 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert5, ",")
  sqlJoin5 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr22, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert5 & ",col6,col7,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),5,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='2' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If sGr23 <> "?" Then
  sGr23 = UCase(sGr23)
  sGr23 = GetSubStrItogo(sGr23, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr23, ";")
  sqlInsert6 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert6, ",")
  sqlJoin6 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr23, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert6 & ",col6,col7,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),6,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='3' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
  sql = ""
End If

'----------------------------------------
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd|
If sGr31 <> "?" Then
  sGr31 = UCase(sGr31)
  sGr31 = GetSubStrItogo(sGr31, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr31, ";")
  sqlInsert7 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert7, ",")
  sqlJoin7 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr31, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert7 & ",col6,col7,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),7,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='1' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd||fffd|
If sGr32 <> "?" Then
  sGr32 = UCase(sGr32)
  sGr32 = GetSubStrItogo(sGr32, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr32, ";")
  sqlInsert8 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert8, ",")
  sqlJoin8 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr32, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert8 & ",col6,col7,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),8,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='2' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If sGr33 <> "?" Then
  sGr33 = UCase(sGr33)
  sGr33 = GetSubStrItogo(sGr33, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr33, ";")
  sqlInsert9 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert9, ",")
  sqlJoin9 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr33, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert9 & ",col6,col7,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col6),0,col6)),Sum(iif(isnull(col7),0,col7)),9,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='3' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

sql = "update Result set AccPls=mid(col8,2,5) where Ord in(4,5,6,7,8,9)"
db.Execute (sql)


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sql = "create table Data_PLS5(Cod text,CodName text,sgn integer)"
db.Execute (sql)

Set R1 = Range("Data_PLS5")

  If R1.Rows.Count > 2 Then
  For i = 1 To R1.Rows.Count - 1
    sql = "insert into Data_PLS5(Cod,CodName,sgn) "
    sql = sql & "values('" & R1.Cells(i, 1).Value & "','" & R1.Cells(i, 2).Value & "'," & IIf(IsNumeric(R1.Cells(i, 3).Value), R1.Cells(i, 3).Value, 0) & ")"
    db.Execute (sql)
  Next i
End If

sql = "update Result "
sql = sql & "set Adr_Dt='0' "
sql = sql & "where Ord in(4,5,6,7,8,9)"
db.Execute (sql)
 
 
sql = "update Result inner join Data_PLS5 on trim(Result.AccPls)=trim(Data_PLS5.Cod) "
sql = sql & "set Adr_Dt='1' "
sql = sql & "where Ord in(4,5,6,7,8,9) and Data_PLS5.sgn<>0"
db.Execute (sql)

sql = "delete * from Result where ord in(4,5,6) and trim(Adr_Dt)='0'"
db.Execute (sql)

sql = "delete * from Result where ord in(7,8,9) and trim(Adr_Dt)='1'"
db.Execute (sql)
sql = ""
 

'Ord=0-|fffd||fffd||fffd||fffd||fffd||fffd|
'Ord=1,2,3-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd|,|fffd||fffd||fffd||fffd|,|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
'Ord=4,5,6-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd|,|fffd||fffd||fffd||fffd|,|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
'Ord=7,8,9-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd|,|fffd||fffd||fffd||fffd|,|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
sAccDt1 = sGetINI("DSItog1.Dt", "?")
sAccKt1 = sGetINI("DSItog1.Kt", "?")
sAccDt2 = sGetINI("DSItog2.Dt", "?")
sAccKt2 = sGetINI("DSItog2.Kt", "?")
sAccDt3 = sGetINI("DSItog3.Dt", "?")
sAccKt3 = sGetINI("DSItog3.Kt", "?")
 
sAccDt1 = sReplace(sAccDt1, " ", "")
sAccKt1 = sReplace(sAccKt1, " ", "")

sAccDt2 = sReplace(sAccDt2, " ", "")
sAccKt2 = sReplace(sAccKt2, " ", "")

sAccDt3 = sReplace(sAccDt3, " ", "")
sAccKt3 = sReplace(sAccKt3, " ", "")



  'DsItog1
  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd|.|fffd|1251_6)
  If sAccDt1 <> "?" And sAccKt1 <> "?" Then
     flGR = 0
  ElseIf sAccDt1 <> "?" And sAccKt1 = "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1254_6)
    flGR = 1
    sn = Mid(sAccDt1, 6, 1)
  ElseIf sAccDt1 = "?" And sAccKt1 <> "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1256_6)
    flGR = 2
    sn = Mid(sAccKt1, 6, 1)
  End If
Call CreateFormula_Ostatok(db, flGR, sqlJoin1, 1, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin2, 2, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin3, 3, sn)


'Call CreateFormula_Ostatok128(db, flgr, sqlJoin1, 1, sn)

'DsItog2
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sAccDt2 <> "?" And sAccKt2 <> "?" Then
   flGR = 0
ElseIf sAccDt2 <> "?" And sAccKt2 = "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1254_6)
  flGR = 1
  sn = Mid(sAccDt2, 6, 1)
ElseIf sAccDt2 = "?" And sAccKt2 <> "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1256_6)
  flGR = 2
  sn = Mid(sAccKt2, 6, 1)
End If
Call CreateFormula_Ostatok(db, flGR, sqlJoin4, 4, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin5, 5, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin6, 6, sn)


'DsItog3
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|

If sAccDt3 <> "?" And sAccKt3 <> "?" Then
   flGR = 0
ElseIf sAccDt3 <> "?" And sAccKt3 = "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1254_6)
  flGR = 1
  sn = Mid(sAccDt3, 6, 1)
ElseIf sAccDt3 = "?" And sAccKt3 <> "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1256_6)
  flGR = 2
  sn = Mid(sAccKt3, 6, 1)
End If
Call CreateFormula_Ostatok(db, flGR, sqlJoin7, 7, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin8, 8, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin9, 9, sn)

  sql = "update Result set Adr_Dt=mid(Adr_Dt,2),Adr_Kt=mid(Adr_Kt,2) "
  sql = sql & "where Ord<>0"
  db.Execute (sql)
  
  db.Execute ("update Result set col6=null,col7=null where Ord<>0")
  
  
  sql = "select * from Result where Ord in(1,2,3) order by KodSpr,ord "
  Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
  If rs.RecordCount = 0 Then Exit Sub
  rs.MoveLast
  rs.MoveFirst
  
  Set rd = Range("Total_Debet")
  nm = rd.Worksheet.name
  k = rd.Column
  row_Itog = 0
  Set RK = Range("Total_Kredit")
  k1 = RK.Column
  row_Itog1 = 0

'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Set r = Range("DSItog1")
Do Until rs.EOF
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown
  Row = r.Rows.Count - 1
  row_Itog = row_Itog + 1
  row_Itog1 = row_Itog1 + 1
  
'  sql = sqlInsert1
'  sql = sReplace(sql, "col", "")
'  fArr = DelimitedLineToArray(sql, ",")
'  sql = ""
'  For i = LBound(fArr) To UBound(fArr)
'
'  Next i

'  r.Cells(row, 1) = "X"
'  r.Cells(row, 2) = "X"
'  r.Cells(row, 3) = "X"
  
  r.Cells(Row, 1) = IIf(IsNull(rs("col2")), "X", rs("col2"))
  r.Cells(Row, 2) = IIf(IsNull(rs("col3")), "X", rs("col3"))
  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), "X", rs("col4"))
  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), "X", rs("col5"))
  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), 0, rs("col6"))
  r.Cells(Row, 6) = IIf(IsNull(rs("col7")), 0, rs("col7"))
  'r.Cells(row, 7) = "X"
  r.Cells(Row, 7) = IIf(IsNull(rs("col8")), "X", rs("col8"))
  
  
  lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Dt"))), "", Trim(rs("Adr_Dt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
       fArr = Empty
       fArr = CreateArrayFromStoka(Trim(rs("Adr_Dt")), 500)
      
        If IsArray(fArr) Then
           
             If row_Itog < rd.Row Then
               row_Itog = rd.Row
             End If
          '    Rn.Rows(Rn.Rows.Count & ":" & UBound(fArr) + 2).Insert shift:=xlDown
             sql = "=("
             For j = 0 To UBound(fArr)
              If Trim(fArr(j)) <> "" Then
                row_Itog = row_Itog + 1
                ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = "=(" & fArr(j) & ")"
                sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & "+"
              End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog = row_Itog + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Interior.ColorIndex = 38
             
             'sAD = "='" & R.Worksheet.Name & "'!" & R1.Cells(row, 4).Address
             'ActiveWorkbook.Names.Add Name:="End", RefersTo:=sAD
             
             r.Cells(Row, 5).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
        End If
    
    Else
      r.Cells(Row, 5).Formula = "=(" & rs("Adr_Dt") & ")"
    End If
  End If
    
  
  
 lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Kt"))), "", Trim(rs("Adr_Kt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Kt")), 500)
      
        If IsArray(fArr) Then
    
             
             If row_Itog1 < RK.Row Then
               row_Itog1 = RK.Row
             End If

             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
             
             r.Cells(Row, 6).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
        End If
    
    Else
      r.Cells(Row, 6).Formula = "=(" & rs("Adr_Kt") & ")"
    End If
  End If
   
  
  rs.MoveNext

Loop


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sql = "select * from Result where Ord in(4,5,6) order by KodSpr,Ord "

Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
  
  Set rd = Range("TotaLItogD2")
  nm = rd.Worksheet.name
  k = rd.Column
  row_Itog = 0
  Set RK = Range("TotaLItogK2")
  k1 = RK.Column
  row_Itog1 = 0

  
  Set r = Range("DSItog2")
  Do Until rs.EOF
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown
  Row = r.Rows.Count - 1
  row_Itog = row_Itog + 1
  row_Itog1 = row_Itog1 + 1
     
  r.Cells(Row, 1) = IIf(IsNull(rs("col2")), "X", rs("col2"))
  r.Cells(Row, 2) = IIf(IsNull(rs("col3")), "X", rs("col3"))
  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), "X", rs("col4"))
  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), "X", rs("col5"))
  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), 0, rs("col6"))
  r.Cells(Row, 6) = IIf(IsNull(rs("col7")), 0, rs("col7"))
  r.Cells(Row, 7) = IIf(IsNull(rs("col8")), "X", rs("col8"))
  
  
  
  
  lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Dt"))), "", Trim(rs("Adr_Dt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Dt")), 500)
      
        If IsArray(fArr) Then
           
             If row_Itog < rd.Row Then
               row_Itog = rd.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog = row_Itog + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog = row_Itog + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Interior.ColorIndex = 38
             
             r.Cells(Row, 5).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
        End If
    
    Else
      r.Cells(Row, 5).Formula = "=(" & rs("Adr_Dt") & ")"
    End If
  End If


lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Kt"))), "", Trim(rs("Adr_Kt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Kt")), 500)
      
        If IsArray(fArr) Then
    
             
             If row_Itog1 < RK.Row Then
               row_Itog1 = RK.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
             
             r.Cells(Row, 6).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
        End If
    
    Else
      r.Cells(Row, 6).Formula = "=(" & rs("Adr_Kt") & ")"
    End If
  End If

      rs.MoveNext
    Loop
End If


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sql = "select * from Result where Ord in(7,8,9) order by KodSpr,Ord "
Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
  
  Set rd = Range("TotaLItogD3")
  nm = rd.Worksheet.name
  k = rd.Column
  row_Itog = 0
  Set RK = Range("TotaLItogK3")
  k1 = RK.Column
  row_Itog1 = 0
  
  Set r = Range("DSItog3")
  Do Until rs.EOF
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown
  Row = r.Rows.Count - 1
  row_Itog = row_Itog + 1
  row_Itog1 = row_Itog1 + 1
  r.Cells(Row, 1) = IIf(IsNull(rs("col2")), "X", rs("col2"))
  r.Cells(Row, 2) = IIf(IsNull(rs("col3")), "X", rs("col3"))
  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), "X", rs("col4"))
  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), "X", rs("col5"))
  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), 0, rs("col6"))
  r.Cells(Row, 6) = IIf(IsNull(rs("col7")), 0, rs("col7"))
  r.Cells(Row, 7) = IIf(IsNull(rs("col8")), "X", rs("col8"))
  
  lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Dt"))), "", Trim(rs("Adr_Dt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Dt")), 500)
      
        If IsArray(fArr) Then
           
             If row_Itog < rd.Row Then
               row_Itog = rd.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog = row_Itog + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog = row_Itog + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Interior.ColorIndex = 38
             
             r.Cells(Row, 5).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
        End If
    
    Else
      r.Cells(Row, 5).Formula = "=(" & rs("Adr_Dt") & ")"
    End If
  End If

lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Kt"))), "", Trim(rs("Adr_Kt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Kt")), 500)
      
        If IsArray(fArr) Then
    
             
             If row_Itog1 < RK.Row Then
               row_Itog1 = RK.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
             
             r.Cells(Row, 6).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
        End If
    
    Else
      r.Cells(Row, 6).Formula = "=(" & rs("Adr_Kt") & ")"
    End If
  End If

      rs.MoveNext
    Loop
End If

'db.Close


finnally:
On Error GoTo 0
On Error Resume Next
'ProtectXlt1
'ActiveSheet.OLEObjects("CmdRecalcItog").Object.Enabled = False
Set R1 = Nothing
Set r = Nothing
Set rd = Nothing
Set RK = Nothing
rs.Close
db.Close
Set rs = Nothing
Set db = Nothing
Kill TempPath & "\SvTemp.mdb"
Exit Sub
err125:
If err = 3204 Then
  'Kill "c:\SvTemp.mdb"
  Kill TempPath & "\SvTemp.mdb"
  Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp", dbLangCyrillic)
  err.Clear
  GoTo GoNext
Else
  'MsgBox Error(err)
  'Resume
  err.Clear
  GoTo finnally
End If

End Sub

Sub CreateFormula_Ostatok(db As Database, flg As Long, sjoin As String, Ord As Long, sn As String)
Dim sql As String
If Trim(sjoin) = "" Then Exit Sub
If flg = 0 Then
    'sql = "update Result INNER JOIN Result AS Result_1 ON trim(Result.col5) = trim(Result_1.col5) "
    sql = "update Result inner join Result as Result_1 on " & sjoin
    sql = sql & " set Result_1.Adr_Dt=trim(Result_1.Adr_Dt) & '+' & trim(Result.Adr_Dt), "
    sql = sql & "Result_1.Adr_Kt=trim(Result_1.Adr_Kt) & '+' & trim(Result.Adr_Kt) "
    sql = sql & "where Result_1.Ord =" & Ord & " And Result.Ord = 0"
    db.Execute (sql)
  ElseIf flg = 1 Then
    'sn = Mid(sAccDt1, 6, 1)
    sql = "update Result inner join Result as Result_1 on " & sjoin
    sql = sql & " set Result_1.Adr_Dt=trim(Result_1.Adr_Dt) & '+' & trim(Result.Adr_Dt) "
    sql = sql & "where Result_1.Ord = " & Ord & " And Result.Ord = 0"
    db.Execute (sql)
    
    sql = "update Result inner join Result as Result_1 on " & sjoin
    sql = sql & " set Result_1.Adr_Dt=trim(Result_1.Adr_Dt) & '" & sn & "' & trim(Result.Adr_Kt) "
    sql = sql & "where Result_1.Ord = " & Ord & " And Result.Ord = 0"
    db.Execute (sql)
    
  ElseIf flg = 2 Then
    'sn = Mid(sAccKt1, 6, 1)
   
    sql = "update Result inner join Result as Result_1 on " & sjoin
    sql = sql & " set Result_1.Adr_Kt=trim(Result_1.Adr_Kt) & '+' & trim(Result.Adr_Kt) "
    sql = sql & "where Result_1.Ord = " & Ord & " And Result.Ord = 0"
    db.Execute (sql)
    
    sql = "update Result inner join Result as Result_1 on " & sjoin
    sql = sql & " set Result_1.Adr_Kt=trim(Result_1.Adr_Kt) & '" & sn & "' & trim(Result.Adr_Dt) "
    sql = sql & "where Result_1.Ord = " & Ord & " And Result.Ord = 0"
    db.Execute (sql)
    
  End If
End Sub

Sub CreateFormula_Ostatok128(db As Database, flg As Long, sjoin As String, Ord As Long, sn As String)
Dim sql As String
If Trim(sjoin) = "" Then Exit Sub
If flg = 0 Then
    'sql = "update Result INNER JOIN Result AS Result_1 ON trim(Result.col5) = trim(Result_1.col5) "
    sql = "update Result inner join Result as Result_1 on " & sjoin
    sql = sql & " set Result_1.Adr_Dt=trim(Result_1.Adr_Dt) & '+' & trim(Result.Adr_Dt), "
    sql = sql & "Result_1.Adr_Kt=trim(Result_1.Adr_Kt) & '+' & trim(Result.Adr_Kt) "
    sql = sql & "where Result_1.Ord =" & Ord & " And Result.Ord = 0"
    db.Execute (sql)
  ElseIf flg = 1 Then
    'sn = Mid(sAccDt1, 6, 1)
    sql = "update Result inner join Result as Result_1 on " & sjoin
    sql = sql & " set Result_1.Adr_Dt=trim(Result_1.Adr_Dt) & '+' & trim(Result.Adr_Dt) "
    sql = sql & "where Result_1.Ord = " & Ord & " And Result.Ord = 0"
    db.Execute (sql)
    
    sql = "update Result inner join Result as Result_1 on " & sjoin
    sql = sql & " set Result_1.Adr_Dt=trim(Result_1.Adr_Dt) & '" & sn & "' & trim(Result.Adr_Kt) "
    sql = sql & "where Result_1.Ord = " & Ord & " And Result.Ord = 0"
    db.Execute (sql)
    
  ElseIf flg = 2 Then
    'sn = Mid(sAccKt1, 6, 1)
   
    sql = "update Result inner join Result as Result_1 on " & sjoin
    sql = sql & " set Result_1.Adr_Kt=trim(Result_1.Adr_Kt) & '+' & trim(Result.Adr_Kt) "
    sql = sql & "where Result_1.Ord = " & Ord & " And Result.Ord = 0"
    db.Execute (sql)
    
    sql = "update Result inner join Result as Result_1 on " & sjoin
    sql = sql & " set Result_1.Adr_Kt=trim(Result_1.Adr_Kt) & '" & sn & "' & trim(Result.Adr_Dt) "
    sql = sql & "where Result_1.Ord = " & Ord & " And Result.Ord = 0"
    db.Execute (sql)
    
  End If

End Sub

Function CreateJoinsql(fArr, str As String) As String
Dim fArr1()
Dim sqlJoin As String
Dim sql As String
Dim i  As Long

fArr1 = DelimitedLineToArray(str, ",")

 For i = LBound(fArr) To UBound(fArr)
  If InStr(fArr(i), "MID") > 0 Then
    sql = sReplace(fArr(i), "col", "Result.col")
    sqlJoin = sqlJoin & "(" & sql & "=Result_1." & fArr1(i) & ") and "
  Else
    sqlJoin = sqlJoin & "(Result." & fArr(i) & "=Result_1." & fArr1(i) & ") and "
  End If
Next i

sqlJoin = Trim(sqlJoin)
sqlJoin = left(sqlJoin, Len(sqlJoin) - 4)

CreateJoinsql = sqlJoin


End Function

Function GetSubStrItogo(str As String, sn As String, Col As Long, unit As String) As String
Dim i  As Long
Dim j  As Long
Dim l  As Long
Dim n  As Long
Dim ColArr
Dim fArr
Dim p  As Long
Dim l1  As Long
Dim m
Dim s As String
 str = UCase(str)
'ColArr = DelimitedLineToArray(str, "&")
ColArr = DelimitedLineToArray(str, unit)
str = ""

   For i = 0 To UBound(ColArr)
    If InStr(ColArr(i), "+") > 0 Then
         j = InStr(ColArr(i), "MID")
         If j > 0 Then
         ColArr(i) = sReplace(ColArr(i), " ", "")
         'Do Until j = 0
          'If j > 0 Then
            fArr = DelimitedLineToArray(ColArr(i), "+")
            For p = LBound(fArr) To UBound(fArr)
               j = InStr(fArr(p), "MID")
               If j > 0 Then
                  s = Mid(fArr(p), 7)
                  If IsNumeric(left(s, 1)) Then
                   n = InStr(1, s, ",")
                     
                     If n > 0 Then
                       l = CInt(Mid(s, 1, n - 1))
                       If sn = "-" Then
                         l1 = l - CInt(Col)
                       ElseIf sn = "+" Then
                         l1 = l + CInt(Col)
                       End If
                       If p = CInt(UBound(fArr)) Then
                         str = str & sReplace(fArr(p), "RC" & CStr(l), "col" & l1) & ";"
                       Else
                         str = str & sReplace(fArr(p), "RC" & CStr(l), "col" & l1) & " & "
                       End If
                     End If
                     
                 End If
               ElseIf InStr(fArr(p), "RC") > 0 Then
                  j = CInt(Mid(fArr(p), 3))
                   If sn = "-" Then
                       m = j - CInt(Col)
                   ElseIf sn = "+" Then
                     m = j + CInt(Col)
                   End If
                   str = str & "col" & m & ";"
                 
               Else
                 str = str & fArr(p) & " & "
               End If
             Next p
             
            
            
          'End If
        'Loop
        End If
    Else

        j = InStr(ColArr(i), "MID")
        If j > 0 Then
          ColArr(i) = sReplace(ColArr(i), " ", "")
           '|fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
             fArr = DelimitedLineToArray(ColArr(i), ",")
             l = Mid(fArr(0), 7)
             j = CInt(Mid(ColArr(i), 7, Len(CStr(l))))
             
             
              If sn = "-" Then
                j = j - CInt(Col)
              ElseIf sn = "+" Then
                j = j + CInt(Col)
              End If
             ColArr(i) = left(ColArr(i), 6) & CStr(j) & Mid(ColArr(i), 8)
             str = str & sReplace(ColArr(i), "RC", "col") & ";"
        
        Else
          
          If InStr(ColArr(i), "RC") > 0 Then
             ColArr(i) = sReplace(ColArr(i), " ", "")
             'fArr = DelimitedLineToArray(ColArr(i), ",")
              '  For p = LBound(fArr) To UBound(fArr)
               j = CInt(Mid(ColArr(i), 3))
               If sn = "-" Then
                   m = j - CInt(Col)
               ElseIf sn = "+" Then
                 m = j + CInt(Col)
               End If
      
             str = str & "col" & m & ";"
             'Next p
             
'             j = CInt(Mid(ColArr(i), 7, Len(CStr(l))))
'             l = Mid(fArr(0), 7)
'             j = CInt(Mid(ColArr(i), 7, Len(CStr(l))))
             
          Else
            str = str & ColArr(i) & ";"
          End If
        End If
     End If
   Next i
   str = left(str, Len(str) - 1)

   
'a1:
GetSubStrItogo = str


End Function

Function CreateArrayFromStoka(stroka As String, csimbols) As Variant
Dim fArr
Dim k As Single
Dim j  As Long
Dim sql As String
Dim sql1 As String
Dim i  As Long
Dim lnFrm As Long
 
On Error GoTo ErrArray
 stroka = Trim(stroka)
 lnFrm = Len(stroka)
 k = lnFrm / csimbols
 j = lnFrm \ csimbols
 If k <> j Then j = j + 1 '|fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 
 ReDim fArr(j - 1)
 sql1 = Trim(stroka)
 sql = Trim(stroka)
  For i = 0 To UBound(fArr)
    sql = left(sql1, csimbols)
    If Right(sql, 1) <> "+" And Right(sql, 1) <> "-" Then
      j = InStr(csimbols, sql1, "+")
      If j = 0 Then j = InStr(csimbols, sql1, "-")
      If j >= csimbols + 1 Then
         fArr(i) = sql & Mid(sql1, csimbols + 1, j - csimbols - 1)
        sql1 = Mid(sql1, j + 1)
       
       ' flEmpthy = False
      Else
         fArr(i) = Mid(sql1, 1)
         sql1 = Mid(sql1, Len(fArr(i)) + 1)
       '  flEmpthy = False
      End If
      
    ElseIf Right(sql, 1) = "+" Or Right(sql, 1) = "-" Then
       fArr(i) = Mid(sql, 1, Len(sql) - 1)
       sql1 = Mid(sql1, Len(fArr(i)) + 2)
    
    End If
 Next i


finally:
CreateArrayFromStoka = fArr
Exit Function

ErrArray:
'MsgBox Error(err)
'Resume
 fArr = 0
GoTo finally

End Function

'1 - |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 2 - |fffd||fffd||fffd||fffd||fffd||fffd|
Public Function InsFormula125(sKod$, Row As Long, R1 As Range)
Dim r As Range, sF$

sKod = "f" & Mid$(sKod, 3)
Set r = Range(sKod & "Dt")
sF = Cells(Row, 1).Formula
If left$(sF, 1) = "=" Then Exit Function
r.Cells(Row, 1).Formula = "=" & R1.Address
Set r = Range(sKod & "Kt")
r.Cells(Row, 1).Formula = "=" & R1.Offset(0, 1).Address
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub F1251Itogo(Optional FromForm As String)
Dim r As Range, R1 As Range, i As Long, sKodAcc$, row0 As Long, Row As Long
Dim sFormula$, rname$, s$, sKod$, sKodAccDt$, sAd$, sAdKt$, sAdDt$, s1$
Dim sGr$, sGr1$, sGr2$, sGr3$, sAccCode$
Dim fl125new As Long
'|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd|
If HasName("dsF") Then fl125new = 1
s1 = sGetINI("Calculate", "?")
If s1 <> "?" Then fl125new = 2
If FromForm = "FromForm" And fl125new = 2 Then Exit Sub
If Not HasName("DSItog1") Then Exit Sub
If Not HasName("DSItog2") Then Exit Sub
If Not HasName("DSItog3") Then Exit Sub

Set r = Range("Data_Sheet1")

sKodAcc = Range("Kod_Account").Cells(1, 1)
sGr1 = sGetINI("DSItog1.Group", "?")
sGr2 = sGetINI("DSItog2.Group", "?")
sGr3 = sGetINI("DSItog3.Group", "?")


For i = 2 To r.Rows.Count - 1
'|fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd|
row0 = r.Row + i - 1 ' |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| Data_Sheet1
If sGr1 = "?" Then GoTo A1
s = "= " & sReplace(sGr1, "R", "R" & Trim$(str(row0)))
'|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
ActiveSheet.Cells(1, 10).Clear
ActiveSheet.Cells(1, 10).Formula = s
sKod = "ww" & ActiveSheet.Cells(1, 10).Value     ' sKod = "w" & R.Cells(i, 3) & R.Cells(i, 4) & sKodAcc
    If HasName(sKod) = False Then
        Set R1 = Range("DSItog1")
        Row = R1.Row + R1.Rows.Count - 1    '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| DSItog1
        Rows(Row).Insert Shift:=xlDown
        Row = R1.Rows.Count - 1
        If R1.Cells(1, 1) <> "X" Then R1.Cells(Row, 1) = r.Cells(i, 3) Else R1.Cells(Row, 1) = "X"
        If R1.Cells(1, 2) <> "X" Then R1.Cells(Row, 2) = r.Cells(i, 4) Else R1.Cells(Row, 2) = "X"
        If R1.Cells(1, 3) <> "X" Then R1.Cells(Row, 3) = r.Cells(i, 5) Else R1.Cells(Row, 3) = "X"
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        sAccCode = fAccItogKode(sGr1, row0)
        R1.Cells(Row, 4) = IIf(Len(sAccCode) = 0, sKodAcc, sAccCode)
        sAd = "='" & r.Worksheet.name & "'!" & R1.Cells(Row, 4).Address
        ActiveWorkbook.Names.Add name:=sKod, RefersTo:=sAd
        sAdDt = R1.Cells(Row, 8).Address
        sAdKt = R1.Cells(Row, 9).Address
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        sFormula = sGetINI("DSItog1.Dt", "0")
        If sFormula <> "0" Then R1.Cells(Row, 5).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
        sFormula = sGetINI("DSItog1.Kt", "0")
        If sFormula <> "0" Then R1.Cells(Row, 6).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
        R1.Cells(Row, 7) = "X"
        If fl125new = 1 Then AddColumn125 sKod
    End If
If fl125new = 1 Then InsFormula125 sKod, i, r.Cells(i, 7)
If fl125new = 0 Then
    InsFormula Range(sKod).Cells(1, 1).Offset(0, 4), r.Cells(i, 7)
    InsFormula Range(sKod).Cells(1, 1).Offset(0, 5), r.Cells(i, 8)
End If
If fl125new = 2 Then
    Calculate125 Range(sKod).Cells(1, 1).Offset(0, 4), r.Cells(i, 7)
    Calculate125 Range(sKod).Cells(1, 1).Offset(0, 5), r.Cells(i, 8)
End If
A1:
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If IfMoney(r.Cells(i, 9)) Then rname = "DSItog2" Else rname = "DSItog3"
If rname = "DSItog2" Then If sGr2 = "?" Then GoTo a2 Else sGr = sGr2
If rname = "DSItog3" Then If sGr3 = "?" Then GoTo a2 Else sGr = sGr3

s = "= " & sReplace(sGr, "R", "R" & Trim$(str(row0)))
ActiveSheet.Cells(1, 10).Clear
ActiveSheet.Cells(1, 10).Formula = s
sKod = "ww" & ActiveSheet.Cells(1, 10).Value 'sKod = sKod & R.Cells(i, 9)
If HasName(sKod) = False Then
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|-|fffd||fffd|
    If IfMoney(r.Cells(i, 9)) Then rname = "DSItog2" Else rname = "DSItog3"
    Set R1 = Range(rname)
    Row = R1.Row + R1.Rows.Count - 1
    Rows(Row).Insert Shift:=xlDown
    Row = R1.Rows.Count - 1
        If R1.Cells(1, 1) <> "X" Then R1.Cells(Row, 1) = r.Cells(i, 3) Else R1.Cells(Row, 1) = "X"
        If R1.Cells(1, 2) <> "X" Then R1.Cells(Row, 2) = r.Cells(i, 4) Else R1.Cells(Row, 2) = "X"
        If R1.Cells(1, 3) <> "X" Then R1.Cells(Row, 3) = r.Cells(i, 5) Else R1.Cells(Row, 3) = "X"
    sAccCode = fAccItogKode(sGr, row0)
    R1.Cells(Row, 4) = IIf(Len(sAccCode) = 0, sKodAcc, sAccCode)
    R1.Cells(Row, 7) = r.Cells(i, 9) '|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    sAd = "='" & r.Worksheet.name & "'!" & R1.Cells(Row, 4).Address
    ActiveWorkbook.Names.Add name:=sKod, RefersTo:=sAd
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    sAdDt = R1.Cells(Row, 8).Address
    sAdKt = R1.Cells(Row, 9).Address
    sFormula = sGetINI(rname & ".Dt", "0")
    If sFormula <> "0" Then R1.Cells(Row, 5).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
    sFormula = sGetINI(rname & ".Kt", "0")
    If sFormula <> "0" Then R1.Cells(Row, 6).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
    If fl125new = 1 Then AddColumn125 sKod
End If
If fl125new = 1 Then InsFormula125 sKod, i, r.Cells(i, 7)
If fl125new = 0 Then
    InsFormula Range(sKod).Cells(1, 1).Offset(0, 4), r.Cells(i, 7)
    InsFormula Range(sKod).Cells(1, 1).Offset(0, 5), r.Cells(i, 8)
End If
If fl125new = 2 Then
    Calculate125 Range(sKod).Cells(1, 1).Offset(0, 4), r.Cells(i, 7)
    Calculate125 Range(sKod).Cells(1, 1).Offset(0, 5), r.Cells(i, 8)
End If
a2:
Next i
'R1.Cells(R1.row + 1, 1).Offset(0, -1) = "|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd|:"
Set R1 = Nothing
Set r = Nothing
End Sub

'1 - |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 2 - |fffd||fffd||fffd||fffd||fffd||fffd|
Public Function Calculate125(r2 As Range, r As Range)
Dim sF$
r2.Value = r2.Value + r.Value
End Function
'|fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub f125ItogoCB()
Dim s As String
    Application.ScreenUpdating = False
    fUnProtect True
    
'    fAddAccount
'    fCleare
'    F1251Itogo
'---------------------------------------------------31.10.2008
   If HasName("Total_Debet") = False Then
      fAddAccount
      fCleare
      F1251Itogo
   Else
     s = sGetINI("flkod", "?")
     If s <> "?" Then '128|fffd|
       Call F1251_Itogo128
     Else
       Call F1251_newItogo
     End If
   End If
'---------------------------------------------------31.10.2008
    fUnProtect False
    Application.ScreenUpdating = True
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub f169ItogoCB()
 Application.ScreenUpdating = False
 fUnProtect True
   If HasName("Itog1") = False Then
      F169Itogo
   Else
      F169_newItogo
   End If
'Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Enabled = False
fUnProtect False
Application.ScreenUpdating = True

End Sub

Public Sub fCleare()
Dim r As Range, a As Variant, i As Long, s$, j As Long
a = Array("DSItog1", "DSItog2", "DSItog3")
For i = 0 To 2
s = a(i)
If Not HasName(s) Then GoTo A1
Set r = Range(s)
If r.Rows.Count = 2 Then GoTo A1
For j = 2 To r.Rows.Count - 1
    r.Cells(j, 8) = 0
    r.Cells(j, 9) = 0
Next j
A1:
Next i
End Sub

Public Sub F169Itogo()
Dim r As Range, i As Long, row0 As Long, R1 As Range, r2 As Range, sKod$, Row As Long, sAd$ ', sKodAcc$
Dim n As name, s$, row1 As Long, row2 As Long
Dim fl As Boolean

If Not HasName("DSItog1") Then Exit Sub
If Not HasName("DSItog2") Then Exit Sub

If Application.ScreenUpdating Then Application.ScreenUpdating = False
'fUnProtect True
F1251deleteFormuls

Set r = Range("Data_Sheet1")
If r.Rows.Count < 3 Then Exit Sub
row1 = r.Row + 1
row2 = row1 + r.Rows.Count - 3
sAd = "='" & ActiveSheet.name & "'!" & Range(Cells(row1, 1), Cells(row2, 4)).Address
Set r = Range(sAd)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
RCopyAndSort r
Set r2 = Range("DSItog2")
Set R1 = Range("DSItog1")
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd|
For i = 1 To r.Rows.Count
    sKod = "ww" & r.Cells(i, 4).Value
    fl = sKod = "ww" Or sKod = "wwX"
    If Not fl Then
'        row = AddRowItog(sKod, R2)
'        If row > 0 Then R2.Cells(row, 2) = Mid$(sKod, 3)
        InsFormula Range(sKod).Cells(1, 1), r.Cells(i, 3)
    End If
    sKod = "ww" & left$(fDelFormat(r.Cells(i, 1).Value), 6) & "000" & "0000"
    '|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'    row = AddRowItog(sKod, R1)
'    If row > 0 Then
'        R1.Cells(row, 1) = Mid$(sKod, 3, 9)
'        R1.Cells(row, 4) = "0000"
'    End If
    InsFormula Range(sKod).Cells(1, 1).Offset(0, 1), r.Cells(i, 2)
    InsFormula Range(sKod).Cells(1, 1).Offset(0, 2), r.Cells(i, 3)
    If Not fl Then
        sKod = "ww" & left$(fDelFormat(r.Cells(i, 1).Value), 6) & "000" & r.Cells(i, 4).Value
'        row = AddRowItog(sKod, R1)
'        If row > 0 Then
'            R1.Cells(row, 1) = Mid$(sKod, 3, 9)
'            R1.Cells(row, 4) = Right$(sKod, 4)
'        End If
        InsFormula Range(sKod).Cells(1, 1).Offset(0, 2), r.Cells(i, 3)
    End If
    'A1:
Next i

'row1 = R2.row + 1
'row2 = row1 + R2.Rows.Count - 3
'sAD = "='" & ActiveSheet.Name & "'!" & Range(Cells(row1, 3), Cells(row2, 4)).Address
'Set R2 = Range(sAD)
'R2.Sort Key1:=R2.Cells(1, 2), Order1:=xlAscending

'row1 = R1.row + 1
'row2 = row1 + R1.Rows.Count - 3
'sAD = "='" & ActiveSheet.Name & "'!" & Range(Cells(row1, 1), Cells(row2, 4)).Address
'Set R1 = Range(sAD)
'R1.Sort Key1:=R1.Cells(1, 1), Key2:=R1.Cells(1, 4), Order1:=xlAscending
For i = 1 To R1.Rows.Count
 If R1.Cells(i, 4) = "0000" Then R1.Cells(i, 4) = "" Else R1.Cells(i, 1) = ""
Next
Set r2 = Nothing
Set R1 = Nothing
Set r = Nothing
'fUnProtect False
If Not Application.ScreenUpdating Then Application.ScreenUpdating = True
End Sub

Public Function AddRowItog(sKod$, r As Range) As Long
Dim Row As Long, sAd$
sKod = sReplace(sKod, " ", "")
If HasName(sKod) = False Then
    Row = r.Row + r.Rows.Count - 1
    Rows(Row).Insert Shift:=xlDown
    Row = r.Rows.Count - 1
    sAd = "='" & r.Worksheet.name & "'!" & r.Cells(Row, 1).Address
    ActiveWorkbook.Names.Add name:=sKod, RefersTo:=sAd
End If
AddRowItog = Row
End Function


Public Sub RCopyAndSort(ByVal r As Range)
Dim R1 As Range, Row As Long, row1 As Long, row2 As Long, sAd$, i As Long, sKod$, fl As Boolean
Set R1 = r.Cells(1, 1).Offset(0, 8)
r.Copy R1
row1 = r.Row
row2 = row1 + r.Rows.Count - 1
sAd = "='" & ActiveSheet.name & "'!" & Range(Cells(row1, 9), Cells(row2, 12)).Address
Set r = Range(sAd)
r.Sort Key1:=r.Cells(1, 1), Key2:=r.Cells(1, 4), Order1:=xlAscending
Set R1 = Range("DSItog1")
For i = 1 To r.Rows.Count
    sKod = "ww" & left$(fDelFormat(r.Cells(i, 1).Value), 6) & "000" & "0000"
    Row = AddRowItog(sKod, R1)
    If Row > 0 Then
        R1.Cells(Row, 1) = Mid$(sKod, 3, 9)
        R1.Cells(Row, 4) = "0000"
    End If
    If Not fl Then
        sKod = "ww" & left$(fDelFormat(r.Cells(i, 1).Value), 6) & "000" & r.Cells(i, 4).Value
        Row = AddRowItog(sKod, R1)
        If Row > 0 Then
            'R1.Cells(row, 1) = Mid$(sKod, 3, 9)
            R1.Cells(Row, 4) = Right$(sKod, 4)
        End If
    End If
Next i
Set R1 = Range("DSItog2")
r.Sort Key1:=r.Cells(1, 4), Order1:=xlAscending
For i = 1 To r.Rows.Count
    sKod = "ww" & r.Cells(i, 4).Value
    fl = sKod = "ww" Or sKod = "wwX"
    If Not fl Then
        Row = AddRowItog(sKod, R1)
        If Row > 0 Then R1.Cells(Row, 2) = Mid$(sKod, 3)
    End If
Next i
Set R1 = Nothing
End Sub
Attribute VB_Name = "ModF725"
Option Explicit

' |fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|

Sub addRowF725(sKod$, r As Range, iAK As Long, Optional Row As Long, Optional flg128$, Optional newNameOrg$)
Dim s$, fl128 As Long, n As Long
'If flg128 <> "?" Then fl128 = 1
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'n = 3 + fl128
n = 5
r.Cells(Row, 2) = Mid$(sKod, n, 5)
n = n + 5
s = Mid$(sKod, 4, 6)
'If left$(s, 1) = "1" Then
'    r.Cells(Row, 1) = NameinSpr(Right$(s, 5), "Data_Org")
'Else
'    If frmAddRow1.Visible And Len(newNameOrg) = 0 Then r.Cells(Row, 2) = Data_ORG.Value Else r.Cells(Row, 2) = newNameOrg
'End If
''|fffd||fffd||fffd|
'If r.Cells(1, 3) <> "X" Then
'    r.Cells(Row, 3) = Mid$(sKod, n, 3)
'    n = n + 3
'Else
'    r.Cells(Row, 3) = "X"
'End If
''|fffd||fffd||fffd||fffd||fffd|
'If r.Cells(1, 4) <> "X" Then
'    r.Cells(Row, 4) = Mid$(sKod, n, iAK)
'    n = n + iAK
'Else
'    r.Cells(Row, 4) = "X"
'End If
''|fffd||fffd|-|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'If r.Cells(1, 5) <> "X" Then
'    r.Cells(Row, 5) = Mid$(sKod, n, 2)
'    n = n + 2
'Else
'    r.Cells(Row, 5) = "X"
'End If
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If r.Cells(1, 3) <> "X" Then
    r.Cells(Row, 3) = Mid$(sKod, n, 17) & left$(Range("Kod_Account").Cells(1, 1).Value, 6) & Mid$(sKod, n + 17, 3)
    n = n + 17 + 3
Else
    r.Cells(Row, 6) = "X"
End If
'|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
r.Cells(Row, 6) = IIf(r.Cells(1, 6) <> "X", Mid$(sKod, n, 9), "X")

''<Spir>20.06.2016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd|169
'fNameForDSandCells r, sKod, Row
fNameForDSandCells_F r, sKod, Row
'fNameForDSandCells r, sKod, Row, "1"
End Sub


'|fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub f725ItogoCB()
Dim s As String
    Application.ScreenUpdating = False
    fUnProtect True
    
'    fAddAccount
'    fCleare
'    F1251Itogo
'---------------------------------------------------31.10.2008
   If HasName("Total_Debet") = False Then
      fAddAccount
      fCleare
      F1251Itogo
   Else
     s = sGetINI("flkod", "?")
     If s <> "?" Then '128|fffd|
       Call F725_Itogo
     Else
       Call F1251_newItogo
     End If
   End If
'---------------------------------------------------31.10.2008
    fUnProtect False
    Application.ScreenUpdating = True
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
Public Sub DataEndInsert725()
Dim s As String

    F1251VDE Range("Kod_VDE").Cells(1, 1)
    Application.ScreenUpdating = False
    fUnProtect True
    
''    If HasName("Total_Debet") = True Then
'
''      s = sGetINI("flKod", "?")
''      If s <> "?" Then '128|fffd|
''        Call F1251_Itogo128
''      Else
        Call F725_Itogo
''      End If
'
''    Else
''      fAddAccount
''      F1251Itogo "FromForm"
''    End If

'    t2 = Time
'    Debug.Print "finish |fffd||fffd||fffd||fffd|"; t2
'    'MsgBox "|fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & DateDiff("n", t2, t1) & " |fffd||fffd||fffd||fffd||fffd|(|fffd|)"
'    Debug.Print "|fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| "; DateDiff("n", t2, t1); " |fffd||fffd||fffd||fffd||fffd|(|fffd|)"
    
    Application.ScreenUpdating = True
    fUnProtect False
    HideDSBeforePrint
End Sub
'
Public Sub F725_Itogo()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 725 |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd||fffd||fffd|),|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|.
Dim r As Range, R1 As Range, i As Long, Row As Long
Dim rd As Range, RK As Range
Dim db As Database
Dim sql As String
Dim sql1 As String
Dim k, k1
Dim rs As Recordset
Dim fArr
Dim lnFrm  As Long
Dim j  As Long
Dim l  As Long
Dim row_Itog  As Long
Dim row_Itog1  As Long
Dim nm As String
Dim sGr$, sGr1$, sGr2$, sGr3$, sKodAcc$, sAccDt1$, sAccKt1$, sAccDt2$, sAccKt2$, sAccDt3$, sAccKt3$
Dim sn As String
Dim ColArr
Dim flGR  As Long
Dim fArr1()
Dim sqlJoin1 As String
Dim sqlJoin2 As String
Dim sqlJoin3 As String
Dim sqlJoin4 As String
Dim sqlJoin5 As String
Dim sqlJoin6 As String
Dim sqlJoin7 As String
Dim sqlJoin8 As String
Dim sqlJoin9 As String
Dim sqlInsert As String
Dim sqlInsert1 As String
Dim sqlInsert2 As String
Dim sqlInsert3 As String
Dim sqlInsert4 As String
Dim sqlInsert5 As String
Dim sqlInsert6 As String
Dim sqlInsert7 As String
Dim sqlInsert8 As String
Dim sqlInsert9 As String
Dim sqlSelect As String
Dim Nds As String
Dim sGr11 As String, sGr12 As String, sGr13 As String
Dim sGr21 As String, sGr22 As String, sGr23 As String
Dim sGr31 As String, sGr32 As String, sGr33 As String
Dim TempPath As String
On Error GoTo err125

'UnProtectXlt1


If Not HasName("DSItog1") Then Exit Sub
If Not HasName("DSItog2") Then Exit Sub
If Not HasName("DSItog3") Then Exit Sub

sqlJoin1 = ""
sqlJoin2 = ""
sqlJoin3 = ""
sqlJoin4 = ""
sqlJoin5 = ""
sqlJoin6 = ""
sqlJoin7 = ""
sqlJoin8 = ""
sqlJoin9 = ""


sKodAcc = Range("Kod_Account").Cells(1, 1)
sGr11 = sGetINI("DSItog11.Group", "?")
sGr12 = sGetINI("DSItog12.Group", "?")
sGr13 = sGetINI("DSItog13.Group", "?")

sGr21 = sGetINI("DSItog21.Group", "?")
sGr22 = sGetINI("DSItog22.Group", "?")
sGr23 = sGetINI("DSItog23.Group", "?")

sGr31 = sGetINI("DSItog31.Group", "?")
sGr32 = sGetINI("DSItog32.Group", "?")
sGr33 = sGetINI("DSItog33.Group", "?")


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Set r = Range("DSItog1")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

Set r = Range("DSItog2")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

Set r = Range("DSItog3")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Set r = Range("Total_Debet")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone
Set r = Range("Total_Kredit")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

Set r = Range("TotaLItogD2")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone
Set r = Range("TotaLItogK2")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

Set r = Range("TotaLItogD3")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone
Set r = Range("TotaLItogK3")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

TempPath = Environ("Temp")
'Set db = DBEngine.CreateDatabase(ThisWorkbook.Path & "\SvTemp", dbLangCyrillic)
Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp", dbLangCyrillic)
  
GoNext:
'Set db = DBEngine.CreateDatabase(ThisWorkbook.Path & "\SvTemp", dbLangCyrillic)

sql = "create table Result(col2 text,col3 text,col4 currency,col5 currency,col6 text,Ord integer,AccPls text,Adr_Dt memo,Adr_Kt memo,KodSpr text)"
''sql = "create table Result(col2 text,col3 text,col4 text,col5 text,col6 currency,col7 currency,col8 text,Ord integer,AccPls text,Adr_Dt memo,Adr_Kt memo,KodSpr text)"
db.Execute (sql)

Nds = fGetNumberDataSheet("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|")
If Nds = "" Then
  Set r = Range("Data_Sheet01")
Else
  Set r = Range("Data_Sheet" & Nds)
End If


 If r.Rows.Count > 2 Then
  For i = 2 To r.Rows.Count - 1
    sql = "insert into Result(col2,col3,col4,col5,col6,Ord,Adr_Dt,Adr_Kt,KodSpr) "
    sql = sql & "values('" & r.Cells(i, 2).Value & "','" & r.Cells(i, 3).Value & "','" & IIf(IsEmpty(r.Cells(i, 4).Value), 0, r.Cells(i, 4).Value) & "','" & IIf(IsEmpty(r.Cells(i, 5).Value), 0, r.Cells(i, 5).Value) & "','" & r.Cells(i, 6).Value & "',0,'" & r.Cells(i, 4).Address & "','" & r.Cells(i, 5).Address & "','" & r.Cells(i, 4).name.name & "')"
''    sql = "insert into Result(col2,col3,col4,col5,col6,col7,col8,Ord,Adr_Dt,Adr_Kt,KodSpr) "
''    sql = sql & "values('" & r.Cells(i, 3).Value & "','" & r.Cells(i, 4).Value & "','" & r.Cells(i, 5).Value & "','" & r.Cells(i, 6).Value & "','" & IIf(IsEmpty(r.Cells(i, 7).Value), 0, r.Cells(i, 7).Value) & "','" & IIf(IsEmpty(r.Cells(i, 8).Value), 0, r.Cells(i, 8).Value) & "','" & r.Cells(i, 9).Value & "',0,'" & r.Cells(i, 7).Address & "','" & r.Cells(i, 8).Address & "','" & r.Cells(i, 7).Name.Name & "')"
    db.Execute (sql)
  Next i
Else
  Exit Sub
End If

db.Close
Set db = OpenDatabase(TempPath & "\SvTemp")
sql = "update Result set KodSpr =mid(KodSpr,5,1)"
db.Execute (sql)


'|fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(Ord=1)|fffd||fffd||fffd||fffd||fffd||fffd|
'sGr1="RC6"

If sGr11 <> "?" Then
  sGr11 = GetSubStrItogo(sGr11, "-", "0", "&")
  fArr = DelimitedLineToArray(sGr11, ";")
  sqlInsert1 = CreateInsertsql(fArr, sGr11, ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert1, ",")
  sqlJoin1 = CreateJoinsql128(fArr, sqlInsert1)
  sqlSelect = sReplace(sGr11, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert1 & ",col4,col5,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col4),0,col4)),Sum(iif(isnull(col5),0,col5)),1,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='1' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(Ord=2)|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'sGr2="RC6 & RC9"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sGr12 <> "?" Then
  sGr12 = UCase(sGr12)
  sGr12 = GetSubStrItogo(sGr12, "-", "0", "&")
  
  fArr = DelimitedLineToArray(sGr12, ";")
  'sqlInsert2 = CreateInsertsql(fArr, sGr12, ";")
  sqlInsert2 = CreateInsertsql128(fArr, "", ";")
  fArr1 = DelimitedLineToArray(sqlInsert2, ",")
  sqlJoin2 = CreateJoinsql128(fArr, "")
  
  sqlSelect = sReplace(sGr12, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert2 & ",col4,col5,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col4),0,col4)),Sum(iif(isnull(col5),0,col5)),2,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='2' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If
'|fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(Ord=3)|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'sGr2="RC6 & RC9"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sGr13 <> "?" Then
  sGr13 = UCase(sGr13)
  sGr13 = GetSubStrItogo(sGr13, "-", "0", "&")
  
  fArr = DelimitedLineToArray(sGr13, ";")
  sqlInsert3 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert3, ",")
  sqlJoin3 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr13, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert3 & ",col4,col5,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col4),0,col4)),Sum(iif(isnull(col5),0,col5)),3,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='3' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If


 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd|
If sGr21 <> "?" Then
  sGr21 = UCase(sGr21)
  sGr21 = GetSubStrItogo(sGr21, "-", "0", "&")
  
  fArr = DelimitedLineToArray(sGr21, ";")
  sqlInsert4 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert4, ",")
  sqlJoin4 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr21, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert4 & ",col4,col5,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col4),0,col4)),Sum(iif(isnull(col5),0,col5)),4,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='1' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd||fffd|
If sGr22 <> "?" Then
  sGr22 = UCase(sGr22)
  sGr22 = GetSubStrItogo(sGr22, "-", "0", "&")
  
  fArr = DelimitedLineToArray(sGr22, ";")
  sqlInsert5 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert5, ",")
  sqlJoin5 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr22, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert5 & ",col4,col5,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col4),0,col4)),Sum(iif(isnull(col5),0,col5)),5,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='2' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If sGr23 <> "?" Then
  sGr23 = UCase(sGr23)
  sGr23 = GetSubStrItogo(sGr23, "-", "0", "&")
  
  fArr = DelimitedLineToArray(sGr23, ";")
  sqlInsert6 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert6, ",")
  sqlJoin6 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr23, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert6 & ",col4,col5,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col4),0,col4)),Sum(iif(isnull(col5),0,col5)),6,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='3' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
  sql = ""
End If

'----------------------------------------
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd|
If sGr31 <> "?" Then
  sGr31 = UCase(sGr31)
  sGr31 = GetSubStrItogo(sGr31, "-", "0", "&")
  
  fArr = DelimitedLineToArray(sGr31, ";")
  sqlInsert7 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert7, ",")
  sqlJoin7 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr31, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert7 & ",col4,col5,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col4),0,col4)),Sum(iif(isnull(col5),0,col5)),7,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='1' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd||fffd|
If sGr32 <> "?" Then
  sGr32 = UCase(sGr32)
  sGr32 = GetSubStrItogo(sGr32, "-", "0", "&")
  
  fArr = DelimitedLineToArray(sGr32, ";")
  sqlInsert8 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert8, ",")
  sqlJoin8 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr32, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert8 & ",col4,col5,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col4),0,col4)),Sum(iif(isnull(col5),0,col5)),8,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='2' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If sGr33 <> "?" Then
  sGr33 = UCase(sGr33)
  sGr33 = GetSubStrItogo(sGr33, "-", "0", "&")
  
  fArr = DelimitedLineToArray(sGr33, ";")
  sqlInsert9 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert9, ",")
  sqlJoin9 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr33, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert9 & ",col4,col5,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col4),0,col4)),Sum(iif(isnull(col5),0,col5)),9,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='3' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

sql = "update Result set AccPls=mid(col6,2,5) where Ord in(4,5,6,7,8,9)"
'sql = "update Result set AccPls=mid(col8,2,5) where Ord in(4,5,6,7,8,9)"
db.Execute (sql)


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sql = "create table Data_PLS5(Cod text,CodName text,sgn integer)"
db.Execute (sql)

Set R1 = Range("Data_PLS5")

  If R1.Rows.Count > 2 Then
  For i = 1 To R1.Rows.Count - 1
    sql = "insert into Data_PLS5(Cod,CodName,sgn) "
    sql = sql & "values('" & R1.Cells(i, 1).Value & "','" & R1.Cells(i, 2).Value & "'," & IIf(IsNumeric(R1.Cells(i, 3).Value), R1.Cells(i, 3).Value, 0) & ")"
    db.Execute (sql)
  Next i
End If

sql = "update Result "
sql = sql & "set Adr_Dt='0' "
sql = sql & "where Ord in(4,5,6,7,8,9)"
'sql = sql & "where Ord in(4,5,6,7,8,9)"
db.Execute (sql)
 
 
sql = "update Result inner join Data_PLS5 on trim(Result.AccPls)=trim(Data_PLS5.Cod) "
sql = sql & "set Adr_Dt='1' "
sql = sql & "where Ord in(4,5,6,7,8,9) and Data_PLS5.sgn<>0"
db.Execute (sql)

sql = "delete * from Result where ord in(4,5,6) and trim(Adr_Dt)='0'"
db.Execute (sql)

sql = "delete * from Result where ord in(7,8,9) and trim(Adr_Dt)='1'"
db.Execute (sql)
sql = ""
 

'Ord=0-|fffd||fffd||fffd||fffd||fffd||fffd|
'Ord=1,2,3-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd|,|fffd||fffd||fffd||fffd|,|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
'Ord=4,5,6-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd|,|fffd||fffd||fffd||fffd|,|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
'Ord=7,8,9-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd|,|fffd||fffd||fffd||fffd|,|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
sAccDt1 = sGetINI("DSItog1.Dt", "?")
sAccKt1 = sGetINI("DSItog1.Kt", "?")
sAccDt2 = sGetINI("DSItog2.Dt", "?")
sAccKt2 = sGetINI("DSItog2.Kt", "?")
sAccDt3 = sGetINI("DSItog3.Dt", "?")
sAccKt3 = sGetINI("DSItog3.Kt", "?")
 
sAccDt1 = sReplace(sAccDt1, " ", "")
sAccKt1 = sReplace(sAccKt1, " ", "")

sAccDt2 = sReplace(sAccDt2, " ", "")
sAccKt2 = sReplace(sAccKt2, " ", "")

sAccDt3 = sReplace(sAccDt3, " ", "")
sAccKt3 = sReplace(sAccKt3, " ", "")



  'DsItog1
  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd|.|fffd|1251_6)
  If sAccDt1 <> "?" And sAccKt1 <> "?" Then
     flGR = 0
  ElseIf sAccDt1 <> "?" And sAccKt1 = "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1254_6)
    flGR = 1
    sn = Mid(sAccDt1, 6, 1)
  ElseIf sAccDt1 = "?" And sAccKt1 <> "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1256_6)
    flGR = 2
    sn = Mid(sAccKt1, 6, 1)
  End If
Call CreateFormula_Ostatok(db, flGR, sqlJoin1, 1, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin2, 2, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin3, 3, sn)


'Call CreateFormula_Ostatok128(db, flgr, sqlJoin1, 1, sn)

'DsItog2
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sAccDt2 <> "?" And sAccKt2 <> "?" Then
   flGR = 0
ElseIf sAccDt2 <> "?" And sAccKt2 = "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1254_6)
  flGR = 1
  sn = Mid(sAccDt2, 6, 1)
ElseIf sAccDt2 = "?" And sAccKt2 <> "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1256_6)
  flGR = 2
  sn = Mid(sAccKt2, 6, 1)
End If
Call CreateFormula_Ostatok(db, flGR, sqlJoin4, 4, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin5, 5, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin6, 6, sn)


'DsItog3
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|

If sAccDt3 <> "?" And sAccKt3 <> "?" Then
   flGR = 0
ElseIf sAccDt3 <> "?" And sAccKt3 = "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1254_6)
  flGR = 1
  sn = Mid(sAccDt3, 6, 1)
ElseIf sAccDt3 = "?" And sAccKt3 <> "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1256_6)
  flGR = 2
  sn = Mid(sAccKt3, 6, 1)
End If
Call CreateFormula_Ostatok(db, flGR, sqlJoin7, 7, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin8, 8, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin9, 9, sn)

  sql = "update Result set Adr_Dt=mid(Adr_Dt,2),Adr_Kt=mid(Adr_Kt,2) "
  sql = sql & "where Ord<>0"
  db.Execute (sql)
  
  db.Execute ("update Result set col4=null,col5=null where Ord<>0")
  
  
  sql = "select * from Result where Ord in(1,2,3) order by KodSpr,ord "
  Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
  If rs.RecordCount = 0 Then Exit Sub
  rs.MoveLast
  rs.MoveFirst
  
  Set rd = Range("Total_Debet")
  nm = rd.Worksheet.name
  k = rd.Column
  row_Itog = 0
  Set RK = Range("Total_Kredit")
  k1 = RK.Column
  row_Itog1 = 0

'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Set r = Range("DSItog1")
Do Until rs.EOF
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown
  Row = r.Rows.Count - 1
  row_Itog = row_Itog + 1
  row_Itog1 = row_Itog1 + 1
  
  r.Cells(Row, 1) = IIf(IsNull(rs("col2")), "X", rs("col2"))
  r.Cells(Row, 2) = IIf(IsNull(rs("col3")), "X", rs("col3"))
  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), 0, rs("col4"))
  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), 0, rs("col5"))
  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), "X", rs("col6"))
''  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), "X", rs("col4"))
''  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), "X", rs("col5"))
''  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), 0, rs("col6"))
''  r.Cells(Row, 6) = IIf(IsNull(rs("col7")), 0, rs("col7"))
''  r.Cells(Row, 7) = IIf(IsNull(rs("col8")), "X", rs("col8"))
  
  
  lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Dt"))), "", Trim(rs("Adr_Dt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
       fArr = Empty
       fArr = CreateArrayFromStoka(Trim(rs("Adr_Dt")), 500)
      
        If IsArray(fArr) Then
           
             If row_Itog < rd.Row Then
               row_Itog = rd.Row
             End If
          '    Rn.Rows(Rn.Rows.Count & ":" & UBound(fArr) + 2).Insert shift:=xlDown
             sql = "=("
             For j = 0 To UBound(fArr)
              If Trim(fArr(j)) <> "" Then
                row_Itog = row_Itog + 1
                ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = "=(" & fArr(j) & ")"
                sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & "+"
              End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog = row_Itog + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Interior.ColorIndex = 38
             
             
             r.Cells(Row, 3).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
'             r.Cells(Row, 5).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
        End If
    
    Else
      r.Cells(Row, 3).Formula = "=(" & rs("Adr_Dt") & ")"
'      r.Cells(Row, 5).Formula = "=(" & rs("Adr_Dt") & ")"
   End If
  End If
    
  
  
 lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Kt"))), "", Trim(rs("Adr_Kt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Kt")), 500)
      
        If IsArray(fArr) Then
    
             
             If row_Itog1 < RK.Row Then
               row_Itog1 = RK.Row
             End If

             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
             
             r.Cells(Row, 4).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
'             r.Cells(Row, 6).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
        End If
    
    Else
      r.Cells(Row, 4).Formula = "=(" & rs("Adr_Kt") & ")"
 '     r.Cells(Row, 6).Formula = "=(" & rs("Adr_Kt") & ")"
    End If
  End If
   
  
  rs.MoveNext

Loop


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sql = "select * from Result where Ord in(4,5,6) order by KodSpr,Ord "

Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
  
  Set rd = Range("TotaLItogD2")
  nm = rd.Worksheet.name
  k = rd.Column
  row_Itog = 0
  Set RK = Range("TotaLItogK2")
  k1 = RK.Column
  row_Itog1 = 0

  
  Set r = Range("DSItog2")
  Do Until rs.EOF
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown
  Row = r.Rows.Count - 1
  row_Itog = row_Itog + 1
  row_Itog1 = row_Itog1 + 1
     
  r.Cells(Row, 1) = IIf(IsNull(rs("col2")), "X", rs("col2"))
  r.Cells(Row, 2) = IIf(IsNull(rs("col3")), "X", rs("col3"))
  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), 0, rs("col4"))
  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), 0, rs("col5"))
  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), "X", rs("col6"))
''  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), "X", rs("col4"))
''  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), "X", rs("col5"))
''  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), 0, rs("col6"))
''  r.Cells(Row, 6) = IIf(IsNull(rs("col7")), 0, rs("col7"))
''  r.Cells(Row, 7) = IIf(IsNull(rs("col8")), "X", rs("col8"))
  
  
  
  
  lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Dt"))), "", Trim(rs("Adr_Dt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Dt")), 500)
      
        If IsArray(fArr) Then
           
             If row_Itog < rd.Row Then
               row_Itog = rd.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog = row_Itog + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog = row_Itog + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Interior.ColorIndex = 38
             
             r.Cells(Row, 3).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
 '            r.Cells(Row, 5).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
        End If
    
    Else
      r.Cells(Row, 3).Formula = "=(" & rs("Adr_Dt") & ")"
'      r.Cells(Row, 5).Formula = "=(" & rs("Adr_Dt") & ")"
    End If
  End If


lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Kt"))), "", Trim(rs("Adr_Kt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Kt")), 500)
      
        If IsArray(fArr) Then
    
             
             If row_Itog1 < RK.Row Then
               row_Itog1 = RK.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
             
             r.Cells(Row, 4).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
'             r.Cells(Row, 6).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
        End If
    
    Else
      r.Cells(Row, 4).Formula = "=(" & rs("Adr_Kt") & ")"
'      r.Cells(Row, 6).Formula = "=(" & rs("Adr_Kt") & ")"
    End If
  End If

      rs.MoveNext
    Loop
End If


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sql = "select * from Result where Ord in(7,8,9) order by KodSpr,Ord "
Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
  
  Set rd = Range("TotaLItogD3")
  nm = rd.Worksheet.name
  k = rd.Column
  row_Itog = 0
  Set RK = Range("TotaLItogK3")
  k1 = RK.Column
  row_Itog1 = 0
  
  Set r = Range("DSItog3")
  Do Until rs.EOF
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown
  Row = r.Rows.Count - 1
  row_Itog = row_Itog + 1
  row_Itog1 = row_Itog1 + 1
  r.Cells(Row, 1) = IIf(IsNull(rs("col2")), "X", rs("col2"))
  r.Cells(Row, 2) = IIf(IsNull(rs("col3")), "X", rs("col3"))
  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), 0, rs("col4"))
  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), 0, rs("col5"))
  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), "X", rs("col6"))
''  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), "X", rs("col4"))
''  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), "X", rs("col5"))
''  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), 0, rs("col6"))
''  r.Cells(Row, 6) = IIf(IsNull(rs("col7")), 0, rs("col7"))
''  r.Cells(Row, 7) = IIf(IsNull(rs("col8")), "X", rs("col8"))
  
  lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Dt"))), "", Trim(rs("Adr_Dt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Dt")), 500)
      
        If IsArray(fArr) Then
           
             If row_Itog < rd.Row Then
               row_Itog = rd.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog = row_Itog + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog = row_Itog + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Interior.ColorIndex = 38
             
             r.Cells(Row, 3).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
 '            r.Cells(Row, 5).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
        End If
    
    Else
      r.Cells(Row, 3).Formula = "=(" & rs("Adr_Dt") & ")"
'      r.Cells(Row, 5).Formula = "=(" & rs("Adr_Dt") & ")"
    End If
  End If

lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Kt"))), "", Trim(rs("Adr_Kt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Kt")), 500)
      
        If IsArray(fArr) Then
    
             
             If row_Itog1 < RK.Row Then
               row_Itog1 = RK.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
             
             r.Cells(Row, 4).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
 '            r.Cells(Row, 6).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
        End If
    
    Else
      r.Cells(Row, 4).Formula = "=(" & rs("Adr_Kt") & ")"
'      r.Cells(Row, 6).Formula = "=(" & rs("Adr_Kt") & ")"
    End If
  End If

      rs.MoveNext
    Loop
End If

'db.Close


finnally:
On Error GoTo 0
On Error Resume Next
'ProtectXlt1
'ActiveSheet.OLEObjects("CmdRecalcItog").Object.Enabled = False
Set R1 = Nothing
Set r = Nothing
Set rd = Nothing
Set RK = Nothing
rs.Close
db.Close
Set rs = Nothing
Set db = Nothing
Kill TempPath & "\SvTemp.mdb"
Exit Sub
err125:
If err = 3204 Then
  'Kill "c:\SvTemp.mdb"
  Kill TempPath & "\SvTemp.mdb"
  Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp", dbLangCyrillic)
  err.Clear
  GoTo GoNext
Else
  'MsgBox Error(err)
  'Resume
  err.Clear
  GoTo finnally
End If

End Sub


Attribute VB_Name = "ModGroupGl"
Option Explicit

Public db As DAO.Database



'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| modCommBars.fOpen()  If GetINI("DSItog3!DataSource") <> "" Then AddComandItog
Public Sub AddComandItog()
Dim CB As CommandBar
'Dim MB As CommandBar
Dim nb As CommandBarButton
Dim idForm$
On Error Resume Next

AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 6, "GroupMain", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
'Set CB = Application.CommandBars("|fffd||fffd||fffd||fffd|")
'If Not CB Is Nothing Then
'    Set NB = CB.Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
'    If NB Is Nothing Then
'    Set NB = CB.Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
'    If NB Is Nothing Then
'        Set NB = CB.Controls.Add(msoControlButton)
'    End If
'    End If
'    NB.OnAction = "GroupMain"
'    NB.Visible = True
'    NB.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
'    NB.TooltipText = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
'    NB.FaceId = 53
'    NB.Style = msoButtonIconAndCaption
'End If
deleteBadNames
HiddenItogRows
'CreateDB   |fffd||fffd||fffd||fffd||fffd||fffd| 01.09.2015
'Set CB = Nothing
'Set NB = Nothing
End Sub

'---------------------------------------------01.12.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (F175)
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| modCommBars.fOpen()  If GetINI("DSItog11!DataSource") <> "" Then AddComandItogMulti
Public Sub AddComandItogMulti()
Dim CB As CommandBar
'Dim MB As CommandBar
Dim nb As CommandBarButton
Dim idForm$
On Error Resume Next

    AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 6, "GroupMainMulti", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
    
    deleteBadNames
    HiddenItogRows

End Sub
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub GroupMain()
Dim nb As CommandBarButton
On Error Resume Next
'Set NB = CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
'If NB Is Nothing Then Set NB = CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
'If NB Is Nothing Then Exit Sub

Application.ScreenUpdating = False
UnProtectXlt1

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If fHasItogi Then
    DeleteItogrows
'    NB.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
'    NB.TooltipText = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
Else
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    ''<Spir>22032016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| f169_22.xlt
    If HasName("Data_Sheet10") Then
        ActiveWorkbook.GetDataToSheet
    End If
    ''<Spir>22032016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

    CreateDB   ''|fffd||fffd||fffd||fffd||fffd||fffd| 01.09.2015
    SaveDB
    ''<Spir>22032016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If HasName("Data_Sheet10") Then
        ActiveWorkbook.SaveDB10
    End If
    ''<Spir>22032016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    deleteBadNames
    UnProtectXlt1
    If AddItogrows() = 0 Then GoTo A1
'    NB.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
'    NB.TooltipText = "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
End If
A1:
ProtectXlt1
Application.ScreenUpdating = True

Application.CalculateFull   '' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|

Set nb = Nothing
End Sub

'---------------------------------------------01.12.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (F175)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub GroupMainMulti()
Dim nb As CommandBarButton
On Error Resume Next

    Application.ScreenUpdating = False
    UnProtectXlt1
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    If fHasItogi Then
        DeleteItogrows
    Else
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        CreateDB   ''|fffd||fffd||fffd||fffd||fffd||fffd| 01.09.2015
        SaveDB
        deleteBadNames
        If AddItogrows() = 0 Then GoTo A1
    End If
A1:
    ProtectXlt1
    Application.ScreenUpdating = True
    
    Set nb = Nothing
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| Svod + Application.UserName |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| data
Public Sub CreateDB()
 Dim tb As TableDef
 Dim fd As Field

    'On Error GoTo ErrorHandler
    If Len(Dir$(fDBName(True))) > 0 Then
        Set db = Nothing
        Kill fDBName(True)
    End If
    Set db = Workspaces(0).CreateDatabase(fDBName(), dbLangCyrillic)
    Set tb = db.CreateTableDef("data")
    Set fd = tb.CreateField("name", dbText)
    tb.Fields.Append fd
    Set fd = tb.CreateField("type", dbText)
    tb.Fields.Append fd
    Set fd = tb.CreateField("value", dbText)
    'fd.AllowZeroLength = True
    tb.Fields.Append fd
    Set fd = tb.CreateField("value_f", dbCurrency)
    tb.Fields.Append fd
    Set fd = tb.CreateField("Data_Sheet", dbText)
    tb.Fields.Append fd
    db.TableDefs.Append tb
    
  Set fd = Nothing
  Set tb = Nothing
 
CreatetbData_Sheets
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| Data_Sheets## |fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub CreatetbData_Sheets()
Dim tb As TableDef
Dim fd As Field
Dim prp As DAO.Property

Dim nn As name, Rds As Range, i As Long, n As Long, sql$

If db Is Nothing Then Set db = Workspaces(0).OpenDatabase(fDBName())

For Each nn In ActiveWorkbook.Names
    If nn.name Like "Data_Sheet##" Then
        If DBHasTable(nn.name) Then db.TableDefs.Delete nn.name
        Set tb = db.CreateTableDef(nn.name)
        Set fd = tb.CreateField("name", dbText)
        tb.Fields.Append fd
        n = 0
        Set Rds = Range(nn.name)
        'SELECT
        '[v].name0 AS [name]
        ', Max([v].a) AS [a]
        ', Max([v].b) AS [b]
        ', Max([v].c) AS [c]
        ', Max([v].d) AS [d]
        ', Max([v].e) AS [e]
        ', Max([v].f) AS [f]
        'FROM
        '(SELECT Left([name],Len([name])-1) AS name0
        ',IIf(Right([name],1)='a',[value],Null) AS a
        ',IIf(Right([name],1)='b',[value],Null) AS b
        ',IIf(Right([name],1)='c',[value],Null) AS c
        ',IIf(Right([name],1)='d',[value],Null) AS d
        ',IIf(Right([name],1)='e',[value],Null) AS e
        ',IIf(Right([name],1)='f',[value],NULL) AS f
        'FROM data
        'WHERE [Data_Sheet] =  'Data_Sheet01'
        ') AS [v]
        'GROUP BY [v].name0
        'ORDER BY [v].name0

        sql = "INSERT INTO %ds ([name]%f)" + _
        " SELECT name0 %m FROM (SELECT Left([name],Len([name])-1) AS name0 %i FROM data WHERE [Data_Sheet] =  '%ds')" + _
        "GROUP BY name0 ORDER BY name0"
        sql = Replace(sql, "%ds", nn.name)
        For i = 1 To Rds.Columns.Count
            If Not CellIncludeInName(Rds.Cells(2, i)) Then GoTo a2
            n = n + 1
            Set fd = tb.CreateField(Chr(96 + n), dbText)
'            Set fd = tb.CreateField(Chr(96 + n), IIf(Rds.Cells(1, i).NumberFormat Like "*[#]*[0]*", dbCurrency, dbText))
            tb.Fields.Append fd
            '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| insert
            sql = Replace(sql, "%f", ", " + fd.name + " %f")
            sql = Replace(sql, "%m", ", Max(" + fd.name + ")" + " %m")
            sql = Replace(sql, "%i", ", IIf(Right([name],1)='" + fd.name + "',[value],Null) AS " + fd.name + "%i")
a2:
        Next i
        db.TableDefs.Append tb
        
        sql = Replace(sql, "%f", "")
        sql = Replace(sql, "%m", "")
        sql = Replace(sql, "%i", "")
        
        Set prp = tb.CreateProperty("sql", dbMemo, sql)
        tb.Properties.Append prp
    End If
A1:
Next nn
Set nn = Nothing
Set Rds = Nothing
Set tb = Nothing
Set prp = Nothing
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd|, |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| data |fffd| Data_Sheet##
Public Sub SaveDB()
Dim rs As DAO.Recordset
Dim tb As TableDef
Dim fd As Field
Dim r As Range, Rds As Range, i As Long, name$, sql$
Dim nn As name

Dim sprefix$
sprefix = "ss*"
'On Error GoTo ErrorHandler
If db Is Nothing Then Set db = Workspaces(0).OpenDatabase(fDBName())
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| data
db.Execute "delete * from data", dbFailOnError
Set rs = db.OpenRecordset("select * from data")
Set r = Range("Data_Cells")

For Each nn In ActiveWorkbook.Names
    If nn.name Like "Data_Sheet##" Then
    If Range(nn.name).Worksheet.Index = ActiveSheet.Index Then
    Set Rds = Range(nn.name)
        For i = 1 To r.Rows.Count
            If r.Cells(i, 1) <> "" Then
                name = r.Cells(i, 1)
                If name Like sprefix And InRangeNames(name, nn.name) Then
                    rs.AddNew
'                    If Mid(name, 22, 5) = "12101" Then
'                        rs.Fields("name").Value = left(name, 21) & "121010" & Mid(name, 28, 4)
'                    Else
                        rs.Fields("name").Value = name
'                    End If
                    rs.Fields("type").Value = r.Cells(i, 2).Value
                    If IsEmpty(Range(name)) = False And IsError(Range(name)) = False Then
                        'rs.Fields("value").Value = Range(name).Value
                        If Mid(Range(name).Value, 18, 5) = "12101" Then
                            rs.Fields("value").Value = left(Range(name).Value, 17) & "121010" & Mid(Range(name).Value, 24, 3)
                        Else
                            rs.Fields("value").Value = Range(name).Value
                        End If
                        If r.Cells(i, 2).Value = "F" And IsNumeric(Range(name).Value) Then
                            rs.Fields("value_f").Value = Range(name).Value
                        End If
                    End If
                    rs.Fields("Data_Sheet").Value = nn.name
                    rs.Update
               End If
            End If
        Next i
    End If
    End If
Next

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Data_Sheet##
For Each nn In ActiveWorkbook.Names
If nn.name Like "Data_Sheet##" Then
If Range(nn.name).Worksheet.Index = ActiveSheet.Index Then
    db.Execute "delete * from " + nn.name, dbFailOnError
    sql = db.TableDefs(nn.name).Properties("sql")
    db.Execute sql
End If
End If
Next nn

Set nn = Nothing
Set r = Nothing
Set Rds = Nothing
Set rs = Nothing
Set tb = Nothing
Set fd = Nothing

End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| Data_Sheet
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'' 25/12/2012 Spiridonova
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini-|fffd||fffd||fffd||fffd||fffd|
''DSItog1!NoProtect = |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| :|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|:
''|fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| :|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| DSItog1!NoProtect
'' 09/01/2017 Spiridonova
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini-|fffd||fffd||fffd||fffd||fffd|
''
Public Function AddItogrows() As Long
Dim nn As name, rs As DAO.Recordset, Rds As Range
Dim sql$, n As Long, k As Long, j As Long, i As Long, sAd$, name$, k0 As Long
Dim sSel$, m As Long, l As Long
Dim s As Variant
Dim n_Beg As Long, n_End As Long

If db Is Nothing Then Set db = Workspaces(0).OpenDatabase(fDBName())

For Each nn In ActiveWorkbook.Names
'---------------------------------------------01.12.2015
'    If nn.name Like "DSItog#" Then
    If (nn.name Like "DSItog#" Or nn.name Like "DSItog##") Then
    If Range(nn.name).Worksheet.Index = ActiveSheet.Index Then
        sql = Trim$(LCase(GetINI(nn.name & "!DataSource")))
        If Len(sql) = 0 Then GoTo A3
        Set rs = db.OpenRecordset(sql)
        If rs.EOF And rs.BOF Then GoTo A3
        Set Rds = Range(nn.name)
        k = rs.RecordCount
        k0 = k0 + k
        n = Rds.Row + Rds.Rows.Count - 1
        Rds.Worksheet.Rows(n & ":" & n + k - 1).Insert Shift:=xlDown
        
        sSel = sGetINI(nn.name & "!MergeCells", "?")
        If Not (sSel = "?") Then
            n_Beg = Mid(sSel, 1, InStr(1, sSel, "-", vbTextCompare) - 1)
            n_End = Mid(sSel, InStr(1, sSel, "-", vbTextCompare) + 1, Len(sSel) - InStr(1, sSel, "-", vbTextCompare))
        End If
        
        rs.MoveFirst
        j = 2
        
        If Not (sSel = "?") Then
            For l = 2 To Rds.Rows.Count - 1
                With Range(Rds.Cells(l, n_Beg), Rds.Cells(l, n_End))
                    .MergeCells = True
                    .WrapText = True
                End With
            Next l
        End If

        Do While Not rs.EOF
         n = 0
         For i = 1 To Rds.Columns.Count
            If Not CellIncludeInName(Rds.Cells(j, i)) Then GoTo a2
            
            If n >= rs.Fields.Count Then GoTo a2
            If rs.Fields(n).name = "Code" Then GoTo a2
            
            If Not IsNull(rs.Fields(n).Value) Then
                Rds.Cells(j, i).Value = rs.Fields(n).Value
'---------------------------------------------01.12.2015
'                name = "si_" + Right$(nn.name, 1) + "_" + Trim(rs.Fields("Code").Value) + Chr(96 + n + 1)
                If nn.name Like "DSItog#" Then name = "si_" + Right$(nn.name, 1) + "_" + Trim(rs.Fields("Code").Value) + Chr(96 + n + 1)
                If nn.name Like "DSItog##" Then name = "si_" + Right$(nn.name, 2) + "_" + Trim(rs.Fields("Code").Value) + Chr(96 + n + 1)
                If Not (HasName(name) Or Trim$(LCase(rs.Fields(n).Value)) = "|fffd||fffd||fffd||fffd||fffd|:") Then
                    sAd = "='" & Rds.Worksheet.name & "'!" & Rds.Cells(j, i).Address
                    ActiveWorkbook.Names.Add name:=name, RefersTo:=sAd
                    fSaveData_Cells name, Rds.Cells(j, i).NumberFormat
                End If
            End If
            n = n + 1
a2:
        Next i
        j = j + 1
        rs.MoveNext
        Loop
    If Rds.Rows.Count > 2 Then
        '' 25/12/2012 Spiridonova
        Range(Rds.Cells(2, 1), Rds.Cells(Rds.Rows.Count - 1, Rds.Columns.Count)).Interior.ColorIndex = xlNone
        sSel = sGetINI(nn.name & "!NoProtect", "?")
        If sSel = "?" Then
            Range(Rds.Cells(2, 1), Rds.Cells(Rds.Rows.Count - 1, Rds.Columns.Count)).Interior.ColorIndex = xlNone
        Else
            m = 1
            s = StrEl(sSel, m)
            Do While Not s = ""
                If s <> "" Then
                    For l = 2 To Rds.Rows.Count - 1
                        If Trim(Rds.Cells(l, 1).Value) = s Then
                            With Range(Rds.Cells(l, 1), Rds.Cells(l, Rds.Columns.Count))
                                .Locked = False
                                .FormulaHidden = False
                                .Interior.ColorIndex = 35
                                .Interior.Pattern = xlSolid
                            End With
                        End If
                    Next l
                End If
                m = m + 1
                s = StrEl(sSel, m)
            Loop
            Call SaveFromData_Itogi
        End If
'        Range(Rds.Cells(2, 1), Rds.Cells(Rds.Rows.Count - 1, Rds.Columns.Count)).Interior.ColorIndex = xlNone
        '' 25/12/2012 Spiridonova
    End If
    End If
    End If
A3:
Next
AddItogrows = k0
Set nn = Nothing
Set rs = Nothing
Set Rds = Nothing
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub DeleteItogrows()
Dim nn As name, sSel$

For Each nn In ActiveWorkbook.Names
'---------------------------------------------01.12.2015
'    If nn.name Like "DSItog#" Then
    If (nn.name Like "DSItog#" Or nn.name Like "DSItog##") Then
    If Range(nn.name).Worksheet.Index = ActiveSheet.Index And Range(nn.name).Rows.Count > 2 Then
        '' 25/12/2012 Spiridonova
        sSel = sGetINI(nn.name & "!NoProtect", "?")
        If sSel <> "?" Then
            Call DeleteFromData_Itogi
            Call InsertToData_Itogi(nn.name)
        End If
        '' 25/12/2012 Spiridonova
        ActiveSheet.Rows(Range(nn.name).Row + 1 & ":" & Range(nn.name).Row + Range(nn.name).Rows.Count - 2).Delete
    End If
'    Range(nn.name).Rows.EntireRow.Hidden = True
    End If
Next

DeleteFromData_Cells
HiddenItogRows
Set nn = Nothing
End Sub

Public Sub HiddenItogRows()
Dim nn As name

For Each nn In ActiveWorkbook.Names
'---------------------------------------------01.12.2015
'    If nn.name Like "DSItog#" Then
    If (nn.name Like "DSItog#" Or nn.name Like "DSItog##") Then
        If Range(nn.name).Worksheet.Index = ActiveSheet.Index Then
                Range(nn.name).Rows.EntireRow.Hidden = True
        End If
    End If
Next
Set nn = Nothing
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| DataSheets## |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Public Sub SortDataSheets()
Dim nn As name, r As Range, Rds As Range

Application.ScreenUpdating = False
UnProtectXlt1

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| Data_Sheet |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
For Each nn In ActiveWorkbook.Names
    If nn.name Like "Data_Sheet##" Then
    If Range(nn.name).Worksheet.Index = ActiveSheet.Index Then
        Set r = Range(nn.name)
        If r.Rows.Count < 3 Then GoTo A1
        Set r = Range(r.Cells(2, 1), r.Cells(r.Rows.Count - 1, r.Columns.Count))
        r.EntireRow.Delete
    End If
    End If
A1:
Next nn

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Dim rs As DAO.Recordset
Dim sql$, name$, n As Long, k As Long, nameds$, sAd$, i As Long, j As Long, s$

If db Is Nothing Then Set db = Workspaces(0).OpenDatabase(fDBName())

sql = "select count(*) as count, Data_Sheet from data where name Like 'ss*a' GROUP BY Data_Sheet"
Set rs = db.OpenRecordset(sql)
Do While Not rs.EOF
    name = rs.Fields("Data_Sheet").Value
    If Range(name).Worksheet.Index = ActiveSheet.Index Then
        k = rs.Fields("count").Value
        n = Range(name).Row + Range(name).Rows.Count - 1
        Range(name).Worksheet.Rows(n & ":" & n + k - 1).Insert Shift:=xlDown
    End If
rs.MoveNext
Loop




'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| data
'sql = "select * from data ORDER BY Data_Sheet, name"
'Set rs = db.OpenRecordset(sql)
'Do While Not rs.EOF
'    If nameds <> rs.Fields("Data_Sheet").value Then
'        nameds = rs.Fields("Data_Sheet").value
'        Set R = Range(nameds)
'        k = 1
'    End If
'    If name <> Left$(rs.Fields("name").value, Len(rs.Fields("name").value) - 1) Then
'        name = Left$(rs.Fields("name").value, Len(rs.Fields("name").value) - 1)
'        k = k + 1
'    End If
'    R.Cells(k, rs.Fields("column").value).value = rs.Fields("value").value
'
'    sAd = "='" & R.Worksheet.name & "'!" & R.Cells(k, rs.Fields("column").value).Address
'    ActiveWorkbook.Names.Add name:=rs.Fields("name").value, RefersTo:=sAd
'rs.MoveNext
'Loop



''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| data
'sql = "select * from data ORDER BY Data_Sheet, name"
'Set rs = db.OpenRecordset(sql)
'Do While Not rs.EOF
'    If nameds <> rs.Fields("Data_Sheet").value Then
'        nameds = rs.Fields("Data_Sheet").value
'        Set R = Range(nameds)
'        k = 1
'    End If
'    If name <> Left$(rs.Fields("name").value, Len(rs.Fields("name").value) - 1) Then
'        name = Left$(rs.Fields("name").value, Len(rs.Fields("name").value) - 1)
'        k = k + 1
'    End If
'    R.Cells(k, rs.Fields("column").value).value = rs.Fields("value").value
'
'    sAd = "='" & R.Worksheet.name & "'!" & R.Cells(k, rs.Fields("column").value).Address
'    ActiveWorkbook.Names.Add name:=rs.Fields("name").value, RefersTo:=sAd
'rs.MoveNext
'Loop

''sql = "GROUP BY substring"
''sql = "select Sum($b), sum($c) from $Data_Sheet01 GROUP BY $a"

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| Data_Sheet
For Each nn In ActiveWorkbook.Names
    If nn.name Like "Data_Sheet##" Then
    If Range(nn.name).Worksheet.Index = ActiveSheet.Index Then
    sql = "select * from " + nn.name + " order by name"
    Set rs = db.OpenRecordset(sql)
    If rs.EOF And rs.BOF Then GoTo A3
    rs.MoveFirst
    Set Rds = Range(nn.name)
    k = 2
    Do While Not rs.EOF
        n = 0
        For j = 1 To Rds.Columns.Count
            If CellIncludeInName(Rds.Cells(1, j)) Then
                n = n + 1
                Rds.Cells(k, n).Value = rs.Fields(Chr(96 + n)).Value
                sAd = "='" & Rds.Worksheet.name & "'!" & Rds.Cells(k, n).Address
                ActiveWorkbook.Names.Add name:=rs.Fields("name").Value + Chr(96 + n), RefersTo:=sAd
            End If
        Next j
    k = k + 1
    rs.MoveNext
    Loop
    End If
    End If
A3:
Next
ProtectXlt1
Application.ScreenUpdating = True


'Set W = Nothing
Set nn = Nothing
Set r = Nothing
Set Rds = Nothing
'Set rs = Nothing
'Set rs1 = Nothing
'Set db = Nothing
End Sub





Attribute VB_Name = "ModGroupSl"
Option Explicit


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
Public Sub deleteBadNames()
Dim n As name, r As Range, s As Variant
On Error Resume Next
For Each n In ActiveWorkbook.Names
  Set r = Range(n.name)
  If r Is Nothing Then
        n.Delete
  End If
Set r = Nothing
Next
End Sub

Public Function fHasItogi() As Boolean
Dim nn As name
fHasItogi = False
On Error GoTo A1
For Each nn In ActiveWorkbook.Names
'---------------------------------------------01.12.2015
'    If nn.name Like "DSItog#" And Range(nn.name).Worksheet.Index = ActiveSheet.Index Then
    If (nn.name Like "DSItog#" Or nn.name Like "DSItog##") And Range(nn.name).Worksheet.Index = ActiveSheet.Index Then
        If Range(nn.name).Rows.Count > 2 Then fHasItogi = True: GoTo A1
    End If
    If nn.name Like "si*" And Range(nn.name).Worksheet.Index = ActiveSheet.Index Then
        fHasItogi = True
        GoTo A1
    End If
Next nn
A1:
Set nn = Nothing
End Function

Public Function DBHasTable(sname As String) As Boolean
Dim fl As Boolean
Dim tb As TableDef
For Each tb In db.TableDefs
    If tb.name = sname Then
        fl = True
        Exit For
    End If
Next tb
DBHasTable = fl
Set tb = Nothing
End Function

Public Function DBHasColumn(tb As TableDef, sname As String) As Boolean
Dim fl As Boolean
Dim fd As Field
For Each fd In tb.Fields
    If fd.name = sname Then
        fl = True
        Exit For
    End If
Next fd
DBHasColumn = fl
Set fd = Nothing
End Function

'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| property
Public Function DBTBHasProperti(tb As TableDef, sname As String) As Boolean
Dim fl As Boolean, i As Long
Dim prp As DAO.Property
'On Error GoTo A1
For Each prp In tb.Properties
    If prp.name = sname Then
        fl = True
        Exit For
    End If
Next prp
A1:
DBTBHasProperti = fl
Set prp = Nothing
End Function


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(a, b, c ...)
Public Function CellIncludeInName(r As Range) As Boolean
CellIncludeInName = False
    If r.MergeCells = True Then
        If Not r.MergeArea.Address Like r.Address + "*" Then GoTo a2
    End If
    If Not r.Interior.ColorIndex = 35 Then GoTo a2
    
    ''<Spir>20.06.2016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd|169
'    If left(r.Formula, 1) = "=" Then GoTo a2 'Or Left(Rds.Cells(Rds.Rows.Count, i).Formula, 1) = "=" Then GoTo A2
    
CellIncludeInName = True
a2:
End Function

'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| true
Function InRangeNames(name1$, name2$) As Boolean
Dim rng1 As Range, rng2 As Range
InRangeNames = False
On Error GoTo A1
Set rng1 = Range(name1)
Set rng2 = Range(name2)

    If rng1.Parent.name = rng2.Parent.name And rng1.Worksheet.Index = ActiveSheet.Index Then
        If Union(rng1, rng2).Address = rng2.Address Then
        InRangeNames = True
        End If
    End If
A1:
Set rng1 = Nothing
Set rng1 = Nothing
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|.|fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd|.|fffd|. |fffd||fffd||fffd||fffd||fffd| =
'sKey = "DSItog11!DataSource"
Public Function GetINI(sKey$) As String
Dim sIniFile$, sSection$
Dim sTmp$, flSection As Boolean, flKey As Boolean, n As Long, i As Long, s$

GetINI = ""
sSection = ActiveWorkbook.name
i = InStr(sSection, ".")
If i > 0 Then sSection = left$(sSection, i - 1)
sSection = left$(sSection, Len(sSection) - 1)
sSection = "[[]" + sSection + "]"
sKey = sKey + "*=*"
'|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sIniFile = ThisWorkbook.Path & "\lnc2.ini"
If Len(Dir$(sIniFile)) > 0 Then
Open sIniFile For Input As #1
    Do
    Line Input #1, sTmp
        If UCase(Trim$(sTmp)) Like UCase("rem*") Then GoTo a2
        If UCase(Trim$(sTmp)) Like UCase(";*") Then GoTo a2
        If flSection = True And flKey = True And sTmp Like "*=*" Then GoTo A1
        If flSection = True And sTmp Like "[[]*[]]" Then GoTo A1
        If flSection = True And sTmp Like sKey Then flKey = True: n = n + 1
        If flSection = True And flKey = True Then
             If n = 1 Then
                i = InStr(sTmp, "=")
                If i > 0 Then sTmp = Mid$(sTmp, i + 1)
             End If
             s = s & sTmp + " "
        End If
        If sTmp Like sSection Then flSection = True
a2:
    Loop While Not EOF(1)
A1:
Close #1
GetINI = s
End If
End Function

Public Sub DeleteFromData_Cells()
Dim r As Range, i As Long
Set r = Range("Data_Cells")
fUnProtect True, r.Worksheet.Index
For i = r.Rows.Count To 1 Step -1
    If r.Cells(i, 1).Value Like "si*" Then
        r.Rows(i).Delete Shift:=xlUp
    End If
Next i
fUnProtect False, r.Worksheet.Index
Set r = Nothing
End Sub

Public Function fDBName(Optional flmdb As Boolean = False)
Dim s$
s = Environ("Temp") + "\Svod" + ActiveWorkbook.name
''<Spir>30072016
If Range("Data_Cells").Cells(1, 7).Value > 0 Then s = s & Trim(str(Range("Data_Cells").Cells(1, 7).Value))
'If HasName("Kod_OTD") Then s = s + Range("Kod_OTD").Value
If flmdb Then s = s + ".mdb"
fDBName = s
End Function

Public Sub aaa()
'Set db = Nothing
MsgBox LCase("|fffd||fffd||fffd||fffd||fffd|")
End Sub

'' 25/12/2012 Spiridonova
Public Sub DeleteFromData_Itogi()
Dim r As Range, i As Long
Set r = Range("Data_Itogi")
'fUnProtect True, R.Worksheet.Index
'For i = R.Rows.Count To 1 Step -1
    If r.Rows.Count > 2 Then
        r.Rows("2:" & r.Rows.Count - 1).Delete Shift:=xlUp
    End If
'Next i
'fUnProtect False, R.Worksheet.Index
Set r = Nothing
End Sub

'' 25/12/2012 Spiridonova
Public Sub InsertToData_Itogi(NameItog$)
'' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|. Data_Itogi |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'' NameItog - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| DSItog |fffd||fffd| ini- |fffd||fffd||fffd||fffd||fffd|
Dim r As Range, i As Long
Dim nn As name

Set r = Range("Data_Itogi")
fUnProtect True, r.Worksheet.Index
For Each nn In ActiveWorkbook.Names
    If nn.name Like "si_" & Right$(NameItog, 1) & "_*" Then
        If Range(nn.name).Locked = False And Range(nn.name).Value <> 0 And Range(nn.name).NumberFormat = "0.00" Then
            r.Rows(r.Rows.Count & ":" & r.Rows.Count).Insert Shift:=xlDown
            r.Cells(r.Rows.Count - 1, 1).Value = nn.name
            r.Cells(r.Rows.Count - 1, 2).Value = Range(nn.name).Value
        End If
    End If
Next
fUnProtect False, r.Worksheet.Index
Set r = Nothing

End Sub

'' 25/12/2012 Spiridonova
Public Sub SaveFromData_Itogi()
'' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd|. Data_Itogi |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim r As Range, i As Long
Dim nn As name

On Error Resume Next

Set r = Range("Data_Itogi")
'fUnProtect True, R.Worksheet.Index
For i = 2 To r.Rows.Count - 1
    If Range(r.Cells(i, 1).Value).Locked = False Then
        Range(r.Cells(i, 1).Value).Value = r.Cells(i, 2).Value
    End If
Next i
'fUnProtect False, R.Worksheet.Index
Set r = Nothing

End Sub


Attribute VB_Name = "ModNewRasstanovka"
Dim v() As String
'Dim SP() As String
Public plGR As Boolean ''12.12.2014


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
Public Sub DataEndInsert()

Dim cData As String

'ShowRekv
Application.ScreenUpdating = False
fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
fUnProtect True
'fSaveFilterAndFormat <SPIR>19.11.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| Module1.fGetDdataVnew |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Format =Data_KLD(000 0 00 00000 00 0000 000) |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|

If (left(Range("Kod_OTD").Cells(1, 1), 2) = "00" And Mid(Range("Kod_OTD").Cells(1, 1), 3, 1) <> "0") Then plGR = True Else plGR = False ''<Spir> ~7351 09.11.2018
'If left(Range("Kod_OTD").Cells(1, 1), 2) = "00" Then plGR = True Else plGR = False ''12.12.2014

 '|fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If sGetINI("idForm", "?") = "125" Then DataEndInsert125
 '|fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If sGetINI("idForm", "?") = "725" Then DataEndInsert725
 '|fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 12.12.2014
If sGetINI("idForm", "?") = "125_1" Then DataEndInsert125_1
 '|fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|    <SPIR>26.03.2012
If sGetINI("idForm", "?") = "AddVDE" Then F1251VDE Range("Kod_VDE").Cells(1, 1)
'|fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sGetINI("idForm", "?") = "169" Then
        
    F1251VDE Range("Kod_VDE").Cells(1, 1)
    
    If HasName("Kod_NCH") Then
        'F1251VDE Range("Kod_VDE").Cells(1, 1)
        If Len(Range("Kod_NCH").Value) > 0 Then
            fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
            fData_Copy "Data_PLS0", True
            fData_Filter "Data_PLS0", "?" & Range("Kod_NCH").Value & "*"
        End If
    End If

  If HasName("Itog1") = False Then
    F169Itogo
  Else
    F169_newItogo
  End If


End If
'itogi
'27/12/2010 |fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sGetINI("idForm", "?") = "169N" Or sGetINI("idForm", "?") = "169N2013" Or sGetINI("idForm", "?") = "169N2015" Or sGetINI("idForm", "?") = "169N2016" Then
        
    F1251VDE Range("Kod_VDE").Cells(1, 1)
    
    If HasName("Kod_NCH") Then
        'F1251VDE Range("Kod_VDE").Cells(1, 1)
        If Len(Range("Kod_NCH").Value) > 0 Then
            fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
            fData_Copy "Data_PLS0", True
            fData_Filter "Data_PLS0", "?" & Range("Kod_NCH").Value & "*"
        End If
    End If

'  If HasName("Itog1") = False Then
'    F169Itogo
'  Else
'    F169_newItogo
'  End If


End If

'''' Spiridonova 11.07.2012
'' |fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|)
'If FlagPictures Then
'    Application.ActiveWorkbook.DataEndInsertPic
'End If
'''' Spiridonova 11.07.2012

cmdBarsShow '' |fffd||fffd||fffd| |fffd| 110IN
ShowRekv

On Error Resume Next
Application.Run ActiveWorkbook.name & "!" & "fGoSubXLT"

Application.Run ActiveWorkbook.name & "!" & "FormResults"   ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| FZ_Akt 12.12.2012

'''' Spir 31/03/2015
'    ActiveWorkbook.Range("Naim_STOPdata").FormulaLocal = "=SetStrData(A1;Kod_STOPdata)"
'    ActiveWorkbook.Range("Naim_STOPdata").Calculate
'
'    ActiveWorkbook.Range("Naim_MODdata").FormulaLocal = "=SetStrData(A2;Kod_MODdata)"
'    ActiveWorkbook.Range("Naim_MODdata").Calculate
'    MsgBox "Formula"
'''' Spir 31/03/2015


fUnProtect False, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
'fUnProtect False
Application.ScreenUpdating = True
Application.EnableEvents = True
Application.Calculation = xlAutomatic

''<Spir>29.08.2017 ~3367, 3368
Application.CalculateFull
cData = Range("Naim_STOPdata").Value
Range("Naim_STOPdata").FormulaLocal = ""
Range("Naim_STOPdata").Value = cData

cData = Range("Naim_MODdata").Value
Range("Naim_MODdata").FormulaLocal = ""
Range("Naim_MODdata").Value = cData
fUnProtect False
''<Spir>29.08.2017 ~3367, 3368

End Sub

Public Function fRasstMain() As Long


Dim r As Range, kk As Long
Dim i As Long, j As Long, sKod$, sKod1$, sDSName$, Row As Long, s$, indWS As Long, k As Long ', sName$

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  "Data_Spr1" |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| VarForm mdLib
Application.ScreenUpdating = False
UnProtectXlt1
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Data_FKR1 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd| |fffd|.|fffd|.
'If sEmptyName("Data_FKR1") = 0 Then FKRFormat
'fSaveFormat '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|


i = fAvteZapolnenie
If i <> -1 Then Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
If EmptyName("Data_Spr1") < 2 Then GoTo a2 '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

Set r = Range("Data_Spr1")
r.Sort Key1:=r.Cells(1, 1), Order1:=xlAscending
For i = 1 To r.Rows.Count
    sKod = Trim$(r.Cells(i, 1))   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    If EmptyName(sKod) > 0 Then GoTo A1    '|fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    If left$(sKod, 2) <> "ss" Then GoTo A1
    If sKod Like "*[!a-z][a-z]" Then sKod = left$(sKod, Len(sKod) - 1)
    If sKod Like "*[a-z][a-z]" Then sKod = left$(sKod, Len(sKod) - 2)
    sKod = Mid$(sKod, 3)
    If sKod <> sKod1 Then
        sKod1 = sKod
'        sDSName = "Data_Sheet"
        '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ssXXYYYYYY...  XX - |fffd||fffd||fffd||fffd||fffd| Data_Sheet|fffd||fffd|
        If ActiveWorkbook.Worksheets(1).name = "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 1" Or sGetINI("idForm", "?") = "173" Then  'anketa
            sDSName = "Data_Sheet" & left$(sKod, 2)
            If sGetINI("idForm", "?") = "173" Then sDSName = "Data_Sheet" & left$(sKod, 1)
            '|fffd||fffd||fffd||fffd| |fffd||fffd| Data_Sheet01 |fffd| Data_Sheet1
    '        If sEmptyName(sDSName) = 0 Then fMsgbox "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & sDSName: GoTo A1
            Row = Range(sDSName).Row + Range(sDSName).Rows.Count - 1
            ActiveWorkbook.Worksheets(Range(sDSName).Worksheet.Index).Rows(Row).Insert Shift:=xlDown
            fInsertNameStr sDSName, sKod ', 0, kl
            'Range(sDSName).Rows(Range(sDSName).Rows.Count).Insert Shift:=xlDown
    '        fInsertNameAndKlass sDSName, Mid$(sKod, 3)
        Else
            indWS = fRasstss(sKod)
            If indWS > 0 Then
                sDSName = "Data_Sheet" & Trim$(str(indWS))
                Row = Range(sDSName).Row + Range(sDSName).Rows.Count - 1
                ActiveWorkbook.Worksheets(Range(sDSName).Worksheet.Index).Rows(Row).Insert Shift:=xlDown
                For j = 1 To UBound(v, 1)
                    s = v(j, 0)
                    If Len(s) > 0 Then ActiveWorkbook.Worksheets(Range(sDSName).Worksheet.Index).Cells(Row, j) = s ' |fffd||fffd||fffd|
                    s = v(j, 1)
                    If Len(s) > 0 Then ActiveWorkbook.Worksheets(Range(sDSName).Worksheet.Index).Cells(Row, j) = s '  |fffd||fffd||fffd|
                Next j
                fInsertNameStr sDSName, sKod, 0, UBound(v, 1) + 1
                fExecProc indWS, Row, sKod '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
            End If
        End If
    End If
A1:
Next i
Set r = Nothing
'ProtectXlt1
a2:
fShowCmdInsDelRow

fRasstMain = -1
End Function
'
Public Function fRasstss(ByVal sKod$) As Long
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| sKod |fffd| |fffd||fffd||fffd||fffd| WS.ind
Dim a As Worksheet
Dim iTipe As Long, sTipeSp$, i As Long, j As Long, s$, sSp$, sname$, sNameStr$, sKodStr$, S3$, sFKod$
Dim k0 As Long, k As Long, sKod1$, sKod3$, m As Long, k4 As Long, ii As Long, sTipeSp4$
Dim flUn As Long   '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| GoTo A2 >1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'Dim V() As String
'If Len(sKod) = 0 Then Exit Function



For Each a In ActiveWorkbook.Worksheets
    If a.Visible = False Then GoTo A1
    sTipeSp = sGetINI(a.name & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
    sKodStr = sGetINI(a.name & "!Kod", "?")
    sNameStr = sGetINI(a.name & "!Name", "?")
    If sTipeSp = "?" Or sKodStr Like "*$*" Then GoTo A1
    i = MaxStrEl(sKodStr): j = MaxStrEl(sNameStr)
    If j > i Then i = j
    If i > 0 Then ReDim v(i, 2) Else GoTo A1
iTipe = VarAddForm(a.name)
k0 = 1: k = 0
''<SPIR>22012016 |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd|
If iTipe = 1 And sTipeSp <> "Data_SGU" Then
    sTipeSp = sReplace(sTipeSp, "Data_SGU", "")
        For i = 1 To StrEl(sTipeSp)
        sSp = StrEl(sTipeSp, i)
        If sSp Like "Data_FKR" And sSp Like "Data_SGU" Then
            If Len(fIncludeSpr(left$(sKod, Len(sKod) - 3), "Data_FKR")) > 0 Then
                        sname = fIncludeSpr(Right$(sKod, 3), "Data_SGU")
                        sFKod = fFormat(left$(sKod, Len(sKod) - 3), "Data_FKR") & sR & Right$(sKod, 3)
            End If
        Else
            sname = fIncludeSpr(sKod, sSp)
            sFKod = fFormat(sKod, sSp)
        End If
        If Len(sname) > 0 Then
            j = Val(StrEl(sKodStr, 1)): v(j, 0) = sFKod
            j = Val(StrEl(sNameStr, 1)): v(j, 1) = sname
        GoTo a2 'flUn = flUn + 1
        End If
    Next i
End If
If iTipe = 1 And sTipeSp = "Data_SGU" Then
    sSp = "Data_SGU"
    sname = fIncludeSpr(sKod, sSp)
    sFKod = fFormat(sKod, sSp)
    If Len(sname) > 0 Then
        j = Val(StrEl(sKodStr, 1)): v(j, 0) = sFKod
        j = Val(StrEl(sNameStr, 1)): v(j, 1) = sname
        GoTo a2 'flUn = flUn + 1
    End If
End If
''<SPIR>22012016 |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd|
If iTipe = 2 Or iTipe = 3 Then
    For i = 1 To StrEl(sTipeSp)
        sSp = StrEl(sTipeSp, i)
        k0 = k0 + k
        k = fLenSpr(sSp)
        sKod1 = Mid$(sKod, k0, k)
        sname = fIncludeSpr(sKod1, sSp)
        If Len(sname) = 0 Then GoTo A1
        j = Val(StrEl(sNameStr, i))
        If sname = "TXT" Then j = 0
        If j > 0 Then v(j, 1) = sname
        m = Val(StrEl(sKodStr, i))
        If iTipe = 3 And m > 0 Then v(m, 0) = fFormat(sKod1, sSp)
        If iTipe = 2 Then sKod3 = sKod3 & fFormat(sKod1, sSp) & sR
    Next i
    If iTipe = 2 Then
        j = Val(StrEl(sKodStr, 1))
        If Right$(sKod3, 1) = sR Then sKod3 = left$(sKod3, Len(sKod3) - 1)
        'S3 = sReplace(sKod3, sR, "")
        'If S3 = sKod Then v(j, 0) = sKod3 Else v(j, 0) = sKod
        v(j, 0) = sKod3
    End If
    GoTo a2 'flUn = flUn + 1
End If
If iTipe = 4 Then
    j = Val(StrEl(sKodStr, 1))
    m = Val(StrEl(sNameStr, 1))
    k4 = StrEl(sTipeSp, 0, ";")
    For ii = 1 To k4
        k0 = 1: k = 0
        sTipeSp4 = StrEl(sTipeSp, ii, ";")
        'sTipeSp4 = sReplace(sTipeSp4, "Data_SGU", "")
        For i = 1 To StrEl(sTipeSp4)
            sSp = StrEl(sTipeSp4, i)
            k0 = k0 + k
            k = fLenSpr(sSp)
            sKod1 = Mid$(sKod, k0, k)
            sname = fIncludeSpr(sKod1, sSp)
            If Len(sname) = 0 Then GoTo A3
            sFKod = sFKod & fFormat(sKod1, sSp) & sR
            'j = Val(StrEl(sNameStr, i))
            'If j > 0 Then V(j, 1) = sName
            'm = Val(StrEl(sKodStr, i))
            'If iTipe = 3 And m > 0 Then V(m, 0) = sKod1
            If i = 1 Then v(m, 1) = sname
        Next i
        If Right$(sFKod, 1) = sR Then sFKod = left$(sFKod, Len(sFKod) - 1)
         v(j, 0) = sFKod
         
        GoTo a2 'flUn = flUn + 1
A3:
    Next ii
End If

A1:
Next

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| xls
'Debug.Print sKod & "- |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
Exit Function
a2:
fRasstss = a.Index
'For i = 1 To UBound(v, 1)
''Debug.Print i & " |fffd||fffd||fffd| = " & v(i, 0) & " |fffd||fffd||fffd| =  " & v(i, 1)
'Next i
End Function




Public Function fIncludeSpr(ByVal sKod$, ByVal sSpName$) As String
'|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim r As Range, i As Long
Dim i1 As Long, i2 As Long, sL$, s$, sn$

If Len(sKod) = 0 And sSpName Like "Data_TXT0*" Then
i1 = InStr(8, sSpName, "(")
i2 = InStr(i1 + 1, sSpName, ")")
sL = Mid$(sSpName, i1 + 1, i2 - i1 - 1)
If sEmptyName(sL) = 1 Then
    s = Range(sL).Value
    If Len(s) > 0 Then fIncludeSpr = s: Exit Function
End If
End If
If Len(sKod) = 0 Or Len(sSpName) = 0 Then Exit Function
If sSpName Like "Data_TXT*" Then fIncludeSpr = "TXT": Exit Function
Set r = Range(sSpName)
If sSpName = "Data_PLS0" Then sKod = "?" & Mid$(sKod, 2)
For i = 1 To r.Rows.Count
    If r.Cells(i, 1) Like sKod Then
        sn = Trim$(r.Cells(i, 2))
        If Len(sn) = 0 Then sn = " "
        fIncludeSpr = sn
        Exit Function
    End If
Next i
Set r = Nothing
End Function


Public Function fLenSpr(ByVal sSpName$) As Long
Dim r As Range, k As Long, i As Long

If sSpName Like "Data_TXT*" Then
i = InStr(8, sSpName, "(")
If i > 0 Then fLenSpr = Val(Mid$(sSpName, 9, i - 9)): Exit Function
End If
Set r = Range(sSpName)
k = Len(Trim$(r.Cells(1, 1)))
If k > 0 Then fLenSpr = k: Exit Function
For i = 1 To r.Rows.Count
k = Len(Trim$(r.Cells(i, 1)))
If k > 0 Then fLenSpr = k: Exit Function
Next i
Set r = Nothing
End Function



Attribute VB_Name = "ModRows"

Public Sub DeleteRows()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Dim sMsg$, R0 As Long, i As Long, R1 As Long

If sGetINI("idForm", "?") = "125" Or sGetINI("idForm", "?") = "725" Or sGetINI("idForm", "?") = "125_1" Then
sMsg = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
If Selection.Columns.Count <> Cells.Columns.Count Then MsgBox sMsg: Exit Sub
R0 = Selection.Row
R1 = R0 + Selection.Rows.Count - 1
For i = R1 To R0 Step By - 1
    fDeleteRow i
Next i
Else
    fDeleteRow
End If
End Sub

Public Sub addNewRow(r As Range)
Dim Row As Long

Row = r.Row + r.Rows.Count - 1
Rows(Row).Insert Shift:=xlDown
End Sub

Public Function fDeleteRow(Optional Row As Long)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim n As name, r As Range, Wind As Long
Dim R0 As Long, fl As Boolean, sMsg$, i As Long, s$, j As Long, s1$

On Error Resume Next
Application.ScreenUpdating = False
sMsg = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
If Selection.Columns.Count <> Cells.Columns.Count Then MsgBox sMsg: Exit Function
fl = False
R0 = IIf(Row = 0, Selection.Row, Row)
Wind = ActiveWorkbook.ActiveSheet.Index
For Each n In ActiveWorkbook.Names
    If UCase(n.name) Like "DATA_SHEET*" Then '31.10.2008
        Set r = Range(n.name)
        If r.Worksheet.Index = Wind Then
            If R0 > r.Row And R0 < r.Row + r.Rows.Count - 1 Then fl = True: Exit For
        End If
    End If
Next
If fl = False Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd|.|fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Function
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - 1 |fffd||fffd||fffd||fffd||fffd||fffd|
If Row = 0 Then
    If Selection.Rows.Count > 1 Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!":  Exit Function
    If MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| " & str(R0) & " ?", 4 + 256, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|") = 7 Then Exit Function
End If
fUnProtect True
R0 = R0 - r.Row + 1
For i = 1 To r.Columns.Count
    s = ""
    s = r.Cells(R0, i).name.name
    If Len(s) > 0 Then
        j = j + 1
        ActiveWorkbook.Names(s).Delete
        If j = 1 Then s1 = left$(s, Len(s) - 1) '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd|.|fffd|. |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd|
    End If
Next i

Application.ScreenUpdating = True
If Row > 0 Then Rows(Row).Delete Else Selection.Delete
Application.ScreenUpdating = False

If sGetINI("idForm", "?") = "125" Then
  If HasName("Total_Debet") = False Then
     F1251deleteFormuls
     F1251Itogo
  End If
End If
'-----------------------------------------------------------16.03.2012
If sGetINI("idForm", "?") = "725" Then
  If HasName("Total_Debet") = False Then
     F1251deleteFormuls
     F725_Itogo
  End If
End If
'-----------------------------------------------------------16.03.2012
'-----------------------------------------------------------12.12.2014
If sGetINI("idForm", "?") = "125_1" Then
  If HasName("Total_Debet") = False Then
     F1251deleteFormuls
     F125_1Itogo
  End If
End If
'-----------------------------------------------------------12.12.2014
'-----------------------------------------------------------31.10.2008
If sGetINI("idForm", "?") = "169" Then
  If HasName("Itog1") = False Then
'    F169Itogo
    itogi   '|fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  End If
End If
'-----------------------------------------------------------31.10.2008
'-----------------------------------------------------------27.12.2010
'If sGetINI("idForm", "?") = "169N" Then
'  If HasName("Itog1") = False Then
''    F169Itogo
'    itogi   '|fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'  End If
'End If
'-----------------------------------------------------------27.12.2010
If UCase(sGetINI("idForm", "?")) = "PZ_PL_IZ" Then
  If r.Rows.Count < 3 Then
    CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = False
    CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = False
  Else
    CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = True
    CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = True
  End If
  
End If

fUnProtect False
If r.Rows.Count < 3 Then fShowCmdInsDelRow    'fShowCmdDelete  '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|

Set r = Range("Data_Cells")
fUnProtect True, r.Worksheet.Index
For i = r.Rows.Count To 1 Step -1
    If r.Cells(i, 1) Like s1 & "[a-z]" Or r.Cells(i, 1) Like s1 & "[a-z][a-z]" Then
        r.Rows(i).Delete Shift:=xlUp
    End If
Next i
fUnProtect False, r.Worksheet.Index
Application.ScreenUpdating = True
Set r = Nothing
End Function

Public Function fInsertNameStr(ByVal sDSName$, ByVal sKod$, Optional Row As Long = 0, Optional k As Long = 1, Optional ArrCol As Variant) As Boolean
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| row = |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 To R.Rows.Count
Dim j As Long, fl As Boolean, s$, n As Long
Dim sname$, sAd$, sF$
Dim r As Range
Dim i  As Long
Dim flprn As Boolean
Dim sFormatCell As String

On Error GoTo err

flprn = False
Set r = Range(sDSName)
'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| -1 |fffd|.|fffd|. |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
If Row > r.Rows.Count Then Debug.Print "fInsertNameStr |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| " & str(Row) & " |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Function
If Row = 0 Then Row = r.Rows.Count - 1
k = 1
For j = 1 To r.Columns.Count
    If left(r.Cells(r.Rows.Count, j).Formula, 1) = "=" Then
        r.Cells(r.Rows.Count, j).Copy r.Cells(Row, j)
    End If
    If j >= k Then
        fl = False
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| True |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        If r.Cells(Row, j).MergeCells = True Then
            If s = r.Cells(Row, j).MergeArea.Address Then fl = True
            s = r.Cells(Row, j).MergeArea.Address
        Else
            s = ""
        End If
        'True |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
        If Len(fCellsName(r.Cells(Row, j))) > 0 Then fl = True
        'True |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        sF = r.Cells(Row, j).Formula
        If Not (r.Cells(Row, j).Interior.ColorIndex = 35 Or left(sF, 1) = "=" Or left(r.Cells(r.Rows.Count, j).Formula, 1) = "=") Then fl = True
        'False - |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        If fl = False Then
            n = n + 1
            sname = "ss" & sKod
            If n > 26 Then sname = sname & "a" & Chr(96 + n - 26) Else sname = sname & Chr(96 + n)
            sAd = "='" & r.Worksheet.name & "'!" & r.Cells(Row, j).Address
            ActiveWorkbook.Names.Add name:=sname, RefersTo:=sAd
'-----------------------------------------------------------<SPIR> 15.10.2015 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
            '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd|. Data_CollFormat
            If gCollFormat.Count > 0 Then
                If Not IsEmpty(gCollFormat.Item(sDSName)(j)) Then
                    sFormatCell = gCollFormat.Item(sDSName)(j)
                Else
                    sFormatCell = r.Cells(Row, j).NumberFormat
                End If
            Else
                sFormatCell = r.Cells(Row, j).NumberFormat
            End If
            
              If IsArray(ArrCol) Then
                On Error Resume Next
                i = LBound(ArrCol)  ' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                If err <> 0 Then
                    fSaveData_Cells sname, sFormatCell
                Else
                  For i = LBound(ArrCol) To UBound(ArrCol)
                    If j = ArrCol(i) Then
                      flprn = True
                      Exit For
                    End If
                  Next i
                  If flprn = False Then fSaveData_Cells sname, sFormatCell
                  flprn = False
                End If
              Else
                  fSaveData_Cells sname, sFormatCell
              End If
              On Error GoTo err
'-----------------------------------------------------------<SPIR> 15.10.2015 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'---------------------------------------------------------------------------15.03.2012
'---------------------------------------------------------------------------31.10.2008
'              If IsArray(ArrCol) Then
'                On Error Resume Next
'                i = LBound(ArrCol)  ' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'                If err <> 0 Then
'                    fSaveData_Cells sName, r.Cells(Row, j).NumberFormat
'                Else
'                  For i = LBound(ArrCol) To UBound(ArrCol)
'                    If j = ArrCol(i) Then
'                      flprn = True
'                      Exit For
'                    End If
'                  Next i
'                  If flprn = False Then fSaveData_Cells sName, r.Cells(Row, j).NumberFormat
'                  flprn = False
'                End If
'              Else
'                fSaveData_Cells sName, r.Cells(Row, j).NumberFormat
'              End If
'              On Error GoTo err
'---------------------------------------------------------------------------31.10.2008
'---------------------------------------------------------------------------15.03.2012
              'fSaveData_Cells sName, r.Cells(row, j).NumberFormat
            
        End If
    End If
Next j
If n > 0 Then fInsertNameStr = True
Exit Function
err:
Set r = Nothing

MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!"
End Function


Public Sub fSaveData_Cells(ByVal sname$, ByVal sFormat$)
Dim Row As Long, t As Long, r As Range

Set r = Range("Data_Cells")
Row = r.Rows.Count
r.Rows(Row).Insert Shift:=xlDown
r.Cells(Row, 1) = sname
If sFormat Like "*[#]*" Then sFormat = Mid$(sFormat, InStrRev(sFormat, "#") + 1)
If sFormat Like "*0*" Then
           r.Cells(Row, 2) = "F"
           t = InStr(sFormat, ".")
           If t = 0 Then t = InStr(sFormat, ",")
           If t > 0 Then t = Len(sFormat) - t
           r.Cells(Row, 3) = t
Else
    r.Cells(Row, 2) = "C"
End If
Set r = Nothing
End Sub

Public Function fInsert1Row()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim R0 As Long, R1 As Long, r2 As Long, fl As Boolean
Dim a, sMsg$, sKod$

On Error Resume Next
Application.ScreenUpdating = False

sMsg = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
If Selection.Columns.Count <> Cells.Columns.Count Then MsgBox sMsg: Exit Function

fl = False
R0 = Selection.Row
For Each a In ActiveWorkbook.Names
    If a.name Like "Data_Sheet*" Then
        If Range(a.name).Worksheet.name = ActiveWorkbook.ActiveSheet.name Then
            R1 = Range(a.name).Row
            r2 = Range(a.name).Row + Range(a.name).Rows.Count - 1
            If R0 >= R1 And R0 <= r2 Then fl = True: Exit For
        End If
    End If
Next
If fl = False Then MsgBox sMsg: Exit Function
fUnProtect True: fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Index
ActiveWorkbook.ActiveSheet.Rows(r2).Insert Shift:=xlDown

sKod = Trim$(Mid$(a.name, InStr(a.name, "Sheet") + Len("Sheet")))
sKod = Format(sKod, "00")
sKod = sKod & Format(Range(a.name).Rows.Count - 1, "000")
fInsertNameStr a.name, sKod ', Range(A.Name).Rows.Count - 1
fUnProtect False: fUnProtect False, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Index

fShowCmdInsDelRow True
End Function

Public Function fCellsName(ByVal r As Range) As String
Dim s$
On Error GoTo A1
s = r.name.name
fCellsName = s: Exit Function
A1:
'If Err.Number > 0 Then MsgBox Err.Description
End Function

''05062017 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

Public Function fGetUsedRange(listname As String) As Variant()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd|-|fffd||fffd||fffd| ModRows fInsertNameStr |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim i%, j%, WS As Worksheet, r As Range, RAll As Variant, fl As Boolean, n%
Dim DynArray()
Set WS = ActiveWorkbook.Worksheets(listname)
ReDim DynArray(WS.UsedRange.Rows.Count, WS.UsedRange.Columns.Count)
For j = 1 To WS.UsedRange.Rows.Count
    For i = 1 To WS.UsedRange.Columns.Count
        Set r = WS.Cells(j, i)
        '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Range
        'DynArray(j, i) = r
        '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
        DynArray(j, i) = fRange(r)
    Next i
Next j
Set r = Nothing
Set WS = Nothing
fGetUsedRange = DynArray()
End Function

Attribute VB_Name = "ModStr"
Option Explicit

Function DelimitedLineToArray(ByRef ALine As Variant, Delimiter As String) As Variant
 On Error GoTo catch
var:
 Dim Result, vField, vR
 Dim lP As Long
begin:
 If Not (InStr(1, ALine, Delimiter, vbTextCompare) > 0) Then

  
  ReDim Result(0 To 0)
  Result(0) = ALine
  GoTo finally
 End If

 'vR = ReplaceText(ReplaceText(ALine, Chr(39), ""), Chr(34), "")
 vR = ALine
 While (Len(vR) > 0)
  If Not IsArray(Result) Then
   ReDim Result(0 To 0) As Variant
  Else
   ReDim Preserve Result(0 To UBound(Result) + 1)
  End If
  lP = InStr(1, vR, Delimiter, vbTextCompare)
  If (lP > 0) Then
   vField = left(vR, lP - 1)
   vR = Right(vR, Len(vR) - lP - Len(Delimiter) + 1)
  Else
   vField = vR
   vR = ""
  End If
  Result(UBound(Result)) = Trim(vField)
 Wend
  
finally:
 On Error Resume Next
 
 vField = Null
 DelimitedLineToArray = Result
 Result = Null
 Exit Function
catch:
 Result = Null
 Resume finally
End Function

Attribute VB_Name = "ModSumTxt"
Option Explicit
'' Valery Lavrentiev |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| RM 746
'' Valery Lavrentiev |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| RM 854 27.05.2015

Private Sub qqR()
Dim A1 As String, a2 As Currency, a As String, b As String, c As String, w As Currency
On Error Resume Next
'a1 = TxtSummaRange(Range("G28:G33"))
'----------------------------------------------------------------------------
'Dim a1 As String, a2 As Currency, a As String, b As String, w As Currency
'a = "0.1"
'b = "35.3"
'a1 = TxtSumma(a, b)
'a2 = CCur(a) + CCur(b)
'w = CCur(a1) + a2
'ww = 5
'----------------------------------------------------------------------------
On Error Resume Next
'a = "111111111.11"
'b = "2222"
'c = "3333.2"
'A1 = TxtSumma(Range("D32:G32"))
'a2 = CCur(a) + CCur(b) + CCur(c)
''w = CCur(a1) - a2
'ww = Len(A1)

End Sub

Public Function TxtSumma(ParamArray a()) As String
Dim s$, sitog$, fl As Boolean
Dim r As Range, b As Variant

On Error Resume Next

sitog = "0"
For Each b In a
   fl = False
   Set r = b
   If Not r Is Nothing Then
        If r.Count > 1 Then sitog = TxtSumma2(sitog, TxtSummaRange(r)): fl = True
   End If
   If fl = False Then
        s = Replace(Trim$(b), " ", "")
        If s = "" Then s = "0"
        If Not IsNumeric(s) Then
            TxtSumma = "#ERR"
            Exit Function
        Else
            sitog = TxtSumma2(sitog, s)
        End If
    End If
    Set r = Nothing
Next
TxtSumma = formatt(sitog)
End Function

Private Function TxtSumma2(ByVal a As String, ByVal b As String) As String
Dim ctmp As Currency, cr As Currency, sitog As String, s$, Znak As String, c$
Dim s1 As String, s2 As String
Dim i  As Long, k  As Long
Dim at$, bt$

Znak = ""
a = Replace(Trim$(a), " ", "")
b = Replace(Trim$(b), " ", "")
If a = "" Then a = "0"
If b = "" Then b = "0"

If Not (IsNumeric(a) And IsNumeric(b)) Then
    TxtSumma2 = "#ERR"
    Exit Function
End If



at = Replace(a, "-", "")
bt = Replace(b, "-", "")

'--!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! ????? ????????
'If IIf(InStr(at, ".") = 0, Len(at), InStr(at, ".") - 1) <= 14 And IIf(InStr(bt, ".") = 0, Len(bt), InStr(bt, ".") - 1) <= 14 Then
'    TxtSumma2 = CStr(CCur(a) + CCur(b))
'    Exit Function
'End If

If left$(a, 1) = "-" And left$(b, 1) = "-" Then
    a = at
    b = bt
    Znak = "-"
ElseIf left$(a, 1) = "-" Then
    a = at
    TxtSumma2 = TxtRazn2(b, a)
    Exit Function
ElseIf left$(b, 1) = "-" Then
    b = bt
    TxtSumma2 = TxtRazn2(a, b)
    Exit Function
End If

''Spir 13.01.2016
'If Len(a) < Len(b) Then
'    c = a
'    a = b
'    b = c
'End If

s1 = "0"
s2 = "0"
If InStr(a, ".") <> 0 Then
    s1 = "0." + Mid$(a, InStr(a, ".") + 1)
    a = left$(a, InStr(a, ".") - 1)
End If
If InStr(b, ".") <> 0 Then
    s2 = "0." + Mid$(b, InStr(b, ".") + 1)
    b = left$(b, InStr(b, ".") - 1)
End If
ctmp = CCur(s1) + CCur(s2)
If ctmp > 1 Then
    ctmp = ctmp - 1
    cr = 1
End If
''Spir 13.01.2016 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| =0 |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1.5+1.5=3)
If ctmp = 1 Then
    ctmp = 1
    cr = 1
End If
''''
sitog = Mid$(CStr(ctmp), 2)

''Spir 13.01.2016
If Len(a) < Len(b) Then
    c = a
    a = b
    b = c
End If

b = Replace(Space(Len(a) - Len(b)), " ", "0") + b
For i = Len(a) To 1 Step -1
  k = CInt(Mid$(a, i, 1)) + CInt(Mid$(b, i, 1)) + cr
  If k > 9 And i <> 1 Then
    k = k - 10
    cr = 1
  Else
    cr = 0
  End If
  sitog = CStr(k) + sitog

Next i
TxtSumma2 = Znak + sitog

End Function

Public Function formatt(ByVal sitog As String) As String
Dim s As String, sd As String, s1$, i  As Long
    
    If InStr(sitog, ".") <> 0 Then
        s = left$(sitog, InStr(sitog, ".") - 1)
        sd = Mid$(sitog, InStr(sitog, "."))
    Else
        s = sitog
    End If
    If Len(s) > 3 Then
        s1 = ""
        s = "       " + s
        For i = Len(s) - 2 To 0 Step -3
            s1 = Mid(s, IIf(i = 0, 1, i), 3) + " " + s1
        Next i
        s = Trim$(s1)
    End If
    formatt = s + sd
End Function


Private Function TxtRazn2(ByVal a As String, ByVal b As String) As String
Dim i  As Long, k  As Long, na  As Long, nb  As Long
Dim ctmp As Currency, cr As Currency, sitog As String, s$, Znak As String, c As String
Dim s1 As String, s2 As String
Dim at$, bt$

Znak = ""
a = Replace(Trim$(a), " ", "")
b = Replace(Trim$(b), " ", "")
If a = "" Then
    a = "0"
End If
If b = "" Then
    b = "0"
End If

If Not (IsNumeric(a) And IsNumeric(b)) Then
    TxtRazn2 = ""
    Exit Function
End If

at = Replace(a, "-", "")
bt = Replace(b, "-", "")
If IIf(InStr(at, ".") = 0, Len(at), InStr(at, ".") - 1) <= 14 And IIf(InStr(bt, ".") = 0, Len(bt), InStr(bt, ".") - 1) <= 14 Then
    TxtRazn2 = CStr(CCur(a) - CCur(b))
    Exit Function
End If

If left$(a, 1) = "-" And left$(b, 1) <> "-" Then
    b = "-" + b
    TxtRazn2 = TxtSumma(a, b)
    Exit Function
ElseIf left$(b, 1) = "-" And left$(a, 1) <> "-" Then
    b = bt
    TxtRazn2 = TxtSumma(a, b)
    Exit Function
ElseIf left$(b, 1) = "-" And left$(a, 1) = "-" Then
    c = bt
    b = at
    a = c
End If

If Len(a) < Len(b) Then
    c = a
    a = b
    b = c
    Znak = "-"
End If

s1 = "0"
s2 = "0"
If InStr(a, ".") <> 0 Then
    s1 = "0." + Mid$(a, InStr(a, ".") + 1)
    a = left$(a, InStr(a, ".") - 1)
End If
If InStr(b, ".") <> 0 Then
    s2 = "0." + Mid$(b, InStr(b, ".") + 1)
    b = left$(b, InStr(b, ".") - 1)

End If

If s1 <> "0" Or s2 <> "0" Then
ctmp = CCur(s1) - CCur(s2)
If ctmp < 0 Then
    ctmp = ctmp + 1
    cr = 1
End If
sitog = Mid$(CStr(ctmp), 2)
End If

b = Replace(Space(Len(a) - Len(b)), " ", "0") + b
For i = Len(a) To 1 Step -1
    na = CInt(Mid$(a, i, 1))
    nb = CInt(Mid$(b, i, 1))
    If na < (nb + cr) Then
        k = na + 10 - nb - cr
        cr = 1
    Else
        k = na - nb - cr
        cr = 0
    End If
  sitog = CStr(k) + sitog
Next i

k = InStr(sitog, ".")
For i = 1 To Len(sitog)
    s = Mid$(sitog, i, 1)
    If s <> "0" Or i = k - 1 Then
        sitog = Mid$(sitog, i)
        Exit For
    End If

Next i
TxtRazn2 = Znak + sitog

End Function

Public Function TxtRazn(a As String, b As String) As String
    Dim sitog As String
    
    sitog = "0"
    sitog = TxtRazn2(a, b)
    TxtRazn = formatt(sitog)
End Function


Private Function TxtSummaRange(r As Range) As String
Dim b As String, a As Variant
On Error Resume Next

b = "0"
For Each a In r
    b = TxtSumma2(b, a)
  Next
TxtSummaRange = b
End Function

Private Function TxtSummaS(ByVal a As String) As String
Dim s$, itogo$, arr As Variant, i  As Long
Dim r As Range, Zn$

On Error GoTo A1

a = Replace(Trim$(a), " ", "")
a = Replace(Trim$(a), "-", "+-")
arr = Split(a, "+")

For i = LBound(arr) To UBound(arr)
    s = arr(i)
    If IsNumeric(s) Then
        itogo = TxtSumma2(itogo, s)
     Else
        Zn = ""
        If left$(s, 1) = "-" Then
            Zn = "-"
            s = Mid$(s, 2)
        End If
        Set r = Range(s)
        If Not r Is Nothing Then
            itogo = TxtSumma2(itogo, Zn + r.Value)
        Else
            TxtSummaS = "#ERR"
            Exit Function
        End If
     End If
        
Next i
TxtSummaS = itogo
Exit Function
A1:
TxtSummaS = "#ERR"
End Function




Public Sub aaa()
's = TxtSummaS("5 + 6 -3")
End Sub

Attribute VB_Name = "ModVictor"
Option Explicit
Option Base 1
Public Const sMsg = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| '|fffd||fffd||fffd||fffd||fffd|'|fffd||fffd||fffd||fffd||fffd||fffd||fffd|-|fffd|'"

Sub fCreateGroup_Plan()
Dim db As Database
Dim DsArr
Dim i  As Long, j  As Long, k  As Long
Dim sql As String, s As String, sql_ins As String, sql_sel As String
Dim Rds() As Range
Dim R1 As Range
Dim rs As Recordset
'Dim flgBP As Boolean
Dim flgKosgu As Boolean
'Dim Codbp As String
Dim Kosgu As String
Dim p  As Long
Dim idForm As String
Dim sname As String
Dim TempPath  As String

idForm = UCase(sGetINI("Idform", "?"))
If idForm = "PZ_PL" Then '|fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  sname = "|fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
ElseIf idForm = "PZ_PL_IZ" Then '|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  sname = "|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
End If

'|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|
'ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Select
ActiveWorkbook.Sheets(sname).Select
Call fUnProtect(True)

'Call fUnProtect(True, Worksheets("|fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|").Index)
Call fUnProtect(True, Worksheets(sname & "_|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|").Index)

On Error GoTo errPlan

TempPath = Environ("Temp")
Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp", dbLangCyrillic)
  
GoNext:

DsArr = fGetDataSheetsFromList(ActiveSheet.name)
If Not IsArray(DsArr) Then Exit Sub
ReDim Rds(UBound(DsArr))
For i = LBound(DsArr) To UBound(DsArr)
  s = sGetINI(DsArr(i) & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
  If s <> "?" Then
    
    Set Rds(i) = Range(DsArr(i))
  
    If Rds(i).Rows.Count <= 2 Then GoTo A1
    
    sql = "create table Result" & i & "(Id counter,"
    For j = 1 To Range(DsArr(i)).Columns.Count
      If UCase(Range(DsArr(i)).Columns(j).NumberFormat) Like "*@*" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        sql = sql & "col" & j & " text,"
      ElseIf UCase(Range(DsArr(i)).Columns(j).NumberFormat) = "GENERAL" Then '|fffd||fffd||fffd||fffd||fffd|
        sql = sql & "col" & j & " text,"
      ElseIf UCase(Range(DsArr(i)).Columns(j).NumberFormat) Like "*0.0*" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        sql = sql & "col" & j & " currency,"
      Else
        sql = sql & "col" & j & " text,"
      End If
    Next j
    sql = sql & "Ord integer)"
    db.Execute (sql)
      
    
    
    For k = 2 To Rds(i).Rows.Count - 1 '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    sql_ins = "insert into Result" & i & "("
    sql_sel = "values("
      For j = 1 To Rds(i).Columns.Count '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        sql_ins = sql_ins & "col" & j & ","
        sql_sel = sql_sel & "'" & Rds(i).Cells(k, j).Value & "',"
      Next j
    sql_ins = left(sql_ins, Len(sql_ins) - 1) & ")"
    sql_sel = left(sql_sel, Len(sql_sel) - 1) & ")"
    sql = sql_ins & " " & sql_sel
    db.Execute (sql)
    Next k
  
  sql = ""
  
  End If
A1:
Next i

'db.Close
'Set db = OpenDatabase(ThisWorkbook.Path & "\SvTemp", False, False)


   For i = LBound(Rds) To UBound(Rds)
  If TableExists(db, "Result" & i) Then
    db.Execute ("update Result" & i & " set Ord=0")
      If i = 1 Then '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
      ' sql_ins = "insert into Result" & i & "(col1,col4,col6,"
      sql_ins = "insert into Result" & i & "(col4,col6,"
      'sql_sel = "select col1,col4,col6,"
      sql_sel = "select col4,col6,"
       For j = 7 To Rds(i).Columns.Count
        If UCase(Rds(i).Columns(j).NumberFormat) Like "*0.0*" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
          sql_ins = sql_ins & "col" & j & ","
          sql_sel = sql_sel & "sum(iif(isnull(col" & j & "),0,col" & j & ")),"
        End If
      Next j
      
      '|fffd||fffd||fffd||fffd||fffd|
      sql_ins = left(sql_ins, Len(sql_ins) - 1) & ",Ord)"
      sql_sel = sql_sel
      sql = sql_ins & " " & sql_sel & "1 from Result" & i
      'sql = sql & " group by col1,col4,col6"
      sql = sql & " group by col4,col6"
      db.Execute (sql)
      
      '|fffd||fffd||fffd||fffd||fffd|
      sql_ins = sReplace(sql_ins, "col6,", "")
      sql_sel = sReplace(sql_sel, "col6,", "")
      
      sql_sel = sql_sel
      sql = sql_ins & " " & sql_sel & "2 from Result" & i
      sql = sql & " where Ord=1 "
      'sql = sql & "group by col1,col4"
      sql = sql & "group by col4"
      db.Execute (sql)
      
      sql = "update Result1 set col5='|fffd||fffd||fffd||fffd||fffd|' where Ord=1"
      db.Execute (sql)
      sql = "update Result1 set col5='|fffd||fffd||fffd||fffd||fffd|' where Ord=2"
      db.Execute (sql)
      
      sql = "update Result1 set col6=left(trim(col4),3) & '99'"
      sql = sql & "where ord=2"
      db.Execute (sql)
      
'       db.Close
'      Set db = OpenDatabase(TempPath & "\SvTemp", False, False)
      

      
      sql = "select * from Result1 "
      'sql = sql & "ORDER BY col1, col4,col6, Ord,col17"
      sql = sql & "ORDER BY col4,col6, Ord,col17"
      Set rs = db.OpenRecordset(sql)
      Set R1 = Range(Rds(i).name.name & "_1")
      
      If rs.RecordCount > 0 Then
        rs.MoveLast
        rs.MoveFirst
        
        On Error Resume Next
        Range("Name_Otd_1").Value = Range("Name_Otd").Value
        Range("Naim_Ruk_1").Value = Range("Naim_Ruk").Value
        Range("Naim_MODdata_1").Value = Range("Naim_MODdata").Value
        On Error GoTo 0
        sql = fGetNameSheetFromName(R1.name.name)
        j = 0
        
          If R1.Rows.Count > 2 Then
          '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
            j = R1.Row + R1.Rows.Count - 1
            ActiveWorkbook.Sheets(sql).Rows(R1.Row + 1 & ":" & j - 1).Delete Shift:=xlUp
          End If
           '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
          j = R1.Row + rs.RecordCount
          ActiveWorkbook.Sheets(sql).Rows(R1.Row + 1 & ":" & j).Insert Shift:=xlDown
'Codbp = ""
Kosgu = ""
       j = 2
       
       flgKosgu = True
        Do Until rs.EOF
          
          For k = 1 To R1.Columns.Count
          If k = 1 Then
            If rs!Ord = 0 Then
              R1.Cells(j, k).Value = IIf(IsNull(rs("Col" & k)), "", rs("Col" & k))
            End If

          ElseIf k = 3 Then
          
          ElseIf k = 4 Then 'Kosgu
            If Kosgu <> rs("Col" & k) Then
               R1.Cells(j, k).Value = IIf(IsNull(rs("Col" & k)), "", rs("Col" & k))
               Kosgu = IIf(IsNull(rs("Col" & k)), "", rs("Col" & k))
               flgKosgu = True
               p = p + 1
               R1.Cells(j, k).Font.name = "Arial Black"
               R1.Cells(j, 3).Value = p '|fffd||fffd||fffd||fffd||fffd| |fffd|/|fffd|
               R1.Cells(j, 3).Font.name = "Arial Black"
            Else
                 flgKosgu = False
            End If
          ElseIf k = 6 Then
            If Right(rs("Col" & k), 2) = "99" And (rs!Ord = 2) Then
              R1.Cells(j, k).Value = IIf(IsNull(rs("Col" & k)), "", left(rs("Col" & k), 3) & "00")
              R1.Cells(j, k).Font.name = "Arial Black"
            ElseIf (rs!Ord = 1) Then
              R1.Cells(j, k).Value = IIf(IsNull(rs("Col" & k)), "", rs("Col" & k))
              R1.Cells(j, k).Font.name = "Arial Black"
            Else
              R1.Cells(j, k).Value = IIf(IsNull(rs("Col" & k)), "", rs("Col" & k))
            End If
          ElseIf k = 5 Then
            If (rs!Ord = 1 Or rs!Ord = 2) Then
              R1.Cells(j, k).Value = IIf(IsNull(rs("Col" & k)), "", rs("Col" & k))
              R1.Cells(j, k).Font.name = "Arial Black"
            Else
               R1.Cells(j, k).Value = IIf(IsNull(rs("Col" & k)), "", rs("Col" & k))
            End If
          Else
            R1.Cells(j, k).Value = IIf(IsNull(rs("Col" & k)), "", rs("Col" & k))
               If (rs!Ord = 2 Or rs!Ord = 1) Then
                 R1.Cells(j, k).Font.name = "Arial Black"
                ' R1.Cells(j, k).Font.FontStyle = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
               End If
          End If
           


          Next k
        rs.MoveNext
        j = j + 1
        Loop

        
      Else
        GoTo finnally
      End If
    sql = ""
    
    End If
    GoTo finnally
  End If
Next i

finnally:
On Error GoTo 0
On Error Resume Next
rs.Close
db.Close
Set rs = Nothing
Set db = Nothing
Kill TempPath & "\SvTemp.mdb"
MyProtect
'CommandBars("column").FindControl(id:=886).Enabled = True
'CommandBars("column").FindControl(id:=887).Enabled = True
'ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
ActiveWorkbook.Sheets(sname & "_|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True

'fShowColumnMenu
Call fUnProtect(False)
'ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|").Select
ActiveWorkbook.Sheets(sname & "_|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|").Select
Call fUnProtect(False)
'Call fUnProtect(False, Worksheets("|fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|").Index)
ActiveWorkbook.Protect "rassvet"
Exit Sub
errPlan:
If err = 3204 Then
  Kill TempPath & "\SvTemp.mdb"
  Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp", dbLangCyrillic)
  err.Clear
  GoTo GoNext
Else
  'MsgBox Error(err)
  'Resume
  err.Clear
  GoTo finnally
End If
End Sub

Sub CreateArrayTest(ByRef a, ByRef b)
Dim r As Range
Dim i  As Long


Set r = Range("Data_Spr1")
If r.Rows.Count < 2 Then Exit Sub
'row = r.row

ReDim a(1 To 1, 1 To 2)
a(1, 1) = "01"
a(1, 2) = GetCountRows125
If a(1, 2) = 0 Then Exit Sub
ReDim b(1 To r.Rows.Count, 1 To 2)
  
  For i = 1 To r.Rows.Count
    b(i, 1) = Trim(r.Cells(i, 1))
    b(i, 2) = Trim(r.Cells(i, 2))
  Next i

End Sub

Public Function fReturnInsertErrArray(DArr As Variant) As Variant
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| Result(i,j) |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
'i-|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'Result(i,1)-|fffd||fffd||fffd|
'Result(i,2)-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd|."|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" |fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
Dim r As Range
Dim Result As Variant
Dim i  As Long
Dim sname As String
Dim er  As Long
Dim ErrArray1 As Variant
Dim ErrArray2 As Variant

On Error GoTo err_Insert

Result = 0
If Not IsArray(DArr) Then
  Result = Empty
  GoTo finally
End If
'If EmptyName("Data_Spr1") < 2 Then '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'  Result = Empty
'  GoTo finally
'End If

'Set r = Range("Data_Spr1")
Application.ScreenUpdating = False

er = 0
ReDim ErrArray1(1 To 1)
ReDim ErrArray2(1 To 1)

 For i = LBound(DArr) To UBound(DArr)
    
  sname = Trim(DArr(i, 1))
  
  If Not IsEmpty(sname) Then
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    If Not HasName(sname) Then
      er = er + 1
      ReDim Preserve ErrArray1(1 To er)
      ReDim Preserve ErrArray2(1 To er)
      ErrArray1(er) = sname
      ErrArray2(er) = "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
    Else
      If Trim(DArr(i, 2)) <> "" Then
        If Trim(Range(sname).Value) <> Trim(DArr(i, 2)) Then
          If Not Range(sname).HasFormula Then
            er = er + 1
            ReDim Preserve ErrArray1(1 To er)
            ReDim Preserve ErrArray2(1 To er)
            ErrArray1(er) = sname
            ErrArray2(er) = "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
          End If
        End If
      End If
    End If
    
  End If
Next i



ReDim Result(1 To er, 1 To 2)
For i = 1 To er
  Result(i, 1) = ErrArray1(i)
  Result(i, 2) = ErrArray2(i)
Next i

finally:

If Not IsArray(Result) Then Result = 0
If IsEmpty(Result) Then Result = 0

fReturnInsertErrArray = Result
Application.ScreenUpdating = True
Exit Function

err_Insert:
' MsgBox Error(err)
' Resume
On Error Resume Next
Set r = Nothing
Result = Empty

GoTo finally

End Function

Public Sub AddToSpr(SprName As String, a As Variant, Optional snam As String = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| A

'A(i, 1) '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'A(i, 2) '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

Dim i As Long, Row As Long, r As Range, s$

On Error GoTo add_err
'If Trim(UCase(SprName)) = "DATA_SPR1" Then
'  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, '" & SprName & "'-|fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", vbInformation, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!"
'  Exit Sub
'End If


Application.ScreenUpdating = True

Set r = Range(SprName)
fUnProtect True, Worksheets(snam).Index
Application.EnableEvents = False
Row = r.Rows.Count

Application.ScreenUpdating = False
For i = 1 To UBound(a, 1)
  Row = r.Rows.Count
  r.Rows(Row).Insert Shift:=xlDown
  r.Cells(Row, 1) = a(i, 1) '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  r.Cells(Row, 2) = a(i, 2) '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Next i

r.Rows(r.Rows.Count).Delete: r.Rows(1).Delete
Set r = Nothing
Application.EnableEvents = True
Application.ScreenUpdating = True


Exit Sub
add_err:
'MsgBox Error(err)
'Resume
s = ""

End Sub

Function fGetDdataV(a() As Variant, b() As Variant) As Variant

'Dim t1 As Date
'Dim t2 As Date
't1 = Time
'Debug.Print "start |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"; t1

'a=fGetDdata("1","2")
'A-|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| Data_Sheet-|fffd| |fffd| |fffd||fffd||fffd|-|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|:
'A(i,1)="02"(|fffd||fffd||fffd||fffd||fffd| Data_Sheet-|fffd|("01","02".... |fffd| |fffd|.|fffd|.))
'A(i,2) = 150(|fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd|)
'B-2-|fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'B(i,1)="ss0110000110011701010010000100110101310a" (|fffd||fffd||fffd|,|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| Cell |fffd||fffd|)
'B(i,2)="25.00" (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| Var_f |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| Var_c |fffd|.Ddata |fffd||fffd|)

'i-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
'fReturnInsertErrArray
Dim Result As Variant
Dim i  As Long
Dim j()  As Long
Dim k  As Long
Dim l  As Long
Dim sKod$, sKod1$, n As Long  ' - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| ss |fffd| |fffd|..
Dim Rds() As Range
Dim r As Range
Dim iAK As Long
Dim sKodNew As String
Dim flgDs As Boolean
Dim KodDs As String
Dim FlgErr As Boolean
Dim kodORG As String
Dim idForm As String
Dim flg128 As String

On Error GoTo err_data
If Not IsArray(a) Or IsEmpty(a) Then GoTo finally
If Not IsArray(b) Or IsEmpty(b) Then GoTo finally

Application.Calculation = xlManual
Application.EnableEvents = False

idForm = sGetINI("idForm", "?")
idForm = UCase(idForm)


sKod = sGetINI("UseDataSheetInCodName", "OFF")
sKod = UCase(Trim(sKod))
If sKod = "OFF" Then
  flgDs = False
ElseIf sKod = "ON" Then
  flgDs = True
End If

flg128 = sGetINI("flKod", "?")

''----|fffd||fffd||fffd||fffd||fffd||fffd||fffd|------------------------
'If IdForm = "169" Then flgDs = True
''----|fffd||fffd||fffd||fffd||fffd||fffd||fffd|------------------------

sKod = ""
Call fUnProtect(True)
Call fUnProtect(True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Index)
If idForm = "125" Then
  iAK = Val(sGetINI("OKATO", "11"))
End If



ReDim Rds(UBound(a))
ReDim j(UBound(a))
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| Data_Sheet-|fffd||fffd|
For k = LBound(a) To UBound(a)
  j(k) = a(k, 2)
  i = 0
  If j(k) = 0 Then
    If flgDs = False Then
      j(k) = GetCountRows125 '|fffd||fffd| Data_Spr1
    Else
       j(k) = GetCountRows125New(b()) ' |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    End If
    
  End If
  If j(k) = 0 Then GoTo nxt
  
  Set Rds(k) = Range("Data_Sheet" & a(k, 1))
   i = Rds(k).Row + Rds(k).Rows.Count - 1
  Rows(i & ":" & i + j(k) - 1).Insert Shift:=xlDown
nxt:
Next k
 
 For k = LBound(a) To UBound(a)
   j(k) = 2 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 Next k
    
    For l = LBound(b) To UBound(b)

      sKod = Trim$(b(l, 1))   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
      sKodNew = sKod
      n = Len(sKodNew) - 3
      If sEmptyName(sKod) > 0 Then GoTo skipp1    '|fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
      If left$(sKod, 2) <> "ss" And Not (sKod Like "*[!a-z][a-z]") Then GoTo skipp1
      sKod = Mid$(sKod, 3, n)
'----|fffd||fffd||fffd||fffd||fffd||fffd||fffd|----------------------------------------
'      If IdForm = "169" Then sKod = "01" & sKod
'----|fffd||fffd||fffd||fffd||fffd||fffd||fffd|----------------------------------------
      If sKod <> sKod1 Then
         sKod1 = sKod
         
         On Error GoTo 0
         On Error GoTo InsErr
         If flgDs = True Then
           KodDs = Mid(sKod, 1, 2)
           If idForm = "125" Then
             addRowF1251_New sKod, Rds(Val(KodDs)), iAK, " ", j(Val(KodDs))
'           ElseIf IdForm = "169" Then
'             fInsertNameStr RDS(Val(KodDs)).Name.Name, sKod, j(Val(KodDs))
           Else
             fInsertNameStr Rds(Val(KodDs)).name.name, sKod, j(Val(KodDs))
           End If
           
         Else
           GoTo skipp3
         End If
        
        j(Val(KodDs)) = j(Val(KodDs)) + 1
      End If

skipp1:

      If IsEmpty(b(l, 2)) Then GoTo skipp3
      If Trim(b(l, 2)) = "" Then GoTo skipp3
         'If sEmptyName(sKodNew) > 0 Then
          On Error GoTo skipp2
           If sEmptyName(sKodNew) > 0 Then
             If Range(sKodNew).HasFormula = False Then
               If Trim(Range(sKodNew).Value) <> Trim(b(l, 2)) Then
                 Range(sKodNew).Value = Trim(b(l, 2)) '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
               End If
             End If
               If idForm = "125" Then '|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 125|fffd| |fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                 kodORG = left(sKodNew, Len(sKodNew) - 1) & "b"
                 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                 If left$(kodORG, 2) = "ss" And sEmptyName(kodORG) > 0 Then
                   
                    If flg128 = "?" Then
                      If Mid(kodORG, 5, 1) = "1" Then
                         If Trim(Range(kodORG).Value) = "" Or IsEmpty(Range(kodORG).Value) Then
                           Range(kodORG).Value = NameinSpr(Mid(kodORG, 6, 5), "Data_Org")
                         End If
                      End If
                    Else
                     If Mid(kodORG, 6, 1) = "1" Then
                        If Trim(Range(kodORG).Value) = "" Or IsEmpty(Range(kodORG).Value) Then
                          Range(kodORG).Value = NameinSpr(Mid(kodORG, 7, 5), "Data_Org")
                        End If
                      End If
                    End If
                 End If
               End If
            
skipp2:
             If err <> 0 Then
               FlgErr = True
               err.Clear
             End If
             On Error GoTo 0
             On Error GoTo err_data
           End If

skipp3:

   Next l
  
finally:

If FlgErr = True Then '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'  Dim t3 As Date
'  Dim t4 As Date
'  t3 = Time
'  Debug.Print "start fReturnInsertErrArray"; t3
  
   Result = fReturnInsertErrArray(b)
'
'  t4 = Time
'  Debug.Print "finish fReturnInsertErrArray "; t4
'  Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|"; DateDiff("n", t4, t3)

Else
  Result = 0
End If

If idForm = "PZ_PL_IZ" Then
  If Range("Data_Sheet01").Rows.Count <= 2 Then '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = False
    CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = False
  Else
    CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = True
    CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = True
  End If
End If


Application.EnableEvents = True
Application.Calculation = xlAutomatic
Application.ScreenUpdating = True
ActiveWorkbook.Saved = True
fGetDdataV = Result
On Error GoTo 0
On Error Resume Next
Call fUnProtect(False)
Call fUnProtect(False, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Index)
fShowCmdInsDelRow True

't2 = Time
'Debug.Print "finish "; t2
'Debug.Print "|fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| "; DateDiff("n", t2, t1); "|fffd||fffd||fffd||fffd||fffd|"


Exit Function
err_data:
'MsgBox Error
'Resume
GoTo finally
InsErr:
'Resume
FlgErr = True

If Application.Visible = False Then Application.Visible = True
GoTo finally
End Function

Public Function SaveStaticNamesToRange(sname As String, Value As Variant) As Boolean
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Value |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| False
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|(Kod_okpo,Naim_ruk |fffd| |fffd|.|fffd|.) |fffd| |fffd||fffd||fffd||fffd||fffd|
'sname-|fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd|(|fffd||fffd||fffd||fffd|. "Naim_ruk")
'Value-|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd|. "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd|.|fffd|.")
'a=SaveToRange("Naim_ruk", "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd|.|fffd|.")

Dim r As Range

On Error Resume Next

Set r = Range(sname)
If r Is Nothing Then
    SaveStaticNamesToRange = False
Else
    r.Value = Value
    SaveStaticNamesToRange = True
End If
Set r = Nothing
End Function

Public Sub AddToData_Spr1(a As Variant, Optional SprName As String = "Data_Spr1", Optional SheetName As String = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd| |fffd| Data_Spr1
Dim i As Long, Row As Long, r As Range, s$
'fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
'Set R = Range("Data_Spr1")


fUnProtect True, Worksheets(SheetName).Index
Set r = Range(SprName)
Application.ScreenUpdating = False

For i = 1 To UBound(a, 1)
    s = a(i, 1)
    If Len(s) = 0 Then GoTo A1
    'If SaveToRange(s, A(i, 2)) = False Then
    'If SaveStaticNamesToRange(s, A(i, 2)) = False Then
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|(ss.......a1) |fffd| Data_Spr1
        Row = r.Rows.Count
        If a(i, 2) <> "0" Then
        r.Rows(Row).Insert Shift:=xlDown
        r.Cells(Row, 1) = a(i, 1) '|fffd||fffd||fffd|
        r.Cells(Row, 2) = a(i, 2) ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd|.,|fffd||fffd||fffd||fffd||fffd|)
        End If
    'End If
A1:
Next i
Application.ScreenUpdating = True
Set r = Nothing
End Sub


Attribute VB_Name = "Modini"
#If VBA7 Then
'  Code is running in the new VBA7 editor
     #If Win64 Then
     '  Code is running in 64-bit version of Microsoft Office
        Public Declare PtrSafe Function GetPrivateProfileString Lib "kernel32" Alias "GetPrivateProfileStringA" (ByVal lpApplicationName As String, ByVal lpKeyName As Any, ByVal lpDefault As String, ByVal lpReturnedString As String, ByVal nSize As LongLong, ByVal lpFileName As String) As LongLong
     #Else
     '  Code is running in 32-bit version of Microsoft Office
        Public Declare Function GetPrivateProfileString Lib "kernel32" Alias "GetPrivateProfileStringA" (ByVal lpApplicationName As String, ByVal lpKeyName As Any, ByVal lpDefault As String, ByVal lpReturnedString As String, ByVal nSize As Long, ByVal lpFileName As String) As Long
     #End If
#Else
' Code is running in VBA version 6 or earlier
    Public Declare Function GetPrivateProfileString Lib "kernel32" Alias "GetPrivateProfileStringA" (ByVal lpApplicationName As String, ByVal lpKeyName As Any, ByVal lpDefault As String, ByVal lpReturnedString As String, ByVal nSize As Long, ByVal lpFileName As String) As Long
#End If

#If VBA7 Then
'  Code is running in the new VBA7 editor
     #If Win64 Then
     '  Code is running in 64-bit version of Microsoft Office
        Public Declare PtrSafe Function WritePrivateProfileString Lib "kernel32" Alias "WritePrivateProfileStringA" (ByVal lpApplicationName As String, ByVal lpKeyName As Any, ByVal lpString As Any, ByVal lpFileName As String) As LongLong
     #Else
     '  Code is running in 32-bit version of Microsoft Office
        Public Declare Function WritePrivateProfileString Lib "kernel32" Alias "WritePrivateProfileStringA" (ByVal lpApplicationName As String, ByVal lpKeyName As Any, ByVal lpString As Any, ByVal lpFileName As String) As Long
     #End If
#Else
' Code is running in VBA version 6 or earlier
    Public Declare Function WritePrivateProfileString Lib "kernel32" Alias "WritePrivateProfileStringA" (ByVal lpApplicationName As String, ByVal lpKeyName As Any, ByVal lpString As Any, ByVal lpFileName As String) As Long
#End If

'Public Declare Function GetPrivateProfileString Lib "kernel32" Alias "GetPrivateProfileStringA" (ByVal lpApplicationName As String, ByVal lpKeyName As Any, ByVal lpDefault As String, ByVal lpReturnedString As String, ByVal nSize As Long, ByVal lpFileName As String) As Long
'Public Declare Function WritePrivateProfileString Lib "kernel32" Alias "WritePrivateProfileStringA" (ByVal lpApplicationName As String, ByVal lpKeyName As Any, ByVal lpString As Any, ByVal lpFileName As String) As Long
Public sIniFile As String
Public sRazdel As String
Public Const sNameGl = "189,100"

'Public Function sGetINI(sKey As String, sDefault As String) As String
'Dim sIniFile$, sSection$
'Dim sTemp As String * 256
'Dim nLenght As Integer
'
'sTemp = Space$(256)
'
'sIniFile = ThisWorkbook.Path & "\lnc2.ini"
'i = InStr(ActiveWorkbook.Name, ".")
'If i = 0 Then i = Len(ActiveWorkbook.Name) - 1 Else i = i - 2
'sSection = left$(ActiveWorkbook.Name, i) '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'
'nLenght = GetPrivateProfileString(sSection, sKey, sDefault, _
'                                        sTemp, 255, sIniFile)
'sGetINI = left$(sTemp, nLenght)
'End Function

Public Function sGetINI(sKey As String, sDefault As String) As String
Dim sIniFile$, sSection$
Dim sTemp As String
'Dim nLenght As Long
#If VBA7 Then
'  new VBA7 editor
     #If Win64 Then
     '  64-bit
        Dim nLenght As LongLong, nLenght32 As Long
     #Else
     '  32-bit
        Dim nLenght As Long, nLenght32 As Long
     #End If
#Else
' VBA version 6 or earlier
    Dim nLenght As Long, nLenght32 As Long
#End If

sTemp = Space$(2048)

sIniFile = ThisWorkbook.Path & "\lnc2.ini"
i = InStr(ActiveWorkbook.name, ".")
If i = 0 Then i = Len(ActiveWorkbook.name) - 1 Else i = i - 2
sSection = left$(ActiveWorkbook.name, i) '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|

nLenght = GetPrivateProfileString(sSection, sKey, sDefault, _
                                        sTemp, 2048, sIniFile)
nLenght32 = CLng(nLenght)
sGetINI = left$(sTemp, nLenght32)
End Function

Public Function Gl_ORG2() As Boolean
Dim sKod$

    On Error GoTo errHandler
    '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    If Day(Date) > 2 And Day(Date) < 30 Then
'        strMErr = sMsg
        sKod = Range("Kod_GL").Value
        If sKod = HasElinStr(sNameGl, sKod) Then Gl_ORG2 = False Else Gl_ORG2 = True
'        sKod = left(Trim(ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range("Data_FKR").Cells(1, 1).Value), 3)
'        'If sKod = "100" Or sKod = "189" Then GoTo A1
'        If HasElinStr(sNameGl, sKod) Then GoTo A3
'        sKod = left(Trim(ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range("Data_KLD").Cells(1, 1).Value), 3)
'        If HasElinStr(sNameGl, sKod) Then GoTo A3
'        sKod = left(Trim(ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range("Data_IFV").Cells(1, 1).Value), 3)
'        If HasElinStr(sNameGl, sKod) Then GoTo A3
        '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    Else
        Gl_ORG2 = True
    End If
    Exit Function
    
errHandler:
    Gl_ORG2 = True
    
End Function

Public Sub sWriteINI(sIniFile As String, sSection _
    As String, sKey As String, sValue As String)
    
Dim sTemp As String * 256
'Dim nLenght As Integer
#If VBA7 Then
'  new VBA7 editor
     #If Win64 Then
     '  64-bit
        Dim nLenght As LongLong, nLenght32 As Long
     #Else
     '  32-bit
        Dim nLenght As Long, nLenght32 As Long
     #End If
#Else
' VBA version 6 or earlier
    Dim nLenght As Long, nLenght32 As Long
#End If
   
sTemp = Space$(256)
nLenght = WritePrivateProfileString(sSection, sKey, sValue, sIniFile)
nLenght32 = CLng(nLenght)

End Sub
'Public Function sGetRekv(sKey As String, sDefault As String) As String
''|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| Kod |fffd| Name |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
''|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| Data
'Dim n As Name, s$, s1$
'
'sKey = sReplace(sKey, "!|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "")
'For Each n In ActiveWorkbook.Names
'    If n.RefersToLocal Like "*" & sKey & "*" Then
'        If n.Name Like "Kod*" Or n.Name Like "Name*" Then
'            s = sReplace(n.Name, "Kod", "Data")
'            s = sReplace(s, "Name", "Data")
'
'            On Error Resume Next
'            ss = ActiveWorkbook.Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range(s).Rows.Count
'            If Err = 0 Then
'                        If Not s1 Like "*" & s & "*" Then s1 = s1 & s & " ,"
'            End If
'        End If
'    End If
'Next
'
'If Len(s1) > 0 Then sGetRekv = Mid$(s1, 1, Len(s1) - 1) Else sGetRekv = sDefault
'End Function

Public Sub |fffd||fffd||fffd||fffd||fffd||fffd|Ini()
Dim sIniFile$, sSection$, sKey$, sValue$

sIniFile = ThisWorkbook.Path & "\aksiok.ini"
sSection = "F125FK_1"
sWriteINI sIniFile, sSection, "|fffd||fffd||fffd||fffd|1!|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "Data_EI, Data_BSR, Data_ORG, Data_KPL"
sWriteINI sIniFile, sSection, "|fffd||fffd||fffd||fffd|1!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "Data_FKR, Data_PLS"

sSection = "F127"
sWriteINI sIniFile, sSection, "|fffd||fffd||fffd||fffd||fffd||fffd|!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "Data_KLD, Data_FKR, Data_IFR, Data_IFV"
sWriteINI sIniFile, sSection, "|fffd||fffd||fffd||fffd||fffd||fffd|!Kod", "3"
sWriteINI sIniFile, sSection, "|fffd||fffd||fffd||fffd||fffd||fffd|!Naim", "1"

End Sub

Public Function sGetINI1(sKey As String, sDefault As String) As String
Dim s$, sn$, n As Long, k As Long

sn = "Data_Spr1"
If EmptyName(sn) > 1 Then
n = Range(sn).Row
k = Range(sn).Rows.Count
For i = n To n + k - 1
    If UCase(Trim$(Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(i, 1))) = UCase(Trim$(sKey)) Then
        s = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(i, 2)
        Exit For
    End If
Next i
End If
If Len(s) = 0 Then s = sDefault
sGetINI1 = s
End Function



Attribute VB_Name = "Module1"
#If VBA7 Then
'  Code is running in the new VBA7 editor
     #If Win64 Then
     '  Code is running in 64-bit version of Microsoft Office
        Declare PtrSafe Function GetLocaleInfo Lib "kernel32" Alias "GetLocaleInfoA" (ByVal Locale As LongLong, ByVal LCType As LongLong, ByVal lpLCData As String, ByVal cchData As LongLong) As LongLong
     #Else
     '  Code is running in 32-bit version of Microsoft Office
        Declare Function GetLocaleInfo Lib "kernel32" Alias "GetLocaleInfoA" (ByVal Locale As Long, ByVal LCType As Long, ByVal lpLCData As String, ByVal cchData As Long) As Long
     #End If
#Else
' Code is running in VBA version 6 or earlier
    Declare Function GetLocaleInfo Lib "kernel32" Alias "GetLocaleInfoA" (ByVal Locale As Long, ByVal LCType As Long, ByVal lpLCData As String, ByVal cchData As Long) As Long
#End If
'Declare Function GetLocaleInfo Lib "kernel32" Alias "GetLocaleInfoA" (ByVal Locale As Long, ByVal LCType As Long, ByVal lpLCData As String, ByVal cchData As Long) As Long
Public Const LOCALE_NOUSEROVERRIDE = &H80000000
Public Const LOCALE_SDECIMAL = &HE
Public Const LOCALE_SGROUPING = &H10
Public Const LOCALE_STHOUSAND = &HF
Public Const LOCALE_SDATE = &H1D
Public Const LOCALE_SSHORTDATE = &H1F
Public Const LOCALE_SLONGDATE = &H20

Public Const LOCALE_SMONDECIMALSEP = &H16        '  monetary decimal separator
Public Const LOCALE_SMONTHOUSANDSEP = &H17        '  monetary thousand separator


Public arrPic() As String '''' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|' Spiridonova 10.07.2012
Public gcDirTemp As String  ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Spiridonova 25.07.2012
Public gcInkod As String   '' InKod Spiridonova 25.07.2012

Public gCollFormat As New Collection ''<SPIR> 15.10.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|)

Dim v() As String
Dim lErr As Boolean

'Public arrShPic() As String '''' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|' Spiridonova 10.07.2012


'Ivanov 29/06/2011 ============
Public Function vbGetLocaleInfo(lcInfoType&) As String  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|

    Dim Locale As Long, lpLCData As String, cchData As Long
    lpLCData = Space(16)
    cchData = 16
    If GetLocaleInfo(Locale, lcInfoType, lpLCData, cchData) Then vbGetLocaleInfo = left$(lpLCData, 1)
End Function
'=============================

'Dim err(1 To 100, 1 To 2) As String

Public Function fGetDdata(a() As Variant, b() As Variant) As Variant
Dim idForm$

idForm = UCase(sGetINI("idForm", "?"))
If idForm = "14R" Or idForm = "14R_179" Or idForm = "14R_OKTMO" Or idForm = "14R_OKTMO_2018" Then
    fGetDdata = Rasstanovka014rFromArray(b)
    Exit Function
End If
'If idForm = "14" Then
If idForm = "14" Then
    fGetDdata = Rasstanovka014FromArray(b)
    Exit Function
End If
'17.01.2011
If idForm = "14_179" Then
    fGetDdata = Rasstanovka014FromArray_179(b)
    Exit Function
End If
'20.06.2016
If idForm = "14_86" Then
    fGetDdata = Rasstanovka014FromArray_86(b)
    Exit Function
End If
'15.01.2018
If idForm = "14_2018" Then
    fGetDdata = Rasstanovka014FromArray_2018(b)
    Exit Function
End If

fGetDdata = fGetDdataVnew(a, b)

'17.01.2011
'fGetDdata = fGetDdataV(A, B)
End Function

    ' Spiridonova 10.07.2012
Public Function fGetImage(c() As Variant) As Variant
Dim idForm$
Dim Result As Variant

    Result = -1
    If Not IsArray(c) Or IsEmpty(c) Then GoTo finally
    'Spiridonova 25.07.2012
    gcDirTemp = c(1, 1) '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    gcInkod = Trim(ActiveWorkbook.Application.Range("Data_Cells").Cells(1, 7).Value)
    'Spiridonova 25.07.2012
    
    If UBound(c) = 1 Then
        ' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        Result = 0
    Else
        Result = ProcessingPic(c)
        'If Result <> 0 Then Result = 0
    End If
finally:
fGetImage = Result
End Function
    ' Spiridonova 10.07.2012

Function fGetDdataVnew(a() As Variant, b() As Variant) As Variant
Dim idForm As String, flgDs As Boolean, flg128 As String, k As Long, u As Long
Dim iAK As Long, i As Long, j As Long, Rds As Range, n As Long, sname$, Val1 As Variant, s$, s1$
Dim sKod$, sKod1$, sKodDs$, Row As Long, indWS As Long, sDSName$, strMErr$
Dim Result As Variant
Dim masN(), l As Long, sKOdOld$
Dim strDecSeparator As String   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Dim blnIfSeparator As Boolean   '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Dim sNameProc As String         '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim r As Range
Dim arrFormat() As Variant
Dim rData_CollFormat As Range

'Ivanov 29/06/2011 ============
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    strDecSeparator = vbGetLocaleInfo(LOCALE_SDECIMAL)
    If strDecSeparator <> Application.International(3) Then
        '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        blnIfSeparator = True
    Else
        blnIfSeparator = False
    End If
'=============================

ReDim err(1 To 100, 1 To 2)
u = LBound(err, 1)

''<SPIR>19.11.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| ModNewRasstanovrf.DataEndInsert |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Format =Data_KLD(000 0 00 00000 00 0000 000) |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
fSaveFilterAndFormat

Result = -1
If Not IsArray(a) Or IsEmpty(a) Then GoTo finally
If Not IsArray(b) Or IsEmpty(b) Then GoTo finally

'    '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 17.01.2013
'    If Day(Date) > 2 And Day(Date) < 20 Then
'        strMErr = sMsg
'        sKod = left(Trim(ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range("Data_FKR").Cells(1, 1).Value), 3)
'        'If sKod = "100" Or sKod = "189" Then GoTo A1
'        If HasElinStr(sNameGl, sKod) Then GoTo finallyErr
'        sKod = left(Trim(ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range("Data_KLD").Cells(1, 1).Value), 3)
'        If HasElinStr(sNameGl, sKod) Then GoTo finallyErr
'        sKod = left(Trim(ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range("Data_IFV").Cells(1, 1).Value), 3)
'        If HasElinStr(sNameGl, sKod) Then GoTo finallyErr
'    End If
'    '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|

'<SPIR> 15.10.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|)
If HasName("Data_CollFormat") Then
    Set rData_CollFormat = ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range("Data_CollFormat")
    With gCollFormat
        If .Count <> rData_CollFormat.Rows.Count Then  ' |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
            For i = 1 To rData_CollFormat.Rows.Count
                '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                ReDim arrFormat(1 To rData_CollFormat.Columns.Count - 1)
                For j = 1 To rData_CollFormat.Columns.Count - 1
                    arrFormat(j) = rData_CollFormat.Cells(i, j + 1).Value
                Next j
                '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                .Add arrFormat, rData_CollFormat.Cells(i, 1).Value
            Next i
        End If
    End With
Else
'    gCollFormat.Add Null, "ElNull"
End If

idForm = UCase(sGetINI("idForm", "?"))
If UCase(Trim(sGetINI("UseDataSheetInCodName", "OFF"))) = "ON" Then flgDs = True
flg128 = sGetINI("flKod", "?")
If idForm = "125" Then iAK = Val(sGetINI("OKATO", "11"))
If idForm = "125_1" Then iAK = Val(sGetINI("OKATO\" & Range("Kod_Account").Value & "\", "8"))
If idForm = "125_1" Then flg128 = Val(sGetINI("flKod\" & Range("Kod_Account").Value & "\", "8"))
UnProtectBook
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| Data_Sheet-|fffd||fffd|
ReDim masN(1 To UBound(a), 1 To 2)
For i = LBound(a) To UBound(a)
  k = a(i, 2)
  
  '''''' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|
  If idForm = "125" And k = 0 Then
    l = 0
    sKOdOld = ""
    For j = LBound(b) To UBound(b)
      sKod = Trim$(b(j, 1))  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
      If left$(sKod, 2) = "ss" And (sKod Like "*[!a-z][a-z]") Then
        sKod = Mid(sKod, 3, Len(sKod) - 3)
        If sKod <> sKOdOld Then
            l = l + 1
            sKOdOld = sKod
            If sKod = "5000" Then l = l - 1 '10.02.2011 |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        End If
      End If
    Next j
    If l <> 0 Then
        'k = l - 1 10.02.2011
        k = l '10.02.2011
    End If
  End If
  ''''''
  
  masN(i, 1) = a(i, 1)
  masN(i, 2) = 1
  
  '|fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| Data_Spr1
  'If k = 0 Then k = IIf(flgDs, GetCountRows125New(b()), GetCountRows125)
  If k = 0 Then GoTo A1
  Set Rds = Range("Data_Sheet" & a(i, 1))
  
  ' Spiridonova 10.12.2009 - |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| Data_Sheet-a
  sKod = sGetINI("Data_Sheet" & a(i, 1) & "!Kod", "?")
  If sKod Like "*$*" Then GoTo A1
  '
  ActiveWorkbook.Sheets(Rds.Worksheet.name).Select
  n = Rds.Row + Rds.Rows.Count - 1
  Rows(n & ":" & n + k - 1).Insert Shift:=xlDown
A1:
Next i

'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'Spiridonova 19/12/2012
sNameProc = sGetINI("BeforeProc", "?")
If sNameProc <> "?" Then
    Application.Run ActiveWorkbook.name & "!" & Trim$(sNameProc), b
End If
'If idForm = "AKT_KP" Then Application.Run ActiveWorkbook.name & "!fAddPril2"

'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd| |fffd| [FZ_AKT]) |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'Spiridonova 19/11/2012
sNameProc = sGetINI("idForm", "?")
'Spiridonova 19/11/2012

Row = 1
l = 1
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|.|fffd|. |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|
For i = LBound(b) To UBound(b)
        'Ivanov 29/06/2011 ============
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        If blnIfSeparator Then
            If IsNumeric(b(i, 2)) Then
                b(i, 2) = Replace(b(i, 2), ",", ".", 1, 1, vbBinaryCompare)
            End If
        End If
        '==============================
      sname = Trim$(b(i, 1))   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
      
      'Spiridonova 12/12/2012
      If sNameProc = "STATIC_FORM" Then
        If HasName(sname) Then Range(sname) = b(i, 2)
      Else
        If Not sname Like "ss*" Then
          If HasName(sname) Then Range(sname) = b(i, 2)
        End If
     End If
     'Spiridonova 12/12/2012

'    If Not sname Like "ss*" Then
'      If HasName(sname) Then Range(sname) = b(i, 2)
'    End If
Next i

'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd| |fffd| [FZ_AKT]) |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'Spiridonova 19/11/2012
'sNameProc = sGetINI("idForm", "?")
If sNameProc = "STATIC_FORM" Then
    If l > 1 Then
       Result = err
    Else
       Result = 0
    End If
    ProtectBook 'Spiridonova 12/12/2012
    GoTo finally
End If
'Spiridonova 19/11/2012


If UBound(b) < 3000 Then    '24.02.2012
    Call Quicksort(b, LBound(b), UBound(b))  '10.02.2011 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'    If IsNumeric(b(UBound(b), 2)) Then
'        b(UBound(b), 2) = str(b(UBound(b), 2))  '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|
'    End If
    ''Spir 13.01.2016 |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    If HasName("Data_CollFormat") Then
        For i = LBound(b) To UBound(b)
            b(i, 2) = Format(b(i, 2), "@")
        Next i
    End If
End If

If left(Range("Kod_OTD").Cells(1, 1), 2) = "00" Then plGR = True Else plGR = False ''12.12.2014

''12.12.2014
If idForm = "125_1" Then
    s = sGetINI("SortCell\" & Range("Kod_Account").Value & "\", "?")
    If s <> "?" Then
        Sort125 b
    End If
    s = sGetINI("FillCells\" & Range("Kod_Account").Value & "\", "?")
    If s <> "?" Then
        FillCells s
    End If
    s = sGetINI("FillCellsF\" & Range("Kod_Account").Value & "\", "?")
    If s <> "?" Then
        FillCellsF s
    End If
    RestrictionList
    ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd|1").Activate
    fUnProtect True
End If
''12.12.2014

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
For i = LBound(b) To UBound(b)
      sname = Trim$(b(i, 1))   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
      If Not sname Like "ss*" Then GoTo A3 ' "ss*[a-h]"
      Val1 = b(i, 2)
      If HasName(sname) Then
        If left(Range(sname).Formula, 1) <> "=" Then
            Range(sname) = Val1: GoTo a2
        Else
            GoTo a2
        End If
      End If
      'If Len(sName) < 20 Then GoTo A3
      
      '<SPIR>25122015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| 0503190)
      If Not IsNumeric(Mid$(sname, Len(sname) - 1, 1)) Then
        If 96 < Asc(Mid$(sname, Len(sname) - 1, 1)) < 123 Then  ' |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd|
            ''<Spir>29112018 ~7519 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            If UCase(Mid$(sname, Len(sname) - 1, 1)) = Mid$(sname, Len(sname) - 1, 1) Then
                sKod = Mid$(sname, 3, Len(sname) - 3)
            Else
                sKod = Mid$(sname, 3, Len(sname) - 4)
            End If
'            sKod = Mid$(sname, 3, Len(sname) - 4)
        Else
            sKod = Mid$(sname, 3, Len(sname) - 3)
        End If
      Else
        sKod = Mid$(sname, 3, Len(sname) - 3)
      End If
''      sKod = Mid$(sName, 3, Len(sName) - 3)
      
      If sKod <> sKod1 And Len(sKod) > gLenDopKodForCodName Then    ' |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
         sKod1 = sKod
         If flgDs = True Then
           sKodDs = Mid(sKod, 1, gLenDopKodForCodName)
           
           'Row = Row + 1
           For j = LBound(b) To UBound(b)
                If Trim(masN(j, 1)) = Trim(sKodDs) Then
                    Row = masN(j, 2) + 1
                    masN(j, 2) = Row
                    Exit For
                End If
           Next
           
           Select Case idForm
                Case "125"
                    sKodDs = "01"
                    addRowF125 sKod, Range("Data_Sheet" & sKodDs), iAK, Row, flg128
                Case "169"
                    sKodDs = "01"
                    addRowF169 sKod, Range("Data_Sheet" & sKodDs), Row
                Case "169N2015", "169N2016"
                     sDSName = "Data_Sheet" & sKodDs
                     addRowF169n sKod, Range(sDSName), Row
                Case "169N2013"
                     sDSName = "Data_Sheet" & sKodDs
                     addRowF169n sKod, Range(sDSName), Row
                 Case "169N"
                     sDSName = "Data_Sheet" & sKodDs
                     addRowF169n sKod, Range(sDSName), Row
               Case "725"
                    sKodDs = "01"
                    addRowF725 sKod, Range("Data_Sheet" & sKodDs), iAK, Row, flg128
               Case "125_1"
                    sKodDs = "01"
                    addRowF125_1 sKod, Range("Data_Sheet" & sKodDs), iAK, Row, flg128
                    fUnProtect True
                Case Else
                    sDSName = "Data_Sheet" & sKodDs
                    indWS = fGetNameKod(sKod, sDSName)
                    
                    If indWS = 0 And lErr Then
                        err(l, 1) = sname
                        l = l + 1
                        'GoTo A2
                    End If
                    
                    If indWS = 1 Then
                        For j = 1 To UBound(v, 1)
                            s = v(j, 0)
                            If Len(s) > 0 Then Range(sDSName).Cells(Row, j) = s ' |fffd||fffd||fffd|
                            s1 = v(j, 1)
                            If Len(s1) > 0 Then Range(sDSName).Cells(Row, j) = s1 '  |fffd||fffd||fffd|
                        Next j
                    End If
                    fInsertNameStr sDSName, sKod, Row
                    
                    '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                    'N.Tanina, Dec.2016
                    sNameProc = sGetINI(sDSName & "!ProcCell", "?")
                    If sNameProc <> "?" Then
                        Application.Run ActiveWorkbook.name & "!" & Trim$(sNameProc), Range(sDSName).Row + Row - 1, sKod
                    End If
                    
                    '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                    'ivanov 23/12/2011
                    sNameProc = sGetINI(sDSName & "!Proc", "?")
                    If sNameProc <> "?" Then
                        Application.Run ActiveWorkbook.name & "!" & Trim$(sNameProc), Range(sDSName).Row + Row - 1, IIf(Len(sKod) > gLenDopKodForCodName, Mid(sKod, gLenDopKodForCodName + 1), sKod)
                    End If
                    
           End Select
           
'           If idForm = "125" Then
'           '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'           '|fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| = +1
'             sKodDs = "01"
'             addRowF125 sKod, Range("Data_Sheet" & sKodDs), iAK, Row, flg128
'           Else
'                If idForm = "169" Then
'                    sKodDs = "01"
'                    addRowF169 sKod, Range("Data_Sheet" & sKodDs), Row
'                Else
'                    If idForm = "169n" Then
'                       sKodDs = "01"
'                       addRowF169n sKod, Range("Data_Sheet" & sKodDs), Row
'                    Else
'
'                        '''''
'                        sDSName = "Data_Sheet" & sKodDs
'                        indWS = fGetNameKod(sKod, sDSName)
'
'                        If indWS = 0 And lErr Then
'                            err(l, 1) = sName
'                            l = l + 1
'                            'GoTo A2
'                        End If
'
'                        If indWS = 1 Then
'                            For j = 1 To UBound(v, 1)
'                                s = v(j, 0)
'                                If Len(s) > 0 Then Range(sDSName).Cells(Row, j) = s ' |fffd||fffd||fffd|
'                                s1 = v(j, 1)
'                                If Len(s1) > 0 Then Range(sDSName).Cells(Row, j) = s1 '  |fffd||fffd||fffd|
'                            Next j
'                        End If
'                        fInsertNameStr sDSName, sKod, Row
'                        '''''
'
'                        'fInsertNameStr "Data_Sheet" & sKodDs, sKod, Row
'                    End If
'                End If
'           End If
         End If
      End If
      On Error GoTo A3
      If HasName(sname) Then If Range(sname).Value = "" Then Range(sname) = Val1: GoTo a2
A3:
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| Err
'If sName Like "ss*" And l <= u Then
'    err(l, 1) = sName
'    l = l + 1
'End If
a2:
Next i

'' Spiridonova 10.07.2012
'If c(1, 1) = "1" Then
'    ' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'Else
'    Result = ProcessingPic(c)
'    If Result = -1 Then l = l + 1
'End If
'' Spiridonova 10.07.2012

'' 25/12/2012 Spiridonova
''|fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| DSItog1!NoProtect
sNameProc = sGetINI("DSItog1!NoProtect", "?")
If sNameProc <> "?" Then
    Set r = Range("DSItog1")
    r.Worksheet.Activate
    Set r = Range("Data_Itogi")
    For i = LBound(b) To UBound(b)
          sname = Trim$(b(i, 1))
          If sname Like "si_*" Then
            r.Rows(r.Rows.Count & ":" & r.Rows.Count).Insert Shift:=xlDown
            r.Cells(r.Rows.Count - 1, 1).Value = sname
            r.Cells(r.Rows.Count - 1, 2).Value = Trim$(b(i, 2))
          End If
    Next i
    Call GroupMain
End If
''


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd|.|fffd|. |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd|
If idForm = "125" Or idForm = "125_1" Then AddOrgName
ActiveWorkbook.Saved = True
fShowCmdInsDelRow True
ProtectBook

If l > 1 Then
   Result = err
Else
   Result = 0
End If

'Exit Function
'
'finallyErr:
'    MsgBox strMErr, vbInformation, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
    
finally:
fGetDdataVnew = Result
End Function

'''' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
' Spiridonova 10.07.2012
Public Function CreateArrPic() As Variant
    Dim i As Long, nRows As Long, j As Long, iPic As Long
    Dim IsError As Boolean  '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Dim NumErr As Long      '|fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Dim strErr As String    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    
    IsError = False
'    Application.ScreenUpdating = False
    
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    nRows = ActiveWorkbook.Application.Range("Data_Cells").Rows.Count
    iPic = 0
    For i = 1 To nRows
        If ActiveWorkbook.Application.Range("Data_Cells").Cells(i, 2).Value = "P" Then
          iPic = iPic + 1
          ReDim Preserve arrPic(1 To 7, 1 To iPic)
          arrPic(1, iPic) = ActiveWorkbook.Application.Range("Data_Cells").Cells(i, 1).Value '|fffd||fffd||fffd|
          arrPic(2, iPic) = ActiveWorkbook.Application.Range("Data_Cells").Cells(i, 2).Value '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
          arrPic(4, iPic) = ActiveWorkbook.Application.Range("Data_Cells").Cells(i, 4).Value '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
          arrPic(6, iPic) = ActiveWorkbook.Application.Range("Data_Cells").Cells(i, 6).Value '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
          arrPic(7, iPic) = ActiveWorkbook.Application.Range("Data_Cells").Cells(i, 7).Value '|fffd||fffd|. |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
       End If
    Next i
    
    If IsError Then
        MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|! |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & _
                "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: 'ProcessingPic'" & vbCrLf & _
                "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|: " & NumErr & vbCrLf & _
                "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & strErr, vbOKOnly + vbCritical, "|fffd||fffd||fffd||fffd||fffd||fffd|"
                CreateArrPic = -1
    End If
    CreateArrPic = 0
    
End Function

'''' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
' Spiridonova 10.07.2012
Public Function ProcessingPic(arrPicFile() As Variant) As Variant
    Dim i As Long, nRows As Long, j As Long, iPic As Long
    Dim lYes As Boolean
    Dim lnHeight  As Long, lnWidth  As Long, lnHeightR  As Long, lnWidthR  As Long
    Dim arrProp, loPic As Object
    Dim IsError As Boolean  '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Dim NumErr As Long      '|fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Dim strErr As String    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|

    On Error GoTo errHandler
    IsError = False
   Application.ScreenUpdating = False
   fUnProtect True
    
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    nRows = UBound(arrPicFile)    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    For i = 2 To nRows
        For j = 1 To UBound(arrPic, 2)
            If arrPic(1, j) = arrPicFile(i, 1) Then
                Application.Worksheets(arrPic(6, j)).Select
                
                Application.Cells(Range(arrPicFile(i, 1)).Cells(1, 1).Row + 1, Range(arrPicFile(i, 1)).Cells(1, 1).Column).Select ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
                fUnProtect True
                Application.ActiveSheet.Pictures.Insert(arrPicFile(i, 2)).name = arrPicFile(i, 1)
                Set loPic = Application.ActiveSheet.Pictures(arrPicFile(i, 1))  '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                'Spiridonova 10.09.2012
                '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|
                loPic.Select
                Selection.OnAction = "'fClickOpen """ & arrPicFile(i, 1) & """'"
                
                ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'                arrProp = Split(arrPic(7, j), ",", , 1) ' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| Height,Width,Top,Left |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd|
'                Application.Cells(Range(arrPicFile(i, 1)).Cells(1, 1).Row + 1 + Val(arrProp(0)), Range(arrPicFile(i, 1)).Cells(1, 1).Column + Val(arrProp(1))).Select

                If arrPic(7, j) <> "" Then
                    Application.Range(arrPic(7, j)).Select
                    lnHeightR = Application.Selection.Height
                    lnWidthR = Application.Selection.Width
                    
                    lnHeight = loPic.Height
                    lnWidth = loPic.Width
                    If loPic.Height > lnHeightR Then
                        loPic.Height = lnHeightR
                        If loPic.Width > lnWidthR Then
                            loPic.Width = loPic.Width * loPic.Height / lnHeight
                        End If
                    End If
                    If loPic.Width > lnWidthR Then
                        lnWidthR = loPic.Width
                        loPic.Width = Application.Selection.Width
                        If loPic.Height > lnHeightR Then
                            loPic.Height = loPic.Width * loPic.Height / lnWidthR
                        End If
                    End If
                    
                    loPic.Top = Application.Selection.Top
                    loPic.left = Application.Selection.left
                End If
                Exit For
                
                fUnProtect False
                
            End If
        Next j
        
        'Kill arrPicFile(i, 2)    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
        
    Next i
'    Application.Worksheets(1).Select
    
'    MsgBox "*** ProcessingPic ***"
    
    fUnProtect False
    Application.ScreenUpdating = True
    Application.Worksheets(1).Activate
    Range("Name_OTD").Activate

    ProcessingPic = 0
    Exit Function
    
errHandler:
    IsError = True
    NumErr = err.Number
    strErr = err.Description
        MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|! |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & _
                "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: 'ProcessingPic'" & vbCrLf & _
                "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|: " & NumErr & vbCrLf & _
                "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & strErr, vbOKOnly + vbCritical, "|fffd||fffd||fffd||fffd||fffd||fffd|"
                ProcessingPic = -1
'    Resume Next

End Function

Sub addRowF125(sKod$, r As Range, iAK As Long, Optional Row As Long, Optional flg128$, Optional newNameOrg$)
Dim s$, fl128 As Long, n As Long

If flg128 <> "?" Then fl128 = 1
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
n = 3 + fl128
r.Cells(Row, 1) = Mid$(sKod, n, 6)
n = n + 6
'|fffd||fffd||fffd|
If r.Cells(1, 3) <> "X" Then
    r.Cells(Row, 3) = Mid$(sKod, n, 3)
    n = n + 3
Else
    r.Cells(Row, 3) = "X"
End If
'|fffd||fffd||fffd||fffd||fffd|
If r.Cells(1, 4) <> "X" Then
    r.Cells(Row, 4) = Mid$(sKod, n, iAK)
    n = n + iAK
Else
    r.Cells(Row, 4) = "X"
End If
'|fffd||fffd|-|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If r.Cells(1, 5) <> "X" Then
    r.Cells(Row, 5) = Mid$(sKod, n, 2)
    n = n + 2
Else
    r.Cells(Row, 5) = "X"
End If
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If r.Cells(1, 6) <> "X" Then
    r.Cells(Row, 6) = Mid$(sKod, n, 17) & left$(Range("Kod_Account").Cells(1, 1).Value, 6) & Mid$(sKod, n + 17, 3)
    n = n + 17 + 3
Else
    r.Cells(Row, 6) = "X"
End If
'|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
r.Cells(Row, 9) = IIf(r.Cells(1, 9) <> "X", Mid$(sKod, n, 9), "X")

fNameForDSandCells r, sKod, Row, "1"
End Sub

Public Function fNameForDSandCells(r As Range, ByVal sKod$, Optional Row As Long = 0, Optional strNotSave$) As Boolean
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| row = |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 To R.Rows.Count
Dim j As Long, sname$, n As Long, sAd$

'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| -1 |fffd|.|fffd|. |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
If Row > r.Rows.Count Then Debug.Print "fInsertNameStr |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| " & str(Row) & " |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Function
If Row = 0 Then Row = r.Rows.Count - 1
For j = 1 To r.Columns.Count
    '|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If IsFirstCell(r.Cells(1, j)) = False Then GoTo A1
    If left(r.Cells(1, j).Formula, 1) = "=" Then r.Cells(1, j).Copy r.Cells(Row, j): GoTo A1
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    If Len(fCellsName(r.Cells(Row, j))) > 0 Then GoTo A1
    '|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If Not r.Cells(Row, j).Interior.ColorIndex = 35 Then GoTo A1
    n = n + 1
    sname = "ss" & sKod
    If n > 26 Then sname = sname & "a" & Chr(96 + n - 26) Else sname = sname & Chr(96 + n)
    sAd = "='" & r.Worksheet.name & "'!" & r.Cells(Row, j).Address
    ActiveWorkbook.Names.Add name:=sname, RefersTo:=sAd
    If HasElinStr(strNotSave, str(n)) = False And r.Cells(1, j).Value <> "X" Then fSaveData_Cells sname, r.Cells(Row, j).NumberFormat
A1:
Next j
'If n > 0 Then
fNameForDSandCells = True
End Function

''<Spir>20.06.2016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd|169 (|fffd||fffd| fNameForDSandCells)
Public Function fNameForDSandCells_F(r As Range, ByVal sKod$, Optional Row As Long = 0, Optional strNotSave$) As Boolean
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| row = |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 To R.Rows.Count
Dim j As Long, sname$, n As Long, sAd$

'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| -1 |fffd|.|fffd|. |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
If Row > r.Rows.Count Then Debug.Print "fInsertNameStr |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| " & str(Row) & " |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Function
If Row = 0 Then Row = r.Rows.Count - 1
For j = 1 To r.Columns.Count
    '|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If IsFirstCell(r.Cells(1, j)) = False Then GoTo A1
    If left(r.Cells(1, j).Formula, 1) = "=" Then r.Cells(1, j).Copy r.Cells(Row, j) '': GoTo A1  <Spir>20.06.2016
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    If Len(fCellsName(r.Cells(Row, j))) > 0 Then GoTo A1
    '|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If Not r.Cells(Row, j).Interior.ColorIndex = 35 Then GoTo A1
    n = n + 1
    sname = "ss" & sKod
    If n > 26 Then sname = sname & "a" & Chr(96 + n - 26) Else sname = sname & Chr(96 + n)
    sAd = "='" & r.Worksheet.name & "'!" & r.Cells(Row, j).Address
    ActiveWorkbook.Names.Add name:=sname, RefersTo:=sAd
    If HasElinStr(strNotSave, str(n)) = False And r.Cells(1, j).Value <> "X" Then fSaveData_Cells sname, r.Cells(Row, j).NumberFormat
A1:
Next j
'If n > 0 Then
fNameForDSandCells_F = True
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| xml |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function DBToArray125() As Variant
Dim sFName$, sql$, a() As Variant, i As Long, s$, b() As Variant
Dim db As Database, rs As Recordset

ReDim a(1 To 1, 2)
a(1, 1) = "01"
sFName = "c:\|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|\db4.mdb"
Set db = OpenDatabase(sFName, False, False)
sql = "Select * From cur_ddata"
Set rs = db.OpenRecordset(sql, dbOpenDynaset, dbReadOnly)
  rs.MoveLast
  rs.MoveFirst
ReDim b(1 To rs.RecordCount, 2)
i = LBound(b)
Do Until rs.EOF
b(i, 1) = rs("cell")
b(i, 2) = IIf(rs("var_f") > 0, rs("var_f"), rs("var_c"))
  rs.MoveNext
  i = i + 1
Loop

fGetDdataVnew a, b
DBToArray125 = b
End Function


Public Sub AddOrgName()
Dim r As Range, R1 As Range, sAd$, i As Long

Set r = Range("Data_Sheet01")
sAd = "='" & "|fffd||fffd||fffd||fffd|1" & "'!" & Range(Cells(r.Row, 1), Cells(r.Row + r.Rows.Count - 1, 1)).Address
Set R1 = Range(sAd)
For i = 2 To R1.Rows.Count - 1
    If R1.Cells(i, 1) Like "1*" And Len(R1.Cells(i, 2).Value) = 0 Then R1.Cells(i, 2) = SprValue(Mid(R1.Cells(i, 1), 2), "Data_ORG")
Next i
End Sub

Sub addRowF169(sKod$, r As Range, Optional Row As Long)
'|fffd||fffd||fffd||fffd|
r.Cells(Row, 1) = Mid$(sKod, 3, 9)
'|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
r.Cells(Row, 4) = Mid$(sKod, 12, 4)
'fNameForDSandCells R, sKod, row, "1"
fNameForDSandCells r, sKod, Row
End Sub

Public Function fGetNameKod(ByVal sKod$, ByVal sDSName$) As Long
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| sKod |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| sDSName
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini |fffd||fffd||fffd||fffd||fffd| (!Name) (!Kod)

Dim a As Worksheet
Dim iTipe As Long, sTipeSp$, i As Long, j As Long, s$, sSp$, sname$, sNameStr$, sKodStr$, S3$, sFKod$, sKodSp$
Dim k0 As Long, k As Long, sKod1$, sKod3$, m As Long, k4 As Long, ii As Long, sTipeSp4$
Dim flUn As Long   '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| GoTo A2 >1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim idForm$
'Dim V() As String
'If Len(sKod) = 0 Then Exit Function

lErr = False

'For Each a In ActiveWorkbook.Worksheets
    'If a.Visible = False Then GoTo A1
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    sKodSp = Mid(sKod, gLenDopKodForCodName + 1, Len(sKod) - gLenDopKodForCodName)
    sKod = sKodSp
    
    sTipeSp = sGetINI(sDSName & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
    sKodStr = sGetINI(sDSName & "!Kod", "?")
    sNameStr = sGetINI(sDSName & "!Name", "?")
    idForm = sGetINI("idForm", "?")
    If sTipeSp = "?" Or sKodStr Like "*$*" Then GoTo A1
    i = MaxStrEl(sKodStr): j = MaxStrEl(sNameStr)
    If j > i Then i = j
    If i > 0 Then ReDim v(i, 2) Else GoTo A1
iTipe = VarAddForm(sDSName)
k0 = 1: k = 0
''<Spir>18032016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| SGU
'If iTipe = 1 And sTipeSp <> "Data_SGU" Then
'    sTipeSp = sReplace(sTipeSp, "Data_SGU", "")
If iTipe = 1 And sTipeSp <> "Data_SGU" Then
    sTipeSp = sReplace(sTipeSp, "Data_SGU", "")
        For i = 1 To StrEl(sTipeSp)
        sSp = StrEl(sTipeSp, i)
        ''<SPIR>22012016 |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd|
'        If sSp Like "Data_FKR" Then
'            If Len(fIncludeSpr(left$(sKod, Len(sKod) - 3), "Data_FKR")) > 0 Then
'                        sName = fIncludeSpr(Right$(sKod, 3), "Data_SGU")
'                        sFKod = fFormat(left$(sKod, Len(sKod) - 3), "Data_FKR") & sR & Right$(sKod, 3)
'            End If
'        Else
'            sName = fIncludeSpr(sKod, sSp)
'            sFKod = fFormat(sKod, sSp)
'        End If
        If sSp Like "Data_FKR" And sSp Like "Data_SGU" Then
            If Len(fIncludeSpr(left$(sKod, Len(sKod) - 3), "Data_FKR")) > 0 Then
                        sname = fIncludeSpr(Right$(sKod, 3), "Data_SGU")
                        sFKod = fFormat(left$(sKod, Len(sKod) - 3), "Data_FKR") & sR & Right$(sKod, 3)
            End If
        Else
            sname = fIncludeSpr(sKod, sSp)
            sFKod = fFormat(sKod, sSp)
        End If
        ''<SPIR>22012016 |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd|
        If Len(sname) > 0 Then
            j = Val(StrEl(sKodStr, 1)): v(j, 0) = sFKod
            j = Val(StrEl(sNameStr, 1)): v(j, 1) = sname
        GoTo a2 'flUn = flUn + 1
        End If
    Next i
End If
''<Spir>18032016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| SGU
If iTipe = 1 And sTipeSp = "Data_SGU" Then
    sSp = "Data_SGU"
    sname = fIncludeSpr(sKod, sSp)
    sFKod = fFormat(sKod, sSp)
    If Len(sname) > 0 Then
        j = Val(StrEl(sKodStr, 1)): v(j, 0) = sFKod
        j = Val(StrEl(sNameStr, 1)): v(j, 1) = sname
        GoTo a2 'flUn = flUn + 1
    End If
End If
''<Spir>18032016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| SGU
If iTipe = 2 Or iTipe = 3 Then
    For i = 1 To StrEl(sTipeSp)
        sSp = StrEl(sTipeSp, i)
        k0 = k0 + k
        k = fLenSpr(sSp)
        sKod1 = Mid$(sKod, k0, k)
        sname = fIncludeSpr(sKod1, sSp)
        If Len(sname) = 0 Then GoTo A1
        j = Val(StrEl(sNameStr, i))
        If sname = "TXT" Then j = 0
        If j > 0 Then v(j, 1) = sname
        m = Val(StrEl(sKodStr, i))
'-------------------------------------15.10.2015
'        If iTipe = 3 And m > 0 Then v(m, 0) = fFormat(sKod1, sSp)
        If iTipe = 3 And m > 0 Then
            Select Case idForm
                Case "SostavKod"
                    v(m, 0) = Trim(v(m, 0)) & " " & fFormat(sKod1, sSp)
                Case Else
                    v(m, 0) = fFormat(sKod1, sSp)
            End Select
        End If
'-------------------------------------15.10.2015
        If iTipe = 2 Then sKod3 = sKod3 & fFormat(sKod1, sSp) & sR
    Next i
    If iTipe = 2 Then
        j = Val(StrEl(sKodStr, 1))
        If Right$(sKod3, 1) = sR Then sKod3 = left$(sKod3, Len(sKod3) - 1)
        'S3 = sReplace(sKod3, sR, "")
        'If S3 = sKod Then v(j, 0) = sKod3 Else v(j, 0) = sKod
        v(j, 0) = sKod3
    End If
    GoTo a2 'flUn = flUn + 1
End If
If iTipe = 4 Then
    j = Val(StrEl(sKodStr, 1))
    m = Val(StrEl(sNameStr, 1))
    k4 = StrEl(sTipeSp, 0, ";")
    For ii = 1 To k4
        k0 = 1: k = 0
        sTipeSp4 = StrEl(sTipeSp, ii, ";")
        'sTipeSp4 = sReplace(sTipeSp4, "Data_SGU", "")
        For i = 1 To StrEl(sTipeSp4)
            sSp = StrEl(sTipeSp4, i)
            k0 = k0 + k
            k = fLenSpr(sSp)
            sKod1 = Mid$(sKod, k0, k)
            sname = fIncludeSpr(sKod1, sSp)
            If Len(sname) = 0 Then GoTo A3
            sFKod = sFKod & fFormat(sKod1, sSp) & sR
            'j = Val(StrEl(sNameStr, i))
            'If j > 0 Then V(j, 1) = sName
            'm = Val(StrEl(sKodStr, i))
            'If iTipe = 3 And m > 0 Then V(m, 0) = sKod1
            If i = 1 Then v(m, 1) = sname
        Next i
        If Right$(sFKod, 1) = sR Then sFKod = left$(sFKod, Len(sFKod) - 1)
         v(j, 0) = sFKod
         
        GoTo a2 'flUn = flUn + 1
A3:
    Next ii
End If

A1:
'Next

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| xls
'Debug.Print sKod & "- |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
lErr = True
Exit Function
a2:
fGetNameKod = 1
'For i = 1 To UBound(v, 1)
''Debug.Print i & " |fffd||fffd||fffd| = " & v(i, 0) & " |fffd||fffd||fffd| =  " & v(i, 1)
'Next i
End Function

Sub Quicksort(values(), ByVal min As Long, ByVal max As Long)

  Dim med_value As String, med_value2 As String
  Dim hi As Long
  Dim lo As Long
  Dim i As Long

  ' |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.
  If min >= max Then Exit Sub

  ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.
  i = min + Int(Rnd(max - min + 1))
  med_value = values(i, 1)
  med_value2 = values(i, 2)

  ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|.
   values(i, 1) = values(min, 1)
'   If IsNumeric(values(min, 2)) Then
'    values(i, 2) = Format(values(min, 2), "@")
'   Else
    values(i, 2) = values(min, 2)
'   End If
  ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|.
  lo = min
  hi = max
  Do
    Do While values(hi, 1) >= med_value
      hi = hi - 1
      If hi <= lo Then Exit Do
    Loop

    If hi <= lo Then
      values(lo, 1) = med_value
      values(lo, 2) = med_value2
      Exit Do
    End If

    values(lo, 1) = values(hi, 1)
'    values(lo, 2) = values(hi, 2)
'   If IsNumeric(values(hi, 2)) Then
'    values(lo, 2) = Format(values(min, 2), "@")
'   Else
    values(lo, 2) = values(hi, 2)
'   End If

    lo = lo + 1
    Do While values(lo, 1) < med_value
      lo = lo + 1
      If lo >= hi Then Exit Do
    Loop

    If lo >= hi Then
      lo = hi
      values(hi, 1) = med_value
      values(hi, 2) = med_value2
      Exit Do
    End If

    values(hi, 1) = values(lo, 1)
'    values(hi, 2) = values(lo, 2)
'   If IsNumeric(values(lo, 2)) Then
'    values(hi, 2) = Format(values(min, 2), "@")
'   Else
    values(hi, 2) = values(lo, 2)
'   End If
  Loop

  ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.
  Quicksort values, min, lo - 1
  Quicksort values, lo + 1, max

End Sub

'Sub Quicksort(values(), ByVal min As Long, ByVal max As Long)
'
'  Dim med_value As String, med_value2 As String
'  Dim hi As Long
'  Dim lo As Long
'  Dim i As Long
'
'  ' |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.
'  If min >= max Then Exit Sub
'
'  ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.
'  i = min + Int(Rnd(max - min + 1))
'  med_value = values(i, 1)
'  med_value2 = values(i, 2)
'
'  ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|.
'   values(i, 1) = values(min, 1)
'   values(i, 2) = values(min, 2)
'
'  ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|.
'  lo = min
'  hi = max
'  Do
'    Do While values(hi, 1) >= med_value
'      hi = hi - 1
'      If hi <= lo Then Exit Do
'    Loop
'
'    If hi <= lo Then
'      values(lo, 1) = med_value
'      values(lo, 2) = med_value2
'      Exit Do
'    End If
'
'    values(lo, 1) = values(hi, 1)
'    values(lo, 2) = values(hi, 2)
'
'    lo = lo + 1
'    Do While values(lo, 1) < med_value
'      lo = lo + 1
'      If lo >= hi Then Exit Do
'    Loop
'
'    If lo >= hi Then
'      lo = hi
'      values(hi, 1) = med_value
'      values(hi, 2) = med_value2
'      Exit Do
'    End If
'
'    values(hi, 1) = values(lo, 1)
'    values(hi, 2) = values(lo, 2)
'  Loop
'
'  ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.
'  Quicksort values, min, lo - 1
'  Quicksort values, lo + 1, max
'
'End Sub
'



Attribute VB_Name = "UserForm1"
Attribute VB_Base = "0{87331414-2B36-46F3-99C7-8B8B7BA79B18}{7896EB48-8F3D-467E-84EA-563417CBFF29}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False

Private Sub cmdFontSize_Click()
    s = GetSetting("Svod", "Forms", "FontSiZe", "?")
    If s = "?" Then s = "9"
    s = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| (8 |fffd||fffd| 12)", "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", s)
    If IsNumeric(s) Then i = Val(s) Else Exit Sub
    If i < 8 Or i > 12 Then Exit Sub
    SaveSetting "Svod", "Forms", "FontSiZe", s
    For Each a In Me.Controls
        If (TypeName(a) = "ListBox" Or TypeName(a) = "ComboBox" Or TypeName(a) = "TextBox") Then
            a.Font.Size = i
        End If
    Next
End Sub

Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
On Error Resume Next
Cancel = Application.Run(ActiveWorkbook.name & "!" & "fAnalizRekvizit")
End Sub
Attribute VB_Name = "UserForm3"
Attribute VB_Base = "0{5248793C-E403-4ED6-A489-8E12109706A1}{D592D8F3-522B-4B1C-9A50-EC8F5F69099C}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub cmbSave_Click()
    
    If Len(Trim(UserForm3.TextBox1.Text)) > 254 Then
        MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 254 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", vbCritical, UserForm3.Caption
        UserForm3.TextBox1.SetFocus
        Exit Sub
    Else
        g|fffd|Comment = UserForm3.TextBox1.Text
        Unload UserForm3
        Application.ActiveWorkbook.Saved = False
    End If
    
End Sub

Private Sub cmbCancel_Click()

    Unload UserForm3
    
End Sub

Attribute VB_Name = "UserForm4"
Attribute VB_Base = "0{4BC6FF50-3FCD-4B00-8CE7-6F2B7FE8794C}{CF44450C-B31B-4335-9D2D-A0C4538D9A11}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Attribute VB_Name = "clsWork"
Attribute VB_Base = "0{FCFB3D2A-A0FA-1068-A738-08002B3371B5}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit
'VERSION 1.0 CLASS
'BEGIN
'  MultiUse = -1  'True
'  Persistable = 0  'NotPersistable
'  DataBindingBehavior = 0  'vbNone
'  DataSourceBehavior = 0   'vbNone
'  MTSTransactionMode = 0   'NotAnMTSObject
'End
'Attribute VB_Name = "clsWork"
'Attribute VB_GlobalNameSpace = False
'Attribute VB_Creatable = True
'Attribute VB_PredeclaredId = False
'Attribute VB_Exposed = True
'Attribute VB_Ext_KEY = "SavedWithClassBuilder6" ,"Yes"
'Attribute VB_Ext_KEY = "Top_Level" ,"Yes"
'Option Explicit

Public PasswordName As String
'Attribute PasswordName.VB_VarDescription = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"

Private Const NameBegSpr As String = "Data_"                '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Private Const NameBegCell As String = "ss"                  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Private Const NameRangeListCell As String = "Data_Cells"    '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|


Public Function AutoFillColumn(ByRef objBook As Excel.Workbook, _
                                ByVal sNameRange As String, _
                                ByVal lngCol As Long) As Long
'Attribute AutoFillColumn.VB_Description = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (0 - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, 1 - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)"
                                
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|:
    '0 - |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    '1 - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    
    Dim i As Long
    Dim vRD As Excel.Range
    Dim nRowsD As Long
    Dim nRow As Long
    Dim nCol As Long
    Dim blnFlag As Long
    
    On Error GoTo errHandler
    
    AutoFillColumn = 0
    
    With objBook.Application
        
        Set vRD = .Range(sNameRange)
        With vRD
            nRow = .Row
            nCol = .Column
            nRowsD = .Rows.Count
        End With
        
        If nRowsD > 1 Then
            blnFlag = .ScreenUpdating
            .ScreenUpdating = False
            With vRD.Worksheet
                .Range(.Cells(nRow, lngCol), .Cells(nRow + nRowsD - 1, lngCol)).Select
                objBook.Application.Selection.FillDown
            End With
            .ScreenUpdating = blnFlag
        End If
        
    End With

    
    AutoFillColumn = 1
    
    Set vRD = Nothing
    
    Exit Function
    
errHandler:
'    App.LogEvent "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| " & err.Number & ": " & err.Description, vbLogEventTypeError
    MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| " & err.Number & ": " & err.Description
    
    Set vRD = Nothing
    
    AutoFillColumn = 0
                                
End Function

Public Function MergeCellsOfRange(ByRef objBook As Excel.Workbook, _
                                ByVal sNameRange As String, _
                                ByVal lngColBeg As Long, _
                                ByVal lngcolCount As Long) As Long
'Attribute MergeCellsOfRange.VB_Description = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (0 - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, 1 - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)"
                                
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|:
    '0 - |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    '1 - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    
    Dim i As Long
    Dim vRD As Excel.Range
    Dim nRowsD As Long
    Dim nRow As Long
    Dim nCol As Long
    Dim lngCol As Long
    Dim blnFlag As Long
    
    On Error GoTo errHandler
    
    MergeCellsOfRange = 0
    
    With objBook.Application
        
        Set vRD = .Range(sNameRange)
        With vRD
            nRowsD = .Rows.Count
            nRow = .Row
            nCol = .Column
        End With
        
        blnFlag = .ScreenUpdating
        .ScreenUpdating = False
        
        For i = 0 To nRowsD - 1
            lngCol = nCol + lngColBeg - 1
            With vRD.Worksheet
                .Range(.Cells(nRow + i, lngCol), .Cells(nRow + i, lngCol + lngcolCount - 1)).Select
                With objBook.Application.Selection
                    .HorizontalAlignment = vRD.Cells(i + 1, lngColBeg).HorizontalAlignment
                    .VerticalAlignment = vRD.Cells(i + 1, lngColBeg).VerticalAlignment
                    .WrapText = vRD.Cells(i + 1, lngColBeg).WrapText
                    .MergeCells = True
                End With
            End With
'            Selection.Merge
            
        Next
        
        .ScreenUpdating = blnFlag
    End With

    
    MergeCellsOfRange = 1
    
    Set vRD = Nothing
    
    Exit Function
    
errHandler:
'    App.LogEvent "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| " & err.Number & ": " & err.Description, vbLogEventTypeError
    MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| " & err.Number & ": " & err.Description
    
    Set vRD = Nothing
    
    MergeCellsOfRange = 0
End Function

Public Function AddNewNames(ByRef objBook As Excel.Workbook, _
                            ByVal sNameRangeOfNames As String, _
                            ByVal lngColOfNames As Long, _
                            ByVal sNameRangeForNames As String, _
                            ByVal lngColForNames As Long, _
                            ByVal strDelim As String, _
                            Optional ByVal strNameType As String = "F") As Long
'Attribute AddNewNames.VB_Description = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| (0 - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, 1 - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)"
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|:
    '0 - |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    '1 - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    
                            
    Dim nRowsD As Long
    Dim nRowsS As Long
    Dim blnFlag As Boolean
    Dim i As Long
    Dim vRD As Excel.Range
    Dim vRS As Excel.Range
    Dim vRInfo As Excel.Range
    Dim lVar As Long
    
    Dim strNameCell As String
    
    On Error GoTo errHandler
    
    AddNewNames = 0
    
    With objBook.Application
        blnFlag = .ScreenUpdating
        .ScreenUpdating = False
        
        Set vRInfo = .Range(NameRangeListCell)
        
        Set vRD = .Range(sNameRangeForNames)
        nRowsD = vRD.Rows.Count
        
        Set vRS = .Range(sNameRangeOfNames)
        nRowsS = vRS.Rows.Count
        
        If nRowsS <= nRowsD Then
            For i = 1 To nRowsS
                strNameCell = NameBegCell & vRS.Cells(i, lngColOfNames).Value & strDelim
                .Names.Add name:=strNameCell, _
                        RefersToR1C1:=vRD.Cells(i, lngColForNames)
                lVar = vRInfo.Rows.Count
                vRInfo.Cells(lVar, 1).EntireRow.Insert Shift:=xlShiftDown
                vRInfo.Cells(lVar, 1).Value = strNameCell
                vRInfo.Cells(lVar, 2).Value = strNameType
            Next
        End If
        
        .ScreenUpdating = blnFlag
    End With
    
    AddNewNames = 1
    
    Set vRS = Nothing
    Set vRD = Nothing
    Set vRInfo = Nothing
    
    Exit Function
    
errHandler:
'    App.LogEvent "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| " & err.Number & ": " & err.Description, vbLogEventTypeError
    MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| " & err.Number & ": " & err.Description
    
    Set vRS = Nothing
    Set vRD = Nothing
    Set vRInfo = Nothing
    
    AddNewNames = 0

End Function

Public Function InsertSprToSheet(ByRef objBook As Excel.Workbook, _
                                ByVal sNameRange As String, _
                                ByVal SprName As String, _
                                Optional ByVal strLocation As String) As Long
'Attribute InsertSprToSheet.VB_Description = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (0 - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, 1 - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)"
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|:
    '0 - |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    '1 - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    
    Dim nRowsS As Long
    Dim nColsS As Long
    Dim nRowsD As Long
    Dim nColsD As Long
    Dim strNameCell As String
    Dim i As Long
    Dim j As Long
    Dim lVar As Long
    Dim vRS As Excel.Range
    Dim vRD As Excel.Range
    Dim aryLoc As Variant   '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Dim blnFlag As Boolean
    
    On Error GoTo errHandler
    
    InsertSprToSheet = 0
    
    With objBook.Application
        blnFlag = .ScreenUpdating
        .ScreenUpdating = False
        Set vRS = .Range(NameBegSpr & SprName)
        Set vRD = .Range(sNameRange)
        
        If Not (vRS Is Nothing) And Not (vRD Is Nothing) Then
            nRowsS = vRS.Rows.Count
            nRowsD = vRD.Rows.Count
            nColsS = vRS.Columns.Count
            nColsD = vRD.Columns.Count
            
            If Len(strLocation) > 0 Then
                aryLoc = Split(strLocation, ",", , 1)
            Else
                ReDim aryLoc(0 To nColsS - 1)
                For i = 0 To nColsS - 1
                    aryLoc(i) = i + 1
                Next
            End If
            
            If nColsS = UBound(aryLoc, 1) + 1 And nColsD > UBound(aryLoc, 1) Then
            
                For i = nRowsD To nRowsS - 1
                    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                    vRD.Cells(i, 1).EntireRow.Insert Shift:=xlShiftDown
                Next
                
                For i = 1 To nRowsS
                    For j = 1 To nColsS
                        If aryLoc(j - 1) > 0 Then
'                            Debug.Print "Cell(" & i & "," & j & ")=" & vRS.Cells(i, Val(aryLoc(j - 1)))
                            vRD.Cells(i, Val(aryLoc(j - 1))) = vRS.Cells(i, j)
                        End If
                    Next
                Next
                
            End If
        End If
        
        .ScreenUpdating = blnFlag
    End With
    
    Set vRS = Nothing
    Set vRD = Nothing
    Set aryLoc = Nothing
    
    InsertSprToSheet = 1
    
    Exit Function
    
errHandler:
'    App.LogEvent "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| " & err.Number & ": " & err.Description, vbLogEventTypeError
    MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| " & err.Number & ": " & err.Description
    InsertSprToSheet = 0
    
    Set vRS = Nothing
    Set vRD = Nothing
    Set aryLoc = Nothing
End Function

Public Function VarForm(ByRef objBook As Excel.Workbook, ByVal sNameRange As String) As Long
'
' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| 31.03.2004 (nekrasova)
'' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| 02.06.2004 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (BALANS)
'
    Dim nRows As Long, nCols As Long, strNameCell As String
    Dim lFor1 As Long, lFor2 As Long, lVar As Long
    Dim vR As Range

    With objBook.Application
        .ScreenUpdating = False
        On Error Resume Next
'            MsgBox "!!!DO"
        Set vR = .Range(sNameRange)
'            MsgBox "!!!POSLE"
        If vR Is Nothing Then
     '       MsgBox "!!!"
        Else
            nRows = .Range("Data_EKR").Rows.Count
            nCols = .Range(sNameRange).Columns.Count
         '  |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
            For lFor1 = 1 To nRows
                If lFor1 < nRows - 1 Then
                    .Range(sNameRange).Cells(lFor1 + 1, 1).EntireRow.Insert Shift:=xlShiftDown
                End If
                
                For lFor2 = 1 To nCols
                    If lFor2 <= 2 Then
                         Select Case lFor2
                            Case 1
                            .Range("Data_EKR").Cells(lFor1, lFor2).Copy .Range(sNameRange).Cells(lFor1, 2)
                            Case 2
                            .Range("Data_EKR").Cells(lFor1, lFor2).Copy .Range(sNameRange).Cells(lFor1, 1)
                        End Select
                    End If
                    
                   If lFor2 >= 3 Then
        '          |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| - "ss"+"|fffd||fffd||fffd|"+"|fffd|"
                       strNameCell = "ss" & .Range(sNameRange).Cells(lFor1, 2).Value & Chr(94 + lFor2)
        '                    .range("name_col").Cells(1, lFor2).Value
        '          |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd|."Data_Sheet1"
                       .Names.Add name:=strNameCell, _
                            RefersToR1C1:=.Range(sNameRange).Cells(lFor1, lFor2)
         '         |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd|."Data_Cells"  "|fffd||fffd||fffd||fffd|2"
    '                   lVar = (nCols - 2) * (lFor1 - 1) + (lFor2 - 2)
                       lVar = .Range("Data_Cells").Rows.Count
                       .Range("Data_Cells").Cells(lVar, 1).EntireRow.Insert Shift:=xlShiftDown
                       .Range("Data_Cells").Cells(lVar, 1).Value = strNameCell
                       .Range("Data_Cells").Cells(lVar, 2).Value = "F"
    '                   .range("Data_Cells").Cells(lVar, 3).Value = "2"
                  End If
                  
                Next lFor2
                Rows(.Range(sNameRange).Row + lFor1 - 1).Select
                Selection.WrapText = True
                Selection.EntireRow.AutoFit
            Next lFor1
            Application.ScreenUpdating = True
        End If
       .Range("Name_ORG").Activate
   End With
   VarForm = 1
End Function

Public Function SetDataName(ByVal sVoise As String, _
                        ByVal dDate As Date) As String

    Dim nDay  As Long
    Dim nMonth  As Long
    Dim nYear  As Long
    Dim sMonth As String
'Dim sVoise As String

    If Not dDate = "0:00:00" Then
    
        nDay = Day(dDate)
        nMonth = Month(dDate)
        nYear = Year(dDate)
        
        sMonth = Get_Month(nMonth, sVoise)
        If (sVoise = "|fffd||fffd|" Or sVoise = "") Then
            SetDataName = nDay & " " & sMonth & " " & nYear & "|fffd|."
        Else
            SetDataName = sMonth & " " & nYear & "|fffd|."
        End If
    Else
        SetDataName = " "
    End If
    
End Function


Public Function Get_Month(ByVal nMonth As Long, ByVal sVoise As String) As String

        Get_Month = LCase(MonthName(nMonth))
        Select Case sVoise
            Case "|fffd||fffd|", ""
                If (nMonth = 3 Or nMonth = 8) Then
                    Get_Month = Get_Month & "|fffd|"
                Else
                    Get_Month = left(Get_Month, (Len(Get_Month)) - 1) & "|fffd|"
                End If
            Case "|fffd||fffd|"
               Get_Month = Get_Month
            Case Else
               Get_Month = Get_Month
'               MsgBox "!!"
        End Select
          
End Function

Private Sub Class_Initialize()
    PasswordName = "rassvet"
End Sub

Attribute VB_Name = "clsfrmshow"
Attribute VB_Base = "0{FCFB3D2A-A0FA-1068-A738-08002B3371B5}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Public WithEvents ButtonGroup As MSForms.CommandButton
Attribute ButtonGroup.VB_VarHelpID = -1
Public WithEvents OptionGroup As MSForms.OptionButton
Attribute OptionGroup.VB_VarHelpID = -1
Public WithEvents ComboGroup As MSForms.ComboBox
Attribute ComboGroup.VB_VarHelpID = -1


Private Sub ButtonGroup_Click()
On Error Resume Next
Dim fl As Boolean


If ButtonGroup.name = "cmdOk" Then
    If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then rekv
    If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then AddRow
    If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then AddColumn
    If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then AddColumn
    If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then form014RShow
    If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd| OKTMO" Then form014RShow
End If

If ButtonGroup.name = "cmdCancel" And UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then fSelectColumn
If ButtonGroup.name = "cmdCancel" And UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then ShowRekv
If ButtonGroup.name = "cmdCancel" And UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then ShowRekv
If ButtonGroup.name = "cmdCancel" Then
    fl = Application.Run(ActiveWorkbook.name & "!" & "fAnalizRekvizit")
    If fl Then Exit Sub Else Unload UserForm1
End If
End Sub

Private Sub ComboGroup_Click()
Dim s As String
Dim DsName As String
Dim i  As Long
On Error Resume Next

If UCase(ComboGroup.name) = "CMBDATASHEET" Then
  If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then
    If flAdd = True Then Exit Sub
    DsName = UserForm1.Controls("CmbDataSheet").Value
    s = sGetINI("Data_Sheet" & DsName & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
    
     For Each cntrl In UserForm1.Controls
       If UCase(cntrl.name) <> "CMBDATASHEET" Then
         If UCase(cntrl.name) <> "LBLDATASHEET" Then
           UserForm1.Controls.Remove cntrl.name
         End If
       End If
     Next
     i = VarAddForm("Data_Sheet" & DsName)
     Select Case i
       Case 1
           AddForma1 s
       Case 2, 3
           AddForma23 s
       Case 4
          AddForma4 s
     End Select
  End If
End If

End Sub


Private Sub ComboGroup_DropButtonClick()
'MsgBox "ComboGroup_DropButtonClick"
End Sub


Private Sub ComboGroup_KeyUp(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
'MsgBox "ComboGroup_KeyUp"
End Sub


Private Sub ComboGroup_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single)
'MsgBox "ComboGroup_MouseUp"
End Sub


Private Sub OptionGroup_Click()
Dim n As Long, i As Long, sname$, sDataName$
Dim sRekvizit$, s$, sTipeSp$
Dim DsName As String

On Error Resume Next

With UserForm1.Controls("ListBox1")
 If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then
    .RowSource = OptionGroup.name
'    fListIndex  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| Kod |fffd| Naim |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 End If
  If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Or UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then
     If EmptyName(OptionGroup.name & "1") > 0 Then .RowSource = OptionGroup.name & "1" Else .RowSource = OptionGroup.name
'    fListIndex  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| Kod |fffd| Naim |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 End If
DsName = ""
If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then
   If flgUseDataSheetInCodName = True Then
     DsName = "Data_Sheet" & UserForm1.Controls("CmbDataSheet").Value
   End If
      If VarAddForm(DsName) <> 4 Then
      sname = OptionGroup.name
      
      If EmptyName(sname & "1") > 0 Then .RowSource = sname & "1" Else .RowSource = sname
'      If OptionGroup.Name = "Data_FKR" Then .RowSource = "Data_FKR1" Else .RowSource = OptionGroup.Name
'     .RowSource = OptionGroup.Name
        finsertColumn UserForm1.Controls("ListBox1")

        If OptionGroup.name = "Data_FKR" Then
            finsertColumn UserForm1.Controls("SGU")

            UserForm1.Controls("SGU").Visible = True
            UserForm1.Controls("lblSGU").Visible = True
        Else
            UserForm1.Controls("SGU").Visible = False
            UserForm1.Controls("lblSGU").Visible = False
        End If
    Else
        
        n = Val(OptionGroup.name)
        If DsName <> "" Then
          sRekvizit = DsName & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
        Else
          sRekvizit = ActiveSheet.name & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
        End If
        sTipeSp = sGetINI(sRekvizit, "?")
        s = StrEl(sTipeSp, n, ";")
        
        For Each a In UserForm1.Controls
        If (TypeName(a) = "ListBox" Or TypeName(a) = "ComboBox") Then
            i = Val(Right$(a.name, 1))
            If Len(StrEl(s, i)) > 0 Then
                a.Visible = True
                sDataName = StrEl(s, i)
                If EmptyName(sDataName & "1") > 0 Then a.RowSource = sDataName & "1" Else a.RowSource = sDataName
                'If StrEl(s, i) = "Data_FKR" Then a.RowSource = "Data_FKR1" Else a.RowSource = StrEl(s, i)
'                a.RowSource = StrEl(s, i)
                finsertColumn a
            Else
                a.Visible = False
            End If
        End If
        Next
    End If
End If
If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then
    finsertColumn UserForm1.Controls("ListBox1")
    fListIndex  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| Kod |fffd| Naim |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
End If
End With
End Sub


Public Function finsertColumn(ByVal a As Control)
Dim r As Range, s$, i As Long, fl As Boolean

On Error GoTo err
Set r = Range(a.RowSource)
For i = 1 To r.Rows.Count
    If Not IsEmpty(r.Cells(i, 3)) Then fl = True: Exit For
    If i > 10 Then Exit For
Next i

If fl = True Then
   ' R.Sort Key1:=R.Cells(1, 3), Order1:=xlAscending
    a.ColumnCount = 3
    s = ";390;230"
Else
    a.ColumnCount = 2
    s = ";400"
End If
a.ColumnWidths = str(Len(r.Cells(1, 1)) * 5 + 27) & s
err:
Set r = Nothing
End Function
Attribute VB_Name = "mdLib1"
Option Explicit
Public flIsSvod As Boolean

Public Sub ProtectXlt1(Optional Rezim As Long = 0)
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'Rezim% = 0 - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|; 1 - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|; 2 - |fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim a As Worksheet
Application.ScreenUpdating = False
With ActiveWorkbook
If .ProtectStructure = False Then .Protect "rassvet"
For Each a In .Worksheets
    Select Case Rezim
        Case 0: fUnProtect False, a.Index
        Case 1: If a.Visible = True Then fUnProtect False, a.Index
        Case 2: If a.name <> .ActiveSheet.name Then fUnProtect False, a.Index
    End Select
Next
End With
End Sub
Public Sub UnProtectXlt1(Optional Rezim As Long = 0)
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim a As Worksheet
Application.ScreenUpdating = False
With ActiveWorkbook
If .ProtectStructure = True Then .Unprotect "rassvet"
For Each a In .Worksheets
    Select Case Rezim
        Case 0: fUnProtect True, a.Index
        Case 1: If a.Visible = True Then fUnProtect True, a.Index
        Case 2: If a.name <> .ActiveSheet.name Then fUnProtect True, a.Index
    End Select
Next
End With
End Sub
Attribute VB_Name = "modCommBars"
Public SPS() As Boolean
Global flgUseDataSheetInCodName As Boolean
Global gLenDopKodForCodName As Long
Public gcNameAddRd As String    '13.01.2011 |fffd||fffd||fffd| |fffd|.074 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (Data_RCH)

Public FlagPictures As Boolean      '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Public StrNameCellsPictures As String       '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public objSvod2 As Variant   '' 24.09.2014 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Office64
Public gcCodeName As String '' |fffd||fffd||fffd| |fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" 06.04.2015
Public bFlagTransDataToSheet As Boolean '11.03.2014 Ivanov |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|



Public Sub fOpen()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Dim CB As CommandBar
Dim MB As CommandBar
Dim nb As CommandBarButton
Dim MBut As CommandBarPopup
Dim HelpMenu As CommandBarPopup
Dim idForm$
'-----------------------------------------------------------31.10.2008
Dim Cbox As CommandBarComboBox
Dim flF074 As String
Dim DSArray As Variant
Dim s As String, Result As Long
Dim calc As String
'-----------------------------------------------------------31.10.2008
On Error Resume Next

'-----------------------------------------------------------06.04.2015
gcCodeName = Application.ActiveWorkbook.CodeName
'-----------------------------------------------------------06.04.2015

'-----------------------------------------------------------31.10.2008
flgUseDataSheetInCodName = False
s = sGetINI("UseDataSheetInCodName", "?") '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| data_sheet |fffd| |fffd||fffd||fffd||fffd||fffd|
s = UCase(s)
If s = "ON" Then flgUseDataSheetInCodName = True
'-----------------------------------------------------------31.10.2008
'------------------Spiridonova----------------------18.09.2009
gLenDopKodForCodName = 2
s = sGetINI("LenDopKodForCodName", "?") '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| data_sheet |fffd| |fffd||fffd||fffd||fffd||fffd|
s = UCase(s)
If s <> "?" Then gLenDopKodForCodName = Val(s)
'------------------Spiridonova----------------------18.09.2009

AddIns("lnc2").Installed = False
Application.CommandBars("Worksheet Menu Bar").Reset
Application.CommandBars("Column").Reset
Application.CommandBars("Row").Reset
Application.ScreenUpdating = False
For Each CB In Application.CommandBars
    If CB.name Like "|fffd||fffd||fffd||fffd|*" Then CB.Delete
Next

Set HelpMenu = Application.CommandBars("Worksheet Menu Bar").FindControl(id:=30010)
Set CB = Application.CommandBars.Add("|fffd||fffd||fffd||fffd|", msoBarTop, False, True)
Set MB = Application.CommandBars("Worksheet Menu Bar") '.Controls.Add(msoControlPopup)
MB.Reset

If HelpMenu Is Nothing Then
    Set MBut = MB.Controls.Add(Type:=msoControlPopup, Temporary:=True)
Else
    Set MBut = MB.Controls.Add(Type:=msoControlPopup, Before:=10, Temporary:=True)
End If
MBut.Caption = "|fffd||fffd||fffd||fffd|"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| xls", 271, "cmbSaveAs_Click"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 35, "frmRekvizitShow"
'-----------------------------------------------------------31.10.2008
'-------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| Data_Sheet-|fffd||fffd||fffd|
Set Cbox = CB.Controls.Add(msoControlComboBox)
Cbox.Caption = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
Cbox.Tag = "CmbDataSheet"
If Not DataSheetFill(Cbox) Then
  If Cbox.ListCount > 0 Then
    Cbox.ListIndex = 1
  Else
    Cbox.ListIndex = 0
  End If
End If
'-------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| Data_Sheet-|fffd||fffd||fffd|

'If flgUseDataSheetInCodName = False Then
'  Cbox.Visible = False
'End If

'If Cbox.ListCount > 2 Then
'  Cbox.Visible = True
'Else
'  Cbox.Visible = False
'End If

idForm = sGetINI("idForm", "?")
idForm = UCase(idForm)

'-----------------------------------------------------------31.10.2008
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 296, "frmInsertRowShow"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 314, "fRowHidden"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd|", 296, "fInsert1Row", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "|fffd||fffd||fffd||fffd||fffd||fffd|"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 294, "InsertColumn", , False, "14"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 47, "RenameColumn", , False, "14"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 293, "DeleteColumn", , False, "14"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 4, "PrintF074", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14"
If sGetINI("GLRP", "?") <> "?" Then
    AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 6, "fGroupAdd", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14"
    AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 44, "fDeleteGroup", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14"
End If
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 44, "ShowSelectOrgForm", , False, "14r"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 4, "PrintF074", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14r"
'AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 6, "fGroupAdd", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14r"  '17.01.2011
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd|", 293, "DeleteRows", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", True, 125
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd|", 293, "DeleteRows", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", True, "125"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd|", 293, "DeleteRows", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", True, "125_1"
'idForm = sGetINI("idForm", "?")
'If idForm = "125" And sGetINI("Calculate", "?") <> "?" Then AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 6, "f125ItogoCB", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "125"
'-----------------------------------------------------------31.10.2008
'-----------------------------------------------------------17.01.2011
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 296, "InsertColumn_179", , False, "14_179"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 47, "RenameColumn_179", , False, "14_179"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 293, "DeleteColumn_179", , False, "14_179"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 4, "PrintF074", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14_179"
If sGetINI("GLRP", "?") <> "?" Then
    AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 6, "fGroupAdd_179", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14_179"
    AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 44, "fDeleteGroup", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14"
End If
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 44, "ShowSelectOrgForm", , False, "14r_179"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 4, "PrintF074", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14r_179"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 6, "fGroupAdd_179", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14r_179"
'AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd|", 293, "DeleteRows", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", True, 125
'-----------------------------------------------------------17.01.2011

'-----------------------------------------------------------15.01.2018
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 296, "InsertColumn_2018", , False, "14_2018"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 47, "RenameColumn_2018", , False, "14_2018"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 293, "DeleteColumn_2018", , False, "14_2018"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 4, "PrintF074_2018", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14_2018"
If sGetINI("GLRP", "?") <> "?" Then
    AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 6, "fGroupAdd_2018", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14_179"
    AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 44, "fDeleteGroup", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14"
End If
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 44, "ShowSelectOrgForm", , False, "14r_2018"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 4, "PrintF074_2018", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14r_2018"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 6, "fGroupAdd_2018", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14r_2018"
If idForm = "14_2018" Then
    gcNameAddRd = sGetINI("NameAddPd", "?")
    gcNameAddRd = UCase(gcNameAddRd)
    If cNameAddRd = "?" Then
        MsgBox "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| lnc2.ini!"
    End If
End If
'-----------------------------------------------------------15.01.2018

'-----------------------------------------------------------20.06.2016
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 296, "InsertColumn_86", , False, "14_86"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 47, "RenameColumn_86", , False, "14_86"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", 293, "DeleteColumn_86", , False, "14_86"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 4, "PrintF074_86", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14_86"
If sGetINI("GLRP", "?") <> "?" Then
    AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 6, "fGroupAdd_86", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14_179"
    AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 44, "fDeleteGroup", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14"
End If
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 44, "ShowSelectOrgForm", , False, "14r_86"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 4, "PrintF074_86", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14r_86"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 6, "fGroupAdd_86", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14r_86"
If idForm = "14_86" Then
    gcNameAddRd = sGetINI("NameAddPd", "?")
    gcNameAddRd = UCase(gcNameAddRd)
    If cNameAddRd = "?" Then
        MsgBox "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| lnc2.ini!"
    End If
End If
'-----------------------------------------------------------20.06.2016

'-----------------------------------------------------------13.01.2011 17.01.2011
If idForm = "14_179" Then
    gcNameAddRd = sGetINI("NameAddPd", "?")
    gcNameAddRd = UCase(gcNameAddRd)
    If cNameAddRd = "?" Then
        MsgBox "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| lnc2.ini!"
    End If
End If
'-----------------------------------------------------------13.01.2011 17.01.2011
'-----------------------------------------------------------17.02.2015
If idForm = "14R_OKTMO" Then
    gcNameAddRd = sGetINI("NameAddPd", "?")
    gcNameAddRd = UCase(gcNameAddRd)
    If cNameAddRd = "?" Then
        MsgBox "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| lnc2.ini!"
    End If
End If 'If idForm = "14R_OKTMO" Then
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 44, "ShowSelectOrgForm", , False, "14R_OKTMO"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 4, "PrintF074", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14R_OKTMO"
'AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 6, "fGroupAdd_179", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14R_OKTMO"
'End If
'-----------------------------------------------------------17.02.2015
'-----------------------------------------------------------31.01.2018
If idForm14r = "14R_OKTMO_2018" Then
    gcNameAddRd = sGetINI("NameAddPd", "?")
    gcNameAddRd = UCase(gcNameAddRd)
    If cNameAddRd = "?" Then
        MsgBox "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| lnc2.ini!"
    End If
End If
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 44, "ShowSelectOrgForm", , False, "14R_OKTMO_2018"
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 4, "PrintF074_2018", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "14R_OKTMO_2018"
'-----------------------------------------------------------31.01.2018

calc = sGetINI("Calculate", "?")
If calc <> "?" Then
  If idForm = "125" Then
    AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 6, "f125ItogoCB", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "125"
    'Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Enabled = False
  ElseIf idForm = "169" Then
    AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 6, "f169ItogoCB", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "169"
  ElseIf InStr(1, idForm, "PZ_PL") > 0 Then
    AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 6, "fCreateGroup_Plan", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", False, "PZ_PL"
  End If
    
End If

'------------------Spiridonova----------------------29.12.2010
'If calc <> "?" Then
    If idForm = "169N" Or idForm = "169N2013" Or idForm = "169N2015" Or idForm = "169N2016" Then
        If GetINI("DSItog1!DataSource") <> "" Then     ''Spiridonova 17.01.2013 |fffd||fffd||fffd| 169_18
        Else
            AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 6, "F169ItogoN", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" ', False, "169"
        End If
    End If
'End If
'------------------Spiridonova----------------------29.12.2010

'------------------Spiridonova----------------------15.03.2012
    If idForm = "725" Then
        AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 6, "f725ItogoCB", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" ', False, "125"
    End If
'------------------Spiridonova----------------------15.03.2012
'------------------Spiridonova----------------------12.12.2014
    If idForm = "125_1" Then
        AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 6, "f125_1ItogoCB", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" ', False, "125"
    End If
'------------------Spiridonova----------------------12.12.2014


'If idForm = "125" And sGetINI("Calculate", "?") <> "?" Then
'  AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", 6, "f125ItogoCB", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False, "125"
'  'Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Enabled = False
'End If

'-----------------------------------------------------------31.10.2008
'If idForm <> "125" And idForm <> "14" And idForm <> "14R" Then AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd|", 293, "fDeleteRow", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
If idForm <> "125" And idForm <> "14" And idForm <> "14_179" And idForm <> "14R" And idForm <> "14R_179" And idForm <> "125_1" And idForm <> "14_86" And idForm <> "14_2018" Then AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd|", 293, "fDeleteRow", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"   '17.01.2011
If IsAdmin Then AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd|", 293, "MyProtect"
                    
'------------------Spiridonova----------------------19.03.2009
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...", 2761, "fStartWindow"   '272
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...", 2761, "fStartWindowOld"   '272

'------------------Spiridonova----------------------17.07.2014
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...", 2761, "cmbPrintDetal"   '272

'------------------Spiridonova----------------------01.10.2010
If sGetINI("ConversionToSvod", "?") = "On" Then AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1|fffd|", 35, "LoadData_1C"
'If sGetINI("ConversionToSvod", "?") = "On" Then AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1|fffd|", 35, ActiveWorkbook.name & "!prConvertData"

'------------------Spiridonova----------------------08.12.2010
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 44, "fEditComment", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
ReDim SPS(ActiveWorkbook.Worksheets.Count)

'----------------Ivanov-----------------------------08/06/2011, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If sGetINI("OnPic", "") = "" Then
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        FlagPictures = False
    Else
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        FlagPictures = True
        AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| ...", 6, "fAddPicture", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False
        AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 44, "fDeletePicture", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", False
        Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| ...").Enabled = False
        Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = False
'        Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls(10).Enabled = False
'        Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls(11).Enabled = False
        StrNameCellsPictures = sGetINI("PicCells", "")
        
        ' Spiridonova 10.07.2012
        Result = CreateArrPic()
    End If
    

'----------------Ivanov---------------------------12/02/2014, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    If sGetINI("UseFastMenu", "") <> "" Then
        AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|...", 6, "newSubMenu", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|", False
    End If

'----------------Ivanov --------------------------07/03/2014, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    If sGetINI("ButtonPrint", "") <> "" Then
        AddCmdMenu "", 4, "PrintActiveWindow", "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", False
    End If
    
    If sGetINI("ButtonPrintAll", "") <> "" Then
        AddCmdMenu "", 160, "PrintActiveWindowAll", "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", False
    End If

'----------------Ivanov---------------------------10/04/2014, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    If sGetINI("UseUpdateData", "") <> "" Then
        AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 582, "UpdateData", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", False
    End If

'---------------Ivanov-----------------------------11.03.2015, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| bFlagTransDataToSheet |fffd||fffd| ini-|fffd||fffd||fffd||fffd||fffd|
    Dim strFlagTemp As String
    strFlagTemp = sGetINI("FlagTransDataToSheet", "")
    If strFlagTemp <> "1" Then strFlagTemp = "0"
    bFlagTransDataToSheet = CBool(strFlagTemp)

'-----------------------------------------------------------------


'----------------Spiridonova---------------------------03/09/2014, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd|
    If sGetINI("ButtonLoad", "") <> "" Then
        AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 582, "LoadData", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd|", False
    End If

'----------------Lavr-----------------------------06.09.2012 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|.'----------------Lavr-----------------------------06.09.2012 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|.
If GetINI("DSItog1!DataSource") <> "" Then AddComandItog
'----------------Lavr-----------------------------06.09.2012 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|.
'---------------------------------------------01.12.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (F175)
If GetINI("DSItog11!DataSource") <> "" Then AddComandItogMulti
'---------------------------------------------01.12.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|.


'----------------Spiridonova---------------------------24/09/2014, |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Office64
Set objSvod2 = New clsWork
'----------------Spiridonova---------------------------

ActiveWindow.WindowState = xlMaximized

CB.Visible = True

Set nb = Nothing
Set HelpMenu = Nothing
Set MBut = Nothing
Set CB = Nothing
Set MB = Nothing
End Sub
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub AddCmdMenu(Caption$, FaceId As Long, OnAction$, Optional TooltipText$ = "", Optional flMenu As Boolean = True, Optional idForm$ = "")
Dim CB As CommandBar
Dim MB As CommandBar
Dim nb As CommandBarButton
Dim Form$
On Error Resume Next
If Len(idForm) > 0 And UCase(idForm) <> UCase(sGetINI("idForm", "?")) Then Exit Sub
Set CB = Application.CommandBars("|fffd||fffd||fffd||fffd|")
Set nb = CB.Controls.Add(msoControlButton)
'NB.Tag |fffd||fffd||fffd| idForm
nb.Caption = Caption
nb.FaceId = FaceId
nb.Style = msoButtonIconAndCaption
nb.TooltipText = IIf(Len(TooltipText) = 0, Caption, TooltipText)
nb.OnAction = OnAction

If flMenu Then
    Set MB = Application.CommandBars("Worksheet Menu Bar")
    Set nb = MB.Controls("|fffd||fffd||fffd||fffd|").Controls.Add(msoControlButton)
    nb.Caption = Caption
    nb.OnAction = OnAction
    nb.FaceId = FaceId
End If
Set nb = Nothing
Set CB = Nothing
Set MB = Nothing
End Sub

Public Sub cmdBarsShow()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
Dim CB As CommandBar
Dim MB As CommandBar
Dim sRekvizit$
Dim fl As Boolean, s$, i As Long
Dim HelpMenu As CommandBarControl
Dim flF074 As String
'-----------------------------------------------------------31.10.2008
Dim nm As String
Dim StrIni As String
Dim s1 As String
Dim flCmb As Boolean
Dim idForm As String
Dim DsName As String
'-----------------------------------------------------------31.10.2008

On Error Resume Next

idForm = UCase(sGetINI("idForm", "?"))
Set CB = Application.CommandBars("|fffd||fffd||fffd||fffd|")
Set MB = Application.CommandBars("Worksheet Menu Bar")
Static a(10) As Boolean

'sRekvizit = ActiveSheet.Name & "!|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
'-----------------------------------------------------------31.10.2008
StrIni = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
sRekvizit = ActiveSheet.name & "!" & StrIni
'-----------------------------------------------------------31.10.2008

s = sGetINI(sRekvizit, "?")
If s <> "?" Then fl = True Else fl = False
CB.Controls(StrIni).Visible = fl
MB.Controls("|fffd||fffd||fffd||fffd|").Controls(StrIni).Visible = fl
'-----------------------------------------------------------31.10.2008
'-----------------------------------------------------------17.01.2013

If GetINI("DSItog1!DataSource") <> "" Then
    StrIni = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
    CB.Controls(StrIni).Visible = fl
    MB.Controls("|fffd||fffd||fffd||fffd|").Controls(StrIni).Visible = fl
End If
'-----------------------------------------------------------17.01.2013
nm = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
flCmb = DataSheetFill(CB.Controls(nm))
CB.Controls(nm).Visible = False '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| 28.11.2008
'If CB.Controls(nm).ListCount <= 2 Then flCmb = False '|fffd||fffd||fffd||fffd| Data_Sheet |fffd||fffd||fffd||fffd|,|fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'If flgUseDataSheetInCodName = True Then
'
'  If flCmb = True Then
'    CB.Controls(nm).Visible = flCmb
'  Else
'    CB.Controls(nm).Visible = False
'  End If
'End If
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| 28.11.2008

StrIni = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
If flgUseDataSheetInCodName = True Then
  DsName = Trim(CB.Controls(nm).Text)
'  DsName = UCase(Trim(CB.Controls(nm).Text))
  sRekvizit = DsName & "!" & StrIni
  s = Trim(sGetINI(sRekvizit, "?"))
Else
  DsName = ActiveSheet.name
  sRekvizit = DsName & "!" & StrIni
  s = Trim(sGetINI(sRekvizit, "?"))
  If s = "?" Then
    DsName = "Data_Sheet" & ActiveSheet.Index
    sRekvizit = DsName & "!" & StrIni
    s = Trim(sGetINI(sRekvizit, "?"))
  End If
End If

If s <> "?" Then
  s1 = sGetINI(DsName & "!Kod", "?")
End If

If s <> "?" And Not s1 Like "*$*" Then
  fl = True
Else
  fl = False
End If

'If sGetINI(sRekvizit, "?") <> "?" And Not sGetINI(ActiveSheet.Name & "!Kod", "?") Like "*$*" Then fl = True Else fl = False
If idForm = "125" Or idForm = "725" Or idForm = "125_1" Then fl = True
'-----------------------------------------------------------Spir 12.03.2015
If idForm = "164" Then fl = True
'-----------------------------------------------------------Spir 12.03.2015

CB.Controls(StrIni).Visible = fl
MB.Controls("|fffd||fffd||fffd||fffd|").Controls(StrIni).Visible = fl

If idForm = "125" Or idForm = "725" Or idForm = "125_1" Then
  CB.Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = False
  MB.Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = False
End If
'-----------------------------------------------------------31.10.2008


'If idForm = "14" Then
If idForm = "14" Or idForm = "14_179" Or idForm = "14_86" Or idForm = "14_2018" Then  '17.01.2011 '20.06.2016   '15.01.2018
    flF074 = sGetINI("GLRP", "?")
'    If HasName("Data_Options") = True Then flF074 = Trim$(Range("Data_Options").Cells(1, 2).Value)
'    If HasName("Data_Spr1") = True Then flF074 = Trim$(Range("Data_Spr1").Cells(1, 1).Value)
    If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
        CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
        CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
        CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
        If flF074 <> "?" Then
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
'            MB.Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
        End If
        MB.Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
        MB.Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
    Else
        CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
        CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
        CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
        If flF074 <> "?" Then
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
'            MB.Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
        End If
        MB.Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
        MB.Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
        
    End If
End If
If idForm = "14R" Or idForm = "14R_179" Or idForm = "14R_86" Then
        If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
        Else
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
        End If
End If
'---------------------------------------------01.12.2015
If idForm = "14_179" Or idForm = "14R_179" Or idForm = "14R_OKTMO" Or idForm = "14R_OKTMO_2018" Then
        If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_5" Or ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_6" Then
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Visible = False
        Else
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Visible = True
        End If
End If
'---------------------------------------------01.12.2015
'---------------------------------------------20.06.2016
If idForm = "14_86" Then
        If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_6" Or ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_7" Then
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Visible = False
        Else
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Visible = True
        End If
End If
'---------------------------------------------20.06.2016
'---------------------------------------------15.01.2018
If idForm = "14_2018" Then
        If ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-7" Or ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-8" Or ActiveSheet.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-9" Then
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Visible = False
        Else
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Visible = True
        End If
End If
'---------------------------------------------15.01.2018

Set CB = Nothing
Set MB = Nothing
'InsertRowsScopom

'' 10/03/2015 |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|..."
i = fGetObject(goSvod)
'' 10/03/2015 |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|..."

fcmdRowHidden
fShowCmdInsDelRow
fShowColumnMenu
End Sub

Function DataSheetFill(CmbControl As Object, Optional FirstItem As String = "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|") As Boolean
If Not IsObject(CmbControl) Then
  DataSheetFill = False
  Exit Function
End If

Dim i As Long
Dim j As Long
Dim k As Long
Dim l As Long
Dim sname As String
Dim RangeArr As Variant
Dim ResultArr As Variant
Dim SnameArr() As String
Dim Result As Boolean
Dim s As String, s1 As String

ReDim RangeArr(1 To 1)
ReDim ResultArr(1 To 1)

On Error GoTo cansel
Result = False
k = 0
l = 0
  For i = 1 To Names.Count
    If UCase(Names(i).name) Like "DATA_SHEET*" Then
        s1 = sGetINI(Names(i).name & "!Kod", "?")
        If s1 <> "?" And Not s1 Like "*$*" Then
           l = l + 1
           sname = Names(i).RefersTo
           j = InStr(1, sname, "!")
           If j > 0 Then
             sname = Mid(sname, 1, j - 1)
             sname = Replace(sname, "=", "")
             sname = Trim(sname)
             If ActiveWorkbook.Sheets(sname).Visible = True Then
               If UCase(ActiveWorkbook.ActiveSheet.name) = UCase(sname) Then
                 k = k + 1
                 ReDim Preserve RangeArr(1 To 2)
                 ReDim Preserve ResultArr(1 To k)
                 RangeArr(1) = Names(i).name  '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                 RangeArr(2) = sname '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|,|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| range(name)
                 ResultArr(k) = RangeArr
                 
               End If
               
             End If
           End If
        End If
    End If
  Next i

CmbControl.Clear
If IsArray(ResultArr) And IsArray(ResultArr(1)) Then
  
  ReDim SnameArr(1 To UBound(ResultArr))
  ReDim sValue(1 To UBound(ResultArr))
  CmbControl.AddItem (FirstItem)
  For i = LBound(ResultArr) To UBound(ResultArr)
    SnameArr(i) = ResultArr(i)(1)
    CmbControl.AddItem (SnameArr(i))
  Next i
  If CmbControl.ListCount > 1 Then
    CmbControl.ListIndex = 2
  Else
    CmbControl.ListIndex = 1
  End If
  Result = True
Else
  Result = False
End If


finally:
DataSheetFill = Result
Exit Function

cansel:
'MsgBox Error(err)
'Resume
Result = False
GoTo finally

End Function


Function GetDataSheetsFromSheet(ShName As String) As Variant
Dim i As Long
Dim j As Long
Dim k As Long
Dim sname As String
Dim ResultArr As Variant
Dim Result As Boolean

ReDim ResultArr(1 To 1)

On Error GoTo cansel
Result = False
k = 0

  For i = 1 To Names.Count
    If UCase(Names(i).name) Like "DATA_SHEET*" Then
       sname = Names(i).RefersTo
       j = InStr(1, sname, "!")
       If j > 0 Then
         sname = Mid(sname, 1, j - 1)
         sname = Replace(sname, "=", "")

           If UCase(ShName) = UCase(sname) Then
             k = k + 1
             ReDim Preserve ResultArr(1 To k)
             ResultArr(k) = Names(i).name
           End If
           
       End If
    End If
  Next i
  
If IsArray(ResultArr) Then
  If LBound(ResultArr) = UBound(ResultArr) Then
    If IsEmpty(ResultArr(LBound(ResultArr))) Then
      ResultArr = Empty
    End If
  End If
End If


finally:
GetDataSheetsFromSheet = ResultArr
Exit Function


cansel:
'MsgBox Error(err)
' Resume
ResultArr = Empty
GoTo finally


End Function

Private Sub cmbPrintDetal()

    Dim NameFile As Variant, WSheet As Worksheet
    Dim nInkod As Long
    Dim XLT_Sheet As Excel.Application, WBook As String
    Dim sDelName As String
    Dim a As name, s$
    Dim IsSaved As Boolean, llFound As Boolean
    Dim i As Long, r As Long, t As Long
    Dim lnStr As Long, lnCh As Long
    Dim SelRange As Range

    On Error GoTo A1
    
'    sDelName = UCase(sGetINI("IsDeleteNames", "?"))

'    CountDetal = CountDetal + 1
'    NameFile = Application.GetSaveAsFilename("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" & str(CountDetal), _
'            "|fffd||fffd||fffd||fffd||fffd| Microsoft Ecxel (*.xls), *.xls", , _
'            "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")

t2 = Time
'Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd| 1 - "; t2

     WBook = ThisWorkbook.Path & "\spr_org.XLT"
    Set XLTSheet = CreateObject("Excel.Application")
    XLTSheet.ScreenUpdating = False
    XLTSheet.Workbooks.Open WBook
    ''''''''''''''''''''''''''
        Set WSheet = XLTSheet.Sheets("|fffd||fffd||fffd||fffd|1")
        WSheet.Select
        WSheet.Activate
        WSheet.Rows("1:7").Delete Shift:=xlUp
        'ActiveWindow.WindowState = xlMaximized
        
'        ResizeRange ActiveWorkbook.Application.Range("DataSpravka"), UBound(a, 1) + 2, UBound(a, 2)
                
'    XLTSheet.ScreenUpdating = True
'    XLTSheet.Visible = True
        
        On Error Resume Next
        n1 = UBound(gArr, 2)
        n2 = UBound(gArr, 1)
'        ReDim gArr(n2, n1)
        nRowB = 6
        nRowE = n2
        nColB = 1
        nColE = n1
        
        With XLTSheet.Application.Cells
            If n1 > 4 Then
               .Columns(2).NumberFormat = "@" ''<Spir>01110271 ~5375
               
                For i = 3 To n1 - 2
                    .Columns(i).NumberFormat = "General"
                Next i
            End If
            
            .Font.Size = 8
            .Columns(nColE).ColumnWidth = 170   '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            For i = LBound(gArr, 1) + 1 To UBound(gArr, 1) - 1
                .Cells(i + 2 + 5, 1) = gArr(i, 1)
'                gArr(i, 1) = a(i, 1)
                For j = LBound(gArr, 2) + 3 To UBound(gArr, 2)
                     .Cells(i + 2 + 5, j - 2) = gArr(i, j)
'                     gArr(i, j) = a(i, j)
                 Next j
                 .Cells(i + 2 + 5, n1 - 1) = gArr(i, 3)
                 .Cells(i + 2 + 5, n1) = gArr(i, 2)
'                 gArr(i, 3) = a(i, 3)
'                 gArr(i, 2) = a(i, 2)
             Next i
            
            ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            cCaption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
            cCaption = goSvod.cRepAlias & " - " & cCaption
            WSheet.Range("A1") = cCaption
        
            WSheet.Range("A4") = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
            WSheet.Range("A3") = "|fffd||fffd||fffd||fffd||fffd||fffd|"
            WSheet.Range("B4") = Time & "  " & Date
            WSheet.Range("B3") = Trim(gcNamePer)    '' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| 3|fffd||fffd| 2015)
            
            WSheet.Range("A1:A4").Font.Size = 9
             
            ' |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            .Cells(nRowB + 1, 1).Value = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
            
            .Cells(nRowB, 1).Value = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
            .Cells(nRowB, n1 - 1).Value = "|fffd||fffd||fffd||fffd||fffd||fffd|"
            .Cells(i, n1).Value = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
        
            .Cells(nRowB + 2, 1).Value = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
            
            lFulfillment = True
            .Cells(nRowB, 2).Value = "|fffd||fffd||fffd| |fffd||fffd|"   ''<Spir>01110271 ~5375
            For j = LBound(gArr, 2) + 4 To UBound(gArr, 2)  ''<Spir>01110271 ~5375 |fffd||fffd||fffd||fffd| LBound(gArr, 2) + 3
            
                '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                .Cells(nRowB, j - 2).Value = gArr(1, j)
                .Cells(nRowB + 1, j - 2).Value = gArr(n2, j)
'                .Cells(nRowB, j - 2).Value = Replace(WSheet.Range(gArr(1, j)).AddressLocal, "$", "")
'                .Cells(nRowB + 1, j - 2).Value = WSheet.Range(gArr(1, j)).Value
                
                ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                If IsNumeric(.Cells(nRowB + 1, j - 2).Value) Then
                  ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|,
                  .Cells(8, j - 2).FormulaLocal = "=|fffd||fffd||fffd||fffd|((" & Replace(.Cells(9, j - 2).Address, "$", "") & ":" & Replace(.Cells(n2 + 8, j - 2).Address, "$", "") & "))"
                    If Val(.Cells(8, j - 2).Value) <> Val(.Cells(7, j - 2).Value) Then
                        .Rows(7 & ":" & 8).Select
                         With Selection.Font
                            .Color = -16776961
                        End With
                        lFulfillment = False
                    End If
                   .Columns(j - 2).Select
                   .Columns(j - 2).NumberFormat = "#,##0.00"
                   .Columns(j - 2).ColumnWidth = 15
                   .HorizontalAlignment = xlRight
                Else
                    .Columns(j - 2).Select
                    .Columns(j - 2).NumberFormat = "@"
                    .Columns(j - 2).ColumnWidth = 30
                    .HorizontalAlignment = xlCenter
                End If
                
'                gArr(i, 1) = a(i, 1)
           Next j
           If lFulfillment Then
                 .Rows(nRowB + 2).EntireRow.Hidden = True
           End If

        '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        .Rows(nRowB).HorizontalAlignment = xlCenter
        .Rows(nRowB).VerticalAlignment = xlCenter
        .Rows(nRowB).Font.Bold = True
        .Rows(nRowB).Font.Size = 9
        
        .Columns(2).HorizontalAlignment = xlCenter  ''|fffd||fffd||fffd| |fffd||fffd|   <Spir>01110271 ~5375
        .Columns(2).ColumnWidth = 10                ''|fffd||fffd||fffd| |fffd||fffd|   <Spir>01110271 ~5375
        
         .Columns(1).HorizontalAlignment = xlLeft
         .Columns(nColE).HorizontalAlignment = xlRight
         .Cells(nRowB, 1).ColumnWidth = 28 ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
         .Rows(nRowB + 1).Font.Bold = True ''|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
         .Rows(nRowB + 2).Font.Bold = True ''|fffd||fffd||fffd||fffd||fffd|
         .Columns(nColE - 1).HorizontalAlignment = xlCenter ''|fffd||fffd||fffd||fffd||fffd||fffd|
         .Cells(nRowB, nColE - 1).HorizontalAlignment = xlLeft ''|fffd||fffd||fffd||fffd||fffd||fffd|
         .Columns(nColE - 1).ColumnWidth = 8   ''|fffd||fffd||fffd||fffd||fffd||fffd|
         .Columns(nColE - 1).NumberFormat = "@"   ''|fffd||fffd||fffd||fffd||fffd||fffd|
         '.Columns(.Columns.Count).ColumnWidth = 70   '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
         .Columns(nColE).EntireColumn.Hidden = True   '' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
         WSheet.Range("B3").HorizontalAlignment = xlLeft
    
        'WSheet.Range("A6:" & Replace(.Cells(n2 + 8, nColE).Address, "$", "")).Select
        Set SelRange = WSheet.Range("A6:" & Replace(.Cells(n2 + 8, nColE).Address, "$", ""))
        SelRange.Borders(xlDiagonalDown).LineStyle = xlNone
        SelRange.Borders(xlDiagonalUp).LineStyle = xlNone
        With SelRange.Borders(xlEdgeLeft)
            .LineStyle = xlContinuous
            .ColorIndex = 0
            .TintAndShade = 0
            .Weight = xlThin
        End With
        With SelRange.Borders(xlEdgeTop)
            .LineStyle = xlContinuous
            .ColorIndex = 0
            .TintAndShade = 0
            .Weight = xlThin
        End With
        With SelRange.Borders(xlEdgeBottom)
            .LineStyle = xlContinuous
            .ColorIndex = 0
            .TintAndShade = 0
            .Weight = xlThin
        End With
        With SelRange.Borders(xlEdgeRight)
            .LineStyle = xlContinuous
            .ColorIndex = 0
            .TintAndShade = 0
            .Weight = xlThin
        End With
        With SelRange.Borders(xlInsideVertical)
            .LineStyle = xlContinuous
            .ColorIndex = 0
            .TintAndShade = 0
            .Weight = xlThin
        End With
        With SelRange.Borders(xlInsideHorizontal)
            .LineStyle = xlContinuous
            .ColorIndex = 0
            .TintAndShade = 0
            .Weight = xlThin
        End With
        SelRange.AutoFilter    ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

         WSheet.Rows("9:" & n2 + 8).WrapText = True
         WSheet.Rows("9:" & n2 + 8).EntireRow.AutoFit
         
         WSheet.Rows(nRowB).WrapText = True
         
'         For i = 2 To .Rows.Count
'              .Rows(i).WrapText = True
'              .Rows(i).EntireRow.AutoFit
'         Next i
'         row = lRange.row + 1 '2-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'         i = row + lRange.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'         Rows(row & ":" & i).WrapText = True
'         Rows(row & ":" & i).EntireRow.AutoFit
         
'         .AutoFilter    ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        
       End With
       WSheet.Range("B4").Select
       
t2 = Time
'Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd| 2 - "; t2
'==============================
    ''''''''''''''''''''''''''
    XLTSheet.ScreenUpdating = True
    XLTSheet.Visible = True
          
    If NameFile <> False Then
    
        Application.ActiveWorkbook.SaveCopyAs Filename:=NameFile
        
        WBook = NameFile
        Set XLT_Sheet = CreateObject("Excel.Application")
        XLT_Sheet.Workbooks.Open WBook
        XLT_Sheet.ScreenUpdating = False
        XLT_Sheet.Application.DisplayAlerts = False
        XLT_Sheet.Workbooks(1).Activate
        
        lnStr = 0
        lnCh = 0
        With XLT_Sheet.ActiveWorkbook.VBProject.VBComponents(gcCodeName).CodeModule
            r = .ProcCountLines("Workbook_WindowActivate", vbext_pk_Proc)
            t = .ProcStartLine("Workbook_WindowActivate", vbext_pk_Proc)
            For i = t To t + r - 1
               .ReplaceLine i, " "
            Next i
            
            On Error Resume Next
            r = 0
            t = 0
            r = .ProcCountLines("Workbook_WindowActivate", vbext_pk_Proc)
            t = .ProcStartLine("Workbook_WindowActivate", vbext_pk_Proc)
            If r > 0 Then
                For i = t To t + r - 1
                   .ReplaceLine i, " "
                Next i
            End If
            
            r = 0
            t = 0
            r = .ProcCountLines("Workbook_SheetSelectionChange", vbext_pk_Proc)
            t = .ProcStartLine("Workbook_SheetSelectionChange", vbext_pk_Proc)
            If r > 0 Then
                For i = t To t + r - 1
                   .ReplaceLine i, " "
                Next i
            End If
        End With
        
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 28.08.2014
        For j = 1 To XLT_Sheet.ActiveWorkbook.Worksheets.Count
            With XLT_Sheet.ActiveWorkbook.VBProject.VBComponents(j).CodeModule
                On Error Resume Next
                r = 0
                t = 0
                r = .ProcCountLines("Worksheet_Activate", vbext_pk_Proc)
                t = .ProcStartLine("Worksheet_Activate", vbext_pk_Proc)
                For i = t To t + r - 1
                   .ReplaceLine i, " "
                Next i
            End With
        Next
        
        On Error GoTo A1
        XLT_Sheet.DisplayAlerts = False
        With XLT_Sheet.VBE.VBProjects.Item(1).References
            For i = .Count To 1 Step -1
                If Right$(.Item(i).name, 4) = "lnc2" Then
                    .Remove .Item(i)
                    Exit For
                End If
            Next
        End With
        
        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
        If XLT_Sheet.Windows.Count = 2 Then
            XLT_Sheet.Windows(2).Close
        End If
        
        
        XLT_Sheet.ActiveWorkbook.Unprotect "rassvet"
       
        For Each WSheet In XLT_Sheet.Sheets
            WSheet.Unprotect "rassvet"
            XLT_Sheet.DisplayAlerts = False
            If WSheet.name <> gsNameDetal Then WSheet.Delete
        Next
        
        XLT_Sheet.ScreenUpdating = False
        
    
'        If sDelName <> "?" Then
        
            XLT_Sheet.ScreenUpdating = False
            
            With XLT_Sheet.Names
                For i = .Count To 1 Step -1
                    .Item(i).Delete
                Next
            End With
'       End If
       
        XLT_Sheet.Application.DisplayAlerts = False
        XLT_Sheet.Workbooks(1).Save
        
        XLT_Sheet.ScreenUpdating = True
        XLT_Sheet.Visible = True
        XLT_Sheet.DisplayAlerts = True
'        XLT_Sheet.Quit
       
    End If
    Exit Sub
A1:
    MsgBox err.Number & " - " & err.Description & ". (cmbPrintDetal)"
    Resume Next
End Sub



Private Sub cmbSaveAs_Click()
' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
' 11.02.2011 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (Range("Data_Cells").Cells(1, 7).Value)
' 30.05.2014 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini-|fffd||fffd||fffd||fffd||fffd| IsDeleteNames=ON - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|. |fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ss
' 19.05.2017 |fffd||fffd||fffd||fffd||fffd||fffd|: |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| SheetsNotDelFromSaveAs |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd|, |fffd|.|fffd|. |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

    
    Dim NameFile As Variant, WSheet As Worksheet
    Dim nInkod As Long
    Dim XLT_Sheet As Excel.Application, WBook As String
    Dim sDelName As String
    Dim a As name, s$
    Dim IsSaved As Boolean, llFound As Boolean
    Dim i As Long, r As Long, t As Long
    Dim lnStr As Long, lnCh As Long
    Dim sDelXLA As String
    Dim sSheetsList As String

    On Error GoTo A1
    
    sDelName = UCase(sGetINI("IsDeleteNames", "?"))
    sDelXLA = UCase(sGetINI("IsDeleteXLA", "?"))

    NameFile = Application.GetSaveAsFilename(Application.ActiveWorkbook.name, _
            "|fffd||fffd||fffd||fffd||fffd| Microsoft Ecxel (*.xls), *.xls", , _
            "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|")
            
    If NameFile <> False Then
    
        Application.ActiveWorkbook.SaveCopyAs Filename:=NameFile
        
        WBook = NameFile
        Set XLT_Sheet = CreateObject("Excel.Application")
        XLT_Sheet.Workbooks.Open WBook
        XLT_Sheet.ScreenUpdating = False
        XLT_Sheet.Application.DisplayAlerts = False
        XLT_Sheet.Workbooks(1).Activate
        
        lnStr = 0
        lnCh = 0
        With XLT_Sheet.ActiveWorkbook.VBProject.VBComponents(gcCodeName).CodeModule
            If sDelXLA = "?" Then
                r = .ProcCountLines("Workbook_Open", vbext_pk_Proc)
                t = .ProcStartLine("Workbook_Open", vbext_pk_Proc)
                For i = t To t + r
                    llFound = .Find("s = ", i, 1, i, 80)
                    If llFound Then
                        lnStr = i
                    End If
                    If lnStr <> 0 And (0 <= lnCh And lnCh <= 3) Then
                        .ReplaceLine i, " "
                        lnCh = lnCh + 1
                    End If
                Next i
            End If
            
            On Error Resume Next
            r = 0
            t = 0
            r = .ProcCountLines("Workbook_WindowActivate", vbext_pk_Proc)
            t = .ProcStartLine("Workbook_WindowActivate", vbext_pk_Proc)
            If r > 0 Then
                For i = t To t + r - 1
                   .ReplaceLine i, " "
                Next i
            End If
            
            r = 0
            t = 0
            r = .ProcCountLines("Workbook_SheetSelectionChange", vbext_pk_Proc)
            t = .ProcStartLine("Workbook_SheetSelectionChange", vbext_pk_Proc)
            If r > 0 Then
                For i = t To t + r - 1
                   .ReplaceLine i, " "
                Next i
            End If
        End With
        
        On Error GoTo A1
        XLT_Sheet.DisplayAlerts = False
        With XLT_Sheet.VBE.VBProjects.Item(1).References
            For i = .Count To 1 Step -1
                If Right$(.Item(i).name, 4) = "lnc2" Then
                    .Remove .Item(i)
                    Exit For
                End If
            Next
        End With
        
        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
        If XLT_Sheet.Windows.Count = 2 Then
            XLT_Sheet.Windows(2).Close
        End If
        
        
'XLT_Sheet.Visible = True
'MsgBox XLT_Sheet.Workbooks(1).name
        
        XLT_Sheet.ActiveWorkbook.Unprotect "rassvet"
       sSheetsList = sGetINI("SheetsNotDelFromSaveAs", "?")
        For Each WSheet In XLT_Sheet.Sheets
            WSheet.Unprotect "rassvet"
'            fUnProtect True, W.Index
'            If W.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|" Then
'                nInkod = Range("Data_Cells").Cells(1, 7).Value
'                Range("Data_Cells").Cells(1, 7).Value = 0
'            End If
            XLT_Sheet.DisplayAlerts = False
            If WSheet.Visible = False Then
                If InStr(1, sSheetsList, WSheet.name, vbTextCompare) = 0 Then
                    WSheet.Delete
                End If
            End If
        Next
        
        XLT_Sheet.ScreenUpdating = False
        
    
        If sDelName <> "?" Then
        
            XLT_Sheet.ScreenUpdating = False
            
            With XLT_Sheet.Names
                For i = .Count To 1 Step -1
'                    If left$(.Item(i).name, 2) = "ss" Then
                        .Item(i).Delete
'                    End If
                Next
            End With
'            For Each a In XLT_Sheet.Names
''                s = a.name
''                If s Like "ss*" Then
'                    a.Delete
''                End If
'            Next
       End If
       
        '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'        With XLT_Sheet.VBE.ActiveVBProject.References
       
        XLT_Sheet.Application.DisplayAlerts = False
        XLT_Sheet.Workbooks(1).Save
        XLT_Sheet.Quit
       
    End If
    Exit Sub
A1:
    MsgBox err.Number & " - " & err.Description & ". (cmbSaveAs_Click)"
    Resume Next
End Sub

'Private Sub cmbSaveAs_Click()
'' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
'' 11.02.2011 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (Range("Data_Cells").Cells(1, 7).Value)
'' 30.05.2014 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini-|fffd||fffd||fffd||fffd||fffd| IsDeleteNames=ON - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|. |fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ss
'
'
'    Dim NameFile As Variant, W As Worksheet
'    Dim nInkod As Long
'    Dim XLT_Sheet As Object, WBook As String
'    Dim sDelName As String
'    Dim a As name, s$
'    Dim IsSaved As Boolean
'    Dim i As Long
'
'    sDelName = UCase(sGetINI("IsDeleteNames", "?"))
'
'    NameFile = Application.GetSaveAsFilename(Application.ActiveWorkbook.name, _
'            "|fffd||fffd||fffd||fffd||fffd| Microsoft Ecxel (*.xls), *.xls", , _
'            "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|")
'    If NameFile <> False Then
'
'        IsSaved = ActiveWorkbook.Saved
'
'        For Each W In ActiveWorkbook.Sheets
'            If Not (W.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or W.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|") And W.Visible = True Then fUnProtect True, W.Index
'            If W.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|" Then
'                fUnProtect True, W.Index
'                nInkod = Range("Data_Cells").Cells(1, 7).Value
'                Range("Data_Cells").Cells(1, 7).Value = 0
'                fUnProtect False, W.Index
'            End If
'        Next
'        Application.ActiveWorkbook.SaveCopyAs Filename:=NameFile
'
'        For Each W In ActiveWorkbook.Sheets
'            If W.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|" Then
'                fUnProtect True, W.Index
'                Range("Data_Cells").Cells(1, 7).Value = nInkod
'                fUnProtect False, W.Index
'            End If
'            If Not (W.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or W.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|") And W.Visible = True Then fUnProtect False, W.Index
'        Next
'
'        ActiveWorkbook.Saved = IsSaved
'
'        WBook = NameFile
'        Set XLT_Sheet = CreateObject("Excel.Application")
'        XLT_Sheet.Workbooks.Open WBook
'        For Each W In XLT_Sheet.Sheets
'            If Not (W.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or W.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|") And W.Visible = True Then fUnProtect True, W.Index
''            If W.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|" Then
''                fUnProtect True, W.Index
''                nInkod = Range("Data_Cells").Cells(1, 7).Value
''                Range("Data_Cells").Cells(1, 7).Value = 0
''                fUnProtect False, W.Index
''            End If
'        Next
'
'
'        If sDelName <> "?" Then
'            On Error GoTo A1
''            WBook = NameFile
''            Set XLT_Sheet = CreateObject("Excel.Application")
''            'XLT_Sheet.ScreenUpdating = False
''            XLT_Sheet.Workbooks.Open WBook
''            'Range("Data_Cells").Cells(1, 7).Value = 1000
''            'XLT_Sheet.Workbooks.Close
'
''    With XLT_Sheet.Names
''        For i = .Count To 1 Step -1
''            If left$(.Item(i).name, 2) = "ss" Then
''                .Item(i).Delete
''            End If
''        Next
''    End With
'
'            For Each a In XLT_Sheet.Names
''                s = a.name
''                If s Like "ss*" Then
'                    a.Delete
''                End If
'            Next
''            XLT_Sheet.ScreenUpdating = True
''            XLT_Sheet.Visible = True
''            XLT_Sheet.ActiveWorkbook.Saved = False
'
''            XLT_Sheet.Application.DisplayAlerts = False
''            XLT_Sheet.Workbooks(1).Save
''            XLT_Sheet.Quit
'       End If
'
'        XLT_Sheet.Application.DisplayAlerts = False
'        XLT_Sheet.Workbooks(1).Save
'        XLT_Sheet.Quit
'
'    End If
'    Exit Sub
'A1:
'    MsgBox err.Number & " - " & err.Description & ". (cmbSaveAs_Click)"
'    Resume Next
'End Sub



Public Sub fcmdRowHidden()
On Error GoTo A1
If SPS(ActiveSheet.Index) = False Then
'CommandBars("|fffd||fffd||fffd||fffd|").Controls(4).Caption = "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
CommandBars("|fffd||fffd||fffd||fffd|").Controls(5).Caption = "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" '31.10.2008

CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls(4).Caption = "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
'CommandBars("|fffd||fffd||fffd||fffd|").Controls(4).FaceId = 314
CommandBars("|fffd||fffd||fffd||fffd|").Controls(5).FaceId = 314 '31.10.2008
CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls(4).FaceId = 314
Else
'CommandBars("|fffd||fffd||fffd||fffd|").Controls(4).Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
CommandBars("|fffd||fffd||fffd||fffd|").Controls(5).Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" '31.10.2008
CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls(4).Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
'CommandBars("|fffd||fffd||fffd||fffd|").Controls(4).FaceId = 315
CommandBars("|fffd||fffd||fffd||fffd|").Controls(5).FaceId = 315 '31.10.2008
CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls(4).FaceId = 315
End If
A1:
End Sub
Public Sub fShowCmdInsDelRow(Optional ByVal flDelRow As Boolean = False)
'|fffd||fffd||fffd||fffd||fffd| / |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd|
Dim n As name
Dim flMS As Boolean, flInsRow As Boolean  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd|
'Dim flDelRow As Boolean '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim flRowHidden As Boolean '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|

On Error Resume Next
With ActiveWorkbook
flRowHidden = flDelRow
If .Worksheets(1).name = "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 1" Then flMS = True   '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
If flDelRow = True Then GoTo A1

For Each n In .Names
    If UCase(n.name) Like "DATA_SHEET*" Then
        If Range(n.name).Worksheet.name = .ActiveSheet.name Then
            If flMS = True Then flInsRow = True
            If Range(n.name).Rows.Count > 2 Then flDelRow = True: flRowHidden = True
        End If
    End If
Next

CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = flInsRow
'CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = flInsRow

A1:
If flMS = True Then flRowHidden = False ' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = flDelRow
CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd|").Visible = flDelRow
'CommandBars("|fffd||fffd||fffd||fffd|").Controls(4).Visible = flRowHidden
CommandBars("|fffd||fffd||fffd||fffd|").Controls(5).Visible = flRowHidden '31.10.2008
CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls(4).Visible = flRowHidden


End With
End Sub
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| -|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub fShowColumnMenu()
Dim CB As CommandBar
Dim cc As CommandBarControl
Dim MenuItem As CommandBarControl
Dim MenuSubItem As CommandBarControl
Dim MBut As CommandBarPopup
Dim fl As Boolean
'If (ActiveWorkbook.ActiveSheet.ProtectContents = True)
'|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
If IsAdmin Then Exit Sub
If Not ActiveWorkbook.FileFormat = xlTemplate Then
' |fffd||fffd|.|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
For Each cc In Application.CommandBars("Worksheet Menu Bar").Controls
    'Debug.Print CC.Caption & CC.id
    If cc.id = 30006 Then
        For Each MenuItem In cc.Controls
            'Debug.Print MenuItem.Caption & MenuItem.id
                If MenuItem.id = 30025 Or MenuItem.id = 30024 Then
                    For Each MenuSubItem In MenuItem.Controls
                        'Debug.Print MenuSubItem.Caption & MenuSubItem.id
                        If MenuSubItem.id = 886 Or MenuSubItem.id = 887 Or _
                                    MenuSubItem.id = 883 Or MenuSubItem.id = 884 Then _
                                   MenuSubItem.Enabled = False
                    Next MenuSubItem
                End If
        Next MenuItem
    End If
Next cc
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
Set cc = CommandBars("Column").FindControl(id:=886)
cc.Enabled = False
Set cc = CommandBars("Column").FindControl(id:=887)
cc.Enabled = False
Set cc = CommandBars("Row").FindControl(id:=883)
cc.Enabled = False
Set cc = CommandBars("Row").FindControl(id:=884)
cc.Enabled = False

End If
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| Enabled |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub ShowRekv()
Dim fl As Boolean, n As name, flHasRows As Boolean
Dim r As Range
Dim sRekvizit$, sTipeSp$, k As Long, j As Long, s$, v As Variant, i As Long, s1$, sv$, flRekv$
On Error Resume Next
flRekv = sGetINI("flRekv", "?")
If flRekv = "?" Then Exit Sub
fl = False
sRekvizit = ActiveSheet.name & "!|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
sTipeSp = sGetINI(sRekvizit, "?")
If sTipeSp = "?" Then Exit Sub
k = StrEl(sTipeSp)  '|fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
v = Array("Kod", "Name")
For j = 1 To k
    s = StrEl(sTipeSp, j)
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    If left$(s, 4) = "Date" Then
        s = left$(s, InStr(s, "(") - 1)
        s = sReplace(s, "Date", "Data")
    End If
    If left$(s, 4) = "Data" Then
        For i = 0 To 1
        s1 = sReplace(s, "Data", v(i))
            If HasName(s1) Then
                Set r = Range(s1)
                sv = Trim$(r.Cells(1, 1).Value)
                 If Len(sv) = 0 Then
                    fl = True
                    GoTo A1
                End If
            End If
        Next
    End If
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    If left$(s, 3) = "TXT" Then
        s1 = Mid$(s, InStr(s, "_") + 1)
        s1 = left$(s1, InStr(s1, "(") - 1)
        s1 = "Kod_" & s1
            If HasName(s1) Then
                Set r = Range(s1)
                sv = Trim$(r.Cells(1, 1).Value)
                 If Len(sv) = 0 Then
                    fl = True
                    GoTo A1
                End If
            End If
    End If
Next

If fl = False Then
    For Each n In ActiveWorkbook.Names
        s = n.name
        If s Like "Data_Sheet*" Then
            If Range(s).Rows.Count > 2 Then
                flHasRows = True
                GoTo A1
            End If
        End If
'        '' <Spir>10.01.2018 ~4177
'        If s Like "rr*" Then    '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|. |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|.0305074
'            flHasRows = True
'            GoTo A1
'        End If
    Next
End If


A1:
CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = Not flHasRows
CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = Not fl
'' <Spir>10.01.2018 ~4177
CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = Not fl
CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = Not fl
CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = Not fl

Set MB = Application.CommandBars("Worksheet Menu Bar")
MB.Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = Not flHasRows
MB.Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = Not fl
'' <Spir>10.01.2018 ~4177
MB.Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = Not fl
MB.Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = Not fl
MB.Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = Not fl
End Sub
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub HideDSBeforePrint()
On Error Resume Next
If sGetINI("idForm", "?") <> "125" Then Exit Sub
If sGetINI("GLRP", "?") = "?" Then Exit Sub
AddCmdMenu "|fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", 314, "fData_Sheet1Hide"
CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Delete
CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Delete
End Sub

Public Sub fData_Sheet1Hide()
Dim r As Range, j As Long, fl As Boolean
Dim NumDs As String

'Set r = Range("Data_Sheet1")
NumDs = fGetNumberDataSheet("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|")
If NumDs = "" Then NumDs = "1"
Set r = Range("Data_Sheet" & NumDs)

If r.Rows.Count < 3 Then Exit Sub
fl = r.Rows(2).EntireRow.Hidden
Application.ScreenUpdating = False
fUnProtect True
For j = 2 To r.Rows.Count - 1   '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
        r.Rows(j).EntireRow.Hidden = Not fl
Next j
Application.ScreenUpdating = True
fUnProtect False
Set r = Nothing
End Sub



Public Function IsAdmin() As Boolean
    IsAdmin = Application.UserName = "Victor" Or Application.UserName = "Lavrentiev" Or Application.UserName = "Simens" Or Application.UserName = "Spiridonova"
End Function

'----------------Ivanov---------------------------12/02/2014
Public Sub newSubMenu()
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    Dim menuBar As CommandBar
    Dim newMenu As CommandBarControl
    Dim oWs As Worksheet
 
    On Error Resume Next
    Application.CommandBars("Sub Menu Bar").Delete
    Set menuBar = Application.CommandBars.Add(menuBar:=False, Position:=msoBarPopup, name:="Sub Menu Bar", Temporary:=True)
    
    For Each oWs In Application.ActiveWorkbook.Worksheets
        If oWs.Visible = True Then
            Set newMenu = menuBar.Controls.Add(Type:=msoControlButton)
            newMenu.Caption = oWs.name
            newMenu.OnAction = "'SetWorkSheet (""" & oWs.name & """)'"
        End If
    Next
   Application.CommandBars("Sub Menu Bar").ShowPopup
End Sub

'----------------Ivanov---------------------------07/03/2014
Public Sub PrintActiveWindow()
    ActiveWindow.SelectedSheets.PrintOut Copies:=1, Collate:=True, Preview:=True
End Sub

Public Sub PrintActiveWindowAll()
    Dim oWs As Worksheet
    
    For Each oWs In Application.ActiveWorkbook.Worksheets
        If oWs.Visible Then
            oWs.PrintOut Copies:=1, Collate:=True, Preview:=True
        End If
    Next
    Set oWs = Nothing
End Sub

'----------------Ivanov---------------------------12/02/2014
Public Sub SetWorkSheet(Optional strName As String)
    Application.ActiveWorkbook.Worksheets(strName).Activate
End Sub

'----------------Ivanov---------------------------10/04/2014
Public Sub UpdateData()
    On Error Resume Next
    Application.Run ActiveWorkbook.name & "!" & "UpdateDataSheet"
End Sub


'----------------Spiridonova---------------------------03/09/2014
Public Sub LoadData()
    On Error Resume Next
    Application.Run ActiveWorkbook.name & "!" & "CreateFileForSm"
End Sub

'----------------Spiridonova---------------------------10/10/2016
Public Sub LoadData_1C()
    On Error Resume Next
    Application.Run ActiveWorkbook.name & "!" & "prConvertData"
End Sub


Attribute VB_Name = "modComment"
Public g|fffd|Comment As String

' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Function fGetComment(obj As Variant) As Variant
    g|fffd|Comment = obj
    
    'g|fffd|Comment = "------Test-------"
    
    fGetComment = 0
    
End Function

' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Function fSetComment() As Variant
    fSetComment = g|fffd|Comment
End Function

' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function fEditComment() As Variant
    
    UserForm3.TextBox1.Text = g|fffd|Comment
    UserForm3.Show
    
End Function
Attribute VB_Name = "modConstrForms"
Public Buttons() As New clsfrmshow
Public Options() As New clsfrmshow
Public Combos() As New clsfrmshow
Public flAdd As Boolean

Public Sub FormsCreate()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|.|fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| xlt |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
End Sub

Public Function VarAddForm(Optional ByVal sname$ = "") As Long
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim s$, i As Long
If Len(sname) = 0 Then sname = ActiveSheet.name
s = sGetINI(sname & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
'-----------------------------------------------------------31.10.2008
If s = "?" Then
   s = sGetINI(ActiveSheet.name & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
End If
'-----------------------------------------------------------31.10.2008

If s Like "*;*" Then
    i = 4
Else
    s = sGetINI(sname & "!Kod", "?")
    If s <> "?" And Not s Like "*$*" Then
        If StrEl(s) = 1 Then
            'If Not s Like "*+*" Then i = 1 Else i = 2
            If Not s Like "*+*" And Not s Like "*%*" Then i = 1 Else i = 2    '31.01.2011
        Else
            i = 3
        End If
    End If
End If
VarAddForm = i
End Function

Public Sub frmRekvizitShow()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|)
Dim s$, s1$
s = sGetINI(ActiveSheet.name & "!|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
'If flSaveFormat = False Then fSaveFormat
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| Kod |fffd| Naim |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini - |fffd||fffd||fffd||fffd||fffd|
'If s = "?" Then s = sGetRekv(ActiveSheet.Name & "!|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
If s <> "?" Then
    UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
    AddFormarekvizit s
    ''12.12.2014
    idForm = UCase(sGetINI("idForm", "?"))
    If idForm = "125_1" Then
        s = sGetINI("FillCells\" & Range("Kod_Account").Value & "\", "?")
        If s <> "?" Then
            FillCells s
        End If
        s = sGetINI("FillCellsF\" & Range("Kod_Account").Value & "\", "?")
        If s <> "?" Then
            FillCellsF s
        End If
        RestrictionList
    End If
    ''12.12.2014
End If
End Sub

Public Sub frmRekvizitShow2()
'Ivanov: |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| frmRekvizitShow, |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|)
Dim s$
Dim blnFlag As Boolean
s = sGetINI(ActiveSheet.name & "!|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
'If flSaveFormat = False Then fSaveFormat
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| Kod |fffd| Naim |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini - |fffd||fffd||fffd||fffd||fffd|
'If s = "?" Then s = sGetRekv(ActiveSheet.Name & "!|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
If s <> "?" Then
    blnFlag = Application.Run(Application.ActiveWorkbook.name & "!CheckRekvizits")
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If blnFlag Then
        UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
        Application.Run Application.ActiveWorkbook.name & "!ChangeRekvizits", True
        AddFormarekvizit s
        Application.Run Application.ActiveWorkbook.name & "!ChangeRekvizits", False
    End If
End If
End Sub

Public Sub frmInsertRowShow()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|)
Dim s$, sfl$
'-----------------------------------------------------------31.10.2008
Dim i As Long
Dim sname As String
Dim idForm As String
Dim Cbox As CommandBarComboBox
Dim sKod$, strMErr As String


 idForm = UCase(sGetINI("idForm", "?")): If Gl_ORG2() = False Then GoTo A3
'If IdForm = "125" Or IdForm = "169" Then
  If flgUseDataSheetInCodName = True Then
   
   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| Data_Sheet-|fffd||fffd||fffd|,|fffd|.|fffd|. |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
   Set Cbox = Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|")
   i = DataSheetFill(Cbox)
   i = 0
     
   sname = GetTextFormCmbBarCmbBox("|fffd||fffd||fffd||fffd|", "CmbDataSheet")
    If UCase(sname) = "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Or Trim(sname) = "" Then
      sname = ""
    '  s = "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| Data_Sheet," & vbCrLf
    '  s = s & "|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| " & vbCrLf
    '  s = s & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!"
    '  MsgBox s, vbOKOnly, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!"
    '  Exit Sub
    End If
  Else
    sname = ActiveSheet.name
  End If
'End If

'-----------------------------------------------------------31.10.2008
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| F125
If idForm = "125" Or idForm = "725" Or idForm = "125_1" Then
  ActiveWorkbook.CallFormAdd
  Exit Sub
End If
s = sGetINI(sname & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
'-----------------------------------------------------------31.10.2008
'-----------------------------------------------------------Spir 12.03.2015
If idForm = "164" Then
    s = sGetINI("Data_Sheet200!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
    sname = "Data_Sheet200"
End If
'-----------------------------------------------------------Spir 12.03.2015

'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| fRasstMain
'If flSaveFormat = False Then fSaveFormat
If s <> "?" Then
    UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
    i = VarAddForm(sname)
    'true-|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    'false-|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" |fffd||fffd||fffd||fffd||fffd|
    flAdd = True
    Select Case i
    Case 1
        AddForma1 s
    Case 2, 3
        AddForma23 s
    Case 4
        AddForma4 s
    End Select
Else
  s = "|fffd| ini-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| " & Chr(10) '31.10.2008
  s = s & "'" & sname & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|'"       '31.10.2008
  MsgBox s                                        '31.10.2008
End If

Exit Sub

A3:
    MsgBox sMsg, vbInformation, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
Exit Sub
A1:
    MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
End Sub
Public Function fNullspr(ByVal sTipeSp As String) As Boolean
'|fffd||fffd||fffd||fffd| False |fffd||fffd||fffd||fffd| |fffd||fffd||fffd|.|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim k As Long, j As Long, sn$, sNullSpr$, fl As Boolean
Dim i As Long, n As Long
    k = StrEl(sTipeSp)  '|fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If k = 0 Then fNullspr = False: Exit Function
    For j = 1 To k
        sn = StrEl(sTipeSp, j)
        If sn Like "*Data_TXT*" Or sn Like "*Date_*" Or sn Like "*TXT*_*" Or sn Like "GUID" Then GoTo A1
        n = n + 1
        If EmptyName(sn) > 1 Then
            i = i + 1
        Else
            sNullSpr = sNullSpr & sn & " "
        End If
A1:
    Next j
    If i = 0 And n > 0 Then
        MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & sNullSpr & " |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!"
        fNullspr = False
        Exit Function
    End If
    If Len(sNullSpr) > 0 Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & sNullSpr & " |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
    fNullspr = True
End Function

Public Sub AddFormarekvizit(ByVal sTipeSp As String)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| ListBox, txt |fffd| Date
Dim Q As New AddControl
Dim s$, k As Long, j As Long, sn$, ih As Long, s1$, i As Long
Dim h As Long, hl As Long, fl As Boolean
Dim iMaxBottom As Long, iMaxRight As Long
Dim sOneOptButton$

If fNullspr(sTipeSp) = False Then Exit Sub
k = StrEl(sTipeSp)  '|fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
For j = 1 To k
    sn = StrEl(sTipeSp, j)
    h = 10 + Q.MaxBottom    '10 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If sn Like "*Date_*" Or sn Like "*TXT*_*" Then
        fGetTxtBox sn, Q
    Else
        If EmptyName(sn) > 1 Then
            With Q
                .AutoSize = True
                sOneOptButton = sn  '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                s1 = fStrNameSpr(sn)
                ih = (Len(s1) \ 30 + 1) * 19 + 7
                .AddControl "OptionButton", sn, s1, h, 10, ih, 130
                i = i + 1
                If i = 1 Then hl = h
            End With
        End If
    End If
Next
If i > 0 Then
    With Q
       .ColumnCount = 2
       If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then .ColumnWidths = "115;400" Else .ColumnWidths = "125;400"
       
       .BoundColumn = 1
       .ColumnHeads = True
       .MaxBottom = 0
       .AddControl "ListBox", , , hl, 150, 120, 340
    End With
End If
h = Q.MaxBottom + 20
Q.AddControl "CommandButton", "cmdOk", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", h, Q.MaxRight - 205, 23, 90
Q.AddControl "CommandButton", "cmdCancel", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|", h, (Q.MaxRight - 90), 23, 90
With UserForm1
    .Height = Q.MaxBottom + 30
    .Width = Q.MaxRight + 20
End With
If i = 1 Then UserForm1.Controls(sOneOptButton).Value = True    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
fGetRekvTXT
UserForm1.Show
End Sub


Public Sub AddForma1(ByVal sTipeSp As String)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| ListBox, OptionButton |fffd| ComboBox |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd|
Dim Q As New AddControl
Dim s$, k As Long, i As Long, j As Long, sn$, ih As Long, s1$, lf As Long
Dim h As Long, fl As Boolean, h0 As Long
Dim iMaxBottom As Long, iMaxRight As Long
Dim sOneOptButton$, sNullSpr$
Dim rname As String '31.10.2008
Dim crows  As Long
'sTipeSp = sReplace(sTipeSp, "Data_SGU", "")
If fNullspr(sTipeSp) = False Then Exit Sub
k = StrEl(sTipeSp)  '|fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If k = 1 And sTipeSp Like "*Data_TXT*" Then
    fGetTxtBox sTipeSp, Q
    UserForm1.Controls("cmdFontSize").Visible = False
    '------01.12.2015 |fffd||fffd||fffd| |fffd|1605 - Data_Sheet001!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|= Data_TXT5(Kod_OTD) (|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
    If k = 1 And sTipeSp Like "Data_TXT5(Kod_OTD)" Then sDSName = "Data_Sheet001"
    GoTo A1
End If

If AddFrmDataSheetCbBox > 1 Then h0 = 27
h = h0

For j = 1 To k
    sn = StrEl(sTipeSp, j)
    If UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Or _
            UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Or UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Or sn <> "Data_SGU" Then
        If EmptyName(sn) > 1 Then
            With Q
                .AutoSize = True
                sOneOptButton = sn  '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                s1 = fStrNameSpr(sn)
                ih = (Len(s1) \ 30 + 1) * 19 + 7
                .AddControl "OptionButton", sn, s1, 7 + h, 10, ih, 130
                h = h + ih
            End With
'            i = i + 1
'        Else
'            sNullSpr = sNullSpr & sn & " "
        End If
    End If
    ''<Spir>18032016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| SGU
    If sn = "Data_SGU" Then
        If EmptyName(sn) > 1 Then
            With Q
                .AutoSize = True
                sOneOptButton = sn  '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                s1 = fStrNameSpr(sn)
                ih = (Len(s1) \ 30 + 1) * 19 + 7
                .AddControl "OptionButton", sn, s1, 7 + h, 10, ih, 130
                h = h + ih
            End With
        End If
    End If
Next
h = h0 + 10
With Q
   .ColumnCount = 2
   .ColumnWidths = "100;400"
   .BoundColumn = 1
   .ColumnHeads = True
   .MaxBottom = 0
   .AddControl "ListBox", , , h, 150, 120, 340
End With

If sTipeSp Like "*Data_FKR*" And UserForm1.Caption <> "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then
    If EmptyName("Data_SGU") > 1 Then
        With Q
            .ColumnCount = 2
            .ColumnWidths = "70;400"
            .BoundColumn = 1
            .ColumnHeads = True
            .RowSource = "Data_SGU"
            If i = 1 Then fl = True Else fl = False '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd|. |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
            h = .MaxBottom + 20
            .AddControl "ComboBox", "SGU", , h, 150, , 340, fl
            .AddControl "Label", "lblSGU", "|fffd||fffd||fffd||fffd||fffd|", h, 10, 20, 32, fl
         End With
     Else
        ''<SPIR>22012016 |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd|
'        MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
     End If
End If
A1:
h = Q.MaxBottom + 20
lf = (Q.MaxRight + 20) / 2
Q.AddControl "CommandButton", "cmdOk", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", h, (lf - 100) / 2, 23, 100
Q.AddControl "CommandButton", "cmdCancel", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|", h, lf + (lf - 100) / 2, 23, 100
With UserForm1
    .Height = Q.MaxBottom + 30
    .Width = lf * 2
End With
flAdd = False
If i = 1 Then UserForm1.Controls(sOneOptButton).Value = True    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
UserForm1.Show
End Sub

Public Sub AddForma23(ByVal sTipeSp As String)
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim i As Long, k As Long, s$, j As Long, sn$, sType$, h As Long, hList As Long, s1$, ih As Long, iL As Long, h0 As Long
Dim sNullSpr$
Dim wcmb As Long, w12f As Long
Dim Q As New AddControl
Dim Q1 As New clsfrmshow
Dim crows As Long

If fNullspr(sTipeSp) = False Then Exit Sub
If AddFrmDataSheetCbBox > 1 Then h0 = 27
h = h0
k = StrEl(sTipeSp)  '|fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'If k = 0 Then Exit Sub
hList = 110
'----12.01.2011---
'If k = 3 Then hList = 90
'If k > 3 Then sType = "ComboBox" Else sType = "ListBox"
If k = 5 Then hList = 75
''29.03.2017
If k = 6 Then hList = 75
If k > 6 Then sType = "ComboBox" Else sType = "ListBox"
'If k > 5 Then sType = "ComboBox" Else sType = "ListBox"
'----12.01.2011---
For j = 1 To k
    sn = StrEl(sTipeSp, j)
    If j = 1 Then
        h = 40 + Q.MaxBottom
    Else
        h = 20 + Q.MaxBottom
    End If
    If sn Like "*Data_TXT*" Then
            fGetTxtBox sn, Q
    Else
        If EmptyName(sn) > 1 Then
                With Q
                    '    .Tag = Sn
                    .ColumnCount = 2
                    .BoundColumn = 1
                    .ColumnHeads = True
                    .RowSource = sn
                    .AutoSize = True
                    'h = 20 + .MaxBottom
                    .AddControl sType, sn, , h, 150, hList, 340
                    DoEvents
                    Q1.finsertColumn UserForm1.Controls(sn)
                    s1 = fStrNameSpr(sn)
                    ih = (Len(s1) \ 30 + 1) * 21
                    .AddControl "Label", , s1, h, 10, ih, 130
                End With
'                i = i + 1
'        Else
'            sNullSpr = sNullSpr & sn & " "
        End If
    End If
Next
'If i = 0 Then MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & sNullSpr: Exit Sub
'If Len(sNullSpr) > 0 Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & sNullSpr & " |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"

h = Q.MaxBottom + 20
wcmb = 100
w12f = (Q.MaxRight + 20) / 2 - 30 - wcmb
If w12f < 0 Then
    wcmb = wcmb + w12f - 20
    UserForm1.cmdFontSize.Visible = False
Else
    UserForm1.cmdFontSize.Visible = True
End If

If wcmb < 50 Then wcmb = 50

Q.AddControl "CommandButton", "cmdOk", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", h, (Q.MaxRight + 20) / 2 - 30 - wcmb, , wcmb
Q.AddControl "CommandButton", "cmdCancel", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|", h, (Q.MaxRight + 20) / 2 + 30, , wcmb
With UserForm1
    .Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
    ''<Spir>01112017 ~3374
    .Width = Q.MaxRight + 20
'    ''<Spir>09092016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'    If crows = 0 Then
'        .Width = Q.MaxRight + 335
'    Else
'        .Width = Q.MaxRight + 20
'    End If
'    .Width = Q.MaxRight + 20
    If crows > 1 Then
      .Height = Q.MaxBottom + 60
    Else
      .Height = Q.MaxBottom + 40
    End If
End With
If flAdd = True Then
  flAdd = False
  UserForm1.Show
End If

End Sub

Function AddFrmDataSheetCbBox() As Long
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| DAta_Sheet-|fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim ih  As Long, h  As Long, hList  As Long, DsCnt  As Long
Dim sType As String, sn As String, dsnum As String
Dim Q As New AddControl

If sGetINI("UseDataSheetInCodName", "?") <> "ON" Then
    AddFrmDataSheetCbBox = 0
    Exit Function
End If

DsCnt = Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").ListCount - 1
If flAdd = False Then GoTo finnaly
If DsCnt >= 1 Then '|fffd||fffd||fffd||fffd| DAta_Sheet-|fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|>1
  h = 7
  hList = 20
  sn = Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Tag
  sType = "ComboBox"
  j = 0
   With Q
     .ColumnCount = 2
     .BoundColumn = 1
     .ColumnHeads = True
     .AutoSize = True
     .AddControl sType, sn, , h, 150, hList, 340
     
     For i = 1 To DsCnt + 1
       dsnum = Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").List(i)
       dsnum = UCase(dsnum)
       dsnum = sReplace(dsnum, "DATA_SHEET", "")
       If IsNumeric(dsnum) Then
         UserForm1.Controls(sn).AddItem dsnum
         j = UserForm1.Controls(sn).ListCount - 1
       Else
         GoTo ntx
       End If
       s = sGetINI(Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").List(i) & "!Caption", "?")
       If s <> "?" Then
         UserForm1.Controls(sn).List(j, 1) = s
       Else
         UserForm1.Controls(sn).List(j, 1) = Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").List(i)
       End If
       UserForm1.Controls(sn).TextColumn = 2
       UserForm1.Controls(sn).TextAlign = 1
       UserForm1.Controls(sn).ColumnWidths = 30
       
ntx:
     Next i
     If flAdd = True Then
       UserForm1.Controls(sn).ListIndex = 0
     End If
     DoEvents
     ih = (Len(s1) \ 30 + 1) * 21
     s1 = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
     .AddControl "Label", "LblDataSheet", s1, h, 10, ih, 130
    End With
End If

If DsCnt = 1 Then
  UserForm1.Controls(sn).Height = 0
  UserForm1.Controls("LblDataSheet").Height = 0
End If

finnaly:
AddFrmDataSheetCbBox = DsCnt
'Exit Function

End Function
Function GetTextFormCmbBarCmbBox(CmdBarName As String, ControlName As String) As String
'|fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|-> ControlName,|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ->CmdBarName,
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ControlName |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Tag |fffd||fffd||fffd| |fffd| Caption
'
Dim nm As String
On Error GoTo err_text
nm = ""
  For Each cntrl In Application.CommandBars(CmdBarName).Controls
    'If cntrl.Visible = True Then
      If UCase(cntrl.Tag) = UCase(ControlName) Then
        nm = cntrl.Text
        Exit For
      ElseIf UCase(cntrl.Caption) = UCase(ControlName) Then
        nm = cntrl.Text
        Exit For
      End If
    'End If
   Next

finally:
GetTextFormCmbBarCmbBox = nm

Exit Function
err_text:
'MsgBox Error(err)
'Resume
nm = ""
GoTo finally

End Function

Function fGetNumberDataSheet(stroka As String) As String
Dim i  As Long
Dim NumDs As String
On Error Resume Next
i = 0
stroka = Trim(stroka)
' If Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls(stroka).Visible = True Then
      NumDs = Trim(Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls(stroka).Text)
      NumDs = UCase(NumDs)
      i = InStr(1, NumDs, "DATA_SHEET")
      If i = 0 Then
        NumDs = ""
        GoTo finnaly
      End If
      NumDs = Mid(NumDs, i + Len("DATA_SHEET")) '|fffd||fffd||fffd||fffd||fffd| Data_Sheet
' End If

finnaly:
If stroka = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then
  NumDs = "01"
End If
fGetNumberDataSheet = NumDs

End Function
Public Sub AddForma4(ByVal sTipeSp As String)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ListBox |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ;
Dim Q As New AddControl
Dim s$, i As Long, j As Long, sn$, hList As Long, s1$, ih As Long, h0 As Long
Dim h As Long, fl As Boolean
Dim iMaxBottom As Long, iMaxRight As Long
Dim sOneOptButton$
Dim n As Long, k As Long, sNullSpr$, sType$
Dim rname As String '31.10.2008
Dim crows  As Long

If AddFrmDataSheetCbBox > 1 Then h0 = 27
h = ho

n = StrEl(sTipeSp, , ";")   ' |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
For j = 1 To n
s1 = StrEl(sTipeSp, j, ";")
If k < StrEl(s1) Then k = StrEl(s1) '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Next j

For j = 1 To n
    sn = StrEl(sTipeSp, j, ";")
    sn = StrEl(sn, 1)
    If EmptyName(sn) > 1 Then
        With Q
            .AutoSize = True
            s1 = fStrNameSpr(sn)
            ih = (Len(s1) \ 30 + 1) * 21
            .AddControl "OptionButton", str(j), s1, 7 + h, 10, ih, 130
            h = h + ih
        End With
        i = i + 1
    Else
        sNullSpr = sNullSpr & sn & " "
    End If
Next j
If i = 0 Then MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & sNullSpr: Exit Sub
If Len(sNullSpr) > 0 Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & sNullSpr & " |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
h = h0
Q.MaxBottom = 0
hList = 100
If k = 3 Then hList = 90
If k > 3 Then sType = "ComboBox" Else sType = "ListBox"
For j = 1 To k
With Q
   .ColumnCount = 2
   .ColumnWidths = "100;400"
   .BoundColumn = 1
   .ColumnHeads = True
   If crows > 1 Then
     h = 30 + .MaxBottom
   Else
     h = 10 + .MaxBottom
   End If
   .AddControl sType, , , h, 150, hList, 340
End With
Next j
h = Q.MaxBottom + 20
Q.AddControl "CommandButton", "cmdOk", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", h, (Q.MaxRight + 20) / 2 - 130, 23, 100
Q.AddControl "CommandButton", "cmdCancel", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|", h, (Q.MaxRight + 20) / 2 + 30, 23, 100

With UserForm1
    .Height = Q.MaxBottom + 30
    .Width = Q.MaxRight + 20
End With
If flAdd = True Then
  flAdd = False
  UserForm1.Show
End If
End Sub


Public Sub rekv()
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim s$, s1$, sd$, j  As Long, oldRekv$, newRekv$
Dim v As Variant, ss$, i As Long, sDate$, sfl$, sFormat$
fUnProtect True
v = Array("Kod", "Name")
If fEmptyControl("ListBox1") Then
    s = UserForm1.Controls("ListBox1").RowSource
    UserForm1.Controls("ListBox1").BoundColumn = 1
    newRekv = UserForm1.Controls("ListBox1").Value
    If s = "Data_EI" Then
        oldRekv = Trim$(Range("Kod_EI").Value)
        IzmenEI oldRekv, newRekv
    End If
'    sfl = sGetINI("Year", "?")
    If s = "Data_Account" And (sGetINI("idForm", "?") = "125" Or sGetINI("idForm", "?") = "725") Then
            If Len(Trim$(Range("Kod_VDE").Cells(1, 1).Value)) = 0 Then
                MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!"
                GoTo a2
            End If
    End If
    '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    s1 = sGetINI("idForm", "?")
    If s = "Data_VDE" And (s1 = "125" Or s1 = "169" Or s1 = "169N" Or s1 = "725" Or s1 = "AddVDE" Or s1 = "169N2013" Or s1 = "125_1" Or s1 = "169N2015" Or s1 = "169N2016") Then
'        F1251VDE
        F1251VDE Range("Kod_VDE").Cells(1, 1)
    End If
    If s = "Data_NCH" And sGetINI("idForm", "?") = "169" Then
        Application.ScreenUpdating = False
        fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
        sFormat = Range("Data_PLS0").Cells(1, 1).Offset(-1, 3)
        fData_Copy "Data_PLS0", True
        fData_Format "Data_PLS0", sFormat
        fData_Filter "Data_PLS0", "?" & newRekv & "*"
        fUnProtect False, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
        Application.ScreenUpdating = True
    End If
    '''12.01.2011
    If s = "Data_NCH" And (sGetINI("idForm", "?") = "169N" Or sGetINI("idForm", "?") = "169N2013" Or sGetINI("idForm", "?") = "169N2015" Or sGetINI("idForm", "?") = "169N2016") Then
        Application.ScreenUpdating = False
        fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
        sFormat = Range("Data_PLS0").Cells(1, 1).Offset(-1, 3)
        fData_Copy "Data_PLS0", True
        fData_Format "Data_PLS0", sFormat
        fData_Filter "Data_PLS0", "?" & newRekv & "*"
        fUnProtect False, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
        Application.ScreenUpdating = True
    End If
    '''12.01.2011
    
    If s Like "*Data_*" Then
        For j = 0 To 1
            s1 = sReplace(s, "Data", v(j))
            If EmptyName(s1) > 0 Then
                If ActiveWorkbook.Names(s1).RefersToLocal Like "*" & ActiveSheet.name & "*" Then
                    UserForm1.Controls("ListBox1").BoundColumn = j + 1
                    ActiveSheet.Range(s1).Value = UserForm1.Controls("ListBox1").Value
                End If
            End If
        Next j
    End If
End If
For Each a In UserForm1.Controls
    If (TypeName(a) = "TextBox") And a.Visible = True Then
        If Len(a.Value) = 0 Then GoTo A1
        If a.Enabled = False Then GoTo A1
        s1 = a.Tag
        If s1 Like "*Date_*" Then
                If IsDate(a.Value) = False Then
                    MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|.|fffd||fffd|.|fffd||fffd||fffd||fffd|"
                    GoTo A1
                End If
                i = InStr(s1, "_")
                sd = "Kod_" & Mid$(s1, i + 1)
                If EmptyName(sd) > 0 Then
                    If ActiveWorkbook.Names(sd).RefersToLocal Like "*" & ActiveSheet.name & "*" Then
                                ActiveSheet.Range(sd).Value = Format$(a.Value, "dd.mm.yyyy")
                                a.Enabled = False
                    End If
                End If
                sd = "Name_" & Mid$(s1, i + 1)
                If EmptyName(sd) > 0 Then
                    If ActiveWorkbook.Names(sd).RefersToLocal Like "*" & ActiveSheet.name & "*" Then
                                ActiveSheet.Range(sd).Value = Format$(a.Value, "dd mmmm yyyy")
                                a.Enabled = False
                    End If
                End If
        End If
        
        If s1 Like "*TXT*_*" Then
            i = InStr(s1, "_")
            s1 = "Kod_" & Mid$(s1, i + 1)
            If EmptyName(s1) > 0 Then
                If ActiveWorkbook.Names(s1).RefersToLocal Like "*" & ActiveSheet.name & "*" Then
                    If a.Enabled = True Then
                        ActiveSheet.Range(s1).Value = a.Value
                        a.Enabled = False
                    End If
                End If
            End If
        End If

    End If
A1:
Next
a2:
'If UserForm1.Controls("ListBox1").RowSource = "Data_EI" Then
'        UserForm1.Controls("ListBox1").BoundColumn = 1
'        Okr UserForm1.Controls("ListBox1").Value
'End If
fUnProtect False
End Sub

Public Sub fExecProc(Optional ByVal id As Long = 0, Optional ByVal nStr As Long, Optional ByVal sKod$)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'Nstr - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| sKod - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| ss |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
On Error GoTo A1
Dim s$, sWS$
If id = 0 Then
  
  If flgUseDataSheetInCodName = True Then
    sWS = "Data_Sheet" & UserForm1.Controls("CmbDataSheet").Value
  Else
    sWS = ActiveSheet.name
  End If

Else
  sWS = ActiveWorkbook.Worksheets(id).name
End If

s = sGetINI(sWS & "!Proc", "?") '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If Not s = "?" Then Application.Run ActiveWorkbook.name & "!" & Trim$(s), nStr, sKod

s = sGetINI(sWS & "!Proc_Add", "?") '' 20.06.2016 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
If s = "?" Then Exit Sub
Application.Run ActiveWorkbook.name & "!" & Trim$(s), nStr, sKod
Exit Sub
A1:
If err.Number = 450 Then Application.Run ActiveWorkbook.name & "!" & Trim$(s)
End Sub


Public Sub AddRow(Optional ByVal sDSName$ = "")
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim s$, k As Long, sKod$
Dim Row As Long
Dim n As name
Dim s1 As String '31.10.2008
Dim strError As String, s2 As String, Col  As Long '31.03.2015
Dim i  As Long, Par1 As String, Par2 As String '31.03.2015
Dim sTipeSp$, cNameGUIT$, fl  As Long   '15.10.2015

Application.ScreenUpdating = False
flAdd = True

''-------------------15.10.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| GUID |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
''SetGUID
'
'SetGUID
'SetGUID ("GUID1")
'-------------------30.10.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| GUID |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
SetGUID
For i = 1 To 10
    SetGUID ("GUID" + Trim(str(i)))
Next i

'If Trim(sDSName) <> "" Then
'  fl = EmptyName(sDSName)
'Else
'  fl = EmptyName("Data_Sheet" & ActiveSheet.Index)
'End
'IfsTipeSp = sGetINI(sDSName & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
'If sTipeSp = "?" And fl > 0 Then sTipeSp = sGetINI(ActiveSheet.name & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
'If sTipeSp Like "*GUID*" Then
'    cNameGUIT = Mid(sTipeSp, InStr(InStr(1, sTipeSp, "Kod_GUID"), sTipeSp, ")") - 5, InStr(InStr(1, sTipeSp, "Kod_GUID"), sTipeSp, ")") - InStr(1, sTipeSp, "Kod_GUID") - 4)
'    SetGUID (cNameGUIT)
'Else
'    SetGUID
'End If

sKod = fKod

'-----------------------------------------------------------31.10.2008
If Trim(sDSName) <> "" Then
  s1 = UCase(sDSName)
  s1 = Replace(s1, "DATA_SHEET", "")
Else
  If flgUseDataSheetInCodName = True Then
    s1 = left(Trim(sKod), gLenDopKodForCodName)
    sDSName = "Data_Sheet" & s1
  Else
     sDSName = "Data_Sheet" & ActiveSheet.Index
  End If

End If
'-----------------------------------------------------------31.10.2008

If Len(Trim$(sKod)) = 0 Then MsgBox "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Sub
If sKod Like "err*" Then
    MsgBox "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| " & StrEl(sKod, 2) & " |fffd|.|fffd|. " & StrEl(sKod, 3) & " |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
    Exit Sub
End If
fUnProtect True
fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Index
If Len(sDSName) = 0 Then sDSName = "Data_Sheet" & ActiveSheet.Index
'If sGetINI("idForm", "?") = "173" Then sDSName = "Data_Sheet" & Format(ActiveSheet.Index, "0")

If EmptyName(sDSName) > 0 Then
  Row = Range(sDSName).Row + Range(sDSName).Rows.Count - 1
End If

If Row > 0 Then
 '-----------------------------------------------------------31.03.2015
    s2 = GetINI(sDSName & "!CheckCode")
    If s2 <> "" Then
        '' Data_Sheet04!CheckCode=3,4;10,5;25,4
        Col = UBound(Split(s2, ";")) '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        If Col < 1 Then MsgBox "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ", , "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|": GoTo A1
        ReDim arrPar(1 To 4)
        arrPar(1) = ""
        arrPar(2) = ""
        arrPar(3) = ""
        arrPar(4) = ""
        For i = 1 To (Col + 1)
            strError = StrEl(s2, i, ";")
            Par1 = StrEl(strError, 1)
            Par2 = StrEl(strError, 2)
            arrPar(i) = Mid(sKod, Val(Par1), Val(Par2))
        Next i
        strError = ""
        If CheckCode(arrPar(1), strError, arrPar(2), arrPar(3), arrPar(4)) Then
        Else
            If strError <> "" Then
                MsgBox strError, , "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|": GoTo A1
            Else
               MsgBox Range("Data_CheckMsg").Value, , "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|": GoTo A1
            End If
        End If
    End If
 
    '-------22032017 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| 169
    If sGetINI(sDSName & "!Kod_OTD", "?") = "?" Then
        If (sGetINI("idForm", "?") = "169N2015" Or sGetINI("idForm", "?") = "169N2016") And (Mid(sKod, 1, 2) = "04" Or Mid(sKod, 1, 2) = "05" Or Mid(sKod, 1, 2) = "06") Then
    '-------22032017
            ''29.03.2017
            If Len(sKod) = 54 Then
                sKod = left(sKod, 30) & Mid(sKod, 32, 6) & Mid(sKod, 39, Len(sKod) - 37)
            Else
                sKod = left(sKod, 30) & Mid(sKod, 32, Len(sKod) - 30)
            End If
        End If
    Else
        If (sGetINI("idForm", "?") = "169N2015" Or sGetINI("idForm", "?") = "169N2016") And (Mid(sKod, 1, 2) = "04" Or Mid(sKod, 1, 2) = "05" Or Mid(sKod, 1, 2) = "06") Then
            ''29.03.2017
            If Len(sKod) = 54 Then
                sKod = left(sKod, 30) & Mid(sKod, 32, 6) & Mid(sKod, 39, Len(sKod) - 37) & Range("Kod_OTD").Value
            Else
                sKod = left(sKod, 30) & Mid(sKod, 32, Len(sKod) - 30) & Range("Kod_OTD").Value
            End If
        End If
    End If
'    '-------22032017 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| 169
'    If sGetINI(sDSName & "!Kod_OTD", "?") = "?" Then
'        If (sGetINI("idForm", "?") = "169N2015" Or sGetINI("idForm", "?") = "169N2016") And (Mid(sKod, 1, 2) = "04" Or Mid(sKod, 1, 2) = "05" Or Mid(sKod, 1, 2) = "06") Then sKod = left(sKod, 30) & Mid(sKod, 32, Len(sKod) - 30)
'    Else
'        If (sGetINI("idForm", "?") = "169N2015" Or sGetINI("idForm", "?") = "169N2016") And (Mid(sKod, 1, 2) = "04" Or Mid(sKod, 1, 2) = "05" Or Mid(sKod, 1, 2) = "06") Then sKod = left(sKod, 30) & Mid(sKod, 32, Len(sKod) - 30) & Range("Kod_OTD").Value
'    End If
'    '-------22032017
 
 '-----------------------------------------------------------31.03.2015
 '-----------------------------------------------------------31.10.2008
    If EmptyName("ss" & sKod & "a") > 0 Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & sKod & " |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": GoTo A1
    Application.ScreenUpdating = True
    Rows(Row).Insert Shift:=xlDown
    sKod = fInsertKod(sDSName, k)
    If flgUseDataSheetInCodName = True Then
      fInsertNameStr sDSName, s1 & sKod, 0, k
    Else
      fInsertNameStr sDSName, sKod, 0, k
    End If
'-----------------------------------------------------------31.10.2008
   
    fShowCmdInsDelRow True
    fExecProc , Row, sKod '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
End If
itogi
A1:
flAdd = False
fUnProtect False
fUnProtect False, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").Index
Application.ScreenUpdating = True

End Sub

Public Function fInsertKod(ByVal sDSName$, ByRef k0 As Long) As String
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim typeF As Long, sname$, s$, sskod$, k As Long, k1 As Long, Row As Long, sKod$, i As Long, fl As Long, sFormatKod$, sValue$
Dim a As Control, r As Range, sSp$
Dim sTipeSp$
Dim idForm$, sPr$
Dim lPrKodVD As Boolean ''<Spir> 29.12.2018

If flgUseDataSheetInCodName = True Then
  typeF = VarAddForm(sDSName)
Else
  typeF = VarAddForm
End If

lPrKodVD = False

'fl = sEmptyName("Data_Sheet" & ActiveSheet.Index)
'-----------------------------------------------------------31.10.2008
If Trim(sDSName) <> "" Then
  fl = EmptyName(sDSName)
Else
  fl = EmptyName("Data_Sheet" & ActiveSheet.Index)
End If
'-----------------------------------------------------------31.10.2008
'-----------------------------------------------------------17.01.2013
If GetINI("DSItog1!DataSource") <> "" Then
    sR = ""
End If
'-----------------------------------------------------------17.01.2013
sskod = sGetINI(sDSName & "!Kod", "?")
If sskod = "?" And fl > 0 Then sskod = sGetINI(ActiveSheet.name & "!Kod", "?")
sname = sGetINI(sDSName & "!Name", "?")
If sname = "?" And fl > 0 Then sname = sGetINI(ActiveSheet.name & "!Name", "?")
'|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sTipeSp = sGetINI(sDSName & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
If sTipeSp = "?" And fl > 0 Then sTipeSp = sGetINI(ActiveSheet.name & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")

Set r = Range(sDSName)
Row = r.Rows.Count - 1

'If sName <> "?" And typeF = 1 And StrEl(sName) = 1 Then
'    If fEmptyControl("SGU") = True Then sName = "0," & sName
'End If
For Each a In UserForm1.Controls
    If (TypeName(a) = "ListBox" Or TypeName(a) = "ComboBox" Or TypeName(a) = "TextBox") And a.Visible = True Then
       'If UCase(a.Name) = "CMBDATASHEET" Or UCase(a.Name) = "GUID" Then GoTo A1
       If UCase(a.name) = "CMBDATASHEET" Then GoTo A1
        i = i + 1
        'If A.RowSource <> StrEl(sTipeSp, i) Then fMsgbox "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|.|fffd||fffd||fffd|"
        If sname <> "?" Then
            s = StrEl(sname, i)
            If typeF = 1 Then s = StrEl(sname, 1)
            If s <> "0" And Len(s) > 0 Then
                If TypeName(a) <> "TextBox" Then
                        a.BoundColumn = 2
                        k1 = Val(s)
                        r.Cells(Row, k1) = a.Value
                        If typeF = 1 And a.name = "SGU" Then r.Cells(Row, k1) = a.Value
                        If k1 > k Then k = k1
                 End If
                If TypeName(a) = "TextBox" And Not IsNumeric(a.Value) Then
                    k1 = Val(s)
                        r.Cells(Row, k1) = a.Value
                    If k1 > k Then k = k1
                End If
            End If
        End If
        If sskod <> "?" Then
            s = StrEl(sskod, i)
            sSp = ""
            If TypeName(a) <> "TextBox" Then a.BoundColumn = 1: sSp = a.RowSource
            If Right$(sSp, 1) = "1" Then sSp = left$(sSp, Len(sSp) - 1)
'            If sSp = "Data_FKR1" Then sSp = "Data_FKR"
            sValue = sReplace(a.Value, " ", "")
            'If Not IsNumeric(sValue) Then GoTo A1
            If typeF = 3 Then
                
                  If s <> "0" And Len(s) > 0 Then
                  '  If UCase(a.Name) = "CMBDATASHEET" Or UCase(a.Name) = "GUID" Then GoTo A1
                      k1 = Val(s)
                      
''-------------------------------------27.12.2010
'                       'r.Cells(Row, k1) = fFormat(sValue, sSp)
'                       idForm = sGetINI("idForm", "?")
'                        If idForm = "169N" Or idForm = "169N2013" Or idForm = "169N2015" Then
'                            r.Cells(Row, k1) = Trim(r.Cells(Row, k1).Value) & fFormat(sValue, sSp)
'                        Else
'                            r.Cells(Row, k1) = fFormat(sValue, sSp)
'                        End If
''-------------------------------------27.12.2010
'-------------------------------------15.10.2015
                       idForm = sGetINI("idForm", "?")
                       Select Case idForm
                            Case "169N", "169N2013", "169N2015"
                                r.Cells(Row, k1) = Trim(r.Cells(Row, k1).Value) & fFormat(sValue, sSp)
                            Case "169N2016"
                                If sSp = "Data_PLS0" Then sPr = " " Else sPr = ""   '' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd| 2 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                                r.Cells(Row, k1) = sPr & Trim(r.Cells(Row, k1).Value) & fFormat(sValue, sSp)
                            Case "SostavKod"    '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini |fffd||fffd||fffd||fffd| Data_Sheet012!Kod =1,1,7 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| 1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 2-|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (F175_1)
                                ''<Spir> 29.12.2018 |fffd|7732 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                                If lPrKodVD = False Then
                                    r.Cells(Row, k1) = Trim(r.Cells(Row, k1).Value) & " " & fFormat(sValue, sSp)
                                Else
                                    r.Cells(Row, k1) = Trim(r.Cells(Row, k1).Value) & fFormat(sValue, sSp)
                                    lPrKodVD = False
                                End If
                            Case Else
                                r.Cells(Row, k1) = fFormat(sValue, sSp)
                       End Select
                       
                       If sSp = "Data_KODVD" Then lPrKodVD = True   ''<Spir> 29.12.2018 |fffd|7732
                       
'-------------------------------------15.10.2015
                      If k1 > k Then k = k1
                  End If
                
            End If
            '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            If Not (sSp = "Data_KODVD") Then    ''<Spir> 29.12.2018 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                sFormatKod = sFormatKod & fFormat(sValue, sSp) & sR
            End If
            sKod = sKod & sValue
         End If
    End If
A1:
Next
sKod = Trim$(sKod)
If typeF <> 3 And sskod <> "?" Then
    s = StrEl(sskod, 1)
    k1 = Val(s)
    If Right$(sFormatKod, 1) = sR Then sFormatKod = left$(sFormatKod, Len(sFormatKod) - 1)
    
'' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| 169  10.11.2015
'    r.Cells(Row, k1) = sFormatKod
    idForm = sGetINI("idForm", "?")
    If idForm = "169N2015" Then
        If Right(sDSName, 2) = "01" Or Right(sDSName, 2) = "04" Then r.Cells(Row, k1) = Mid$(sFormatKod, 1, 3) & " " & Mid$(sFormatKod, 4, 10) & " " & Mid$(sFormatKod, 14, 4) & " " & Mid$(sFormatKod, 18, 9)
        If Right(sDSName, 2) = "02" Or Right(sDSName, 2) = "05" Then r.Cells(Row, k1) = Mid$(sFormatKod, 1, 3) & " " & Mid$(sFormatKod, 4, 4) & " " & Mid$(sFormatKod, 8, 7) & " " & Mid$(sFormatKod, 15, 3) & " " & Mid$(sFormatKod, 18, 9)
        If Right(sDSName, 2) = "03" Or Right(sDSName, 2) = "06" Then r.Cells(Row, k1) = Mid$(sFormatKod, 1, 3) & " " & Mid$(sFormatKod, 4, 10) & " " & Mid$(sFormatKod, 14, 4) & " " & Mid$(sFormatKod, 18, 9)
    End If
    If idForm = "169N2016" Then
        If Right(sDSName, 2) = "01" Or Right(sDSName, 2) = "04" Then r.Cells(Row, k1) = Mid$(sFormatKod, 1, 19) & " " & Mid$(sFormatKod, 20, 9)
        If Right(sDSName, 2) = "02" Or Right(sDSName, 2) = "05" Then r.Cells(Row, k1) = Mid$(sFormatKod, 1, 19) & " " & Mid$(sFormatKod, 20, 9)
        If Right(sDSName, 2) = "03" Or Right(sDSName, 2) = "06" Then r.Cells(Row, k1) = Mid$(sFormatKod, 1, 19) & " " & Mid$(sFormatKod, 20, 9)
        ''<Spir>30.01.2019 #7848
        If Right(sDSName, 2) = "07" Then r.Cells(Row, k1) = Mid$(sFormatKod, 1, 19) & " " & Mid$(sFormatKod, 20, 9)
        If Right(sDSName, 2) = "08" Then r.Cells(Row, k1) = Mid$(sFormatKod, 1, 19) & " " & Mid$(sFormatKod, 20, 9)
    End If
    If Not (idForm = "169N2015" Or idForm = "169N2016") Then
        r.Cells(Row, k1) = sFormatKod
    End If
    
    If k1 > k Then k = k1
End If
Set r = Nothing
k0 = k + 1
'|fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If sGetINI("idForm", "?") = "173" Then
sDSName = sReplace(sDSName, "Data_Sheet", "")
sKod = Format(sDSName, "0") & sKod
End If
If sGetINI(sDSName & "!Kod_OTD", "?") = "?" Then
    If (sGetINI("idForm", "?") = "169N2015" Or sGetINI("idForm", "?") = "169N2016") And (Mid(sDSName, 11, 2) = "04" Or Mid(sDSName, 11, 2) = "05" Or Mid(sDSName, 11, 2) = "06") Then
        ''29.03.2017
        If Len(sKod) = 52 Then
            sKod = left(sKod, 28) & Mid(sKod, 30, 6) & Mid(sKod, 37, Len(sKod) - 36)
        Else
            sKod = left(sKod, 28) & Mid(sKod, 30, Len(sKod) - 29)
        End If
    End If
Else
    If (sGetINI("idForm", "?") = "169N2015" Or sGetINI("idForm", "?") = "169N2016") And (Mid(sDSName, 11, 2) = "04" Or Mid(sDSName, 11, 2) = "05" Or Mid(sDSName, 11, 2) = "06") Then
'            sKod = left(sKod, 28) & Mid(sKod, 30, Len(sKod) - 29) & Range("Kod_OTD").Value
        ''29.03.2017
        If Len(sKod) = 52 Then
            sKod = left(sKod, 28) & Mid(sKod, 30, 6) & Mid(sKod, 37, Len(sKod) - 36) & Range("Kod_OTD").Value
        Else
            sKod = left(sKod, 28) & Mid(sKod, 30, Len(sKod) - 29) & Range("Kod_OTD").Value
        End If
    End If
End If
'If sGetINI(sDSName & "!Kod_OTD", "?") = "?" Then
'    If (sGetINI("idForm", "?") = "169N2015" Or sGetINI("idForm", "?") = "169N2016") And (Mid(sDSName, 11, 2) = "04" Or Mid(sDSName, 11, 2) = "05" Or Mid(sDSName, 11, 2) = "06") Then sKod = left(sKod, 28) & Mid(sKod, 30, Len(sKod) - 29)
'Else
'    If (sGetINI("idForm", "?") = "169N2015" Or sGetINI("idForm", "?") = "169N2016") And (Mid(sDSName, 11, 2) = "04" Or Mid(sDSName, 11, 2) = "05" Or Mid(sDSName, 11, 2) = "06") Then sKod = left(sKod, 28) & Mid(sKod, 30, Len(sKod) - 29) & Range("Kod_OTD").Value
'End If
'If sGetINI("idForm", "?") = "169N2015" And (Mid(sDSName, 11, 2) = "04" Or Mid(sDSName, 11, 2) = "05" Or Mid(sDSName, 11, 2) = "06") Then sKod = left(sKod, 28) & Right(sKod, 9)
fInsertKod = sKod
End Function

Public Function fGetTxtBox(ByVal sSpName$, ByRef Q As AddControl)
Dim i1 As Long, i2 As Long, iL As Long, sL$, h As Long, ih As Long, Enabled As Boolean, sR$
Dim s$, Caption$, Value$, stxtName$
Dim flDs As Boolean
Dim str As String
Dim th As Long
'''''''12.01.2011
Dim cNameGUIT$
'''''''22.03.2016
Dim idForm$


On Error Resume Next
Enabled = True
Visible = True
i1 = InStr(sSpName, "=")
If i1 > 0 Then Value = Trim$(Mid$(sSpName, i1 + 1))
i1 = InStr(8, sSpName, "(")
i2 = InStr(i1 + 1, sSpName, ")")
sL = Mid$(sSpName, i1 + 1, i2 - i1 - 1)
If sSpName Like "*Data_*" Then iL = Val(Mid$(sSpName, 9, i1 - 9)): Caption = sL
If sSpName Like "*Date_*" Then iL = 10: Caption = left$(sSpName, i1 - 1)
If sSpName Like "*TXT*_*" Then
    i1 = InStr(sSpName, "TXT") + 3
    i2 = InStr(3, sSpName, "_")
    iL = Val(Mid$(sSpName, i1, i2 - i1))
    i1 = InStr(sSpName, "(")
    Caption = left$(sSpName, i1 - 1)
    If Len(Value) > 0 Then
        Enabled = False
        sR = "Kod_" & Mid$(Caption, i2 + 1)
        If ActiveSheet.Range(sR).Cells(1, 1).Value <> Value Then
            fUnProtect True
             ActiveSheet.Range(sR).Cells(1, 1).Value = Value
            fUnProtect False
        End If
    End If

End If
Q.MaxLength = iL

'''''''12.01.2011
If sEmptyName(sL) = 1 Then
    s = Range(sL).Value

  If sL Like "*GUID*" Then
  
'''''''12.01.2011
    cNameGUIT = Mid(sL, 5, Len(sL) - 4)
'''''''12.01.2011

    sL = Trim(sGetINI("GUIDCaption", "?"))
    If sL = "?" Then
      sL = "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd|"
    End If
    Enabled = False
    str = Trim(sGetINI("GUIDVISIBLE", "?"))
    h = 10 + Q.MaxBottom
    If UCase(str) = "TRUE" Then
      ih = (Len(sL) \ 30 + 1) * 21
      th = 18
      Q.AddControl "Label", , sL, h, 15, ih, 130, , True
'''''''12.01.2011
      'Q.AddControl "TextBox", s, "GUID", h, 150, th, iL * 10 + 50, , Enabled
      Q.AddControl "TextBox", s, cNameGUIT, h, 150, th, iL * 10 + 50, , Enabled
'''''''12.01.2011
    Else
      ih = 0
      th = 0
'''''''12.01.2011
      'Q.AddControl "TextBox", s, "GUID", h, 150, th, 0, , Enabled
      Q.AddControl "TextBox", s, cNameGUIT, h, 150, th, 0, , Enabled
'''''''12.01.2011
    End If
     
     
  Else
'    ' |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|!!!!!------01.12.2015 |fffd||fffd||fffd| |fffd|1605 - Data_Sheet001!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|= Data_TXT5(Kod_OTD) (|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
'    If sSpName Like "Data_TXT5(Kod_OTD)" Then
'        Q.AddControl "TextBox", s, "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", h, 150, 18, iL * 10 + 50, , False
'    Else
        Q.AddControl "TextBox", s
'    End If
'   Q.AddControl "TextBox", s
  End If
Else
    h = 10 + Q.MaxBottom
    ''<Spir>22.03.2016 |fffd||fffd||fffd| 769 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    idForm = UCase(sGetINI("idForm", "?"))
    If idForm = "169N2016" Then h = h + 20
    ''
    ih = (Len(sL) \ 30 + 1) * 21
    Q.AddControl "TextBox", Value, Caption, h, 150, 18, iL * 10 + 50, , Enabled
    Q.AddControl "Label", , sL, h, 15, ih, 130, , Enabled
  
End If
End Function

Public Function fKod() As String
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ListBox |fffd| ComboBox |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| = ""
Dim sKod$, sValue$
For Each a In UserForm1.Controls
    If (TypeName(a) = "ListBox" Or TypeName(a) = "ComboBox" Or TypeName(a) = "TextBox") And a.Visible = True Then
    'If (TypeName(a) = "ListBox" Or TypeName(a) = "ComboBox" Or TypeName(a) = "TextBox") Then
    'If UCase(a.Name) = "GUID" Then Stop
       If flgUseDataSheetInCodName = False And UCase(a.name) = "CMBDATASHEET" Then GoTo A1
        If TypeName(a) <> "TextBox" Then a.BoundColumn = 1
        If (IsNull(a.Value)) Then
          fKod = ""
          Exit Function
        Else
          sValue = a.Value
        End If
        If (Len(sValue) = 0) Then fKod = "": Exit Function
        'If Not IsNumeric(sValue) Then GoTo A1
        sValue = sReplace(sValue, " ", "")  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Data_FKR
        If Not IsNull(sValue) And Len(sValue) > 0 Then sKod = sKod & sValue Else fKod = "": Exit Function
        If TypeName(a) = "TextBox" Then
            If Len(Trim$(sValue)) < a.MaxLength Then fKod = "err," & a.Tag & "," & a.MaxLength: Exit Function
        End If
    End If
A1:
Next
If sGetINI("idForm", "?") = "173" Then sKod = Format(ActiveSheet.Index, "0") & sKod
'If sGetINI("idForm", "?") = "169N2015" And (Mid(ActiveSheet.name, 11, 2) = "04" Or Mid(ActiveSheet.name, 11, 2) = "05" Or Mid(ActiveSheet.name, 11, 2) = "06") Then sKod = left(sKod, 30) & Right(sKod, 9)
fKod = sKod
End Function

'' Spir 01/09/2015    |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'' Ivanov 29/06/2015    |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'' Ivanov 31/03/2015
Public Function CheckCode(ByVal MainCode As String, _
                            ByRef StringError As String, _
                            ByVal Code1 As String, _
                            Optional ByVal Code2 As String, _
                            Optional ByVal Code3 As String, _
                            Optional ByVal Name_DataCheck As String) As Boolean

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'MainCode - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|
'StringError - |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
'Code1,Code2,Code3 - |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| MainCode. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'Name_DataCheck - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|. |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| "Data_Check" Spir 01/09/2015

    Dim i  As Long
    Dim blnFlagAvail As Boolean
    Dim blnFlagCode As Boolean
    Dim strErr As String    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Dim strTempErr As String
    Dim oXML As Object            '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| xml
    Dim iDiff  As Long          '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1-|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Dim blnCheckRekv As Boolean     '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Dim k  As Long
    Dim rDataCheck As Range         ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|. |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Spir 01/09/2015
    Dim strParam As String          ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  Spir 01/09/2015
    
    On Error GoTo A1
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    blnFlagAvail = False
    
    ''Spir 01/09/2015
    If Len(Name_DataCheck) > 0 Then
        Set rDataCheck = Range(Name_DataCheck)
    Else
        Set rDataCheck = Range("Data_Check")
    End If
    On Error Resume Next
    
    strParam = ""
    
'    With Range("Data_Check")
    With rDataCheck   ''Spir 01/09/2015
        iDiff = .Columns.Count - 7      '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 7, |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Ivanov 29/06/2015
        If iDiff > 0 Then
            On Error Resume Next
            Set oXML = CreateObject("MSXML2.DOMDocument")
        End If
        For i = 1 To .Rows.Count
            '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|
            blnCheckRekv = True
'            If IsObject(oXML) Then
            If iDiff > 0 Then
                With oXML
                    ''Spir 22/09/2015
                    oXML.LoadXML "<aksiok>" & rDataCheck.Cells(i, 1) & "</aksiok>"
                    For k = 0 To .ChildNodes(0).ChildNodes.Length - 1
                        If .ChildNodes(0).ChildNodes(k).Text <> Range("Kod_" & .ChildNodes(0).ChildNodes(k).nodeName) Then
                            blnCheckRekv = False
                            Exit For
                            '|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|
                        End If
                    Next
                    ''''''''''''''''''''
'                    oXML.LoadXML rDataCheck.Cells(i, 1) ''Spir 01/09/2015
''                    oXML.LoadXML Range("Data_Check").Cells(i, 1)
'                    For k = 0 To .ChildNodes.Length - 1
'                        If .ChildNodes(k).Text <> Range("Kod_" & .ChildNodes(k).nodeName) Then
'                            blnCheckRekv = False
'                            Exit For
'                            '|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|
'                        End If
'                    Next
                    ''''''''''''''''''''
                End With
            Else
                If iDiff > 0 Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd| Internet Explorer" & vbCrLf & "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" & vbCrLf & "|fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: msxml4.dll", vbOKOnly + vbCritical, "|fffd||fffd||fffd||fffd||fffd||fffd|"
            End If
            If MainCode Like Trim(.Cells(i, 1 + iDiff)) And blnCheckRekv Then
                ''Spir 01/09/2015 |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                strParam = rDataCheck.Cells(i, 1).Value
                '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                If Len(.Cells(i, 2 + iDiff)) > 0 Then
                    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd|1
                    blnFlagCode = SeekCode(Code1, .Cells(i, 2 + iDiff))
                    If Not blnFlagCode Then
                        '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                        strTempErr = Replace(.Cells(i, 3 + iDiff), "<MainCode>", MainCode, 1, 1)
                        strTempErr = Replace(strTempErr, "<Code1>", Code1, 1, 1)
                        strTempErr = Replace(strTempErr, "<Param>", strParam, 1, 1) ''Spir 01/09/2015
                        strErr = strErr & strTempErr & vbCrLf
                    Else
                        '|fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|2 (|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|)
                        If Len(Code2) > 0 Then
                            blnFlagCode = SeekCode(Code2, .Cells(i, 4 + iDiff))
                            If Not blnFlagCode Then
                                '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                                strTempErr = Replace(.Cells(i, 5 + iDiff), "<MainCode>", MainCode, 1, 1)
                                strTempErr = Replace(strTempErr, "<Code2>", Code2, 1, 1)
                                strTempErr = Replace(strTempErr, "<Param>", strParam, 1, 1) ''Spir 01/09/2015
                                strErr = strErr & strTempErr & vbCrLf
                            Else
                                If Len(Code3) > 0 Then
                                    blnFlagCode = SeekCode(Code3, .Cells(i, 6 + iDiff))
                                    If Not blnFlagCode Then
                                        '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                                        strTempErr = Replace(.Cells(i, 7 + iDiff), "<MainCode>", MainCode, 1, 1)
                                        strTempErr = Replace(strTempErr, "<Code3>", Code3, 1, 1)
                                        strTempErr = Replace(strTempErr, "<Param>", strParam, 1, 1) ''Spir 01/09/2015
                                        strErr = strErr & strTempErr & vbCrLf
                                    Else
                                        blnFlagAvail = True
                                    End If
                                Else
                                    blnFlagAvail = True
                                End If
                            End If
                        Else
                            blnFlagAvail = True
                        End If
                    End If
                End If
            End If
        Next
    End With

    CheckCode = blnFlagAvail
    StringError = strErr
    Set oXML = Nothing
    Exit Function
    
A1:
    MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & vbCrLf & _
    "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| lnc2.ini " & vbCrLf & _
    "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", , "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
    
End Function

'' Ivanov 31/03/2015
Private Function SeekCode(ByVal CodeForSeek As String, ByVal StringCodes As String) As Boolean
    Dim vArr() As String    '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    Dim j  As Long
    Dim SeekCodeNot As Boolean
    
    vArr = Split(StringCodes, ",")
    '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|
    SeekCode = False
    If IsArray(vArr) Then
        For j = 0 To UBound(vArr, 1)
            If CodeForSeek Like Trim(vArr(j)) Then
                SeekCode = True
                Exit Function
            End If
        Next
        '' 20.06.2016 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| <>
        If SeekCode = False Then
            SeekCodeNot = False
            For j = 0 To UBound(vArr, 1)
                If left(Trim(vArr(j)), 2) = "<>" Then
                    If CodeForSeek Like Mid(Trim(vArr(j)), 3, Len(Trim(vArr(j))) - 2) Then
                        SeekCodeNot = True
                        Exit Function
                    End If
                End If
            Next
            If SeekCodeNot = False And left(Trim(vArr(0)), 2) = "<>" Then SeekCode = True
        End If
    End If
    
End Function



Attribute VB_Name = "modDetaleSvod"
Option Explicit


Public goSvod As Object
Public gfWindowOn As Boolean
Public gsNameDetal As String
Public t2 As Variant
Public CountDetal As Long
Public gArr() As Variant '' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public gcNamePer As String

Public Function fVisiblePrint() As Variant
' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

    If Not (gsNameDetal = "") Then
        If ActiveWorkbook.Windows.Count = 1 Then
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = False
        Else
            CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = True
        End If
    End If
    
    fVisiblePrint = True

End Function


Public Function fGetObject(obj As Variant) As Variant
Dim Result  As Long
Dim cKod As Variant, lSvod As Variant, lSvodMenu As Variant
Dim t  As Long
Dim WSheet As Worksheet
Dim s$
    
    If IsObject(obj) Then
'        Debug.Print "IsObject"
        If Not (obj Is Nothing) Then
        'ivanov 23.06.2017 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            Set goSvod = obj
            cKod = obj.cKodOrg
            lSvodMenu = obj.lIsSvod
        End If
        '' 10/03/2015 |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|..."
        s = sGetINI(ActiveSheet.name & "!NoDetal", "?")
        If s <> "?" And lSvodMenu = "2" Then lSvodMenu = "3"
        '' 10/03/2015 |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|..."
        
        gsNameDetal = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        t = 0 '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        For Each WSheet In ActiveWorkbook.Sheets
            If WSheet.name = gsNameDetal Then
               t = 1    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            Else
            End If
        Next
        If t = 1 Then
            If lSvodMenu = "1" Or lSvodMenu = "2" Then
                lSvod = True
                With ActiveWorkbook
                   CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = lSvod
                   CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = Not lSvod
                   CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = Not lSvod
                   gfWindowOn = False
                   gsNameDetal = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
                End With
            
                fVisiblePrint
              
            Else
                lSvod = False
                With ActiveWorkbook
                   CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = False
                   CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = False
                   CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = False
                End With
            End If
            
            Result = 0
        End If
        If t = 0 Then
            gsNameDetal = ""
'            If lSvodMenu = "1" Then
'                lSvod = True
'                With ActiveWorkbook
'                   CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = lSvod
'                   CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = Not lSvod
'                   CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = False
'                   gfWindowOn = False
'                End With
'            Else
'                lSvod = False
                With ActiveWorkbook
                   CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = False
                   CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = False
                   CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = False
                   gfWindowOn = False
                End With
'            End If
            Result = 0
        End If
    Else
'        Debug.Print "NOT IsObject"
        Result = -1
    End If
    

fGetObject = Result
End Function

Public Function fStartWindow() As Variant
    Dim lcNameCell As String

    If Not (gsNameDetal = "") Then
        If gfWindowOn = False Then
            gfWindowOn = True
            fStartFox
        Else
            gfWindowOn = False
            If Application.Windows.Count = 2 Then
               Application.Windows("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Close
            End If
            ActiveWindow.WindowState = xlMaximized
        End If
    End If
    
'    If gsNameDetal = "" Then
'        gfWindowOn = True
'        fStartFox
'    End If
    
End Function

Public Function fStartWindowOld() As Variant
    Dim lcNameCell As String

'    If Not (gsNameDetal = "") Then
'        If gfWindowOn = False Then
'            gfWindowOn = True
'            fStartFox
'        Else
'            gfWindowOn = False
'            If Application.Windows.Count = 2 Then
'               Application.Windows("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Close
'            End If
'            ActiveWindow.WindowState = xlMaximized
'        End If
'    End If
'
    If gsNameDetal = "" Then
        gfWindowOn = True
        fStartFox
    End If
    
End Function


Public Function fStartFox() As Variant
    Dim lcNameCell As String
    Dim SRow  As Long, SCol1  As Long, SRow1  As Long
    Dim i As Long, j As Long, lnCoutn  As Long, k  As Long
    Dim lcName As String
    Dim lSaved As Boolean
    Dim lcNameSh As String
    Dim r As Long, t As Long
    Dim lFind As Boolean
    Dim WSheet As Worksheet
    
    On Error Resume Next
    
    If gsNameDetal = "" Then GoTo a2    '' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    
    If ActiveWorkbook.Sheets(gsNameDetal).name = ActiveWorkbook.ActiveSheet.name Then GoTo A1 '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    
'    gfWindowOn = True
    If gfWindowOn Then
    
t2 = Time
'Debug.Print "1 - "; t2

        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        t = 0
        For Each WSheet In ActiveWorkbook.Sheets
            If WSheet.name = gsNameDetal Then
               t = 1
            Else
            End If
        Next
        If t = 0 Then GoTo a2 '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        t = 0
        
        lcNameSh = ActiveWorkbook.ActiveSheet.name
        Application.ScreenUpdating = False
        'Application.Visible = False
       lSaved = Application.ActiveWorkbook.Saved
       
       With Application.ActiveWorkbook.VBProject.VBComponents(gcCodeName).CodeModule
       ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            t = .ProcStartLine("Workbook_WindowActivate", vbext_pk_Proc)
            If t = 0 Then
                .AddFromString ("Private Sub Workbook_WindowActivate(ByVal Wn As Window)")
                t = .ProcStartLine("Workbook_WindowActivate", vbext_pk_Proc)
                .InsertLines t + 1, "If Application.WindowState = xlMinimized Then"
                .InsertLines t + 2, "Application.WindowState = xlNormal"
                .InsertLines t + 3, "End If"
                .InsertLines t + 4, "If Application.ActiveWorkbook.Windows.Count = 1 Then"
                .InsertLines t + 5, "If Application.ActiveWorkbook.Windows.Item(1).Caption = " & Chr(34) & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" & Chr(34) & "Then"
                .InsertLines t + 6, "Application.Quit"
                .InsertLines t + 7, "End If"
                .InsertLines t + 8, "End If"
                .InsertLines t + 9, "If Application.ActiveWorkbook.Windows.Count = 1 Then"
                .InsertLines t + 10, "ActiveWindow.WindowState = xlMaximized"
                .InsertLines t + 11, "gfWindowOn = False"
                .InsertLines t + 12, "End If"
                .InsertLines t + 13, "fVisiblePrint"
                .InsertLines t + 14, "End Sub"
                
                ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
                With Application.ActiveWorkbook.VBProject.VBComponents("mdLib").CodeModule
                     t = .ProcStartLine("CloseWorkbook", vbext_pk_Proc)
                     r = .ProcCountLines("CloseWorkbook", vbext_pk_Proc)
                     For i = t To r + t
                         lFind = .Find("FormSpr.IsUnload = True", i, 1, i, 180)
                         If lFind Then
                            .ReplaceLine i, "'FormSpr.IsUnload = True"
                         End If
                         lFind = .Find("Unload FormSpr", i, 1, i, 180)
                         If lFind Then
                            .ReplaceLine i, "'Unload FormSpr"
                         End If
                     Next
                End With
            End If
            
       ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
            t = .ProcStartLine("Workbook_SheetChange", vbext_pk_Proc)
            r = .ProcCountLines("Workbook_SheetChange", vbext_pk_Proc)
            For i = t To r + t
                lFind = .Find("Private Sub Workbook_SheetChange", i, 1, i, 180)
                If lFind Then
                    lFind = .Find("On Error Resume Next: If gfWindowOn Then Exit Sub", i + 1, 1, i + 1, 180)
                    If Not lFind Then
                        .ReplaceLine i + 1, "On Error Resume Next: If gfWindowOn Then Exit Sub"
                    End If
'                   .ReplaceLine i, "Private Sub Workbook_SheetChange1(ByVal Sh As Object, ByVal Target As Range)"
                   Exit For
                End If
            Next
      End With
      
        '<SPIR>01.02.2014 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        SRow = Selection.Areas.Count
        lnCoutn = 0
        For i = 1 To SRow
            lcName = ""
            If Selection.Areas.Item(i).Cells.Count = 1 Then
                lcName = Selection.Areas.Item(i).name.name
                If Not (lcName = "") And left(lcName, 2) = "ss" Then
                   lcNameCell = lcNameCell + lcName + ","
                   lnCoutn = lnCoutn + 1
                End If
             Else
                SRow1 = Selection.Areas.Item(i).Cells.Rows.Count
                SCol1 = Selection.Areas.Item(i).Cells.Columns.Count
                For j = 1 To SRow1
                    For k = 1 To SCol1
                        lcName = Selection.Areas.Item(i).Cells(j, k).name.name
                        If Not (lcName = "") And left(lcName, 2) = "ss" Then
                           lcNameCell = lcNameCell + lcName + ","
                           lnCoutn = lnCoutn + 1
                        End If
                    Next k
                Next j
             End If
        Next i
        lcNameCell = Mid(lcNameCell, 1, Len(lcNameCell) - 1)
    
t2 = Time
'Debug.Print "2 - "; t2
    
        
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        fInitGrid (lnCoutn + 3)
    
t2 = Time
'Debug.Print "3 - "; t2
    
        
        If Len(lcNameCell) > 0 Then
            goSvod.GetArraySvod lcNameCell
        End If
        
    
t2 = Time
'Debug.Print "4 - "; t2
    
        
'       ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'       With Application.ActiveWorkbook.VBProject.VBComponents("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").CodeModule
'            t = .ProcStartLine("Workbook_SheetChange", vbext_pk_Proc)
'            R = .ProcCountLines("Workbook_SheetChange", vbext_pk_Proc)
'            For i = t To R + t
'                lFind = .Find("Private Sub Workbook_SheetChange1", i, 1, i, 180)
'                If lFind Then
'                   .ReplaceLine i, "Private Sub Workbook_SheetChange(ByVal Sh As Object, ByVal Target As Range)"
'                   Exit For
'                End If
'            Next
'      End With
        
'        Application.ActiveWorkbook.Saved = lSaved
        ActiveWorkbook.Sheets(gsNameDetal).Protect "rassvet"
        Windows.Item("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Activate
        Sheets(gsNameDetal).Select
        ActiveSheet.Cells(1, 1).Select
        ActiveWindow.ScrollRow = 2
        ActiveWindow.ScrollRow = 1
        ActiveWindow.ScrollColumn = 2
        ActiveWindow.ScrollColumn = 1
        ''01122015 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
'        If Windows.Item("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Index = 1 Then
'            k = 2
'        Else
'            k = 1
'        End If
''''''''''
        ''25012016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
'        k = 1
        For j = 1 To Windows.Count
            If Windows.Item(j).Caption & "*" Like left(goSvod.cXltBlank, Len(goSvod.cXltBlank) - 4) & "*" Then
                k = j
                Exit For
            End If
        Next j
 '''''''''''''''
 
        Application.ActiveWorkbook.Saved = lSaved
        Windows.Item(k).Activate
        Application.Sheets(lcNameSh).Activate
        Application.ScreenUpdating = True
        'Application.Visible = True
    
t2 = Time
'Debug.Print "5 - "; t2
        
''        lcNameCell = Application.ActiveCell.name
''        If Len(lcNameCell) > 0 Then
''            lcNameCell = Application.Names(, , CStr(lcNameCell)).name
''
''            UserForm2.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| - " & lcNameCell
''
''            If left(lcNameCell, 2) = "ss" Then
''              goSvod.GetArraySvod lcNameCell
''            End If
''        End If
'
'        UserForm2.Show vbModeless

       fVisiblePrint
       
    End If
     
'     CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|...").Visible = True
     
     Exit Function
a2:
'    MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", , "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
    
    ''<Spir>19.05.2017 |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd|-|fffd||fffd|  |fffd||fffd||fffd||fffd| 2013 |fffd||fffd||fffd| 2016 )
'    MsgBox " |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ", vbOKOnly, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
    
'    If gfWindowOn Then
'        '<SPIR>01.02.2014 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'        SRow = Selection.Areas.Count
'        lnCoutn = 0
'        For i = 1 To SRow
'            lcName = ""
'            If Selection.Areas.Item(i).Cells.Count = 1 Then
'                lcName = Selection.Areas.Item(i).name.name
'                If Not (lcName = "") And left(lcName, 2) = "ss" Then
'                   lcNameCell = lcNameCell + lcName + ","
'                   lnCoutn = lnCoutn + 1
'                End If
'             Else
'                SRow1 = Selection.Areas.Item(i).Cells.Rows.Count
'                SCol1 = Selection.Areas.Item(i).Cells.Columns.Count
'                lcNameSh = ""   ''|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (F074 3-|fffd| |fffd||fffd||fffd||fffd|)
'                For j = 1 To SRow1
'                    For k = 1 To SCol1
'                        lcName = Selection.Areas.Item(i).Cells(j, k).name.name
'                        If Not (lcName = "") And left(lcName, 2) = "ss" And lcNameSh <> lcName Then
'                           lcNameCell = lcNameCell + lcName + ","
'                           lnCoutn = lnCoutn + 1
'                           lcNameSh = lcName
'                        End If
'                    Next k
'                Next j
'             End If
'        Next i
'        lcNameCell = Mid(lcNameCell, 1, Len(lcNameCell) - 1)
'
'        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'        fInitGridOld (lnCoutn + 3)
'
'        If Len(lcNameCell) > 0 Then
'            goSvod.GetArraySvod lcNameCell
'        End If
'
'
'        UserForm2.Show vbModeless
'
''        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
''        fInitGridOld
''
''        lcNameCell = Application.ActiveCell.name
''        If Len(lcNameCell) > 0 Then
''            lcNameCell = Application.Names(, , CStr(lcNameCell)).name
''
''            UserForm2.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| - " & lcNameCell
''
''            If left(lcNameCell, 2) = "ss" Then
''              goSvod.GetArraySvod lcNameCell
''            End If
''        End If
''
''        UserForm2.Show vbModeless
'     End If
    Exit Function
    
A1:
    Exit Function
   
End Function

'Public Function fInitGridOld(pnCount As Integer) As Variant
'
'    With UserForm2.VSFlexGrid1
'        .Clear
'        .Rows = 1
'
'        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'        .FixedRows = 1
'        .AllowUserResizing = 3
'        .ExtendLastCol = True
'        '.OutlineBar = 1
'        .OutlineCol = 0
'        .SubtotalPosition = 1
'        .Cols = pnCount
'
'        .TextMatrix(0, 0) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
''        .TextMatrix(0, 1) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
''        .TextMatrix(0, 2) = "|fffd||fffd||fffd||fffd||fffd||fffd|"
''        .TextMatrix(0, 3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
'
'        .ColAlignment(0) = 1
''        .ColAlignment(1) = 4
''        .ColAlignment(2) = 4
''        .ColAlignment(3) = 1
'
'        .ColWidth(0) = 4800
''        .ColWidth(1) = 1500
''        .ColWidth(2) = 1000
''        .ColWidth(3) = 7000
'     End With
'
''    With UserForm2.VSFlexGrid1
''        .Clear
''        .Rows = 1
''
''        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
''        .FixedRows = 1
''        .AllowUserResizing = 3
''        .ExtendLastCol = True
''        '.OutlineBar = 1
''        .OutlineCol = 0
''        .SubtotalPosition = 1
''        .Cols = 4
''        .TextMatrix(0, 0) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
''        .TextMatrix(0, 1) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
''        .TextMatrix(0, 2) = "|fffd||fffd||fffd||fffd||fffd||fffd|"
''        .TextMatrix(0, 3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
''
''        .ColAlignment(0) = 1
''        .ColAlignment(1) = 4
''        .ColAlignment(2) = 4
''        .ColAlignment(3) = 1
''
''        .ColWidth(0) = 4800
''        .ColWidth(1) = 1500
''        .ColWidth(2) = 1000
''        .ColWidth(3) = 7000
''     End With
'
'End Function
'
'
'
'<SPIR>01.09.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|.Data_NomColumn
'<SPIR>12.02.2014 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Public Function fGetArraySvod(a() As Variant, Optional lcNamePer As String = " ", Optional lcNameOrg As String = " ") As Variant
Dim Result As Variant
Dim i As Long, AddStr As String, j As Long
Dim lcNameCell As String
Dim R1 As Long, r2 As Long
Dim strDecSeparator As String   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Dim blnIfSeparator As Boolean   '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Dim n1 As Long, n2 As Long
Dim lRange As Range, Row As Long, Col As Long
Dim cCaption As String
Dim lFulfillment As Boolean
Dim nRowB As Long, nRowE As Long, nColB As Long, nColE As Long
Dim lIsNomColumn As Boolean ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|. Data_NomColumn
Dim n As Long, sname As String
Dim sActiveSheet As String, sNameRangeNomColumn As String '<SPIR>19.10.2015 |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
Dim lIsKod As Boolean   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| k_org |fffd| |fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim nCol1  As Long  '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim sFStr As String, nLenFStr  As Long    ''

'==============================
   Result = -1
    If Not IsArray(a) Or IsEmpty(a) Then GoTo finally
    
t2 = Time
'Debug.Print "31 - "; t2
    
    
If Not (gsNameDetal = "") Then
    sActiveSheet = Application.ActiveSheet.name '<SPIR>19.10.2015 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    
    '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    On Error Resume Next
    Windows("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Activate
    With ActiveWorkbook.Sheets(gsNameDetal)
        .Activate
        .Columns("A:Z").Select
        'Selection.ClearContents
        Selection.Delete Shift:=xlUp
    
t2 = Time
'Debug.Print "32 |fffd||fffd||fffd||fffd||fffd||fffd||fffd| - "; t2
    
    End With
   
   If Not a(1, 1) = " " Then
        Sheets(gsNameDetal).Select
'        ResizeRange ActiveWorkbook.Application.Range("DataSpravka"), UBound(a, 1) + 2, UBound(a, 2)
                
        On Error Resume Next
        n1 = UBound(a, 2)   ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        n2 = UBound(a, 1)   ''|fffd||fffd||fffd||fffd||fffd||fffd|
'        ReDim gArr(1 To n2 + 1, 1 To n1)
        gcNamePer = lcNamePer
        ''<Spir>22052017 |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| k_org |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        If a(1, 4) = "|fffd||fffd||fffd| |fffd||fffd|" Then
            lIsKod = True
            nColE = n1
            ReDim gArr(1 To n2 + 1, 1 To n1)
            nCol1 = 4
        Else
            lIsKod = False
            nColE = n1 + 1
            ReDim gArr(1 To n2 + 1, 1 To n1 + 1)
            nCol1 = 3
        End If
        sFStr = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd|. - "
        nLenFStr = Len(sFStr)
        
        nRowB = 6
        nRowE = n2
        nColB = 1
'        nColE = n1
        
        With ActiveWorkbook.Application.Cells
            If n1 > 5 Then
                For i = 2 To nColE - 3  ''n1 - 2
                    .Columns(i).NumberFormat = "General"
                Next i
            End If
            
            .Font.Size = 8
            .Columns(nColE - 1).ColumnWidth = 170 '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            For i = LBound(a, 1) + 1 To UBound(a, 1)
                .Cells(i + 2 + 5, 1) = a(i, 1)
                gArr(i, 1) = a(i, 1)
                For j = LBound(a, 2) + nCol1 To UBound(a, 2)
                     .Cells(i + 2 + 5, j - nCol1 + 1) = a(i, j)
                     gArr(i, j) = a(i, j)
                 Next j
                 .Cells(i + 2 + 5, nColE - 2) = a(i, 3)
                 .Cells(i + 2 + 5, nColE - 1) = a(i, 2)
                 gArr(i, 3) = a(i, 3)
                 gArr(i, 2) = a(i, 2)
                If Not lIsKod Then
                    ''<Spir>22052017 |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| k_org |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                    cCaption = Mid(a(i, 2), InStr(1, a(i, 2), sFStr, 1) + nLenFStr, 5)
                    .Cells(i + 2 + 5, nColE) = cCaption
                    gArr(i, 4) = cCaption
                Else
                    .Cells(i + 2 + 5, nColE) = a(i, 4)
                    gArr(i, 4) = a(i, 4)
                End If
             Next i
    
t2 = Time
'Debug.Print "33 |fffd||fffd||fffd||fffd||fffd||fffd| - "; t2
    
            
            ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            cCaption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
            cCaption = goSvod.cRepAlias & " - " & cCaption
            Range("A1") = cCaption
        
            Range("A4") = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
            Range("A3") = "|fffd||fffd||fffd||fffd||fffd||fffd|"
            Range("B4") = Time & "  " & Date
            Range("B3") = Trim(lcNamePer) '' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| 3|fffd||fffd| 2015)
            
            Range("A1:A4").Font.Size = 9
             
            ' |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            .Cells(nRowB + 1, 1).Value = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
            
            .Cells(nRowB, 1).Value = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
            .Cells(nRowB, nColE - 2).Value = "|fffd||fffd||fffd||fffd||fffd||fffd|"
            .Cells(nRowB, nColE - 1).Value = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
            .Cells(nRowB, nColE).Value = "|fffd||fffd||fffd| |fffd||fffd|"
        
            .Cells(nRowB + 2, 1).Value = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
            
            '<SPIR>19.10.2015 |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
            '<SPIR>01.09.2015 |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            lIsNomColumn = False
            If HasName("Data_NomColumn") Then
                If sActiveSheet = Range("Data_NomColumn").Worksheet.name Then
                    lIsNomColumn = True
                    sNameRangeNomColumn = "Data_NomColumn"
                End If
            End If
            ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| 3 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            For j = 1 To 3
                If lIsNomColumn = False Then
                    If HasName("Data_NomColumn" + Trim(str(j))) Then
                        If sActiveSheet = Range("Data_NomColumn" + Trim(str(j))).Worksheet.name Then
                            lIsNomColumn = True
                            sNameRangeNomColumn = "Data_NomColumn" + Trim(str(j))
                        End If
                    End If
                End If
            Next j
'            If HasName("Data_NomColumn") Then
'                lIsNomColumn = True
'            Else
'                lIsNomColumn = False
'            End If
            
            
            lFulfillment = True
            For j = LBound(a, 2) + nCol1 To UBound(a, 2)
            
                '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                If lIsNomColumn Then
                    lIsNomColumn = False '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                    For n = 1 To Range(sNameRangeNomColumn).Columns.Count
                        If Mid(Range(sNameRangeNomColumn).Cells(1, n).AddressLocal, 2, 1) = Mid(Range(a(1, j)).AddressLocal, 2, 1) Then
                            sname = Mid(a(1, j), 3, Len(Trim(a(1, j))) - 3) & ", " & Trim(Range(sNameRangeNomColumn).Cells(1, n).Value)
                            .Cells(nRowB, j - 2).Value = sname
                            .Cells(nRowB + 1, j - 2).Value = Range(a(1, j)).Value
                            gArr(1, j) = sname
                            gArr(n2 + 1, j) = Range(a(1, j)).Value
                            lIsNomColumn = True '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                            Exit For
                        End If
                    Next n
                End If
                If Not lIsNomColumn Then '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|
                    .Cells(nRowB, j - nCol1 + 1).Value = Replace(Range(a(1, j)).AddressLocal, "$", "")
                    .Cells(nRowB + 1, j - nCol1 + 1).Value = Range(a(1, j)).Value
                    gArr(1, j) = Replace(Range(a(1, j)).AddressLocal, "$", "")
                    gArr(n2 + 1, j) = Range(a(1, j)).Value
                End If
                
                ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                If IsNumeric(.Cells(nRowB + 1, j - nCol1 + 1).Value) Then
                  ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|,
                  .Cells(8, j - nCol1 + 1).FormulaLocal = "=|fffd||fffd||fffd||fffd|((" & Replace(.Cells(9, j - nCol1 + 1).Address, "$", "") & ":" & Replace(.Cells(n2 + 8, j - nCol1 + 1).Address, "$", "") & "))"
                    .Rows(7 & ":" & 8).Select
                    If Val(.Cells(8, j - nCol1 + 1).Value) <> Val(.Cells(7, j - nCol1 + 1).Value) Then
                         With Selection.Font
                            .Color = 255
                        End With
                        lFulfillment = False
                    Else
                         With Selection.Font
                            .Color = 0
                        End With
                        lFulfillment = True
                    End If
                    
                   .Columns(j - nCol1 + 1).Select
                   .Columns(j - nCol1 + 1).NumberFormat = "#,##0.00"
                   .Columns(j - nCol1 + 1).ColumnWidth = 15
                   .HorizontalAlignment = xlRight
                Else
                    .Columns(j - nCol1 + 1).Select
                    .Columns(j - nCol1 + 1).NumberFormat = "@"
                    .Columns(j - nCol1 + 1).ColumnWidth = 30
                    .HorizontalAlignment = xlCenter
                End If
                
           Next j
           If lFulfillment Then
              .Rows(nRowB + 2).EntireRow.Hidden = True
           Else
              .Rows(nRowB + 2).EntireRow.Hidden = False
           End If

    
t2 = Time
'Debug.Print "34 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 1 - "; t2
    

            
        '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        .Rows(nRowB).HorizontalAlignment = xlCenter
        .Rows(nRowB).VerticalAlignment = xlCenter
        .Rows(nRowB).Font.Bold = True
        If lIsNomColumn Then
            .Rows(nRowB).Font.Size = 8
'            .Rows(nRowB).RowHeight = 28.8
'            .Rows(nRowB).WrapText = True
'            .Rows(nRowB).ColumnWidth = 30
        Else
            .Rows(nRowB).Font.Size = 9
        End If
        
         .Columns(1).HorizontalAlignment = xlLeft
         .Columns(nColE).HorizontalAlignment = xlRight
         .Cells(nRowB, 1).ColumnWidth = 28 ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
         .Rows(nRowB + 1).Font.Bold = True ''|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
         .Rows(nRowB + 2).Font.Bold = True ''|fffd||fffd||fffd||fffd||fffd|
         .Columns(nColE - 2).HorizontalAlignment = xlCenter ''|fffd||fffd||fffd||fffd||fffd||fffd|
         .Cells(nRowB, nColE - 2).HorizontalAlignment = xlLeft ''|fffd||fffd||fffd||fffd||fffd||fffd|
         .Columns(nColE - 2).ColumnWidth = 8   ''|fffd||fffd||fffd||fffd||fffd||fffd|
         .Columns(nColE - 2).NumberFormat = "@"   ''|fffd||fffd||fffd||fffd||fffd||fffd|
         '.Columns(.Columns.Count).ColumnWidth = 70   '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
         .Columns(nColE - 1).EntireColumn.Hidden = True '' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
         Range("B3").HorizontalAlignment = xlLeft
         .Columns(nColE).HorizontalAlignment = xlCenter ''|fffd||fffd||fffd| |fffd||fffd|
         .Cells(nRowB, nColE).HorizontalAlignment = xlLeft ''|fffd||fffd||fffd| |fffd||fffd|
         .Columns(nColE).ColumnWidth = 8   ''|fffd||fffd||fffd| |fffd||fffd|
         .Columns(nColE).NumberFormat = "@"   ''|fffd||fffd||fffd| |fffd||fffd|
        
t2 = Time
'Debug.Print "34 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 2 - "; t2
    
        Range("A6:" & Replace(.Cells(n2 + 8, nColE).Address, "$", "")).Select
        Selection.Borders(xlDiagonalDown).LineStyle = xlNone
        Selection.Borders(xlDiagonalUp).LineStyle = xlNone
        With Selection.Borders(xlEdgeLeft)
            .LineStyle = xlContinuous
            .ColorIndex = 0
            .TintAndShade = 0
            .Weight = xlThin
        End With
        With Selection.Borders(xlEdgeTop)
            .LineStyle = xlContinuous
            .ColorIndex = 0
            .TintAndShade = 0
            .Weight = xlThin
        End With
        With Selection.Borders(xlEdgeBottom)
            .LineStyle = xlContinuous
            .ColorIndex = 0
            .TintAndShade = 0
            .Weight = xlThin
        End With
        With Selection.Borders(xlEdgeRight)
            .LineStyle = xlContinuous
            .ColorIndex = 0
            .TintAndShade = 0
            .Weight = xlThin
        End With
        With Selection.Borders(xlInsideVertical)
            .LineStyle = xlContinuous
            .ColorIndex = 0
            .TintAndShade = 0
            .Weight = xlThin
        End With
        With Selection.Borders(xlInsideHorizontal)
            .LineStyle = xlContinuous
            .ColorIndex = 0
            .TintAndShade = 0
            .Weight = xlThin
        End With
        Selection.AutoFilter    ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

         Rows("9:" & n2 + 8).WrapText = True
         Rows("9:" & n2 + 8).EntireRow.AutoFit
         
         .Rows(nRowB).WrapText = True
         
        
       End With
    
t2 = Time
'Debug.Print "34 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 3 - "; t2
         
   End If
   Result = 1
'==============================
End If

'If gsNameDetal = "" Then
'    'Ivanov 11/07/2011 ============
'    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'        strDecSeparator = vbGetLocaleInfo(LOCALE_SDECIMAL)
'        If strDecSeparator <> Application.International(3) Then
'            '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'            blnIfSeparator = True
'        Else
'            blnIfSeparator = False
'        End If
'    '=============================
'    Result = -1
'    If Not IsArray(a) Or IsEmpty(a) Then GoTo finally
'
'    If Not a(1, 1) = " " Then
'        With UserForm2.VSFlexGrid1
'            For j = LBound(a, 2) + 3 To UBound(a, 2)
'                .TextMatrix(0, j - 3) = Range(a(1, j)).AddressLocal
'                .ColAlignment(j - 3) = 7
'                .ColWidth(j - 3) = 1600
'                .ColFormat(j - 3) = "#,###.00"
'                .ColDataType(j - 3) = 5
'
'                .ColSort(j - 3) = flexSortGenericAscending
'             Next j
'
'                .ColAlignment(UBound(a, 2) - 2) = 4
'                .ColAlignment(UBound(a, 2) - 1) = 1
'                .ColWidth(UBound(a, 2) - 2) = 1000
'                .ColWidth(UBound(a, 2) - 1) = 7000
'                .TextMatrix(0, UBound(a, 2) - 2) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
'                .TextMatrix(0, UBound(a, 2) - 1) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
'
'         End With
'
'
'        lcNameCell = Application.ActiveCell.name
'        lcNameCell = Application.Names(, , CStr(lcNameCell)).name
'
'
'         If a(1, 3) <> " " Then
'            AddStr = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" & vbTab
'            UserForm2.VSFlexGrid1.AddItem AddStr
'            UserForm2.VSFlexGrid1.Cell(flexcpFontBold, 1, 0) = True
'
'             AddStr = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" & vbTab
'            UserForm2.VSFlexGrid1.AddItem AddStr
'            UserForm2.VSFlexGrid1.Cell(flexcpFontBold, 2, 0) = True
'
'            For i = LBound(a, 1) + 1 To UBound(a, 1)
'                AddStr = a(i, 1)
'                For j = LBound(a, 2) + 3 To UBound(a, 2)
'                    'Ivanov 11/07/2011 ============
'                    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'                    If blnIfSeparator Then
'                        If IsNumeric(Replace(a(i, j), Application.International(3), strDecSeparator, 1, 1, vbBinaryCompare)) Then
'                            a(i, j) = Replace(a(i, j), Application.International(3), strDecSeparator, 1, 1, vbBinaryCompare)
'                        End If
'                    End If
'                    '==============================
'                     AddStr = AddStr & vbTab & a(i, j)
'
'    '                'Ivanov 11/07/2011 ============
'    '                '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'    '                If blnIfSeparator Then
'    '                    If IsNumeric(Replace(a(i, 3), Application.International(3), strDecSeparator, 1, 1, vbBinaryCompare)) Then
'    '                        a(i, 3) = Replace(a(i, 3), Application.International(3), strDecSeparator, 1, 1, vbBinaryCompare)
'    '                    End If
'    '                End If
'    '                '==============================
'    '                 AddStr = a(i, 1) & vbTab & a(i, 3) & vbTab & a(i, 4) & vbTab & a(i, 2) & vbTab
'                 Next j
'                 AddStr = AddStr & vbTab & a(i, 3) & vbTab & a(i, 2) & vbTab
'                 UserForm2.VSFlexGrid1.AddItem AddStr
'             Next i
'
'             R1 = UserForm2.VSFlexGrid1.FixedRows + UserForm2.VSFlexGrid1.FrozenRows
'             r2 = UserForm2.VSFlexGrid1.Rows - 1
'             For j = LBound(a, 2) + 3 To UBound(a, 2)
'                UserForm2.VSFlexGrid1.TextMatrix(2, j - 3) = UserForm2.VSFlexGrid1.Aggregate(flexSTSum, R1, j - 3, r2, j - 3)
''                UserForm2.VSFlexGrid1.TextMatrix(1, j - 3) = UserForm2.VSFlexGrid1.Aggregate(flexSTSum, R1, j - 3, r2, j - 3)
'                lcNameCell = UserForm2.VSFlexGrid1.TextMatrix(0, j - 3)
'                UserForm2.VSFlexGrid1.TextMatrix(1, j - 3) = Val(Application.Range(lcNameCell).Value)
''                UserForm2.VSFlexGrid1.TextMatrix(2, j - 3) = Val(Application.Range(lcNameCell).Value)
'                UserForm2.VSFlexGrid1.Cell(flexcpFontBold, 1, j - 3) = True
'                UserForm2.VSFlexGrid1.Cell(flexcpFontBold, 2, j - 3) = True
'                If Val(UserForm2.VSFlexGrid1.TextMatrix(1, j - 3)) <> Val(Application.Range(lcNameCell).Value) Then
'                    UserForm2.VSFlexGrid1.Cell(flexcpBackColor, 1, j - 3) = vbRed
'                    UserForm2.VSFlexGrid1.Cell(flexcpBackColor, 2, j - 3) = vbRed
'                End If
'             Next j
'
'             UserForm2.VSFlexGrid1.Sort = flexSortUseColSort
'             UserForm2.VSFlexGrid1.FrozenRows = 1
'             UserForm2.VSFlexGrid1.FrozenRows = 2
'
'             UserForm2.Label2.Caption = lcNamePer
'             UserForm2.Label3.Caption = lcNameOrg
'
'    '         UserForm2.VSFlexGrid1.TextMatrix(1, 2) = UserForm2.VSFlexGrid1.Aggregate(flexSTSum, r1, 2, r2, 2)
'
'             'UserForm2.Caption = UserForm2.Caption & " (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| S)"
'
'
'    '  var2
'    '         UserForm2.VSFlexGrid1.Subtotal flexSTClear
'    '         UserForm2.VSFlexGrid1.Subtotal flexSTSum, -1, 1, , , , True, "|fffd||fffd||fffd||fffd||fffd|"
'    '         UserForm2.VSFlexGrid1.Subtotal flexSTSum, -1, 2, , vbCyan, , , "|fffd||fffd||fffd||fffd||fffd|"
'    '         If Application.ActiveCell.Value <> CCur(UserForm2.VSFlexGrid1.TextMatrix(1, 1)) Then
'    '             UserForm2.VSFlexGrid1.Subtotal flexSTClear
'    '             UserForm2.VSFlexGrid1.Subtotal flexSTSum, -1, 1, , vbCyan, vbRed, True, "|fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)"
'    ''            Else
'    ''                UserForm2.VSFlexGrid1.Subtotal flexSTSum, -1, 1, , , , , "|fffd||fffd||fffd||fffd||fffd|"
'    '         End If
'
'
'    '  var1
'    '            UserForm2.VSFlexGrid1.Subtotal flexSTSum, -1, 1 ', , vbBlue, vbWhite, , "|fffd||fffd||fffd||fffd||fffd|"
'    '
'    '            If Application.ActiveCell.Value <> Val(UserForm2.VSFlexGrid1.TextMatrix(1, 1)) Then
'    '                UserForm2.Label1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - " & _
'    '                    Application.ActiveCell.Value & " # " & Val(UserForm2.VSFlexGrid1.TextMatrix(1, 1))
'    '            Else
'    '                UserForm2.Label1.Caption = ""
'    '            End If
'    '            UserForm2.VSFlexGrid1.Subtotal flexSTClear
'            Result = 1
'        End If
'    End If
'
'
''    Result = -1
''    If Not IsArray(a) Or IsEmpty(a) Then GoTo finally
''
''
''    lcNameCell = Application.ActiveCell.name
''    lcNameCell = Application.Names(, , CStr(lcNameCell)).name
''
''
''     If a(1, 3) <> " " Then
''         For i = LBound(a) + 1 To UBound(a)
''            'Ivanov 11/07/2011 ============
''            '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
''            If blnIfSeparator Then
''                If IsNumeric(Replace(a(i, 3), Application.International(3), strDecSeparator, 1, 1, vbBinaryCompare)) Then
''                    a(i, 3) = Replace(a(i, 3), Application.International(3), strDecSeparator, 1, 1, vbBinaryCompare)
''                End If
''            End If
''            '==============================
''             AddStr = a(i, 1) & vbTab & a(i, 3) & vbTab & a(i, 4) & vbTab & a(i, 2) & vbTab
''             UserForm2.VSFlexGrid1.AddItem AddStr
''         Next
''
''         'UserForm2.Caption = UserForm2.Caption & " (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| S)"
''
''         UserForm2.VSFlexGrid1.Subtotal flexSTClear
''         UserForm2.VSFlexGrid1.Subtotal flexSTSum, -1, 1, , vbCyan, , , "|fffd||fffd||fffd||fffd||fffd|"
'''  var2
''         If Application.ActiveCell.Value <> CCur(UserForm2.VSFlexGrid1.TextMatrix(1, 1)) Then
''             UserForm2.VSFlexGrid1.Subtotal flexSTClear
''             UserForm2.VSFlexGrid1.Subtotal flexSTSum, -1, 1, , vbCyan, vbRed, True, "|fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)"
'''            Else
'''                UserForm2.VSFlexGrid1.Subtotal flexSTSum, -1, 1, , , , , "|fffd||fffd||fffd||fffd||fffd|"
''         End If
''
''        Result = 1
''    End If
'End If

finally:
fGetArraySvod = Result

End Function







Public Function fInitGrid(pnCount As Long) As Variant

Dim cName As String
Dim oWindow As Window

    On Error GoTo errHandler

    ActiveWorkbook.Unprotect "rassvet"
    gfWindowOn = False
    
    Set oWindow = ActiveWindow
    cName = ActiveWindow.ActiveSheet.name
    
    If ActiveWorkbook.Sheets(gsNameDetal).Visible = 0 Then
        ActiveWorkbook.Sheets(gsNameDetal).Visible = True
        ActiveWorkbook.Sheets(gsNameDetal).Activate
    End If
    ActiveWorkbook.Sheets(gsNameDetal).Unprotect "rassvet"
    
    If Application.Windows.Count = 1 Then
       '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
        ActiveWindow.NewWindow
        ActiveWindow.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
        oWindow.Activate
        Sheets(cName).Select
        
        Windows.SyncScrollingSideBySide = False '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        Windows.Arrange ArrangeStyle:=xlTiled   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        
'        Windows.CompareSideBySideWith "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
        
        Windows("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Activate
        
'        With ActiveSheet.PageSetup
'            .PrintTitleRows = ""
'            .PrintTitleColumns = ""
'        End With
'        ActiveSheet.PageSetup.PrintArea = ""
        With ActiveSheet.PageSetup
'            .LeftHeader = ""
'            .CenterHeader = ""
'            .RightHeader = ""
'            .LeftFooter = ""
''            .CenterFooter = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| &P |fffd||fffd| &N"
'            .RightFooter = ""
            .LeftMargin = Application.InchesToPoints(0.7)
            .RightMargin = Application.InchesToPoints(0.7)
            .TopMargin = Application.InchesToPoints(0.75)
            .BottomMargin = Application.InchesToPoints(0.75)
            .HeaderMargin = Application.InchesToPoints(0.3)
            .FooterMargin = Application.InchesToPoints(0.3)
'            .PrintHeadings = False
'            .PrintGridlines = False
'            .PrintComments = xlPrintNoComments
''            .PrintQuality = 1200
'            .CenterHorizontally = False
'            .CenterVertically = False
'            .Orientation = xlPortrait
'            .Draft = False
''            .PaperSize = xlPaperA4
'            .FirstPageNumber = xlAutomatic
'            .Order = xlDownThenOver
'            .BlackAndWhite = False
'            .Zoom = 100
'            .PrintErrors = xlPrintErrorsDisplayed
'            .OddAndEvenPagesHeaderFooter = False
'            .DifferentFirstPageHeaderFooter = False
'            .ScaleWithDocHeaderFooter = True
'            .AlignMarginsHeaderFooter = False
'            .EvenPage.LeftHeader.Text = ""
'            .EvenPage.CenterHeader.Text = ""
'            .EvenPage.RightHeader.Text = ""
'            .EvenPage.LeftFooter.Text = ""
'            .EvenPage.CenterFooter.Text = ""
'            .EvenPage.RightFooter.Text = ""
'            .FirstPage.LeftHeader.Text = ""
'            .FirstPage.CenterHeader.Text = ""
'            .FirstPage.RightHeader.Text = ""
'            .FirstPage.LeftFooter.Text = ""
'            .FirstPage.CenterFooter.Text = ""
'            .FirstPage.RightFooter.Text = ""
        End With
'        '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'        Windows("Detal").Activate
'        Sheets.Add After:=Sheets(Sheets.Count)
'        Sheets.Item(Sheets.Count).name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
'
'        ActiveSheet.Range("A6:B7").Select
'        ActiveWorkbook.Names.Add name:="DataSpravka", RefersToR1C1:="=" & ActiveSheet.name & "!R6C1:R7C2"
   End If
    
    ActiveWorkbook.Protect "rassvet"
    gfWindowOn = True


'    With UserForm2.VSFlexGrid1
'        .Clear
'        .Rows = 1
'
'        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'        .FixedRows = 1
'        .AllowUserResizing = 3
'        .ExtendLastCol = True
'        '.OutlineBar = 1
'        .OutlineCol = 0
'        .SubtotalPosition = 1
'        .Cols = pnCount
'
'        .TextMatrix(0, 0) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
''        .TextMatrix(0, 1) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
''        .TextMatrix(0, 2) = "|fffd||fffd||fffd||fffd||fffd||fffd|"
''        .TextMatrix(0, 3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
'
'        .ColAlignment(0) = 1
''        .ColAlignment(1) = 4
''        .ColAlignment(2) = 4
''        .ColAlignment(3) = 1
'
'        .ColWidth(0) = 4800
''        .ColWidth(1) = 1500
''        .ColWidth(2) = 1000
''        .ColWidth(3) = 7000
'     End With

    Exit Function
    
errHandler:
    MsgBox err.Number & " - " & err.Description & ". (fInitGrid)"
    Resume Next

End Function

Public Function ShowDetalSvod() As Variant

    Dim cCaption As String
    Dim hl As Long, tr&, lc&, rd As Long
    Dim nW0, nW1, nW2, nW3 As Long
    Dim XLTSheet As Object, WBook As String
    Dim i  As Long, j  As Long

'    WBook = ThisWorkbook.Path & "\spr_org.XLT"
'    Set XLTSheet = CreateObject("Excel.Application")
'    XLTSheet.ScreenUpdating = False
'    XLTSheet.Workbooks.Open WBook
''    WBook = ThisWorkbook.Path & "\spr_sv.XLT"
''    Set XLTSheet = CreateObject("Excel.Application")
''    XLTSheet.ScreenUpdating = False
''    XLTSheet.Workbooks.Open WBook
'
'    '
'    ResizeRange XLTSheet.Range("DataSpravka"), UserForm2.VSFlexGrid1.Rows, UserForm2.VSFlexGrid1.Columns
'
''    cCaption = Mid(UserForm2.Caption, InStr(1, UserForm2.Caption, "ss"))
''    cCaption = goSvod.cRepAlias & " - " & cCaption
''    XLTSheet.Range("Name_Spr") = cCaption
''
''    XLTSheet.Range("B4") = Time & Date
'
'    XLTSheet.ScreenUpdating = True
'    XLTSheet.Visible = True
'
''    For i = 1 To UserForm2.VSFlexGrid1.Rows
''        XLTSheet.Range("DataSpravka").Cells(i, 3).EntireRow.Insert Shift:=xlShiftDown
''    Next
'    For i = 1 To UserForm2.VSFlexGrid1.Rows
'        For j = 1 To UserForm2.VSFlexGrid1.Columns
'            XLTSheet.Range("DataSpravka").Cells(i, j) = UserForm2.VSFlexGrid1.TextMatrix(i - 1, j - 1)
'
''            XLTSheet.Range("DataSpravka").Cells(i, 1) = UserForm2.VSFlexGrid1.TextMatrix(i - 1, 0)
''            XLTSheet.Range("DataSpravka").Cells(i, 2) = UserForm2.VSFlexGrid1.TextMatrix(i - 1, 1)
''            XLTSheet.Range("DataSpravka").Cells(i, 3) = UserForm2.VSFlexGrid1.TextMatrix(i - 1, 2)
''            XLTSheet.Range("DataSpravka").Cells(i, 4) = UserForm2.VSFlexGrid1.TextMatrix(i - 1, 3)
'        Next j
'   Next i
'
'
End Function

'' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function ResizeRange(tRange As Range, MaxRow As Long, MaxColumn As Long) As Variant
    Dim CountColumns As Long
    Dim CountRows As Long
    Dim l As Long
    Dim m As Long
    
    CountColumns = tRange.Columns.Count
    CountRows = tRange.Rows.Count
    ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    For l = CountColumns To MaxColumn - 1
        tRange.Cells(CountRows, l).EntireColumn.Insert
        If l = CountColumns Then
            For m = 1 To CountRows
                tRange.Cells(m, l) = tRange.Cells(m, l + 1)
                tRange.Cells(m, l + 1) = ""
            Next m
        End If
    Next l
    CountColumns = MaxColumn
    ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    For l = CountRows To MaxRow - 1
        tRange.Cells(l, CountColumns).EntireRow.Insert
        If l = CountRows Then
            For m = 1 To CountColumns
                tRange.Cells(CountRows, m) = tRange.Cells(CountRows + 1, m)
                tRange.Cells(CountRows + 1, m) = ""
            Next m
        End If
    Next l
  

''    ActiveWorkbook.Sheets(gsNameDetal).Unprotect "rassvet"
'    CountColumns = tRange.Columns.Count
'    CountRows = tRange.Rows.Count
'    ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'    For l = CountColumns To MaxColumn - 1
'        tRange.Cells(CountRows, l).EntireColumn.Insert
''        If l = CountColumns Then
''            For m = 1 To CountRows
''                tRange.Cells(m, l) = tRange.Cells(m, l + 1)
''                tRange.Cells(m, l + 1) = ""
''            Next m
''        End If
'    Next l
'    CountColumns = MaxColumn
'    ''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'    For l = CountRows To MaxRow - 1
'        tRange.Cells(l, CountColumns).EntireRow.Insert
''        If l = CountRows Then
''            For m = 1 To CountColumns
''                tRange.Cells(CountRows, m) = tRange.Cells(CountRows + 1, m)
''                tRange.Cells(CountRows + 1, m) = ""
''            Next m
''        End If
'    Next l
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd|)
Public Sub SetDataForShablon(ByRef arrData() As Variant)
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    '11.03.2015 Ivanov |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| bFlagTransDataToSheet (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|)
    '22/05/2017 ivanov |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Range(CStr(arrData(i, 1))).Value = arrData(i, 2) |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| arrData(i, 2) |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    
    Dim i As Long
    
    On Error Resume Next
    
    fUnProtect True
    If IsArray(arrData) Then
        If Not bFlagTransDataToSheet Then
            For i = LBound(arrData, 1) To UBound(arrData, 1)
                Range(CStr(arrData(i, 1))).Value = CStr(arrData(i, 2))
            Next
        Else
            ActiveWorkbook.SetTransDataToSheet arrData
        End If
    End If
    fUnProtect False
End Sub

Attribute VB_Name = "modF074_179"
'
' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 074 |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|179
' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini-|fffd||fffd||fffd||fffd||fffd| -   idForm=14_179
' |fffd||fffd||fffd| 17.01.2011
'
Option Explicit
Public sSelectRange As String
Dim db As Database
Dim rs As Recordset
Dim FlReneme  As Long

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (mod074)*
Public Sub InsertColumn_179()

UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"

'AddFormarekvizit "Data_RCH"
AddFormarekvizit gcNameAddRd '13.01.2011
 
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|(mod074)*
Public Sub RenameColumn_179()
Dim r As Range, sKod$

Set r = Selection
sKod = r.Cells(1, 1).Value
sKod = sReplace(sKod, " ", "")
sKod = sReplace(sKod, "'", "")
If Len(sKod) = 0 Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
If HasInSpr(sKod, "Data_RCHGr") Then MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
'If HasInSpr(sKod, "Data_RCH") = False Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
If HasInSpr(sKod, gcNameAddRd) = False Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub '13.01.2011

UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
'AddFormarekvizit "Data_RCH"2
AddFormarekvizit gcNameAddRd '13.01.2011

End Sub


'-------------------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|(mod074)*
Public Function AddColumnList_179(sKod() As String) As String
Dim r As Range, i As Long, Rv As Range, Rds As Range, Rds4 As Range, j As Long, sp$, sAd$
Dim sAdrv$, sAdds$, sAdds4$ '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'    On Error Resume Next
''''13.01.2011 4 |fffd||fffd||fffd||fffd||fffd||fffd| 3
For j = 1 To 4
    sp = Trim$(str(j))
    Set Rv = Range("Data_" & sp & "3v")
    Rv.Columns.EntireColumn.Hidden = False
    For i = LBound(sKod) To UBound(sKod)
        If Len(sKod(i)) = 0 Then GoTo a2
        Set r = Range("Data_" & sp & "1v").Cells(1, 1)
        If IsEmpty(r.Value) Or Len(r.Value) = 0 Then Set Rds = Range("Data_" & sp & "1"): Set Rds4 = Range("Data_41"): GoTo A1
        Set r = Range("Data_" & sp & "2v").Cells(1, 1)
        If IsEmpty(r.Value) Or Len(r.Value) = 0 Then Set Rds = Range("Data_" & sp & "2"): Set Rds4 = Range("Data_42"): GoTo A1
        
        sAdrv = "='" & Rv.Worksheet.name & "'!" & Rv.Cells.Address
        sAdds = "='" & Rv.Worksheet.name & "'!" & Range("Data_" & sp & "3").Address
        If j = 3 Then sAdds4 = "='" & Rv.Worksheet.name & "'!" & Range("Data_43").Address
        Rv.Copy
        Rv.Insert Shift:=xlToRight
        Application.CutCopyMode = False
        Set Rds = Range(sAdds)
        If j = 3 Then Set Rds4 = Range(sAdds4)
        Set r = Range(sAdrv).Cells(1, 1)
A1:
        r.Value = FormatKod(sKod(i))
        sAd = "='" & r.Worksheet.name & "'!" & r.Address
        ActiveWorkbook.Names.Add name:="rr" & sp & sKod(i), RefersTo:=sAd
        insertName sKod(i), Rds, "Kod" & sp, False
        ''''13.01.2011
'        If j = 3 Then
'            insertName sKod(i), Rds4, "Kod4", False
'        End If
        ''''13.01.2011
a2:
    Next i
    fMerge_179 Rv.Worksheet
    Rv.Columns.EntireColumn.Hidden = True
Next j
AddNN_179
If UBound(sKod) = 0 Then sSelectRange = "rr1" & sKod(0)
Set Rds = Nothing
Set Rv = Nothing
Set r = Nothing
End Function


'-------------------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|(mod074)*
'<Spir>10.01.2016 |fffd||fffd||fffd| |fffd||fffd| 01012017  idForm=14R_OKTMO |fffd| Len_CS = 10
'-------------------------------------
Public Function AddColumnList_179_CS10(sKod() As String) As String
Dim r As Range, i As Long, Rv As Range, Rds As Range, Rds4 As Range, j As Long, sp$, sAd$
Dim sAdrv$, sAdds$, sAdds4$ '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'    On Error Resume Next
For j = 1 To 7
    sp = Trim$(str(j))
    Set Rv = Range("Data_" & sp & "3v")
    Rv.Columns.EntireColumn.Hidden = False
    For i = LBound(sKod) To UBound(sKod)
        If Len(sKod(i)) = 0 Then GoTo a2
        Set r = Range("Data_" & sp & "1v").Cells(1, 1)
        If IsEmpty(r.Value) Or Len(r.Value) = 0 Then Set Rds = Range("Data_" & sp & "1"): Set Rds4 = Range("Data_41"): GoTo A1
        Set r = Range("Data_" & sp & "2v").Cells(1, 1)
        If IsEmpty(r.Value) Or Len(r.Value) = 0 Then Set Rds = Range("Data_" & sp & "2"): Set Rds4 = Range("Data_42"): GoTo A1
        
        sAdrv = "='" & Rv.Worksheet.name & "'!" & Rv.Cells.Address
        sAdds = "='" & Rv.Worksheet.name & "'!" & Range("Data_" & sp & "3").Address
'        If j = 3 Then sAdds4 = "='" & Rv.Worksheet.name & "'!" & Range("Data_43").Address
        Rv.Copy
        Rv.Insert Shift:=xlToRight
        Application.CutCopyMode = False
        Set Rds = Range(sAdds)
'        If j = 3 Then Set Rds4 = Range(sAdds4)
        Set r = Range(sAdrv).Cells(1, 1)
A1:
        r.Value = FormatKod(sKod(i))
        sAd = "='" & r.Worksheet.name & "'!" & r.Address
        ActiveWorkbook.Names.Add name:="rr" & sp & sKod(i), RefersTo:=sAd
        insertName sKod(i), Rds, "Kod" & sp, False
a2:
    Next i
    fMerge_179_CS10 Rv.Worksheet, sp
    Rv.Columns.EntireColumn.Hidden = True
Next j
AddNN_179
If UBound(sKod) = 0 Then sSelectRange = "rr1" & sKod(0)
Set Rds = Nothing
Set Rv = Nothing
Set r = Nothing
End Function


'----------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(mod074)*
Public Sub fGroupAdd_179()
Dim mKodGr() As String, mKod() As String, i As Long, Org$, sKodRrimary$, j As Long, sKodGr$

If MsgBox("|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|?", 4 + 256, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|") = 7 Then Exit Sub
UnProtectBook
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
mKod() = ReturnKods_179(False)
'If UBound(mKod) = 0 And mKod(0) = "False" Then MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Sub
    
Range("Data_13v").Columns.EntireColumn.Hidden = False
Range("Data_23v").Columns.EntireColumn.Hidden = False
Range("Data_33v").Columns.EntireColumn.Hidden = False
Range("Data_43v").Columns.EntireColumn.Hidden = False   '13.01.2011

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
For i = 0 To UBound(mKod)
    sKodRrimary = mKod(i)
    Org = Mid$(sKodRrimary, 20, 4)
    mKodGr() = fKodsGr_179(left(sKodRrimary, 19))
    For j = 0 To UBound(mKodGr)
'            sKodGr = KodGr(j)
            sKodGr = mKodGr(j) & Org
            If Len(sKodGr) > 0 And Not HasName("rg1" & sKodGr) Then AddGRColumn_179 sKodRrimary, sKodGr
            sKodRrimary = sKodGr
    Next j
Next i
AddNN_179
CleareFormuls
InsertFormuls
Range("Data_13v").Columns.EntireColumn.Hidden = True
Range("Data_23v").Columns.EntireColumn.Hidden = True
Range("Data_33v").Columns.EntireColumn.Hidden = True
Range("Data_43v").Columns.EntireColumn.Hidden = True      '13.01.2011
ProtectBook
End Sub
'-------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|(mod074)*
Public Sub AddGRColumn_179(ByVal sKodRrimary$, ByVal sKodGr$)
Dim sNamePrimary$, sGrName$, j As Long, sp$
Dim Rv As Range, r As Range, Rpr As Range
Dim sAdrDS$, Rds As Range, w As Worksheet, sAd$

For j = 1 To 4  '13.01.2011
'For j = 1 To 3
    sp = Trim$(str(j))
    sNamePrimary = "rr" & sp & sKodRrimary
    If Not HasName(sNamePrimary) Then sNamePrimary = "rg" & sp & sKodRrimary
    Set Rpr = Range(sNamePrimary)
    sGrName = "rg" & sp & sKodGr
    Set Rv = Range("Data_" & sp & "3v")
    Set w = Rv.Worksheet
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set r = Range(w.Cells(Rv.Row, Rpr.Column), w.Cells(Rv.Row + Rv.Rows.Count - 1, Rpr.Column + Rv.Columns.Count - 1))
    sAdrDS = "='" & Rv.Worksheet.name & "'!" & r.Address
    Rv.Copy
    r.Insert Shift:=xlToRight
    Set r = Range(sAdrDS)
'    If j <> 3 Then R.ColumnWidth = 12.86 Else R.ColumnWidth = 14.29
    r.Cells(1, 1) = FormatKod(sKodGr)
        sAd = "='" & r.Worksheet.name & "'!" & r.Cells(1, 1).Address
        ActiveWorkbook.Names.Add name:=sGrName, RefersTo:=sAd
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| ~ Data_11
Set Rds = Range(w.Cells(Range("Kod" & sp).Row, r.Column), w.Cells(Rv.Row + Rv.Rows.Count - 1, r.Column + r.Columns.Count - 1))
Rds.Interior.ColorIndex = xlNone
Rds.Locked = True
insertName sKodGr, Rds, "Kod" & sp, True

'13.01.2011
'If j = 3 Then
'    Set Rds = W.Range(W.Cells(Range("Kod4").Row, r.Column), W.Cells(Range("Kod4").Row + Range("Kod4").Rows.Count - 1, r.Column + r.Columns.Count - 1))
'    insertName sKodGr, Rds, "Kod4", True
'    Rds.Interior.ColorIndex = xlNone
'    Rds.Locked = True
'End If
'13.01.2011

fMerge_179 Rv.Worksheet
Next j
Set r = Nothing
Set Rpr = Nothing
Set Rv = Nothing
Set Rds = Nothing
Set w = Nothing
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (mod074_2)*
'False - |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  True |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function ReturnKods_179(flGroup As Boolean) As String()
Dim mKod() As String, Rv As Range, w As Worksheet, rowKod As Long, sKod$, j As Long, i As Long, Org$

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Set Rv = Range("Data_13v")
'rowKod = Rv.Cells(1, 1).row
rowKod = Rv.Row
ReDim mKod(0 To (Rv.Column - Range("Kod1").Column) \ 2)
For i = Range("Kod1").Column + 3 To Rv.Column - 1
    Org = ""
    sKod = w.Cells(rowKod, i)
    If Len(sKod) = 0 Then GoTo A1
    sKod = sReplace(sKod, "'", "")
    sKod = sReplace(sKod, vbLf, "")
    If Len(sKod) > 19 Then
        Org = Mid$(sKod, 20, 4)
        sKod = left(sKod, 19)
    End If
    If Len(sKod) > 0 Then
'        If flGroup = False And HasInSpr(sKod, "Data_RCH") = True Then
        If flGroup = False And HasInSpr(sKod, gcNameAddRd) = True Then '13.01.2011
           mKod(j) = IIf(Len(Org) = 0, sKod, sKod & Org)
            j = j + 1
        End If
        If flGroup = True And HasInSpr(sKod, "Data_RCHGr") = True Then
            mKod(j) = sKod
            j = j + 1
        End If
    End If
A1:
Next i
If j = 0 Then j = 1: mKod(0) = "False"
ReDim Preserve mKod(0 To j - 1)
Set Rv = Nothing
Set w = Nothing
ReturnKods_179 = mKod()
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| (mod074_2)*
Public Function fKodsGr_179(sKod As String) As String()
Dim mKodGr() As String, r As Range, i As Long, sGrStr$, k As Long, s$
ReDim mKodGr(0 To 15)
fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index

'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd||fffd| Parent
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd|
'Set r = Range("Data_RCH")
Set r = Range(gcNameAddRd) '13.01.2011

r.Sort Key1:=r.Cells(1, 1), Order1:=xlAscending
For i = 1 To r.Rows.Count
    If r.Cells(i, 1) = sKod Then
        If Len(r.Cells(i, 2)) > 0 Then sGrStr = r.Cells(i, 3): GoTo A1
    End If
Next i
A1:
If Len(sGrStr) = 0 Then GoTo a2
Set r = Range("Data_RCHGr")
r.Sort Key1:=r.Cells(1, 1), Order1:=xlAscending
While Len(sGrStr) > 0
    For i = 1 To r.Rows.Count
        s = r.Cells(i, 1)
        If Right$(s, 5) = sGrStr Then
            mKodGr(k) = s
            k = k + 1
            sGrStr = r.Cells(i, 3)
            GoTo A3
        End If
    Next i
    sGrStr = ""
A3:
Wend
a2:
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "" |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
ReDim Preserve mKodGr(0 To k)
'If k = 0 Then k = 1
'ReDim Preserve mKodGr(0 To k - 1)
Set r = Nothing
fKodsGr_179 = mKodGr()
End Function

' (mod074_2)*
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| "|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
Public Sub fMerge_179(w As Worksheet, Optional ByVal Col1 As Long = 0, Optional ByVal Col2 As Long = 0)
Dim Row As Long, sAd$, r As Range, Col3 As Long, iw As Single, Rv As Range
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge1").Row
    Set Rv = Range("Data_13v")
    If Col1 = 0 Then Col1 = Range("Data_Kods1").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge2").Row
    Set Rv = Range("Data_23v")
    If Col1 = 0 Then Col1 = Range("Data_Kods2").Cells(1, 4).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 3
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge3").Row
    Set Rv = Range("Data_33v")
    If Col1 = 0 Then Col1 = Range("Data_Kods3").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    'iw = 14.89
    iw = 12.89  '13.01.2011
End If
'13.01.2011
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge4").Row
    Set Rv = Range("Data_43v")
    If Col1 = 0 Then Col1 = Range("Data_Kods4").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
'13.01.2011
sAd = "='" & w.name & "'!" & Range(Cells(Row, Col1), Cells(Row, Col2)).Address
Set r = Range(sAd)
r.UnMerge
r.Merge
r.ColumnWidth = iw
r.Borders(xlEdgeTop).LineStyle = xlContinuous
Rv.Columns.EntireColumn.Hidden = True

sAd = "='" & w.name & "'!" & Range(Cells(Row, Col3), Cells(Row, 90)).Address
Set r = Range(sAd)
r.Borders(xlEdgeBottom).LineStyle = xlNone
r.Borders(xlEdgeTop).LineStyle = xlNone
Set r = Nothing
Set Rv = Nothing
End Sub

' (mod074_2)*
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| "|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
'<Spir>10.01.2016 |fffd||fffd||fffd| |fffd||fffd| 01012017  idForm=14R_OKTMO |fffd| Len_CS = 10
'-------------------------------------
Public Sub fMerge_179_CS10(w As Worksheet, NomRange As String, Optional ByVal Col1 As Long = 0, Optional ByVal Col2 As Long = 0)
Dim Row As Long, sAd$, r As Range, Col3 As Long, iw As Single, Rv As Range
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge1").Row
    Set Rv = Range("Data_13v")
    If Col1 = 0 Then Col1 = Range("Data_Kods1").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge2").Row
    Set Rv = Range("Data_23v")
    If Col1 = 0 Then Col1 = Range("Data_Kods2").Cells(1, 4).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 3
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge3").Row
    Set Rv = Range("Data_33v")
    If Col1 = 0 Then Col1 = Range("Data_Kods3").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.89
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-4,5" Then
    Row = Range("Data_Merge" & NomRange).Row
    Set Rv = Range("Data_" & NomRange & "3v")
    If Col1 = 0 Then Col1 = Range("Data_Kods" & NomRange).Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
sAd = "='" & w.name & "'!" & Range(Cells(Row, Col1), Cells(Row, Col2)).Address
Set r = Range(sAd)
r.UnMerge
r.Merge
r.ColumnWidth = iw
r.Borders(xlEdgeTop).LineStyle = xlContinuous
Rv.Columns.EntireColumn.Hidden = True

sAd = "='" & w.name & "'!" & Range(Cells(Row, Col3), Cells(Row, 90)).Address
Set r = Range(sAd)
r.Borders(xlEdgeBottom).LineStyle = xlNone
r.Borders(xlEdgeTop).LineStyle = xlNone
Set r = Nothing
Set Rv = Nothing
End Sub


' (modF074new)*
Public Sub DeleteColumn_179()
Dim n As name, r As Range, sp$, Rv As Range, sAd$, j As Long, sKod$, Rds As Range, w As Worksheet, sname$, s$
For Each n In ActiveWorkbook.Names
    sname = n.name
    If n.name Like "rg*" Then MsgBox "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
Next

Set r = Selection
sKod = r.Cells(1, 1).Value
sKod = sReplace(sKod, "'", "")
sKod = sReplace(sKod, " ", "")
'If Len(sKod) = 0 Or Not HasInSpr(sKod, "Data_RCH") Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
If Len(sKod) = 0 Or Not HasInSpr(sKod, gcNameAddRd) Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub  '13.01.2011
If MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| " & sKod & " ?", 4 + 256, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|") = 7 Then Exit Sub
UnProtectBook
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| c |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
If DelName11(sKod) Then GoTo a2
DelNamesss sKod
For j = 1 To 4  '13.01.2011
'For j = 1 To 3
    sp = Trim$(str(j))
    s = "rr" & sp & sKod
    Set r = Range(s)
    Set w = r.Worksheet
    Set Rv = Range("Data_" & sp & "1v")
    sAd = "='" & r.Worksheet.name & "'!" & Range(Cells(Rv.Row, r.Column), Cells(Rv.Row + Rv.Rows.Count - 1, r.Column + Rv.Columns.Count - 1)).Address
    Set Rv = Range(sAd)
    
    If DelName2_179(Rv, sp) Then GoTo A1
    If DelName1_179(Rv, sp) Then GoTo A1

    
'    If Rv.Column > Range("Data_" & sp & "2v").Column Then
        Rv.Delete Shift:=xlToLeft
        Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
        
A1:
'    Else
'        R.Value = ""
'        Set Rds = Range("Data_" & sp & "1")
'        sAd = "='" & R.Worksheet.Name & "'!" & Range(Cells(Rds.row, R.Column), Cells(Rds.row + Rds.Rows.Count - 1, R.Column + Rds.Columns.Count - 1)).Address
'        fCleareRange Range(sAd)
'        If j = 3 Then
'            Set Rds = Range("Data_41")
'            sAd = "='" & R.Worksheet.Name & "'!" & Range(Cells(Rds.row, R.Column), Cells(Rds.row + Rds.Rows.Count - 1, R.Column + Rds.Columns.Count - 1)).Address
'            fCleareRange Range(sAd)
'        End If
'    End If
    ActiveWorkbook.Names(s).Delete
    fMerge_179 w
Next j
AddNN_179
a2:
CleareFormuls
InsertFormuls
ProtectBook
Set r = Nothing
Set Rv = Nothing
Set Rds = Nothing
Set w = Nothing
End Sub
' (modF074new)*
'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| "Data_" & sp & "2v"
Public Function DelName2_179(Rv As Range, sp$) As Boolean
Dim sAdv$, sAdds$, sAdds4$
If Rv.Address <> Range("Data_" & sp & "2v").Address Then
    DelName2_179 = False
    Exit Function
End If
sAdv = "='" & Rv.Worksheet.name & "'!" & Rv.Address
sAdds = "='" & Rv.Worksheet.name & "'!" & Range("Data_" & sp & "2").Address
If sp = "3" Then sAdds4 = "='" & Rv.Worksheet.name & "'!" & Range("Data_42").Address
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|
If Rv.Column = Range("Data_" & sp & "3v").Column - Rv.Columns.Count Then
        Rv.Cells(1, 1).Value = ""
        fCleareRange Range("Data_" & sp & "2")
        'If sp = "3" Then fCleareRange Range("Data_42") '13.01.2011
Else
        Rv.Delete Shift:=xlToLeft
        ActiveWorkbook.Names.Add name:="Data_" & sp & "2v", RefersTo:=sAdv
        ActiveWorkbook.Names.Add name:="Data_" & sp & "2", RefersTo:=sAdds
        'If sp = "3" Then ActiveWorkbook.Names.Add Name:="Data_42", RefersTo:=sAdds4    '13.01.2011
        Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
End If
DelName2_179 = True
End Function
' (modF074new)*
'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| "Data_" & sp & "1v"
Public Function DelName1_179(Rv1 As Range, sp$) As Boolean
Dim sAdv1$, sAdv2$, sAdds1$, sAdds2$, sAdds41$, sAdds42$
Dim Rv2 As Range
If Rv1.Address <> Range("Data_" & sp & "1v").Address Then
    DelName1_179 = False
    Exit Function
End If
Set Rv2 = Range("Data_" & sp & "2v")
If Len(Rv2.Cells(1, 1).Value) = 0 Then
    Rv1.Cells(1, 1).Value = ""
    fCleareRange Range("Data_" & sp & "1")
    If sp = "3" Then fCleareRange Range("Data_41")
End If

If Rv2.Column < Range("Data_" & sp & "3v").Column - Rv1.Columns.Count Then
    sAdv1 = "='" & Rv1.Worksheet.name & "'!" & Rv1.Address
    sAdv2 = "='" & Rv2.Worksheet.name & "'!" & Rv2.Address
    sAdds1 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_" & sp & "1").Address
    sAdds2 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_" & sp & "2").Address
    If sp = "3" Then
        sAdds41 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_41").Address
        sAdds42 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_42").Address
    End If
    Rv1.Delete Shift:=xlToLeft
    ActiveWorkbook.Names("Data_" & sp & "2v").Delete
    ActiveWorkbook.Names("Data_" & sp & "2").Delete
    ActiveWorkbook.Names.Add name:="Data_" & sp & "1v", RefersTo:=sAdv1
    ActiveWorkbook.Names.Add name:="Data_" & sp & "1", RefersTo:=sAdds1
    ActiveWorkbook.Names.Add name:="Data_" & sp & "2v", RefersTo:=sAdv2
    ActiveWorkbook.Names.Add name:="Data_" & sp & "2", RefersTo:=sAdds2
    '13.01.2011
'    If sp = "3" Then
'        ActiveWorkbook.Names("Data_42").Delete
'        ActiveWorkbook.Names.Add Name:="Data_41", RefersTo:=sAdds41
'        ActiveWorkbook.Names.Add Name:="Data_42", RefersTo:=sAdds42
'    End If
    '13.01.2011
End If

'sAdv = "='" & Rv.Worksheet.Name & "'!" & Rv.Address
'sAdds = "='" & Rv.Worksheet.Name & "'!" & Range("Data_" & sp & "2").Address
'If sp = "3" Then sAdds4 = "='" & Rv.Worksheet.Name & "'!" & Range("Data_42").Address
''|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|
'If Rv.Column = Range("Data_" & sp & "2v").Column - 2 Then
'        Rv.Cells(1, 1).Value = ""
'        fCleareRange Range("Data_" & sp & "2")
'        If sp = "3" Then fCleareRange Range("Data_42")
'Else
'        Rv.Delete Shift:=xlToLeft
'        ActiveWorkbook.Names.Add Name:="Data_" & sp & "2v", RefersTo:=sAdv
'        ActiveWorkbook.Names.Add Name:="Data_" & sp & "2", RefersTo:=sAdds
'        If sp = "3" Then ActiveWorkbook.Names.Add Name:="Data_42", RefersTo:=sAdds4
'        Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
'End If
Set Rv2 = Nothing
DelName1_179 = True
End Function
'   (ModF074R)*
Public Sub CleareColumns_179()
Dim w As Worksheet, r2 As Range, R3 As Range, r As Range, R1 As Range, R0 As Range
Dim sAd$, Col1 As Long, Col2 As Long, i As Long, sp$, a As Variant
If IsEmpty(Range("Data_11v").Cells(1, 1)) Then Exit Sub

For i = 1 To 4  '13.01.2011
'For i = 1 To 3
sp = Trim$(str(i))
Set R0 = Range("Kod" & sp)
Set R1 = Range("Data_" & sp & "1v")
Set r2 = Range("Data_" & sp & "2v")
Set R3 = Range("Data_" & sp & "3v")
Set w = r2.Worksheet
Col1 = r2.Column + r2.Columns.Count
Col2 = R3.Column - 1
If Col2 > Col1 Then
    sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
    Range(sAd).Delete Shift:=xlToLeft
End If
Col1 = R0.Column + R0.Columns.Count + R1.Columns.Count
Col2 = R1.Column - 1
If Col2 > Col1 Then
    sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
    Range(sAd).Delete Shift:=xlToLeft
End If
Col1 = R1.Column + R1.Columns.Count
Col2 = r2.Column - 1
If Col2 > Col1 Then
    sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
    Range(sAd).Delete Shift:=xlToLeft
End If

    fMerge_179 w
    R3.Columns.EntireColumn.Hidden = True
    fCleareRange Range("Data_" & sp & "1")
    fCleareRange Range("Data_" & sp & "2")
    '13.01.2011
'    If i = 3 Then
'        fCleareRange Range("Data_41")
'        fCleareRange Range("Data_42")
'    End If
     '13.01.2011
     If R1.Cells(1, 1).MergeCells Then R1.Cells(1, 1).MergeArea.ClearContents Else R1.Cells(1, 1).ClearContents
     If r2.Cells(1, 1).MergeCells Then r2.Cells(1, 1).MergeArea.ClearContents Else r2.Cells(1, 1).ClearContents
Next i
deleteNames
Set w = Nothing
Set r2 = Nothing
Set R3 = Nothing
Set r = Nothing
End Sub

'   (ModF074R)*
'<Spir>10.01.2016 |fffd||fffd||fffd| |fffd||fffd| 01012017  idForm=14R_OKTMO |fffd| Len_CS = 10

Public Sub CleareColumns_179_CS10()
Dim w As Worksheet, r2 As Range, R3 As Range, r As Range, R1 As Range, R0 As Range
Dim sAd$, Col1 As Long, Col2 As Long, i As Long, sp$, a As Variant
If IsEmpty(Range("Data_11v").Cells(1, 1)) Then Exit Sub

For i = 1 To 7
    sp = Trim$(str(i))
    Set R0 = Range("Kod" & sp)
    Set R1 = Range("Data_" & sp & "1v")
    Set r2 = Range("Data_" & sp & "2v")
    Set R3 = Range("Data_" & sp & "3v")
    Set w = r2.Worksheet
    Col1 = r2.Column + r2.Columns.Count
    Col2 = R3.Column - 1
    If Col2 > Col1 Then
        sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
        Range(sAd).Delete Shift:=xlToLeft
    End If
    Col1 = R0.Column + R0.Columns.Count + R1.Columns.Count
    Col2 = R1.Column - 1
    If Col2 > Col1 Then
        sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
        Range(sAd).Delete Shift:=xlToLeft
    End If
    Col1 = R1.Column + R1.Columns.Count
    Col2 = r2.Column - 1
    If Col2 > Col1 Then
        sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
        Range(sAd).Delete Shift:=xlToLeft
    End If
    
    fMerge_179_CS10 w, sp
    R3.Columns.EntireColumn.Hidden = True
    fCleareRange Range("Data_" & sp & "1")
    fCleareRange Range("Data_" & sp & "2")
     If R1.Cells(1, 1).MergeCells Then R1.Cells(1, 1).MergeArea.ClearContents Else R1.Cells(1, 1).ClearContents
     If r2.Cells(1, 1).MergeCells Then r2.Cells(1, 1).MergeArea.ClearContents Else r2.Cells(1, 1).ClearContents
Next i
deleteNames
Set w = Nothing
Set r2 = Nothing
Set R3 = Nothing
Set r = Nothing
End Sub


'   (ModF074R)*
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub AddNN_179()
Dim j As Long, sp$, Row As Long, w As Worksheet
Dim r As Range, k As Long, i As Long, Col As Long, n As Long

For j = 1 To 4
    sp = Trim$(str(j))
    Set r = Range("Data_" & sp & "3")
    Set w = r.Worksheet
    Row = r.Row - 1
    Col = Range("Kod" & sp).Column + 1
    k = 3: n = 1
'13.01.2011    If j = 3 Then k = 4: n = 2
    For i = Col To r.Column - 1
        If IsFirstCell(w.Cells(Row, i)) Then
            w.Cells(Row, i) = k
            k = k + n
        End If
    Next i
Next j
Set r = Nothing
Set w = Nothing
End Sub
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (modF074)*
Public Function Rasstanovka014FromArray_179(a As Variant) As Variant
Dim Val As Variant, sKod(0) As String, sname$, n As Long, err() As Variant
Dim i As Long

ReDim err(1 To 100, 1 To 2)
n = LBound(err, 1)
UnProtectBook
For i = LBound(a) To UBound(a)
    sname = Trim$(a(i, 1))
    If Len(sname) = 0 Then GoTo a2
'    Val = IIf(A(i, 1) > 0, A(i, 1), A(i, 2))
    Val = a(i, 2)
    If Not sname Like "ss*[a-c]" Then GoTo A1
    If Len(sname) < 23 Then GoTo A1
    sKod(0) = Mid$(sname, 3, Len(sname) - 6)
    If HasName("rr1" & sKod(0)) Then GoTo A1
    AddColumnList_179 sKod
A1:
    If HasName(sname) Then If HasFormula(Range(sname)) = False Then Range(sname) = Val
'    Else
''        err(n, 1) = sName
''        err(n, 2) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
''        n = n + 1
'    End If
a2:
Next i
InsertFormuls
ProtectBook
'If n = LBound(err) Then Rasstanovka014FromArray = 0
'Else
'    ReDim Preserve err(1 To n - 1, 1 To 2)
'    Rasstanovka014FromArray = err
'End If
Rasstanovka014FromArray_179 = 0
End Function



Attribute VB_Name = "modF074_86"
'
' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 074 |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|86
' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini-|fffd||fffd||fffd||fffd||fffd| -   idForm=14_86
' |fffd||fffd||fffd| 20.06.2016
'
Option Explicit
Public sSelectRange As String
Dim db As Database
Dim rs As Recordset
Dim FlReneme  As Long
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (mod074_86)*
Public Sub InsertColumn_86()

UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"

'AddFormarekvizit "Data_RCH"
AddFormarekvizit gcNameAddRd '13.01.2011
 
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|(mod074_86)*
Public Sub RenameColumn_86()
Dim r As Range, sKod$

Set r = Selection
sKod = r.Cells(1, 1).Value
sKod = sReplace(sKod, " ", "")
sKod = sReplace(sKod, "'", "")
If Len(sKod) = 0 Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
If HasInSpr(sKod, "Data_RCHGr") Then MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
'If HasInSpr(sKod, "Data_RCH") = False Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
If HasInSpr(sKod, gcNameAddRd) = False Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub '13.01.2011

UserForm1.Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
'AddFormarekvizit "Data_RCH"2
AddFormarekvizit gcNameAddRd '13.01.2011

End Sub


'-------------------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|(mod074_86)*
Public Function AddColumnList_86(sKod() As String) As String
Dim r As Range, i As Long, Rv As Range, Rds As Range, Rds4 As Range, j As Long, sp$, sAd$
Dim sAdrv$, sAdds$, sAdds4$ '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'    On Error Resume Next
For j = 1 To 7
    sp = Trim$(str(j))
    Set Rv = Range("Data_" & sp & "3v")
    Rv.Columns.EntireColumn.Hidden = False
    For i = LBound(sKod) To UBound(sKod)
        If Len(sKod(i)) = 0 Then GoTo a2
        Set r = Range("Data_" & sp & "1v").Cells(1, 1)
        If IsEmpty(r.Value) Or Len(r.Value) = 0 Then Set Rds = Range("Data_" & sp & "1"): Set Rds4 = Range("Data_41"): GoTo A1
        Set r = Range("Data_" & sp & "2v").Cells(1, 1)
        If IsEmpty(r.Value) Or Len(r.Value) = 0 Then Set Rds = Range("Data_" & sp & "2"): Set Rds4 = Range("Data_42"): GoTo A1
        
        sAdrv = "='" & Rv.Worksheet.name & "'!" & Rv.Cells.Address
        sAdds = "='" & Rv.Worksheet.name & "'!" & Range("Data_" & sp & "3").Address
        If j = 3 Then sAdds4 = "='" & Rv.Worksheet.name & "'!" & Range("Data_43").Address
        Rv.Copy
        Rv.Insert Shift:=xlToRight
        Application.CutCopyMode = False
        Set Rds = Range(sAdds)
        If j = 3 Then Set Rds4 = Range(sAdds4)
        Set r = Range(sAdrv).Cells(1, 1)
A1:
        r.Value = FormatKod(sKod(i))
        sAd = "='" & r.Worksheet.name & "'!" & r.Address
        ActiveWorkbook.Names.Add name:="rr" & sp & sKod(i), RefersTo:=sAd
        insertName sKod(i), Rds, "Kod" & sp, False
        ''''13.01.2011
'        If j = 3 Then
'            insertName sKod(i), Rds4, "Kod4", False
'        End If
        ''''13.01.2011
a2:
    Next i
    fMerge_86 Rv.Worksheet
    Rv.Columns.EntireColumn.Hidden = True
Next j
AddNN_86
If UBound(sKod) = 0 Then sSelectRange = "rr1" & sKod(0)
Set Rds = Nothing
Set Rv = Nothing
Set r = Nothing
End Function

'----------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(mod074_86)*
Public Sub fGroupAdd_86()
Dim mKodGr() As String, mKod() As String, i As Long, Org$, sKodRrimary$, j As Long, sKodGr$

If MsgBox("|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|?", 4 + 256, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|") = 7 Then Exit Sub
UnProtectBook
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
mKod() = ReturnKods_86(False)
'If UBound(mKod) = 0 And mKod(0) = "False" Then MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Sub
    
Range("Data_13v").Columns.EntireColumn.Hidden = False
Range("Data_23v").Columns.EntireColumn.Hidden = False
Range("Data_33v").Columns.EntireColumn.Hidden = False
Range("Data_43v").Columns.EntireColumn.Hidden = False   '13.01.2011

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
For i = 0 To UBound(mKod)
    sKodRrimary = mKod(i)
    Org = Mid$(sKodRrimary, 20, 4)
    mKodGr() = fKodsGr_86(left(sKodRrimary, 19))
    For j = 0 To UBound(mKodGr)
'            sKodGr = KodGr(j)
            sKodGr = mKodGr(j) & Org
            If Len(sKodGr) > 0 And Not HasName("rg1" & sKodGr) Then AddGRColumn_86 sKodRrimary, sKodGr
            sKodRrimary = sKodGr
    Next j
Next i
AddNN_86
CleareFormuls_86
InsertFormuls_86
Range("Data_13v").Columns.EntireColumn.Hidden = True
Range("Data_23v").Columns.EntireColumn.Hidden = True
Range("Data_33v").Columns.EntireColumn.Hidden = True
Range("Data_43v").Columns.EntireColumn.Hidden = True      '13.01.2011
ProtectBook
End Sub
'-------------------------|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|(mod074_86)*
Public Sub AddGRColumn_86(ByVal sKodRrimary$, ByVal sKodGr$)
Dim sNamePrimary$, sGrName$, j As Long, sp$
Dim Rv As Range, r As Range, Rpr As Range
Dim sAdrDS$, Rds As Range, w As Worksheet, sAd$

For j = 1 To 4  '13.01.2011
'For j = 1 To 3
    sp = Trim$(str(j))
    sNamePrimary = "rr" & sp & sKodRrimary
    If Not HasName(sNamePrimary) Then sNamePrimary = "rg" & sp & sKodRrimary
    Set Rpr = Range(sNamePrimary)
    sGrName = "rg" & sp & sKodGr
    Set Rv = Range("Data_" & sp & "3v")
    Set w = Rv.Worksheet
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set r = Range(w.Cells(Rv.Row, Rpr.Column), w.Cells(Rv.Row + Rv.Rows.Count - 1, Rpr.Column + Rv.Columns.Count - 1))
    sAdrDS = "='" & Rv.Worksheet.name & "'!" & r.Address
    Rv.Copy
    r.Insert Shift:=xlToRight
    Set r = Range(sAdrDS)
'    If j <> 3 Then R.ColumnWidth = 12.86 Else R.ColumnWidth = 14.29
    r.Cells(1, 1) = FormatKod(sKodGr)
        sAd = "='" & r.Worksheet.name & "'!" & r.Cells(1, 1).Address
        ActiveWorkbook.Names.Add name:=sGrName, RefersTo:=sAd
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| ~ Data_11
Set Rds = Range(w.Cells(Range("Kod" & sp).Row, r.Column), w.Cells(Rv.Row + Rv.Rows.Count - 1, r.Column + r.Columns.Count - 1))
Rds.Interior.ColorIndex = xlNone
Rds.Locked = True
insertName sKodGr, Rds, "Kod" & sp, True

'13.01.2011
'If j = 3 Then
'    Set Rds = W.Range(W.Cells(Range("Kod4").Row, r.Column), W.Cells(Range("Kod4").Row + Range("Kod4").Rows.Count - 1, r.Column + r.Columns.Count - 1))
'    insertName sKodGr, Rds, "Kod4", True
'    Rds.Interior.ColorIndex = xlNone
'    Rds.Locked = True
'End If
'13.01.2011

fMerge_86 Rv.Worksheet
Next j
Set r = Nothing
Set Rpr = Nothing
Set Rv = Nothing
Set Rds = Nothing
Set w = Nothing
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (mod074_86_2)*
'False - |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  True |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function ReturnKods_86(flGroup As Boolean) As String()
Dim mKod() As String, Rv As Range, w As Worksheet, rowKod As Long, sKod$, j As Long, i As Long, Org$

Set w = Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Set Rv = Range("Data_13v")
'rowKod = Rv.Cells(1, 1).row
rowKod = Rv.Row
ReDim mKod(0 To (Rv.Column - Range("Kod1").Column) \ 2)
For i = Range("Kod1").Column + 3 To Rv.Column - 1
    Org = ""
    sKod = w.Cells(rowKod, i)
    If Len(sKod) = 0 Then GoTo A1
    sKod = sReplace(sKod, "'", "")
    sKod = sReplace(sKod, vbLf, "")
    If Len(sKod) > 19 Then
        Org = Mid$(sKod, 20, 4)
        sKod = left(sKod, 19)
    End If
    If Len(sKod) > 0 Then
'        If flGroup = False And HasInSpr(sKod, "Data_RCH") = True Then
        If flGroup = False And HasInSpr(sKod, gcNameAddRd) = True Then '13.01.2011
           mKod(j) = IIf(Len(Org) = 0, sKod, sKod & Org)
            j = j + 1
        End If
        If flGroup = True And HasInSpr(sKod, "Data_RCHGr") = True Then
            mKod(j) = sKod
            j = j + 1
        End If
    End If
A1:
Next i
If j = 0 Then j = 1: mKod(0) = "False"
ReDim Preserve mKod(0 To j - 1)
Set Rv = Nothing
Set w = Nothing
ReturnKods_86 = mKod()
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| (mod074_86_2)*
Public Function fKodsGr_86(sKod As String) As String()
Dim mKodGr() As String, r As Range, i As Long, sGrStr$, k As Long, s$
ReDim mKodGr(0 To 15)
fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index

'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd||fffd| Parent
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd|
'Set r = Range("Data_RCH")
Set r = Range(gcNameAddRd) '13.01.2011

r.Sort Key1:=r.Cells(1, 1), Order1:=xlAscending
For i = 1 To r.Rows.Count
    If r.Cells(i, 1) = sKod Then
        If Len(r.Cells(i, 2)) > 0 Then sGrStr = r.Cells(i, 3): GoTo A1
    End If
Next i
A1:
If Len(sGrStr) = 0 Then GoTo a2
Set r = Range("Data_RCHGr")
r.Sort Key1:=r.Cells(1, 1), Order1:=xlAscending
While Len(sGrStr) > 0
    For i = 1 To r.Rows.Count
        s = r.Cells(i, 1)
        If Right$(s, 5) = sGrStr Then
            mKodGr(k) = s
            k = k + 1
            sGrStr = r.Cells(i, 3)
            GoTo A3
        End If
    Next i
    sGrStr = ""
A3:
Wend
a2:
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "" |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
ReDim Preserve mKodGr(0 To k)
'If k = 0 Then k = 1
'ReDim Preserve mKodGr(0 To k - 1)
Set r = Nothing
fKodsGr_86 = mKodGr()
End Function

' (mod074_86_2)*
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| "|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
Public Sub fMerge_86(w As Worksheet, Optional ByVal Col1 As Long = 0, Optional ByVal Col2 As Long = 0)
Dim Row As Long, sAd$, r As Range, Col3 As Long, iw As Single, Rv As Range
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge1").Row
    Set Rv = Range("Data_13v")
    If Col1 = 0 Then Col1 = Range("Data_Kods1").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge2").Row
    Set Rv = Range("Data_23v")
    If Col1 = 0 Then Col1 = Range("Data_Kods2").Cells(1, 4).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 3
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    Row = Range("Data_Merge3").Row
    Set Rv = Range("Data_33v")
    If Col1 = 0 Then Col1 = Range("Data_Kods3").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.89
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-4,5" Then
    Row = Range("Data_Merge4").Row
    Set Rv = Range("Data_43v")
    If Col1 = 0 Then Col1 = Range("Data_Kods4").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-4,5" Then
    Row = Range("Data_Merge5").Row
    Set Rv = Range("Data_53v")
    If Col1 = 0 Then Col1 = Range("Data_Kods5").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-4,5" Then
    Row = Range("Data_Merge6").Row
    Set Rv = Range("Data_63v")
    If Col1 = 0 Then Col1 = Range("Data_Kods6").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
If w.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-4,5" Then
    Row = Range("Data_Merge7").Row
    Set Rv = Range("Data_73v")
    If Col1 = 0 Then Col1 = Range("Data_Kods7").Cells(1, 3).Column
    If Col2 = 0 Then Col2 = Rv.Column - 1
    Col3 = Rv.Column + 2
    iw = 12.86
End If
sAd = "='" & w.name & "'!" & Range(Cells(Row, Col1), Cells(Row, Col2)).Address
Set r = Range(sAd)
r.UnMerge
r.Merge
r.ColumnWidth = iw
r.Borders(xlEdgeTop).LineStyle = xlContinuous
Rv.Columns.EntireColumn.Hidden = True

sAd = "='" & w.name & "'!" & Range(Cells(Row, Col3), Cells(Row, 90)).Address
Set r = Range(sAd)
r.Borders(xlEdgeBottom).LineStyle = xlNone
r.Borders(xlEdgeTop).LineStyle = xlNone
Set r = Nothing
Set Rv = Nothing
End Sub

' (modF074new)*
Public Sub DeleteColumn_86()
Dim n As name, r As Range, sp$, Rv As Range, sAd$, j As Long, sKod$, Rds As Range, w As Worksheet, sname$, s$
For Each n In ActiveWorkbook.Names
    sname = n.name
    If n.name Like "rg*" Then MsgBox "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
Next

Set r = Selection
sKod = r.Cells(1, 1).Value
sKod = sReplace(sKod, "'", "")
sKod = sReplace(sKod, " ", "")
'If Len(sKod) = 0 Or Not HasInSpr(sKod, "Data_RCH") Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
If Len(sKod) = 0 Or Not HasInSpr(sKod, gcNameAddRd) Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub  '13.01.2011
If MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| " & sKod & " ?", 4 + 256, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|") = 7 Then Exit Sub
UnProtectBook
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| c |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
If DelName11(sKod) Then GoTo a2
DelNamesss sKod
For j = 1 To 7
    sp = Trim$(str(j))
    s = "rr" & sp & sKod
    Set r = Range(s)
    Set w = r.Worksheet
    Set Rv = Range("Data_" & sp & "1v")
    sAd = "='" & r.Worksheet.name & "'!" & Range(Cells(Rv.Row, r.Column), Cells(Rv.Row + Rv.Rows.Count - 1, r.Column + Rv.Columns.Count - 1)).Address
    Set Rv = Range(sAd)
    
    If DelName2_86(Rv, sp) Then GoTo A1
    If DelName1_86(Rv, sp) Then GoTo A1

    
'    If Rv.Column > Range("Data_" & sp & "2v").Column Then
        Rv.Delete Shift:=xlToLeft
        Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
        
A1:
'    Else
'        R.Value = ""
'        Set Rds = Range("Data_" & sp & "1")
'        sAd = "='" & R.Worksheet.Name & "'!" & Range(Cells(Rds.row, R.Column), Cells(Rds.row + Rds.Rows.Count - 1, R.Column + Rds.Columns.Count - 1)).Address
'        fCleareRange Range(sAd)
'        If j = 3 Then
'            Set Rds = Range("Data_41")
'            sAd = "='" & R.Worksheet.Name & "'!" & Range(Cells(Rds.row, R.Column), Cells(Rds.row + Rds.Rows.Count - 1, R.Column + Rds.Columns.Count - 1)).Address
'            fCleareRange Range(sAd)
'        End If
'    End If
    ActiveWorkbook.Names(s).Delete
    fMerge_86 w
Next j
AddNN_86
a2:
CleareFormuls_86
InsertFormuls_86
ProtectBook
Set r = Nothing
Set Rv = Nothing
Set Rds = Nothing
Set w = Nothing
End Sub
' (modF074new)*
'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| "Data_" & sp & "2v"
Public Function DelName2_86(Rv As Range, sp$) As Boolean
Dim sAdv$, sAdds$, sAdds4$
If Rv.Address <> Range("Data_" & sp & "2v").Address Then
    DelName2_86 = False
    Exit Function
End If
sAdv = "='" & Rv.Worksheet.name & "'!" & Rv.Address
sAdds = "='" & Rv.Worksheet.name & "'!" & Range("Data_" & sp & "2").Address
If sp = "3" Then sAdds4 = "='" & Rv.Worksheet.name & "'!" & Range("Data_42").Address
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|
If Rv.Column = Range("Data_" & sp & "3v").Column - Rv.Columns.Count Then
        Rv.Cells(1, 1).Value = ""
        fCleareRange Range("Data_" & sp & "2")
        'If sp = "3" Then fCleareRange Range("Data_42") '13.01.2011
Else
        Rv.Delete Shift:=xlToLeft
        ActiveWorkbook.Names.Add name:="Data_" & sp & "2v", RefersTo:=sAdv
        ActiveWorkbook.Names.Add name:="Data_" & sp & "2", RefersTo:=sAdds
        'If sp = "3" Then ActiveWorkbook.Names.Add Name:="Data_42", RefersTo:=sAdds4    '13.01.2011
        Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
End If
DelName2_86 = True
End Function
' (modF074new)*
'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| "Data_" & sp & "1v"
Public Function DelName1_86(Rv1 As Range, sp$) As Boolean
Dim sAdv1$, sAdv2$, sAdds1$, sAdds2$, sAdds41$, sAdds42$
Dim Rv2 As Range
If Rv1.Address <> Range("Data_" & sp & "1v").Address Then
    DelName1_86 = False
    Exit Function
End If
Set Rv2 = Range("Data_" & sp & "2v")
If Len(Rv2.Cells(1, 1).Value) = 0 Then
    Rv1.Cells(1, 1).Value = ""
    fCleareRange Range("Data_" & sp & "1")
    If sp = "3" Then fCleareRange Range("Data_41")
End If

If Rv2.Column < Range("Data_" & sp & "3v").Column - Rv1.Columns.Count Then
    sAdv1 = "='" & Rv1.Worksheet.name & "'!" & Rv1.Address
    sAdv2 = "='" & Rv2.Worksheet.name & "'!" & Rv2.Address
    sAdds1 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_" & sp & "1").Address
    sAdds2 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_" & sp & "2").Address
    If sp = "3" Then
        sAdds41 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_41").Address
        sAdds42 = "='" & Rv1.Worksheet.name & "'!" & Range("Data_42").Address
    End If
    Rv1.Delete Shift:=xlToLeft
    ActiveWorkbook.Names("Data_" & sp & "2v").Delete
    ActiveWorkbook.Names("Data_" & sp & "2").Delete
    ActiveWorkbook.Names.Add name:="Data_" & sp & "1v", RefersTo:=sAdv1
    ActiveWorkbook.Names.Add name:="Data_" & sp & "1", RefersTo:=sAdds1
    ActiveWorkbook.Names.Add name:="Data_" & sp & "2v", RefersTo:=sAdv2
    ActiveWorkbook.Names.Add name:="Data_" & sp & "2", RefersTo:=sAdds2
    '13.01.2011
'    If sp = "3" Then
'        ActiveWorkbook.Names("Data_42").Delete
'        ActiveWorkbook.Names.Add Name:="Data_41", RefersTo:=sAdds41
'        ActiveWorkbook.Names.Add Name:="Data_42", RefersTo:=sAdds42
'    End If
    '13.01.2011
End If

'sAdv = "='" & Rv.Worksheet.Name & "'!" & Rv.Address
'sAdds = "='" & Rv.Worksheet.Name & "'!" & Range("Data_" & sp & "2").Address
'If sp = "3" Then sAdds4 = "='" & Rv.Worksheet.Name & "'!" & Range("Data_42").Address
''|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|
'If Rv.Column = Range("Data_" & sp & "2v").Column - 2 Then
'        Rv.Cells(1, 1).Value = ""
'        fCleareRange Range("Data_" & sp & "2")
'        If sp = "3" Then fCleareRange Range("Data_42")
'Else
'        Rv.Delete Shift:=xlToLeft
'        ActiveWorkbook.Names.Add Name:="Data_" & sp & "2v", RefersTo:=sAdv
'        ActiveWorkbook.Names.Add Name:="Data_" & sp & "2", RefersTo:=sAdds
'        If sp = "3" Then ActiveWorkbook.Names.Add Name:="Data_42", RefersTo:=sAdds4
'        Range("Data_" & sp & "3v").Columns.EntireColumn.Hidden = True
'End If
Set Rv2 = Nothing
DelName1_86 = True
End Function
'   (ModF074R)*
Public Sub CleareColumns_86()
Dim w As Worksheet, r2 As Range, R3 As Range, r As Range, R1 As Range, R0 As Range
Dim sAd$, Col1 As Long, Col2 As Long, i As Long, sp$, a As Variant
If IsEmpty(Range("Data_11v").Cells(1, 1)) Then Exit Sub

For i = 1 To 7
sp = Trim$(str(i))
Set R0 = Range("Kod" & sp)
Set R1 = Range("Data_" & sp & "1v")
Set r2 = Range("Data_" & sp & "2v")
Set R3 = Range("Data_" & sp & "3v")
Set w = r2.Worksheet
Col1 = r2.Column + r2.Columns.Count
Col2 = R3.Column - 1
If Col2 > Col1 Then
    sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
    Range(sAd).Delete Shift:=xlToLeft
End If
Col1 = R0.Column + R0.Columns.Count + R1.Columns.Count
Col2 = R1.Column - 1
If Col2 > Col1 Then
    sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
    Range(sAd).Delete Shift:=xlToLeft
End If
Col1 = R1.Column + R1.Columns.Count
Col2 = r2.Column - 1
If Col2 > Col1 Then
    sAd = "='" & w.name & "'!" & Range(Cells(r2.Row, Col1), Cells(r2.Row + r2.Rows.Count - 1, Col2)).Address
    Range(sAd).Delete Shift:=xlToLeft
End If

    fMerge_86 w
    R3.Columns.EntireColumn.Hidden = True
    fCleareRange Range("Data_" & sp & "1")
    fCleareRange Range("Data_" & sp & "2")
     If R1.Cells(1, 1).MergeCells Then R1.Cells(1, 1).MergeArea.ClearContents Else R1.Cells(1, 1).ClearContents
     If r2.Cells(1, 1).MergeCells Then r2.Cells(1, 1).MergeArea.ClearContents Else r2.Cells(1, 1).ClearContents
Next i
deleteNames
Set w = Nothing
Set r2 = Nothing
Set R3 = Nothing
Set r = Nothing
End Sub

'   (ModF074R)*
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub AddNN_86()
Dim j As Long, sp$, Row As Long, w As Worksheet
Dim r As Range, k As Long, i As Long, Col As Long, n As Long

For j = 1 To 7
    sp = Trim$(str(j))
    Set r = Range("Data_" & sp & "3")
    Set w = r.Worksheet
    Row = r.Row - 1
    Col = Range("Kod" & sp).Column + 1
    k = 3: n = 1
    For i = Col To r.Column - 1
        If IsFirstCell(w.Cells(Row, i)) Then
            w.Cells(Row, i) = k
            k = k + n
        End If
    Next i
Next j
Set r = Nothing
Set w = Nothing
End Sub
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (modF074)*
Public Function Rasstanovka014FromArray_86(a As Variant) As Variant
Dim Val As Variant, sKod(0) As String, sname$, n As Long, err() As Variant
Dim i As Long

ReDim err(1 To 100, 1 To 2)
n = LBound(err, 1)
UnProtectBook
For i = LBound(a) To UBound(a)
    sname = Trim$(a(i, 1))
    If Len(sname) = 0 Then GoTo a2
'    Val = IIf(A(i, 1) > 0, A(i, 1), A(i, 2))
    Val = a(i, 2)
    If Not sname Like "ss*[a-c]" Then GoTo A1
    If Len(sname) < 23 Then GoTo A1
    sKod(0) = Mid$(sname, 3, Len(sname) - 6)
    If HasName("rr1" & sKod(0)) Then GoTo A1
    AddColumnList_86 sKod
A1:
    If HasName(sname) Then If HasFormula(Range(sname)) = False Then Range(sname) = Val
'    Else
''        err(n, 1) = sName
''        err(n, 2) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
''        n = n + 1
'    End If
a2:
Next i
InsertFormuls_86
ProtectBook
'If n = LBound(err) Then Rasstanovka014FromArray = 0
'Else
'    ReDim Preserve err(1 To n - 1, 1 To 2)
'    Rasstanovka014FromArray = err
'End If
Rasstanovka014FromArray_86 = 0
End Function


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Public Sub CleareFormuls_86()
Dim j As Long, sp$, r As Range, Col1 As Long, Rds As Range, Col2 As Long, w As Worksheet, s$
'Dim n As Name, sName, iKod%, sKod$
On Error GoTo A1
'UnProtectXlt1
For j = 1 To 7
    sp = Trim$(str(j))
    Set r = Range("Data_" & sp & "3")
    Set w = r.Worksheet

'    Col1 = Range("Kod" & sp).Column + 1 + R.Columns.Count
    Col1 = Range("Kod" & sp).Column + 1
    Col2 = r.Column - 1
    Set Rds = Range(w.Cells(r.Row, Col1), w.Cells(r.Row + r.Rows.Count - 1, Col2))
    For Each r In Rds
        s = r.Formula
        If Len(s) = 0 Or s = "X" Or left$(s, 5) = "=|fffd||fffd||fffd||fffd|" Or left$(s, 4) = "=SUM" Then GoTo A1
        If left$(s, 1) = "=" Then r.Formula = ""
A1:
    Next
Next j
Set r = Nothing
Set Rds = Nothing
Set w = Nothing
End Sub


Public Sub InsertFormuls_86()
Dim n As name, sname$, sKod$, Org$, idForm$
idForm = sGetINI("idForm", "?")
For Each n In ActiveWorkbook.Names
    sname = n.name
    If sname Like "rr1*" Then
        sKod = Mid$(sname, 4, 22)
'        Org = Mid$(sKod, 20, 4)
'        If (idForm = "14r" Or idForm = "14r_86") Then Org = Mid$(sName, 23, 4)
        If idForm14r = "14R_OKTMO" Then Org = Mid$(sname, 26, 12)
        AddFormulsofRange_86 sKod, Org, idForm
    End If
Next
End Sub


'|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| DataSheets |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 14r |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub AddFormulsofRange_86(sKod$, Org$, idForm$)
Dim r As Range, Rds As Range, Rsour As Range, Rtag As Range, n As Long, i As Long, j As Long, k As Long, sp$, Col1 As Long, Col2 As Long, Coltag As Long, Rowtag As Long
Dim w As Worksheet, s$, mKodGr() As String

mKodGr() = fKodsGr(sKod)
For n = 1 To 7
    sp = Trim$(str(n))
    Set r = Range("Data_" & sp & "3")
    Set w = r.Worksheet
'    If n = 4 Then sp = "3"
Col1 = Range("rr" & sp & sKod & Org).Column
Col2 = Col1 + r.Columns.Count - 1
Set Rds = Range(w.Cells(r.Row, Col1), w.Cells(r.Row + r.Rows.Count - 1, Col2))
For i = 1 To Rds.Columns.Count
 For j = 1 To Rds.Rows.Count
 
Set Rsour = Rds.Cells(j, i)
If left$(Rsour.Formula, 5) = "=|fffd||fffd||fffd||fffd|" Or left$(Rsour.Formula, 4) = "=SUM" Or Rsour.Value = "X" Or _
                    Rsour.Interior.ColorIndex <> 35 Or Not IsFirstCell(Rsour) Then GoTo A1

For k = LBound(mKodGr) To UBound(mKodGr)
    If Len(mKodGr(k)) = 0 And (idForm = "14" Or idForm = "14_179" Or idForm = "14_86") Then '17.01.2011
        Coltag = Range("Kod" & sp).Column
    Else
        s = "rg" & sp & mKodGr(k) & Org
        If Not HasName(s) Then GoTo a2
        Coltag = Range(s).Column - 1
    End If
    Rowtag = Rsour.Row
    Set Rtag = w.Cells(Rowtag, Coltag + i)
            If left$(Rtag.Formula, 1) = "=" Then
                    Rtag.Formula = Rtag.Formula & " + " & Rsour.Address
            Else
                    Rtag.Formula = "=" & Rsour.Address
            End If
a2:
Next k
A1:
Next j
Next i
Next n
Set w = Nothing
Set r = Nothing
Set Rds = Nothing
Set Rsour = Nothing
Set Rtag = Nothing
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub RenameColumns_86(sKodNew$)
Dim sKOdOld$, mKodGr() As String, sKodGrOld$, sKodGrNew$, j As Long, s$, sp$, r As Range, Rds As Range, sAd$
Set r = Selection
sKOdOld = r.Cells(1, 1).Value
sKOdOld = sReplace(sKOdOld, "'", "")
sKOdOld = sReplace(sKOdOld, " ", "")
mKodGr() = fKodsGr_86(sKOdOld)
If UBound(mKodGr) > 0 Then sKodGrOld = mKodGr(0)
If HasName("rg1" & sKodGrOld) Then
    mKodGr() = fKodsGr_86(sKodNew)
    If UBound(mKodGr) > 0 Then sKodGrNew = mKodGr(0)
    If sKodGrOld <> sKodGrNew Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|." & vbCrLf & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!": Exit Sub
End If
Unload UserForm1
DelNamesss sKOdOld  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| "Data_Cells"
For j = 1 To 4
    sp = Trim$(str(j))
    s = "rr" & sp & sKOdOld
    Set r = Range(s)
    Set Rds = Range("Data_" & sp & "1")
    sAd = "='" & r.Worksheet.name & "'!" & Range(Cells(Rds.Row, r.Column), Cells(Rds.Row + Rds.Rows.Count - 1, r.Column + Rds.Columns.Count - 1)).Address
    Set Rds = Range(sAd)
    sAd = "='" & r.Worksheet.name & "'!" & r.Address
    ActiveWorkbook.Names(s).Delete
'    r.Value = sKodNew
    r.Value = FormatKod(sKodNew)
    ActiveWorkbook.Names.Add name:="rr" & sp & sKodNew, RefersTo:=sAd
    insertName sKodNew, Rds, "Kod" & sp, False
'        If j = 3 Then
'            Set Rds = Range("Data_41")
'            sAd = "='" & r.Worksheet.name & "'!" & Range(Cells(Rds.Row, r.Column), Cells(Rds.Row + Rds.Rows.Count - 1, r.Column + Rds.Columns.Count - 1)).Address
'            insertName sKodNew, Rds, "Kod4", False
'        End If
Next j
Set r = Nothing
Set Rds = Nothing
End Sub

Attribute VB_Name = "modF125"
Option Explicit
Dim db As Database
Dim rs As Recordset
'' Spir 25.01.2016 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| 125 |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (|fffd||fffd|)
'' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini
Sub RestrictionList()
Dim sname As String
Dim rData As Range
Dim sStr As String
Dim i  As Long, s As String
Dim s1 As String, s2 As String, n  As Long, j  As Long, nn  As Long, nn1  As Long
Dim r As Range
Dim ii  As Long, jj  As Long, sKodStop As String, sNameActivSh As String, hi As Long, nFirst As Long

i = 5
ReDim arrSpr(1 To i)    '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
arrSpr(1) = "KLD"
arrSpr(2) = "FKR"
arrSpr(3) = "IFR"
arrSpr(4) = "PLS0"
arrSpr(5) = "SGU"
sKodStop = Range("Kod_STOPdata").Cells(1, 1)

'fUnProtect True
fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index

'<Spir> 25.12.2018 ~7670
nFirst = 0  '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|

For j = 1 To i
    s = "?"
    If plGR Then
        s = sGetINI("RestrictionList\" & arrSpr(j) & "\" & Range("Kod_Account").Value & "\" & sKodStop & "\GR\", "?")
    End If
    If s = "?" Then
        s = sGetINI("RestrictionList\" & arrSpr(j) & "\" & Range("Kod_Account").Value & "\" & sKodStop & "\", "?")
    End If
    If s = "?" Then
        s = sGetINI("RestrictionList\" & arrSpr(j) & "\" & Range("Kod_Account").Value & "\", "?")
    End If
    If s <> "?" Then
        
       '<Spir> 25.12.2018 ~7670
       If nFirst = 0 Then
            ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Activate
            Application.ScreenUpdating = False
            nFirst = 1
        End If
        
        If s = "empty" Then
            ClearData "Data_" & arrSpr(j)
        Else
            s1 = ","
            s2 = s
            n = UBound(Split(s2, s1)) '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            ReDim arrSprOne(1 To n + 1)
            For nn = 1 To n + 1
              s1 = StrEl(s, nn)
              arrSprOne(nn) = s1
            Next nn
            
            Set r = ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range("Data_" & arrSpr(j))
            If r.Cells(1, 1) <> "" Then
                nn1 = r.Rows.Count
                ''<Spir>30112018 ~7534
                If j = 4 Then
                    '' |fffd||fffd||fffd| RestrictionList\PLS0\140110180\01.01.2017\=1104xx411,1103xx430,... |fffd||fffd||fffd| xx - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, 2 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                    For jj = 1 To n + 1
                        s1 = Replace(arrSprOne(jj), "x", "?")
                        hi = nn1
                        Do While hi <= nn1
                            If hi = 0 Then Exit Do
                            If r.Cells(hi, 1) Like s1 Then
                                r.Cells(hi, 3) = "1"
                            End If
                            hi = hi - 1
                        Loop
                    Next jj
                    
                    For ii = nn1 To 1 Step -1
                        If Not (r.Cells(ii, 3) = "1") Then
                            r.Rows(ii).Delete Shift:=xlUp
                        End If
                    Next ii
                   
                Else
                    '<Spir> 25.12.2018 ~7670
                    ii = r.Cells(2, 3).Row
                    jj = r.Cells(r.Rows.Count - 1, 3).Row
                    s1 = "A" & ii & ":C" & jj
                    ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range(s1).Select
                    Selection.Delete Shift:=xlUp
                    '<Spir> 28.01.2019 ~7829
                    r.Cells(1, 1).Value = ""
                    r.Cells(2, 1).Value = ""
                    
                    
                    ResizeRange r, n + 1, 3
                    
                    For jj = 1 To n + 1
                        r.Cells(jj, 1) = arrSprOne(jj)
                        r.Cells(jj, 2) = ""
                    Next jj
                    
                
'                    For ii = nn1 To 1 Step -1
'                        s1 = ""
'                        For jj = 1 To n + 1
'                            If r.Cells(ii, 1) = arrSprOne(jj) Then
'                                s1 = "yes"
'                                Exit For
'                            End If
'                        Next jj
'                        If s1 = "" And r.Cells(ii, 1) <> "" Then
'                            If ii = nn1 Or ii = nn1 - 1 Then
'                                r.Cells(ii, 1) = ""
'                                r.Cells(ii, 2) = ""
'                            Else
'                                r.Rows(ii).Delete Shift:=xlUp
'                            End If
'                        End If
'                    Next ii
                End If
            End If
            If r.Cells(1, 1) = "" And r.Rows.Count >= 2 Then r.Rows(1).Delete Shift:=xlUp
            If r.Cells(1, 1) = "" And r.Rows.Count >= 2 Then r.Rows(1).Delete Shift:=xlUp
            If r.Cells(r.Rows.Count, 1) = "" And r.Rows.Count >= 2 Then r.Rows(r.Rows.Count).Delete Shift:=xlUp
            If r.Cells(r.Rows.Count, 1) = "" And r.Rows.Count >= 2 Then r.Rows(r.Rows.Count).Delete Shift:=xlUp
            Set r = Nothing
        End If
        
'        ActiveWorkbook.Sheets(sNameActivSh).Activate
        
    End If
Next j

'<Spir> 25.12.2018 ~7670
If nFirst = 1 Then
     ActiveWorkbook.Sheets("|fffd||fffd||fffd||fffd|1").Activate
     Application.ScreenUpdating = True
     CommandBars("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = True
     CommandBars("Worksheet Menu Bar").Controls("|fffd||fffd||fffd||fffd|").Controls("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Enabled = True
 End If


'fUnProtect False
fUnProtect False, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index

End Sub

' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Sub ClearData(NameData As String)
Dim r As Range, i As Long

Set r = Range(NameData)
For i = r.Rows.Count To 1 Step -1
'    If R.Cells(i, 1) Like sFilter Then R.Rows(i).Delete Shift:=xlUp
    r.Rows(i).Delete Shift:=xlUp
Next i
Set r = Nothing

End Sub

''12.12.2014    |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 125 (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)

Sub Sort125(b())
'' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini SortCell\|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|\
Dim sql$, sFName$, i As Long, s$, Row As Long
Dim sDir$, r As Range, Val As Variant, sV1$, err() As Variant, n As Long, LenKod As Long
ReDim err(1 To 100, 1 To 2)

sDir = Environ("TEMP") & "\"
sFName = sDir & ActiveWorkbook.name & ".mdb"
If Len(Dir$(sFName)) > 0 Then Kill sFName
Set db = DBEngine.CreateDatabase(left$(sFName, Len(sFName) - 4), dbLangCyrillic)
'|fffd||fffd||fffd||fffd||fffd| |fffd|.|fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| Excel
db.Close
Set db = OpenDatabase(sFName, False, False)
sql = "create table Data(Kod string(54), Value1 string(254))"
db.Execute (sql)

For i = LBound(b) To UBound(b)
    s = Trim$(b(i, 1))
    sV1 = Trim$(b(i, 2))
    sql = "insert into Data values('" & s & "','" & sV1 & "')"
    db.Execute (sql)
Next i
s = sGetINI("SortCell\" & Range("Kod_Account").Value & "\", "?")
Select Case s
    Case "GL"
        sql = "SELECT Kod, Value1 FROM(" & _
        "SELECT Kod, Value1, Mid(Kod, 12, 3) AS CodeS, Mid(Kod, 23, 20) AS CodeS1 FROM Data " & _
        " ORDER BY Mid(Kod, 12, 3), Mid(Kod, 23, 20))"
    Case "OKTMO"
        sql = "SELECT Kod, Value1 FROM(" & _
        "SELECT Kod, Value1, Mid(Kod, 15, 8) AS CodeS, Mid(Kod, 23, 20) AS CodeS1 FROM Data " & _
        " ORDER BY Mid(Kod, 15, 8), Mid(Kod, 23, 20))"
    Case "GL,OKTMO"
        sql = "SELECT Kod, Value1 FROM(" & _
        "SELECT Kod, Value1, Mid(Kod, 12, 3) AS CodeS, Mid(Kod, 15, 8) AS CodeS1, Mid(Kod, 23, 20) AS CodeS2 FROM Data " & _
        " ORDER BY Mid(Kod, 12, 3), Mid(Kod, 15, 8), Mid(Kod, 23, 20))"
    Case "OKTMO,GL"
        sql = "SELECT Kod, Value1 FROM(" & _
        "SELECT Kod, Value1, Mid(Kod, 15, 8) AS CodeS, Mid(Kod, 12, 3) AS CodeS1, Mid(Kod, 23, 20) AS CodeS2 FROM Data " & _
        " ORDER BY Mid(Kod, 15, 8), Mid(Kod, 12, 3), Mid(Kod, 23, 20))"
End Select
Set rs = db.OpenRecordset(sql, dbOpenDynaset, dbReadOnly)
If rs.RecordCount > 0 Then rs.MoveLast
 
rs.MoveFirst
i = 1
Do Until rs.EOF
    b(i, 1) = rs("Kod")
    b(i, 2) = rs("Value1")
  rs.MoveNext
  i = i + 1
Loop
rs.Close
Set rs = Nothing

End Sub
' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|  |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|  X (FillCells\030404000\=Data_Sheet01:3,4,5;DSItog1:1,2,3,7;DSItog2:1,2,3;DSItog3:1,2,3;)
Public Sub FillCells(ByVal sNameData As String)
    Dim sname As String
    Dim rData As Range
    Dim sStr As String
    Dim i  As Long, s As String
    Dim s1 As String, s2 As String, n  As Long, j  As Long, nn  As Long, nn1  As Long

 s1 = ";"
 s2 = sNameData
 n = UBound(Split(s2, s1)) '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 
    fUnProtect True
    For j = 1 To n
        If j = 1 Then
            nn = InStr(sNameData, ":")
            nn1 = InStr(sNameData, ";")
            sname = Mid(sNameData, j, nn - 1)
        Else
            sname = Mid(sNameData, nn1 + 1, InStr(nn + 1, sNameData, ":") - InStr(nn1, sNameData, ";") - 1)
            nn = InStr(nn + 1, sNameData, ":")
            nn1 = InStr(nn1 + 1, sNameData, ";")
        End If
        Set rData = Range(sname)
        sStr = Mid(sNameData, nn + 1, nn1 - nn - 1)
        '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        rData.Rows(1).Select
        Selection.ClearContents
        rData.Rows(2).Select
        Selection.ClearContents
'        If sName = "Data_Sheet01" Then
'           rData.Columns(4).Locked = False
'           rData.Columns(5).Locked = False
'           rData.Columns(6).Locked = False
'           rData.Columns(10).Locked = False
'        End If
        
        For i = 1 To StrEl(sStr)
            s = StrEl(sStr, i)
            rData.Cells(1, Val(s)).Value = "X"
            rData.Cells(2, Val(s)).Value = "X"
'            rData.Cells(1, Val(s)).Locked = True
'            rData.Cells(2, Val(s)).Locked = True
        Next i
    Next j
    
''<Spir>03122018 ~7507
'    If Not plGR Then
'        Set rData = Range("Data_Sheet01")
'        rData.Cells(1, 15).Value = "X"
'        rData.Cells(1, 14).Value = "X"
'        ' <Spir>24.04.2018 ~6314
''        rData.Cells(1, 13).Value = "X"
'        rData.Cells(2, 15).Value = "X"
'        rData.Cells(2, 14).Value = "X"
'        ' <Spir>24.04.2018 ~6314
''        rData.Cells(2, 13).Value = "X"
'    End If
    
    fUnProtect False
End Sub

' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  X (FillCellsF\130404000\=ss5000a:|fffd||fffd||fffd||fffd|(Data_s6);ss5000b:|fffd||fffd||fffd||fffd|(Data_s7);)
Public Sub FillCellsF(ByVal sNameData As String)
    Dim sname As String
    Dim rData As Range
    Dim sStr As String
    Dim i  As Long, s As String
    Dim s1 As String, s2 As String, n  As Long, j  As Long, nn  As Long, nn1  As Long

 s1 = ";"
 s2 = sNameData
 n = UBound(Split(s2, s1)) '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 
    fUnProtect True
    
    '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Range("ss5000a").FormulaR1C1Local = ""
    Range("ss5000b").FormulaR1C1Local = ""
    
    For j = 1 To n
        If j = 1 Then
            nn = InStr(sNameData, ":")
            nn1 = InStr(sNameData, ";")
            sname = Mid(sNameData, j, nn - 1)
        Else
            sname = Mid(sNameData, nn1 + 1, InStr(nn + 1, sNameData, ":") - InStr(nn1, sNameData, ";") - 1)
            nn = InStr(nn + 1, sNameData, ":")
            nn1 = InStr(nn1 + 1, sNameData, ";")
        End If
        sStr = Mid(sNameData, nn + 1, nn1 - nn - 1)
        
        Range(sname).FormulaR1C1Local = "=" & sStr
        
    Next j
    fUnProtect False
End Sub


Sub addRowF125_1(sKod$, r As Range, iAK As Long, Optional Row As Long, Optional flg128$, Optional newNameOrg$)
Dim s$, fl128 As Long, n As Long
Dim sKodBU As String
Dim s1 As String, s2 As String, k  As Long

fUnProtect True

If flg128 <> "?" Then fl128 = 1
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
n = 3 + fl128
r.Cells(Row, 1) = Mid$(sKod, n, 6)
n = n + 6
'|fffd||fffd||fffd|
If r.Cells(1, 4) <> "X" Then
    r.Cells(Row, 4) = Mid$(sKod, n, 3)
'    n = n + 3
Else
    r.Cells(Row, 4) = "X"
End If
n = n + 3
'O|fffd||fffd||fffd||fffd|
''<Spir> 06.09.2019 ~8639 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| N |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If Mid$(sKod, n, 1) <> "N" Then
    r.Cells(Row, 5) = Mid$(sKod, n, iAK)
Else
    r.Cells(Row, 5) = "X"
End If
n = n + iAK
'|fffd||fffd|-|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
''<Spir> 06.09.2019 ~8639 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| N |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If Mid$(sKod, n, 1) <> "N" Then
    r.Cells(Row, 6) = Mid$(sKod, n, 2)
Else
    r.Cells(Row, 6) = "X"
End If
n = n + 2
'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If r.Cells(1, 7) <> "X" Then
    sKodBU = Mid$(sKod, 23, 17) & left$(Range("Kod_Account").Cells(1, 1).Value, 6) & Mid$(sKod, 40, 3)
'    sKodBU = Mid$(sKod, 23, 17) & left$(Range("Kod_Account").Cells(1, 1).Value, 6) & Mid$(sKod, 42, 3)
    s1 = "N"
    k = UBound(Split(sKodBU, s1)) '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If k > 0 Then
        sKodBU = Replace$(sKodBU, s1, "")
    End If
    r.Cells(Row, 7) = sKodBU
'    R.Cells(Row, 7) = Mid$(sKod, n, 17) & left$(Range("Kod_Account").Cells(1, 1).Value, 6) & Mid$(sKod, n + 17, 3)
'    n = n + 17 + 3
Else
    r.Cells(Row, 7) = "X"
End If
n = n + 17 + 3
'|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'R.Cells(Row, 10) = IIf(R.Cells(1, 10) <> "X", Mid$(sKod, 46, 9), "X")
r.Cells(Row, 10) = IIf(r.Cells(1, 10) <> "X", Mid$(sKod, n, 9), "X")

fNameForDSandCells r, sKod, Row, "1"

''<Spir>03122018 ~7507
'If Not plGR Then
'    r.Cells(Row, 15) = "X"
'    r.Cells(Row, 14) = "X"
'    ' <Spir>24.04.2018 ~6314
''    r.Cells(Row, 13) = "X"
'End If

fUnProtect False

End Sub


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub F125_1Itogo(Optional FromForm As String)
Dim r As Range, R1 As Range, i As Long, sKodAcc$, row0 As Long, Row As Long
Dim sFormula$, rname$, s$, sKod$, sKodAccDt$, sAd$, sAdKt$, sAdDt$, s1$
Dim sGr$, sGr1$, sGr2$, sGr3$, sAccCode$
Dim fl125new As Long
'|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd|
If HasName("dsF") Then fl125new = 1
s1 = sGetINI("Calculate", "?")
If s1 <> "?" Then fl125new = 2
If FromForm = "FromForm" And fl125new = 2 Then Exit Sub
If Not HasName("DSItog1") Then Exit Sub
If Not HasName("DSItog2") Then Exit Sub
If Not HasName("DSItog3") Then Exit Sub

Set r = Range("Data_Sheet1")

sKodAcc = Range("Kod_Account").Cells(1, 1)
sGr1 = sGetINI("DSItog1.Group\" & sKodAcc & "\", "?")
sGr2 = sGetINI("DSItog2.Group\" & sKodAcc & "\", "?")
sGr3 = sGetINI("DSItog3.Group\" & sKodAcc & "\", "?")


For i = 2 To r.Rows.Count - 1
'|fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd|
row0 = r.Row + i - 1 ' |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| Data_Sheet1
If sGr1 = "?" Then GoTo A1
s = "= " & sReplace(sGr1, "R", "R" & Trim$(str(row0)))
'|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
ActiveSheet.Cells(1, 10).Clear
ActiveSheet.Cells(1, 10).Formula = s
sKod = "ww" & ActiveSheet.Cells(1, 10).Value     ' sKod = "w" & R.Cells(i, 3) & R.Cells(i, 4) & sKodAcc
    If HasName(sKod) = False Then
        Set R1 = Range("DSItog1")
        Row = R1.Row + R1.Rows.Count - 1    '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| DSItog1
        Rows(Row).Insert Shift:=xlDown
        Row = R1.Rows.Count - 1
        R1.Cells(Row, 1) = "X"
        If R1.Cells(1, 2) <> "X" Then R1.Cells(Row, 2) = r.Cells(i, 4) Else R1.Cells(Row, 2) = "X"
        If R1.Cells(1, 3) <> "X" Then R1.Cells(Row, 3) = r.Cells(i, 5) Else R1.Cells(Row, 3) = "X"
        If R1.Cells(1, 4) <> "X" Then R1.Cells(Row, 3) = r.Cells(i, 6) Else R1.Cells(Row, 4) = "X"
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        sAccCode = fAccItogKode(sGr1, row0)
        R1.Cells(Row, 5) = IIf(Len(sAccCode) = 0, sKodAcc, sAccCode)
        sAd = "='" & r.Worksheet.name & "'!" & R1.Cells(Row, 5).Address
        ActiveWorkbook.Names.Add name:=sKod, RefersTo:=sAd
        sAdDt = R1.Cells(Row, 6).Address
        sAdKt = R1.Cells(Row, 10).Address
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        sFormula = sGetINI("DSItog1.Dt", "0")
        If sFormula <> "0" Then R1.Cells(Row, 6).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
        sFormula = sGetINI("DSItog1.Kt", "0")
        If sFormula <> "0" Then R1.Cells(Row, 7).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
        R1.Cells(Row, 8) = "X"
        If fl125new = 1 Then AddColumn125 sKod
    End If
If fl125new = 1 Then InsFormula125 sKod, i, r.Cells(i, 8)
If fl125new = 0 Then
    InsFormula Range(sKod).Cells(1, 1).Offset(0, 4), r.Cells(i, 8)
    InsFormula Range(sKod).Cells(1, 1).Offset(0, 5), r.Cells(i, 9)
End If
If fl125new = 2 Then
    Calculate125 Range(sKod).Cells(1, 1).Offset(0, 4), r.Cells(i, 8)
    Calculate125 Range(sKod).Cells(1, 1).Offset(0, 5), r.Cells(i, 9)
End If
A1:
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If IfMoney(r.Cells(i, 9)) Then rname = "DSItog2" Else rname = "DSItog3"
If rname = "DSItog2" Then If sGr2 = "?" Then GoTo a2 Else sGr = sGr2
If rname = "DSItog3" Then If sGr3 = "?" Then GoTo a2 Else sGr = sGr3

s = "= " & sReplace(sGr, "R", "R" & Trim$(str(row0)))
ActiveSheet.Cells(1, 10).Clear ''
ActiveSheet.Cells(1, 10).Formula = s ''
sKod = "ww" & ActiveSheet.Cells(1, 10).Value 'sKod = sKod & R.Cells(i, 9)''
If HasName(sKod) = False Then
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|-|fffd||fffd|
    If IfMoney(r.Cells(i, 10)) Then rname = "DSItog2" Else rname = "DSItog3"
    Set R1 = Range(rname)
    Row = R1.Row + R1.Rows.Count - 1
    Rows(Row).Insert Shift:=xlDown
    Row = R1.Rows.Count - 1
        R1.Cells(Row, 1) = "X"
        If R1.Cells(1, 2) <> "X" Then R1.Cells(Row, 2) = r.Cells(i, 4) Else R1.Cells(Row, 2) = "X"
        If R1.Cells(1, 3) <> "X" Then R1.Cells(Row, 3) = r.Cells(i, 5) Else R1.Cells(Row, 3) = "X"
        If R1.Cells(1, 4) <> "X" Then R1.Cells(Row, 4) = r.Cells(i, 6) Else R1.Cells(Row, 4) = "X"
    sAccCode = fAccItogKode(sGr, row0)
    R1.Cells(Row, 5) = IIf(Len(sAccCode) = 0, sKodAcc, sAccCode)
    R1.Cells(Row, 8) = r.Cells(i, 10) '|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    sAd = "='" & r.Worksheet.name & "'!" & R1.Cells(Row, 5).Address
    ActiveWorkbook.Names.Add name:=sKod, RefersTo:=sAd
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    sAdDt = R1.Cells(Row, 9).Address
    sAdKt = R1.Cells(Row, 10).Address
    sFormula = sGetINI(rname & ".Dt", "0")
    If sFormula <> "0" Then R1.Cells(Row, 6).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
    sFormula = sGetINI(rname & ".Kt", "0")
    If sFormula <> "0" Then R1.Cells(Row, 7).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
    If fl125new = 1 Then AddColumn125 sKod
End If
If fl125new = 1 Then InsFormula125 sKod, i, r.Cells(i, 8)
If fl125new = 0 Then
    InsFormula Range(sKod).Cells(1, 1).Offset(0, 4), r.Cells(i, 8)
    InsFormula Range(sKod).Cells(1, 1).Offset(0, 5), r.Cells(i, 9)
End If
If fl125new = 2 Then
    Calculate125 Range(sKod).Cells(1, 1).Offset(0, 4), r.Cells(i, 8)
    Calculate125 Range(sKod).Cells(1, 1).Offset(0, 5), r.Cells(i, 9)
End If
a2:
Next i
'R1.Cells(R1.row + 1, 1).Offset(0, -1) = "|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd|:"
Set R1 = Nothing
Set r = Nothing
End Sub

'
'
Public Sub F125_1_Itogo128()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 125|fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd||fffd|,|fffd||fffd||fffd||fffd||fffd||fffd|),|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|.
Dim r As Range, R1 As Range, i As Long, Row As Long
Dim rd As Range, RK As Range
Dim db As Database
Dim sql As String
Dim sql1 As String
Dim k, k1
Dim rs As Recordset
Dim fArr
Dim lnFrm  As Long
Dim j  As Long
Dim l  As Long
Dim row_Itog  As Long
Dim row_Itog1  As Long
Dim nm As String
Dim sGr$, sGr1$, sGr2$, sGr3$, sKodAcc$, sAccDt1$, sAccKt1$, sAccDt2$, sAccKt2$, sAccDt3$, sAccKt3$
Dim sn As String
Dim ColArr
Dim flGR  As Long
Dim fArr1()
Dim sqlJoin1 As String
Dim sqlJoin2 As String
Dim sqlJoin3 As String
Dim sqlJoin4 As String
Dim sqlJoin5 As String
Dim sqlJoin6 As String
Dim sqlJoin7 As String
Dim sqlJoin8 As String
Dim sqlJoin9 As String
Dim sqlInsert As String
Dim sqlInsert1 As String
Dim sqlInsert2 As String
Dim sqlInsert3 As String
Dim sqlInsert4 As String
Dim sqlInsert5 As String
Dim sqlInsert6 As String
Dim sqlInsert7 As String
Dim sqlInsert8 As String
Dim sqlInsert9 As String
Dim sqlSelect As String
Dim Nds As String
Dim sGr11 As String, sGr12 As String, sGr13 As String
Dim sGr21 As String, sGr22 As String, sGr23 As String
Dim sGr31 As String, sGr32 As String, sGr33 As String
Dim TempPath As String
On Error GoTo err125

'UnProtectXlt1


If Not HasName("DSItog1") Then Exit Sub
If Not HasName("DSItog2") Then Exit Sub
If Not HasName("DSItog3") Then Exit Sub

sqlJoin1 = ""
sqlJoin2 = ""
sqlJoin3 = ""
sqlJoin4 = ""
sqlJoin5 = ""
sqlJoin6 = ""
sqlJoin7 = ""
sqlJoin8 = ""
sqlJoin9 = ""


sKodAcc = Range("Kod_Account").Cells(1, 1)
sGr11 = sGetINI("DSItog11.Group\" & sKodAcc & "\", "?")
sGr12 = sGetINI("DSItog12.Group\" & sKodAcc & "\", "?")
sGr13 = sGetINI("DSItog13.Group\" & sKodAcc & "\", "?")

sGr21 = sGetINI("DSItog21.Group\" & sKodAcc & "\", "?")
sGr22 = sGetINI("DSItog22.Group\" & sKodAcc & "\", "?")
sGr23 = sGetINI("DSItog23.Group\" & sKodAcc & "\", "?")

sGr31 = sGetINI("DSItog31.Group\" & sKodAcc & "\", "?")
sGr32 = sGetINI("DSItog32.Group\" & sKodAcc & "\", "?")
sGr33 = sGetINI("DSItog33.Group\" & sKodAcc & "\", "?")


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Set r = Range("DSItog1")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

Set r = Range("DSItog2")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

Set r = Range("DSItog3")
If r.Rows.Count > 2 Then
 Row = r.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 i = Row + r.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
 Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Set r = Range("Total_Debet")
'nm = R.Worksheet.Name
'i = R.Column
'ActiveWorkbook.Sheets(nm).Columns(i).ClearContents
'ActiveWorkbook.Sheets(nm).Columns(i).Interior.ColorIndex = xlNone
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone
Set r = Range("Total_Kredit")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

Set r = Range("TotaLItogD2")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone
Set r = Range("TotaLItogK2")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

Set r = Range("TotaLItogD3")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone
Set r = Range("TotaLItogK3")
Columns(r.Column).ClearContents
Columns(r.Column).Interior.ColorIndex = xlNone

TempPath = Environ("Temp")
'Set db = DBEngine.CreateDatabase(ThisWorkbook.Path & "\SvTemp", dbLangCyrillic)
Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp", dbLangCyrillic)
  
GoNext:
'Set db = DBEngine.CreateDatabase(ThisWorkbook.Path & "\SvTemp", dbLangCyrillic)

sql = "create table Result(col3 text,col4 text,col5 text,col6 text,col7 currency,col8 currency,col9 text,Ord integer,AccPls text,Adr_Dt memo,Adr_Kt memo,KodSpr text)"
db.Execute (sql)

Nds = fGetNumberDataSheet("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|")
If Nds = "" Then
  Set r = Range("Data_Sheet01")
Else
  Set r = Range("Data_Sheet" & Nds)
End If


 If r.Rows.Count > 2 Then
  For i = 2 To r.Rows.Count - 1
    sql = "insert into Result(col3,col4,col5,col6,col7,col8,col9,Ord,Adr_Dt,Adr_Kt,KodSpr) "
    sql = sql & "values('" & r.Cells(i, 4).Value & "','" & r.Cells(i, 5).Value & "','" & r.Cells(i, 6).Value & "','" & r.Cells(i, 7).Value & "','" & IIf(IsEmpty(r.Cells(i, 8).Value), 0, r.Cells(i, 8).Value) & "','" & IIf(IsEmpty(r.Cells(i, 9).Value), 0, r.Cells(i, 9).Value) & "','" & r.Cells(i, 10).Value & "',0,'" & r.Cells(i, 8).Address & "','" & r.Cells(i, 9).Address & "','" & r.Cells(i, 8).name.name & "')"
    db.Execute (sql)
  Next i
Else
  Exit Sub
End If

db.Close
Set db = OpenDatabase(TempPath & "\SvTemp")
sql = "update Result set KodSpr =mid(KodSpr,5,1)"
db.Execute (sql)


'|fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(Ord=1)|fffd||fffd||fffd||fffd||fffd||fffd|
'sGr1="RC6"

If sGr11 <> "?" Then
  sGr11 = GetSubStrItogo(sGr11, "-", "1", "&")
  fArr = DelimitedLineToArray(sGr11, ";")
  sqlInsert1 = CreateInsertsql(fArr, sGr11, ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert1, ",")
  'sqlJoin1 = CreateJoinsql(fArr, sqlInsert1)
  sqlJoin1 = CreateJoinsql128(fArr, sqlInsert1)
  sqlSelect = sReplace(sGr11, ";", ",")
  
   'sql = "INSERT INTO Result(col5,col6,col7,Ord) "
  sql = "INSERT INTO Result(" & sqlInsert1 & ",col7,col8,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col7),0,col7)),Sum(iif(isnull(col8),0,col8)),1,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='1' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  'sql = sql & "GROUP BY col5"
  db.Execute (sql)
End If

'|fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(Ord=2)|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'sGr2="RC6 & RC9"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sGr12 <> "?" Then
  sGr12 = UCase(sGr12)
  sGr12 = GetSubStrItogo(sGr12, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr12, ";")
  'sqlInsert2 = CreateInsertsql(fArr, sGr12, ";")
  sqlInsert2 = CreateInsertsql128(fArr, "", ";")
  fArr1 = DelimitedLineToArray(sqlInsert2, ",")
  sqlJoin2 = CreateJoinsql128(fArr, "")
  
  sqlSelect = sReplace(sGr12, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert2 & ",col7,col8,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col7),0,col7)),Sum(iif(isnull(col8),0,col8)),2,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='2' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If
'|fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(Ord=3)|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'sGr2="RC6 & RC9"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sGr13 <> "?" Then
  sGr13 = UCase(sGr13)
  sGr13 = GetSubStrItogo(sGr13, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr13, ";")
  sqlInsert3 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert3, ",")
  sqlJoin3 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr13, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert3 & ",col7,col8,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col7),0,col7)),Sum(iif(isnull(col8),0,col8)),3,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='3' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If


 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd|
If sGr21 <> "?" Then
  sGr21 = UCase(sGr21)
  sGr21 = GetSubStrItogo(sGr21, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr21, ";")
  sqlInsert4 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert4, ",")
  sqlJoin4 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr21, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert4 & ",col7,col8,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col7),0,col7)),Sum(iif(isnull(col8),0,col8)),4,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='1' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd||fffd|
If sGr22 <> "?" Then
  sGr22 = UCase(sGr22)
  sGr22 = GetSubStrItogo(sGr22, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr22, ";")
  sqlInsert5 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert5, ",")
  sqlJoin5 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr22, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert5 & ",col7,col8,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col7),0,col7)),Sum(iif(isnull(col8),0,col8)),5,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='2' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If sGr23 <> "?" Then
  sGr23 = UCase(sGr23)
  sGr23 = GetSubStrItogo(sGr23, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr23, ";")
  sqlInsert6 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert6, ",")
  sqlJoin6 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr23, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert6 & ",col7,col8,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col7),0,col7)),Sum(iif(isnull(col8),0,col8)),6,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='3' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
  sql = ""
End If

'----------------------------------------
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd|
If sGr31 <> "?" Then
  sGr31 = UCase(sGr31)
  sGr31 = GetSubStrItogo(sGr31, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr31, ";")
  sqlInsert7 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert7, ",")
  sqlJoin7 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr31, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert7 & ",col7,col8,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col7),0,col7)),Sum(iif(isnull(col8),0,col8)),7,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='1' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd||fffd|
If sGr32 <> "?" Then
  sGr32 = UCase(sGr32)
  sGr32 = GetSubStrItogo(sGr32, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr32, ";")
  sqlInsert8 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert8, ",")
  sqlJoin8 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr32, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert8 & ",col7,col8,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col7),0,col7)),Sum(iif(isnull(col8),0,col8)),8,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='2' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If sGr33 <> "?" Then
  sGr33 = UCase(sGr33)
  sGr33 = GetSubStrItogo(sGr33, "-", "1", "&")
  
  fArr = DelimitedLineToArray(sGr33, ";")
  sqlInsert9 = CreateInsertsql128(fArr, "", ";")
  
  fArr1 = DelimitedLineToArray(sqlInsert9, ",")
  sqlJoin9 = CreateJoinsql128(fArr, "")
  sqlSelect = sReplace(sGr33, ";", ",")
  
  sql = "INSERT INTO Result(" & sqlInsert9 & ",col7,col8,Ord,KodSpr) "
  sql = sql & "SELECT " & sqlSelect & ", Sum(iif(isnull(col7),0,col7)),Sum(iif(isnull(col8),0,col8)),9,KodSpr "
  sql = sql & "FROM Result "
  sql = sql & "where Ord=0 and trim(KodSpr)='3' "
  sql = sql & "GROUP BY KodSpr," & sqlSelect
  db.Execute (sql)
End If

sql = "update Result set AccPls=mid(col9,2,5) where Ord in(4,5,6,7,8,9)"
db.Execute (sql)


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sql = "create table Data_PLS5(Cod text,CodName text,sgn integer)"
db.Execute (sql)

Set R1 = Range("Data_PLS5")

  If R1.Rows.Count > 2 Then
  For i = 1 To R1.Rows.Count - 1
    sql = "insert into Data_PLS5(Cod,CodName,sgn) "
    sql = sql & "values('" & R1.Cells(i, 1).Value & "','" & R1.Cells(i, 2).Value & "'," & IIf(IsNumeric(R1.Cells(i, 3).Value), R1.Cells(i, 3).Value, 0) & ")"
    db.Execute (sql)
  Next i
End If

sql = "update Result "
sql = sql & "set Adr_Dt='0' "
sql = sql & "where Ord in(4,5,6,7,8,9)"
db.Execute (sql)
 
 
sql = "update Result inner join Data_PLS5 on trim(Result.AccPls)=trim(Data_PLS5.Cod) "
sql = sql & "set Adr_Dt='1' "
sql = sql & "where Ord in(4,5,6,7,8,9) and Data_PLS5.sgn<>0"
db.Execute (sql)

sql = "delete * from Result where ord in(4,5,6) and trim(Adr_Dt)='0'"
db.Execute (sql)

sql = "delete * from Result where ord in(7,8,9) and trim(Adr_Dt)='1'"
db.Execute (sql)
sql = ""
 

'Ord=0-|fffd||fffd||fffd||fffd||fffd||fffd|
'Ord=1,2,3-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd|,|fffd||fffd||fffd||fffd|,|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
'Ord=4,5,6-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd|,|fffd||fffd||fffd||fffd|,|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
'Ord=7,8,9-|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd|,|fffd||fffd||fffd||fffd|,|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
sAccDt1 = sGetINI("DSItog1.Dt\" & sKodAcc & "\", "?")
sAccKt1 = sGetINI("DSItog1.Kt\" & sKodAcc & "\", "?")
sAccDt2 = sGetINI("DSItog2.Dt\" & sKodAcc & "\", "?")
sAccKt2 = sGetINI("DSItog2.Kt\" & sKodAcc & "\", "?")
sAccDt3 = sGetINI("DSItog3.Dt\" & sKodAcc & "\", "?")
sAccKt3 = sGetINI("DSItog3.Kt\" & sKodAcc & "\", "?")
 
sAccDt1 = sReplace(sAccDt1, " ", "")
sAccKt1 = sReplace(sAccKt1, " ", "")

sAccDt2 = sReplace(sAccDt2, " ", "")
sAccKt2 = sReplace(sAccKt2, " ", "")

sAccDt3 = sReplace(sAccDt3, " ", "")
sAccKt3 = sReplace(sAccKt3, " ", "")



  'DsItog1
  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd|.|fffd|1251_6)
  If sAccDt1 <> "?" And sAccKt1 <> "?" Then
     flGR = 0
  ElseIf sAccDt1 <> "?" And sAccKt1 = "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1254_6)
    flGR = 1
    sn = Mid(sAccDt1, 6, 1)
  ElseIf sAccDt1 = "?" And sAccKt1 <> "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1256_6)
    flGR = 2
    sn = Mid(sAccKt1, 6, 1)
  End If
Call CreateFormula_Ostatok(db, flGR, sqlJoin1, 1, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin2, 2, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin3, 3, sn)


'Call CreateFormula_Ostatok128(db, flgr, sqlJoin1, 1, sn)

'DsItog2
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sAccDt2 <> "?" And sAccKt2 <> "?" Then
   flGR = 0
ElseIf sAccDt2 <> "?" And sAccKt2 = "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1254_6)
  flGR = 1
  sn = Mid(sAccDt2, 6, 1)
ElseIf sAccDt2 = "?" And sAccKt2 <> "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1256_6)
  flGR = 2
  sn = Mid(sAccKt2, 6, 1)
End If
Call CreateFormula_Ostatok(db, flGR, sqlJoin4, 4, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin5, 5, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin6, 6, sn)


'DsItog3
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|

If sAccDt3 <> "?" And sAccKt3 <> "?" Then
   flGR = 0
ElseIf sAccDt3 <> "?" And sAccKt3 = "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1254_6)
  flGR = 1
  sn = Mid(sAccDt3, 6, 1)
ElseIf sAccDt3 = "?" And sAccKt3 <> "?" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|.|fffd|1256_6)
  flGR = 2
  sn = Mid(sAccKt3, 6, 1)
End If
Call CreateFormula_Ostatok(db, flGR, sqlJoin7, 7, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin8, 8, sn)
Call CreateFormula_Ostatok(db, flGR, sqlJoin9, 9, sn)

  sql = "update Result set Adr_Dt=mid(Adr_Dt,2),Adr_Kt=mid(Adr_Kt,2) "
  sql = sql & "where Ord<>0"
  db.Execute (sql)
  
  db.Execute ("update Result set col7=null,col8=null where Ord<>0")
  
  
  sql = "select * from Result where Ord in(1,2,3) order by KodSpr,ord "
  Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
  If rs.RecordCount = 0 Then Exit Sub
  rs.MoveLast
  rs.MoveFirst
  
  Set rd = Range("Total_Debet")
  nm = rd.Worksheet.name
  k = rd.Column
  row_Itog = 0
  Set RK = Range("Total_Kredit")
  k1 = RK.Column
  row_Itog1 = 0

'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Set r = Range("DSItog1")
Do Until rs.EOF
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown
  Row = r.Rows.Count - 1
  row_Itog = row_Itog + 1
  row_Itog1 = row_Itog1 + 1
  
'  sql = sqlInsert1
'  sql = sReplace(sql, "col", "")
'  fArr = DelimitedLineToArray(sql, ",")
'  sql = ""
'  For i = LBound(fArr) To UBound(fArr)
'
'  Next i

'  r.Cells(row, 1) = "X"
'  r.Cells(row, 2) = "X"
'  r.Cells(row, 3) = "X"
  
  r.Cells(Row, 1) = "X"
  r.Cells(Row, 2) = IIf(IsNull(rs("col3")), "X", rs("col3"))
  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), "X", rs("col4"))
  r.Cells(Row, 4) = IIf(IsNull(rs("col4")), "X", rs("col5"))
  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), "X", rs("col6"))
  r.Cells(Row, 6) = IIf(IsNull(rs("col7")), 0, rs("col7"))
  r.Cells(Row, 7) = IIf(IsNull(rs("col8")), 0, rs("col8"))
  'r.Cells(row, 7) = "X"
  r.Cells(Row, 8) = IIf(IsNull(rs("col9")), "X", rs("col9"))
  
  
  lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Dt"))), "", Trim(rs("Adr_Dt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
       fArr = Empty
       fArr = CreateArrayFromStoka(Trim(rs("Adr_Dt")), 500)
      
        If IsArray(fArr) Then
           
             If row_Itog < rd.Row Then
               row_Itog = rd.Row
             End If
          '    Rn.Rows(Rn.Rows.Count & ":" & UBound(fArr) + 2).Insert shift:=xlDown
             sql = "=("
             For j = 0 To UBound(fArr)
              If Trim(fArr(j)) <> "" Then
                row_Itog = row_Itog + 1
                ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = "=(" & fArr(j) & ")"
                sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & "+"
              End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog = row_Itog + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Interior.ColorIndex = 38
             
             'sAD = "='" & R.Worksheet.Name & "'!" & R1.Cells(row, 4).Address
             'ActiveWorkbook.Names.Add Name:="End", RefersTo:=sAD
             
             r.Cells(Row, 6).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
        End If
    
    Else
      r.Cells(Row, 6).Formula = "=(" & rs("Adr_Dt") & ")"
    End If
  End If
    
  
  
 lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Kt"))), "", Trim(rs("Adr_Kt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Kt")), 500)
      
        If IsArray(fArr) Then
    
             
             If row_Itog1 < RK.Row Then
               row_Itog1 = RK.Row
             End If

             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
             
             r.Cells(Row, 7).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
        End If
    
    Else
      r.Cells(Row, 7).Formula = "=(" & rs("Adr_Kt") & ")"
    End If
  End If
   
  
  rs.MoveNext

Loop


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sql = "select * from Result where Ord in(4,5,6) order by KodSpr,Ord "

Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
  
  Set rd = Range("TotaLItogD2")
  nm = rd.Worksheet.name
  k = rd.Column
  row_Itog = 0
  Set RK = Range("TotaLItogK2")
  k1 = RK.Column
  row_Itog1 = 0

  
  Set r = Range("DSItog2")
  Do Until rs.EOF
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown
  Row = r.Rows.Count - 1
  row_Itog = row_Itog + 1
  row_Itog1 = row_Itog1 + 1
     
  r.Cells(Row, 1) = "X"
  r.Cells(Row, 2) = IIf(IsNull(rs("col3")), "X", rs("col3"))
  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), "X", rs("col4"))
  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), "X", rs("col5"))
  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), "X", rs("col6"))
  r.Cells(Row, 6) = IIf(IsNull(rs("col7")), 0, rs("col7"))
  r.Cells(Row, 7) = IIf(IsNull(rs("col8")), 0, rs("col8"))
  r.Cells(Row, 8) = IIf(IsNull(rs("col9")), "X", rs("col9"))
  
  
  
  
  lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Dt"))), "", Trim(rs("Adr_Dt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Dt")), 500)
      
        If IsArray(fArr) Then
           
             If row_Itog < rd.Row Then
               row_Itog = rd.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog = row_Itog + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog = row_Itog + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Interior.ColorIndex = 38
             
             r.Cells(Row, 6).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
        End If
    
    Else
      r.Cells(Row, 6).Formula = "=(" & rs("Adr_Dt") & ")"
    End If
  End If


lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Kt"))), "", Trim(rs("Adr_Kt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Kt")), 500)
      
        If IsArray(fArr) Then
    
             
             If row_Itog1 < RK.Row Then
               row_Itog1 = RK.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
             
             r.Cells(Row, 7).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
        End If
    
    Else
      r.Cells(Row, 7).Formula = "=(" & rs("Adr_Kt") & ")"
    End If
  End If

      rs.MoveNext
    Loop
End If


'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sql = "select * from Result where Ord in(7,8,9) order by KodSpr,Ord "
Set rs = db.OpenRecordset(sql, dbOpenSnapshot)
If rs.RecordCount > 0 Then
  rs.MoveLast
  rs.MoveFirst
  
  Set rd = Range("TotaLItogD3")
  nm = rd.Worksheet.name
  k = rd.Column
  row_Itog = 0
  Set RK = Range("TotaLItogK3")
  k1 = RK.Column
  row_Itog1 = 0
  
  Set r = Range("DSItog3")
  Do Until rs.EOF
  Row = r.Row + r.Rows.Count - 1
  Rows(Row).Insert Shift:=xlDown
  Row = r.Rows.Count - 1
  row_Itog = row_Itog + 1
  row_Itog1 = row_Itog1 + 1
  
  r.Cells(Row, 1) = "X"
  r.Cells(Row, 2) = IIf(IsNull(rs("col3")), "X", rs("col3"))
  r.Cells(Row, 3) = IIf(IsNull(rs("col4")), "X", rs("col4"))
  r.Cells(Row, 4) = IIf(IsNull(rs("col5")), "X", rs("col5"))
  r.Cells(Row, 5) = IIf(IsNull(rs("col6")), "X", rs("col6"))
  r.Cells(Row, 6) = IIf(IsNull(rs("col7")), 0, rs("col7"))
  r.Cells(Row, 7) = IIf(IsNull(rs("col8")), 0, rs("col8"))
  r.Cells(Row, 8) = IIf(IsNull(rs("col9")), "X", rs("col9"))
  
  lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Dt"))), "", Trim(rs("Adr_Dt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Dt")), 500)
      
        If IsArray(fArr) Then
           
             If row_Itog < rd.Row Then
               row_Itog = rd.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog = row_Itog + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog = row_Itog + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Interior.ColorIndex = 38
             
             r.Cells(Row, 6).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog, k).Address & ")"
        End If
    
    Else
      r.Cells(Row, 6).Formula = "=(" & rs("Adr_Dt") & ")"
    End If
  End If

lnFrm = Len(IIf(IsNull(Trim(rs("Adr_Kt"))), "", Trim(rs("Adr_Kt")))) '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
  If lnFrm > 0 Then
    
    If lnFrm > 500 Then
      
      fArr = CreateArrayFromStoka(Trim(rs("Adr_Kt")), 500)
      
        If IsArray(fArr) Then
    
             
             If row_Itog1 < RK.Row Then
               row_Itog1 = RK.Row
             End If
             sql = "=("
             For j = 0 To UBound(fArr)
               If Trim(fArr(j)) <> "" Then
                 row_Itog1 = row_Itog1 + 1
                 ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = "=(" & fArr(j) & ")"
                 sql = sql & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & "+"
               End If
             Next j
              
             sql = left(sql, Len(sql) - 1)
             sql = sql & ")"
       
             row_Itog1 = row_Itog1 + 1
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Formula = sql
             ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Interior.ColorIndex = 38
             
             r.Cells(Row, 7).Formula = "=(" & ActiveWorkbook.Sheets(nm).Cells(row_Itog1, k1).Address & ")"
        End If
    
    Else
      r.Cells(Row, 7).Formula = "=(" & rs("Adr_Kt") & ")"
    End If
  End If

      rs.MoveNext
    Loop
End If

''<Spir>19022017 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|.|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd| 4003)
If lnFrm > 500 Then
    ActiveWorkbook.Application.Range("Q:W").EntireColumn.Hidden = True
End If

'db.Close


finnally:
On Error GoTo 0
On Error Resume Next
'ProtectXlt1
'ActiveSheet.OLEObjects("CmdRecalcItog").Object.Enabled = False
Set R1 = Nothing
Set r = Nothing
Set rd = Nothing
Set RK = Nothing
rs.Close
db.Close
Set rs = Nothing
Set db = Nothing
Kill TempPath & "\SvTemp.mdb"
Exit Sub
err125:
If err = 3204 Then
  'Kill "c:\SvTemp.mdb"
  Kill TempPath & "\SvTemp.mdb"
  Set db = DBEngine.CreateDatabase(TempPath & "\SvTemp", dbLangCyrillic)
  err.Clear
  GoTo GoNext
Else
  'MsgBox Error(err)
  'Resume
  err.Clear
  GoTo finnally
End If

End Sub


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
Public Sub DataEndInsert125_1()
Dim s As String
Dim sKodAcc As String
Dim sKodStop As String
Dim Rds As Range
Dim s1 As String, s2 As String, n  As Long, k  As Long, i  As Long


'    F1251VDE Range("Kod_VDE").Cells(1, 1)
    Application.ScreenUpdating = False
    fUnProtect True
        
'    Dim t1 As Date
'    Dim t2 As Date
'    t1 = Time
'    Debug.Print "start |fffd||fffd||fffd||fffd|"; t1

    '' |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| fAddAccount\01.01.2015\GR\=130404000,130406000,120551000
    sKodStop = Range("Kod_STOPdata").Cells(1, 1)
    Select Case plGR
        Case True
            s = sGetINI("fAddAccount\" & sKodStop & "\GR\", "?")
            If s = "?" Then s = sGetINI("fAddAccount\" & sKodStop & "\", "?")
        Case False
            s = sGetINI("fAddAccount\" & sKodStop & "\", "?")
    End Select
    If s = "?" Then s = sGetINI("fAddAccount", "?")
    If s <> "?" Then
        '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        s1 = ","
        s2 = s
        k = UBound(Split(s2, s1)) + 1 '' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
       
'        If k > 2 Then
'            Set Rds = Range("Data_Account")
'            Set Rds = ActiveWorkbook.Sheets(Rds.Worksheet.name).Range("Data_Account")
'            fUnProtect True, Rds.Worksheet.Index
''            ActiveWorkbook.Sheets(Rds.Worksheet.name).Select
'            n = Rds.Row + Rds.Rows.Count - 1
'            Rows(n & ":" & n + k - 3).Insert Shift:=xlDown
'            ActiveWorkbook.Sheets(Range("Kod_STOPdata").Worksheet.name).Select
'        End If
        
        Set Rds = Range("Data_Account")
        For i = 1 To k
            s1 = StrEl(s, i)
            Rds.Cells(i, 1).Value = s1
        Next i
        ActiveWorkbook.Saved = True
    End If
    
    If HasName("Total_Debet") = True Then
      
      sKodAcc = Range("Kod_Account").Cells(1, 1)

      s = sGetINI("flKod\" & sKodAcc & "\", "?")
      If s <> "?" Then '128|fffd|
        Call F125_1_Itogo128
      Else
'        Call F125_1_newItogo
      End If
    
    Else
      fAddAccount_1
      F125_1Itogo "FromForm"
    End If

'    t2 = Time
'    Debug.Print "finish |fffd||fffd||fffd||fffd|"; t2
'    'MsgBox "|fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & DateDiff("n", t2, t1) & " |fffd||fffd||fffd||fffd||fffd|(|fffd|)"
'    Debug.Print "|fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| "; DateDiff("n", t2, t1); " |fffd||fffd||fffd||fffd||fffd|(|fffd|)"
    
    Application.ScreenUpdating = True
    fUnProtect False
    HideDSBeforePrint
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub f125_1ItogoCB()
Dim s As String
Dim sKodAcc As String

    Application.ScreenUpdating = False
    fUnProtect True
    
'    fAddAccount
'    fCleare
'    F1251Itogo
'---------------------------------------------------31.10.2008
   If HasName("Total_Debet") = False Then
      fAddAccount
      fCleare
      F125_1Itogo
   Else
     sKodAcc = Range("Kod_Account").Cells(1, 1)
     s = sGetINI("flkod\" & sKodAcc & "\", "?")
     If s <> "?" Then '128|fffd|
       Call F125_1_Itogo128
     Else
'       Call F1251_newItogo
     End If
   End If
'---------------------------------------------------31.10.2008
    fUnProtect False
    Application.ScreenUpdating = True
End Sub


'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd|.|fffd|. |fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub fAddAccount_1()
Dim r As Range, i As Long, s$
Set r = Range("Data_Sheet1")
If r.Rows.Count < 3 Then Exit Sub
For i = 2 To r.Rows.Count - 1
    s = r.Cells(i, 7)
    r.Cells(i, 7) = left$(s, 17) & left(Range("Kod_Account").Cells(1, 1).Value, 7) & Right$(s, 3)
Next i
Set r = Nothing
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'Public Sub F125_1Itogo1(Optional FromForm As String)
'Dim R As Range, R1 As Range, i%, sKodAcc$, row0%, Row%
'Dim sFormula$, rname$, s$, sKod$, sKodAccDt$, sAd$, sAdKt$, sAdDt$, s1$
'Dim sGr$, sGr1$, sGr2$, sGr3$, sAccCode$
'Dim fl125new%
''|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd|
'If HasName("dsF") Then fl125new = 1
's1 = sGetINI("Calculate", "?")
'If s1 <> "?" Then fl125new = 2
'If FromForm = "FromForm" And fl125new = 2 Then Exit Sub
'If Not HasName("DSItog1") Then Exit Sub
'If Not HasName("DSItog2") Then Exit Sub
'If Not HasName("DSItog3") Then Exit Sub
'
'Set R = Range("Data_Sheet1")
'
'sKodAcc = Range("Kod_Account").Cells(1, 1)
'sGr1 = sGetINI("DSItog1.Group\" & sKodAcc & "\", "?")
'sGr2 = sGetINI("DSItog2.Group\" & sKodAcc & "\", "?")
'sGr3 = sGetINI("DSItog3.Group\" & sKodAcc & "\", "?")
'
'
'For i = 2 To R.Rows.Count - 1
''|fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd|
'row0 = R.Row + i - 1 ' |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| Data_Sheet1
'If sGr1 = "?" Then GoTo A1
's = "= " & sReplace(sGr1, "R", "R" & Trim$(str(row0)))
''|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'ActiveSheet.Cells(1, 10).Clear
'ActiveSheet.Cells(1, 10).Formula = s
'sKod = "ww" & ActiveSheet.Cells(1, 10).Value     ' sKod = "w" & R.Cells(i, 3) & R.Cells(i, 4) & sKodAcc
'    If HasName(sKod) = False Then
'        Set R1 = Range("DSItog1")
'        Row = R1.Row + R1.Rows.Count - 1    '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| DSItog1
'        Rows(Row).Insert Shift:=xlDown
'        Row = R1.Rows.Count - 1
'        If R1.Cells(1, 1) <> "X" Then R1.Cells(Row, 1) = R.Cells(i, 3) Else R1.Cells(Row, 1) = "X"
'        If R1.Cells(1, 2) <> "X" Then R1.Cells(Row, 2) = R.Cells(i, 4) Else R1.Cells(Row, 2) = "X"
'        If R1.Cells(1, 3) <> "X" Then R1.Cells(Row, 3) = R.Cells(i, 5) Else R1.Cells(Row, 3) = "X"
'        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'        sAccCode = fAccItogKode(sGr1, row0)
'        R1.Cells(Row, 4) = IIf(Len(sAccCode) = 0, sKodAcc, sAccCode)
'        sAd = "='" & R.Worksheet.name & "'!" & R1.Cells(Row, 4).Address
'        ActiveWorkbook.Names.Add name:=sKod, RefersTo:=sAd
'        sAdDt = R1.Cells(Row, 8).Address
'        sAdKt = R1.Cells(Row, 9).Address
'        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'        sFormula = sGetINI("DSItog1.Dt", "0")
'        If sFormula <> "0" Then R1.Cells(Row, 5).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
'        sFormula = sGetINI("DSItog1.Kt", "0")
'        If sFormula <> "0" Then R1.Cells(Row, 6).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
'        R1.Cells(Row, 7) = "X"
'        If fl125new = 1 Then AddColumn125 sKod
'    End If
'If fl125new = 1 Then InsFormula125 sKod, i, R.Cells(i, 7)
'If fl125new = 0 Then
'    InsFormula Range(sKod).Cells(1, 1).Offset(0, 4), R.Cells(i, 7)
'    InsFormula Range(sKod).Cells(1, 1).Offset(0, 5), R.Cells(i, 8)
'End If
'If fl125new = 2 Then
'    Calculate125 Range(sKod).Cells(1, 1).Offset(0, 4), R.Cells(i, 7)
'    Calculate125 Range(sKod).Cells(1, 1).Offset(0, 5), R.Cells(i, 8)
'End If
'A1:
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'If IfMoney(R.Cells(i, 9)) Then rname = "DSItog2" Else rname = "DSItog3"
'If rname = "DSItog2" Then If sGr2 = "?" Then GoTo A2 Else sGr = sGr2
'If rname = "DSItog3" Then If sGr3 = "?" Then GoTo A2 Else sGr = sGr3
'
's = "= " & sReplace(sGr, "R", "R" & Trim$(str(row0)))
'ActiveSheet.Cells(1, 10).Clear
'ActiveSheet.Cells(1, 10).Formula = s
'sKod = "ww" & ActiveSheet.Cells(1, 10).Value 'sKod = sKod & R.Cells(i, 9)
'If HasName(sKod) = False Then
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|-|fffd||fffd|
'    If IfMoney(R.Cells(i, 9)) Then rname = "DSItog2" Else rname = "DSItog3"
'    Set R1 = Range(rname)
'    Row = R1.Row + R1.Rows.Count - 1
'    Rows(Row).Insert Shift:=xlDown
'    Row = R1.Rows.Count - 1
'        If R1.Cells(1, 1) <> "X" Then R1.Cells(Row, 1) = R.Cells(i, 3) Else R1.Cells(Row, 1) = "X"
'        If R1.Cells(1, 2) <> "X" Then R1.Cells(Row, 2) = R.Cells(i, 4) Else R1.Cells(Row, 2) = "X"
'        If R1.Cells(1, 3) <> "X" Then R1.Cells(Row, 3) = R.Cells(i, 5) Else R1.Cells(Row, 3) = "X"
'    sAccCode = fAccItogKode(sGr, row0)
'    R1.Cells(Row, 4) = IIf(Len(sAccCode) = 0, sKodAcc, sAccCode)
'    R1.Cells(Row, 7) = R.Cells(i, 9) '|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'    sAd = "='" & R.Worksheet.name & "'!" & R1.Cells(Row, 4).Address
'    ActiveWorkbook.Names.Add name:=sKod, RefersTo:=sAd
'    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'    sAdDt = R1.Cells(Row, 8).Address
'    sAdKt = R1.Cells(Row, 9).Address
'    sFormula = sGetINI(rname & ".Dt", "0")
'    If sFormula <> "0" Then R1.Cells(Row, 5).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
'    sFormula = sGetINI(rname & ".Kt", "0")
'    If sFormula <> "0" Then R1.Cells(Row, 6).Formula = fRepFormula(sFormula, sAdDt, sAdKt)
'    If fl125new = 1 Then AddColumn125 sKod
'End If
'If fl125new = 1 Then InsFormula125 sKod, i, R.Cells(i, 7)
'If fl125new = 0 Then
'    InsFormula Range(sKod).Cells(1, 1).Offset(0, 4), R.Cells(i, 7)
'    InsFormula Range(sKod).Cells(1, 1).Offset(0, 5), R.Cells(i, 8)
'End If
'If fl125new = 2 Then
'    Calculate125 Range(sKod).Cells(1, 1).Offset(0, 4), R.Cells(i, 7)
'    Calculate125 Range(sKod).Cells(1, 1).Offset(0, 5), R.Cells(i, 8)
'End If
'A2:
'Next i
''R1.Cells(R1.row + 1, 1).Offset(0, -1) = "|fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd|:"
'Set R1 = Nothing
'Set R = Nothing
'End Sub
'
'

Attribute VB_Name = "modF169n"
' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|169 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|) 01.01.2011
'Public Declare Function SetArray Lib "rascrtgr" (ByRef paVal As Variant) As Variant

Public objCreateGr As Object

Sub addRowF169n(sKod$, r As Range, Optional Row As Long)

Dim idForm$
idForm = UCase(sGetINI("idForm", "?"))

'|fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd|
'' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| 169  10.11.2015
'r.Cells(Row, 1) = Mid$(sKod, 3, 26)
If idForm = "169N2015" Then
    If left(sKod, 2) = "01" Or left(sKod, 2) = "04" Then r.Cells(Row, 1) = Mid$(sKod, 3, 3) & " " & Mid$(sKod, 6, 10) & " " & Mid$(sKod, 16, 4) & " " & Mid$(sKod, 20, 9)
    If left(sKod, 2) = "02" Or left(sKod, 2) = "05" Then r.Cells(Row, 1) = Mid$(sKod, 3, 3) & " " & Mid$(sKod, 6, 4) & " " & Mid$(sKod, 10, 7) & " " & Mid$(sKod, 17, 3) & " " & Mid$(sKod, 20, 9)
    If left(sKod, 2) = "03" Or left(sKod, 2) = "06" Then r.Cells(Row, 1) = Mid$(sKod, 3, 3) & " " & Mid$(sKod, 6, 10) & " " & Mid$(sKod, 16, 4) & " " & Mid$(sKod, 20, 9)
End If
If idForm = "169N2016" Then
    If left(sKod, 2) = "01" Or left(sKod, 2) = "04" Then r.Cells(Row, 1) = Mid$(sKod, 3, 10) & " " & Mid$(sKod, 13, 4) & " " & Mid$(sKod, 17, 3) & " " & Mid$(sKod, 20, 9)
    If left(sKod, 2) = "02" Or left(sKod, 2) = "05" Then r.Cells(Row, 1) = Mid$(sKod, 3, 4) & " " & Mid$(sKod, 7, 10) & " " & Mid$(sKod, 17, 3) & " " & Mid$(sKod, 20, 9)
    If left(sKod, 2) = "03" Or left(sKod, 2) = "06" Then r.Cells(Row, 1) = Mid$(sKod, 3, 14) & " " & Mid$(sKod, 17, 3) & " " & Mid$(sKod, 20, 9)
    If left(sKod, 2) = "10" Or left(sKod, 2) = "11" Then r.Cells(Row, 1) = Mid$(sKod, 3, 9)
    ''<Spir>30.01.2019 #7848
    If left(sKod, 2) = "07" Then r.Cells(Row, 1) = Mid$(sKod, 3, 10) & " " & Mid$(sKod, 13, 4) & " " & Mid$(sKod, 17, 3) & " " & Mid$(sKod, 20, 9)
    If left(sKod, 2) = "08" Then r.Cells(Row, 1) = Mid$(sKod, 3, 4) & " " & Mid$(sKod, 7, 10) & " " & Mid$(sKod, 17, 3) & " " & Mid$(sKod, 20, 9)
End If
If Not (idForm = "169N2015" Or idForm = "169N2016") Then
    r.Cells(Row, 1) = Mid$(sKod, 3, 26)
End If
'|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If (idForm = "169N2015" Or idForm = "169N2016") And (Mid(r.name, 11, 2) = "04" Or Mid(r.name, 11, 2) = "05" Or Mid(r.name, 11, 2) = "06") Then
    r.Cells(Row, 3) = Mid$(sKod, 29, 2) & "." & Mid$(sKod, 31, 4)
End If
'29032017 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If (idForm = "169N2015" Or idForm = "169N2016") And (Mid(r.name, 11, 2) = "04" Or Mid(r.name, 11, 2) = "05" Or Mid(r.name, 11, 2) = "06") Then
    If Len(sKod) = 52 Then r.Cells(Row, 4) = Mid$(sKod, 35, 2) & "." & Mid$(sKod, 37, 4)
End If
If idForm = "169N2013" Then
    r.Cells(Row, 3) = Mid$(sKod, 29, 4)
End If
If idForm = "169N" Then
    r.Cells(Row, 4) = Mid$(sKod, 29, 4)
End If
'R.Cells(Row, 3) = Mid$(sKod, 29, 4)
'R.Cells(Row, 4) = Mid$(sKod, 29, 4)

'fNameForDSandCells R, sKod, row, "1"

''<Spir>20.06.2016 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd|169
fNameForDSandCells_F r, sKod, Row
'fNameForDSandCells r, sKod, Row
End Sub

Public Function F169ItogoN() As Long

    'Option Base 0
    
    On Error GoTo errHandler
    
    'Dim objCreateGr As Object
    Dim txt As String, lCreateCurs$, lCreateGr1$, lCreateGr2$, cTitle$, cDataGr$, cDataItog$, cDataItog1$, cNamePrg$
    Dim n As Variant, i As Long, k As Long, lRows As Long, lCount As Long, j As Long, Row As Long
    Dim arr() As Variant, arrC() As Variant, arrGr() As Variant
    Dim lRange As Range, lRangeI As Range
    Dim oApp As Object
    Dim lSaved As Boolean
    
    lSaved = ActiveWorkbook.Saved
    ''05.06.2014 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set objCreateGr = goSvod.oCreateGroup
'    Set objCreateGr = CreateObject("rascrtgr.clsCreateGroup")

    'Application.Run (ActiveWorkbook.Name!fItogoGr)
        
    cTitle = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
'    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'    fUnProtect True
'    n = fCreateCurs
'    fUnProtect False

    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If Not HasName("DSItog1") Then MsgBox ("|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| DSItog1"): Exit Function
    If Not HasName("DSItog2") Then MsgBox ("|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| DSItog2"): Exit Function
    If Not HasName("Itog1") Then MsgBox ("|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| Itog1"): Exit Function
    If Not HasName("Itog2") Then MsgBox ("|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| Itog2"): Exit Function
    
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    For j = 1 To 2
    
      If j = 1 Then
        cDataItog = "DSItog1"
        cDataItog1 = "Itog1"
        cNamePrg = "fGetItog1_169"
      Else
        cDataItog = "DSItog2"
        cDataItog1 = "Itog2"
        cNamePrg = "fGetItog2_169"
      End If
      
      ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
      cDataGr = sGetINI(cDataItog & ".DataGr", "?")
      If cDataGr = "?" Then
          n = MsgBox("|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| lnc2.ini (DataGr)", vbOKOnly, cTitle)
          GoTo errHandler
      End If
      
      '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
      lCreateCurs = sGetINI(cDataItog & ".CreateCurs", "?")
      If lCreateCurs <> "?" Then
          n = objCreateGr.CreateCursor(lCreateCurs)
          If Not IsNumeric(n) Then
              n = MsgBox(objCreateGr.cErrorTextMessage, vbOKOnly, cTitle)
              GoTo errHandler
          End If
      End If
    
      lCreateCurs = sGetINI(cDataItog & ".CreateArray", "?")   '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
      If lCreateCurs <> "?" Then
          n = Val(StrEl(lCreateCurs))
          'ReDim arr(0, 1 To n)
          
          ' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
          ReDim arrC(n)
          For i = 1 To n
              arrC(i) = Val(StrEl(lCreateCurs, i))
          Next i
          
          Set lRange = ActiveWorkbook.Application.Range(cDataGr)
          lRows = lRange.Rows.Count
          '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
          lCount = 0
          For i = 1 To lRows   '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
              If Trim(Len(lRange.Cells(i, 1))) <> 0 Then
                  lCount = lCount + 1
              End If
          Next i
          ReDim arr(1 To lCount, 1 To n)
          'Dim arr(1 To lCount, 1 To n)
         
          ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
          lCount = 0
          For i = 1 To lRows   '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
              If Trim(Len(lRange.Cells(i, 1))) <> 0 Then
                  lCount = lCount + 1
                  For k = 1 To n  '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                      If IsEmpty(lRange.Cells(i, arrC(k))) Then
                        arr(lCount, k) = 0 '25.01.2011
                     Else
                        arr(lCount, k) = lRange.Cells(i, arrC(k)) '25.01.2011
                      End If
                  Next k
              End If
          Next i
      End If
      
      ' |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|c|fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
      If lCount > 0 Then
          n = objCreateGr.GetArrayToCursor(arr)
          If Not IsNumeric(n) Then
              n = MsgBox(objCreateGr.cErrorTextMessage, vbOKOnly, cTitle)
              GoTo errHandler
          End If
      End If
      
      lCreateGr1 = sGetINI(cDataItog & ".CreateGroup1", "?")
      If lCreateGr1 = "?" Then
          GoTo errHandler
      End If
      lCreateGr2 = sGetINI(cDataItog & ".CreateGroup2", "?")
      If lCreateGr2 = "?" Then
          GoTo errHandler
      End If
      
      'lCreateGr1 = "SELECT '1' as n,SUBSTR(s1,18,4)+'00000' as gr1, s1+s4 as gr, s1, CAST(0 as f(16,2)) as s2, SUM(s3) as s3, s4 FROM curItog  GROUP BY s1,s4 WHERE not EMPTY(s4) INTO CURSOR curItog1 ORDER BY 2,1 UNION select '1' as n,SUBSTR(s1,18,4)+'00000' as gr1, s1 as gr, s1, SUM(s2) as s2, SUM(s3) as s3, CAST('' as c(4)) as s4 FROM curItog  GROUP BY s1 UNION select '2' as n,SUBSTR(s1,18,4)+'00000' as gr1, SUBSTR(s1,18,4)+'00000' as gr, SUBSTR(s1,18,4)+'00000' as s1, SUM(s2) as s2, SUM(s3) as s3, CAST('' as c(4)) as s4 FROM curItog  GROUP BY gr UNION SELECT '3' as n,SUBSTR(s1,18,4)+'00000' as gr1, SUBSTR(s1,18,4)+'00000' as gr, SUBSTR(s1,18,4)+'00000' as s1, CAST(0 as f(16,2)) as s2, SUM(s3) as s3, s4 FROM curItog  GROUP BY gr,s4 WHERE not EMPTY(s4)"
      ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
      n = objCreateGr.CreateGroupCursor169(lCreateGr1, lCreateGr2)
      If Not IsNumeric(n) Then
          n = MsgBox(objCreateGr.cErrorTextMessage, vbOKOnly, cTitle)
          GoTo errHandler
      End If
      
      'Call objCreateGr.SetArray(byref arr)
      
'      If IsArray(objCreateGr.arrGr) Then
'          n = 10
'      End If
      
     fUnProtect True
     Application.ScreenUpdating = False
      
    '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
      'Set lRangeI = ActiveWorkbook.Application.Range(cDataItog)
      Set lRangeI = Range(cDataItog1)
    'Set r = Range("DSItog1")
      If lRangeI.Rows.Count > 2 Then
         Row = lRangeI.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
         i = Row + lRangeI.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
         Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
      End If
        
     '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
       'Set lRangeI = ActiveWorkbook.Application.Range(cDataItog)
       For i = 1 To n - 2
            lCount = lRangeI.Rows.Count
            lRangeI.Cells(lCount, 1).EntireRow.Insert Shift:=xlShiftDown
        Next i
      
      ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
      Set oApp = ActiveWorkbook.Application
      Call objCreateGr.GetObjectApp(oApp, "!" & cNamePrg, cDataItog1)
      If Not IsNumeric(objCreateGr.vReturt) Then
          n = MsgBox(objCreateGr.cErrorTextMessage, vbOKOnly, cTitle)
          GoTo errHandler
      End If
      
      Application.ScreenUpdating = True
      fUnProtect False
      ActiveWorkbook.Saved = lSaved
      
  Next j
    
    
Exit Function

errHandler:
    'F169ItogoN = objCreateGr.cErrorTextMessage
    F169ItogoN = 0
End Function

Public Function fGetItog1_169() As Variant

Dim i As Long, j As Long, nRows As Long, nRowDS As Long
Dim RangeItog As Range, RangeItog1 As Range
Dim cKod$, cPref$
Dim lPrint As Boolean
    
     Set RangeItog = Range("DSItog1")
     Set RangeItog1 = Range("Itog1")
     
    '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
      If RangeItog.Rows.Count > 2 Then
         Row = RangeItog.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
         i = Row + RangeItog.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
         Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
      End If
      
     cKod = " "
     nRowDS = 0
     For i = 1 To RangeItog1.Rows.Count
        If RangeItog1.Cells(i, 2) <> 0 Or RangeItog1.Cells(i, 3) <> 0 Then
            nRowDS = nRowDS + 1
            nRows = RangeItog.Rows.Count
            If i >= 2 Then
                RangeItog.Cells(nRows, 1).EntireRow.Insert Shift:=xlShiftDown
                nRows = RangeItog.Rows.Count
            End If
            For j = 1 To RangeItog1.Columns.Count
                 cPref = ""
                 lPrint = True
                 If j = 1 Then
                    If cKod <> RangeItog1.Cells(i, 1) Then
                       cKod = RangeItog1.Cells(i, 1)
                       If Len(Trim(cKod)) > 9 Then
                           cPref = "|fffd||fffd||fffd||fffd||fffd|: "
                       Else
                           cPref = "|fffd||fffd||fffd||fffd||fffd|: "
                       End If
                       
                    Else
                       lPrint = False
                    End If
                 End If
                 If lPrint Then
                    RangeItog(nRows - 1, j) = cPref & RangeItog1.Cells(i, j)
                 End If
            Next j
            
       End If
     Next i
   
    fGetItog1_169 = 0
    
End Function

Public Function fGetItog2_169() As Variant

Dim i As Long, j As Long, nRows As Long, nRowDS As Long
Dim RangeItog As Range, RangeItog1 As Range
Dim cKod$
Dim lPrint As Boolean
    
     Set RangeItog = Range("DSItog2")
     Set RangeItog1 = Range("Itog2")
     
    '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
      If RangeItog.Rows.Count > 2 Then
         Row = RangeItog.Row '1-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
         i = Row + RangeItog.Rows.Count - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
         Rows(Row + 1 & ":" & i - 1).Delete Shift:=xlUp
      End If
      RangeItog.Cells(1, 1) = 0
      RangeItog.Cells(1, 2) = ""
      RangeItog.Cells(2, 1) = 0
      RangeItog.Cells(2, 2) = ""
     
      '01.02.2011 |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
      If Range("Itog2").Cells(1, 1) = Val(Range("Itog1").Cells(1, 1)) Then
        'i = MsgBox("hh")
        GoTo A1:
      End If
      
     cKod = " "
     nRowDS = 0
     For i = 1 To RangeItog1.Rows.Count
        If RangeItog1.Cells(i, 2) <> 0 Or RangeItog1.Cells(i, 3) <> 0 Then
            nRowDS = nRowDS + 1
            nRows = RangeItog.Rows.Count
            If i >= 2 Then
                RangeItog.Cells(nRows, 1).EntireRow.Insert Shift:=xlShiftDown
                nRows = RangeItog.Rows.Count
            End If
            For j = 1 To RangeItog1.Columns.Count
                 lPrint = True
'                 If j = 1 Then
'                    If cKod <> RangeItog1.Cells(i, 1) Then
'                       cKod = RangeItog1.Cells(i, 1)
'                    Else
'                       lPrint = False
'                    End If
'                 End If
                 If lPrint Then
                    RangeItog(nRows - 1, j) = RangeItog1.Cells(i, j)
                 End If
            Next j
            
       End If
     Next i
   
A1:
    fGetItog2_169 = 0
    
End Function

Attribute VB_Name = "modFormatAndFilter"
Option Explicit

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| Data_XXX
Public Sub fSaveFilterAndFormat()
Dim sTipeSp$, n As Long, j As Long, sSp$, i1 As Long, i2 As Long, sF$, a As Variant
Dim i As Long, s$
On Error GoTo err
a = Array("Filter", "Format")
'-----------01.12.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Filter |fffd| Format
'For i = 0 To 1
For i = 0 To 2
s = a(i)
sTipeSp = sGetINI(s, "?")
If i = 1 And sTipeSp = "?" Then sR = " "  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If sTipeSp = "?" Then GoTo a2
n = StrEl(sTipeSp)
For j = 1 To n
    sSp = StrEl(sTipeSp, j)
    If Not sSp Like "*Data_*" Then GoTo A1
    i1 = InStr(sSp, "(")
    i2 = InStr(sSp, ")")
    If i2 <= i1 Then GoTo A1
    sF = Mid$(sSp, i1 + 1, i2 - i1 - 1)
    If Len(sR) = 0 Then sR = left$(sReplace(sF, "0", ""), 1)  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    sSp = Trim$(left$(sSp, i1 - 1)) '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If EmptyName(sSp) > 0 Then
        fData_Copy sSp
        If i = 1 Then Range(sSp).Cells(1, 1).Offset(-1, 3).Value = sF
        Range(sSp).Cells(1, 1).Offset(-i, 3).Value = sF
        If i = 0 Then fData_Filter sSp, sF
        If i = 1 Then fData_Format sSp, sF
    End If
A1:
Next j
a2:
Next i
err:
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Data_*
Public Sub fData_Copy(ByVal sRangeName As String, Optional fl As Boolean = False)
Dim r2 As Range, r As Range, sNewRangeName As String
Dim i  As Long, s As String, sAdr$

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Data_XXX1 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| c |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sNewRangeName = sRangeName & "1"
If HasName(sNewRangeName) And fl = False Then Exit Sub
'If HasName(sNewRangeName) Then ActiveWorkbook.Names(sNewRangeName).Delete
Set r = Range(sRangeName)
Set r2 = r.Cells(1, 1).Offset(0, 4)
sAdr = "='" & r.Worksheet.name & "'!" & r2.Address & ":"
sAdr = sAdr & r.Cells(1, 3).Offset(r.Rows.Count - 1, r.Columns.Count + 1).Address
ActiveWorkbook.Names.Add name:=sNewRangeName, RefersTo:=sAdr
r.Copy r2
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Set r2 = Range(r.Cells(1, 1).Offset(-2, 0), r.Cells(1, 1).Offset(-1, 2))
r2.Copy r.Cells(1, 1).Offset(-2, 4)
Set r = Nothing
Set r2 = Nothing
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub fData_Format(ByVal sRangeName As String, Optional ByVal sFormat As String = "")
Dim r2 As Range, sNewRangeName As String, i  As Long, s As String
Dim sAdr As String
sNewRangeName = sRangeName & "1"
If Len(sFormat) > 0 Then
    Set r2 = Range(sNewRangeName)
    For i = 1 To r2.Rows.Count
        s = r2.Cells(i, 1)
        If Len(s) > 0 Then
            s = Format$(s, sFormat)
            r2.Cells(i, 1) = s
        End If
    Next i
End If
Set r2 = Nothing
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Mid
Public Sub fData_Filter(ByVal sRangeName As String, Optional ByVal sFilter As String = "", Optional ByVal k As Long = 0, Optional ByVal n As Long = 0)
Dim r As Range, R1 As Range, sNewRangeName As String
Dim i  As Long ', s As String

sNewRangeName = sRangeName & "1"
Set r = Range(sRangeName)
Set R1 = Range(sNewRangeName)

For i = r.Rows.Count To 1 Step -1
    If ((Len(sFilter) > 0) And (Not r.Cells(i, 1) Like sFilter)) Then
        R1.Rows(i).Delete Shift:=xlUp
'    Else
'        If k <> 0 Then s = IIf(n > 0, Mid$(R.Cells(i, 1), k, n), Mid$(R.Cells(i, 1), k))
'        R.Cells(i, 1) = s
    End If
Next i
Set r = Nothing
Set R1 = Nothing

End Sub

''
'Public Function fFormat(ByVal sKod$, Optional ByVal sSp$ = "") As String
'Dim sF$, sR$
'On Error GoTo err
'If Len(sSp) = 0 Or sSp Like "Data_TXT*" Then fFormat = sKod: Exit Function
'sF = Range(sSp).Cells(1, 1).Offset(-1, 3).Value
'If Len(sF) = 0 Then fFormat = sKod: Exit Function
'sR = left$(sReplace(sF, "0", ""), 1)
'sF = sReplace(sF, sR, "'")
'sKod = Format$(sKod, sF)
'sKod = sReplace(sKod, "'", sR)
'err:
'fFormat = sKod
'End Function
'
'
Public Function fDelFormat(ByVal sKod$) As String
    Dim sF$, sR$
    sKod = sReplace(sKod, " ", "")
    If Len(sR) = 0 Then GoTo A1
    sKod = sReplace(sKod, sR, "")
A1:
fDelFormat = sKod
End Function
Attribute VB_Name = "modNamesanketa"

Public Sub fDelNames()
Dim a As name, r As Range, s$
Dim i As Long
Set r = Range("Data_Cells")
fUnProtect True, r.Worksheet.Index

For Each a In ActiveWorkbook.Names
    s = a.name
    'If s Like "Data_Sheet*" Then a.Delete
    'If s Like "Data_s??" Then a.Delete
    If s Like "ss*" Then
        a.Delete
        For i = r.Rows.Count To 1 Step -1
            If r.Cells(i, 1) Like s Then r.Rows(i).Delete Shift:=xlUp
        Next i
    End If
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Data_Cells
    'ClearData_Cells
Next
MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
End Sub

Public Sub ClearData_Cells()
Dim r As Range, i As Long
r = Range("Data_Cells")
If r.Rows.Count < 3 Then Exit Sub
For i = r.Rows.Count - 1 To 2 Step -1
        r.Rows(i).Delete Shift:=xlUp
        Next i
End Sub

'|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| DataSheetXX

Public Sub fInsertssYY()
Dim Row As Long
Dim a As name, r As Range, s As String, s1$, j As Long, s2$, s0$
Dim sname$, sAd$, fl As Boolean
For Each a In ActiveWorkbook.Names
    s = a.name
    If s Like "Data_Sheet*" Then
        Row = 1
        s1 = Mid$(a.name, 11)
        s2 = Format(Row, "000")
        Set r = Range(s)
        
        For j = 1 To r.Columns.Count
            '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| True |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
            fl = False
            If r.Cells(1, j).MergeCells = True Then
                If s0 = r.Cells(1, j).MergeArea.Address Then fl = True
                s0 = r.Cells(Row, j).MergeArea.Address
            Else
                s0 = ""
            End If
            If fl = False Then
                sname = "ss" & s1 & s2 & Chr(96 + j)
                sAd = "='" & r.Worksheet.name & "'!" & r.Cells(1, j).Address
                ActiveWorkbook.Names.Add name:=sname, RefersTo:=sAd
                fSaveData_Cells sname, r.Cells(Row, j).NumberFormat
            End If
        Next j
    End If
Next
MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
End Sub

Public Sub fInsert00()
Dim a As Worksheet, i As Long, j As Long, s0$, s2$, Row As Long
Dim fl As Boolean, fl1 As Boolean, k As Long

Row = 1
For Each a In ActiveWorkbook.Sheets
 If (a.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or a.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|") Then GoTo A1
 For i = 1 To 200
    fl1 = False
    s2 = Format(Row, "000")
    k = 1
    For j = 1 To 30
        If a.Cells(i, j).Interior.ColorIndex = 35 Or a.Cells(i, j).Interior.ColorIndex = 34 Then
            fl = False
            If j = 1 Then GoTo a2   '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| Data_Sheet
            If a.Cells(i, j).MergeCells = True Then fl = Not IsFirstMarge(a.Cells(i, j))
                    'True |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
            If Len(fCellsName(a.Cells(i, j))) > 0 Then fl = True

            If fl = False Then
                fl1 = True
                sname = "ss00" & s2 & Chr(96 + k)
                sAd = "='" & a.name & "'!" & a.Cells(i, j).Address
                ActiveWorkbook.Names.Add name:=sname, RefersTo:=sAd
                fSaveData_Cells sname, a.Cells(i, j).NumberFormat
                k = k + 1
            End If
        End If
    Next j
    If fl1 = True Then Row = Row + 1
a2:
 Next i
A1:
Next
MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
End Sub


Public Sub fProt()
'ProtectXlt1
'ActiveWorkbook.Worksheets(1).Name "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 1"
End Sub

Public Function IsFirstMarge(r As Range)
Dim sAdress$, fl As Boolean
sAdress = r.Address
If sAdress <> r.MergeArea.Offset(0, 0).Address Then fl = False Else fl = True
IsFirstMarge = fl
End Function
Attribute VB_Name = "modSaveToFile"

Public Sub fSaveFile()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| Reference |fffd| |fffd||fffd||fffd||fffd||fffd| xlt
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim Filename$
Application.Visible = False
Application.DisplayAlerts = False
Filename = Dir$(ThisWorkbook.Path & "\" & "*.xlt")
While Filename <> ""
    'fSaveReference (Filename)
    'fFromModule Filename
    'fSaveSheetActivate (Filename)
    'fSaveBeforeClose Filename
    'fDeleteCode Filename
    'fRemoveModule Filename
Filename = Dir$
Wend
MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
Application.Visible = True
End Sub

Public Function fSaveReference(ByVal Filename As String)
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| xla
Filename = ThisWorkbook.Path & "\" & Filename
Workbooks.Open Filename:=Filename, Editable:=True
On Error Resume Next
Application.ScreenUpdating = False
' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Application.VBE.ActiveVBProject.References.AddFromFile ThisWorkbook.Path & "\" & "lnc2.xla"
If err <> 0 Then Debug.Print Filename & " " & err.Number & " |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": GoTo A1
ActiveWorkbook.Save '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " & Filename & " |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
A1:
ActiveWorkbook.Close
End Function

Public Sub fSaveSheetActivate(ByVal Filename As String)
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| Worksheet_Activate
Dim WN(20) As String

Dim sname As String
Application.ScreenUpdating = False
Filename = ThisWorkbook.Path & "\" & Filename

Workbooks.Open Filename:=Filename, Editable:=True

On Error GoTo A1

s = "Private Sub Workbook_Open()" & vbCrLf
s = s & "Dim s$" & vbCrLf
s = s & "On Error Resume next" & vbCrLf
'SaveSetting "Aksiok", "Xlt", "Path", "c:\Aksiok\Prg\VSvod\Xlt"
's = s & "s = GetSetting(""Aksiok"", ""Xlt"", ""Path"", ""C:\Aksiok\Prg\VSvod\Xlt"")" & vbCrLf
s = s & "s = GetRegistrValue & ""lnc2.xla""" & vbCrLf
's = s & "s = s &  ""\lnc2.xla""" & vbCrLf
s = s & "Application.VBE.ActiveVBProject.References.AddFromFile s" & vbCrLf
s = s & "Application.Run ""lnc2.xla!fOpen""" & vbCrLf
s = s & "Application.Run ""lnc2.xla!cmdBarsShow""" & vbCrLf
s = s & "End Sub" & vbCrLf
If ActiveWorkbook.VBProject.VBComponents(gcCodeName).CodeModule.Find("Private Sub Workbook_Open()", 1, 1, -1, -1) = False Then
    With ActiveWorkbook.VBProject.VBComponents(gcCodeName).CodeModule
        NextLine = .CountOfLines + 1
       .InsertLines NextLine, s
    End With
End If
s = "Private Sub Worksheet_Activate()" & vbCrLf
s = s & "On Error Resume next" & vbCrLf
's = s & "Application.Run ""lnc2.xla!cmdBarsShow""" & vbCrLf
s = s & "cmdBarsShow" & vbCrLf
s = s & "End Sub" & vbCrLf
For Each a In ActiveWorkbook.Sheets
 If Not (a.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or a.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|") And a.Visible = True Then
     WN(i) = a.CodeName
     i = i + 1
 End If
Next
For i = 0 To 9
sname = WN(i)
If Len(sname) > 0 Then
   If ActiveWorkbook.VBProject.VBComponents(sname).CodeModule.Find("Worksheet_Activate()", 1, 1, -1, -1) = False Then
         With ActiveWorkbook.VBProject.VBComponents(sname).CodeModule
             NextLine = .CountOfLines + 1
            .InsertLines NextLine, s
         End With
    End If
End If
Next

'fFromModule

ActiveWorkbook.Save
Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " & Filename & " |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
A1: ActiveWorkbook.Close
End Sub

Public Sub fDeleteCode(Filename$)
Dim r As Long, t As Long
On Error GoTo A1
Filename = ThisWorkbook.Path & "\" & Filename
Workbooks.Open Filename:=Filename, Editable:=True
Application.ScreenUpdating = False

r = ActiveWorkbook.VBProject.VBComponents(gcCodeName).CodeModule.ProcCountLines("Workbook_Open", vbext_pk_Proc)
t = ActiveWorkbook.VBProject.VBComponents(gcCodeName).CodeModule.ProcStartLine("Workbook_Open", vbext_pk_Proc)
ActiveWorkbook.VBProject.VBComponents(gcCodeName).CodeModule.DeleteLines t, r

For Each a In ActiveWorkbook.Sheets
If Not (a.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or a.name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|") And a.Visible = True Then
     sname = a.CodeName
   ' If ActiveWorkbook.VBProject.VBComponents(sName).CodeModule.Find("Worksheet_Activate()", 1, 1, -1, -1) = False Then
    'ActiveWorkbook.VBProject.VBComponents("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").CodeModule.DeleteLines Start, Count
     With ActiveWorkbook.VBProject.VBComponents(sname).CodeModule
        r = .ProcCountLines("Worksheet_Activate", vbext_pk_Proc)
        t = .ProcStartLine("Worksheet_Activate", vbext_pk_Proc)
        .DeleteLines t, r
     End With
   ' End If
    'i = i + 1
End If
Next

ActiveWorkbook.Save
Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " & Filename & " |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
A1: ActiveWorkbook.Close

End Sub

Public Sub fFromModule(Filename$)
Dim FileName1$, sn$

On Error GoTo A1
Filename = ThisWorkbook.Path & "\" & Filename
FileName1 = ThisWorkbook.Path & "\" & "ModReg.bas"
Workbooks.Open Filename:=Filename, Editable:=True
Application.ScreenUpdating = False

sn = ActiveWorkbook.VBProject.VBComponents.Add(vbext_ct_StdModule).name
ActiveWorkbook.VBProject.VBComponents(sn).CodeModule.AddFromFile FileName1

ActiveWorkbook.Save
Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " & Filename & " |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
A1: ActiveWorkbook.Close
End Sub

Public Sub fRemoveModule(Filename$)
Dim r As Long, t As Long

On Error GoTo A1
Filename = ThisWorkbook.Path & "\" & Filename
Workbooks.Open Filename:=Filename, Editable:=True
Application.ScreenUpdating = False

Set a = ActiveWorkbook.VBProject.VBComponents("ModReg")
ActiveWorkbook.VBProject.VBComponents.Remove (a)

ActiveWorkbook.Save
Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " & Filename & " |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
A1: ActiveWorkbook.Close

End Sub
Public Sub fSaveBeforeClose(ByVal Filename As String)
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| Worksheet_Activate
Dim WN(20) As String

Dim sname As String
Application.ScreenUpdating = False
Filename = ThisWorkbook.Path & "\" & Filename

Workbooks.Open Filename:=Filename, Editable:=True

On Error GoTo A1

s = "Private Sub Workbook_BeforeClose(Cancel As Boolean)" & vbCrLf
s = s & "On Error Resume next" & vbCrLf
s = s & "Dim i As Long" & vbCrLf
s = s & "With Application.VBE.ActiveVBProject.References" & vbCrLf
s = s & "For i = .Count To 1 Step -1" & vbCrLf
s = s & "If Right$(.Item(i).Name, 4) = ""lnc2"" Then" & vbCrLf
s = s & "Application.DisplayAlerts = True" & vbCrLf
s = s & ".Remove .Item(i)" & vbCrLf
s = s & "Exit For" & vbCrLf
s = s & "End If" & vbCrLf
s = s & "Next" & vbCrLf
s = s & "End With" & vbCrLf
s = s & "End Sub" & vbCrLf

If ActiveWorkbook.VBProject.VBComponents(gcCodeName).CodeModule.Find("Private Sub Workbook_BeforeClose(Cancel As Boolean)", 1, 1, -1, -1) = False Then
    With ActiveWorkbook.VBProject.VBComponents(gcCodeName).CodeModule
        NextLine = .CountOfLines + 1
       .InsertLines NextLine, s
    End With
End If

ActiveWorkbook.Save
Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " & Filename & " |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
A1: ActiveWorkbook.Close
End Sub

Attribute VB_Name = "modSluzFunction"
Public sR$
'Public flSaveFormat As Boolean
'***************************             |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|        *******************************
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function fStrNameSpr(sSprName$) As String
Dim s$, r As Range
Set r = Range(sSprName)
s = r.Cells(1, 1).Offset(-2, 0).Value
s = sReplace(s, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|."): s = sReplace(s, "-", "")
s = sReplace(s, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
If InStr(s, "(") > 0 Then s = Trim$(left(s, InStr(s, "(") - 1))
Set r = Nothing
fStrNameSpr = s
End Function

Function TableExists(db As Variant, TableName As String) As Variant
 'returns NULL if an exception`s raised
 'db might be either database object or just a full file name
 On Error GoTo catch
var:
 Dim Result As Variant, b As Database
 Dim oTest As Object
begin:
 Result = Null
 If Not IsObject(db) Then
  Set b = OpenDatabase(db, False, False)
 Else
  Set b = db
 End If
 Result = False
 With b
  .TableDefs.Refresh
  For Each oTest In .TableDefs
   If UCase$(oTest.name) = UCase$(Trim$(TableName)) Then
    Result = True
    Exit For
   End If
  Next oTest
 End With

finally:
 On Error Resume Next
 Set oTest = Nothing: Set b = Nothing
 TableExists = Result
 Exit Function
catch:
 Result = Null
 Resume finally
End Function

Sub drop_table(d As Database, table_name As String)
On Error GoTo catch

If TableExists(d, table_name) Then
   d.Execute ("drop table " & table_name)
End If


finally:
 'On Error Resume Next
 'd.Close
 'Set d = Nothing

Exit Sub

catch:
 
 Resume finally
'MsgBox error(Err)
End Sub

Function fFillControl(ByRef mss As String) As Boolean
Dim s As String
Dim db As Database
Dim sql As String
Dim str1() As String
Dim str2() As String
Dim str3()
Dim sWhere As String
Dim Result As Boolean
Dim i  As Long
Dim j  As Long
Dim l  As Long
Dim nm() As String
Dim ds() As String
Dim sCondition As String
Dim fArr
Dim fArr1
Dim fArr2
Dim farr3
Dim farr4
Dim fData
Dim ColArr
Dim Row As Long
Dim row1 As Long
Dim Col  As Long
Dim Col1  As Long
Dim r As Range
Dim p  As Long
Dim p1  As Long
Dim n1  As Long
Dim sqlInsert As String
Dim rs As Recordset

On Error GoTo errFill

Result = False
n1 = 0
ReDim nm(n1)
ReDim farr3(3)
ReDim farr4(0)

Set db = DBEngine.CreateDatabase("c:\SvTemp", dbLangCyrillic)
  
GoNext:
Set db = DBEngine.CreateDatabase("c:\SvTemp", dbLangCyrillic)



For i = 1 To ActiveWorkbook.Sheets.Count
  If ActiveWorkbook.Sheets(i).Visible = True Then '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    ReDim Preserve nm(n1)
    nm(n1) = ActiveWorkbook.Sheets(i).name
    fData = fGetDataSheetsFromList(nm(n1))
    
    For l = LBound(fData) To UBound(fData)
      s = sGetINI(nm(n1) & "!" & fData(l) & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "?")
        
      If s <> "?" Then
      fArr = DelimitedLineToArray(s, ";")
         ReDim str1(UBound(fArr))
         ReDim str2(UBound(fArr))
         ReDim ds(UBound(fArr))
        For j = LBound(fArr) To UBound(fArr)
          If TableExists(db, CStr(fData(l))) Then
             db.Execute ("delete * from " & fData(l))
          End If
           If Trim(fArr(j)) <> "" Then
             fArr(j) = UCase(fArr(j))
             fArr1 = DelimitedLineToArray(fArr(j), "|fffd||fffd||fffd||fffd|")
             ds(j) = fData(l)
             
             
             If Trim(fArr1(j)) <> "" Then
               If UBound(fArr1) <> 1 Then
errmss:
                 mss = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| " & Chr(10) & Chr(13)
                 mss = mss & "'" & nm(n1) & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|'" & Chr(10) & Chr(13)
                 mss = mss & "|fffd| |fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd|!"
                 GoTo finnally
               End If
               
               
               For k = 0 To 1
                                                    
                 If k = 0 Then
                  sCondition = fArr1(k)
                  sCondition = sReplace(sCondition, " ", "")
                  sCondition = sReplace(sCondition, "RC", "Trim(col")
                  sCondition = sReplace(sCondition, "=", ")=")
                   If InStr(1, sCondition, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|") > 0 Then
                     sCondition = sReplace(sCondition, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|", Chr(34) & Chr(34))
                   End If
                   If InStr(1, sCondition, "|fffd||fffd||fffd||fffd||fffd|") > 0 Then
                     sCondition = sReplace(sCondition, "=", "<>")
                     sCondition = sReplace(sCondition, "|fffd||fffd||fffd||fffd||fffd|", Chr(34) & Chr(34))
                   End If
                   sCondition1 = sCondition
                   sCondition1 = sReplace(sCondition1, "Trim", "IsNull")
                   sCondition1 = sReplace(sCondition1, Chr(34), "")
                   sCondition1 = sReplace(sCondition1, "=", "")
                   sCondition1 = sReplace(sCondition1, "<>", "")
                   
                 Else
                   sWhere = fArr1(k)
                   sWhere = sReplace(sWhere, "RC", "Trim(col")
                   sWhere = sReplace(sWhere, "=", ")=")
                   sWhere = sReplace(sWhere, " ", "")
                   sWhere = sReplace(sWhere, "=|fffd||fffd|", "<>")
                   sWhere = sReplace(sWhere, "=|fffd||fffd|", "<>")
                   sWhere = sReplace(sWhere, "|fffd||fffd||fffd||fffd||fffd|", Chr(34) & Chr(34))
                   sWhere = sReplace(sWhere, "AND", " AND ")
                   sWhere = sReplace(sWhere, "OR", " OR ")
                   
                  ' sWhere1 = sWhere
                   
                 End If
                Next k
'-----------------------------------------------------------------------------
       If s <> "?" Then
        If Not TableExists(db, CStr(fData(l))) Then
           Row = Range(fData(l)).Row + 1
           row1 = Range(fData(l)).Rows.Count + Row - 3
           Col = Range(fData(l)).Column
           Col1 = Range(fData(l)).Columns.Count
           sql = "create table " & fData(l) & "("
           For p = 1 To (Col + Col1 - 1)
             If ActiveWorkbook.Sheets(nm(n1)).Columns(p).Hidden = False Then
               'If ActiveWorkbook.Sheets(nm(n1)).Cells(row, p).NumberFormat Like "*0.0*" Then
               '  sql = sql & "col" & p & " currency,"
               'Else
                 sql = sql & "col" & p & " text,"
               'End If
               
             End If
           Next p
          sql = sql & "RowNumber integer,Ord integer)"
          db.Execute (sql)
        End If
                 
       Set r = Range(fData(l))
       If r.Rows.Count <= 2 Then Exit Function
       
       For p = Row To row1
         sqlInsert = "insert into " & fData(l) & "("
         sql = "values('"
           
           For p1 = 1 To (Col + Col1 - 1)
             sqlInsert = sqlInsert & "col" & p1 & ","
'             If IsEmpty(ActiveWorkbook.Sheets(nm(n1)).Cells(p, p1).Value) Then
'               If ActiveWorkbook.Sheets(nm(n1)).Cells(p, p1).NumberFormat Like "*0.0*" Then
'                 sql = sql & "0','"
'               Else
'                  sql = sql & Space(1) & "','"
'               End If
'
'             Else
               sql = sql & ActiveWorkbook.Sheets(nm(n1)).Cells(p, p1).Value & "','"
'             End If
             'sql = sql & ActiveWorkbook.Sheets(nm(n1)).Cells(p, p1).Value & "','"
           Next p1
         
         
         
         sqlInsert = sqlInsert & "RowNumber,Ord) "
         sql = left(sql, Len(sql) - 1)
         sql = sql & p & ",0)"
         db.Execute (sqlInsert + sql)
       Next p
       sql = "update " & fData(l) & " set ord=0"
       db.Execute (sql)
       sql = "update " & fData(l) & " set ord=1 "
       sql = sql & "where " & sCondition & " and " & sWhere
       db.Execute (sql)
         
       sql = "update " & fData(l) & " set ord=1 "
       sql = sql & "where " & sCondition1 & " and " & sWhere
       db.Execute (sql)
       
         
       sql = "select * from " & fData(l) & " where Ord=1"
       Set rs = db.OpenRecordset(sql)
         
         If rs.RecordCount > 0 Then
           rs.MoveLast
           rs.MoveFirst
           sql = UCase(sCondition)
           sql = sReplace(sql, " ", "")
           sql = Mid(sql, InStr(1, sCondition, "col") + 3)
           p = InStr(1, sql, ")=")
           sql = left(sql, p - 1)
           mss = "|fffd||fffd||fffd||fffd||fffd||fffd| (" & IIf(IsNull(rs!RowNumber), 0, rs!RowNumber) & "," & sql & ") |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| '" & nm(n1) & "'  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
'            On Error Resume Next
           ActiveWorkbook.Sheets(nm(n1)).Select
           ActiveWorkbook.Sheets(nm(n1)).Cells(rs!RowNumber, CLng(sql)).Select
         
         'MsgBox mss
        
         GoTo finnally
         End If
       End If
'------------------------------------------------------------------------------
             
             End If
           End If
          sql = ""
        
        Next j
          
      
    End If
      
    
    Next l
    'db.Close
    'Set db = OpenDatabase("c:\SvTemp", False)
    n1 = n1 + 1
  End If
Next i

Result = True

finnally:
On Error Resume Next
Set r = Nothing
'rs.Close
fFillControl = Result

Exit Function
errFill:
If err = 3204 Then
  Kill "c:\SvTemp.mdb"
  err.Clear
  GoTo GoNext
Else
  'MsgBox Error(err)
  'Resume
  err.Clear
  Result = False
  GoTo finnally
End If
End Function

Function fGetDataSheetsFromList(sNameList As String) As Variant
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| Data_Sheet-|fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| sNameList
Dim i  As Long
Dim j  As Long
Dim k  As Long
Dim l  As Long
Dim sname As String
Dim ResultArr As Variant

ReDim ResultArr(1 To 1)

On Error GoTo cansel
k = 0
l = 0
  For i = 1 To Names.Count
    If UCase(Names(i).name) Like "DATA_SHEET*" Then
       l = l + 1
       sname = Names(i).RefersTo
       j = InStr(1, sname, "!")
       If j > 0 Then
         sname = Mid(sname, 1, j - 1)
         sname = Replace(sname, "=", "")
         sname = Trim(sname)
         If ActiveWorkbook.Sheets(sname).Visible = True Then
           If UCase(sNameList) = UCase(sname) Then
             k = k + 1
             ReDim Preserve ResultArr(1 To k)
             ResultArr(k) = Names(i).name
           End If
         End If
       End If
    End If
  Next i

fGetDataSheetsFromList = ResultArr

Exit Function

cansel:
'MsgBox Error(err)
'Resume
fGetDataSheetsFromList = 0

End Function

Function fGetNameSheetFromName(sname As String) As String
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd||fffd||fffd|)
Dim Result As Variant

On Error GoTo cansel
Result = Trim(Range(sname).Worksheet.name)

finnally:
fGetNameSheetFromName = Result

Exit Function

cansel:
'MsgBox Error(err)
'Resume
fGetNameSheetFromName = ""
GoTo finnally


End Function

Function GetNameWBook() As String
Dim i  As Long
On Error GoTo err_getName

i = InStr(ActiveWorkbook.name, ".")
If i = 0 Then i = Len(ActiveWorkbook.name) - 1 Else i = i - 2
Result = left$(ActiveWorkbook.name, i) '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Result = Trim(Result)

finally:
GetNameWBook = Result

Exit Function
err_getName:
'MsgBox Error(err)
'Resume
Result = ""
GoTo finally

End Function

Public Function fGetWorkBookVersion(wbName As String) As String
Dim WbVersion As String

On Error GoTo err_ver
Result = ""
wbName = Trim(wbName)
WbVersion = Trim(Workbooks(wbName).VBProject.Description)
WbVersion = UCase(WbVersion)
WbVersion = Replace(WbVersion, "|fffd||fffd||fffd||fffd||fffd||fffd|", "")
WbVersion = Replace(WbVersion, " ", "")

  If WbVersion <> "" Or Len(WbVersion) > 0 Then
    Result = WbVersion
  End If

finally:
fGetWorkBookVersion = Result
Exit Function
err_ver:
'MsgBox errror(err)
'Resume
Result = ""
GoTo finally

End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function HasInSpr(sKod$, sSprName$) As Boolean
Dim fl As Boolean, r As Range
On Error GoTo A1
Set r = Range(sSprName)
'fUnProtect True, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
'R.Sort Key1:=R.Cells(1, 1), Order1:=xlAscending
For i = 1 To r.Rows.Count
    If r.Cells(i, 1) = sKod Then fl = True: GoTo A1
Next i
A1:
'fUnProtect False, Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Index
Set r = Nothing
HasInSpr = fl
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function SprValue(sKod$, sSprName$) As String
Dim fl As Boolean, r As Range, s$
On Error GoTo A1
Set r = Range(sSprName)
For i = 1 To r.Rows.Count
    If r.Cells(i, 1) = sKod Then s = r.Cells(i, 2): GoTo A1
Next i
A1:
Set r = Nothing
SprValue = s
End Function

Public Function NameinSpr(sKod$, sSprName$) As String
NameinSpr = SprValue(sKod, sSprName)
End Function


'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function MaxValueSpr(r As Range) As Long
Dim Value As Long, i  As Long
For i = 1 To r.Rows.Count
    If r.Cells(i, 1) > Value Then Value = r.Cells(i, 1)
Next i
MaxValueSpr = Value
End Function

Public Function EmptyName(sname As String) As Long
Dim r As Range, i As Long, Value As Long, n As Long

On Error GoTo err
Set r = Range(sname)
Value = 1
n = r.Rows.Count
If n > 10 Then n = 10
For i = 1 To n
    If Not IsEmpty(r.Cells(i, 1)) Then Value = 2: Exit For
Next i
err:
Set r = Nothing
EmptyName = Value
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| sEmptyName > 0
'|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd| sName  |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| sEmptyName =2
'|fffd||fffd||fffd||fffd| sName  |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| sEmptyName =3
Public Function sEmptyName(sname As String) As Long
Dim r As Range, i As Long, fl1 As Boolean, fl3 As Boolean

On Error GoTo err
Set r = Range(sname)
sEmptyName = 1
If r.Worksheet.name <> "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then GoTo err
For i = 1 To r.Rows.Count
    If Not IsEmpty(r.Cells(i, 1)) Then fl1 = True
    If Not IsEmpty(r.Cells(i, 3)) Then fl3 = True
    If i > 10 Then Exit For
Next i
If fl1 = True Then sEmptyName = 2
If fl3 = True Then sEmptyName = 3
Set r = Nothing
Exit Function
err:
Set r = Nothing
End Function

'***************************             |fffd||fffd||fffd||fffd||fffd|        *******************************
Public Function HasName(sname As String) As Boolean
Dim r As Range

On Error Resume Next
Set r = Range(sname)
If r Is Nothing Then HasName = False Else HasName = True
Set r = Nothing
End Function

'#6359 ======================================

Public Sub UnProtectWorkbook(ByRef WB As Workbook)
    WB.Unprotect "rassvet"
End Sub

Public Sub ProtectWorkbook(ByRef WB As Workbook)
    WB.Protect "rassvet"
End Sub

'=============================================

Public Sub MyProtect()
Dim id As Long

ActiveWorkbook.Unprotect "rassvet"
id = ActiveSheet.Index
ActiveWorkbook.Worksheets(id).Unprotect "rassvet"
'ThisWorkbook.Unprotect "rassvet"
End Sub


' True - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| False - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub fUnProtect(fl As Boolean, Optional id As Long = 0)

On Error Resume Next
If id = 0 Then id = ActiveSheet.Index
'With ActiveWorkbook
'If .ProtectStructure = False And fl = False Then .Protect "rassvet"
'If .ProtectStructure = True And fl = True Then .Unprotect "rassvet"
'End With
With ActiveWorkbook.Worksheets(id)
If .ProtectContents = True And fl = True Then .Unprotect "rassvet"
If .ProtectContents = False And fl = False Then
    If Val(Application.Version) < 10 Then
        .Protect "rassvet"
    Else
        .Protect "rassvet", AllowFormattingColumns:=True    ', AllowFormattingRows:=True
        'ActiveSheet.EnableSelection = xlUnlockedCells
    End If
End If
End With
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| Data_Cell |fffd||fffd||fffd| ""
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| Worksheet_Change(ByVal Target As Range)
'!!! |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| HasInData_Cells |fffd||fffd| modTest = |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd|
Public Function FormatData_Cell(sname As String) As String
Dim RDC As Range, f1$, f2$

Set RDC = Range("Data_Cells")
For i = 1 To RDC.Rows.Count
    If RDC.Cells(i, 1) = sname Then
        f1 = Trim$(RDC.Cells(i, 2))
        f2 = Trim$(RDC.Cells(i, 3))
        If Len(f1) = 0 Then FormatData_Cell = "": Exit Function
        If f1 = "C" Then FormatData_Cell = "@": Exit Function
        If f1 = "F" Then GoTo A1
    End If
Next i
Set RDC = Nothing
FormatData_Cell = ""
Exit Function
A1:
    If f2 = "0" Or Len(f2) = 0 Then FormatData_Cell = "0"
    If f2 = "1" Then FormatData_Cell = "0.0"
    If f2 = "2" Then FormatData_Cell = "0.00"
Set RDC = Nothing
End Function


Public Sub fRowHidden()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
Dim n As name, j As Long, fl As Boolean, flStr As Boolean
Dim r As Range, i As Long, k As Long

On Error Resume Next
Application.ScreenUpdating = False
fUnProtect True
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
fl = SPS(ActiveSheet.Index)
''fcmdRowHidden   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
For Each n In ActiveWorkbook.Names
    If n.name Like "Data_Sheet*" Then
        If Range(n.name).Worksheet.name = ActiveWorkbook.ActiveSheet.name Then
            
            Set r = Range(n.name)
'            k = fCountVisible(R)
            For j = 2 To r.Rows.Count - 1   '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                If fl = True Then
                    r.Rows(j).EntireRow.Hidden = False
                Else
                    flStr = IfNotNullStr(r, j)   'True |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                    If flStr = False Then r.Rows(j).EntireRow.Hidden = True: i = i + 1
                End If
            Next j
        End If
    End If
Next
If Not (fl = False And i = 0) Then
    SPS(ActiveSheet.Index) = Not SPS(ActiveSheet.Index)
    fcmdRowHidden
End If
Set r = Nothing
fUnProtect False
End Sub

Public Function IfNotNullStr(r As Range, Row As Long) As Boolean
Dim i As Long, s$, v, fl As Boolean

On Error Resume Next
For i = 1 To r.Columns.Count
    s = ""
    s = r.Cells(Row, i).name.name
    v = r.Cells(Row, i).Value
    If (s Like "ss*" And v <> 0) And (s Like "ss*" And Not ((UCase(Trim(v)) = UCase("x") Or UCase(Trim(v)) = UCase("|fffd|") Or IsEmpty(v)))) Then
        fl = True: Exit For '' Spir 26/03/2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd|
    End If
'    If s Like "ss*" And v <> 0 Then fl = True: Exit For
Next i
IfNotNullStr = fl
End Function

Public Function StrEl(ByVal sF As String, Optional n As Long, Optional ByVal sR As String = ",") As String
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| n |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| =0 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Dim s As String, s1$, s2$

sF = Trim$(sF)
For i = 1 To Len(sF)
    s = Mid$(sF, i, 1)
    If s = sR Then
        If Len(s1) <> 0 And Right$(s1, 1) <> sR And Len(sF) <> i Then
                             k = k + 1
                             If k = n Then s2 = s1
                             s1 = ""
        End If
    Else
        s1 = s1 & s
    End If
Next i
If k > 0 Then k = k + 1
If k = n Then s2 = s1
If k = 0 And Len(s1) > 0 Then
    k = 1
    If n = 1 Then s2 = s1
End If
If n = 0 Then StrEl = str(k) Else StrEl = Trim$(s2)
End Function

Public Function MaxStrEl(ByVal sEl$) As Long
Dim i As Long, k As Long, k0 As Long, n As Long

n = StrEl(sEl)
For i = 1 To n
    k = Val(StrEl(sEl, i))
    If k0 < k Then k0 = k
Next i
MaxStrEl = k0
End Function

'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Public Function ArrayStrEl(ByVal sEl$, Optional sFormat As String = "") As Variant()
Dim a() As Variant, i As Long, n As Long

n = StrEl(sEl)
ReDim a(0 To n - 1)
For i = 1 To n
    a(i - 1) = IIf(Len(sFormat) > 0, Format$(StrEl(sEl, i), sFormat), StrEl(sEl, i))
Next i
ArrayStrEl = a
End Function

Public Function HasElinStr(ByVal sEl$, ByVal s$) As Boolean
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim i As Long, n As Long
If Len(sEl) = 0 Then HasElinStr = False: Exit Function
n = StrEl(sEl)
For i = 1 To n
    If Trim$(StrEl(sEl, i)) = Trim$(s) Then
        HasElinStr = True
        Exit Function
    End If
Next i
HasElinStr = False
End Function

Public Function fEmptyControl(sContrName$) As Boolean
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| sContrName |fffd| |fffd||fffd||fffd||fffd||fffd|
Dim fl As Boolean

fl = False
For Each a In UserForm1.Controls
    If (TypeName(a) = "ListBox" Or TypeName(a) = "ComboBox" Or TypeName(a) = "TextBox") Then
        If a.name = sContrName Then fl = True: Exit For
    End If
Next
fEmptyControl = fl
End Function

Public Sub fListIndex()
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| Kod_|fffd||fffd||fffd| Name_|fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
Dim s$, s1$

With UserForm1.Controls("ListBox1")
s = .RowSource
If Len(s) = 0 Then Exit Sub

On Error GoTo A1

For j = 0 To 1

If j = 0 Then s = sReplace(s, "Data", "Kod") Else s = sReplace(s, "Kod", "Name")
If HasName(s) Then s1 = Range(s).Cells(1, 1).Value
's1 = ActiveWorkbook.Names(s).RefersToRange.Value
For i = 0 To .ListCount - 1
    If .List(i, j) = s1 Then .ListIndex = i: GoTo A1
Next i
'A1:
'Resume D1
'D1:
Next j
A1:
.SetFocus
End With
End Sub

Public Sub fGetRekvTXT()
Dim s$, i As Long, sd$, fl As Boolean

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| Kod_|fffd||fffd||fffd| Name_|fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
For Each a In UserForm1.Controls
    If (TypeName(a) = "TextBox") And a.Visible = True Then
        s = a.Tag
        fl = False
        If s Like "*Date_*" Then
                i = InStr(s, "_")
                sd = "Kod_" & Mid$(s, i + 1)
                If EmptyName(sd) > 0 Then
                    If ActiveWorkbook.Names(sd).RefersToLocal Like "*" & ActiveSheet.name & "*" Then
                        If Len(ActiveSheet.Range(sd).Value) > 0 Then
                            a.Value = ActiveSheet.Range(sd).Value
                            fl = True
                        End If
                    End If
                End If
                If fl = False Then
                    sd = "Name_" & Mid$(s, i + 1)
                    If EmptyName(sd) > 0 Then
                        If ActiveWorkbook.Names(sd).RefersToLocal Like "*" & ActiveSheet.name & "*" Then
                            If CDate(ActiveSheet.Range(sd).Value) Then _
                                a.Value = Format$(CDate(ActiveSheet.Range(sd).Value), "dd.mm.yyyy")
                        End If
                    End If
                End If
        End If
        
        If s Like "*TXT*_*" Then
            i = InStr(s, "_")
            sd = "Kod_" & Mid$(s, i + 1)
            If EmptyName(sd) > 0 Then
                If ActiveWorkbook.Names(sd).RefersToLocal Like "*" & ActiveSheet.name & "*" Then
                    If Len(ActiveSheet.Range(sd).Value) > 0 Then _
                        a.Value = ActiveSheet.Range(sd).Value
                End If
            End If
        End If
    End If
Next
End Sub

Public Function sReplace(ByVal s1 As Variant, ByVal s2 As Variant, ByVal S3 As Variant) As String
Dim i As Long, k As Long

k = 1
Do
i = InStr(k, s1, s2)
If i > 0 Then
    s1 = left$(s1, i - 1) & S3 & Mid$(s1, i + Len(s2))
    k = i + Len(S3)
End If
Loop While i > 0
sReplace = s1
End Function


Public Sub IzmenEI(ByVal Old_izm As String, ByVal New_izm As String)    ', ByVal sCol As String)

''  382 - |fffd||fffd||fffd||fffd||fffd|
''  383 - |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
''  384 - |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
''  385 - |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
 
 
            Select Case Old_izm
                Case "383", "" '  - |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                    Select Case New_izm
                        Case "382"  '  - |fffd||fffd||fffd||fffd||fffd|
                             RoundCells 1, 0
                        Case "384"  '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                             RoundCells 0.001, 0
                        Case "385"  '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                             RoundCells 0.001, 1, "#,##0.0"
                    End Select
                Case "382"  '|fffd||fffd||fffd||fffd||fffd|
                    Select Case New_izm
                        Case "383"  '  - |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                             RoundCells 1, 2, "#,##0.00"
                        Case "384"  '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                             RoundCells 0.001, 0
                        Case "385"  '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                             RoundCells 0.001, 1, "#,##0.0"
                    End Select
                Case "384"  '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                    Select Case New_izm
                        Case "382"  '  - |fffd||fffd||fffd||fffd||fffd|
                             RoundCells 1000, 0
                        Case "383"  ' |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                             RoundCells 1000, 2, "#,##0.00"
                        Case "385"  '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                             RoundCells 1, 1, "#,##0.0"
                    End Select
                 Case "385" '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                    Select Case New_izm
                        Case "382"  '  - |fffd||fffd||fffd||fffd||fffd|
                             RoundCells 1000, 0
                        Case "383"  ' |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                             RoundCells 1000, 2, "#,##0.00"
                        Case "384"  '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
                             RoundCells 1, 0
                    End Select
            End Select
End Sub

Public Sub RoundCells(ByVal iPr As Double, ByVal iKZ As Long, Optional sFormat As String = "#,###")

Dim v As Range, r As Range, w As Worksheet, sw$, s$, sR$
On Error Resume Next
Application.ScreenUpdating = False
'If iPr < 1 Then
'    Style = vbYesNo + vbCritical + vbDefaultButton2
'    If MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ?", Style) <> vbYes Then Exit Sub
'End If

For Each w In ActiveWorkbook.Sheets
If w.Visible = True And w.name <> ActiveSheet.name Then fUnProtect True, w.Index
Next

For Each n In ActiveWorkbook.Names
    If n.name Like "ss*" Then
       ' s = n.RefersToLocal
       ' sw = Mid$(s, 2, InStr(s, "!") - 2)
       ' sr = Mid$(s, InStr(s, "!") + 1)
       ' se = Worksheets(sw).Range(sr).Formula
       ' se = Range(s).Formula
        If left$(Trim$((Range(n.RefersToLocal).Formula)), 1) <> "=" Then
            i = n.RefersToRange * iPr
            n.RefersToRange = Round(n.RefersToRange * iPr, iKZ)
        End If
        'Debug.Print n.RefersToLocal
        Range(n.RefersToLocal).NumberFormat = sFormat
    End If
Next

For Each w In ActiveWorkbook.Sheets
If w.Visible = True And w.name <> ActiveSheet.name Then fUnProtect False, w.Index
Next

End Sub




Public Function fOptions(ByVal sKey$) As Long
Dim r As Range, i As Long

On Error Resume Next
Set r = Range("Data_Options")
If err <> 0 Then fOptions = 0: Exit Function
For i = 1 To r.Rows.Count
    If UCase(Trim$(r.Cells(i, 1))) = UCase(sKey) Then fOptions = r.Cells(i, 2): Exit Function
Next i
Set r = Nothing
End Function


Public Function fFormat(ByVal sKod$, Optional ByVal sSp$ = "") As String
Dim sF$

On Error GoTo err
If Len(sSp) = 0 Or sSp Like "Data_TXT*" Then fFormat = sKod: Exit Function
sF = Range(sSp).Cells(1, 1).Offset(-1, 3).Value
If Len(sF) = 0 Then fFormat = sKod: Exit Function
'sR = Left$(sReplace(sF, "0", ""), 1)
'sF = sReplace(sF, sR, "'")
sKod = Format$(sKod, sF)
'sKod = sReplace(sKod, "'", sR)
err:
fFormat = sKod
End Function


'Public Sub fSaveFormat()
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| Data_XXX
''  sR$ |fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'Dim s$, k%, i%, i1%, i2%, sF$, sSp$
'On Error GoTo err
's = sGetINI("Format", "?")
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|.|fffd|. |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
''|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| fRasstMain
'flSaveFormat = True
'If s = "?" Then sR = " ": Exit Sub  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'k = 1
'Do
'i = InStr(k, s, "Data_")
'If i > 0 Then
'    i1 = InStr(i + 5, s, "(")
'    i2 = InStr(i + 5, s, ")")
'    sF = Mid$(s, i1 + 1, i2 - i1 - 1)
'    If Len(sR) = 0 Then sR = left$(sReplace(sF, "0", ""), 1)
'    sSp = Mid$(s, i, i1 - i)    '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'    If EmptyName(sSp) > 0 Then
'        Range(sSp).Cells(1, 1).Offset(-1, 3).Value = sF
'        fData_Format sSp, sF
'    End If
'    k = i2 + 1
'End If
'Loop While i > 0
'
'
'err:
'End Sub
'Public Sub fData_Format(ByVal sRangeName As String, ByVal sFormat As String)
'Dim R2 As Range, R As Range, sNewRangeName As String
'Dim sAdr As String, i As Integer, s As String
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Data_XXX1 |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
''|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| fRasstMain
'sNewRangeName = sRangeName & "1"
'
'Set R = Range(sRangeName)
'sFormat = sReplace(sFormat, sR, " ")
'Set R2 = R.Cells(1, 1).Offset(0, 4)
'sAdr = "='" & R.Worksheet.Name & "'!" & R2.Address & ":"
'sAdr = sAdr & R.Cells(1, 3).Offset(R.Rows.Count - 1, R.Columns.Count + 1).Address
'ActiveWorkbook.Names.Add Name:=sNewRangeName, RefersTo:=sAdr
'R.Copy R2
'Set R2 = Range(sNewRangeName)
'
'For i = 1 To R2.Rows.Count
'    s = R2.Cells(i, 1)
'    s = Format$(s, sFormat)
'    R2.Cells(i, 1) = s
'Next i
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'Set R2 = Range(R.Cells(1, 1).Offset(-2, 0), R.Cells(1, 1).Offset(-1, 2))
'R2.Copy R.Cells(1, 1).Offset(-2, 4)
'End Sub
'
'-------------------15.10.2015 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| GUID |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'Public Sub SetGUID()
Public Sub SetGUID(Optional ByVal sGUIDName$ = "GUID")

Dim r As Range, Value As Long
Dim str As String
Dim i  As Long
Dim j  As Long

'If Not HasName("Kod_GUID") Then Exit Sub
'If Not HasName("Data_GUID") Then Exit Sub
If Not HasName("Kod_" & sGUIDName) Then Exit Sub
If Not HasName("Data_" & sGUIDName) Then Exit Sub

If Not (Range("Data_" & sGUIDName).Parent.name = ActiveSheet.name) Then Exit Sub

On Error Resume Next
'Set r = Range("Data_GUID")
Set r = Range("Data_" & sGUIDName)
Value = MaxValueSpr(r) + 1

 If flgUseDataSheetInCodName = True Then
   str = "Data_Sheet" & UserForm1.Controls("CmbDataSheet").Value
   str = sGetINI(str & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
   str = UCase(str)
   str = fSetGuidFormat(str)

   If IsNumeric(str) Then
     j = CLng(str)
     s = Format(Value, String(j, "0"))
   Else
     s = Format(Value, "000")
   End If

Else
  
   str = "Data_Sheet" & UserForm1.Controls("CmbDataSheet").Value
   str = sGetINI(str & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
   If str = "?" Then
     str = sGetINI(ActiveSheet.name & "!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", "?")
   End If
  
   str = UCase(str)
'   i = InStr(1, str, "(KOD_GUID")
   i = InStr(1, str, "(KOD_" & sGUIDName)
   j = Mid(str, i - 1, 1)
   If IsNumeric(j) Then
     s = Format(Value, String(j, "0"))
   Else
     s = Format(Value, "000")
   End If
  
End If

Set r = Nothing
'If fEmptyControl("GUID") Then UserForm1.Controls("GUID").Value = s
If fEmptyControl(sGUIDName) Then UserForm1.Controls(sGUIDName).Value = s
End Sub



Function fSetGuidFormat(str As String) As String
Dim fArr
Dim fArr1
Dim i  As Long
Dim j  As Long
Dim k  As Long
Dim p  As Long
Dim Result

On Error GoTo guid_err
Result = ""
fArr = DelimitedLineToArray(str, ";")
   For i = LBound(fArr) To UBound(fArr)
     fArr1 = DelimitedLineToArray(fArr(i), ",")
       For j = LBound(fArr1) To UBound(fArr1)
         p = InStr(1, fArr1(j), "(KOD_GUID")
         If p > 0 Then
           k = InStr(1, fArr1(j), "DATA_TXT")
           If k > 0 Then
             Result = Mid(fArr1(j), k + 8, p - 9)
             GoTo finnally
           End If
         End If
       Next j
     
   Next i

finnally:
fSetGuidFormat = Result
Exit Function

guid_err:
Result = "000"
GoTo finnally

End Function

Public Function HasInArray(Value As Variant, a As Variant) As Boolean
Dim i As Long, fl As Boolean

For i = LBound(a) To UBound(a)
 If a(i) = Value Then fl = True: GoTo A1
Next i
A1:
HasInArray = fl
End Function

Public Function HasFormula(r As Range) As Boolean
Dim fl As Boolean

If left(r.Cells(1, 1).Formula, 1) = "=" Then fl = True
HasFormula = fl
End Function


Public Function GetFilePath(Optional ByVal Title As String = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", _
                     Optional ByVal InitialPath As String = "c:\", _
                     Optional ByVal FilterDescription As String = "|fffd||fffd||fffd||fffd||fffd| Excel", _
                     Optional ByVal FilterExtention As String = "*.xls*") As String
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Title,
   ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| InitialPath
   ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
   ' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
   '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 09.06.2012 |fffd||fffd||fffd||fffd||fffd||fffd|
   On Error Resume Next
    With Application.FileDialog(msoFileDialogOpen)
        .ButtonName = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|": .Title = Title: .InitialFileName = InitialPath
        .Filters.Clear: .Filters.Add FilterDescription, FilterExtention
        If .Show <> -1 Then Exit Function
        GetFilePath = .SelectedItems(1)
    End With
End Function

Public Function fAddPicture() As Variant
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    Dim strFileName As String
    Dim strNameRange As String
    Dim i As Long, nRows As Long, j As Long, iPic As Long
    Dim lnHeight  As Long, lnWidth  As Long, lnHeightR  As Long, lnWidthR As Long
    Dim loPic As Object
    Dim loChart As Object
    Dim loShape  As Object
    
       Application.ScreenUpdating = False
       
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        strNameRange = Application.Names(, , CStr(Application.ActiveCell.name)).name
        If Len(strNameRange) > 0 Then
            '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
    
            Application.Cells(Range(strNameRange).Cells(1, 1).Row + 1, Range(strNameRange).Cells(1, 1).Column).Select
            '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
            strFileName = GetFilePath("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", "", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "*.emf, *.wmf, *.jpg, *.jpeg, *.jiff, *.jpe, *.png, *.bmp, *.dib, *.rle, *.bmz, *.gif, *.gfa, *.emz, *.wmz, *.pcz, *.tif, *.tiff, *.cdr, *.cgm, *.eps, *.pct, *.pict, *.wpg")
            If Len(strFileName) > 0 Then
                fUnProtect True
                ActiveSheet.Pictures.Insert(strFileName).name = strNameRange
                
                'Spiridonova 25.07.2012
                Set loPic = Application.ActiveSheet.Pictures(strNameRange)  '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|
                'Spiridonova 10.09.2012
                loPic.OnAction = "'fClickOpen """ & strNameRange & """'"
                'loPic.BackStyle = fmBackStyleOpaque
                
                Set loShape = Application.ActiveSheet.Shapes(strNameRange)
                strFileName = gcDirTemp & gcInkod & "_" & strNameRange & ".JPG"
                If Dir(strFileName) = strFileName Then Kill (strFileName)
                'Set loChart = Application.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|").ChartObjects.Add(0, 0, loPic.Width, loPic.Height)
                'Set loChart = Application.ActiveSheet.ChartObjects.Add(0, 0, loPic.Width, loPic.Height)
                loShape.Copy
                Set loChart = Application.ActiveSheet.ChartObjects.Add(10000, 10000, loShape.Width, loShape.Height)
               With loChart.Chart
                    .ChartArea.Border.LineStyle = 0
                    .Paste
                    .Export Filename:=strFileName, FilterName:="JPG"
                    .Parent.Delete
                End With
                'Spiridonova 25.07.2012
                
                ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ' Spiridonova 10.07.2012
                nRows = UBound(arrPic, 2)   ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                For i = 1 To nRows
                    If strNameRange = arrPic(1, i) And arrPic(7, i) <> "" Then
                        'Set loPic = Application.ActiveSheet.Pictures(strNameRange)  '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
                        
                        Application.Range(arrPic(7, i)).Select
                        
                        lnHeightR = Application.Selection.Height
                        lnWidthR = Application.Selection.Width
                        lnHeight = loPic.Height
                        lnWidth = loPic.Width
                        If loPic.Height > lnHeightR Then
                            loPic.Height = lnHeightR
                            If loPic.Width > lnWidthR Then
                                loPic.Width = loPic.Width * loPic.Height / lnHeight
                            End If
                        End If
                        If loPic.Width > lnWidthR Then
                            lnWidthR = loPic.Width
                            loPic.Width = Application.Selection.Width
                            If loPic.Height > lnHeightR Then
                                loPic.Height = loPic.Width * loPic.Height / lnWidthR
                            End If
                        End If
                        
                        loPic.Top = Application.Selection.Top
                        loPic.left = Application.Selection.left
                        Exit For
                    End If
                Next i
                ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ' Spiridonova 10.07.2012
                
                fUnProtect False
            End If
            Application.Range(strNameRange).Select
            Application.ScreenUpdating = True
        End If

    
End Function
    
Public Function fClickOpen(strNameRange As String) As Variant
    'Spiridonova 10.09.2012 '
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|
    Dim strFileName As String
'    Dim strNameRange As String
    Dim i As Long, nRows As Long, j As Long, iPic As Long
    Dim lnHeight  As Long, lnWidth  As Long, lnHeightR  As Long, lnWidthR  As Long
    Dim loPic As Object
    Dim loChart As Object
    Dim loShape  As Object
    Dim NameVisCell As String
    
    On Error Resume Next
    
    Application.ScreenUpdating = False
    
    If Len(strNameRange) > 0 Then
        strFileName = gcDirTemp & gcInkod & "_" & strNameRange & ".JPG"
'strFileName = "C:\Documents and Settings\Spiridonova\|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|\|fffd||fffd||fffd||fffd||fffd|\cat_36.jpg"
        'Set loShape = Application.ActiveSheet.Shapes("OpenImage")
        fUnProtect True
        
        ' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|e|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
        ActiveSheet.Pictures("OpenImage").Delete
        
        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
        NameVisCell = Mid(ActiveSheet.Columns(Application.ActiveWindow.VisibleRange.Column).Address, 2, 1) & Application.ActiveWindow.VisibleRange.Row
        ActiveSheet.Range(NameVisCell).Select
        ActiveSheet.Pictures.Insert(strFileName).name = "OpenImage"
        Set loPic = Application.ActiveSheet.Pictures("OpenImage")
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|
        loPic.Select
        Selection.OnAction = "fClickClose"

      fUnProtect False
      
      Application.ScreenUpdating = True
      
    End If
    
End Function

Public Function fClickClose()
' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| OpenImage

    On Error Resume Next

    fUnProtect True
    ActiveSheet.Pictures("OpenImage").Delete
    fUnProtect False

End Function

Public Function IsCellForPicture(ByVal NameCell As String) As Boolean
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|, |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| R1C1 !!!
    
    On Error GoTo errHandler
    IsCellForPicture = False
    If Len(NameCell) > 0 Then
        If InStr(1, StrNameCellsPictures, NameCell, vbBinaryCompare) > 0 Then
            IsCellForPicture = True
        End If
    End If
    Exit Function
    
errHandler:
    IsCellForPicture = False
    err.Clear
End Function

Public Function PictureItThere(ByVal NamePic As String) As Boolean
    On Error GoTo errHandler
    PictureItThere = False
    If ActiveSheet.Pictures(NamePic).Width > 0 Then
        PictureItThere = True
    End If
    
errHandler:
    err.Clear
End Function
Public Function fDeletePicture() As Variant
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    ' Spiridonova 05072012
    Dim strFileName As String
    Dim strNameRange As String
    
        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        strNameRange = Application.Names(, , CStr(Application.ActiveCell.name)).name
        If Len(strNameRange) > 0 Then
            '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
    
            Application.Cells(Range(strNameRange).Cells(1, 1).Row + 1, Range(strNameRange).Cells(1, 1).Column).Select
'            '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
'            strFileName = GetFilePath("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", "", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "*.emf, *.wmf, *.jpg, *.jpeg, *.jiff, *.jpe, *.png, *.bmp, *.dib, *.rle, *.bmz, *.gif, *.gfa, *.emz, *.wmz, *.pcz, *.tif, *.tiff, *.cdr, *.cgm, *.eps, *.pct, *.pict, *.wpg")
'            If Len(strFileName) > 0 Then
                fUnProtect True
                ActiveSheet.Pictures(strNameRange).Delete
                fUnProtect False
'            End If
            Application.Range(strNameRange).Select
            
            'Spiridonova 25.07.2012
            strFileName = gcDirTemp & gcInkod & "_" & strNameRange & ".JPG"
            If UCase(Dir(strFileName)) = UCase(gcInkod & "_" & strNameRange & ".JPG") Then Kill (strFileName)
            'Spiridonova 25.07.2012

        End If

    
End Function
Attribute VB_Name = "modTest"
Public Function GetAllDictionarys(WBook As Workbook) As Variant()
Dim RangeArr()
Dim i  As Long
Dim k  As Long
Dim j  As Long
Dim Result
Dim SprName As String
Dim sname As String


On Error GoTo err_dict
SprName = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
'ActiveWorkbook.Sheets(SprName).Cells(1, 1).Select

k = -1
ReDim RangeArr(0)
  For i = 1 To Names.Count
    If UCase(Names(i).name) Like "DATA_*" Then
       sname = Names(i).RefersTo
       j = InStr(1, sname, "!")
       If j > 0 Then
         sname = Mid(sname, 1, j - 1)
         sname = Replace(sname, "=", "")
         If UCase(SprName) = UCase(sname) Then '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
            k = k + 1
            ReDim Preserve RangeArr(k)
            RangeArr(k) = Names(i).name  '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
         End If
         
       End If
    End If
  Next i
Result = RangeArr

finally:
GetAllDictionarys = Result

Exit Function

err_dict:
' MsgBox Error(err)
' Resume
 Result = Empty
 GoTo finally

End Function

'Public Sub Main()
''|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
''|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd|-|fffd||fffd||fffd| ModRows fInsertNameStr |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'Dim i%, j%, WS As Worksheet, R As Range, RAll As Variant, fl As Boolean, n%
'Set WS = ActiveWorkbook.Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd|")
'For j = 1 To WS.UsedRange.Rows.Count
'For i = 1 To WS.UsedRange.Columns.Count
'Set R = WS.Cells(j, i)
'RAll = fRange(R)
'fl = HasInData_Sheet(R)
'If UBound(RAll) > 1 Then
'If RAll(1) = "ss010b" Then
'HasInData_Cells RAll(1)
'End If
'End If
''If UBound(RAll) > 1 Then If Len(RAll(1)) > 0 Then HasInData_Cells RAll(1)
'Next i
'Next j
'Set R = Nothing
'End Sub

''06062017 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function fRange(r As Range) As Variant()
'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd|-|fffd||fffd||fffd| ModRows fInsertNameStr
Dim sAdress$, sname$, sFormula$, sValue$, iColor%, sFormatDC$, sFormat$, flInDS As Boolean
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| True |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
sAdress = r.Address
If r.MergeCells = True Then
    If sAdress <> r.MergeArea.Offset(0, 0).Address Then fRange = Array(False): Exit Function
End If
sname = fCellsName(r)
If r.HasFormula Then sFormula = r.Formula
On Error Resume Next
sValue = r.Value2
iColor = r.Interior.ColorIndex
sFormat = r.NumberFormat
flInDS = HasInData_Sheet(r)
If Len(sname) > 0 Then sFormatDC = HasInData_Cells(sname)
fRange = Array(True, sname, sFormula, iColor, r.Locked, sValue, sAdress, sFormatDC, sFormat, flInDS)
End Function
Public Function HasInData_Sheet(r As Range) As Boolean
Dim n As name, R3 As Range

For Each n In ActiveWorkbook.Names
    If n.name Like "Data_Sheet*" Then
        If r.Worksheet.name = Range(n.name).Worksheet.name Then
         Set R3 = Application.Intersect(r, Range(n.name))
         If Not (R3 Is Nothing) Then
            HasInData_Sheet = True
            Set R3 = Nothing
            Exit Function
         End If
        End If
    End If
Next
HasInData_Sheet = False
Set R3 = Nothing
End Function

'|fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| "Data_Cells" |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| "" |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 2 |fffd| 3 |fffd||fffd||fffd||fffd||fffd||fffd||fffd| "   " |fffd|.|fffd|. Len > 0
Public Function HasInData_Cells(ByVal sname As String) As String
Dim RDC As Range, sFormat As String, f1$, f2$, fr1$, fr2$, t As Long

Set RDC = Range("Data_Cells")
For i = 1 To RDC.Rows.Count
    If RDC.Cells(i, 1) = sname Then
        f1 = Trim$(RDC.Cells(i, 2))
        f2 = Trim$(RDC.Cells(i, 3))
        GoTo A1
    End If
Next i
Set RDC = Nothing
HasInData_Cells = ""
Exit Function
A1:
If Len(f1) > 0 Then HasInData_Cells = f1 + f2 Else HasInData_Cells = "   "
Set RDC = Nothing
End Function

Public Sub InsertToData_Cells(sname As String)
fSaveData_Cells sname, Range(sname).NumberFormat
End Sub

Public Sub ChangeData_Cells(sname As String)
Dim RDC As Range, r As Range, sFormat$

Set RDC = Range("Data_Cells")
Set r = Range(sname)
sFormat = r.NumberFormat
For i = 1 To RDC.Rows.Count
    If RDC.Cells(i, 1) = sname Then
        RDC.Cells(i, 3) = Empty
        If sFormat Like "*[#]*" Then sFormat = Mid$(sFormat, InStrRev(sFormat, "#") + 1)
        If sFormat Like "*0*" Then
           RDC.Cells(i, 2) = "F"
           t = InStr(sFormat, ".")
           If t = 0 Then t = InStr(sFormat, ",")
           If t > 0 Then t = Len(sFormat) - t
           RDC.Cells(i, 3) = t
        Else
            RDC.Cells(i, 2) = "C"
        End If
        Exit Sub
    End If
Next i
End Sub

Public Function CellHasName(r As Range) As Boolean
Dim s$

On Error Resume Next
s = r.name.name
If Len(s) = 0 Then CellHasName = False Else CellHasName = True
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| Data_Cells
Public Function fGetData_Cells() As String()
Dim i As Long, RDC As Range
Dim a() As String

Set RDC = Range("Data_Cells")
ReDim a(RDC.Rows.Count)
For i = 1 To RDC.Rows.Count
    a(i) = RDC.Cells(i, 1).Value
Next i
Set RDC = Nothing
fGetData_Cells = a()
End Function

Public Sub fDeleteFromData_Cells(sname As String)
Dim r As Range

Set r = Range("Data_Cells")
'fUnProtect True, R.Worksheet.Index
For i = r.Rows.Count To 1 Step -1
    If r.Cells(i, 1) Like sname Then r.Rows(i).Delete Shift:=xlUp
Next i
Set r = Nothing
End Sub
Attribute VB_Name = "|fffd||fffd||fffd||fffd|1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "|fffd||fffd||fffd||fffd|2"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "|fffd||fffd||fffd||fffd|3"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
'|fffd||fffd||fffd||fffd||fffd||fffd| 27.04.2018
' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| modSluzFunction |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| UnProtectWorkbook |fffd| ProtectWorkbook - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd|.|fffd|. |fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd|".

'|fffd||fffd||fffd||fffd||fffd||fffd| 23.06.2017
' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| modDetaleSvod d |fffd||fffd||fffd||fffd||fffd||fffd||fffd| fGetObject |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.

'|fffd||fffd||fffd||fffd||fffd||fffd| 13.06.2017
'|fffd| |fffd||fffd||fffd||fffd||fffd||fffd| ConvertData |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| GetFormatUser |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|-|fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'

'|fffd||fffd||fffd||fffd||fffd||fffd| 31.05.2017
'1) |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| integer-|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| Long
'

'|fffd||fffd||fffd||fffd||fffd||fffd| 09.06.2014 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 05.06.2014 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| rascrtgr.clsCreateGroup (modF169n - F169ItogoN)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 30.05.2014 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| cmbSaveAs_Click |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini-|fffd||fffd||fffd||fffd||fffd| IsDeleteNames=ON - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|. |fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ss |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 16.05.2014 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 07.03.2014 |fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|:
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd|"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|:
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| fOpen()
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| PrintActiveWindowAll()
'
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| "ButtonPrintAll" |fffd| ini-|fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 01.02.2014
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 08.07.2013
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| idForm = 169N2013
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 28.02.2013
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|. addRowF169n
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 17.01.2013
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|. AddComandItog, GroupMain, frmInsertRowShow
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 16.01.2013
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 25.12.2012
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| AddItogrows(|fffd||fffd||fffd||fffd||fffd||fffd| modGroupGl) |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini-|fffd||fffd||fffd||fffd||fffd| (F769)
'  DSItog1!NoProtect = |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| :|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|:
'  |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| :|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| DSItog1!NoProtect
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| SaveFromData_Itogi, InsertToData_Itogi, DeleteFromData_Itogi (|fffd||fffd||fffd||fffd||fffd||fffd| modGroupSl)
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| fGetDdataVnew
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 12.12.2012
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| fGetDdataVnew
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| DataEndInsert
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 19.11.2012
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| AddControl (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| TXT, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|)
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| fGetDdataVnew (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| BeforeProc = [|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|] |fffd| INI-|fffd||fffd||fffd||fffd||fffd|)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 28.09.2012
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| ProcessingPic
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 26.09.2012
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| fClickClose (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 10.09.2012
' - |fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd| Workbook_SheetSelectionChange (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'   If Application.ActiveSheet.Pictures("OpenImage").Visible = True Then i = fClickClose()
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| fAddPicture, ProcessingPic
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| fClickOpen, fClickClose
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|. |fffd||fffd||fffd|:
''''''Private Sub Worksheet_BeforeDoubleClick(ByVal Target As Range, Cancel As Boolean)
''''''
''''''    On Error Resume Next
''''''
''''''    DoubleClickForPicture Target.name
''''''
''''''End Sub
''''''
''''''Private Sub DoubleClickForPicture(ByVal CellName As String)
''''''    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
''''''    Dim i As Long
''''''    Dim FlagOnPic As Boolean    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
''''''    Dim strNameRange As String
''''''
''''''    If Len(CellName) > 0 Then
''''''        '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
''''''        strNameRange = Application.Names(, , CStr(CellName)).name
''''''        If Len(strNameRange) > 0 Then
''''''            '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
''''''
''''''            If IsCellForPicture(strNameRange) Then
''''''                '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
''''''                FlagOnPic = PictureItThere(strNameRange)
''''''               'Spiridonova 10.09.2012
''''''               With Application.CommandBars("|fffd||fffd||fffd||fffd|").Controls
''''''                    For i = 1 To .Count
''''''                        If .Item(i).Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| ..." And .Item(i).Enabled = True Then
''''''                            Call fAddPicture
''''''                            Exit For
''''''                        End If
''''''                        If .Item(i).Caption = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" And .Item(i).Enabled = True Then
''''''                            Call fDeletePicture
''''''                            Exit For
''''''                        End If
''''''                    Next
''''''               End With
''''''
''''''
''''''            End If
''''''
''''''
''''''        End If
''''''    End If
''''''
''''''End Sub
'
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 06.09.2012
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| modCommBars.fOpen()  |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| If GetINI("DSItog1!DataSource") <> "" Then AddComandItog
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| ModGroupGl.bas, ModGroupSl.bas
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 30.07.2012
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|. fAddPicture, ProcessingPic (nRows = UBound(arrPic, 2))
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 25.07.2012
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|. fAddPicture, fDeletePicture, ProcessingPic, fGetImage (|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 10.07.2012
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| fGetDdataVnew (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|), fAddPicture
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ProcessingPic
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 20.06.2012
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (08/06/2011). |fffd| ini-|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| OnPic=1 |fffd| PicCells = Kod_OKPO.
'  |fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd| Workbook_SheetSelectionChange (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd|)
'  |fffd||fffd||fffd||fffd||fffd| ActivateForPicture Target.Name |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ActivateForPicture.
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 28.03.2012
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ini-|fffd||fffd||fffd||fffd||fffd| idForm = AddVDE |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|.
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 26.03.2012
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ini-|fffd||fffd||fffd||fffd||fffd| idForm = AddVDE. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| VDE
'  |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"). |fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd| 0503779 (|fffd||fffd||fffd||fffd||fffd||fffd| F779_1)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 16.03.2012
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| modF725 - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd|.0503725. |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd|. 0503125 |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|) |fffd|
'  |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini-|fffd||fffd||fffd||fffd||fffd|. |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|.125
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 24.02.2012
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| fGetDdataVnew (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'  |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| ~800 |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd|.0503125)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 26.12.2011
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| fGetDdataVnew |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| Module1 (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 19.12.2011
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| frmRekvizitShow2 |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| modConstrForm
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 11.07.2011
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| modDetaleSvod (|fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| Fox |fffd| Basic
'  |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 29.06.2011
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| Module1 (|fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| Fox |fffd| Basic )Ivanov 29/06/2011
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 11.02.2011
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| cmbSaveAs_Click (|fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (Range("Data_Cells").Cells(1, 7).Value))
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 10.02.2011
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| fGetDdataVnew (Module1)
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd|. 125(5) |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 01.02.2011
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 169 |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 30 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 31.01.2011
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| lnc2.ini |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| % - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|". |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|
' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| [F127_15]:
'Data_Sheet520!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|=Data_IFR
'Data_Sheet520!Kod = 3%
'Data_Sheet520!Name = 1
'Data_Sheet520!Caption=|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'Data_Sheet620!|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|=Data_IFV
'Data_Sheet620!Kod = 3%
'Data_Sheet620!Name = 1
'Data_Sheet620!Caption=|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 25.01.2011
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 169 |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 30 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|.14 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd| 4 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 17.01.2011 (24.01.2011)
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|.074 (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|). |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'   lnc2.ini: idForm=14_179 - |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|179|fffd| |fffd||fffd| 23.12.20910
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| idForm = 169N (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 169 |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 30 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|) (|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
'
''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
'|fffd||fffd||fffd||fffd||fffd||fffd| 14.10.2009
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 125 |fffd| 169
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 17.09.2009
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| ini-|fffd||fffd||fffd||fffd| LenDopKodForCodName - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'(|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| data_sheet |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|). |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 2. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| UseDataSheetInCodName=ON.
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 10.12.2009
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (182)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 11.12.2009
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd|.125 |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd|.137
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 14.12.2009
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 17.12.2009
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd||fffd| |fffd|.125-2 (|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd| 2008)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 21.12.2009
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd|.125-2
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 29.06.2010
'- |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| fGoSubXLT |fffd||fffd|-|fffd||fffd||fffd| DataEndInsert |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| ModNewRasstanovka.
'  |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (Public Sub fGoSubXLT()) |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 01.10.2010
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| ConvertData |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1|fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 03.11.2010
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| GetConvStr |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| ConvertData (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1|fffd|)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 08.12.2010
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| 1|fffd|)
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| ConvertData
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 27.12.2010
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| idForm = 169N (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 169 |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 30 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|) (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 29.12.2010
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| idForm = 169N (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 169 |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 30 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|) (|fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 12.01.2011
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| idForm = 169N (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 169 |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| 30 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|) (|fffd||fffd||fffd|  |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|)
' - |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| [F169_15]
'
'|fffd||fffd||fffd||fffd||fffd||fffd| 13.01.2011
' - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 14 [F074_14]. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 4-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
'   lnc2.ini: NameAddPd = Data_RCH - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'



Private Sub Workbook_BeforeClose(Cancel As Boolean)
Application.CommandBars("Worksheet Menu Bar").Reset
Application.CommandBars("Column").Reset
Application.CommandBars("Row").Reset
'RemoveForms

Dim i As Long
    
 With Application.VBE.ActiveVBProject.References
     For i = .Count To 1 Step -1
         If UCase(Trim(.Item(i).name)) = "DAO" Then
           .Remove .Item(i)
           Exit For
         End If
     Next
 End With


End Sub

Private Sub Workbook_Open()
'fOpen
'sIniFile = ThisWorkbook.Path & "\aksiok.ini"
''RemoveForms
On Error Resume Next
s = GetRegistrValue & "dao360.dll"
Application.VBE.ActiveVBProject.References.AddFromFile s


End Sub



INQUEST-PP=macro
