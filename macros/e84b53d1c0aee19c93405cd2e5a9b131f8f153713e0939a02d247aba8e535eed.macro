Attribute VB_Name = "M_Dinhdang_batky"
' PHAN 1 - CHON DE VA DANH DAP AN
Public Sub Lay_de_goc_bat_ky()
Application.ScreenUpdating = False
Dim file As Object
'Buoc 1: Mo file de thi
    Dim FileToOpen
    Dim WordDoc As Object
    FileToOpen = Application.GetOpenFilename _
        (Title:="Vui long chon file Word", _
        FileFilter:="Word Files *.do* (*.do*),")
    If FileToOpen = False Then
    Dim thongbao1 As String
    thongbao1 = "B" & ChrW(7841) & "n ch" & ChrW(432) & "a ch" & ChrW(7885) & "n " & ChrW(272) & ChrW(7873) & " thi g" & ChrW(7889) & "c"
    Application.Assistant.DoAlert "TH|fffd|NG B|fffd|O", thongbao1, 0, 4, 0, 0, 0
        
        Exit Sub
    Else
        Set WordDoc = CreateObject("Word.Application")
        WordDoc.Visible = True
        Set file = WordDoc.Documents.Open(FileName:=FileToOpen)
        Dim duongdan As String
        Dim tenfile As String
        Dim tenfile_fix As String
        
        duongdan = file.Path
        Sheets("Information").Range("C19") = duongdan
        tenfile = file.Name
        tenfile_fix = Left(tenfile, Len(tenfile) - 4) & "_dinhdang"

    End If
    
'Buoc 2: Tao cac duong dan
    Dim thongbao2 As String
    thongbao2 = "S" & ChrW(7869) & " m" & ChrW(7845) & "t th" & ChrW(7901) & "i gian, b" & ChrW(7841) & "n vui l|fffd|ng ch" & ChrW(7901) & " " & ChrW(273) & ChrW(7907) & "i t|fffd| nh|fffd|"
    Application.Assistant.DoAlert "TH|fffd|NG B|fffd|O", thongbao2, 0, 4, 0, 0, 0

Sheets("Sheet1").Range("A1:G1000").ClearContents
'Buoc 4: Khai bao cho VBA biet mot hang so cua Word
Const wdCharacter As Long = 1
Const wdParagraph As Long = 4
Const wdLine As Long = 5
Const wdStory As Long = 6
Const wdExtend = 1
Const wdColorRed = 255
Const wdColorBlack = 0
Const wdReplaceAll = 2
Const wdPasteEnhancedMetafile = 9
Const wdHorizontalPositionRelativeToPage = 5
Const wdHorizontalPositionRelativeToTextBoundary = 7
Const wdDialogToolsWordCount = 228
Const wdHeaderFooterPrimary = 1
Const wdAlignParagraphRight = 2
Dim StartWord As String
Dim EndWord As String

'Buoc 5: Paste table as Enhandce Metafile and convert Number to Text
With file
For Each t In file.Tables
    t.Select
With WordDoc.Selection
.Cut
.PasteSpecial DataType:=wdPasteEnhancedMetafile, Placement:=wdInLine
End With
Next
.ConvertNumbersToText
End With

'Remove line with paragraphs symbol:
WordDoc.Selection.WholeStory
With WordDoc.Selection.Find
.Text = "^l"
.Replacement.Text = "^p"
.Forward = True
.Wrap = wdFindContinue
End With
WordDoc.Selection.Find.Execute Replace:=wdReplaceAll


'Buoc 8: Lay vung can copy noi dung de thi
Sheets("Sheet1").Select
Dim n As Long
n = file.Paragraphs.Count
Sheets("Rand_Sentense").Range("B2") = n
With file
.Paragraphs(1).Range.Select
WordDoc.Selection.MoveEnd wdParagraph, n - 1
WordDoc.Selection.Copy
End With
Range("A1").Select
ActiveSheet.PasteSpecial Format:="Unicode Text"
ActiveSheet.Range("A1").Copy
Application.CutCopyMode = False

Sheets("Sheet1").Activate
Sheets("Sheet1").Range("AD1:AM1000").ClearContents

Dim i As Integer
Dim x As Integer

'Buoc 9: Dat cau va dap an

Sheets("Rand_Sentense").Range("C5:C400").ClearContents

For i = 1 To n
    If Cells(i, 28) = "PHAN" Then
        p = p + 1
        Cells(i, 30) = "PHAN_" & p
        Cells(i, 36).Font.Bold = True
        Cells(i, 36) = Left(Cells(i, 1), 2)
        Sheets("Information").Cells(4, 4) = p
    End If
        
    If Left(Cells(i, 28), 3) = "CAU" Then
        x = x + 1
        Cells(i, 32) = "CAU_" & x
        Sheets("Rand_Sentense").Cells(x + 4, 3) = x
    End If
    
    If Right(Cells(i, 28), 2) = "DA" Then
    Cells(i, 34) = "DA_" & x
    End If
    
    If Right(Cells(i, 36), 2) <> "" Then
    Cells(i, 37) = x + 1
    End If
    
    Cells(1, 39) = Cells(1, 36)
    If Cells(i, 36) <> "" Then
    Phan = Cells(i, 36)
    End If
    If Cells(i, 32) <> "" Then Cells(i, 39) = Phan
    
Next i

For i = n To 1 Step -1
'Buoc 10: Lay phan
If Cells(i + 1, 30) <> "" Then B = 0
If Cells(i, 29) = "PHAN" Then B = B + 1
If Cells(i, 30) <> "" Then Cells(i, 31) = B

'Buoc 11:Lay cau
If Cells(i + 1, 32) <> "" Then C = 0
If Left(Cells(i, 29), 3) = "CAU" Then C = C + 1
If Cells(i, 32) <> "" Then Cells(i, 33) = C

'Buoc 12: Lay dap an that
If Cells(i + 1, 34) <> "" Then D = 0
If Cells(i, 29) = "DA" Then D = D + 1
If Cells(i, 34) <> "" Then Cells(i, 35) = D
'Buoc 13: Lay so dong dap an
If Cells(i + 1, 28) <> "" Then d1 = 0
If Cells(i, 28) = "" Then d1 = d1 + 1
If Right(Cells(i, 28), 2) = "DA" Then Cells(i, 40) = d1 + 1
Next i

Sheets("Rand_Sentense").Cells(3, 2) = x
Sheets("Information").Range("D10") = x

'Buoc 14:Tim can tren va duoi
For i = n To 1 Step -1
If Cells(i + 1, 36) <> "" Then B = 0
If Left(Cells(i, 32), 3) = "CAU" And Cells(i, 36) = "" Then B = B + 1
If Cells(i, 36) <> "" Then Cells(i, 38) = B + Cells(i, 37) - 1
Next i


    Sheets("Dap_an").Activate
    Range("B3").Formula = "=COLUMN()-1"
    Range(Cells(3, 3), Cells(7, 51)).Clear
    Range(Cells(8, 1), Cells(500, 200)).Clear
    Range(Cells(3, 2), Cells(7, x + 1)).FillRight
    Range(Cells(3, 2), Cells(3, x + 1)).Value = Range(Cells(3, 2), Cells(3, x + 1)).Value
    Range(Cells(4, 2), Cells(7, x + 1)).Interior.ColorIndex = xlNone

WordDoc.Visible = True
Set file1 = WordDoc.Documents.Open(ThisWorkbook.Path & "\DE GOC.dot")
WordDoc.Visible = True

'Buoc 16:Copy tu de goc sang------------------------------

'PHAN I - LIET KE DAP AN
Sheets("Sheet1").Activate
Dim Macau As String
Dim Maphan As String
Dim Cau As Integer
For Phan = 1 To Sheets("Information").Cells(4, 4)
    Maphan = "PHAN_" & Phan
    dong = Application.Match(Maphan, Range(Cells(1, 30), Cells(n, 30)), 0)
    sodong = Cells(dong, 31).Value
    cau_dau = Cells(dong, 37).Value
    cau_cuoi = Cells(dong, 38).Value
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
With WordDoc.Selection
        .Copy
End With
End With

    file1.Activate
With WordDoc.Selection
        .Paste
End With

'Phan 1: Copy cau hoi
For Cau = cau_dau To cau_cuoi
    On Error Resume Next
    If Cau > Sheets("Information").Range("D10") Then Exit For
    Macau = "CAU_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 32), Cells(n, 32)), 0)
    sodong = Cells(dong, 33).Value
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
End With
    file1.Activate
With WordDoc.Selection
        .Paste
End With
'Phan 2: Copy dap an
If Cells(dong, 39) = "#1" Then
Else

    Macau = "DA_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 34), Cells(n, 34)), 0)
    dongDA = Cells(dong, 35).Value
    dongDAt = Cells(dong, 35).Value
    
    If dongDAt <> 0 Then
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + dongDA - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
End With

    file1.Activate
With WordDoc.Selection
        .Paste
        .MoveUp wdParagraph, dongDAt, wdExtend
        .Paragraphs.TabStops.ClearAll
        .MoveEnd wdCharacter, -1
        .MoveRight
        .TypeText Text:="#"
        .MoveUp wdParagraph, dongDA, wdExtend
End With

Else

    file1.Activate
With WordDoc.Selection
        .MoveUp wdParagraph, sodong, wdExtend
        .Paragraphs.TabStops.ClearAll
        .MoveEnd wdCharacter, -1
        .MoveRight
        .TypeText Text:="#"
        .MoveUp wdParagraph, sodong, wdExtend
End With
    End If
    
With WordDoc.Selection
            .Find.Text = Chr(9)
            .Find.Replacement.Text = " "
            .Find.Execute Replace:=wdReplaceAll
End With

file1.Activate
With WordDoc.Selection
Set rngParagraphs1 = .Range
End With

'Dap an A-B
StartWord = "A."
EndWord = "B."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
If .Find.Found = False Then
'Tim kieu khac, khong tim thay dap an A
Else

With WordDoc.Selection
.MoveEnd , -2
.MoveRight
m = .Information(wdHorizontalPositionRelativeToTextBoundary)
If m <> 0 Then
.TypeParagraph
End If
End With

End If
End With

'Dap an B-C
StartWord = "B."
EndWord = "C."
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
If .Find.Found = False Then
'Tim kieu khac
Else

With WordDoc.Selection
.MoveEnd , -2
.MoveRight
m = .Information(wdHorizontalPositionRelativeToTextBoundary)
If m <> 0 Then
.TypeParagraph
End If
End With

End If
End With

'Dap an C-D
StartWord = "C."
EndWord = "D."
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select

If .Find.Found = False Then
'Tim kieu khac
Else

With WordDoc.Selection
.MoveEnd , -2
.MoveRight
m = .Information(wdHorizontalPositionRelativeToTextBoundary)
If m <> 0 Then
.TypeParagraph
End If
End With

End If
End With
rngParagraphs1.Select

WordDoc.Selection.MoveRight
WordDoc.Selection.TypeParagraph

End If
Next Cau
Next Phan

'Dong fil1
file.Close SaveChanges:=wbDoNotSaveChanges

file1.Activate

'Remove all Space and Indent at first of Paragraph
With file1
WordDoc.Selection.WholeStory
    With WordDoc.Selection.ParagraphFormat
        .LeftIndent = 0
        .RightIndent = 0
        .CharacterUnitLeftIndent = 0
        .CharacterUnitRightIndent = 0
        .CharacterUnitFirstLineIndent = 0
        .FirstLineIndent = 0
    End With
    
'DANG LAM
For Each i1 In file1.Paragraphs
For n1 = 1 To i1.Range.Characters.Count
If i1.Range.Characters(1).Text = " " Or i1.Range.Characters(1).Text = " " Or i1.Range.Characters(1).Text = Chr(9) Then
i1.Range.Characters(1).Delete
Else: Exit For
End If
Next n1

For n1 = 1 To i1.Range.Characters.Count
u = i1.Range.Characters.Count
If u = 1 Then
'WordDoc.Selection.TypeBackspace
Exit For
End If
If i1.Range.Characters(u - 1).Text = " " Or i1.Range.Characters(u - 1).Text = " " Or i1.Range.Characters(u - 1).Text = Chr(9) Or i1.Range.Characters(u - 1).Text = Chr(160) Or i1.Range.Characters(u - 1).Text = "." Then
i1.Range.Characters(u - 1).Select
WordDoc.Selection.TypeBackspace
Else: Exit For
End If
Next n1
Next

End With


'Remove empty paragraphs:
WordDoc.Selection.WholeStory
With WordDoc.Selection.Find
.Text = "^p^p"
.Replacement.Text = "^p"
.Forward = True
.Wrap = wdFindContinue
End With
WordDoc.Selection.Find.Execute Replace:=wdReplaceAll

'Remove all Space at End of Doc
If Len(file1.Range) = 1 Then Exit Sub
With file1
z = .Range.End
Set r = .Range(z - 2, z - 1)
While r.Text = " " Or r.Text = Chr$(13)
r.Delete
z = .Range.End
Set r = .Range(z - 2, z - 1)
Wend
End With

'Lay vung can copy noi dung de thi-------------------
Sheets("Sheet1").Select
Sheets("Sheet1").Range("A1:Q1000").ClearContents
n = file1.Paragraphs.Count
Sheets("Rand_Sentense").Range("B2") = n
With file1
.Paragraphs(1).Range.Select
WordDoc.Selection.MoveEnd wdParagraph, n - 1
WordDoc.Selection.Copy
End With
Range("A1").Select
ActiveSheet.PasteSpecial Format:="Unicode Text"
ActiveSheet.Range("A1").Copy
Application.CutCopyMode = False
'Ket thuc Lay vung can copy noi dung de thi----------

Sheets("Sheet1").Activate
Sheets("Sheet1").Range("AD1:AM1000").ClearContents

'Dat cau va dap an-----------------------------------
p = 0
x = 0
B = 0
C = 0
D = 0
d1 = 0
Sheets("Rand_Sentense").Range("C5:C400").ClearContents
For i = 1 To n
    If Cells(i, 28) = "PHAN" Then
        p = p + 1
        Cells(i, 30) = "PHAN_" & p
        Cells(i, 36).Font.Bold = True
        Cells(i, 36) = Left(Cells(i, 1), 2)
        Sheets("Information").Cells(4, 4) = p
    End If
        
    If Left(Cells(i, 28), 3) = "CAU" Then
        x = x + 1
        Cells(i, 32) = "CAU_" & x
        Sheets("Rand_Sentense").Cells(x + 4, 3) = x
    End If
    
    If Right(Cells(i, 28), 2) = "DA" Then
    Cells(i, 34) = "DA_" & x
    End If
    
    If Right(Cells(i, 36), 2) <> "" Then
    Cells(i, 37) = x + 1
    End If
    
    Cells(1, 39) = Cells(1, 36)
    If Cells(i, 36) <> "" Then
    Phan = Cells(i, 36)
    End If
    If Cells(i, 32) <> "" Then Cells(i, 39) = Phan
    
Next i

For i = n To 1 Step -1
'lay phan
If Cells(i + 1, 30) <> "" Then B = 0
If Cells(i, 29) = "PHAN" Then B = B + 1
If Cells(i, 30) <> "" Then Cells(i, 31) = B

'lay cau
If Cells(i + 1, 32) <> "" Then C = 0
If Left(Cells(i, 29), 3) = "CAU" Then C = C + 1
If Cells(i, 32) <> "" Then Cells(i, 33) = C
'lay dap an that
If Cells(i + 1, 34) <> "" Then D = 0
If Cells(i, 29) = "DA" Then D = D + 1
If Cells(i, 34) <> "" Then Cells(i, 35) = D
'lay so dong dap an
If Cells(i + 1, 28) <> "" Then d1 = 0
If Cells(i, 28) = "" Then d1 = d1 + 1
If Right(Cells(i, 28), 2) = "DA" Then Cells(i, 40) = d1 + 1
Next i

Sheets("Rand_Sentense").Cells(3, 2) = x
Sheets("Information").Range("D10") = x

'Tim can tren va duoi
For i = n To 1 Step -1
If Cells(i + 1, 36) <> "" Then B = 0
If Left(Cells(i, 32), 3) = "CAU" And Cells(i, 36) = "" Then B = B + 1
If Cells(i, 36) <> "" Then Cells(i, 38) = B + Cells(i, 37) - 1
Next i

'Copy so luong cau hoi----------------------------
    Sheets("Dap_an").Activate
    Range("B3").Formula = "=COLUMN()-1"
    Range(Cells(3, 3), Cells(7, 51)).Clear
    Range(Cells(8, 1), Cells(500, 200)).Clear
    Range(Cells(3, 2), Cells(7, x + 1)).FillRight
    Range(Cells(3, 2), Cells(3, x + 1)).Value = Range(Cells(3, 2), Cells(3, x + 1)).Value
    Range(Cells(4, 2), Cells(7, x + 1)).Interior.ColorIndex = xlNone

'Dong file
file.Close SaveChanges:=wbDoNotSaveChanges
'Save file da liet ke dap an
'-----
'PHAN II _ LAY CHIEU DAI DAP AN
Sheets("Sheet1").Range("AQ1:AT1000").ClearContents
file1.Activate
Sheets("Sheet1").Activate
For Phan = 1 To Sheets("Information").Cells(4, 4)
    Maphan = "PHAN_" & Phan
    dong = Application.Match(Maphan, Range(Cells(1, 30), Cells(n, 30)), 0)
    sodong = Cells(dong, 31).Value
    cau_dau = Cells(dong, 37).Value
    cau_cuoi = Cells(dong, 38).Value

'Phan 1: Copy cau hoi
For Cau = cau_dau To cau_cuoi
    On Error Resume Next
    If Cau > Sheets("Information").Range("D10") Then Exit For
    Macau = "CAU_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 32), Cells(n, 32)), 0)
    sodong = Cells(dong, 33).Value

'Phan 2: Copy dap an
If Cells(dong, 39) = "#1" Then
Else

    Macau = "DA_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 34), Cells(n, 34)), 0)
    dongDA = Cells(dong, 35).Value
    dongDAt = Cells(dong, 35).Value
    
    If dongDAt <> 0 Then
With file1
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + dongDA - 1).Range.End)
            rngParagraphs.Select
End With
    End If

file1.Activate
With WordDoc.Selection
Set rngParagraphs1 = .Range
End With

'Dap an A-B
StartWord = "A."
EndWord = "B."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveUp wdParagraph, 1, Extend:=wdExtend
WordDoc.Selection.MoveEnd , -1

    With WordDoc.Dialogs(wdDialogToolsWordCount)
        .Execute
        numpara = .Lines
    End With
    
vitri_dau = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
WordDoc.Selection.MoveRight
vitri_cuoi = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
len_da = vitri_cuoi - vitri_dau + (numpara - 1) * 465

Sheets("Sheet1").Cells(dong, 43) = len_da

'Dap an B-C
StartWord = "B."
EndWord = "C."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveUp wdParagraph, 1, Extend:=wdExtend
WordDoc.Selection.MoveEnd , -1

    With WordDoc.Dialogs(wdDialogToolsWordCount)
        .Execute
        numpara = .Lines
    End With
vitri_dau = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
WordDoc.Selection.MoveRight
vitri_cuoi = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
len_da = vitri_cuoi - vitri_dau + (numpara - 1) * 465

Sheets("Sheet1").Cells(dong, 44) = len_da

'Dap an C-D
StartWord = "C."
EndWord = "D."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveUp wdParagraph, 1, Extend:=wdExtend
WordDoc.Selection.MoveEnd , -1

    With WordDoc.Dialogs(wdDialogToolsWordCount)
        .Execute
        numpara = .Lines
    End With
vitri_dau = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
WordDoc.Selection.MoveRight
vitri_cuoi = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
len_da = vitri_cuoi - vitri_dau + (numpara - 1) * 465

Sheets("Sheet1").Cells(dong, 45) = len_da

'Dap an D-.End
StartWord = "D."
EndWord = "#"
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
    With WordDoc.Dialogs(wdDialogToolsWordCount)
        .Execute
        numpara = .Lines
    End With
    WordDoc.Selection.MoveStart wdCharacter, 2
vitri_dau = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
WordDoc.Selection.MoveRight
vitri_cuoi = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
len_da = (vitri_cuoi - vitri_dau) + (numpara - 1) * 465
Sheets("Sheet1").Cells(dong, 46) = len_da
End With
End If
Next Cau
Next Phan


'-----
file1.SaveAs FileName:=duongdan & "\" & tenfile_fix & ".doc"
Sheets("Information").Range("C9") = file1.Name
Application.ScreenUpdating = False

WordDoc.Quit
'Ket thuc tao folder luu de
Sheets("Information").Activate
Range("D3").Select
Application.ScreenUpdating = True
End Sub


Sub Dinh_dang_de_thi_bat_ky()
On Error GoTo Error_handler:
Application.ScreenUpdating = False
Dim file As Object
    Dim WordDoc As Object
        Set WordDoc = CreateObject("Word.Application")
        WordDoc.Visible = True
        Set file = WordDoc.Documents.Open(Sheets("Information").Range("C19") & "\" & Sheets("Information").Range("C9"))

WordDoc.Visible = True
Set file1 = WordDoc.Documents.Open(ThisWorkbook.Path & "\DE GOC.dot")
WordDoc.Visible = True
WordDoc.Options.SmartCutPaste = False
'Khai bao cho VBA biet mot hang so cua Word
Const wdCharacter As Long = 1
Const wdParagraph As Long = 4
Const wdLine As Long = 5
Const wdStory As Long = 6
Const wdExtend = 1
Const wdColorRed = 255
Const wdColorBlack = 0
Const wdReplaceAll = 2
Const wdPasteEnhancedMetafile = 9
Const wdHorizontalPositionRelativeToPage = 5
Const wdHorizontalPositionRelativeToTextBoundary = 7
Const wdDialogToolsWordCount = 228
Const wdHeaderFooterPrimary = 1
Const wdAlignParagraphRight = 2
Dim StartWord As String
Dim EndWord As String

n = file.Paragraphs.Count
Sheets("Sheet1").Activate

'PHAN I - LIET KE DAP AN
Sheets("Sheet1").Activate
Dim Macau As String
Dim Maphan As String
Dim Cau As Integer

For Phan = 1 To Sheets("Information").Cells(4, 4)
    Maphan = "PHAN_" & Phan
    dong = Application.Match(Maphan, Range(Cells(1, 30), Cells(n, 30)), 0)
    sodong = Cells(dong, 31).Value
    cau_dau = Cells(dong, 37).Value
    cau_cuoi = Cells(dong, 38).Value

With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
            WordDoc.Selection.Copy
End With
    file1.Activate
With WordDoc.Selection
        .Paste
End With

'Phan 1: Copy cau hoi
For Cau = cau_dau To cau_cuoi
    If Cau > Sheets("Information").Range("D10") Then Exit For
    Macau = "CAU_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 32), Cells(n, 32)), 0)
    sodong = Cells(dong, 33).Value

With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
            WordDoc.Selection.Copy
End With

            file1.Activate
            WordDoc.Selection.Paste
'Phan 2: Copy dap an cau co dap an
If Cells(dong, 28) = "CAU_DA" Then
       file1.Activate
With WordDoc.Selection
        .MoveUp wdParagraph, sodong, wdExtend
End With
 
    Macau = "DA_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 34), Cells(n, 34)), 0)
    dongDA = Cells(dong, 40).Value
    dongDAt = Cells(dong, 40).Value
    If dongDAt <> 0 Then
    
    With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + dongDA - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
    End With

    file1.Activate
    With WordDoc.Selection
        .Paste
        .MoveUp wdParagraph, dongDA, wdExtend
        
    End With

    Else

    file1.Activate
With WordDoc.Selection
        .MoveUp wdParagraph, sodong, wdExtend
End With
    End If

End If

If Cells(dong, 28) = "CAU_DA" Then
With WordDoc.Selection
            .Find.Text = Chr(9)
            .Find.Replacement.Text = " "
            .Find.Execute Replace:=wdReplaceAll
End With
End If

'Phan 3: Copy dap an cau va dap an rieng
If Cells(dong, 28) = "CAU" And Cells(dong, 39) = "#3" Then
       file1.Activate
    Macau = "DA_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 34), Cells(n, 34)), 0)
    dongDA = Cells(dong, 40).Value
    dongDAt = Cells(dong, 40).Value
    With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + dongDA - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
    End With

    file1.Activate
    With WordDoc.Selection
        .Paste
        .MoveUp wdParagraph, dongDA, wdExtend
    
    End With

End If
'Ket thuc copy dap an cau va dap an rieng
   file1.Activate
With WordDoc.Selection
On Error Resume Next
Set rngParagraphs1 = .Range
For n1 = 1 To rngParagraphs1.Characters.Count
'Remove all Space at end of Paragraph
u = rngParagraphs1.Characters.Count
If rngParagraphs1.Characters(u - 1).Text = " " Or rngParagraphs1.Characters(u - 1).Text = " " Or rngParagraphs1.Characters(u - 1).Text = Chr(9) Or rngParagraphs1.Characters(u - 1).Text = Chr(160) Then
rngParagraphs1.Characters(u - 1).Select
WordDoc.Selection.TypeBackspace
Else: Exit For
End If
Next n1

'Remove all Space at first of Paragraph
For n1 = 1 To rngParagraphs1.Characters.Count
If rngParagraphs1.Characters(1).Text = " " Or rngParagraphs1.Characters(1).Text = " " Or rngParagraphs1.Characters(1).Text = Chr(9) Then
rngParagraphs1.Characters(1).Delete
Else: Exit For
End If
Next n1
End With

    dongDAhc = Cells(dong, 48).Value
    vtabStop1 = Cells(dong, 49).Value
    vtabStop2 = Cells(dong, 50).Value
    vtabStop3 = Cells(dong, 51).Value
    
    'Them TabStop
file1.Activate
If vtabStop1 <> 0 Then
WordDoc.Selection.Paragraphs.TabStops.Add vtabStop1
End If

If vtabStop2 <> 0 Then
WordDoc.Selection.Paragraphs.TabStops.Add vtabStop2
End If

If vtabStop3 <> 0 Then
WordDoc.Selection.Paragraphs.TabStops.Add vtabStop3
End If


If dongDAhc = 2 Then
'Dap an A-B
StartWord = "A."
EndWord = "B."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an C-D
StartWord = "C."
EndWord = "D."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an D-#
StartWord = "D."
EndWord = "#"

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -1
WordDoc.Selection.MoveRight
WordDoc.Selection.Delete


End If

If dongDAhc = 1 Then
'Dap an A-B
StartWord = "A."
EndWord = "B."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an B-C
StartWord = "B."
EndWord = "C."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an C-D
StartWord = "C."
EndWord = "D."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an D-#
StartWord = "D."
EndWord = "#"

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -1
WordDoc.Selection.MoveRight
WordDoc.Selection.Delete

End If
If dongDAhc = 4 Then
'Dap an D-#
StartWord = "D."
EndWord = "#"

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -1
WordDoc.Selection.MoveRight
WordDoc.Selection.Delete

End If

WordDoc.Selection.TypeParagraph
Next Cau
Next Phan
'Remove all Space and Indent at first of Paragraph
WordDoc.Selection.WholeStory
WordDoc.Selection.Paragraphs.LeftIndent = 0
WordDoc.Selection.Paragraphs.RightIndent = 0

'Remove all Space at End of Doc
If Len(file1.Range) = 1 Then Exit Sub
With file1
z = .Range.End
Set r = .Range(z - 2, z - 1)
While r.Text = " " Or r.Text = Chr$(13)
r.Delete
z = .Range.End
Set r = .Range(z - 2, z - 1)
Wend
End With

tenfile = file.Name
file.Close SaveChanges:=wbDoNotSaveChanges
FileName = Left(tenfile, Len(tenfile) - 4)
file1.SaveAs FileName:=Sheets("Information").Range("C19") & "\" & FileName & ".doc"

Sheets("Sheet1").Range("A1").Copy
WordDoc.Quit
Application.CutCopyMode = False

Sheets("Information").Activate
Call OpenFolderDemo_de_thi_bat_ky
Range("D3").Select

Error_handler: WordDoc.Quit

'KET THUC DINH DANG
End Sub


Attribute VB_Name = "M_Dinhdang_goc"
Sub Dinh_dang_de_thi_goc()

Application.ScreenUpdating = False
Dim file As Object
    Dim WordDoc As Object
        Set WordDoc = CreateObject("Word.Application")
        WordDoc.Visible = True
        Set file = WordDoc.Documents.Open(Sheets("Information").Range("C12") & "\" & Sheets("Information").Range("C9"))

WordDoc.Visible = True
Set file1 = WordDoc.Documents.Open(ThisWorkbook.Path & "\DE GOC.dot")
WordDoc.Visible = True
WordDoc.Options.SmartCutPaste = False
'Khai bao cho VBA biet mot hang so cua Word
Const wdCharacter As Long = 1
Const wdParagraph As Long = 4
Const wdLine As Long = 5
Const wdStory As Long = 6
Const wdExtend = 1
Const wdColorRed = 255
Const wdColorBlack = 0
Const wdReplaceAll = 2
Const wdPasteEnhancedMetafile = 9
Const wdHorizontalPositionRelativeToPage = 5
Const wdHorizontalPositionRelativeToTextBoundary = 7
Const wdDialogToolsWordCount = 228
Const wdHeaderFooterPrimary = 1
Const wdAlignParagraphRight = 2
Dim StartWord As String
Dim EndWord As String

n = file.Paragraphs.Count
Sheets("Sheet1").Activate

'PHAN I - LIET KE DAP AN
Sheets("Sheet1").Activate
Dim Macau As String
Dim Maphan As String
Dim Cau As Integer

For Phan = 1 To Sheets("Information").Cells(4, 4)
    Maphan = "PHAN_" & Phan
    dong = Application.Match(Maphan, Range(Cells(1, 30), Cells(n, 30)), 0)
    sodong = Cells(dong, 31).Value
    cau_dau = Cells(dong, 37).Value
    cau_cuoi = Cells(dong, 38).Value

With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
            WordDoc.Selection.Copy
End With
    file1.Activate
With WordDoc.Selection
        .Paste
End With

'Phan 1: Copy cau hoi
For Cau = cau_dau To cau_cuoi
    If Cau > Sheets("Information").Range("D10") Then Exit For
    Macau = "CAU_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 32), Cells(n, 32)), 0)
    sodong = Cells(dong, 33).Value

With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
            WordDoc.Selection.Copy
End With

            file1.Activate
            WordDoc.Selection.Paste
'Phan 2: Copy dap an cau co dap an
If Cells(dong, 28) = "CAU_DA" Then
       file1.Activate
With WordDoc.Selection
        .MoveUp wdParagraph, sodong, wdExtend
End With
 
    Macau = "DA_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 34), Cells(n, 34)), 0)
    dongDA = Cells(dong, 40).Value
    dongDAt = Cells(dong, 40).Value
    If dongDAt <> 0 Then
    
    With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + dongDA - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
    End With

    file1.Activate
    With WordDoc.Selection
        .Paste
        .MoveUp wdParagraph, dongDA, wdExtend
        
    End With

    Else

    file1.Activate
With WordDoc.Selection
        .MoveUp wdParagraph, sodong, wdExtend
End With
    End If

End If

If Cells(dong, 28) = "CAU_DA" Then
With WordDoc.Selection
            .Find.Text = Chr(9)
            .Find.Replacement.Text = " "
            .Find.Execute Replace:=wdReplaceAll
End With
End If

'Phan 3: Copy dap an cau va dap an rieng
If Cells(dong, 28) = "CAU" And Cells(dong, 39) = "#3" Then
       file1.Activate
    Macau = "DA_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 34), Cells(n, 34)), 0)
    dongDA = Cells(dong, 40).Value
    dongDAt = Cells(dong, 40).Value
    With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + dongDA - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
    End With

    file1.Activate
    With WordDoc.Selection
        .Paste
        .MoveUp wdParagraph, dongDA, wdExtend
    
    End With

End If
'Ket thuc copy dap an cau va dap an rieng
   file1.Activate
With WordDoc.Selection
On Error Resume Next
Set rngParagraphs1 = .Range
For n1 = 1 To rngParagraphs1.Characters.Count
'Remove all Space at end of Paragraph
u = rngParagraphs1.Characters.Count
If rngParagraphs1.Characters(u - 1).Text = " " Or rngParagraphs1.Characters(u - 1).Text = " " Or rngParagraphs1.Characters(u - 1).Text = Chr(9) Or rngParagraphs1.Characters(u - 1).Text = Chr(160) Then
rngParagraphs1.Characters(u - 1).Select
WordDoc.Selection.TypeBackspace
Else: Exit For
End If
Next n1

'Remove all Space at first of Paragraph
For n1 = 1 To rngParagraphs1.Characters.Count
If rngParagraphs1.Characters(1).Text = " " Or rngParagraphs1.Characters(1).Text = " " Or rngParagraphs1.Characters(1).Text = Chr(9) Then
rngParagraphs1.Characters(1).Delete
Else: Exit For
End If
Next n1
End With

    dongDAhc = Cells(dong, 48).Value
    vtabStop1 = Cells(dong, 49).Value
    vtabStop2 = Cells(dong, 50).Value
    vtabStop3 = Cells(dong, 51).Value
    
    'Them TabStop
file1.Activate
If vtabStop1 <> 0 Then
WordDoc.Selection.Paragraphs.TabStops.Add vtabStop1
End If

If vtabStop2 <> 0 Then
WordDoc.Selection.Paragraphs.TabStops.Add vtabStop2
End If

If vtabStop3 <> 0 Then
WordDoc.Selection.Paragraphs.TabStops.Add vtabStop3
End If


If dongDAhc = 2 Then
'Dap an A-B
StartWord = "A."
EndWord = "B."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an C-D
StartWord = "C."
EndWord = "D."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an D-#
StartWord = "D."
EndWord = "#"

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -1
WordDoc.Selection.MoveRight
WordDoc.Selection.Delete


End If

If dongDAhc = 1 Then
'Dap an A-B
StartWord = "A."
EndWord = "B."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an B-C
StartWord = "B."
EndWord = "C."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an C-D
StartWord = "C."
EndWord = "D."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an D-#
StartWord = "D."
EndWord = "#"

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -1
WordDoc.Selection.MoveRight
WordDoc.Selection.Delete

End If
If dongDAhc = 4 Then
'Dap an D-#
StartWord = "D."
EndWord = "#"

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -1
WordDoc.Selection.MoveRight
WordDoc.Selection.Delete

End If

WordDoc.Selection.TypeParagraph
Next Cau
Next Phan
'Remove all Space and Indent at first of Paragraph
WordDoc.Selection.WholeStory
WordDoc.Selection.Paragraphs.LeftIndent = 0
WordDoc.Selection.Paragraphs.RightIndent = 0

'Remove all Space at End of Doc
If Len(file1.Range) = 1 Then Exit Sub
With file1
z = .Range.End
Set r = .Range(z - 2, z - 1)
While r.Text = " " Or r.Text = Chr$(13)
r.Delete
z = .Range.End
Set r = .Range(z - 2, z - 1)
Wend
End With

tenfile = file.Name
FileName = Left(tenfile, Len(tenfile) - 4) & "_dinhdang"
file1.SaveAs FileName:=Sheets("Information").Range("C12") & "\" & FileName & ".doc"

Sheets("Sheet1").Range("A1").Copy
WordDoc.Quit
Application.CutCopyMode = False

Sheets("Information").Activate
Call OpenFolderDemo_dethi_goc
Range("D3").Select

Error_handler: 'WordDoc.Quit
'KET THUC DINH DANG
End Sub
Attribute VB_Name = "M_Dinhdang_hoanvi"
Sub Dinh_dang_de_thi_da_xuat()
'PHAN 1 - LAY DE DINH DANG - 12-03-2019
On Error GoTo Error_handler:
Application.ScreenUpdating = False
Dim De As Integer
For De = 1 To Sheets("Information").Range("D3")
Dim file As Object
    Dim WordDoc As Object
        Set WordDoc = CreateObject("Word.Application")
        WordDoc.Visible = True
        Set file = WordDoc.Documents.Open(Sheets("Information").Range("C18") & "\" & Sheets("Information").Cells(21 + De, 3))
WordDoc.Visible = True
WordDoc.Options.SmartCutPaste = False
'Khai bao cho VBA biet mot hang so cua Word
Const wdCharacter As Long = 1
Const wdParagraph As Long = 4
Const wdLine As Long = 5
Const wdStory As Long = 6
Const wdExtend = 1
Const wdColorRed = 255
Const wdColorBlack = 0
Const wdReplaceAll = 2
Const wdPasteEnhancedMetafile = 9
Const wdHorizontalPositionRelativeToPage = 5
Const wdHorizontalPositionRelativeToTextBoundary = 7
Const wdDialogToolsWordCount = 228
Const wdHeaderFooterPrimary = 1
Const wdAlignParagraphRight = 2
Dim StartWord As String
Dim EndWord As String

Sheets("Sheet3").Activate
Sheets("Sheet3").Range("A1:Q1000").ClearContents
n = file.Paragraphs.Count
With file
.Paragraphs(1).Range.Select
WordDoc.Selection.MoveEnd wdParagraph, n - 1
WordDoc.Selection.Copy
End With
Range("A1").Select
ActiveSheet.PasteSpecial Format:="Unicode Text"
ActiveSheet.Range("A1").Copy
Application.CutCopyMode = False
'Ket thuc Lay vung can copy noi dung de thi
Sheets("Sheet3").Activate
Sheets("Sheet3").Range("AD1:AN1000").ClearContents
Sheets("Sheet3").Range("BA1:BB1000").ClearContents

'Dat cau va dap an
p = 0
x = 0
B = 0
C = 0
D = 0
d1 = 0
For i = 1 To n
    If Cells(i, 28) = "PHAN" Then
        p = p + 1
        Cells(i, 30) = "PHAN_" & p
        Cells(i, 36).Font.Bold = True
        Cells(i, 36) = Left(Cells(i, 1), 2)
        Sheets("Information").Cells(4, 4) = p
    End If
        
    If Left(Cells(i, 28), 3) = "CAU" Then
        x = x + 1
        Cells(i, 32) = "CAU_" & x
        Cells(i, 53) = "CAU_" & Sheets("Rand_Sentense").Cells(x + 4, De + 3)
    End If
    
    If Right(Cells(i, 28), 2) = "DA" Then
    Cells(i, 34) = "DA_" & x
    Cells(i, 54) = "DA_" & Sheets("Rand_Sentense").Cells(x + 4, De + 3)
    End If
    
    If Right(Cells(i, 36), 2) <> "" Then
    Cells(i, 37) = x + 1
    End If
    
    Cells(1, 39) = Cells(1, 36)
    If Cells(i, 36) <> "" Then
    Phan = Cells(i, 36)
    End If
    If Cells(i, 32) <> "" Then Cells(i, 39) = Phan
    
Next i

For i = n To 1 Step -1
'lay phan
If Cells(i + 1, 30) <> "" Then B = 0
If Cells(i, 29) = "PHAN" Then B = B + 1
If Cells(i, 30) <> "" Then Cells(i, 31) = B

'lay cau
If Cells(i + 1, 32) <> "" Then C = 0
If Left(Cells(i, 29), 3) = "CAU" Then C = C + 1
If Cells(i, 32) <> "" Then Cells(i, 33) = C
'lay dap an that
If Cells(i + 1, 34) <> "" Then D = 0
If Cells(i, 29) = "DA" Then D = D + 1
If Cells(i, 34) <> "" Then Cells(i, 35) = D
'lay so dong dap an
If Cells(i + 1, 28) <> "" Then d1 = 0
If Cells(i, 28) = "" Then d1 = d1 + 1
If Right(Cells(i, 28), 2) = "DA" Then Cells(i, 40) = d1 + 1
Next i

Sheets("Rand_Sentense").Cells(3, 2) = x
Sheets("Information").Range("D10") = x

'Tim can tren va duoi
For i = n To 1 Step -1
If Cells(i + 1, 36) <> "" Then B = 0
If Left(Cells(i, 32), 3) = "CAU" And Cells(i, 36) = "" Then B = B + 1
If Cells(i, 36) <> "" Then Cells(i, 38) = B + Cells(i, 37) - 1
Next i

'Copy so luong cau hoi----------------------------
Sheets("Rand_Sentense").Range("C5:C400").ClearContents
For i = 1 To x
        Sheets("Rand_Sentense").Cells(i + 4, 3) = i
Next i

'KET THUC LAY DE DINH DANG
'-----
'PHAN 2 - DINH DANG
Set file1 = WordDoc.Documents.Open(ThisWorkbook.Path & "\DE GOC.dot")

Sheets("Sheet3").Activate

For Phan = 1 To Sheets("Information").Cells(4, 4)
    Maphan = "PHAN_" & Phan
    dong = Application.Match(Maphan, Range(Cells(1, 30), Cells(n, 30)), 0)
    sodong = Cells(dong, 31).Value
    cau_dau = Cells(dong, 37).Value
    cau_cuoi = Cells(dong, 38).Value

With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
            WordDoc.Selection.Copy
End With
    file1.Activate
With WordDoc.Selection
        .Paste
End With

'Phan 1: Copy cau hoi
For Cau = cau_dau To cau_cuoi
    If Cau > Sheets("Information").Range("D10") Then Exit For
    Macau = "CAU_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 32), Cells(n, 32)), 0)
    sodong = Cells(dong, 55).Value
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
            WordDoc.Selection.Copy
End With

            file1.Activate
            WordDoc.Selection.Paste
'Phan 2: Copy dap an
If Cells(dong, 28) = "CAU_DA" Then
       file1.Activate
With WordDoc.Selection
        .MoveUp wdParagraph, sodong, wdExtend
End With
 
    Macau = "DA_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 34), Cells(n, 34)), 0)
    dongDA = Cells(dong, 56).Value
    dongDAt = Cells(dong, 56).Value
    If dongDAt <> 0 Then
    
    With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + dongDA - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
    End With

    file1.Activate
    With WordDoc.Selection
        .Paste
        .MoveUp wdParagraph, dongDA, wdExtend
        
    End With

    Else

    file1.Activate
With WordDoc.Selection
        .MoveUp wdParagraph, sodong, wdExtend
End With
    End If

End If

If Cells(dong, 28) = "CAU_DA" Then
With WordDoc.Selection
            .Find.Text = Chr(9)
            .Find.Replacement.Text = " "
            .Find.Execute Replace:=wdReplaceAll
End With
End If

'Ket thuc copy dap an cau co dap an

'Phan 3: Copy dap an cau va dap an rieng
If Cells(dong, 28) = "CAU" And Cells(dong, 39) <> "#1" Then
       file1.Activate
    Macau = "DA_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 34), Cells(n, 34)), 0)
    dongDA = Cells(dong, 40).Value
    dongDAt = Cells(dong, 40).Value
    With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + dongDA - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
    End With

    file1.Activate
    With WordDoc.Selection
        .Paste
        .MoveUp wdParagraph, dongDA, wdExtend
    
    End With

End If
'Ket thuc copy dap an cau va dap an rieng

   file1.Activate
With WordDoc.Selection
On Error Resume Next
Set rngParagraphs1 = .Range
For n1 = 1 To rngParagraphs1.Characters.Count
'Remove all Space at end of Paragraph
u = rngParagraphs1.Characters.Count
If rngParagraphs1.Characters(u - 1).Text = " " Or rngParagraphs1.Characters(u - 1).Text = " " Or rngParagraphs1.Characters(u - 1).Text = Chr(9) Or rngParagraphs1.Characters(u - 1).Text = Chr(160) Then
rngParagraphs1.Characters(u - 1).Select
WordDoc.Selection.TypeBackspace
Else: Exit For
End If
Next n1

'Remove all Space at first of Paragraph
For n1 = 1 To rngParagraphs1.Characters.Count
If rngParagraphs1.Characters(1).Text = " " Or rngParagraphs1.Characters(1).Text = " " Or rngParagraphs1.Characters(1).Text = Chr(9) Then
rngParagraphs1.Characters(1).Delete
Else: Exit For
End If
Next n1
End With

    dongDAhc = Cells(dong, 48).Value
    vtabStop1 = Cells(dong, 49).Value
    vtabStop2 = Cells(dong, 50).Value
    vtabStop3 = Cells(dong, 51).Value
    
    'Them TabStop
file1.Activate
If vtabStop1 <> 0 Then
WordDoc.Selection.Paragraphs.TabStops.Add vtabStop1
End If

If vtabStop2 <> 0 Then
WordDoc.Selection.Paragraphs.TabStops.Add vtabStop2
End If

If vtabStop3 <> 0 Then
WordDoc.Selection.Paragraphs.TabStops.Add vtabStop3
End If


If dongDAhc = 2 Then
'Dap an A-B
StartWord = "A."
EndWord = "B."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an C-D
StartWord = "C."
EndWord = "D."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an D-#
StartWord = "D."
EndWord = "#"

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -1
WordDoc.Selection.MoveRight
WordDoc.Selection.Delete


End If

If dongDAhc = 1 Then
'Dap an A-B
StartWord = "A."
EndWord = "B."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an B-C
StartWord = "B."
EndWord = "C."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an C-D
StartWord = "C."
EndWord = "D."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -2
WordDoc.Selection.MoveRight
WordDoc.Selection.TypeBackspace
WordDoc.Selection.TypeText Text:=vbTab

'Dap an D-#
StartWord = "D."
EndWord = "#"

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -1
WordDoc.Selection.MoveRight
WordDoc.Selection.Delete

End If
If dongDAhc = 4 Then
'Dap an D-#
StartWord = "D."
EndWord = "#"

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveEnd , -1
WordDoc.Selection.MoveRight
WordDoc.Selection.Delete

End If

WordDoc.Selection.TypeParagraph
Next Cau
Next Phan
'Remove all Space and Indent at first of Paragraph
WordDoc.Selection.WholeStory
WordDoc.Selection.Paragraphs.LeftIndent = 0
WordDoc.Selection.Paragraphs.RightIndent = 0

'Remove all Space at End of Doc
If Len(file1.Range) = 1 Then Exit Sub
With file1
z = .Range.End
Set r = .Range(z - 2, z - 1)
While r.Text = " " Or r.Text = Chr$(13)
r.Delete
z = .Range.End
Set r = .Range(z - 2, z - 1)
Wend
End With

tenfile = file.Name
file.Close SaveChanges:=wbDoNotSaveChanges
FileName = Left(tenfile, Len(tenfile) - 4) & "_dinhdang"
file1.SaveAs FileName:=Sheets("Information").Range("C18") & "\" & FileName & ".doc"
file1.Close
WordDoc.Quit
Next De

'KET THUC DINH DANG
Application.ScreenUpdating = False
'Ket thuc tao folder luu de
Sheets("Information").Activate
Call OpenFolderDemo_dethi_xuat
Error_handler: WordDoc.Quit
Application.ScreenUpdating = True
End Sub

Attribute VB_Name = "M_Hoan_vi"
' PHAN 1 - CHON DE VA DANH DAP AN
Public Sub Dap_an_de_goc()
Application.ScreenUpdating = False
Dim file As Object
'Buoc 1: Mo file de thi
    Dim FileToOpen
    Dim WordDoc As Object
    FileToOpen = Application.GetOpenFilename _
        (Title:="Vui long chon file Word", _
        FileFilter:="Word Files *.do* (*.do*),")
    If FileToOpen = False Then
    Dim thongbao1 As String
    thongbao1 = "B" & ChrW(7841) & "n ch" & ChrW(432) & "a ch" & ChrW(7885) & "n " & ChrW(272) & ChrW(7873) & " thi g" & ChrW(7889) & "c"
    Application.Assistant.DoAlert "TH|fffd|NG B|fffd|O", thongbao1, 0, 4, 0, 0, 0
        
        Exit Sub
    Else
        Set WordDoc = CreateObject("Word.Application")
        WordDoc.Visible = True
        Set file = WordDoc.Documents.Open(FileName:=FileToOpen)
        Dim duongdan As String
        Dim tenfile As String
        Dim tenfile_fix As String
        
        duongdan = file.Path
        Sheets("Information").Range("C19") = duongdan
        tenfile = file.Name
        tenfile_fix = Left(tenfile, Len(tenfile) - 4) & "_YM"

        Sheets("Information").Range("C19") = duongdan
    End If
    
'Buoc 2: Tao cac duong dan
    Dim thongbao2 As String
    thongbao2 = ChrW(272) & "ang chu" & ChrW(7849) & "n h|fffd|a " & ChrW(272) & ChrW(7873) & " thi g" & ChrW(7889) & "c c" & ChrW(7911) & "a b" & ChrW(7841) & "n - Vui l|fffd|ng ch" & ChrW(7901) & " trong gi|fffd|y l|fffd|t"
    Application.Assistant.DoAlert "TH|fffd|NG B|fffd|O", thongbao2, 0, 4, 0, 0, 0
    duongdan_fix = duongdan & "\De_thi_goc"
    Sheets("Information").Range("C12") = duongdan_fix
    duongdan_file = duongdan & "\De_thi_hoan_vi " & Format$(Date, "dd-mm-yyyy") & " " & Format$(Time, "hh-mm-ss")
    Sheets("Information").Range("C18") = duongdan_file

'Buoc 3: Tao folder luu de
    Call Tao_folder
Sheets("Sheet1").Range("A1:G1000").ClearContents
'Buoc 4: Khai bao cho VBA biet mot hang so cua Word
Const wdCharacter As Long = 1
Const wdParagraph As Long = 4
Const wdLine As Long = 5
Const wdStory As Long = 6
Const wdExtend = 1
Const wdColorRed = 255
Const wdColorBlack = 0
Const wdReplaceAll = 2
Const wdPasteEnhancedMetafile = 9
Const wdHorizontalPositionRelativeToPage = 5
Const wdHorizontalPositionRelativeToTextBoundary = 7
Const wdDialogToolsWordCount = 228
Const wdHeaderFooterPrimary = 1
Const wdAlignParagraphRight = 2
Dim StartWord As String
Dim EndWord As String

'Buoc 5: Paste table as Enhandce Metafile and convert Number to Text
With file
For Each t In file.Tables
    t.Select
With WordDoc.Selection
.Cut
.PasteSpecial DataType:=wdPasteEnhancedMetafile, Placement:=wdInLine
End With
Next
.ConvertNumbersToText
End With

'Remove line with paragraphs symbol:
WordDoc.Selection.WholeStory
With WordDoc.Selection.Find
.Text = "^l"
.Replacement.Text = "^p"
.Forward = True
.Wrap = wdFindContinue
End With
WordDoc.Selection.Find.Execute Replace:=wdReplaceAll
'Remove Section with paragraphs symbol:
WordDoc.Selection.WholeStory
With WordDoc.Selection.Find
.Text = "^b"
.Replacement.Text = "^p"
.Forward = True
.Wrap = wdFindContinue
End With
WordDoc.Selection.Find.Execute Replace:=wdReplaceAll

'Remove Space of first Paragraph
WordDoc.Selection.WholeStory
With WordDoc.Selection.ParagraphFormat
        .SpaceBeforeAuto = False
        .SpaceAfterAuto = False
        .CharacterUnitLeftIndent = 0
End With

For Each j In file.Paragraphs 'cycling in the pragraphs of the active document
For m = 1 To j.Range.Characters.Count
If j.Range.Characters(1).Text = " " Or j.Range.Characters(1).Text = " " Or j.Range.Characters(1).Text = Chr(9) Then
j.Range.Characters(1).Delete
Else: Exit For
End If
Next m
Next


'Buoc 8: Lay vung can copy noi dung de thi
Sheets("Sheet1").Select
Dim n As Long
n = file.Paragraphs.Count
Sheets("Rand_Sentense").Range("B2") = n
With file
.Paragraphs(1).Range.Select
WordDoc.Selection.MoveEnd wdParagraph, n - 1
WordDoc.Selection.Copy
End With
Range("A1").Select
ActiveSheet.PasteSpecial Format:="Unicode Text"
ActiveSheet.Range("A1").Copy
Application.CutCopyMode = False

Sheets("Sheet1").Activate
Sheets("Sheet1").Range("AD1:AM1000").ClearContents

Dim i As Integer
Dim x As Integer

'Buoc 9: Dat cau va dap an

Sheets("Rand_Sentense").Range("C5:C400").ClearContents

For i = 1 To n
    If Cells(i, 28) = "PHAN" Then
        p = p + 1
        Cells(i, 30) = "PHAN_" & p
        Cells(i, 36).Font.Bold = True
        Cells(i, 36) = Left(Cells(i, 1), 2)
        Sheets("Information").Cells(4, 4) = p
    End If
        
    If Left(Cells(i, 28), 3) = "CAU" Then
        x = x + 1
        Cells(i, 32) = "CAU_" & x
        Sheets("Rand_Sentense").Cells(x + 4, 3) = x
    End If
    
    If Right(Cells(i, 28), 2) = "DA" Then
    Cells(i, 34) = "DA_" & x
    End If
    
    If Right(Cells(i, 36), 2) <> "" Then
    Cells(i, 37) = x + 1
    End If
    
    Cells(1, 39) = Cells(1, 36)
    If Cells(i, 36) <> "" Then
    Phan = Cells(i, 36)
    End If
    If Cells(i, 32) <> "" Then Cells(i, 39) = Phan
    
Next i

For i = n To 1 Step -1
'Buoc 10: Lay phan
If Cells(i + 1, 30) <> "" Then B = 0
If Cells(i, 29) = "PHAN" Then B = B + 1
If Cells(i, 30) <> "" Then Cells(i, 31) = B

'Buoc 11:Lay cau
If Cells(i + 1, 32) <> "" Then C = 0
If Left(Cells(i, 29), 3) = "CAU" Then C = C + 1
If Cells(i, 32) <> "" Then Cells(i, 33) = C

'Buoc 12: Lay dap an that
If Cells(i + 1, 34) <> "" Then D = 0
If Cells(i, 29) = "DA" Then D = D + 1
If Cells(i, 34) <> "" Then Cells(i, 35) = D
'Buoc 13: Lay so dong dap an
If Cells(i + 1, 28) <> "" Then d1 = 0
If Cells(i, 28) = "" Then d1 = d1 + 1
If Right(Cells(i, 28), 2) = "DA" Then Cells(i, 40) = d1 + 1
Next i

Sheets("Rand_Sentense").Cells(3, 2) = x
Sheets("Information").Range("D10") = x

'Buoc 14:Tim can tren va duoi
For i = n To 1 Step -1
If Cells(i + 1, 36) <> "" Then B = 0
If Left(Cells(i, 32), 3) = "CAU" And Cells(i, 36) = "" Then B = B + 1
If Cells(i, 36) <> "" Then Cells(i, 38) = B + Cells(i, 37) - 1
Next i


    Sheets("Dap_an").Activate
    Range("B3").Formula = "=COLUMN()-1"
    Range(Cells(3, 3), Cells(7, 51)).Clear
    Range(Cells(8, 1), Cells(500, 200)).Clear
    Range(Cells(3, 2), Cells(7, x + 1)).FillRight
    Range(Cells(3, 2), Cells(3, x + 1)).Value = Range(Cells(3, 2), Cells(3, x + 1)).Value
    Range(Cells(4, 2), Cells(7, x + 1)).Interior.ColorIndex = xlNone

WordDoc.Visible = True
Set file1 = WordDoc.Documents.Open(ThisWorkbook.Path & "\DE GOC.dot")
WordDoc.Visible = True

'Buoc 16:Copy tu de goc sang------------------------------

'PHAN I - LIET KE DAP AN
Sheets("Sheet1").Activate
Dim Macau As String
Dim Maphan As String
Dim Cau As Integer
For Phan = 1 To Sheets("Information").Cells(4, 4)
    Maphan = "PHAN_" & Phan
    dong = Application.Match(Maphan, Range(Cells(1, 30), Cells(n, 30)), 0)
    sodong = Cells(dong, 31).Value
    cau_dau = Cells(dong, 37).Value
    cau_cuoi = Cells(dong, 38).Value
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
With WordDoc.Selection
        .Copy
End With
End With

    file1.Activate
With WordDoc.Selection
        .Paste
End With

'Phan 1: Copy cau hoi
For Cau = cau_dau To cau_cuoi
    On Error Resume Next
    If Cau > Sheets("Information").Range("D10") Then Exit For
    Macau = "CAU_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 32), Cells(n, 32)), 0)
    sodong = Cells(dong, 33).Value
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
End With
    file1.Activate
With WordDoc.Selection
        .Paste
End With
'Phan 2: Copy dap an
If Cells(dong, 39) = "#1" Then
Else

    Macau = "DA_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 34), Cells(n, 34)), 0)
    dongDA = Cells(dong, 35).Value
    dongDAt = Cells(dong, 35).Value
    
    If dongDAt <> 0 Then
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + dongDA - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
End With

    file1.Activate
With WordDoc.Selection
        .Paste
        .MoveUp wdParagraph, dongDAt, wdExtend
        .Paragraphs.TabStops.ClearAll
        .MoveEnd wdCharacter, -1
        .MoveRight
        .TypeText Text:="#"
        .MoveUp wdParagraph, dongDA, wdExtend
End With

Else

    file1.Activate
With WordDoc.Selection
        .MoveUp wdParagraph, sodong, wdExtend
        .Paragraphs.TabStops.ClearAll
        .MoveEnd wdCharacter, -1
        .MoveRight
        .TypeText Text:="#"
        .MoveUp wdParagraph, sodong, wdExtend
End With
    End If
    
With WordDoc.Selection
            .Find.Text = Chr(9)
            .Find.Replacement.Text = " "
            .Find.Execute Replace:=wdReplaceAll
End With

file1.Activate
With WordDoc.Selection
Set rngParagraphs1 = .Range
End With

'Dap an A-B
StartWord = "A."
EndWord = "B."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
If .Find.Found = False Then
'Tim kieu khac, khong tim thay dap an A
Else

With WordDoc.Selection
.MoveEnd , -2
.MoveRight
m = .Information(wdHorizontalPositionRelativeToTextBoundary)
If m <> 0 Then
.TypeParagraph
End If
End With

End If
End With

'Dap an B-C
StartWord = "B."
EndWord = "C."
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
If .Find.Found = False Then
'Tim kieu khac
Else

With WordDoc.Selection
.MoveEnd , -2
.MoveRight
m = .Information(wdHorizontalPositionRelativeToTextBoundary)
If m <> 0 Then
.TypeParagraph
End If
End With

End If
End With

'Dap an C-D
StartWord = "C."
EndWord = "D."
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select

If .Find.Found = False Then
'Tim kieu khac
Else

With WordDoc.Selection
.MoveEnd , -2
.MoveRight
m = .Information(wdHorizontalPositionRelativeToTextBoundary)
If m <> 0 Then
.TypeParagraph
End If
End With

End If
End With
rngParagraphs1.Select

WordDoc.Selection.MoveRight
WordDoc.Selection.TypeParagraph

End If
Next Cau
Next Phan

'Dong fil1
file.Close SaveChanges:=wbDoNotSaveChanges

file1.Activate

'Remove all Space and Indent at first of Paragraph
With file1
WordDoc.Selection.WholeStory
    With WordDoc.Selection.ParagraphFormat
        .LeftIndent = 0
        .RightIndent = 0
        .CharacterUnitLeftIndent = 0
        .CharacterUnitRightIndent = 0
        .CharacterUnitFirstLineIndent = 0
        .FirstLineIndent = 0
    End With
    
'DANG LAM
For Each i1 In file1.Paragraphs
For n1 = 1 To i1.Range.Characters.Count
If i1.Range.Characters(1).Text = " " Or i1.Range.Characters(1).Text = " " Or i1.Range.Characters(1).Text = Chr(9) Then
i1.Range.Characters(1).Delete
Else: Exit For
End If
Next n1

For n1 = 1 To i1.Range.Characters.Count
u = i1.Range.Characters.Count
If u = 1 Then
'WordDoc.Selection.TypeBackspace
Exit For
End If
If i1.Range.Characters(u - 1).Text = " " Or i1.Range.Characters(u - 1).Text = " " Or i1.Range.Characters(u - 1).Text = Chr(9) Or i1.Range.Characters(u - 1).Text = Chr(160) Or i1.Range.Characters(u - 1).Text = "." Then
i1.Range.Characters(u - 1).Select
WordDoc.Selection.TypeBackspace
Else: Exit For
End If
Next n1
Next

End With


'Remove empty paragraphs:
WordDoc.Selection.WholeStory
With WordDoc.Selection.Find
.Text = "^p^p"
.Replacement.Text = "^p"
.Forward = True
.Wrap = wdFindContinue
End With
WordDoc.Selection.Find.Execute Replace:=wdReplaceAll

'Remove all Space at End of Doc
If Len(file1.Range) = 1 Then Exit Sub
With file1
z = .Range.End
Set r = .Range(z - 2, z - 1)
While r.Text = " " Or r.Text = Chr$(13)
r.Delete
z = .Range.End
Set r = .Range(z - 2, z - 1)
Wend
End With

'Lay vung can copy noi dung de thi-------------------
Sheets("Sheet1").Select
Sheets("Sheet1").Range("A1:Q1000").ClearContents
n = file1.Paragraphs.Count
Sheets("Rand_Sentense").Range("B2") = n
With file1
.Paragraphs(1).Range.Select
WordDoc.Selection.MoveEnd wdParagraph, n - 1
WordDoc.Selection.Copy
End With
Range("A1").Select
ActiveSheet.PasteSpecial Format:="Unicode Text"
ActiveSheet.Range("A1").Copy
Application.CutCopyMode = False
'Ket thuc Lay vung can copy noi dung de thi----------

Sheets("Sheet1").Activate
Sheets("Sheet1").Range("AD1:AM1000").ClearContents

'Dat cau va dap an-----------------------------------
p = 0
x = 0
B = 0
C = 0
D = 0
d1 = 0
Sheets("Rand_Sentense").Range("C5:C400").ClearContents
For i = 1 To n
    If Cells(i, 28) = "PHAN" Then
        p = p + 1
        Cells(i, 30) = "PHAN_" & p
        Cells(i, 36).Font.Bold = True
        Cells(i, 36) = Left(Cells(i, 1), 2)
        Sheets("Information").Cells(4, 4) = p
    End If
        
    If Left(Cells(i, 28), 3) = "CAU" Then
        x = x + 1
        Cells(i, 32) = "CAU_" & x
        Sheets("Rand_Sentense").Cells(x + 4, 3) = x
    End If
    
    If Right(Cells(i, 28), 2) = "DA" Then
    Cells(i, 34) = "DA_" & x
    End If
    
    If Right(Cells(i, 36), 2) <> "" Then
    Cells(i, 37) = x + 1
    End If
    
    Cells(1, 39) = Cells(1, 36)
    If Cells(i, 36) <> "" Then
    Phan = Cells(i, 36)
    End If
    If Cells(i, 32) <> "" Then Cells(i, 39) = Phan
    
Next i

For i = n To 1 Step -1
'lay phan
If Cells(i + 1, 30) <> "" Then B = 0
If Cells(i, 29) = "PHAN" Then B = B + 1
If Cells(i, 30) <> "" Then Cells(i, 31) = B

'lay cau
If Cells(i + 1, 32) <> "" Then C = 0
If Left(Cells(i, 29), 3) = "CAU" Then C = C + 1
If Cells(i, 32) <> "" Then Cells(i, 33) = C
'lay dap an that
If Cells(i + 1, 34) <> "" Then D = 0
If Cells(i, 29) = "DA" Then D = D + 1
If Cells(i, 34) <> "" Then Cells(i, 35) = D
'lay so dong dap an
If Cells(i + 1, 28) <> "" Then d1 = 0
If Cells(i, 28) = "" Then d1 = d1 + 1
If Right(Cells(i, 28), 2) = "DA" Then Cells(i, 40) = d1 + 1
Next i

Sheets("Rand_Sentense").Cells(3, 2) = x
Sheets("Information").Range("D10") = x

'Tim can tren va duoi
For i = n To 1 Step -1
If Cells(i + 1, 36) <> "" Then B = 0
If Left(Cells(i, 32), 3) = "CAU" And Cells(i, 36) = "" Then B = B + 1
If Cells(i, 36) <> "" Then Cells(i, 38) = B + Cells(i, 37) - 1
Next i

'Copy so luong cau hoi----------------------------
    Sheets("Dap_an").Activate
    Range("B3").Formula = "=COLUMN()-1"
    Range(Cells(3, 3), Cells(7, 51)).Clear
    Range(Cells(8, 1), Cells(500, 200)).Clear
    Range(Cells(3, 2), Cells(7, x + 1)).FillRight
    Range(Cells(3, 2), Cells(3, x + 1)).Value = Range(Cells(3, 2), Cells(3, x + 1)).Value
    Range(Cells(4, 2), Cells(7, x + 1)).Interior.ColorIndex = xlNone

'Dong file
file.Close SaveChanges:=wbDoNotSaveChanges
'Save file da liet ke dap an
'-----
'PHAN II _ LAY CHIEU DAI DAP AN
Sheets("Sheet1").Range("AQ1:AT1000").ClearContents
file1.Activate
Sheets("Sheet1").Activate
For Phan = 1 To Sheets("Information").Cells(4, 4)
    Maphan = "PHAN_" & Phan
    dong = Application.Match(Maphan, Range(Cells(1, 30), Cells(n, 30)), 0)
    sodong = Cells(dong, 31).Value
    cau_dau = Cells(dong, 37).Value
    cau_cuoi = Cells(dong, 38).Value

'Phan 1: Copy cau hoi
For Cau = cau_dau To cau_cuoi
    On Error Resume Next
    If Cau > Sheets("Information").Range("D10") Then Exit For
    Macau = "CAU_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 32), Cells(n, 32)), 0)
    sodong = Cells(dong, 33).Value

'Phan 2: Copy dap an
If Cells(dong, 39) = "#1" Then
Else

    Macau = "DA_" & Sheets("Rand_Sentense").Cells(Cau + 4, 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 34), Cells(n, 34)), 0)
    dongDA = Cells(dong, 35).Value
    dongDAt = Cells(dong, 35).Value
    
    If dongDAt <> 0 Then
With file1
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + dongDA - 1).Range.End)
            rngParagraphs.Select
End With
    End If

file1.Activate
With WordDoc.Selection
Set rngParagraphs1 = .Range
End With

'Dap an A-B
StartWord = "A."
EndWord = "B."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveUp wdParagraph, 1, Extend:=wdExtend
WordDoc.Selection.MoveEnd , -1

    With WordDoc.Dialogs(wdDialogToolsWordCount)
        .Execute
        numpara = .Lines
    End With
    
vitri_dau = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
WordDoc.Selection.MoveRight
vitri_cuoi = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
len_da = vitri_cuoi - vitri_dau + (numpara - 1) * 465

Sheets("Sheet1").Cells(dong, 43) = len_da

'Dap an B-C
StartWord = "B."
EndWord = "C."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveUp wdParagraph, 1, Extend:=wdExtend
WordDoc.Selection.MoveEnd , -1

    With WordDoc.Dialogs(wdDialogToolsWordCount)
        .Execute
        numpara = .Lines
    End With
vitri_dau = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
WordDoc.Selection.MoveRight
vitri_cuoi = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
len_da = vitri_cuoi - vitri_dau + (numpara - 1) * 465

Sheets("Sheet1").Cells(dong, 44) = len_da

'Dap an C-D
StartWord = "C."
EndWord = "D."

With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
End With

WordDoc.Selection.MoveUp wdParagraph, 1, Extend:=wdExtend
WordDoc.Selection.MoveEnd , -1

    With WordDoc.Dialogs(wdDialogToolsWordCount)
        .Execute
        numpara = .Lines
    End With
vitri_dau = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
WordDoc.Selection.MoveRight
vitri_cuoi = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
len_da = vitri_cuoi - vitri_dau + (numpara - 1) * 465

Sheets("Sheet1").Cells(dong, 45) = len_da

'Dap an D-.End
StartWord = "D."
EndWord = "#"
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
    With WordDoc.Dialogs(wdDialogToolsWordCount)
        .Execute
        numpara = .Lines
    End With
    WordDoc.Selection.MoveStart wdCharacter, 2
vitri_dau = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
WordDoc.Selection.MoveRight
vitri_cuoi = WordDoc.Selection.Information(wdHorizontalPositionRelativeToPage)
len_da = (vitri_cuoi - vitri_dau) + (numpara - 1) * 465
Sheets("Sheet1").Cells(dong, 46) = len_da
End With
End If
Next Cau
Next Phan


'-----
file1.SaveAs FileName:=Sheets("Information").Range("C12") & "\" & tenfile_fix & ".doc"
Sheets("Information").Range("C9") = file1.Name
Application.ScreenUpdating = False

WordDoc.Quit
'Ket thuc tao folder luu de
Sheets("Information").Activate
    Dim thongbao3 As String
    thongbao3 = "M" & ChrW(7901) & "i b" & ChrW(7841) & "n nh" & ChrW(7853) & "p s" & ChrW(7889) & " " & ChrW(272) & ChrW(7873) & " thi c" & ChrW(7847) & "n ho|fffd|n v" & ChrW(7883)
    Application.Assistant.DoAlert "TH|fffd|NG B|fffd|O", thongbao3, 0, 4, 0, 0, 0
Range("D3").Select
Application.ScreenUpdating = True
End Sub
'PHU LUC - HOAN VI CAU HOI - KHONG COPY SANG PHIEU
Sub Hoan_vi_cau_hoi_english()
'On Error GoTo Error_handler:
'Dem so luong cau hoi
Dim n As Integer
n = Sheets("Rand_Sentense").Range("B3")
'Hoan vi cau hoi
Sheets("Rand_Sentense").Activate
Range("A5:B400").ClearContents
Range("D5:BX400").ClearContents
Range("C5", "C" & n + 4).Formula = "=ROW()-4"
Range("C5", "C" & n + 4).Value = Range("C5", "C" & n + 4).Value

Range("C5", "C" & n + 4).Copy Range("A5")
Range("B5", "B" & n + 4).Formula = "=RAND()"
Dim i As Integer
Dim De As Integer
De = Sheets("Information").Range("D3")

With Range("A1")
For i = 3 To De + 2
For j = 1 To Sheets("Rand_Sentense").Cells(2, 2)  'So paragraph
cantren = Sheets("Sheet1").Cells(j, 37) + 4
canduoi = Sheets("Sheet1").Cells(j, 38) + 4
If Sheets("Sheet1").Cells(j, 36) = "#1" Or Sheets("Sheet1").Cells(j, 36) = "#3" Then
Range(Cells(cantren, 1), Cells(canduoi, 2)).Select
    Selection.Sort Key1:=Range(Cells(cantren, 2), Cells(canduoi, 2)), Order1:=xlAscending, Header:=xlGuess, _
        OrderCustom:=1, MatchCase:=False, Orientation:=xlTopToBottom, _
        DataOption1:=xlSortNormal
End If
Range(Cells(cantren, 1), Cells(canduoi, 1)).Copy .Offset(cantren - 1, i)
Next j
Next i
End With

Sheets("Sheet2").Range("B1:AX100").ClearContents
Sheets("Rand_Sentense").Range("C5", "C" & n + 4).Copy
Sheets("Sheet2").Activate
Range("B1").Select
Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks:=False, Transpose:=True

End Sub

'PHAN 1 - CHI HOAN VI CAU HOI
Sub Tra_ve_cau_hoi_goc()
Sheets("Rand_Answer").Activate
'On Error GoTo Error_handler:
Dim i As Long
Dim n As Long
Dim m As Long
Dim k As Integer
n = Sheets("Rand_Sentense").Cells(3, 2)
For i = 9 To 6 * n + 8 Step 6
Dim De As Integer
De = Sheets("Rand_Answer").Range("E8")
k = Int(i / 6)
Range("E" & i) = Sheets("Rand_Sentense").Cells(k + 4, 3)
Next i
End Sub
'PHAN 2 - HOAN VI CHI  DAP AN
Sub Hoan_vi_dap_an1()
Sheets("Rand_Answer").Activate
'On Error GoTo Error_handler:
Dim i As Long
Dim n As Long
Dim m As Long
Dim k As Integer
n = Sheets("Rand_Sentense").Cells(3, 2)
For i = 9 To 6 * n + 8 Step 6
Dim De As Integer
De = Sheets("Rand_Answer").Range("E8")
k = Int(i / 6)
Range("E" & i) = Sheets("Rand_Sentense").Cells(k + 4, 3)
vitri = Application.WorksheetFunction.Match("CAU_" & k, Sheets("Sheet1").Range("AF1:AF1000"), 0)
If Sheets("Sheet1").Range("AM" & vitri) <> "#1" Then
Range("B" & i, "D" & i + 4).Select
Selection.Sort Key1:=Range("D" & i), Order1:=xlAscending, Header:=xlYes, _
        OrderCustom:=1, MatchCase:=False, Orientation:=xlTopToBottom, _
        DataOption1:=xlSortNormal
Else

End If
Next i

'Lay dap an da hoan vi---------------------
    Sheets("Dap_an").Activate
    Dim Dethi As Integer
    Dethi = Sheets("Rand_Answer").Range("E8")
    Range(Cells(2, 1), Cells(7, n + 1)).Copy
    'Tao de thi that - da xao tron
    Cells(7 * Dethi + 2, 1).Select
    ActiveSheet.Paste
    'Tao de thi theo A,B,C
    Cells(7 * Dethi + 2, 53).Select
    ActiveSheet.Paste
    Cells(7 * Dethi + 2, 1) = Sheets("Rand_Answer").Cells(8, 1) & " " & Dethi  'Lay ten de thi
    Cells(7 * Dethi + 2, 53) = Sheets("Rand_Answer").Cells(8, 1) & " " & Dethi  'Lay ten de thi
    
    'Copy cau hoi da hoan vi
    Sheets("Rand_Sentense").Activate
    Sheets("Rand_Sentense").Range(Cells(5, 3), Cells(54, 3)).Copy
    Sheets("Dap_an").Activate
    Cells(7 * Dethi + 3, 2).Select
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=True
    For cauhoi = 1 To n
    Dim Cauhoihv As Integer
    Cauhoihv = Application.WorksheetFunction.Match(cauhoi, Sheets("Rand_Answer").Range("E9:E307"), 0)
    Sheets("Rand_Answer").Activate
    Range(Cells(Cauhoihv + 9, 3), Cells(Cauhoihv + 12, 3)).Copy
    Sheets("Dap_an").Activate
    'DAN DAP DA HOAN VI
    Cells(7 * Dethi + 4, cauhoi + 1).Select
    ActiveSheet.Paste
    'Dan dap an A,B,C
    Cells(7 * Dethi + 4, cauhoi + 53).Select
    Selection.PasteSpecial Paste:=xlPasteFormats
    Next cauhoi
'Ket thuc lay dap an hoan vi---------------
Error_handler:
End Sub


Attribute VB_Name = "M_Hoanvi_Dongian"
' PHAN 1 - CHON DE VA DANH DAP AN
Public Sub Dap_an_de_goc_don_gian()
Application.ScreenUpdating = False
Dim file As Object
'Buoc 1: Mo file de thi
    Dim FileToOpen
    Dim WordDoc As Object
    FileToOpen = Application.GetOpenFilename _
        (Title:="Vui long chon file Word", _
        FileFilter:="Word Files *.do* (*.do*),")
    If FileToOpen = False Then
    Dim thongbao1 As String
    thongbao1 = "B" & ChrW(7841) & "n ch" & ChrW(432) & "a ch" & ChrW(7885) & "n " & ChrW(272) & ChrW(7873) & " thi g" & ChrW(7889) & "c"
    Application.Assistant.DoAlert "TH|fffd|NG B|fffd|O", thongbao1, 0, 4, 0, 0, 0
        
        Exit Sub
    Else
        Set WordDoc = CreateObject("Word.Application")
        WordDoc.Visible = True
        Set file = WordDoc.Documents.Open(FileName:=FileToOpen)
        Dim duongdan As String
        Dim tenfile As String
        Dim tenfile_fix As String
        
        duongdan = file.Path
        Sheets("Information").Range("C19") = duongdan
        tenfile = file.Name
        tenfile_fix = Left(tenfile, Len(tenfile) - 4) & "_YM"

        Sheets("Information").Range("C19") = duongdan
    End If
    
'Buoc 2: Tao cac duong dan
    duongdan_fix = duongdan & "\De_thi_goc"
    Sheets("Information").Range("C12") = duongdan_fix
    duongdan_file = duongdan & "\De_thi_hoan_vi " & Format$(Date, "dd-mm-yyyy") & " " & Format$(Time, "hh-mm-ss")
    Sheets("Information").Range("C18") = duongdan_file

'Buoc 3: Tao folder luu de
    Call Tao_folder
Sheets("Sheet1").Range("A1:G1000").ClearContents
'Buoc 4: Khai bao cho VBA biet mot hang so cua Word
Const wdCharacter As Long = 1
Const wdParagraph As Long = 4
Const wdLine As Long = 5
Const wdStory As Long = 6
Const wdExtend = 1
Const wdColorRed = 255
Const wdColorBlack = 0
Const wdReplaceAll = 2
Const wdPasteEnhancedMetafile = 9
Const wdHorizontalPositionRelativeToPage = 5
Const wdHorizontalPositionRelativeToTextBoundary = 7
Const wdDialogToolsWordCount = 228
Const wdHeaderFooterPrimary = 1
Const wdAlignParagraphRight = 2
Dim StartWord As String
Dim EndWord As String

'Buoc 5: Paste table as Enhandce Metafile and convert Number to Text
With file
For Each t In file.Tables
    t.Select
With WordDoc.Selection
.Cut
.PasteSpecial DataType:=wdPasteEnhancedMetafile, Placement:=wdInLine
End With
Next
.ConvertNumbersToText
End With

'Remove line with paragraphs symbol:
WordDoc.Selection.WholeStory
With WordDoc.Selection.Find
.Text = "^l"
.Replacement.Text = "^p"
.Forward = True
.Wrap = wdFindContinue
End With
WordDoc.Selection.Find.Execute Replace:=wdReplaceAll

'Remove_all_the_first_line_indent_spaces
WordDoc.Selection.WholeStory
With WordDoc.Selection.ParagraphFormat
        .SpaceBeforeAuto = False
        .SpaceAfterAuto = False
        .CharacterUnitLeftIndent = 0
End With

For Each j In file.Paragraphs 'cycling in the pragraphs of the active document
For m = 1 To j.Range.Characters.Count
If j.Range.Characters(1).Text = " " Or j.Range.Characters(1).Text = " " Or j.Range.Characters(1).Text = Chr(9) Then
j.Range.Characters(1).Delete
Else: Exit For
End If
Next m
Next

'Buoc 8: Lay vung can copy noi dung de thi
Sheets("Sheet1").Select
Dim n As Long
n = file.Paragraphs.Count
Sheets("Rand_Sentense").Range("B2") = n
With file
.Paragraphs(1).Range.Select
WordDoc.Selection.MoveEnd wdParagraph, n - 1
WordDoc.Selection.Copy
End With
Range("A1").Select
ActiveSheet.PasteSpecial Format:="Unicode Text"
ActiveSheet.Range("A1").Copy
Application.CutCopyMode = False

Sheets("Sheet1").Activate
Sheets("Sheet1").Range("AD1:AM1000").ClearContents

Dim i As Integer
Dim x As Integer

'Buoc 9: Dat cau va dap an

Sheets("Rand_Sentense").Range("C5:C400").ClearContents

For i = 1 To n
    If Cells(i, 28) = "PHAN" Then
        p = p + 1
        Cells(i, 30) = "PHAN_" & p
        Cells(i, 36).Font.Bold = True
        Cells(i, 36) = Left(Cells(i, 1), 2)
        Sheets("Information").Cells(4, 4) = p
    End If
        
    If Left(Cells(i, 28), 3) = "CAU" Then
        x = x + 1
        Cells(i, 32) = "CAU_" & x
        Sheets("Rand_Sentense").Cells(x + 4, 3) = x
    End If
    
    If Right(Cells(i, 28), 2) = "DA" Then
    Cells(i, 34) = "DA_" & x
    End If
    
    If Right(Cells(i, 36), 2) <> "" Then
    Cells(i, 37) = x + 1
    End If
    
    Cells(1, 39) = Cells(1, 36)
    If Cells(i, 36) <> "" Then
    Phan = Cells(i, 36)
    End If
    If Cells(i, 32) <> "" Then Cells(i, 39) = Phan
    
Next i

For i = n To 1 Step -1
'Buoc 10: Lay phan
If Cells(i + 1, 30) <> "" Then B = 0
If Cells(i, 29) = "PHAN" Then B = B + 1
If Cells(i, 30) <> "" Then Cells(i, 31) = B

'Buoc 11:Lay cau
If Cells(i + 1, 32) <> "" Then C = 0
If Left(Cells(i, 29), 3) = "CAU" Then C = C + 1
If Cells(i, 32) <> "" Then Cells(i, 33) = C

'Buoc 12: Lay dap an that
If Cells(i + 1, 34) <> "" Then D = 0
If Cells(i, 29) = "DA" Then D = D + 1
If Cells(i, 34) <> "" Then Cells(i, 35) = D
'Buoc 13: Lay so dong dap an
If Cells(i + 1, 28) <> "" Then d1 = 0
If Cells(i, 28) = "" Then d1 = d1 + 1
If Right(Cells(i, 28), 2) = "DA" Then Cells(i, 40) = d1 + 1
Next i

Sheets("Rand_Sentense").Cells(3, 2) = x
Sheets("Information").Range("D10") = x

'Buoc 14:Tim can tren va duoi
For i = n To 1 Step -1
If Cells(i + 1, 36) <> "" Then B = 0
If Left(Cells(i, 32), 3) = "CAU" And Cells(i, 36) = "" Then B = B + 1
If Cells(i, 36) <> "" Then Cells(i, 38) = B + Cells(i, 37) - 1
Next i


    Sheets("Dap_an").Activate
    Range("B3").Formula = "=COLUMN()-1"
    Range(Cells(3, 3), Cells(7, 51)).Clear
    Range(Cells(8, 1), Cells(500, 200)).Clear
    Range(Cells(3, 2), Cells(7, x + 1)).FillRight
    Range(Cells(3, 2), Cells(3, x + 1)).Value = Range(Cells(3, 2), Cells(3, x + 1)).Value
    Range(Cells(4, 2), Cells(7, x + 1)).Interior.ColorIndex = xlNone
 
'-----
file.SaveAs FileName:=Sheets("Information").Range("C12") & "\" & tenfile_fix & ".doc"
Sheets("Information").Range("C9") = file.Name
Application.ScreenUpdating = False

WordDoc.Quit
'Ket thuc tao folder luu de
Sheets("Information").Activate
Application.ScreenUpdating = True
End Sub

Sub Tao_de_hoan_cau_hoi_dap_an_don_gian()
Application.ScreenUpdating = False
On Error GoTo Error_handler:
Call Tra_ve_cau_hoi_goc
Call Hoan_vi_cau_hoi_english

Dim file As Object
    Dim WordDoc As Object
        Set WordDoc = CreateObject("Word.Application")
        WordDoc.Visible = True
        Set file = WordDoc.Documents.Open(Sheets("Information").Range("C12") & "\" & Sheets("Information").Range("C9"))
'On Error Resume Next
WordDoc.Visible = True
Set file1 = WordDoc.Documents.Open(ThisWorkbook.Path & "\DE GOC.dot")
'Khai bao cho VBA biet mot hang so cua Word
Const wdCharacter As Long = 1
Const wdParagraph As Long = 4
Const wdLine As Long = 5
Const wdStory As Long = 6
Const wdExtend = 1
Const wdColorRed = 255
Const wdColorBlack = 0
Const wdReplaceAll = 2
Const wdPasteEnhancedMetafile = 9
Const wdHorizontalPositionRelativeToPage = 5
Const wdHeaderFooterPrimary = 1
Const wdAlignParagraphRight = 2
Dim StartWord As String
Dim EndWord As String


'Dat cau va dap an-----------------------------------
Sheets("Sheet1").Activate
Dim n As Long
n = file.Paragraphs.Count
Sheets("Rand_Sentense").Range("B2") = n
Dim x As Long
x = Sheets("Rand_Sentense").Cells(3, 2)

'Hoan vi dap an----------------------------------
Dim De As Integer
For De = 1 To Sheets("Information").Range("D3")
Sheets("Rand_Answer").Range("E8") = De
Sheets("Sheet2").Cells(De + 1, 1) = De
WordDoc.Visible = True
Set file1 = WordDoc.Documents.Open(ThisWorkbook.Path & "\DE GOC.dot")

Call Hoan_vi_dap_an1

'Copy tu de goc sang------------------------------
Sheets("Sheet1").Activate
Dim Macau As String
Dim Maphan As String
Dim Cau As Integer
'Phan 1: Copy cau hoi --------------------
For Phan = 1 To Sheets("Information").Cells(4, 4)
    Maphan = "PHAN_" & Phan
    dong = Application.Match(Maphan, Range(Cells(1, 30), Cells(n, 30)), 0)
    sodong = Cells(dong, 31).Value
    cau_dau = Cells(dong, 37).Value
    cau_cuoi = Cells(dong, 38).Value
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
With WordDoc.Selection
        .Copy
End With
End With

    file1.Activate
With WordDoc.Selection
        .Paste
End With

For Cau = cau_dau To cau_cuoi
If Cau > Sheets("Information").Range("D10") Then Exit For
    Macau = "CAU_" & Sheets("Rand_Sentense").Cells(Cau + 4, De + 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 32), Cells(n, 32)), 0)
    sodong = Cells(dong, 33).Value
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
    With WordDoc.Selection
        .MoveStart wdCharacter, (Len(Macau) - 4)
        .Copy
    End With
End With

    file1.Activate
With WordDoc.Selection
        .Font.Bold = True
        .Font.Color = wdColorBlack
        .TypeText Text:="" & Cau
        .Paste
        .EndKey
End With
    
'Ket thuc Copy cau hoi ------------------

If Cells(dong, 39) = "#1" Or Cells(dong, 39) = "#0" Then ' xet dieu kien co dap an chuan
    Else
    Mada = "DA_" & Sheets("Rand_Sentense").Cells(Cau + 4, De + 3).Value
    dong1 = Application.Match(Mada, Range(Cells(1, 34), Cells(n, 34)), 0)
    dongDA = Cells(dong1, 40).Value
    dongDAt = Cells(dong1, 35).Value
If dongDAt <> 0 Then
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong1).Range.Start, _
            End:=.Paragraphs(dong1 + dongDA - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
End With
    file1.Activate
With WordDoc.Selection
        .Paste
        .MoveUp wdParagraph, dongDA, wdExtend
        .Font.Bold = True
        .Font.Color = wdColorBlack
End With
Else
    file1.Activate
With WordDoc.Selection
        .MoveUp wdParagraph, sodong, wdExtend
        .Font.Bold = True
        .Font.Color = wdColorBlack
End With
End If

'Ket thuc Copy dap an ------------------
    file1.Activate
With WordDoc.Selection
Set rngParagraphs1 = .Range
End With

'Tim dap an dung
With rngParagraphs.Duplicate
.Select
    WordDoc.Selection.Find.Font.Color = wdColorRed
    With WordDoc.Selection.Find
        .Text = "<*>"
        .Replacement.Text = ""
        .Forward = True
        .Format = True
        .MatchWildcards = True
    End With
    WordDoc.Selection.Find.Execute
    If WordDoc.Selection.Find.Found = True Then
    Sheets("Dap_an").Cells(8, Cau + 1) = WordDoc.Selection.Text
    End If
End With

'Cat dap an
       Dim da As Integer
       Dim number As Integer
For da = 1 To 4
       number = Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 2)
Select Case number

                Case 1
                
' Xoa bo khoang noi dung giua 2 tu A. va B.--------------------
If da = 1 Then
StartWord = "A."
EndWord = "B."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="A."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "A"
Else
    
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With

End If
' Ket thuc xoa bo khoang noi dung giua 2 tu A. va B.-----------
                
' Xoa bo khoang noi dung giua 2 tu B. va C.--------------------
If da = 2 Then
StartWord = "B."
EndWord = "C."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="B."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "B"
Else
    
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu B. va C.-----------
                
' Xoa bo khoang noi dung giua 2 tu C. va D.--------------------
If da = 3 Then
StartWord = "C."
EndWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="C."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "C"
Else
    
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu C. va D.----------

' Xoa bo khoang noi dung giua 2 tu D. va .--------------------
If da = 4 Then
StartWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .MoveEnd wdParagraph
    .Select
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="D."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "D"
Else
    
    .MoveStart wdCharacter, 2
    .MoveEnd wdParagraph
    .Select
End If

End With
End If

' Ket thuc xoa bo khoang noi dung giua 2 tu D. va .------------

' Dap an A
StartWord = "A."
EndWord = "B."

file.Activate ' Tim noi dung Dap an A. va B. o de thi mau
With rngParagraphs.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End With

WordDoc.Selection.Copy ' Or whatever you want to do

file1.Activate
With WordDoc.Selection
        .Paste

If da = 4 Then
        '.TypeText Text:="#"
        .TypeParagraph
End If
End With

                Case 2
' Xoa bo khoang noi dung giua 2 tu A. va B.--------------------
If da = 1 Then
StartWord = "A."
EndWord = "B."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="A."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "A"
Else
    
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With

End If
' Ket thuc xoa bo khoang noi dung giua 2 tu A. va B.-----------
                
' Xoa bo khoang noi dung giua 2 tu B. va C.--------------------
If da = 2 Then
StartWord = "B."
EndWord = "C."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="B."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "B"
Else
    
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu B. va C.-----------
                
' Xoa bo khoang noi dung giua 2 tu C. va D.--------------------
If da = 3 Then
StartWord = "C."
EndWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="C."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "C"
Else
    
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu C. va D.----------

' Xoa bo khoang noi dung giua 2 tu D. va .--------------------
If da = 4 Then
StartWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .MoveEnd wdParagraph
    .Select
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="D."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "D"
Else
    
    .MoveStart wdCharacter, 2
    .MoveEnd wdParagraph
    .Select
End If

End With
End If

' Ket thuc xoa bo khoang noi dung giua 2 tu D. va .------------

' Dap an B
StartWord = "B."
EndWord = "C."
With rngParagraphs.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End With

WordDoc.Selection.Copy ' Or whatever you want to do

file1.Activate
With WordDoc.Selection
    If numpara = 2 Then
        .Paste
        '.TypeText Text:=vbTab
        Else
        .Paste
    End If

If da = 4 Then
        '.TypeText Text:="#"
        .TypeParagraph
End If
End With
                Case 3
' Xoa bo khoang noi dung giua 2 tu A. va B.--------------------
If da = 1 Then
StartWord = "A."
EndWord = "B."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="A."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "A"
Else
    
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With

End If
' Ket thuc xoa bo khoang noi dung giua 2 tu A. va B.-----------
                
' Xoa bo khoang noi dung giua 2 tu B. va C.--------------------
If da = 2 Then
StartWord = "B."
EndWord = "C."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select

    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If

    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="B."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "B"
Else
    
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If
End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu B. va C.-----------
                
' Xoa bo khoang noi dung giua 2 tu C. va D.--------------------
If da = 3 Then
StartWord = "C."
EndWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="C."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "C"
Else
    
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If
End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu C. va D.----------

' Xoa bo khoang noi dung giua 2 tu D. va .--------------------
If da = 4 Then
StartWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .MoveEnd wdParagraph
    .Select
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="D."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "D"
Else
    
    .MoveStart wdCharacter, 2
    .MoveEnd wdParagraph
    .Select
End If

End With

End If

' Ket thuc xoa bo khoang noi dung giua 2 tu D. va .------------

' Dap an C
StartWord = "C."
EndWord = "D."
With rngParagraphs.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End With
'file1.Activate
WordDoc.Selection.Copy ' Or whatever you want to do

file1.Activate
With WordDoc.Selection
        .Paste
If da = 4 Then
        '.TypeText Text:="#"
        .TypeParagraph
End If
End With
                Case 4
' Xoa bo khoang noi dung giua 2 tu A. va B.--------------------
If da = 1 Then
StartWord = "A."
EndWord = "B."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="A."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "A"
Else
    
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With

End If
' Ket thuc xoa bo khoang noi dung giua 2 tu A. va B.-----------
                
' Xoa bo khoang noi dung giua 2 tu B. va C.--------------------
If da = 2 Then
StartWord = "B."
EndWord = "C."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="B."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "B"
Else
    
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu B. va C.-----------
                
' Xoa bo khoang noi dung giua 2 tu C. va D.--------------------
If da = 3 Then
StartWord = "C."
EndWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="C."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "C"
Else
    
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu C. va D.----------

' Xoa bo khoang noi dung giua 2 tu D. va .--------------------
If da = 4 Then
StartWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .MoveEnd wdParagraph
    .Select
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="D."
    End With
Sheets("Sheet2").Cells(De + 1, Cau + 1) = "D"
Else
    
    .MoveStart wdCharacter, 2
    .MoveEnd wdParagraph
    .Select
End If

End With

End If

' Ket thuc xoa bo khoang noi dung giua 2 tu D. va .------------

' Dap an D
StartWord = "D."
EndWord = "#"
file.Activate
With rngParagraphs.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
If .Find.Found = False Then
With rngParagraphs.Duplicate
    .Find.Execute Findtext:=StartWord, MatchWildcards:=True, MatchCase:=True
    .Select
    .MoveEnd wdParagraph
    WordDoc.Selection.EndKey
    WordDoc.Selection.TypeText Text:="#"
End With

With rngParagraphs.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .MoveStart wdCharacter, 2
    .MoveEnd wdCharacter, -1
    .Select
End With
Else
    .MoveStart wdCharacter, 2
    .MoveEnd wdCharacter, -1
    .Select
End If
End With

WordDoc.Selection.Copy

file1.Activate
With WordDoc.Selection
        .Paste
If da = 4 Then
        '.TypeText Text:="#"
        .TypeParagraph
End If

End With

End Select

Next da

End If ' ket thuc dieu kien khong co dap an chuan

Next Cau

Next Phan

'Dat ma de cho dap an
With file1.Sections(1)
    .Headers(wdHeaderFooterPrimary).Range.Select
    WordDoc.Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
    .Headers(wdHeaderFooterPrimary).Range.Text = Sheets("Rand_Answer").Cells(8, 1) & " " & De
End With

Dim FileName As String
FileName = "HoanViDapAn_nhanh_" & De
With WordDoc
file1.SaveAs FileName:=Sheets("Information").Range("C18") & "\" & FileName & ".doc"
Sheets("Information").Cells(21 + De, 3) = file1.Name
Sheets("Information").Cells(21 + De, 2) = De
file1.Close
End With
Next De
'Dong word
file.Close SaveChanges:=wdDoNotSaveChanges
WordDoc.Quit
MsgBox "Finish!"

'Xuat dap an sang file Excel
duongdan_folder = Sheets("Information").Range("C18")
Application.DisplayAlerts = False
    Sheets("Sheet2").Activate
    Sheets("Sheet2").Copy
    ActiveWorkbook.SaveAs FileName:=duongdan_folder & "\" & "Dap_an.xlsx", FileFormat:=xlOpenXMLWorkbook, CreateBackup:=False
    ActiveWorkbook.Close
    
Call OpenFolderDemo_dethi_xuat
Sheets("Information").Activate
Application.ScreenUpdating = True
Error_handler: WordDoc.Quit
End Sub

Attribute VB_Name = "M_cauhoi_dapan"
Sub Tao_de_hoan_cau_hoi_dap_an()
'On Error GoTo Error_handler:
Application.ScreenUpdating = False
Call Tra_ve_cau_hoi_goc
Call Hoan_vi_cau_hoi_english

Dim file As Object
    Dim WordDoc As Object
        Set WordDoc = CreateObject("Word.Application")
        WordDoc.Visible = True
        Set file = WordDoc.Documents.Open(Sheets("Information").Range("C12") & "\" & Sheets("Information").Range("C9"))
'On Error Resume Next
WordDoc.Visible = True
Set file1 = WordDoc.Documents.Open(ThisWorkbook.Path & "\DE GOC.dot")
'Khai bao cho VBA biet mot hang so cua Word
Const wdCharacter As Long = 1
Const wdParagraph As Long = 4
Const wdLine As Long = 5
Const wdStory As Long = 6
Const wdExtend = 1
Const wdColorRed = 255
Const wdColorBlack = 0
Const wdReplaceAll = 2
Const wdPasteEnhancedMetafile = 9
Const wdHorizontalPositionRelativeToPage = 5
Const wdHeaderFooterPrimary = 1
Const wdAlignParagraphRight = 2
Dim StartWord As String
Dim EndWord As String


'Dat cau va dap an-----------------------------------
Sheets("Sheet1").Activate
Dim n As Long
n = file.Paragraphs.Count
Sheets("Rand_Sentense").Range("B2") = n
Dim x As Long
x = Sheets("Rand_Sentense").Cells(3, 2)

'Hoan vi dap an----------------------------------
Dim De As Integer
For De = 1 To Sheets("Information").Range("D3")
Sheets("Rand_Answer").Range("E8") = De
WordDoc.Visible = True
Set file1 = WordDoc.Documents.Open(ThisWorkbook.Path & "\DE GOC.dot")

Call Hoan_vi_dap_an1

'Copy tu de goc sang------------------------------
Sheets("Sheet1").Activate
Dim Macau As String
Dim Maphan As String
Dim Cau As Integer
'Phan 1: Copy cau hoi --------------------
For Phan = 1 To Sheets("Information").Cells(4, 4)
    Maphan = "PHAN_" & Phan
    dong = Application.Match(Maphan, Range(Cells(1, 30), Cells(n, 30)), 0)
    sodong = Cells(dong, 31).Value
    cau_dau = Cells(dong, 37).Value
    cau_cuoi = Cells(dong, 38).Value
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
With WordDoc.Selection
        .Copy
End With
End With

    file1.Activate
With WordDoc.Selection
        .Paste
End With

For Cau = cau_dau To cau_cuoi
If Cau > Sheets("Information").Range("D10") Then Exit For
    Macau = "CAU_" & Sheets("Rand_Sentense").Cells(Cau + 4, De + 3).Value
    dong = Application.Match(Macau, Range(Cells(1, 32), Cells(n, 32)), 0)
    sodong = Cells(dong, 33).Value
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong).Range.Start, _
            End:=.Paragraphs(dong + sodong - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
    With WordDoc.Selection
        .MoveStart wdCharacter, (Len(Macau) - 4)
        .Copy
    End With
End With

    file1.Activate
With WordDoc.Selection
        .Font.Bold = True
        .Font.Color = wdColorBlack
        .TypeText Text:="" & Cau
        .Paste
        .EndKey
End With
    
'Ket thuc Copy cau hoi ------------------

If Cells(dong, 39) = "#1" Then ' xet dieu kien co dap an chuan
    Else
    Mada = "DA_" & Sheets("Rand_Sentense").Cells(Cau + 4, De + 3).Value
    dong1 = Application.Match(Mada, Range(Cells(1, 34), Cells(n, 34)), 0)
    dongDA = Cells(dong1, 40).Value
    dongDAt = Cells(dong1, 35).Value
If dongDAt <> 0 Then
With file
            Set rngParagraphs = .Range( _
            Start:=.Paragraphs(dong1).Range.Start, _
            End:=.Paragraphs(dong1 + dongDA - 1).Range.End)
            rngParagraphs.Select
            rngParagraphs.Copy
End With
    file1.Activate
With WordDoc.Selection
        .Paste
        .MoveUp wdParagraph, dongDA, wdExtend
        .Font.Bold = True
        .Font.Color = wdColorBlack
End With
Else
    file1.Activate
With WordDoc.Selection
        .MoveUp wdParagraph, sodong, wdExtend
        .Font.Bold = True
        .Font.Color = wdColorBlack
End With
End If

'Ket thuc Copy dap an ------------------
    file1.Activate
With WordDoc.Selection
Set rngParagraphs1 = .Range
End With

'Tim dap an dung
With rngParagraphs.Duplicate
.Select
    WordDoc.Selection.Find.Font.Color = wdColorRed
    With WordDoc.Selection.Find
        .Text = "<*>"
        .Replacement.Text = ""
        .Forward = True
        .Format = True
        .MatchWildcards = True
    End With
    WordDoc.Selection.Find.Execute
    If WordDoc.Selection.Find.Found = True Then
    Sheets("Dap_an").Cells(8, Cau + 1) = WordDoc.Selection.Text
    End If
End With

'Cat dap an
       Dim da As Integer
       Dim number As Integer
For da = 1 To 4
       number = Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 2)
Select Case number

                Case 1
                
' Xoa bo khoang noi dung giua 2 tu A. va B.--------------------
If da = 1 Then
StartWord = "A."
EndWord = "B."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="A. "
    End With

Else
    
    .Select
    .MoveStart wdCharacter, 3
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With

End If
' Ket thuc xoa bo khoang noi dung giua 2 tu A. va B.-----------
                
' Xoa bo khoang noi dung giua 2 tu B. va C.--------------------
If da = 2 Then
StartWord = "B."
EndWord = "C."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="B. "
    End With
    
Else
    
    .Select
    .MoveStart wdCharacter, 3
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu B. va C.-----------
                
' Xoa bo khoang noi dung giua 2 tu C. va D.--------------------
If da = 3 Then
StartWord = "C."
EndWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="C. "
    End With

Else
    
    .Select
    .MoveStart wdCharacter, 3
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu C. va D.----------

' Xoa bo khoang noi dung giua 2 tu D. va .--------------------
If da = 4 Then
StartWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .MoveEnd wdParagraph
    .Select
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="D. "
    End With
    
Else
    
    .MoveStart wdCharacter, 3
    .MoveEnd wdParagraph
    .Select
End If

End With
End If

' Ket thuc xoa bo khoang noi dung giua 2 tu D. va .------------

' Dap an A
StartWord = "A."
EndWord = "B."

file.Activate ' Tim noi dung Dap an A. va B. o de thi mau
With rngParagraphs.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End With

WordDoc.Selection.Copy ' Or whatever you want to do

file1.Activate
With WordDoc.Selection
        .Paste

If da = 4 Then
        .TypeText Text:="#"
        .TypeParagraph
End If
End With

                Case 2
' Xoa bo khoang noi dung giua 2 tu A. va B.--------------------
If da = 1 Then
StartWord = "A."
EndWord = "B."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="A. "
    End With

Else
    
    .Select
    .MoveStart wdCharacter, 3
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With

End If
' Ket thuc xoa bo khoang noi dung giua 2 tu A. va B.-----------
                
' Xoa bo khoang noi dung giua 2 tu B. va C.--------------------
If da = 2 Then
StartWord = "B."
EndWord = "C."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="B. "
    End With
    
Else
    
    .Select
    .MoveStart wdCharacter, 3
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu B. va C.-----------
                
' Xoa bo khoang noi dung giua 2 tu C. va D.--------------------
If da = 3 Then
StartWord = "C."
EndWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="C. "
    End With

Else
    
    .Select
    .MoveStart wdCharacter, 3
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu C. va D.----------

' Xoa bo khoang noi dung giua 2 tu D. va .--------------------
If da = 4 Then
StartWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .MoveEnd wdParagraph
    .Select
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="D. "
    End With
    
Else
    
    .MoveStart wdCharacter, 3
    .MoveEnd wdParagraph
    .Select
End If

End With
End If

' Ket thuc xoa bo khoang noi dung giua 2 tu D. va .------------

' Dap an B
StartWord = "B."
EndWord = "C."
With rngParagraphs.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End With

WordDoc.Selection.Copy ' Or whatever you want to do

file1.Activate
With WordDoc.Selection
    If numpara = 2 Then
        .Paste
        '.TypeText Text:=vbTab
        Else
        .Paste
    End If

If da = 4 Then
        .TypeText Text:="#"
        .TypeParagraph
End If
End With
                Case 3
' Xoa bo khoang noi dung giua 2 tu A. va B.--------------------
If da = 1 Then
StartWord = "A."
EndWord = "B."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="A. "
    End With

Else
    
    .Select
    .MoveStart wdCharacter, 3
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With

End If
' Ket thuc xoa bo khoang noi dung giua 2 tu A. va B.-----------
                
' Xoa bo khoang noi dung giua 2 tu B. va C.--------------------
If da = 2 Then
StartWord = "B."
EndWord = "C."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select

    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If

    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="B. "
    End With
    
Else
    
    .Select
    .MoveStart wdCharacter, 3
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If
End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu B. va C.-----------
                
' Xoa bo khoang noi dung giua 2 tu C. va D.--------------------
If da = 3 Then
StartWord = "C."
EndWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="C. "
    End With

Else
    
    .Select
    .MoveStart wdCharacter, 3
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If
End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu C. va D.----------

' Xoa bo khoang noi dung giua 2 tu D. va .--------------------
If da = 4 Then
StartWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .MoveEnd wdParagraph
    .Select
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="D. "
    End With
    
Else
    
    .MoveStart wdCharacter, 3
    .MoveEnd wdParagraph
    .Select
End If

End With

End If

' Ket thuc xoa bo khoang noi dung giua 2 tu D. va .------------

' Dap an C
StartWord = "C."
EndWord = "D."
With rngParagraphs.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .Select
    .MoveStart wdCharacter, 2
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End With
'file1.Activate
WordDoc.Selection.Copy ' Or whatever you want to do

file1.Activate
With WordDoc.Selection
        .Paste
If da = 4 Then
        .TypeText Text:="#"
        .TypeParagraph
End If
End With
                Case 4
' Xoa bo khoang noi dung giua 2 tu A. va B.--------------------
If da = 1 Then
StartWord = "A."
EndWord = "B."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="A. "
    End With

Else
    
    .Select
    .MoveStart wdCharacter, 3
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With

End If
' Ket thuc xoa bo khoang noi dung giua 2 tu A. va B.-----------
                
' Xoa bo khoang noi dung giua 2 tu B. va C.--------------------
If da = 2 Then
StartWord = "B."
EndWord = "C."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .Select
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="B. "
    End With
    
Else
    
    .Select
    .MoveStart wdCharacter, 3
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu B. va C.-----------
                
' Xoa bo khoang noi dung giua 2 tu C. va D.--------------------
If da = 3 Then
StartWord = "C."
EndWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True

If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
    
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="C. "
    End With

Else
    
    .Select
    .MoveStart wdCharacter, 3
    .Select
    numpara = WordDoc.Selection.Paragraphs.Count
    If numpara = 2 Then
    WordDoc.Selection.MoveUp wdParagraph, 1, wdExtend
    WordDoc.Selection.MoveEnd wdCharacter, -1
    Else
    .MoveEnd wdCharacter, -2
    .Select
    End If
End If

End With
End If
' Ket thuc xoa bo khoang noi dung giua 2 tu C. va D.----------

' Xoa bo khoang noi dung giua 2 tu D. va .--------------------
If da = 4 Then
StartWord = "D."
file1.Activate
With rngParagraphs1.Duplicate
    .Find.Execute Findtext:=StartWord, MatchWildcards:=True, MatchCase:=True
    
If Sheets("Rand_Answer").Cells(6 * Cau + (3 + da), 3) = Sheets("Dap_an").Cells(8, Cau + 1) Then
    .MoveEnd wdParagraph
    .Select
    With WordDoc.Selection
    .Font.Color = wdColorRed
    .Font.Bold = True
    .TypeText Text:="D. "
    End With
    
Else
    
    .MoveStart wdCharacter, 3
    .MoveEnd wdParagraph
    .Select
End If

End With

End If

' Ket thuc xoa bo khoang noi dung giua 2 tu D. va .------------

' Dap an D
StartWord = "D."
EndWord = "#"
file.Activate
With rngParagraphs.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
If .Find.Found = False Then
With rngParagraphs.Duplicate
    .Find.Execute Findtext:=StartWord, MatchWildcards:=True, MatchCase:=True
    .Select
    .MoveEnd wdParagraph
    WordDoc.Selection.EndKey
    WordDoc.Selection.TypeText Text:="#"
End With

With rngParagraphs.Duplicate
    .Find.Execute Findtext:=StartWord & "*" & EndWord, MatchWildcards:=True, MatchCase:=True
    .MoveStart wdCharacter, 2
    .MoveEnd wdCharacter, -1
    .Select
End With
Else
    .MoveStart wdCharacter, 2
    .MoveEnd wdCharacter, -1
    .Select
End If
End With

WordDoc.Selection.Copy

file1.Activate
With WordDoc.Selection
        .Paste
If da = 4 Then
        .TypeText Text:="#"
        .TypeParagraph
End If

End With

End Select

Next da

End If ' ket thuc dieu kien khong co dap an chuan

Next Cau

Next Phan

'Dat ma de cho dap an
With file1.Sections(1)
    .Headers(wdHeaderFooterPrimary).Range.Select
    WordDoc.Selection.ParagraphFormat.Alignment = wdAlignParagraphRight
    .Headers(wdHeaderFooterPrimary).Range.Text = Sheets("Rand_Answer").Cells(8, 1) & " " & De
End With

Dim FileName As String
FileName = "HoanViDapAn" & De
With WordDoc
file1.SaveAs FileName:=Sheets("Information").Range("C18") & "\" & FileName & ".doc"
Sheets("Information").Cells(21 + De, 3) = file1.Name
Sheets("Information").Cells(21 + De, 2) = De
file1.Close
End With
Next De
'Dong word
file.Close SaveChanges:=wdDoNotSaveChanges
WordDoc.Quit
Sheets("Information").Activate
'Error_handler: WordDoc.Quit
Application.ScreenUpdating = True

End Sub



Attribute VB_Name = "Phu_them"
Sub Xem_hoan_vi()
Application.DisplayAlerts = False
    Sheets("Sheet2").Activate
    Sheets("Sheet2").Copy
    ActiveWorkbook.SaveAs FileName:=Sheets("Information").Range("C18") & "\" & "Dap_an.xlsx", FileFormat:=xlOpenXMLWorkbook, CreateBackup:=False
    ActiveWorkbook.Close
  
End Sub
Sub OpenFolderDemo_dethi_xuat()
Dim s As String
If MsgBox("Finish, OK to Open Folder?", vbYesNo + vbQuestion) = vbNo Then Exit Sub
Dim strPath As String
strPath = Sheets("Information").Range("C18")
Call OpenFolder(strPath)
Sheets("Information").Activate
Range("A1").Select
End Sub
Sub OpenFolderDemo_dethi_goc()
Dim s As String
If MsgBox("Finish, OK to Open Folder?", vbYesNo + vbQuestion) = vbNo Then Exit Sub
Dim strPath As String
strPath = Sheets("Information").Range("C12")
Call OpenFolder(strPath)
Sheets("Information").Activate
Range("A1").Select
End Sub
Sub OpenFolderDemo_de_thi_bat_ky()
Dim s As String
If MsgBox("Finish, OK to Open Folder?", vbYesNo + vbQuestion) = vbNo Then Exit Sub
Dim strPath As String
strPath = Sheets("Information").Range("C19")
Call OpenFolder(strPath)
Sheets("Information").Activate
Range("A1").Select
End Sub

Sub Tao_folder()
Application.ScreenUpdating = False
On Error Resume Next
MkDir Sheets("Information").Range("C12")
MkDir Sheets("Information").Range("C18")
Application.ScreenUpdating = True
End Sub
Private Sub OpenFolder(strDirectory As String)
Dim pID As Variant
Dim sh As Variant
On Error GoTo 102:
Set sh = CreateObject("shell.application")
For Each w In sh.Windows
    If w.Name = "Windows Explorer" Or w.Name = "File Explorer" Then
        If w.document.Folder.self.Path = strDirectory Then
            w.Visible = False
            w.Visible = True
            Exit Sub
        End If
    End If
Next
pID = Shell("explorer.exe " & strDirectory, vbNormalFocus)
102:
End Sub

Attribute VB_Name = "RibCommand"
'BUOC 1: CHON DE THI
Sub Dap_an_de_gocrb(control As IRibbonControl)
Application.ScreenUpdating = False
On Error GoTo Error_handler:
Call Dap_an_de_goc
Error_handler: Sheets("Information").Activate
Application.ScreenUpdating = True
Sheets("Information").Range("D3").Activate
End Sub

'BUOC 2: TAO DE HOAN VI CA CAU HOI VAP DAP AN
Sub Tao_de_hoan_cau_hoi_dap_anrb(control As IRibbonControl)
Application.ScreenUpdating = False
On Error GoTo Error_handler:
Call Tao_de_hoan_cau_hoi_dap_an
Call Dinh_dang_de_thi_da_xuat
Error_handler: Sheets("Information").Activate
Application.ScreenUpdating = True
End Sub

'BUOC 3: Xem hoan vi
Sub Xem_hoan_virb(control As IRibbonControl)
On Error GoTo Error_handler:
Call Xem_hoan_vi
Error_handler: Sheets("Information").Activate
End Sub

'BUOC 4: MO THU MUC
Sub OpenFolderDemorb(control As IRibbonControl)
Application.ScreenUpdating = False
On Error GoTo Error_handler:
Call OpenFolderDemo_dethi_xuat
Error_handler: Sheets("Information").Activate
Application.ScreenUpdating = True
End Sub

'BUOC 5: Trang Web
Sub Link_Webrb(control As IRibbonControl)
On Error GoTo Error_handler:
ActiveWorkbook.FollowHyperlink Address:="http://www.chamthi.com", _
    NewWindow:=True
Error_handler: Sheets("Information").Activate
End Sub


'BUOC 0: TAO DE HOAN VI NHANH
Sub Tao_de_hoan_vi_nhanhrb(control As IRibbonControl)
Application.ScreenUpdating = False
On Error GoTo Error_handler:
Call Dap_an_de_goc_don_gian
Call Tao_de_hoan_cau_hoi_dap_an_don_gian
Error_handler: Sheets("Information").Activate
Application.ScreenUpdating = True
End Sub

Sub Huong_danrb(control As IRibbonControl)
MsgBox ("Ban dang mo file HELP - Hay bam OK khi Window yeu cau")
ThisWorkbook.FollowHyperlink ThisWorkbook.Path & "\HDSD YMIX - ENG.pdf"
End Sub
Attribute VB_Name = "Sheet8"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "ThisWorkbook"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Option Explicit
Private Sub Workbook_BeforeClose(Cancel As Boolean)
'ActiveWindow.DisplayWorkbookTabs = True
End Sub

Private Sub Workbook_Open()
Application.Workbooks.Open (ThisWorkbook.Path & "\" & "Youngmix_Eng.xls")
'ActiveWindow.DisplayWorkbookTabs = False
End Sub

' InQuest injected base64 decoded content
' jZ N
' j+t*.

INQUEST-PP=macro
