Attribute VB_Name = "DBlist"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True












Attribute VB_Name = "Epp"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "Cmd_UlozXML, 1, 0, MSForms, CommandButton"
Attribute VB_Control = "Help, 2, 1, MSForms, CommandButton"
Attribute VB_Control = "ZoomIn, 3, 2, MSForms, CommandButton"
Attribute VB_Control = "CheckBox_DB, 8, 3, MSForms, CheckBox"
Attribute VB_Control = "ZoomOut, 5, 4, MSForms, CommandButton"
Attribute VB_Control = "VseZDB, 12, 5, MSForms, CommandButton"
Attribute VB_Control = "VseDoDB, 10, 6, MSForms, CommandButton"
Attribute VB_Control = "cmdTisk, 13, 7, MSForms, CommandButton"
Attribute VB_Control = "Label1, 21, 8, MSForms, Label"
Attribute VB_Control = "cmdSmazEPP, 17, 10, MSForms, CommandButton"
Attribute VB_Control = "btnSmazatDB, 19, 11, MSForms, CommandButton"
Attribute VB_Control = "lblProgress, 24, 12, MSForms, Label"
Attribute VB_Control = "btnKontrolaEPP, 23, 13, MSForms, CommandButton"
 
Public seznam, Posun, MaxSeznam As Integer
Public Cislo As Double
Public runControlCell As Boolean

Private Sub btnKontrolaEPP_Click()
    KontrolaEpp
End Sub

Public Sub KontrolaEpp()
    DeleteEmtyDataFromSheetEpp (False)
    Worksheet_Change Range("E6")
End Sub

Private Sub btnSmazatDB_Click()

If MsgBox("Opravdu chcete smazat DB", vbQuestion + vbYesNo, "Pozor") = vbYes Then
    Dim VektorHodnot As Range
    start_list = 2
    seznam_list = 3000
    
    Set VektorHodnot = DBlist.Range("H2:H20000")
    pocet_radku = Application.WorksheetFunction.Max(VektorHodnot)

    'kontrola na prazdne radky
    If pocet_radku <= 0 Then Exit Sub

    For i = start_list To (start_list + pocet_radku - 1)
        DBlist.Range("A" & i).Value = ""
        DBlist.Range("B" & i).Value = ""
        DBlist.Range("C" & i).Value = ""
        DBlist.Range("D" & i).Value = ""
        DBlist.Range("E" & i).Value = ""
        DBlist.Range("F" & i).Value = ""
        DBlist.Range("G" & i).Value = ""
        DBlist.Range("H" & i).Value = ""
    Next i
    
    MsgBox "DB byla smaz|fffd|na"
End If

End Sub

Private Sub Cmd_UlozXML_Click()
seznam = 3000
Posun = 10
MaxSeznam = seznam + Posun

DeleteEmtyDataFromSheetEpp (False)
Worksheet_Change Range("E6")

If Range("C2").Value = Range("C1") Then ' vyplnena vsechna rc
    If Range("C2").Value = Range("M1").Value Then  'kazde rc ma nejaky etanol
        GenerateXML Range(EppConstants.ColumnEppRadekCislo & "10:" & EppConstants.ColumnEppEtanolHL & Format(Range("C2").Value) + Posun), "epp", CStr(Range("F6").Value), CStr(Range("M5").Value), CStr(Range("F5").Value), "EPP.xml"
    Else
        MsgBox "Dopl|fffd|te chyb|fffd|j|fffd|c|fffd| hodnoty ve sloupci etanol[hl]", , "Nebude ulo|fffd|eno"
    End If
Else
    MsgBox "V n|fffd|jak|fffd|m |fffd||fffd|dku chyb|fffd| R|fffd| - dopl|fffd|te jej", , "Nebude ulo|fffd|eno"
End If
End Sub

Private Sub cmdSmazEPP_Click()
Application.EnableEvents = False

seznam = 3000
Posun = 10
MaxSeznam = seznam + Posun

Set Polehodnot = Epp.Range(EppConstants.ColumnEppRCPestitele & 1 + Posun & ":" & EppConstants.ColumnEppEtanolL & MaxSeznam)
Polehodnot.Value = ""
Set Polehodnot = Epp.Range(EppConstants.ColumnEppRCVek & 1 + Posun & ":" & EppConstants.ColumnEppRCVek & MaxSeznam)
Polehodnot.Value = ""
Set Polehodnot = Epp.Range(EppConstants.ColumnEppPrijmeni & 1 + Posun & ":" & EppConstants.ColumnEppEtanolL & MaxSeznam)
Polehodnot.Interior.ColorIndex = 36

Application.EnableEvents = True
End Sub

Private Sub cmdTisk_Click()

On Error GoTo ErrSub

Application.EnableEvents = False
Set VektorHodnot = Epp.Range("C11:C3010")
pocet_radku = Application.WorksheetFunction.Max(VektorHodnot)

Worksheet_Change Range("E6")

Epp.PageSetup.PrintHeadings = False
Epp.PageSetup.RightMargin = 10
Epp.PageSetup.TopMargin = 30
Epp.PageSetup.LeftMargin = 10
Epp.PageSetup.BottomMargin = 10

Epp.PageSetup.PrintArea = "$C$9:$" + EppConstants.ColumnEppEtanolHL + "$" & 9 + pocet_radku + 2
Epp.PageSetup.PrintTitleColumns = "C9:" + EppConstants.ColumnEppEtanolHL + "9"
Epp.PageSetup.BlackAndWhite = True
Epp.PageSetup.Orientation = xlLandscape

SetPrintSetting

Epp.PrintPreview

Application.EnableEvents = True
Exit Sub

ErrSub:

MsgBox "Chyba p|fffd|i tisku " & Constants.vbNewLine & Err.Number & " - " & Err.Description & Constants.vbNewLine & "Tisk|fffd|rna: " & Application.ActivePrinter, vbOKOnly, "V|fffd|jimka"
Application.EnableEvents = True
Exit Sub

End Sub

Private Sub Help_Click()
Sheets("N|fffd|pov|fffd|da").Select
End Sub

Private Sub VseDoDB_Click()
On Error GoTo ErrSub

Dim DB_pestitelu, VektorHodnot As Range

Dim i, ii, radek, novy_radek, seznam_list, seznam, start_list, start, last_ID, pocet_radku As Integer
Dim radek_txt, vyraz, rozsah, zprava, strRC, strJmeno, strPrijm, strObec, strUlice, strCislo, strPSC, hledane_RC As String
Dim nasel As Boolean

Application.EnableEvents = False

DeleteEmtyDataFromSheetEpp (False)
Worksheet_Change Range("E6")

i = 0
ii = 0
nasel = False
start = 2
seznam = 20000
start_list = 11
seznam_list = 3000
rozsah = "A" & start & ":H" & seznam
vyraz_RC = "=DZ|fffd|SKAT(A1:H" & seznam & ";Q2;P1:P2)" 'zapiseme vzorec
vyraz_MAX = "=MAX(H2:H" & seznam & ")" 'zapiseme vzorec

Set VektorHodnot = Epp.Range("C11:C3010")
pocet_radku = Application.WorksheetFunction.Max(VektorHodnot)

'kontrola na prazdne radky
If pocet_radku <= 0 Then Exit Sub

Application.EnableEvents = True
SetProgress (True)
Application.EnableEvents = False


Set DB_pestitelu = DBlist.Range(rozsah)
'vyplnime pole funkci nutnych pro vyhledavani RC
    DBlist.Range("O1").Value = "Funkce"    'po|fffd|adovan|fffd| funkce
    DBlist.Range("P1").Value = "Rodn|fffd| |fffd||fffd|slo"    'jmeno pole kriterii
    DBlist.Range("Q1").Value = "Vr|fffd|tit"   'jmena vracenych poli
    DBlist.Range("O2").FormulaLocal = vyraz_RC    'vysledek"
    DBlist.Range("Q2").Value = "ID" 'jmeno vraceneho pole
    
'vyplnime pole funkci nutnych pro vyhledani MAX ID
    DBlist.Range("O3").Value = vyraz_MAX    'vysledek a po|fffd|adovan|fffd| funkce
    DBlist.Range("Q3").Value = "max"    'jmeno funkce


For i = start_list To (start_list + pocet_radku - 1)
    radek_txt = "" 'vynulujeme
    'SetProgress(i)
    hledane_RC = Epp.Range(EppConstants.ColumnEppRCPestitele & i).Value

    If hledane_RC = "" Then 'prazdny radek ukonci cyklus
        Exit For
    End If
    
    If ValidateRC(hledane_RC, False) = True Then
        
        DBlist.Range("P2").Value = "=" & Chr(34) & hledane_RC & Chr(34)   'hledany vyraz"
        
        Do While radek_txt = "" 'zpozdovaci smycka - nez to Excel vyhodnoti na pomalejsich strojich
            radek_txt = DBlist.Range("O2").Text   'najdeme cislo radku z ID
            ii = ii + 1
            If ii = 5000 Then Exit Do
        Loop
    
        Select Case radek_txt
            Case "#HODNOTA!" 'neexistuje v DB
                    'nacteme z listu do promennych
                    strPrijm = FirstUcase(Trim(Epp.Range(EppConstants.ColumnEppPrijmeni & i).Value))
                    strJmeno = FirstUcase(Trim(Epp.Range(EppConstants.ColumnEppJmeno & i).Value))
                    strObec = Epp.Range(EppConstants.ColumnEppObec & i).Value
                    strUlice = Epp.Range(EppConstants.ColumnEppUlice & i).Value
                    strCislo = Epp.Range(EppConstants.ColumnEppCislo & i).Value
                    strPSC = Epp.Range(EppConstants.ColumnEppPSC & i).Value
                
                    max_ID = DBlist.Range("O3").Value  'najdeme maximalni ID
                    novy_radek = max_ID + 1
                      
                    If novy_radek <= seznam Then 'test prekroceni hranice DB
                        'nacteme do radku
                        DB_pestitelu.Cells(novy_radek, 1) = Trim(hledane_RC) 'rodne cislo
                        DB_pestitelu.Cells(novy_radek, 2) = strPrijm 'prijmeni
                        DB_pestitelu.Cells(novy_radek, 3) = strJmeno
                        DB_pestitelu.Cells(novy_radek, 4) = Trim(strObec) 'obec
                        DB_pestitelu.Cells(novy_radek, 5) = Trim(strUlice) 'ulice
                        DB_pestitelu.Cells(novy_radek, 6) = Trim(strCislo) 'cislo
                        DB_pestitelu.Cells(novy_radek, 7) = Trim(strPSC) 'PSC
                        DB_pestitelu.Cells(novy_radek, 8) = max_ID + 1 'nove ID
                      
                    Else
                        MsgBox "Datab|fffd|ze je pln|fffd|.", vbOKOnly, "V|fffd|jimka"
                    End If
                    
                    DBlist.Range("P3").Value = max_ID + 1 'zapiseme nove max ID do listu ke sdileni
                    
            Case "#NUM!" 'opakuje se v DB
                MsgBox "Duplicitn|fffd| v|fffd|skyt rodn|fffd|ho |fffd||fffd|sla v datab|fffd|zi.", vbOKOnly, "V|fffd|jimka"
                
            Case Else
                'vse je OK - najdeme ciselnou hodnotu
                radek = DBlist.Range("O2").Value  'najdeme cislo radku z ID
                
                'ted to nacteme z radku
                strPrijm = FirstUcase(Trim(Epp.Range("E" & i).Value))
                strJmeno = FirstUcase(Trim(Epp.Range("F" & i).Value))
                strObec = Epp.Range("G" & i).Value
                strUlice = Epp.Range("H" & i).Value
                strCislo = Epp.Range("I" & i).Value
                strPSC = Epp.Range("J" & i).Value
                
                'nahrajeme do DB
                DB_pestitelu.Cells(radek, 1) = Trim(hledane_RC) 'rodne cislo
                DB_pestitelu.Cells(radek, 2) = strPrijm 'prijmeni
                DB_pestitelu.Cells(radek, 3) = strJmeno
                DB_pestitelu.Cells(radek, 4) = Trim(strObec) 'obec
                DB_pestitelu.Cells(radek, 5) = Trim(strUlice) 'ulice
                DB_pestitelu.Cells(radek, 6) = Trim(strCislo) 'cislo
                DB_pestitelu.Cells(radek, 7) = Trim(strPSC) 'PSC
                
        End Select
    Else
        MsgBox "Rodn|fffd| |fffd||fffd|slo " + hledane_RC + " na |fffd||fffd|dku |fffd|. " + CStr(Epp.Range("C" & i).Value) + " nen|fffd| validn|fffd|, tento |fffd||fffd|dek nebude ulo|fffd|en", vbCritical
    End If
Next i
Application.EnableEvents = True
SetProgress (False)

Exit Sub

ErrSub:
MsgBox "Do|fffd|lo k neo|fffd|ek|fffd|van|fffd| v|fffd|jimce " & Err.Number & ", z|fffd|ejm|fffd| chybn|fffd| |fffd||fffd|dky v DB", vbOKOnly, "V|fffd|jimka"
Application.EnableEvents = True
SetProgress (False)
Resume Next

End Sub

Private Sub VseZDB_Click()
Application.EnableEvents = False
On Error GoTo ErrSub

Dim DB_pestitelu, VektorHodnot As Range

Dim i, ii, radek, novy_radek, seznam_list, seznam, start_list, start, last_ID, chyba, pocet_radku As Integer
Dim radek_txt, vyraz, rozsah, zprava, strRC, strJmeno, strPrijm, strObec, strUlice, strCislo, strPSC As String
Dim nasel As Boolean


i = 0
ii = 0
chyba = 0 'pocet zaznamu ktere nejsou v DB
nasel = False
start = 2
seznam = 20000
start_list = 11
seznam_list = 3000
rozsah = "A" & start & ":H" & seznam
vyraz_RC = "=DZ|fffd|SKAT(A1:H" & seznam & ";Q2;P1:P2)" 'zapiseme vzorec
vyraz_MAX = "=MAX(H2:H" & seznam & ")" 'zapiseme vzorec
radek_txt = "" 'vynulujeme

Set VektorHodnot = Epp.Range("C11:C3010")
pocet_radku = Application.WorksheetFunction.Max(VektorHodnot)

'kontrola na prazdne radky
If pocet_radku <= 0 Then Exit Sub

Application.EnableEvents = True
SetProgress (True)
Application.EnableEvents = False

Set DB_pestitelu = DBlist.Range(rozsah)
'vyplnime pole funkci nutnych pro vyhledavani RC
    DBlist.Range("O1").Value = "Funkce"    'po|fffd|adovan|fffd| funkce
    DBlist.Range("P1").Value = "Rodn|fffd| |fffd||fffd|slo"    'jmeno pole kriterii
    DBlist.Range("Q1").Value = "Vr|fffd|tit"   'jmena vracenych poli
    DBlist.Range("O2").FormulaLocal = vyraz_RC    'vysledek
    DBlist.Range("Q2").Value = "ID" 'jmeno vraceneho pole
    
'vyplnime pole funkci nutnych pro vyhledani MAX ID
    DBlist.Range("O3").Value = vyraz_MAX    'vysledek a po|fffd|adovan|fffd| funkce
    DBlist.Range("Q3").Value = "max"    'jmeno funkce

For i = start_list To (start_list + pocet_radku - 1)

'SetProgress (i)
radek_txt = ""



hledane_RC = Epp.Range("D" & i).Value

If hledane_RC = "" Then 'prazdny radek ukonci cyklus
 Exit For
End If

    DBlist.Range("P2").Value = "=" & Chr(34) & hledane_RC & Chr(34)   'hledany vyraz"
    
    Do While radek_txt = "" 'zpozdovaci smycka - nez to Excel vyhodnoti na pomalejsich strojich
    radek_txt = DBlist.Range("O2").Text   'najdeme cislo radku z ID
    ii = ii + 1
    If ii = 5000 Then Exit Do
    Loop

    
    Select Case radek_txt
        Case "#HODNOTA!" 'neexistuje v DB
           chyba = chyba + 1
                
        Case "#NUM!" 'opakuje se v DB
            MsgBox "Duplicitn|fffd| v|fffd|skyt rodn|fffd|ho |fffd||fffd|sla v datab|fffd|zi. Odstra|fffd|te duplicitn|fffd| z|fffd|znam.", vbOKOnly, "V|fffd|jimka"
            
        Case Else
            'vse je OK - najdeme ciselnou hodnotu
            radek = DBlist.Range("O2").Value  'najdeme cislo radku z ID
            
            'ted to nacteme z DB
            strPrijm = FirstUcase(Trim(DB_pestitelu.Cells(radek, 2)))
            strJmeno = FirstUcase(Trim(DB_pestitelu.Cells(radek, 3)))
            strObec = DB_pestitelu.Cells(radek, 4)
            strUlice = DB_pestitelu.Cells(radek, 5)
            strCislo = DB_pestitelu.Cells(radek, 6)
            strPSC = DB_pestitelu.Cells(radek, 7)
                        
            'nahrajeme do radku v EPP
            Epp.Range("E" & i).Value = strPrijm 'prijmeni
            Epp.Range("F" & i).Value = strJmeno 'jmeno
            Epp.Range("G" & i).Value = Trim(strObec) 'obec
            Epp.Range("H" & i).Value = Trim(strUlice) 'ulice
            Epp.Range("I" & i).Value = Trim(strCislo) 'cislo
            Epp.Range("J" & i).Value = Trim(strPSC) 'PSC
            
    End Select

    DBlist.Range("P2").Value = ""

Next i
Application.EnableEvents = True
SetProgress (False)

Exit Sub

ErrSub:
MsgBox "Do|fffd|lo k neo|fffd|ek|fffd|van|fffd| v|fffd|jimce " & Err.Number & ", z|fffd|ejm|fffd| chybn|fffd| |fffd||fffd|dky v DB", vbOKOnly, "V|fffd|jimka"
Application.EnableEvents = True
SetProgress (False)
Resume Next

End Sub

Private Sub Worksheet_BeforeDoubleClick(ByVal Target As Range, Cancel As Boolean)
Application.EnableEvents = False

Dim strRC, strPrijm, strObec, strUlice, strCislo, strPSC As String
Dim strJmeno

If (Target.row < 11) Then Exit Sub


strRC = Epp.Range("D" & Target.row).Value

'ted to nacteme z radku
strPrijm = Epp.Range("E" & Target.row).Value
strJmeno = Epp.Range("F" & Target.row).Value
strObec = Epp.Range("G" & Target.row).Value
strUlice = Epp.Range("H" & Target.row).Value
strCislo = Epp.Range("I" & Target.row).Text
strPSC = Epp.Range("J" & Target.row).Text

strPSC = Replace(strPSC, " ", "")

If strRC <> "" Then
    
    'naplnime ovladaci prvky
    UpravZaznam.Tag = Target.row
    
    UpravZaznam.Caption = "|fffd|prava z|fffd|znamu na|fffd|ten|fffd|m z DB"
    UpravZaznam.DataSet strRC, strJmeno, strPrijm, strObec, strUlice, strCislo, strPSC
        
    UpravZaznam.Show
    
    If UpravZaznam.CloseOK Then
        'UpravZaznam.DataGet (strJmeno)
        
        Epp.Range("D" & Target.row).Value = UpravZaznam.txtRC.Value
        Epp.Range("E" & Target.row).Value = UpravZaznam.TextBox2.Value
        Epp.Range("F" & Target.row).Value = UpravZaznam.TextBox1.Value
        Epp.Range("G" & Target.row).Value = UpravZaznam.TextBox3.Value
        Epp.Range("H" & Target.row).Value = UpravZaznam.TextBox4.Value
        Epp.Range("I" & Target.row).Value = UpravZaznam.TextBox5.Value
        Epp.Range("J" & Target.row).Value = UpravZaznam.TextBox6.Value

    End If
    
    UpravZaznam.DataClear
End If
 
Cancel = True 'zrusime normalni DblClick
Application.EnableEvents = True
End Sub

Private Sub Worksheet_Change(ByVal Target As Range)
Dim TestRC As Boolean
Dim rc As String
Dim RCcislo As Double
Dim pocetRadku As Integer
Dim KeDniRange As Range
Dim Radky As Variant
Dim checkSlectionRange As Boolean
Dim checkKeDni As Boolean

On Error GoTo ErrSub

If runControlCell Then Exit Sub

runControlCell = True

seznam = 3000
Posun = 10
MaxSeznam = seznam + Posun

checkSlectionRange = Not (Selection Is Nothing) And Selection.Rows.Count > 1
checkKeDni = Target.row = 6 And Target.Column = 5

Application.EnableEvents = True

If (Target.row > Posun) And (Target.row < MaxSeznam) And (Not checkSlectionRange) Then 'jsme ve formu
    If Target.Column = 4 Then 'zmeneno rodne cislo
        
        rc = Trim(Range(EppConstants.ColumnEppRCPestitele & Target.row).Value)
        TestRC = ValidateRC(rc, True)
        
        If TestRC Then 'vysledek testu RC
            Range(EppConstants.ColumnEppRCPestitele & Target.row).Interior.ColorIndex = 36 'platne rc
            'pokud je platn|fffd| r|fffd|, pak test v|fffd|ku
            'Zjisteni datumu narozeni z rc
            'rok
            If Len(rc) = 9 Then rok = 1900 + CInt(Mid(rc, 1, 2))
            If Len(rc) = 10 Then
                If Mid(rc, 1, 2) < 54 Then
                    rok = 2000 + CInt(Mid(rc, 1, 2))
                Else
                    rok = 1900 + CInt(Mid(rc, 1, 2))
                End If
            End If
            'mesic
            If Mid(rc, 3, 1) < 2 Then 'je to chlap
                mes = Mid(rc, 3, 2)
            Else '|fffd|ensk|fffd|
                mes = CLng(Mid(rc, 3, 2))
                mes = mes - 50
            End If
            'den
            den = Mid(rc, 5, 2)

            'zjisteni, zda je subjektu vice nez 18 let vzhledem k KeDni
            KeDni = Range("F6").Value
            narozeni18 = DateAdd("yyyy", 18, CDate(den & "." & mes & "." & CInt(rok)))
            If KeDni < narozeni18 Then
                Application.EnableEvents = False
                Range(EppConstants.ColumnEppRCVek & Target.row).Formula = "Pod 18 let!"
                Application.EnableEvents = True
                Range(EppConstants.ColumnEppRCPestitele & Target.row).Interior.ColorIndex = 46
            Else
                Application.EnableEvents = False
                Range(EppConstants.ColumnEppRCVek & Target.row).Formula = "OK"
                
                '----- nove presunuto do testu spravnosti -----------------
                rc = RCNastavLomitko(rc)
                Application.EnableEvents = False
                Range(EppConstants.ColumnEppRCPestitele & Target.row).Formula = rc
                
                'kontrola zda ho uz nemame v DB, kdyz ano doplnime radek
                '-----------------------------------------------------------
                
                Call SearchDB(rc, Target, Target.row)
                
                '-----------------------------------------------------------
               
                Application.EnableEvents = True
            End If
        Else 'vysledek testu RC - neplatne RC
            Application.EnableEvents = False
            Range(EppConstants.ColumnEppRCVek & Target.row).Formula = "Neplatn|fffd| R|fffd|!"
            Application.EnableEvents = True
            Range(EppConstants.ColumnEppRCPestitele & Target.row).Interior.ColorIndex = 3
        End If 'vysledek testu RC
    
        rc = RCNastavLomitko(rc)
        Application.EnableEvents = False
        Range(EppConstants.ColumnEppRCPestitele & Target.row).Formula = rc
        Application.EnableEvents = True
    End If 'zmeneno rodne cislo

    'smazano RC
    If Range(EppConstants.ColumnEppRCPestitele & Target.row).Value = "" Then
        ClearRow (Target.row)
    End If

    'pokud je editovan radek, ktery nema hl, jsou hl oznaceny
    If Range(EppConstants.ColumnEppEtanolL & Target.row).Value = "" And Range(EppConstants.ColumnEppRCPestitele & Target.row).Value <> "" Then
        Range(EppConstants.ColumnEppEtanolL & Target.row).Interior.ColorIndex = 3
    Else
        Range(EppConstants.ColumnEppEtanolL & Target.row).Interior.ColorIndex = 36
    End If
End If 'jsme ve formu



'zmeneno KeDni - aktualizuj kontroly na v|fffd|ech R|fffd|
If checkKeDni Or checkSlectionRange Then 'zmeneno kedni
    Dim forOd As Integer
    Dim forDo As Integer
    
    If checkKeDni Then
        pocetRadku = Range("C1").Value
        forOd = Posun + 1
        forDo = Posun + pocetRadku
    End If
    
    If checkSlectionRange Then
        forOd = Selection.row
        forDo = forOd + Selection.Rows.Count
    End If
   
    For Radky = forOd To forDo
        rc = Trim(Range(EppConstants.ColumnEppRCPestitele & Radky).Value)
        TestRC = ValidateRC(rc, True)
            
        If TestRC Then 'vysledek testu RC
            Range(EppConstants.ColumnEppRCPestitele & Radky).Interior.ColorIndex = 36 'platne rc
            'pokud je platn|fffd| r|fffd|, pak test v|fffd|ku
            'Zjisteni datumu narozeni z rc
            'rok
            If Len(rc) = 9 Then rok = 1900 + CInt(Mid(rc, 1, 2))
            If Len(rc) = 10 Then
                If Mid(rc, 1, 2) < 54 Then
                    rok = 2000 + CInt(Mid(rc, 1, 2))
                Else
                    rok = 1900 + CInt(Mid(rc, 1, 2))
                End If
            End If
            'mesic
            If Mid(rc, 3, 1) < 2 Then 'je to chlap
                mes = Mid(rc, 3, 2)
            Else '|fffd|ensk|fffd|
                mes = CLng(Mid(rc, 3, 2))
                mes = mes - 50
            End If
            'den
            den = Mid(rc, 5, 2)
    
            'zjisteni, zda je subjektu vice nez 18 let vzhledem k KeDni
            KeDni = Range("F6").Value
            narozeni18 = DateAdd("yyyy", 18, CDate(den & "." & mes & "." & CInt(rok)))
            If KeDni < narozeni18 Then
                Range(EppConstants.ColumnEppRCVek & Radky).Formula = "Pod 18 let!"
                Range(EppConstants.ColumnEppRCPestitele & Radky).Interior.ColorIndex = 46
            Else
                Range(EppConstants.ColumnEppRCVek & Radky).Formula = "OK"
            End If
        Else 'vysledek testu RC - neplatne RC
            'smazano RC
            If Range(EppConstants.ColumnEppRCPestitele & Radky).Value = "" Then
                ClearRow (Radky)
            Else
                rc = RCNastavLomitko(rc)
                Application.EnableEvents = False
                               
                Range(EppConstants.ColumnEppRCVek & Radky).Formula = "Neplatn|fffd| R|fffd|!"
                Range(EppConstants.ColumnEppRCPestitele & Radky).Interior.ColorIndex = 3
                
                Range(EppConstants.ColumnEppRCPestitele & Format(Radky)).Formula = rc
                Application.EnableEvents = True
            End If
        End If 'vysledek testu RC
            
        Range(EppConstants.ColumnEppRCPestitele & Radky & ":" & EppConstants.ColumnEppPSC & Radky).HorizontalAlignment = xlLeft
        Range(EppConstants.ColumnEppEtanolL & Radky & ":" & EppConstants.ColumnEppEtanolHL & Radky).HorizontalAlignment = xlCenter
        
        If Range(EppConstants.ColumnEppRCPestitele & Radky).Value <> "" Then
            'pokud je editovan radek, ktery nema hl, jsou hl oznaceny
            If Range(EppConstants.ColumnEppEtanolL & Radky).Value = "" And Range(EppConstants.ColumnEppRCPestitele & Radky).Value <> "" Then
                Range(EppConstants.ColumnEppEtanolL & Radky).Interior.ColorIndex = 3
            Else
                Range(EppConstants.ColumnEppEtanolL & Radky).Interior.ColorIndex = 36
            End If
        End If
            
        rc = RCNastavLomitko(rc)
        Application.EnableEvents = False
        Range(EppConstants.ColumnEppRCPestitele & Radky).Formula = rc
        Application.EnableEvents = True
        
    Next Radky
End If 'zmeneno kedni

runControlCell = False

On Error Resume Next
'horizontalni posun po odentrovani
If (Target.row > Posun) And (Target.row < MaxSeznam) Then 'jsme ve formu svisle
    If Target.Column >= 4 And Target.Column < 13 Then 'zmeneno neco v EPP mimo posledniho sloupce
        If Target.row = ActiveCell.row Then 'delete
            ' p|fffd|i delete se neposouvej
        Else
            ActiveCell.Offset(-1, 1).Activate 'se posun doprava
        End If
    End If 'zmeneno neco v EPP mimo posledniho sloupce
    If Target.Column = 13 Then 'zmeneno neco v EPP v poslednim sloupci
        If Target.row = ActiveCell.row Then 'delete
            ' p|fffd|i delete se neposouvej
        Else
            ActiveCell.Offset(0, -9).Activate 'se posun na novy radek
        End If
    End If 'zmeneno neco v EPP v poslednim sloupci
End If

On Error GoTo ErrSub
Exit Sub

ErrSub:
MsgBox "Do|fffd|lo k neo|fffd|ek|fffd|van|fffd| v|fffd|jimce, z|fffd|ejm|fffd| je v |fffd||fffd|dku chyba", vbOKOnly, "V|fffd|jimka"
runControlCell = False
End Sub

Private Sub ZoomIn_Click()
DoZoomIn
End Sub

Private Sub ZoomOut_Click()
DoZoomOut
End Sub


Private Sub SearchDB(rodne_cislo As String, Target As Range, T_row As Integer)

On Error GoTo ErrSub

Dim DB_pestitelu As Range
Dim i, ii, radek, seznam, start, last_ID As Integer
Dim radek_txt, vyraz, rozsah, zprava, strRC, strJmeno, strPrijm, strObec, strUlice, strCislo, strPSC As String
Dim nasel As Boolean

i = 0
ii = 0
nasel = False
start = 2
seznam = 20000
rozsah = "A" & start & ":G" & seznam
vyraz_RC = "=DZ|fffd|SKAT(A1:H" & seznam & ";Q2;P1:P2)" 'zapiseme vzorec
vyraz_MAX = "=MAX(H2:H" & seznam & ")" 'zapiseme vzorec
radek_txt = "" 'vynulujeme

Set DB_pestitelu = DBlist.Range(rozsah)
'vyplnime pole funkci nutnych pro vyhledavani RC
    DBlist.Range("O1").Value = "Funkce"    'po|fffd|adovan|fffd| funkce
    DBlist.Range("P1").Value = "Rodn|fffd| |fffd||fffd|slo"    'jmeno pole kriterii
    DBlist.Range("Q1").Value = "Vr|fffd|tit"   'jmena vracenych poli
    DBlist.Range("O2").FormulaLocal = vyraz_RC    'vysledek"
    DBlist.Range("P2").Value = "=" & Chr(34) & rodne_cislo & Chr(34)   'hledany vyraz"
    DBlist.Range("Q2").Value = "ID" 'jmeno vraceneho pole
    
'vyplnime pole funkci nutnych pro vyhledani MAX ID
    DBlist.Range("O3").Value = vyraz_MAX    'vysledek a po|fffd|adovan|fffd| funkce
    DBlist.Range("Q3").Value = "max"    'jmeno funkce
    
    Do While radek_txt = "" 'zpozdovaci smycka - nez to Excel vyhodnoti na pomalejsich strojich
    radek_txt = DBlist.Range("O2").Text   'najdeme cislo radku z ID
    ii = ii + 1
    If ii = 5000 Then Exit Do
    Loop

    

Select Case radek_txt
    Case "#HODNOTA!" 'neni v DB
       If Epp.CheckBox_DB.Value Then ' chci ukladat po jednom
            UpravZaznam.Caption = "P|fffd|id|fffd|n|fffd| nov|fffd|ho z|fffd|znamu"
            'schovame a zakazeme ovladaci prvky
            UpravZaznam.CommandButton3.visible = False
            UpravZaznam.CommandButton2.Enabled = True
            UpravZaznam.TextBox1.Enabled = True
            UpravZaznam.TextBox2.Enabled = True
            UpravZaznam.TextBox3.Enabled = True
            UpravZaznam.TextBox4.Enabled = True
            UpravZaznam.TextBox5.Enabled = True
            UpravZaznam.TextBox6.Enabled = True

            UpravZaznam.txtRC.Value = rodne_cislo
            UpravZaznam.Show
                'posledni pridane ID
                last_ID = DBlist.Range("P3").Value
                If last_ID > 0 Then
                    'nacteme do promennych
                    strRC = DB_pestitelu.Formula(last_ID, 1)
                    strPrijm = DB_pestitelu.Formula(last_ID, 2)
                    strJmeno = DB_pestitelu.Formula(last_ID, 3)
                    strObec = DB_pestitelu.Formula(last_ID, 4)
                    strUlice = DB_pestitelu.Formula(last_ID, 5)
                    strCislo = DB_pestitelu.Formula(last_ID, 6)
                    strPSC = DB_pestitelu.Formula(last_ID, 7)
            
                    'ted to cele napiseme do radku
                     Range("E" & Target.row).Formula = strPrijm
                     Range("F" & Target.row).Formula = strJmeno
                     Range("G" & Target.row).Formula = strObec
                     Range("H" & Target.row).Formula = strUlice
                     Range("I" & Target.row).Formula = strCislo
                     Range("J" & Target.row).Formula = strPSC
                     
                     ActiveCell.Offset(0, 6).Activate 'posun doprava
                 End If
            UpravZaznam.DataClear
        
       Else 'chci ukladat jen tlacitkem VseDoDB
       
       
       End If
       
        
    Case "#NUM!" 'opakuje se v DB
        MsgBox "Duplicitn|fffd| v|fffd|skyt rodn|fffd|ho |fffd||fffd|sla v datab|fffd|zi.", vbOKOnly, "V|fffd|jimka"
        
    Case Else
        'vse je OK - najdeme ciselnou hodnotu
        radek = DBlist.Range("O2").Value  'najdeme cislo radku z ID
        'nacteme do promennych
        strRC = DB_pestitelu.Formula(radek, 1)
        strPrijm = DB_pestitelu.Formula(radek, 2)
        strJmeno = DB_pestitelu.Formula(radek, 3)
        strObec = DB_pestitelu.Formula(radek, 4)
        strUlice = DB_pestitelu.Formula(radek, 5)
        strCislo = DB_pestitelu.Formula(radek, 6)
        strPSC = DB_pestitelu.Formula(radek, 7)

        'ted to cele napiseme do radku
         Range("E" & Target.row).Formula = strPrijm
         Range("F" & Target.row).Formula = strJmeno
         Range("G" & Target.row).Formula = strObec
         Range("H" & Target.row).Formula = strUlice
         Range("I" & Target.row).Formula = strCislo
         Range("J" & Target.row).Formula = strPSC
         
         ActiveCell.Offset(0, 6).Activate 'posun doprava
        
End Select
    

'If Not nasel Then 'zaznam neexistuje tak ho vytvorime
'    UpravZaznam.txtRC.Value = rodne_cislo
'    UpravZaznam.Show
'End If



Exit Sub

ErrSub:
MsgBox "Do|fffd|lo k neo|fffd|ek|fffd|van|fffd| v|fffd|jimce " & Err.Number & ", z|fffd|ejm|fffd| chybn|fffd| |fffd||fffd|dky v DB", vbOKOnly, "V|fffd|jimka"
Resume Next

End Sub

Sub DeleteEmtyDataFromSheetEpp(runChangeEvent As Boolean)
    Dim VektorHodnot As Range
    Dim start_list, pocet_radku, row_empty As Integer
    Dim setEnableEvents As Boolean
    
    setEnableEvents = Application.EnableEvents
    If setEnableEvents Then Application.EnableEvents = False
        
    start_list = 11
    empty_row = False
    
    Set VektorHodnot = Epp.Range("C11:C3010")
    pocet_radku = Application.WorksheetFunction.Max(VektorHodnot)
    
    For i = start_list To (start_list + pocet_radku - 1)
        hledane_RC = Epp.Range(EppConstants.ColumnEppRCPestitele & i).Value

        If hledane_RC = "" Then
            ii = i
           
            Do While hledane_RC = ""
                ii = ii + 1
                If ii > 3010 Then Exit Do
                
                hledane_RC = Epp.Range("D" & ii).Value
            Loop
            
            If ii > 3010 Then Exit For
            
            empty_row = True
            
            Epp.Range(EppConstants.ColumnEppRCPestitele & ii & ":" & EppConstants.ColumnEppRCVek & ii).Copy Destination:=Epp.Range(EppConstants.ColumnEppRCPestitele & i)

            Epp.Range(EppConstants.ColumnEppRCPestitele & ii).Value = ""
            ClearRow (ii)

            If (runChangeEvent) Then
                Worksheet_Change Epp.Range(EppConstants.ColumnEppRCPestitele & i)
                Worksheet_Change Epp.Range(EppConstants.ColumnEppRCPestitele & ii)
            End If
            
        End If
    Next i
    
    If empt_row Then Range("D11").Select
    If setEnableEvents Then Application.EnableEvents = True

End Sub

Private Sub SetProgress(visible As Boolean)

lblProgress.Caption = "Pracuji..."
lblProgress.visible = visible

End Sub
Attribute VB_Name = "Epp97"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "Help, 2, 1, MSForms, CommandButton"
Private Sub Help_Click()
If Sheets(Napoveda97.Name).visible = xlSheetVisible Then
   Sheets(Napoveda97.Name).Select
Else
   Sheets(Napoveda.Name).Select
End If
End Sub
Attribute VB_Name = "EppConstants"
Public Const ColumnDBListRodneCislo As String = "A"
Public Const ColumnDBListPrijmeni As String = "B"
Public Const ColumnDBListJmeno As String = "C"
Public Const ColumnDBListObec As String = "D"
Public Const ColumnDBListUlice As String = "E"
Public Const ColumnDBListCislo As String = "F"
Public Const ColumnDBListPSC As String = "G"
Public Const ColumnDBListID = "H"

Public Const ColumnEppRadekCislo As String = "C"
Public Const ColumnEppRCPestitele As String = "D"
Public Const ColumnEppPrijmeni As String = "E"
Public Const ColumnEppJmeno As String = "F"
Public Const ColumnEppObec As String = "G"
Public Const ColumnEppUlice As String = "H"
Public Const ColumnEppCislo As String = "I"
Public Const ColumnEppPSC As String = "J"
Public Const ColumnEppEtanolL As String = "K"
Public Const ColumnEppEtanolHL As String = "L"
Public Const ColumnEppRCVek As String = "M"


Attribute VB_Name = "Module1"
Sub DoZoomIn()
AktualniZoom = ActiveWindow.Zoom
ActiveWindow.Zoom = ActiveWindow.Zoom + 1
End Sub

Sub DoZoomOut()
AktualniZoom = ActiveWindow.Zoom
    If AktualniZoom > 40 Then
    ActiveWindow.Zoom = ActiveWindow.Zoom - 1
End If
End Sub

Sub GenerateXML(rngData As Range, rootNodeName As String, KeDniString As String, CelkemEtanol As String, DIC As String, defaultFileName As String)
    
    Set objXMLDoc = GenerateXMLDOM(rngData, rootNodeName, KeDniString, CelkemEtanol, DIC)
    
    Dim strFile As String
    strFile = Application.GetSaveAsFilename( _
        InitialFileName:=defaultFileName, _
        FileFilter:="XML files, *.xml", _
        Title:="Save as XML")
        
    ' If a file was named then save
    If strFile = "False" Then Exit Sub
    objXMLDoc.Save strFile
End Sub

Function GenerateXMLDOM(rngData As Range, rootNodeName As String, KeDniString As String, CelkemEtanol As String, DIC As String)

    Const NODE_DELIMITER As String = "/"  ' the default node delimiter
    
    Dim intColCount As Integer
    Dim intRowCount As Integer
    Dim intColCounter As Integer
    Dim intRowCounter As Integer
    
       
    Dim rngCell As Range
  
    Set objXMLDoc = CreateObject("Microsoft.XMLDOM")
    objXMLDoc.async = False
                   
    Set Heading = objXMLDoc.createProcessingInstruction("xml", "version=""1.0"" encoding=""UTF-8"" standalone=""yes""")
    objXMLDoc.appendChild (Heading)
    
    Set top_node = objXMLDoc.createNode(1, rootNodeName, "")
    objXMLDoc.appendChild (top_node)
    
'ke dni pridane
    Set objKeDni = objXMLDoc.createElement("ke_dni")
    objKeDni.Text = KeDniString
    objXMLDoc.documentElement.appendChild objKeDni
'celem etanol ppridane
    Set objCelkemEtanol = objXMLDoc.createElement("celkem_etanol_hl")
    objCelkemEtanol.Text = CelkemEtanol
    objXMLDoc.documentElement.appendChild objCelkemEtanol
'DIC
    Set objDIC = objXMLDoc.createElement("DIC")
    objDIC.Text = DIC
    objXMLDoc.documentElement.appendChild objDIC
    
    Dim Nodes() As String       'Array storing the current splited node names
    Dim NodeStack() As String   'Array storing the last node names
    
    Dim new_nodes()
    ReDim NodeStack(0)
    ReDim new_nodes(0)
            
     With rngData  ' The selected region on the Excel Sheet passed in
        
        '   Discover dimensions of the data we  will be dealing with...
        intColCount = .Columns.Count
        intRowCount = .Rows.Count
        
        Dim strColNames() As String     ' The Array of column names
        ReDim strColNames(intColCount)
        
        
        ' First Row is the Field/Tag names
        ' Extract all the field names into array "strColNames"
        If intRowCount >= 1 Then
            '   Loop accross columns... and put names in array
            For intColCounter = 1 To intColCount

                '   Mark the cell under current scrutiny by setting
                '   an object variable...
                Set rngCell = .Cells(1, intColCounter)
                
                '  not support merged cells .. so quit
                If Not rngCell.MergeArea.Address = _
                                            rngCell.Address Then
                      MsgBox ("!! Cell Merged ... Invalid format")
                      Exit Function
                End If
                
                strColNames(intColCounter) = rngCell.Text
                                 
            Next
        End If
        
        '   Loop down the table's rows
        For intRowCounter = 2 To intRowCount
           
            ReDim new_nodes(0)
            ReDim NodeStack(0)
            '   Loop accross columns...
            For intColCounter = 1 To intColCount
                
                '   Mark the cell under current scrutiny by setting
                '   an object variable...
                Set rngCell = .Cells(intRowCounter, intColCounter)
                
                
                '   Is the cell merged?..
                If Not rngCell.MergeArea.Address = _
                                            rngCell.Address Then
                
                      MsgBox ("!! Cell Merged ... Invalid format")
                      Exit Function
                      
                                       
                End If
                          
                ' divide the field name by the delimiter to get appropriate node names
                Nodes = Split(strColNames(intColCounter), NODE_DELIMITER)
                    
                If UBound(Nodes) = 0 Then
                  ReDim Nodes(1)
                  Nodes(1) = strColNames(intColCounter)
                End If
                
                 ' don't count it when no content
                 If Trim(rngCell.Text) <> "" Then
                                    
                    Dim i As Integer
                    MatchAll = True
                    For i = 1 To UBound(Nodes)

                        If i <= UBound(NodeStack) Then
                            
                            If Trim(Nodes(i)) <> Trim(NodeStack(i)) Then
                                'not match
                                MatchAll = False
                                Exit For
                            
                            End If
                        Else
                          MatchAll = False
                          Exit For
                        End If
                       
                                                                          
                      Next
                      
                      ' match all means in same level as previous, so it needs to output for the last node
                      If MatchAll Then
                          i = i - 1
                      End If
                      
                          
                      If UBound(new_nodes) < UBound(Nodes) Then
                             ' enlong the array
                             ReDim Preserve new_nodes(UBound(Nodes))
                              
                              
                      End If
                          
                      For t = i To UBound(Nodes)
                          ' create uncommon nodes with the previous one
                          Set new_nodes(t) = objXMLDoc.createNode(1, Nodes(t), "")
                                                       
                      Next
                      
                      
                      For t = i - 1 To UBound(Nodes) - 1
                      
                          If t >= 1 Then
                              ' connect the nodes based on the hierarchy
                              new_nodes(t).appendChild (new_nodes(t + 1))
                          End If
                      
                      Next
                      Set Textcont = objXMLDoc.createTextNode(Trim(rngCell.Text))
                      new_nodes(UBound(Nodes)).appendChild (Textcont)
                       
                      If i = 1 Then
                          top_node.appendChild (new_nodes(1))
                      End If
                  
                  
                      NodeStack = Nodes
                                                               
                  End If
               
            Next ' finished a column
        Next
    End With
    

    '   Return the XMLDOM
     Set GenerateXMLDOM = objXMLDoc
     
End Function


Public Function FirstUcase(str As String) As String
    Dim s As String
    
    If (Len(str) <> 0) Then
        s = UCase(Left(Trim(str), 1)) & LCase(Right(Trim(str), Len(Trim(str)) - 1)) 'jmeno
    Else
        s = str
    End If
    
    FirstUcase = s
    
End Function

Public Sub SetPrintSetting()

sDIC = "DI|fffd|: " + CStr(Epp.Range("F5").Value)
sKeDni = "Ke dni: " + CStr(Epp.Range("F6").Value)
sSumaEtalonu = "Suma etanolu: " + CStr(Epp.Range("M5").Value)
    
Epp.PageSetup.LeftHeader = sDIC + ", " + sKeDni + ", " + sSumaEtalonu
'Epp.PageSetup.CenterHeader = "Page  &P  of  &N"
Epp.PageSetup.CenterHeader = ""

End Sub

Public Sub ClearRow(row As Long)
    Epp.Range(EppConstants.ColumnEppRCPestitele & row).Interior.ColorIndex = 36
    Epp.Range(EppConstants.ColumnEppEtanolL & row).Interior.ColorIndex = 36
    
    Dim setEnableEvents As Boolean
    
    setEnableEvents = Application.EnableEvents
    
    If setEnableEvents Then
        Application.EnableEvents = False
    End If
    
    Epp.Range(EppConstants.ColumnEppPrijmeni & row).Formula = ""
    Epp.Range(EppConstants.ColumnEppJmeno & row).Formula = ""
    Epp.Range(EppConstants.ColumnEppObec & row).Formula = ""
    Epp.Range(EppConstants.ColumnEppUlice & row).Formula = ""
    Epp.Range(EppConstants.ColumnEppCislo & row).Formula = ""
    Epp.Range(EppConstants.ColumnEppPSC & row).Formula = ""
    Epp.Range(EppConstants.ColumnEppEtanolL & row).Formula = ""
    'Epp.Range(EppConstants.ColumnEppEtanolHL & row).Formula = ""
    Epp.Range(EppConstants.ColumnEppRCVek & row).Formula = ""
    
    If setEnableEvents Then
        Application.EnableEvents = True
    End If
End Sub
        

Public Function ExcelOldVersion() As Boolean
    Dim ret As Integer
    Dim retStr As String
    Dim expression As String
    
    expression = Application.Version

    If Strings.InStr(expression, ",") > 0 Then
        retStr = Strings.Mid(expression, 1, Strings.InStr(expression, ",") - 1)
    ElseIf Strings.InStr(expression, ".") > 0 Then
        retStr = Strings.Mid(expression, 1, Strings.InStr(expression, ".") - 1)
    Else
        retStr = expression
    End If
    
    Dim isNum As Boolean
    isNum = True
    For i = 1 To Len(retStr)
        If (IsNumeric(CVar(Mid(retStr, i, 1))) = False) Then
            isNum = False
            Exit For
        End If
    Next i

    If isNum Then
        ret = CInt(retStr)
    Else
        ret = 0
    End If
    
         
    ExcelOldVersion = ret < 9
End Function
Public Function GetCountFullRow(ws As Worksheet) As Integer
    Dim VektorHodnot As Range
    Dim pocet_radku As Integer
    Dim r As String
    
    If ws Is DBlist Then r = "H2:H20000"
    If ws Is Epp Or ws Is Epp97 Then r = "C11:C3010"
    
    Set VektorHodnot = ws.Range(r)
    pocet_radku = Application.WorksheetFunction.Max(VektorHodnot)
    
    GetCountFullRow = pocet_radku
End Function

Public Sub CopyDataFrom97()
    
    Application.EnableEvents = False
    
    Dim pocetRadku As Integer
    pocetRadku = GetCountFullRow(Epp97)

    Epp97.Range(EppConstants.ColumnEppRCPestitele & "11:" & EppConstants.ColumnEppEtanolL & "3010").Copy Destination:=Epp.Range(EppConstants.ColumnEppRCPestitele & "11")
    Epp97.Range("F5").Copy Destination:=Epp.Range("F5")
    Epp97.Range("F6").Copy Destination:=Epp.Range("F6")
    
    Epp.KontrolaEpp
    
    Application.EnableEvents = True
    
End Sub
Attribute VB_Name = "ModuleRC"

Function ValidateRC(ByRef rodneCislo As String, ByVal replaceChar As Boolean) As Boolean
    Dim retTestRC As Boolean
       
    rc = rodneCislo
    
    'konverze lomitka
    rc = Replace(rc, "/", "")
    rc = Replace(rc, "\", "")
    
    'Test RC
    retTestRC = True 'predpoklad spravnosti RC
    
    'zda neobsahuje nejake nepovolene znaky
    For i = 1 To Len(rc)
        If (IsNumeric(CVar(Mid(rc, i, 1))) = False) And (Mid(rc, i, 1) <> "/") Then
            retTestRC = False
            Exit For
        End If
    Next i
    
    If retTestRC Then
        If Len(rc) = 9 Then 'pro 9 cifer jen kontrola na rocnik
            Rocnik = Mid(rc, 1, 2)
            If Rocnik >= 54 Then retTestRC = False
        Else
            If Len(rc) = 10 Then ' pro 10 cifer kontrola na kontrolni cislici
                RCcislo = Mid(rc, 1, 9)
                RC10 = RCcislo Mod 11
                
                If RC10 = 10 Then RC10 = 0
                
                If Mid(rc, 10, 1) <> CStr(RC10) Then retTestRC = False
            Else
                retTestRC = False 'jiny pocet cifer neni pripustny
            End If
        End If 'pro 9 cifer jen kontrola na rocnik
    End If
        
    If Mid(rc, 3, 1) > 6 Then retTestRC = False   ' dodatecna kontrola na 3ti cislici
    
    If retTestRC Then
        rok = Mid(rc, 1, 2)
        mesic = Mid(rc, 3, 2)
        den = Mid(rc, 5, 2)
               
        If (CInt(mesic) > 50) Then mesic = CStr(CInt(mesic) - 50)
     
        retTestRC = IsDate(mesic & "/" & den & "/" & CInt(rok)) ' nic moc
        
    End If
    
    ValidateRC = retTestRC
    If replaceChar Then rodneCislo = rc
End Function

Public Function RCNastavLomitko(rodneCislo As String) As String
    
    If InStr(1, rodneCislo, "/") = 0 Then
        If Len(rodneCislo) = 10 Then rodneCislo = Mid(rodneCislo, 1, 6) & "/" & Mid(rodneCislo, 7, 4)
        If Len(rodneCislo) = 9 Then rodneCislo = Mid(rodneCislo, 1, 6) & "/" & Mid(rodneCislo, 7, 3)
    End If
    RCNastavLomitko = rodneCislo
End Function
Attribute VB_Name = "Napoveda"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True













Attribute VB_Name = "Napoveda97"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True













Attribute VB_Name = "Tento_se|fffd|it"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Public seznam, Posun, MaxSeznam As Integer
Public Cislo As Double


Private Sub Workbook_BeforePrint(Cancel As Boolean)

SetPrintSetting
End Sub

Private Sub Workbook_Open()
    Application.EnableEvents = True
    seznam = 3000
    Posun = 10
    MaxSeznam = seznam + Posun
    
    Dim superUser As Boolean
    superUser = False
    'superUser = True  ' v pripade ze chcete videt vse odremujte tento radek
    
    Epp.lblProgress.Caption = ""
    
    If superUser Then
        Epp.visible = xlSheetVisible
        Napoveda.visible = xlSheetVisible
        Epp97.visible = xlSheetVisible
        Napoveda97.visible = xlSheetVisible
        DBlist.visible = xlSheetVisible
        
        Epp97.Select
    
    ElseIf ExcelOldVersion Then
        Epp.visible = xlSheetVeryHidden
        Napoveda.visible = xlSheetVeryHidden
        Epp97.visible = xlSheetVisible
        Napoveda97.visible = xlSheetVisible
        DBlist.visible = xlSheetVeryHidden
        
        Epp97.Select
    Else
        Worksheets("EPP").Protect , userinterfaceonly:=True
        
        Dim pocetRadku97 As Integer
        pocetRadku97 = GetCountFullRow(Epp97)
              
        Epp.visible = xlSheetVisible
        Napoveda.visible = xlSheetVisible
        If pocetRadku97 > 0 Then
            Epp97.visible = xlSheetVisible
            Epp97.Select
            If MsgBox("V se|fffd|itu EPP(97) jsou data zapsan|fffd| v Excelu 97- " & Constants.vbNewLine & "Chcete je zkop|fffd|rovat do EPP?", vbQuestion & vbYesNo, "Epp") = vbYes Then CopyDataFrom97
        Else
            Epp97.visible = xlSheetVeryHidden
        End If
        Napoveda97.visible = xlSheetHidden
        DBlist.visible = xlSheetVisible
        
        Epp.Select
    End If
    
    Range("D11").Select
End Sub
Attribute VB_Name = "UpravZaznam"
Attribute VB_Base = "0{CDDAB937-CFC0-43B4-95E0-2E510E2FCDEA}{6ECBF9D8-0476-431D-8A98-17638FC00623}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False












Dim close_OK As Boolean


Private Sub btnUlozit_Click()
On Error GoTo ErrSub

Dim DB_pestitelu As Range

Dim i, radek, novy_radek, seznam_list, seznam, start_list, start, last_ID As Integer
Dim radek_txt, vyraz, rozsah, zprava, strRC, strJmeno, strPrijm, strObec, strUlice, strCislo, strPSC As String
Dim nasel As Boolean

Application.EnableEvents = False

i = 0
nasel = False
start = 2
seznam = 20000
start_list = 11
seznam_list = 3000
rozsah = "A" & start & ":H" & seznam
vyraz_RC = "=DZ|fffd|SKAT(A1:H" & seznam & ";Q2;P1:P2)" 'zapiseme vzorec
vyraz_MAX = "=MAX(H2:H" & seznam & ")" 'zapiseme vzorec

max_ID = DBlist.Range("O3").Value  'najdeme maximalni ID
novy_radek = max_ID + 1
Set DB_pestitelu = DBlist.Range(rozsah)

'vyplnime pole funkci nutnych pro vyhledavani RC
    DBlist.Range("O1").Value = "Funkce"    'po|fffd|adovan|fffd| funkce
    DBlist.Range("P1").Value = "Rodn|fffd| |fffd||fffd|slo"    'jmeno pole kriterii
    DBlist.Range("Q1").Value = "Vr|fffd|tit"   'jmena vracenych poli
    DBlist.Range("O2").FormulaLocal = vyraz_RC    'vysledek"
    DBlist.Range("Q2").Value = "ID" 'jmeno vraceneho pole
    
'vyplnime pole funkci nutnych pro vyhledani MAX ID
    DBlist.Range("O3").Value = vyraz_MAX    'vysledek a po|fffd|adovan|fffd| funkce
    DBlist.Range("Q3").Value = "max"    'jmeno funkce



hledane_RC = Trim(UpravZaznam.txtRC.Value)


    DBlist.Range("P2").Value = "=" & Chr(34) & hledane_RC & Chr(34)   'hledany vyraz"
    radek_txt = DBlist.Range("O2").Text   'najdeme cislo radku z ID

    Select Case radek_txt
        Case "#HODNOTA!" 'neexistuje v DB
                        If novy_radek <= seznam Then 'test prekroceni hranice DB
                            'nahrajeme do radku v DB
                            UpravZaznam.TextBox2.Value = FirstUcase(Trim(UpravZaznam.TextBox2.Value))
                            UpravZaznam.TextBox1.Value = FirstUcase(Trim(UpravZaznam.TextBox1.Value))
                            
                            DB_pestitelu.Cells(novy_radek, 1) = Trim(UpravZaznam.txtRC.Value) 'rodne cislo
                            DB_pestitelu.Cells(novy_radek, 2) = UpravZaznam.TextBox2.Value 'prijmeni
                            DB_pestitelu.Cells(novy_radek, 3) = UpravZaznam.TextBox1.Value 'jmeno
                            DB_pestitelu.Cells(novy_radek, 4) = Trim(UpravZaznam.TextBox3.Value) 'obec
                            DB_pestitelu.Cells(novy_radek, 5) = Trim(UpravZaznam.TextBox4.Value) 'ulice
                            DB_pestitelu.Cells(novy_radek, 6) = Trim(UpravZaznam.TextBox5.Value) 'cislo
                            DB_pestitelu.Cells(novy_radek, 7) = Trim(UpravZaznam.TextBox6.Value) 'PSC
                            DB_pestitelu.Cells(novy_radek, 8) = max_ID + 1 'nove ID
                        Else
                            MsgBox "Datab|fffd|ze je pln|fffd|.", vbOKOnly, "V|fffd|jimka"
                        End If
                        
                        DBlist.Range("P3").Value = max_ID + 1 'zapiseme nove max ID do listu ke sdileni
                
        Case "#NUM!" 'opakuje se v DB
                        MsgBox "Duplicitn|fffd| v|fffd|skyt rodn|fffd|ho |fffd||fffd|sla v datab|fffd|zi.", vbOKOnly, "V|fffd|jimka"
            
        Case Else
                        'vse je OK - najdeme ciselnou hodnotu
                        radek = DBlist.Range("O2").Value  'najdeme cislo radku z ID
                        
                        UpravZaznam.TextBox2.Value = FirstUcase(Trim(UpravZaznam.TextBox2.Value))
                        UpravZaznam.TextBox1.Value = FirstUcase(Trim(UpravZaznam.TextBox1.Value))
                        
                        'nahrajeme do radku v DB
                        DB_pestitelu.Cells(radek, 1) = Trim(UpravZaznam.txtRC.Value) 'rodne cislo
                        DB_pestitelu.Cells(radek, 2) = UpravZaznam.TextBox2.Value 'prijmeni
                        DB_pestitelu.Cells(radek, 3) = UpravZaznam.TextBox1.Value 'jmeno
                        DB_pestitelu.Cells(radek, 4) = Trim(UpravZaznam.TextBox3.Value) 'obec
                        DB_pestitelu.Cells(radek, 5) = Trim(UpravZaznam.TextBox4.Value) 'ulice
                        DB_pestitelu.Cells(radek, 6) = Trim(UpravZaznam.TextBox5.Value) 'cislo
                        DB_pestitelu.Cells(radek, 7) = Trim(UpravZaznam.TextBox6.Value) 'PSC
            
    End Select

Application.EnableEvents = True
UpravZaznam.Hide
close_OK = True

Exit Sub

ErrSub:
MsgBox "Do|fffd|lo k neo|fffd|ek|fffd|van|fffd| v|fffd|jimce " & Err.Number & ", z|fffd|ejm|fffd| chybn|fffd| |fffd||fffd|dky v DB", vbOKOnly, "V|fffd|jimka"
Application.EnableEvents = True
UpravZaznam.Hide
Resume Next

End Sub

Private Sub CommandButton2_Click()
    'vycistime formular a zavreme formular
    UpravZaznam.txtRC.Value = ""
    UpravZaznam.TextBox1.Value = ""
    UpravZaznam.TextBox2.Value = ""
    UpravZaznam.TextBox3.Value = ""
    UpravZaznam.TextBox4.Value = ""
    UpravZaznam.TextBox5.Value = ""
    UpravZaznam.TextBox6.Value = ""
    UpravZaznam.Tag = 0
    UpravZaznam.Hide
    
    DBlist.Range("P3").Value = 0 'nastavime priznak storno Max_ID = 0

End Sub

Private Sub OdemkniTlacitkoUloz() 'kontrola pro povoleni ulozeni
    Dim povolUlozeni As Boolean
    
    povolUlozeni = UpravZaznam.txtRC <> "" And UpravZaznam.TextBox1 <> ""
    povolUlozeni = povolUlozeni And UpravZaznam.TextBox2 <> "" And UpravZaznam.TextBox3 <> ""
    povolUlozeni = povolUlozeni And UpravZaznam.TextBox4 <> "" And UpravZaznam.TextBox5 <> ""
    povolUlozeni = povolUlozeni And UpravZaznam.TextBox6 <> ""
    
    'zatim kontrolovano odtud
    povolUlozeni = True
    
    Dim psc As String
    povolPSC = True
    psc = UpravZaznam.TextBox6.Text
    
    For i = 1 To Len(psc)
        If (IsNumeric(CVar(Mid(psc, i, 1))) = False) Then
            povolPSC = False
            Exit For
        End If
    Next i

    If (povolPSC And Len(psc) = 5) Then
        UpravZaznam.TextBox6.BackColor = vbWindowBackground
    Else
        UpravZaznam.TextBox6.BackColor = vbRed
    End If
    
    
    UpravZaznam.btnUlozit.Enabled = povolUlozeni
End Sub

Private Sub CommandButton3_Click()  'nacist 1 zaznam z DB
On Error GoTo ErrSub

'Exit Sub 'nezapomen odstranit //////////////////////////////////////////////////////////////////////////////////////////////

Dim DB_pestitelu, VektorHodnot As Range

Dim i, ii, radek, novy_radek, seznam_list, seznam, start_list, start, last_ID, chyba, pocet_radku As Integer
Dim radek_txt, vyraz, rozsah, zprava, strRC, strJmeno, strPrijm, strObec, strUlice, strCislo, strPSC As String
Dim nasel As Boolean

Application.EnableEvents = False

i = 0
ii = 0
chyba = 0 'pocet zaznamu ktere nejsou v DB
nasel = False
start = 2
seznam = 20000
start_list = 11
seznam_list = 3000
rozsah = "A" & start & ":H" & seznam
vyraz_RC = "=DZ|fffd|SKAT(A1:H" & seznam & ";Q2;P1:P2)" 'zapiseme vzorec
vyraz_MAX = "=MAX(H2:H" & seznam & ")" 'zapiseme vzorec
radek_txt = "" 'vynulujeme

Set DB_pestitelu = DBlist.Range(rozsah)
'vyplnime pole funkci nutnych pro vyhledavani RC
    DBlist.Range("O1").Value = "Funkce"    'po|fffd|adovan|fffd| funkce
    DBlist.Range("P1").Value = "Rodn|fffd| |fffd||fffd|slo"    'jmeno pole kriterii
    DBlist.Range("Q1").Value = "Vr|fffd|tit"   'jmena vracenych poli
    DBlist.Range("O2").FormulaLocal = vyraz_RC    'vysledek
    DBlist.Range("Q2").Value = "ID" 'jmeno vraceneho pole
    

hledane_RC = Trim(UpravZaznam.txtRC.Value)

    DBlist.Range("P2").Value = "=" & Chr(34) & hledane_RC & Chr(34)   'hledany vyraz"
    
    Do While radek_txt = "" 'zpozdovaci smycka - nez to Excel vyhodnoti na pomalejsich strojich
    radek_txt = DBlist.Range("O2").Text   'najdeme cislo radku z ID
    ii = ii + 1
    If ii = 5000 Then Exit Do
    Loop

    Select Case radek_txt
        Case "#HODNOTA!" 'neexistuje v DB
           chyba = chyba + 1
                
        Case "#NUM!" 'opakuje se v DB
            MsgBox "Duplicitn|fffd| v|fffd|skyt rodn|fffd|ho |fffd||fffd|sla v datab|fffd|zi. Odstra|fffd|te duplicitn|fffd| z|fffd|znam.", vbOKOnly, "V|fffd|jimka"
            
        Case Else
            'vse je OK - najdeme ciselnou hodnotu
            radek = DBlist.Range("O2").Value  'najdeme cislo radku z ID
            
            'ted to nacteme z DB
            strPrijm = DB_pestitelu.Cells(radek, 2)
            strJmeno = DB_pestitelu.Cells(radek, 3)
            strObec = DB_pestitelu.Cells(radek, 4)
            strUlice = DB_pestitelu.Cells(radek, 5)
            strCislo = DB_pestitelu.Cells(radek, 6)
            strPSC = DB_pestitelu.Cells(radek, 7)
                        
            'nahrajeme do radku v EPP
            Epp.Range("E" & UpravZaznam.Tag).Value = UCase(Trim(strPrijm))              'prijmeni
            Epp.Range("F" & UpravZaznam.Tag).Value = UCase(Left(Trim(strJmeno), 1)) & LCase(Right(Trim(strJmeno), Len(Trim(strJmeno)) - 1))  'jmeno
            Epp.Range("G" & UpravZaznam.Tag).Value = Trim(strObec) 'obec
            Epp.Range("H" & UpravZaznam.Tag).Value = Trim(strUlice) 'ulice
            Epp.Range("I" & UpravZaznam.Tag).Value = Trim(strCislo) 'cislo
            Epp.Range("J" & UpravZaznam.Tag).Value = Trim(strPSC) 'PSC
            
    End Select

Application.EnableEvents = True
UpravZaznam.Hide
Exit Sub

ErrSub:
MsgBox "Do|fffd|lo k neo|fffd|ek|fffd|van|fffd| v|fffd|jimce " & Err.Number & ", z|fffd|ejm|fffd| chybn|fffd| |fffd||fffd|dky v DB", vbOKOnly, "V|fffd|jimka"
Application.EnableEvents = True
Resume Next

End Sub

Private Sub TextBox1_Change()
 Call OdemkniTlacitkoUloz
End Sub

Private Sub TextBox2_Change()
 Call OdemkniTlacitkoUloz
End Sub

Private Sub TextBox3_Change()
 Call OdemkniTlacitkoUloz
End Sub

Private Sub TextBox4_Change()
 Call OdemkniTlacitkoUloz
End Sub

Private Sub TextBox5_Change()
 Call OdemkniTlacitkoUloz
End Sub

Private Sub TextBox6_Change()
 Call OdemkniTlacitkoUloz
End Sub


Private Sub txtRC_Change()
 Call OdemkniTlacitkoUloz
    txtRC.Value = RCNastavLomitko(txtRC.Value)
    If (ValidateRC(txtRC.Value, False) Or txtRC.Value = "") Then
        txtRC.Value = RCNastavLomitko(txtRC.Value)
        txtRC.BackColor = vbWindowBackground
    Else
        txtRC.BackColor = vbRed
    End If
End Sub

Public Sub DataSet(ByVal strRC As String, ByVal strJmeno As String, ByVal strPrijm As String, ByVal strObec As String, ByVal strUlice As String, ByVal strCislo As String, ByVal strPSC As String)
    close_OK = False
    
    UpravZaznam.txtRC.Value = strRC
    UpravZaznam.TextBox1.Value = FirstUcase(Trim(strJmeno)) 'jmeno
    UpravZaznam.TextBox2.Value = FirstUcase(Trim(strPrijm)) 'prijmeni
    UpravZaznam.TextBox3.Value = Trim(strObec) 'obec
    UpravZaznam.TextBox4.Value = Trim(strUlice) 'ulice
    UpravZaznam.TextBox5.Value = Trim(strCislo) 'cislo
    UpravZaznam.TextBox6.Value = Trim(strPSC) 'PSC
    
End Sub
Public Sub DataGet(ByRef strJmeno)
    
    'UpravZaznam.txtRC.Value = strRC
    strJmeno = UpravZaznam.TextBox1.Value
    'strPrijm = UpravZaznam.TextBox2.Value 'prijmeni
    'UpravZaznam.TextBox3.Value = Trim(strObec) 'obec
    'UpravZaznam.TextBox4.Value = Trim(strUlice) 'ulice
    'UpravZaznam.TextBox5.Value = Trim(strCislo) 'cislo
    'UpravZaznam.TextBox6.Value = Trim(strPSC) 'PSC
End Sub

Property Get CloseOK() As Boolean
    CloseOK = close_OK
End Property

Public Sub DataClear()
    'vycistime formular
    UpravZaznam.txtRC.Value = ""
    UpravZaznam.TextBox1.Value = ""
    UpravZaznam.TextBox2.Value = ""
    UpravZaznam.TextBox3.Value = ""
    UpravZaznam.TextBox4.Value = ""
    UpravZaznam.TextBox5.Value = ""
    UpravZaznam.TextBox6.Value = ""

End Sub


' InQuest injected base64 decoded content
' .+-F

INQUEST-PP=macro
