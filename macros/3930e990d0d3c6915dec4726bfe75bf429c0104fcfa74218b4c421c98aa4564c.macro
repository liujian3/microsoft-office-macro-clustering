Attribute VB_Name = "Module1"
Sub Lombard()
Attribute Lombard.VB_ProcData.VB_Invoke_Func = "t\n14"

Dim dtDate As Date
Dim MyExcelApp As Excel.Application
dtDate = Date

Dim strFile As String
strFile = "LombardReport" & Format(dtDate, " dd-mm-yy") & ".xlsm"

ActiveWorkbook.SaveAs Filename:=strFile

Range("H:H,I:I,J:J").delete
Rows("1:3").delete

Dim report As Worksheet
    Sheets.Add.Name = "160111"
    Sheets.Add.Name = "160112"
    Sheets.Add.Name = "16011B"
    Sheets.Add.Name = "16011D"
    Sheets.Add.Name = "194733"
    Sheets.Add.Name = "196135"
    Sheets.Add.Name = "196136"
    Sheets.Add.Name = "196137"
    Sheets.Add.Name = "196138"
    Sheets.Add.Name = "196139"
    Sheets.Add.Name = "197150"
    
Sheets("report").UsedRange
With Worksheets("report")
    .Range("A1:Z9999").AutoFilter field:=9, Criteria1:="160111"
LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
    .Range("A1:A" & LastRow).SpecialCells(xlCellTypeVisible).EntireRow.Copy _
            Destination:=Sheets("160111").Range("A1")
            
          End With
            
Worksheets("report").Range("A1:Z9999").Copy Worksheets("160111").Range("A1")
Rows("1:1").Select
    Selection.Font.Bold = True
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlBottom
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    Cells.Select
    Cells.EntireColumn.AutoFit


Sheets("report").UsedRange
With Worksheets("report")
    .Range("A1:Z9999").AutoFilter field:=9, Criteria1:="160112"
LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
    .Range("A1:A" & LastRow).SpecialCells(xlCellTypeVisible).EntireRow.Copy _
            Destination:=Sheets("160112").Range("A1")
            
          End With
            
Worksheets("report").Range("A1:Z9999").Copy Worksheets("160112").Range("A1")
Rows("1:1").Select
    Selection.Font.Bold = True
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlBottom
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    Cells.Select
    Cells.EntireColumn.AutoFit
    

Sheets("report").UsedRange
With Worksheets("report")
    .Range("A1:Z9999").AutoFilter field:=9, Criteria1:="000016011B"
LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
    .Range("A1:A" & LastRow).SpecialCells(xlCellTypeVisible).EntireRow.Copy _
            Destination:=Sheets("16011B").Range("A1")
            
          End With
            
Worksheets("report").Range("A1:Z9999").Copy Worksheets("16011B").Range("A1")
Rows("1:1").Select
    Selection.Font.Bold = True
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlBottom
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    Cells.Select
    Cells.EntireColumn.AutoFit

Sheets("report").UsedRange
With Worksheets("report")
    .Range("A1:Z9999").AutoFilter field:=9, Criteria1:="000016011D"
LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
    .Range("A1:A" & LastRow).SpecialCells(xlCellTypeVisible).EntireRow.Copy _
            Destination:=Sheets("16011D").Range("A1")
            
          End With
                      
Worksheets("report").Range("A1:Z9999").Copy Worksheets("194733").Range("A1")
Rows("1:1").Select
    Selection.Font.Bold = True
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlBottom
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    Cells.Select
    Cells.EntireColumn.AutoFit
Sheets("report").UsedRange
With Worksheets("report")
    .Range("A1:Z9999").AutoFilter field:=9, Criteria1:="194733"
LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
    .Range("A1:A" & LastRow).SpecialCells(xlCellTypeVisible).EntireRow.Copy _
            Destination:=Sheets("194733").Range("A1")
            
          End With
            
Worksheets("report").Range("A1:Z9999").Copy Worksheets("196135").Range("A1")
Rows("1:1").Select
    Selection.Font.Bold = True
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlBottom
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    Cells.Select
    Cells.EntireColumn.AutoFit
Sheets("report").UsedRange
With Worksheets("report")
    .Range("A1:Z9999").AutoFilter field:=9, Criteria1:="196135"
LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
    .Range("A1:A" & LastRow).SpecialCells(xlCellTypeVisible).EntireRow.Copy _
            Destination:=Sheets("196135").Range("A1")
            
          End With
            
Worksheets("report").Range("A1:Z9999").Copy Worksheets("196136").Range("A1")
Rows("1:1").Select
    Selection.Font.Bold = True
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlBottom
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    Cells.Select
    Cells.EntireColumn.AutoFit
Sheets("report").UsedRange
With Worksheets("report")
    .Range("A1:Z9999").AutoFilter field:=9, Criteria1:="196136"
LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
    .Range("A1:A" & LastRow).SpecialCells(xlCellTypeVisible).EntireRow.Copy _
            Destination:=Sheets("196136").Range("A1")
            
          End With
          
Worksheets("report").Range("A1:Z9999").Copy Worksheets("196137").Range("A1")
Rows("1:1").Select
    Selection.Font.Bold = True
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlBottom
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    Cells.Select
    Cells.EntireColumn.AutoFit
Sheets("report").UsedRange
With Worksheets("report")
    .Range("A1:Z9999").AutoFilter field:=9, Criteria1:="196137"
LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
    .Range("A1:A" & LastRow).SpecialCells(xlCellTypeVisible).EntireRow.Copy _
            Destination:=Sheets("196137").Range("A1")
            
          End With

Worksheets("report").Range("A1:Z9999").Copy Worksheets("196138").Range("A1")
Rows("1:1").Select
    Selection.Font.Bold = True
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlBottom
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    Cells.Select
    Cells.EntireColumn.AutoFit
Sheets("report").UsedRange
With Worksheets("report")
    .Range("A1:Z9999").AutoFilter field:=9, Criteria1:="196138"
LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
    .Range("A1:A" & LastRow).SpecialCells(xlCellTypeVisible).EntireRow.Copy _
            Destination:=Sheets("196138").Range("A1")
            
          End With


Worksheets("report").Range("A1:Z9999").Copy Worksheets("196139").Range("A1")
Rows("1:1").Select
    Selection.Font.Bold = True
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlBottom
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    Cells.Select
    Cells.EntireColumn.AutoFit
Sheets("report").UsedRange
With Worksheets("report")
    .Range("A1:Z9999").AutoFilter field:=9, Criteria1:="196139"
LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
    .Range("A1:A" & LastRow).SpecialCells(xlCellTypeVisible).EntireRow.Copy _
            Destination:=Sheets("196139").Range("A1")
            
          End With
          
 Sheets("report").UsedRange
With Worksheets("report")
    .Range("A1:Z9999").AutoFilter field:=9, Criteria1:="197150"
LastRow = .Range("A" & .Rows.Count).End(xlUp).Row
    .Range("A1:A" & LastRow).SpecialCells(xlCellTypeVisible).EntireRow.Copy _
            Destination:=Sheets("197150").Range("A1")
            
          End With
            
Worksheets("report").Range("A1:Z9999").Copy Worksheets("197150").Range("A1")
Rows("1:1").Select
    Selection.Font.Bold = True
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlBottom
        .WrapText = False
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = False
        .ReadingOrder = xlContext
        .MergeCells = False
    End With
    Cells.Select
    Cells.EntireColumn.AutoFit
          
          
Application.DisplayAlerts = False
Worksheets("report").delete
Application.DisplayAlerts = False

ActiveWorkbook.Save

            
Dim OutApp As Object
    Dim OutMail As Object

    Set OutApp = CreateObject("Outlook.Application")
    Set OutMail = OutApp.CreateItem(0)

    On Error Resume Next

    With OutMail
        .To = ""
        .CC = ""
        .BCC = ""
        .Subject = "TA ACCOUNT REPORT " & Date
        .HTMLBody = "Dear All," & "<br>" & "<br>" & "Please find attached the weekly Transfer Agent accounts list as per " & Format(dtDate, " dd-mm-yy") & "  for your accounts 160111,160112, 16011B, 194733, 16011D ,196135, 196136, 196137 and 197150." & "<br>" & "<br>" & "Please let me know if you require anything additional." & "<br>" & "<br>" & "Kind Regards"
        .Attachments.Add ActiveWorkbook.FullName
        .Display 'Change the argument to "Send" to directly send the email
    End With
    On Error GoTo 0
 
    With Application
        .EnableEvents = True
        .ScreenUpdating = True
    End With
 
    Set OutMail = Nothing
    Set OutApp = Nothing

ActiveWorkbook.Close True

End Sub


Function RangetoHTML(rng As Range)
    Dim fso As Object
    Dim ts As Object
    Dim TempFile As String
    Dim TempWB As Workbook

    TempFile = Environ$("temp") & "/" & Format(Now, "dd-mm-yy h-mm-ss") & ".htm"
 
    ' Copy the range and create a workbook to receive the data.
    rng.Copy
    Set TempWB = Workbooks.Add(1)
    With TempWB.Sheets(1)
        .Cells(1).PasteSpecial Paste:=8
        .Cells(1).PasteSpecial xlPasteValues, , False, False
        .Cells(1).PasteSpecial xlPasteFormats, , False, False
        .Cells(1).Select
        Application.CutCopyMode = False
        On Error Resume Next
        .DrawingObjects.Visible = True
        .DrawingObjects.delete
        On Error GoTo 0
    End With
 
    ' Publish the sheet to an .htm file.
    With TempWB.PublishObjects.Add( _
         SourceType:=xlSourceRange, _
         Filename:=TempFile, _
         Sheet:=TempWB.Sheets(1).Name, _
         Source:=TempWB.Sheets(1).UsedRange.Address, _
         HtmlType:=xlHtmlStatic)
        .Publish (True)
    End With
 
    ' Read all data from the .htm file into the RangetoHTML subroutine.
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set ts = fso.GetFile(TempFile).OpenAsTextStream(1, -2)
    RangetoHTML = ts.ReadAll
    ts.Close
    RangetoHTML = Replace(RangetoHTML, "align=center x:publishsource=", _
                          "align=left x:publishsource=")
 
    ' Close TempWB.
    TempWB.Close SaveChanges:=False
 
    ' Delete the htm file.
    Kill TempFile
 
    Set ts = Nothing
    Set fso = Nothing
    Set TempWB = Nothing
End Function


Attribute VB_Name = "ThisWorkbook"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True


INQUEST-PP=macro
