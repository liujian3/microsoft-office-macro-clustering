Attribute VB_Name = "Datos"
Public rangotabla1, rangotabla2, renglones1, renglones2, estado_para_municipios
Public rangoInsti, rengInsti
Public columna, num_columnas_encabezado
Public hoja, abriendo_el_libro, macro_para_actualizar
Public existeR1, existePerR1
Public nominsti, vnumins, vnumper
Public periodos, instituciones, arrInsti, arrPeriodo, ultinsti, ultper, ultimoenCombo3, ultimoenCombo4
Public arrCombo1, arrCombo2, arrCombo3, arrCombo4, DatoCombo1, DatoCombo2, DatoCombo3, DatoCombo4
Public hojaprincipal, estelibro, MiConexion
Public columna_inicial, renglones_datos, datos_de_la_tabla
Public posicion, destino, destino_ant, destino_final
Public dimen_el_combo, Actualizado, cual_cve_encabezado
Public campo, campodl, ligado, llenar, total_de_columnas
Public columnas_encabezado, renglones_encabezado, inicio, renglon_inicio, cves_encabezado, datos_en_encabezado
Public periodol, periodoantl, LimitarInstituciones, excluir_virtuales, incluir_sofomes, limitar_periodos, QuitarInstituciones
Public formatocol, num_pivotes, numero_de_combos_activos, Combos_Llenos
Public der_tabla, aba_tabla, formato_tabla, columnas_en_tabla, datos_encontrados, selecciona_todo
Public vnumcombo1, vnumcombo2, vnumcombo3, vnumcombo4
Public dato_opcional1, campo_opcional1, dato_opcional2, campo_opcional2, numero_real_de_elementos
Public numero_de_datos_en_combo4, numero_de_datos_en_combo3, numero_de_datos_en_combo2, numero_de_datos_en_combo1
Public anterior_c1, anterior_c2, anterior_c3, anterior_c4
Public activocombo1, activocombo2, activocombo3, activocombo4
Public tiposeleccioncombo1, tiposeleccioncombo2, tiposeleccioncombo3, tiposeleccioncombo4
Public cvecombo1, cvecombo2, cvecombo3, cvecombo4, cve_en_combo1, cve_en_combo2, cve_en_combo3, cve_en_combo4
Public dlcombo1, dlcombo2, dlcombo3, dlcombo4, dl_en_combo1, dl_en_combo2, dl_en_combo3, dl_en_combo4
Public EtiquetaCombo1, EtiquetaCombo2, EtiquetaCombo3, EtiquetaCombo4
Public listar_combo1en_b, listar_combo2en_b, listar_combo3en_b, listar_combo4en_b, hay_listado
Public listar_tabla_estados, listar_tabla_municipios, listar_tabla_instituciones, listar_tabla_conceptos, listar_tabla_fija
Public ligar_combo2, ligar_combo3, ligar_combo4
Public orden_combo1, orden_combo2, orden_combo3, orden_combo4, orden_combo
Public monedas_en_combo1, monedas_en_combo2, monedas_en_combo3, monedas_en_combo4
Public conceptos_en_combo1, conceptos_en_combo2, conceptos_en_combo3, conceptos_en_combo4
Public estados_en_combo1, estados_en_combo2, estados_en_combo3, estados_en_combo4
Public municipios_en_combo1, municipios_en_combo2, municipios_en_combo3, municipios_en_combo4
Public localidades_en_combo1, localidades_en_combo2, localidades_en_combo3, localidades_en_combo4
Public generar_t_monedas, sector_t_monedas, sub_reporte_t_monedas, TCP
Public generar_t_conceptos, sector_t_conceptos, sub_reporte_t_conceptos
Public generar_t_estados, generar_t_municipios, generar_t_localidades
Public queryR01, querycombo1, querycombo2, querycombo3, querycombo4, queryextra1, queryextra2, queryextra3, queryextra4, queryextra5, queryextra6
Public periodos_en_combo1, periodos_en_combo2, periodos_en_combo3, periodos_en_combo4
Public instituciones_en_combo1, instituciones_en_combo2, instituciones_en_combo3, instituciones_en_combo4
Public valor_error, dl_combo1, dl_combo2, dl_combo3, dl_combo4, datos_de_columnas_en_encabezado
Public sel_todo_combo1, sel_todo_combo2, sel_todo_combo3, sel_todo_combo4, posicion_h, posicion2
Public ACVP, ACNP, quitar_columnas, Estado_actual, pintar_cves_en_el_encabezado, quitar_cve, quitar_columnas_der
Public pintado_formato
Public inicializando, cve_del_combo(3, 1), cves_de_combos_activos(3, 1), DC
Sub Actualiza_TD()
Application.ScreenUpdating = False
Estado_actual = 1
Combos_Llenos = False

    If ThisWorkbook.Sheets(2).Name <> "Notas" Then
        ThisWorkbook.Sheets("Notas").Move Before:=Sheets(2)
    End If
    
valor_error = ""
    desBloquea
    inicializa
    
    ThisWorkbook.Sheets(hojaprincipal).Activate
        ActiveWindow.FreezePanes = False
    ThisWorkbook.Sheets("BD").Activate
    
    If UCase(ThisWorkbook.Sheets("Query").Range("A3").Value) = "EXPORTAR" Then
        exportar_datos_TR01
        GoTo FIN
    End If

    
    Sheets("BD").Select
    
    If valor_error <> "" Then
            GoTo ERRORES
        Else
        
        tamcombo
        
        Sheets("BD").Select
        'DESARROLLO
        If UCase(ThisWorkbook.Sheets("BD").Range("C2").Value) = "SI" Then
            borra_hasta ("F1")
            borra_hasta ("A10")
            Call genera_querys
                If valor_error <> "" Then GoTo ERRORES
        End If

    End If

'***************************
revisa_y_llena_combos
limpia_combos

Actualizado = True
Combos_Llenos = True

selecciona_todo_en_el_combo
Application.ScreenUpdating = False

Call ultimafechaactualizacion(1, 0)
tamcombo

    Call proceso_abrir_libro

    Range("MINFO!a1").Value = ""
    Range("MINFO!a2").Value = ""
GoTo FIN
'************************************
ERRORES:
    Errores_generales

FIN:

Estado_actual = 3
Range(posicion).Offset(2, 2).Select

End Sub
Sub CADENAS(tabla, cadena, campo, tipo, dl)
'VER 4
On Error GoTo Control_Error

x1 = 0
miclave = 0
inicio = True

Set pvttable = ThisWorkbook.Sheets("BD").PivotTables(tabla)

cadena = "("
If UCase(tipo) = "ALFANUMERICO" Or campo = "cve_municipio5" Then
    cadena = cadena & "'"
End If

        For Each pvtitem In pvttable.PivotFields(campo).PivotItems
        miclaveant = miclave
        miclave = pvtitem.Name
        If miclave <> miclaveant Then
        
                If inicio = True Then
                    cadena = cadena & miclave
                    If UCase(tipo) = "ALFANUMERICO" Or campo = "cve_municipio5" Then
                        cadena = cadena & "'"
                    End If
                    
                    inicio = False
                Else
                    cadena = cadena & ","
                    If UCase(tipo) = "ALFANUMERICO" Or campo = "cve_municipio5" Then
                        cadena = cadena & "'"
                    End If
                    cadena = cadena & miclave
                    If UCase(tipo) = "ALFANUMERICO" Or campo = "cve_municipio5" Then
                        cadena = cadena & "'"
                    End If
                End If
        End If
        x1 = x1 + 1

        Next
cadena = cadena & ")"


        If UCase(campo) = "CVE_INSTITUCION" And UCase(dl) = "DL_INSTITUCION" Then
            If campo = "cve_municipio5" Then
                cadena = "" & Chr(34) & " and substring(cve_localidad_CNBV,4,5) " & " in " & cadena & Chr(34)
            Else
                cadena = "" & Chr(34) & " and " & campo & " in " & cadena & Chr(34)
            End If
        
        Else
            If campo = "cve_municipio5" Then
                cadena = " and substring(cve_localidad_CNBV,4,5) " & " in " & cadena
            Else
                cadena = " and " & campo & " in " & cadena
            End If
        End If

GoTo FIN


Control_Error:

        Select Case Err.Number
        Case 9
            MsgBox "error 9"
        Case 1004
            GoTo FIN

    End Select

FIN:
End Sub
Sub nombrecampo(campocombo3, campocombo4, campo)

campoc1 = "cve_institucion"

If ThisWorkbook.Sheets("BD").Range("C4").Value <> "" Then
    campocombo3 = ThisWorkbook.Sheets("BD").Range("C5").Value
End If

If ThisWorkbook.Sheets("BD").Range("E4").Value <> "" Then
    campocombo4 = ThisWorkbook.Sheets("BD").Range("E5").Value
End If

If ThisWorkbook.Sheets("BD").Range("B13").Value <> "" Then
    campoc2 = ThisWorkbook.Sheets("BD").Range("C5").Value
End If

If ThisWorkbook.Sheets("BD").Range("B14").Value <> "" Then
    campoc3 = ThisWorkbook.Sheets("BD").Range("C5").Value
End If

FIN:
End Sub

Sub obtiene_campo_cadena(linea_de_cadenas, destino)


Select Case destino
    Case "TMONEDAS"
    campo = "cve_moneda"
    campodl = "dl_moneda"

    Case "TCONCEPTOS"
    campo = "cve_concepto"
    campodl = "dl_concepto"

    Case "TESTADOS"
    campo = "cve_estado"
    campodl = "dl_estado"
    
    Case "TMUNICIPIOS"
    
    If Range("Query!B19").Value = 5 Then
        campo = "cve_municipio5"
    Else
        campo = "cve_municipio"
    End If
    
    
    campodl = "dl_municipio"

    Case "TLOCALIDADES"
    campo = "cve_localidad_CNBV"
    campodl = "dl_localidad"

End Select

End Sub
Sub evalua_sp(TR01, SP)

    largo = Len(TR01)
    largo = largo - 4
    idex = Left(TR01, 4)
    SP = Left(TR01, 2)

    If idex = "idex" Then
    SP = True
    GoTo FIN
        Else
    SP = False
    End If
    
    If SP = "sp" Then
    SP = True
    GoTo FIN
        Else
    SP = False
    End If
    
FIN:
End Sub
Sub combos_activos()

    numero_de_combos_activos = 0
    activocombo1 = Range("Query!C4").Value
    If activocombo1 <> "" Then numero_de_combos_activos = numero_de_combos_activos + 1
    
    activocombo2 = Range("Query!E4").Value
    If activocombo2 <> "" Then numero_de_combos_activos = numero_de_combos_activos + 1
    
    activocombo3 = Range("Query!G4").Value
    If activocombo3 <> "" Then numero_de_combos_activos = numero_de_combos_activos + 1
    
    activocombo4 = Range("Query!I4").Value
    If activocombo4 <> "" Then numero_de_combos_activos = numero_de_combos_activos + 1

    cvecombo1 = Range("Query!C6").Value
    cvecombo2 = Range("Query!E6").Value
    cvecombo3 = Range("Query!G6").Value
    cvecombo4 = Range("Query!I6").Value

    cves_de_combos_activos(0, 0) = cvecombo1
    cves_de_combos_activos(1, 0) = cvecombo2
    cves_de_combos_activos(2, 0) = cvecombo3
    cves_de_combos_activos(3, 0) = cvecombo4
    cves_de_combos_activos(0, 1) = activocombo1
    cves_de_combos_activos(1, 1) = activocombo2
    cves_de_combos_activos(2, 1) = activocombo3
    cves_de_combos_activos(3, 1) = activocombo4

End Sub
Sub datos_de_la_hoja_Query()
'VER 4
    If Range("Query!A2").Value = "" Then valor_error = "sin query en r01"
    queryR01 = Range("Query!A2").Value

    querycombo1 = Range("Query!C2").Value
    querycombo2 = Range("Query!E2").Value
    querycombo3 = Range("Query!G2").Value
    querycombo4 = Range("Query!I2").Value
    queryextra1 = Range("Query!K2").Value
    queryextra2 = Range("Query!M2").Value
    queryextra3 = Range("Query!O2").Value
    queryextra4 = Range("Query!Q2").Value
    queryextra5 = Range("Query!S2").Value
    queryextra6 = Range("Query!U2").Value
    
    
    combos_activos
    tiposeleccioncombo1 = Range("Query!C5").Value
    tiposeleccioncombo2 = Range("Query!E5").Value
    tiposeleccioncombo3 = Range("Query!G5").Value
    tiposeleccioncombo4 = Range("Query!I5").Value

    dlcombo1 = Range("Query!C7").Value
    dlcombo2 = Range("Query!E7").Value
    dlcombo3 = Range("Query!G7").Value
    dlcombo4 = Range("Query!I7").Value
    
    EtiquetaCombo1 = Range("Query!C8").Value
    EtiquetaCombo2 = Range("Query!E8").Value
    EtiquetaCombo3 = Range("Query!G8").Value
    EtiquetaCombo4 = Range("Query!I8").Value
    
    listar_combo1en_b = Range("Query!C9").Value
    listar_combo2en_b = Range("Query!E9").Value
    listar_combo3en_b = Range("Query!G9").Value
    listar_combo4en_b = Range("Query!I9").Value
        If listar_combo1en_b <> "" Or listar_combo2en_b <> "" Or listar_combo3en_b <> "" Or listar_combo4en_b <> "" Then
            hay_listado = 1
        Else
            hay_listado = 2
        End If

    ligar_combo2 = Range("Query!E10").Value
    ligar_combo3 = Range("Query!G10").Value
    ligar_combo4 = Range("Query!I10").Value
    
    orden_combo1 = Range("Query!C11").Value
    orden_combo2 = Range("Query!E11").Value
    orden_combo3 = Range("Query!G11").Value
    orden_combo4 = Range("Query!I11").Value
    
    sel_todo_combo1 = Range("Query!C13").Value
    sel_todo_combo2 = Range("Query!E13").Value
    sel_todo_combo3 = Range("Query!G13").Value
    sel_todo_combo4 = Range("Query!I13").Value
    
    monedas_en_combo1 = Range("Query!C16").Value
    monedas_en_combo2 = Range("Query!E16").Value
    monedas_en_combo3 = Range("Query!G16").Value
    monedas_en_combo4 = Range("Query!I16").Value
    
    conceptos_en_combo1 = Range("Query!C17").Value
    conceptos_en_combo2 = Range("Query!E17").Value
    conceptos_en_combo3 = Range("Query!G17").Value
    conceptos_en_combo4 = Range("Query!I17").Value
    
    estados_en_combo1 = Range("Query!C18").Value
    estados_en_combo2 = Range("Query!E18").Value
    estados_en_combo3 = Range("Query!G18").Value
    estados_en_combo4 = Range("Query!I18").Value
    
    municipios_en_combo1 = Range("Query!C19").Value
    municipios_en_combo2 = Range("Query!E19").Value
    municipios_en_combo3 = Range("Query!G19").Value
    municipios_en_combo4 = Range("Query!I19").Value
    
    localidades_en_combo1 = Range("Query!C20").Value
    localidades_en_combo2 = Range("Query!E20").Value
    localidades_en_combo3 = Range("Query!G20").Value
    localidades_en_combo4 = Range("Query!I20").Value
    
    periodos_en_combo1 = Range("Query!C21").Value
    periodos_en_combo2 = Range("Query!E21").Value
    periodos_en_combo3 = Range("Query!G21").Value
    periodos_en_combo4 = Range("Query!I21").Value

    instituciones_en_combo1 = Range("Query!C22").Value
    instituciones_en_combo2 = Range("Query!E22").Value
    instituciones_en_combo3 = Range("Query!G22").Value
    instituciones_en_combo4 = Range("Query!I22").Value
    
    generar_t_monedas = Range("Query!B16").Value
    sector_t_monedas = Range("Query!K16").Value
    sub_reporte_t_monedas = Range("Query!M16").Value
    
    generar_t_conceptos = Range("Query!B17").Value
    sector_t_conceptos = Range("Query!K17").Value
    sub_reporte_t_conceptos = Range("Query!M17").Value
    
    generar_t_estados = Range("Query!B18").Value
    generar_t_municipios = Range("Query!B19").Value
    generar_t_localidades = Range("Query!B20").Value

    listar_tabla_estados = Range("Query!M5").Value
    listar_tabla_municipios = Range("Query!M6").Value
    listar_tabla_instituciones = Range("Query!M7").Value
    listar_tabla_conceptos = Range("Query!M8").Value
    
    If UCase(listar_tabla_estados) = "S" Or UCase(listar_tabla_municipios) = "S" Or UCase(listar_tabla_instituciones) = "S" Or UCase(listar_tabla_conceptos) = "S" Then
        listar_tabla_fija = 1
    End If
   
    If UCase(Range("Query!B28").Value) = "V" Then
'        quitar_columnas = Range("Query!C29").Value
'        quitar_columnas_der = Range("Query!B29").Value
        quitar_columnas = Range("Query!B29").Value
        quitar_columnas_der = Range("Query!C29").Value
    Else
        quitar_columnas = Range("Query!C28").Value
        
    End If

evalua_datos

FIN:

End Sub

Sub evalua_datos()
'VER 4
If querycombo1 <> "" Then
    If periodos_en_combo1 <> "" Or instituciones_en_combo1 <> "" Or monedas_en_combo1 <> "" Or conceptos_en_combo1 <> "" Or estados_en_combo1 <> "" Or municipios_en_combo1 <> "" Or localidades_en_combo1 Then
        valor_error = "mas de 1 elemento para Combo 1"
        GoTo FIN
    End If
End If

If querycombo2 <> "" Then
    If periodos_en_combo2 <> "" Or instituciones_en_combo2 <> "" Or monedas_en_combo2 <> "" Or conceptos_en_combo2 <> "" Or estados_en_combo2 <> "" Or municipios_en_combo2 <> "" Or localidades_en_combo2 Then
        valor_error = "mas de 1 elemento para Combo 2"
        GoTo FIN
    End If
End If
If querycombo3 <> "" Then
    If periodos_en_combo3 <> "" Or instituciones_en_combo3 <> "" Or monedas_en_combo3 <> "" Or conceptos_en_combo3 <> "" Or estados_en_combo3 <> "" Or municipios_en_combo3 <> "" Or localidades_en_combo3 Then
        valor_error = "mas de 1 elemento para Combo 3"
        GoTo FIN
        
    End If
End If
If querycombo4 <> "" Then
    If periodos_en_combo4 <> "" Or instituciones_en_combo4 <> "" Or monedas_en_combo4 <> "" Or conceptos_en_combo4 <> "" Or estados_en_combo4 <> "" Or municipios_en_combo4 <> "" Or localidades_en_combo4 Then
        valor_error = "mas de 1 elemento para Combo 4"
        GoTo FIN
    End If
End If

FIN:

End Sub

Sub arma_query_fijo(destino, query_a_ejecutar, cadena)
'VER 4
sql_fijo = ""

Select Case destino
        Case "TMONEDAS"
        
            sql_fijo = "select cve_moneda, dl_moneda "
            sql_fijo = sql_fijo + " from dbcatalogos..cat_rr_oac_monedas "
            sql_fijo = sql_fijo + " where cve_subreporte = " & sub_reporte_t_monedas
            sql_fijo = sql_fijo + " and cve_tipo_sector_rr = " & sector_t_monedas
            sql_fijo = sql_fijo + " and cve_moneda <> 0 " & cadena
            
            destino = "TMONEDAS"

        Case "TCONCEPTOS"
            sql_fijo = "select distinct cve_concepto,dl_concepto "
            sql_fijo = sql_fijo + "from dbcatalogos..cat_rr_oac_conceptos "
            sql_fijo = sql_fijo + " where cve_subreporte = " & sub_reporte_t_conceptos
            sql_fijo = sql_fijo + " and cve_tipo_sector_rr = " & sector_t_conceptos
            sql_fijo = sql_fijo + " " & cadena
            
            destino = "TCONCEPTOS"
        
        Case "TESTADOS"

            sql_fijo = "select distinct cve_estado,dl_estado, cve_estado estados, null suma "
            sql_fijo = sql_fijo + "from dbcatalogos..cat_localidades_CNBV "
            sql_fijo = sql_fijo + " where cve_localidad_CNBV like '484%' "
            sql_fijo = sql_fijo + " " & cadena
            
            destino = "TESTADOS"

        Case "TMUNICIPIOS"
            sql_fijo = "select distinct cve_municipio,dl_municipio, cve_estado, substring(cve_localidad_CNBV,4,5) cve_municipio5, null suma  "
            sql_fijo = sql_fijo + "from dbcatalogos..cat_localidades_CNBV "
            sql_fijo = sql_fijo + " where cve_localidad_CNBV like '484%' "
            sql_fijo = sql_fijo + " " & cadena
            
            destino = "TMUNIYLOCAL"

        Case "TLOCALIDADES"

            sql_fijo = "select distinct cve_estado,cve_municipio, cve_localidad_CNBV, dl_localidad, null suma  "
            sql_fijo = sql_fijo + "from dbcatalogos..cat_localidades_CNBV "
            sql_fijo = sql_fijo + " where cve_localidad_CNBV <> '' " & cadena
            
            destino = "TLOCALIDADES"

        'MUNICIPIOS Y LOCALIDADES
        Case "TMUNIYLOCAL"
            sql_fijo = "select distinct cve_municipio,dl_municipio, cve_estado, dl_estado, null suma  "
            sql_fijo = sql_fijo + "from dbcatalogos..cat_localidades_CNBV "
            sql_fijo = sql_fijo + " where cve_localidad_CNBV like '484%' "
            sql_fijo = sql_fijo + " " & cadena

            destino = "TMUNIYLOCAL"

        Case "Instituciones"
        
            sql_fijo = "sp_orden_instituciones " & cadena
            destino = "Instituciones"

End Select

query_a_ejecutar = sql_fijo

End Sub
Sub Errores_generales()
'VER 4
Select Case valor_error
            Case "sin query en r01"
                MsgBox "NO HAY QUERY EN R01, NO SE PUEDE CONTINUAR CON EL PROCESO"

            Case "mas de 1 elemento para Combo 1"
                MsgBox "NO SE PUEDEN METER 2 O MAS ELEMENTOS EN EL COMBO 1"
                
            Case "mas de 1 elemento para Combo 2"
                MsgBox "NO SE PUEDEN METER 2 O MAS ELEMENTOS EN EL COMBO 2"
                
            Case "mas de 1 elemento para Combo 3"
                MsgBox "NO SE PUEDEN METER 2 O MAS ELEMENTOS EN EL COMBO 3"
                
            Case "mas de 1 elemento para Combo 4"
                MsgBox "NO SE PUEDEN METER 2 O MAS ELEMENTOS EN EL COMBO 4"
              
            Case "La Tabla no se encontro la Tabla"
                MsgBox "NO SE ENCONTRARON LOS DATOS PARA LA TABLA"

            Case "No se han seleccionado elementos en el combo"
                MsgBox "Por lo menos debe de seleccionar 1 elemento en los combos"
                
            Case "Mas de 250 Columnas a pintar"
                MsgBox "El Resultado con el n|fffd|mero de opciones seleccionadas no se puede mostrar, disminuya el n|fffd|mero de opciones seleccionadas"
                
            Case "Error al Filtrar Instituciones"
                MsgBox "Error al Filtrar el combo de Instituciones / Recuerde no duplicar Instituciones a Filtrar"
                
            Case "NO HAY INFORMACI|fffd|N EN TR01"
                MsgBox "La busqueda en el query R01 no contiene informaci|fffd|n para seguir con el proceso"
            
End Select

End Sub
Sub genera_querys()
'VER 4
num_querys = 18
dato_query = ""

For numero = 1 To num_querys
            cadena = ""
            tipo = ""
            combo = ""
            hacer = 1
            destino_ant = ""
            
    Select Case numero
        Case 1
            destino = "TR01"
            tabla = "TR01"
            dato_query = queryR01
            rangov = "P5"

        Case 2
            destino = "TCombo1"
            tabla = "TCombo1"
            dato_query = querycombo1
            rangov = "P12"
            campo = cvecombo1
            campodl = dlcombo1
            combo = activocombo1
            tipo = Range("Query!C12").Value
            
        Case 3
            destino = "TCombo2"
            tabla = "TCombo2"
            dato_query = querycombo2
            rangov = "P19"
            campo = cvecombo2
            campodl = dlcombo2
            combo = activocombo2
            tipo = Range("Query!E12").Value
            
        Case 4
            destino = "TCombo3"
            tabla = "TCombo3"
            dato_query = querycombo3
            rangov = "P26"
            campo = cvecombo3
            campodl = dlcombo3
            combo = activocombo3
            tipo = Range("Query!G12").Value
            
        Case 5
            destino = "TCombo4"
            tabla = "TCombo4"
            dato_query = querycombo4
            rangov = "P33"
            campo = cvecombo4
            campodl = dlcombo4
            combo = activocombo4
            tipo = Range("Query!I12").Value
            
        Case 6
            destino = "QExtra1"
            tabla = "QExtra1"
            dato_query = queryextra1
            rangov = "P40"
        
        Case 7
            destino = "QExtra2"
            tabla = "QExtra2"
            dato_query = queryextra2
            rangov = "P47"

        Case 8

    'MANDAR DESTINO PARA ARMAR EL QUERY NECESARIO
        Case 9
            campo = "cve_institucion"
            campodl = "dl_institucion"
            tipo = "alfanumerico"
            destino = "Instituciones"
            If Range("Query!B22").Value = "" And Range("Query!C22").Value = "" And Range("Query!E22").Value = "" And Range("Query!G22").Value = "" And Range("Query!I22").Value = "" Then GoTo FIN

        'CONSIDERAR SECTOR Y SUB REPORTE
        Case 10
            tabla = "TR01"
            destino = "TMONEDAS"
            campodl = "dl_moneda"
            campo = "cve_moneda"
            If Range("Query!B16").Value = "" And Range("Query!C16").Value = "" And Range("Query!E16").Value = "" And Range("Query!G16").Value = "" And Range("Query!I16").Value = "" Then GoTo FIN
            destino_ant = destino
                If Range("Query!C16").Value <> "" Then destino = "TCombo1" Else
                    If Range("Query!E16").Value <> "" Then destino = "TCombo2" Else
                        If Range("Query!G16").Value <> "" Then destino = "TCombo3" Else
                            If Range("Query!I16").Value <> "" Then
                                destino = "TCombo4"
                End If

        'CONSIDERAR SECTOR Y SUB REPORTE
        Case 11
            tabla = "TR01"
            destino = "TCONCEPTOS"
            campo = "cve_concepto"
            campodl = "dl_concepto"
            If Range("Query!B17").Value = "" And Range("Query!C17").Value = "" And Range("Query!E17").Value = "" And Range("Query!G17").Value = "" And Range("Query!I17").Value = "" Then GoTo FIN
                destino_ant = destino
                If Range("Query!C17").Value <> "" Then destino = "TCombo1" Else
                    If Range("Query!E17").Value <> "" Then destino = "TCombo2" Else
                        If Range("Query!G17").Value <> "" Then destino = "TCombo3" Else
                            If Range("Query!I17").Value <> "" Then
                                destino = "TCombo4"
                End If


        'REVISAR
        Case 12
            tabla = "TR01"
            destino = "TESTADOS"
            campo = "cve_estado"
            campodl = "dl_estado"
            If Range("Query!B18").Value = "" And Range("Query!C18").Value = "" And Range("Query!E18").Value = "" And Range("Query!G18").Value = "" And Range("Query!I18").Value = "" Then GoTo FIN
                destino_ant = destino
                If Range("Query!C18").Value <> "" Then destino = "TCombo1" Else
                    If Range("Query!E18").Value <> "" Then destino = "TCombo2" Else
                        If Range("Query!G18").Value <> "" Then destino = "TCombo3" Else
                            If Range("Query!I18").Value <> "" Then
                                destino = "TCombo4"
                End If


        'REVISAR
        Case 13
            tabla = "TR01"
            destino = "TMUNICIPIOS"
            
            If Range("Query!B19").Value = 5 Then
                campo = "cve_municipio5"
            Else
                campo = "cve_municipio"
            End If
            campodl = "dl_municipio"
            If Range("Query!B19").Value = "" And Range("Query!C19").Value = "" And Range("Query!E19").Value = "" And Range("Query!G19").Value = "" And Range("Query!I19").Value = "" Then GoTo FIN
                destino_ant = destino
                If Range("Query!C19").Value <> "" Then destino = "TCombo1" Else
                    If Range("Query!E19").Value <> "" Then destino = "TCombo2" Else
                        If Range("Query!G19").Value <> "" Then destino = "TCombo3" Else
                            If Range("Query!I19").Value <> "" Then
                                destino = "TCombo4"
                End If


        'REVISAR
        Case 14
            tabla = "TR01"
            destino = "TLOCALIDADES"
            campo = "cve_localidad"
            campodl = "dl_localidad"
            If Range("Query!B20").Value = "" And Range("Query!C20").Value = "" And Range("Query!E20").Value = "" And Range("Query!G20").Value = "" And Range("Query!I20").Value = "" Then GoTo FIN
                destino_ant = destino
                If Range("Query!C20").Value <> "" Then destino = "TCombo1" Else
                    If Range("Query!E20").Value <> "" Then destino = "TCombo2" Else
                        If Range("Query!G20").Value <> "" Then destino = "TCombo3" Else
                            If Range("Query!I20").Value <> "" Then
                                destino = "TCombo4"
                End If

        Case 15
            destino = "QExtra3"
            tabla = "QExtra3"
            dato_query = queryextra3
            rangov = "P54"

        Case 16
            destino = "QExtra4"
            tabla = "QExtra4"
            dato_query = queryextra4
            rangov = "P61"

        Case 17
            destino = "QExtra5"
            tabla = "QExtra5"
            dato_query = queryextra5
            rangov = "P68"
            
        Case 18
            destino = "QExtra6"
            tabla = "QExtra6"
            dato_query = queryextra6
            rangov = "P75"

    End Select

        If destino_ant <> "" Then
            destino_final = destino
            destino = destino_ant
        End If


If numero <> 1 And numero <> 6 And numero <> 7 And numero <> 15 And numero <> 16 And numero <> 17 And numero <> 18 Then

        Call CADENAS("TR01", cadena, campo, tipo, campodl)

        Call arma_query_fijo(destino, query_a_ejecutar, cadena)
        
        If numero > 8 Then
            dato_query = query_a_ejecutar
        End If
        tabla = "TR01"
End If

If dato_query <> "" Then

        If numero = 2 Or numero = 3 Or numero = 4 Or numero = 5 Then
            dato_query = "" & dato_query & cadena
            If combo = "" Then
                hacer = 2
            End If
        End If
        
        If hacer = 1 Then
        
        If destino_ant <> "" Then
            destino = destino_final
        End If
        
                Call lugar_de_cadena(destino, rangodatos)
                Call query(dato_query, "BD", cadena, destino, rangodatos)
    
                If numero < 8 Or numero > 14 Then
                    Call Formato_Tabla_R01(rangov, destino)
'                        If destino = "TR01" Then
'                            rangotabla1 = ThisWorkbook.Sheets("BD").PivotTables("TR01").TableRange1
'                            renglones1 = UBound(rangotabla1)
'                            If renglones1 = 3 Then
'                                valor_error = "NO HAY INFORMACI|fffd|N EN TR01"
'                                        Sheets("minfo").Select
'                                            borra_hasta ("B9")
'                                            Range("MINFO!a2").Value = "Al realizar la consulta de la base Institucional, no se obtuvo informaci|fffd|n"
'                                                Range("MINFO!C10").Value = "Al realizar la consulta de la base Institucional, no se obtuvo informaci|fffd|n"
'                                                Range("MINFO!C10").Font.Size = 14
'                                            Call ultimafechaactualizacion(1, 0)
'                                                Bloquea
'
'                                Exit For
'                            End If
'                        End If
                Else
                If numero > 8 Then
                    Call acomodar_tablas_fijas(destino, campo, campodl)
                End If
                End If
        End If
        
End If

FIN:

    dato_query = ""

Next

End Sub
Sub acomodar_tablas_fijas(destino, campo, campodl)
'VER 4

    If destino = "Instituciones" Then
    
        With ThisWorkbook.Sheets("BD").PivotTables(destino)
            .NullString = "0"
            .ColumnGrand = False
            .RowGrand = False
            .PivotFields("cve_institucion").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
            .PivotFields("dl_institucion").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
            .PivotFields("id").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
            .AddFields RowFields:=Array("id", "dl_institucion", "cve_institucion", "tipo")
        ActiveSheet.PivotTables(destino).AddDataField ActiveSheet.PivotTables( _
            destino).PivotFields("Expr"), "Suma de Expr", xlSum
        End With

    Else
    
        If destino_ant = "TESTADOS" Or destino_ant = "TMUNICIPIOS" Or destino_ant = "TLOCALIDADES" Then

        If destino_ant <> "" Then
            destino = destino_final
        End If

    
            With ThisWorkbook.Sheets("BD").PivotTables(destino)
                    .NullString = "0"
                    .ColumnGrand = False
                    .RowGrand = False
                    .PivotFields("cve_estado").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
                    
                        If destino_ant = "TMUNICIPIOS" Then
                            If Range("Query!B19").Value = 5 Then
                                .PivotFields("cve_municipio5").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
                            Else
                                .PivotFields("cve_municipio").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
                            End If
                            .PivotFields("dl_municipio").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
                            If Range("Query!B19").Value = 5 Then
                                .AddFields RowFields:=Array("dl_municipio", "cve_municipio5"), PageFields:=Array("cve_estado")
                            Else
                                .AddFields RowFields:=Array("dl_municipio", "cve_municipio"), PageFields:=Array("cve_estado")
                            End If
                       
                        Else
                        If destino_ant = "TLOCALIDADES" Then
                            If Range("Query!B19").Value = 5 Then
                                .PivotFields("cve_municipio5").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
                            Else
                                .PivotFields("cve_municipio").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
                            End If
                            .PivotFields("cve_localidad").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
                            .PivotFields("dl_localidad").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
                            If Range("Query!B19").Value = 5 Then
                                .AddFields RowFields:=Array("dl_localidad"), PageFields:=Array("cve_estado", "cve_municipio5", "cve_localidad")
                            Else
                                .AddFields RowFields:=Array("dl_localidad"), PageFields:=Array("cve_estado", "cve_municipio", "cve_localidad")
                            End If
                            
                        Else
                        If destino_ant = "TESTADOS" Then
                            .PivotFields("dl_estado").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
                            .PivotFields("cve_estado").Subtotals = Array(False, False, False, False, False, False, False, False, False, False, False, False)
                            .AddFields RowFields:=Array("dl_estado", "estados"), PageFields:=Array("cve_estado")
                            
                        End If
                        End If
                        End If
                        
                    ActiveSheet.PivotTables(destino).AddDataField ActiveSheet.PivotTables( _
                        destino).PivotFields("suma"), "Suma de suma", xlSum

                    ActiveSheet.PivotTables(destino).ColumnGrand = False
            End With

    Else
        
    If destino_ant = "TMONEDAS" Then
        If destino_ant <> "" Then
            destino = destino_final
        End If
    
        campo = "cve_moneda"
        campodl = "dl_moneda"
    Else
    If destino_ant = "TCONCEPTOS" Then
        If destino_ant <> "" Then
            destino = destino_final
        End If

        campo = "cve_concepto"
        campodl = "dl_concepto"
    Else
        valor_error = "La Tabla no se encontro"
    End If
    End If
    
        With ActiveSheet.PivotTables(destino).PivotFields(campodl)
                    .Orientation = xlRowField
                    .Position = 1
        End With

                ActiveSheet.PivotTables(destino).AddDataField ActiveSheet.PivotTables( _
                    destino).PivotFields(campo), "Suma de Campo", xlSum
                    
        With ActiveSheet.PivotTables(destino).PivotFields(campo)
                    .Orientation = xlPageField
                    .Position = 1
        End With

        ActiveSheet.PivotTables(destino).ColumnGrand = False
        
    End If
    End If

        With ActiveSheet.PivotTables(destino)
            .InGridDropZones = True
            .RowAxisLayout xlTabularRow
        End With

End Sub
Sub query(TR01, hoja, cadena, destino, rangodatos)
'VER 4

Call lee(st_linea, db_donde, numero_de_lineas)

Set MiConexion = New ADODB.Connection

MiConexion.ConnectionString = "" & db_donde
MiConexion.Open
MiConexion.CommandTimeout = 0

'Range("f20").Value = TR01
Set miTR01 = MiConexion.Execute(TR01)

        Set objPivotCache = ActiveWorkbook.PivotCaches.Create(SourceType:=xlExternal, Version:=xlPivotTableVersion12)
        Set objPivotCache.Recordset = miTR01

        With objPivotCache
            .CreatePivotTable TableDestination:=Range(rangodatos), _
                TableName:=destino
        End With

miTR01.Close

End Sub
Sub Formato_Tabla_R01(rangov, tabla)
'VER 4
Dim hojav

Windows(estelibro).Activate
    ActiveWorkbook.Sheets("Query").Activate

Range(rangov).Select

Call cuenta_lugares(rangov, posiciones1, 1)

der = posiciones1
aba = 4

der_tabla = der - 1
aba_tabla = aba - 1

ReDim formato_tabla(aba_tabla, der_tabla)


For Y = 0 To aba - 1
    For X = 0 To der - 1
        If ActiveCell.Offset(Y, X).Value <> "" Then
            Var = ActiveCell.Offset(Y, X).Value
            Var = LTrim(Var)
            Var = RTrim(Var)
            formato_tabla(Y, X) = Var
        Else
        
            formato_tabla(Y, X) = "SD"
        End If
             If formato_tabla(Y, X) <> "" Then
                 celda = ActiveCell.Offset(Y, X).Address
             End If
    Next
        a = formato_tabla
Next

Call acomdaR01(tabla)

    If Regresar = 1 Then
        ActiveWorkbook.Unprotect (dgaex)
        Sheets("Query").Visible = False
        ActiveWorkbook.Protect (dgaex), Structure:=True
    End If

End Sub

Sub lugar_de_cadena(destino, rangodatos)
'VER 4
    If destino = "TR01" Then
                rangodatos = "G1"
    Else
    If destino = "Instituciones" Then
                rangodatos = "A13"
                
    Else

    Dim h(7)
    h(0) = "BB1"
    h(1) = "CC1"
    h(2) = "DD1"
    h(3) = "EE1"
    h(4) = "FF1"
    h(5) = "GG1"
    h(6) = "HH1"
    h(7) = "II1"

    Dim hh(7)
    hh(0) = "BC2"
    hh(1) = "CD2"
    hh(2) = "DE2"
    hh(3) = "EF2"
    hh(4) = "FG2"
    hh(5) = "GH2"
    hh(6) = "HI2"
    hh(7) = "IJ2"
    
    Dim hg(7)
    hg(0) = "BB3"
    hg(1) = "CC3"
    hg(2) = "DD3"
    hg(3) = "EE3"
    hg(4) = "FF3"
    hg(5) = "GG3"
    hg(6) = "HH3"
    hg(7) = "II3"
    
    p = 0
    salir = False
    
    Do Until salir = True
        If ThisWorkbook.Sheets("BD").Range(h(p)).Value <> "" Or ThisWorkbook.Sheets("BD").Range(hh(p)).Value <> "" Or ThisWorkbook.Sheets("BD").Range(hg(p)).Value <> "" Then
            p = p + 1
        Else
            salir = True
        End If
            rangodatos = h(p)
    Loop
    
    End If
    End If

End Sub


Sub municipiosenCombo(valor1, valor2)

    Sheets("BD").Select

    If Sheets("Query").Range("F4").Value <> "" Then

            Range(ActiveCell.Address).Select
            rangotabla1 = ActiveSheet.PivotTables("TCombo3").TableRange1
            renglones1 = UBound(rangotabla1)
        
        Set combox = ThisWorkbook.Sheets(hojaprincipal).ListBoxCombo4
        combox.Clear
        
        Set pvttable = Worksheets("BD").PivotTables("TCombo3")

For i = 3 To renglones1 - 1
            combox.AddItem rangotabla1(i, 1)
Next
    End If

End Sub
Sub lista_municipios(cve_estado)
    Set pvttable = ThisWorkbook.Sheets("BD").PivotTables("TMunicipios")

      pvttable.PivotFields("cve_estado").CurrentPage = cve_estado

    rangotabla = pvttable.TableRange1
    renglones = UBound(rangotabla)
    
    j = 0
    ReDim arreglo(renglones - 4, 1)
    ThisWorkbook.Sheets(hojaprincipal).Select
    Range(posicion).Select
    Range(Selection.End(xlDown), Selection.End(xlToRight)).Clear
    
    For i = 3 To renglones
        Selection.Offset(i - 3, 0) = rangotabla(i, 2)
        Selection.Offset(i - 3, 1) = rangotabla(i, 1)
        j = j + 1
    Next

        Selection.Offset(i - 3, 0) = "Total general"
        Selection.Offset(i - 3, 1) = "Totales"

End Sub

Sub lista_estados()

    Set pvttable = ThisWorkbook.Sheets("BD").PivotTables("TEstados")

    rangotabla = pvttable.TableRange1
    renglones = UBound(rangotabla)
    
    j = 0
    ReDim arreglo(renglones - 4, 1)
    ThisWorkbook.Sheets(hojaprincipal).Select
    Range(posicion).Select
    Range(Selection.End(xlDown), Selection.End(xlToRight)).Clear
    
    For i = 3 To renglones - 1
        Selection.Offset(i - 3, 0) = rangotabla(i, 2)
        Selection.Offset(i - 3, 1) = rangotabla(i, 1)
        j = j + 1
    Next

End Sub
Sub listados_en_B(arreglo_B)

    Set pvttable = ThisWorkbook.Sheets("BD").PivotTables("TEstados")

    rangotabla = pvttable.TableRange1
    renglones = UBound(rangotabla)
    
    j = 0
    ReDim arreglo(renglones - 4, 1)
    ThisWorkbook.Sheets(hojaprincipal).Select
    Range(posicion).Select
    Range(Selection.End(xlDown), Selection.End(xlToRight)).Clear
    
    For i = 3 To renglones - 1
        Selection.Offset(i - 3, 0) = rangotabla(i, 2)
        Selection.Offset(i - 3, 1) = rangotabla(i, 1)
        j = j + 1
    Next

End Sub

Sub listadolocalidades()
'*****************************************
    ' PARA LLENAR COMBO 4 CON MUNICIPIOS
    If Sheets("Query").Range("F5").Value <> "" Then
    
    Set lb3 = ThisWorkbook.Sheets(hojaprincipal).ListBoxCombo3
    Set lb4 = ThisWorkbook.Sheets(hojaprincipal).ListBoxCombo4
    
    Call muevetablaestados
    
'para saber que Municipio selecciono
    Y = 0
    For x1 = 0 To lb4.ListCount - 1
        If lb4.Selected(x1) = True Then
            valor2 = lb4.List(x1)

            Exit For
        End If
    Next
    
'para saber que Estado selecciono
    Y = 0
    For x1 = 0 To lb3.ListCount - 1
        If lb3.Selected(x1) = True Then
            valor1 = lb3.List(x1)

            Exit For
        End If
    Next

    End If
'*****************************************

End Sub


Attribute VB_Name = "Extras"
Sub inicializa()
    inicializando = "SI"
    inicio = "A9"
    renglon_inicio = Range(inicio).Row
    a = renglon_inicio
    hojaprincipal = Sheets(1).Name
    estelibro = ThisWorkbook.Name

    columna_inicial = ThisWorkbook.Sheets("Query").Range("B26").Value
    hoja_actual = ThisWorkbook.ActiveSheet.Name

    'Revisa el n|fffd|mero de columnas y lineas en la hoja de Formato
        ThisWorkbook.Sheets("Formato").Activate
            Call maxima_columna_en_10_lineas(max, renglones_encabezado)
            
    renglones_avanza = 0
    posibilidades_en_encabezado = 9
        ReDim datos_en_encabezado(posibilidades_en_encabezado)
        ReDim cual_cve_encabezado(4)
        cves_encabezado = 0

    Sheets("Formato").Activate

    Do Until ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 0).Value = "" And ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 1).Value = "" And ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 2).Value = "" And ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 3).Value = "" And ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 4).Value = "" And ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 5).Value = "" And ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 6).Value = "" And ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 7).Value = "" And ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 8).Value = "" And ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 9).Value = "" And ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 10).Value = ""
        datos_en_encabezado(renglones_avanza) = ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 0).Value

                    linea_cve = Left(datos_en_encabezado(renglones_avanza), 3)
                    

                        If linea_cve = "cve" Then
                            cves_encabezado = cves_encabezado + 1
                            cve_del_combo(renglones_avanza, 0) = datos_en_encabezado(renglones_avanza)
                            cve_del_combo(renglones_avanza, 1) = "p" ' Pintar
                            
                            Call sacar_arreglo_de_datos_en_combo(numero_de_datos_en_combos)
                            
                            For pe = 0 To 3
                                If numero_de_datos_en_combos(pe, 0) = cve_del_combo(renglones_avanza, 0) Then
                                    numero_de_datos_en_combos(pe, 2) = p
                                End If
                            Next
                        Else
                                   revisando_valor = ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, num_columnas).Address
                                   num_columnas_encabezado = Right(revisando_valor, 1)
                        End If
        renglones_avanza = renglones_avanza + 1
    Loop
            
            
            
                If renglones_encabezado <= cves_encabezado Then
                    renglones_encabezado = renglones_avanza
                End If

        columnas_encabezado = max
        ReDim formatocol(columnas_encabezado, 3)

        celda = "A" & cves_encabezado + 1
        celda_cols = "A" & cves_encabezado + 1 + 40
    ThisWorkbook.Sheets("Formato").Range(celda).Offset(0, 0).Select
    
        salir = 0
        der = 0
        abajo = 0
        Der1 = 1
        
    ThisWorkbook.Sheets("Formato").Range(celda).Offset(0, der).Select
    
    Do Until vamonos
        Do Until salir = 2
            'CDCS
            'If ThisWorkbook.Sheets("Formato").Range(celda).Offset(abajo, der).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda).Offset(abajo, der + 1).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda).Offset(abajo, der + 2).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda).Offset(abajo, der + 3).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda).Offset(abajo, der + 4).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda).Offset(abajo, der + 5).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda).Offset(abajo, der + 6).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda).Offset(abajo, der + 7).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda).Offset(abajo, der + 8).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda).Offset(abajo, der + 9).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda).Offset(abajo, der + 10).Value = "" Then
            If ThisWorkbook.Sheets("Formato").Range(celda_cols).Offset(-40 + abajo, der).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda_cols).Offset(-40 + abajo, der + 1).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda_cols).Offset(-40 + abajo, der + 2).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda_cols).Offset(-40 + abajo, der + 3).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda_cols).Offset(-40 + abajo, der + 4).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda_cols).Offset(-40 + abajo, der + 5).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda_cols).Offset(-40 + abajo, der + 6).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda_cols).Offset(-40 + abajo, der + 7).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda_cols).Offset(-40 + abajo, der + 8).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda_cols).Offset(-40 + _
abajo, der + 9).Value = "" And ThisWorkbook.Sheets("Formato").Range(celda_cols).Offset(-40 + abajo, der + 10).Value = "" Then
                salir = salir + 1
            Else
                der = der + 1
            End If
        Loop
        
        If der > Der1 Then
            Der1 = der
        End If
        der = 0
        
        If ThisWorkbook.Sheets("Formato").Range(celda).Offset(abajo + 1, der).Value = "" Then
            vamonos = True
        Else
            abajo = abajo + 1
            salir = 0
        End If
    Loop

        ReDim datos_de_columnas_en_encabezado(abajo, Der1 - 1)

        For X = 0 To abajo
            For Y = 0 To Der1 - 1
                
                datos_de_columnas_en_encabezado(X, Y) = ThisWorkbook.Sheets("Formato").Range(celda).Offset(X, Y).Value
            Next
        Next
        
        num_columnas_encabezado = Der1
    Sheets(hojaprincipal).Activate

    renglones_datos = 0

    Do Until ThisWorkbook.Sheets(hojaprincipal).Cells((renglon_inicio + renglones_datos + renglones_encabezado), 2).Value = ""
        renglones_datos = renglones_datos + 1
    Loop

    datos_de_la_hoja_Query

    If hay_listado = 1 Then
        posicion = ThisWorkbook.Sheets(hojaprincipal).Cells(renglon_inicio + renglones_encabezado - 1, 1).Address
    Else
        posicion = ThisWorkbook.Sheets(hojaprincipal).Cells(renglon_inicio + renglones_encabezado, 1).Address
    End If


    If UCase(activocombo1) <> "S" And UCase(activocombo2) <> "S" And UCase(activocombo3) <> "S" And UCase(activocombo4) <> "S" Then
        'Sin Combos
    Else
        combo1 = ThisWorkbook.Sheets(hojaprincipal).ListBoxCombo1.ListCount
        vnumcombo1 = ThisWorkbook.Sheets(hojaprincipal).ListBoxCombo1.ListCount
        vnumcombo2 = ThisWorkbook.Sheets(hojaprincipal).ListBoxCombo2.ListCount
        vnumcombo3 = ThisWorkbook.Sheets(hojaprincipal).ListBoxCombo3.ListCount
        vnumcombo4 = ThisWorkbook.Sheets(hojaprincipal).ListBoxCombo4.ListCount
    
        ReDim arrCombo1(vnumcombo1, 1)
        ReDim arrCombo2(vnumcombo2, 1)
        ReDim arrCombo3(vnumcombo3, 1)
        ReDim arrCombo4(vnumcombo4, 1)
    
        limitar_periodos = UCase(ThisWorkbook.Sheets("BD").Range("B1").Value)
        periodol = "" & Range("BD!B2")
        periodoantl = "" & Range("BD!B3")
        excluir_virtuales = UCase(ThisWorkbook.Sheets("BD").Range("B5").Value)
        incluir_sofomes = UCase(ThisWorkbook.Sheets("BD").Range("B4").Value)
    
        QuitarInstituciones = ThisWorkbook.Sheets("Query").Range("K25").Value
            Call formatocolumnas(formatocol, renglones_encabezado)
        posicion_h = posicion
    End If

End Sub

Sub llena_combo(cb, valor)
'Esta sub se usa para seleccion Total en los combos
    Call define_combo(cb, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)

        ant = Estado_actual
        Estado_actual = 1

    For x1 = 0 To combo.ListCount - 1

            If valor = 1 Then
                combo.Selected(x1) = True
                    Else
                    If valor = 2 Then
                        combo.Selected(x1) = False
                    End If
            End If
    Next
    
    tamcombo
    
        Estado_actual = ant
End Sub

Sub limpia_combos()
llenar = True
ant = Estado_actual
Estado_actual = 1
For X = 1 To numero_de_combos_activos

    Call define_combo(X, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)

    For x1 = 0 To combo.ListCount - 1
        If x1 = 0 Then
                Combos_Llenos = False
            combo.Selected(0) = False
                Combos_Llenos = True
            combo.Selected(0) = True
                valorCombo = combo.List(0, 1)
        Else
            combo.Selected(x1) = False
        End If
    Next
Next
Estado_actual = ant
End Sub
Sub Bloquea()

On Error Resume Next

    If Sheets("Query").Visible = True Then Sheets("Query").Visible = False
    If Sheets("Notas T").Visible = True Then Sheets("Notas T").Visible = False
    If Sheets("Formato").Visible = True Then Sheets("Formato").Visible = False
    ActiveWorkbook.Protect (dgaex), Structure:=True
    Sheets("MINFO").Select
    
On Error GoTo 0

End Sub
Sub desBloquea()

On Error Resume Next

    ActiveWorkbook.Unprotect (dgaex)
        If Sheets("Query").Visible = False Then Sheets("Query").Visible = True
        If Sheets("Notas T").Visible = False Then Sheets("Notas T").Visible = True
        If Sheets("Formato").Visible = False Then Sheets("Formato").Visible = True
    Sheets("Query").Select
    
On Error GoTo 0

End Sub

Sub define_combo(combo_a_usar, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)

Select Case combo_a_usar
        Case 1
            If activocombo1 <> "" Then
                Set combo = ThisWorkbook.Sheets(hojaprincipal).ListBoxCombo1
                arreglo = arrCombo1
                cvecombo = cvecombo1
                elementos_en_combo = numero_de_datos_en_combo1
                activo = activocombo1
                seleccionar = sel_todo_combo1
                listar = listar_combo1en_b

            End If
        Case 2
            If activocombo2 <> "" Then
                Set combo = ThisWorkbook.Sheets(hojaprincipal).ListBoxCombo2
                arreglo = arrCombo2
                cvecombo = cvecombo2
                elementos_en_combo = numero_de_datos_en_combo2
                activo = activocombo2
                seleccionar = sel_todo_combo2
                listar = listar_combo2en_b

                
            End If
        Case 3
            If activocombo3 <> "" Then
                Set combo = ThisWorkbook.Sheets(hojaprincipal).ListBoxCombo3
                arreglo = arrCombo3
                cvecombo = cvecombo3
                elementos_en_combo = numero_de_datos_en_combo3
                activo = activocombo3
                seleccionar = sel_todo_combo3
                listar = listar_combo3en_b

            End If
        Case 4
            If activocombo4 <> "" Then
                Set combo = ThisWorkbook.Sheets(hojaprincipal).ListBoxCombo4
                arreglo = arrCombo4
                cvecombo = cvecombo4
                elementos_en_combo = numero_de_datos_en_combo4
                activo = activocombo4
                seleccionar = sel_todo_combo4
                listar = listar_combo4en_b
            End If
End Select

End Sub

Sub Seguridadact()

Call lee(st_linea, db_donde, numero_de_lineas)

If st_linea <> "" Then
    Call Actualiza_TD
End If

End Sub
Function obtiene_dato_relativo(institucion, periodo_inicio, periodo_fin, cve_concepto) As Double

x1 = 0
    
    Set pvttable = Sheets("BD").PivotTables("R01")
    valor2 = pvttable.PivotFields("cve_institucion").CurrentPage.Value
    valor3 = pvttable.PivotFields("cve_periodo").CurrentPage.Value
    
    pvttable.AddFields RowFields:=Array("cve_periodo"), PageFields:=Array("cve_concepto", "cve_institucion") ', "cve_moneda")

    pvttable.PivotFields("cve_institucion").CurrentPage = institucion
    pvttable.PivotFields("cve_concepto").CurrentPage = cve_concepto
    
    For Each pvtitem In pvttable.PivotFields("cve_periodo").PivotItems
      
        If ((pvtitem >= periodo_inicio) And (pvtitem <= periodo_fin)) Then
           Range("BD!gg1000").FormulaR1C1 = "=GetPivotData(""dat_importe"",R5C5, ""cve_periodo""," & pvtitem & ")"
           
           On Error Resume Next
              Monto = Monto + Range("BD!gg1000").Value
        End If
        x1 = x1 + 1
        If pvtitem < periodo_inicio Then Exit For
    Next

obtiene_dato_relativo = Monto

    Sheets("BD").PivotTables("R01").AddFields RowFields:=Array("cve_concepto"), PageFields:=Array("cve_periodo", "cve_institucion") ', "cve_moneda")
    Sheets("BD").PivotTables("R01").PivotFields("cve_institucion").CurrentPage = valor2
    Sheets("BD").PivotTables("R01").PivotFields("cve_periodo").CurrentPage = valor3
    Range("gg1000").Delete
End Function
Sub BuscaPeriodo(periodo)

    existePerR1 = False

    Set pvttable = Worksheets("BD").Range("E2").PivotTable
    
    For Each pvtitem In pvttable.PivotFields("cve_periodo").PivotItems
        If pvtitem.Name = periodo Then
            existePerR1 = True
            Exit For
        End If
    Next

End Sub
Sub BuscaInsti(institucion)

    existeR1 = False
    
    Set pvttable = Worksheets("BD").PivotTables("R01")
    
    For Each pvtitem In pvttable.PivotFields("cve_institucion").PivotItems
        If pvtitem.Name = institucion Then
            existeR1 = True
            Exit For
        End If
    Next

End Sub

Sub BuscaNomInsti(institucion)

    For X = 3 To rengInsti
        If institucion = rangoInsti(X, 1) Then
            nominsti = rangoInsti(X, 2)
            Exit For
        End If
    Next X
    
End Sub

Sub acom_fecha()
    ActiveSheet.Shapes("fechaactualizacion").Select
    Selection.ShapeRange.ScaleWidth 1, msoFalse, msoScaleFromTopLeft
    Selection.ShapeRange.LockAspectRatio = msoFalse
    Selection.ShapeRange.Top = 10
    Selection.ShapeRange.Left = 710
    Selection.ShapeRange.Height = 30
    Selection.ShapeRange.Width = 120
End Sub
Sub acomoda_5_lineas(hoja, lineas)
    ThisWorkbook.Sheets(hoja).Rows("1:1").RowHeight = (lineas)
    ThisWorkbook.Sheets(hoja).Rows("2:2").RowHeight = lineas
    ThisWorkbook.Sheets(hoja).Rows("3:3").RowHeight = lineas
    ThisWorkbook.Sheets(hoja).Rows("4:4").RowHeight = lineas
    ThisWorkbook.Sheets(hoja).Rows("5:5").RowHeight = (lineas + 77)
End Sub

Sub acomoda_logo(hoja, logo)

    Hojas1 = ActiveSheet.Name
    Sheets(hoja).Activate

    ActiveSheet.Shapes(logo).Select
    Selection.ShapeRange.ScaleWidth 1, msoFalse, msoScaleFromTopLeft
    Selection.ShapeRange.Height = 153
    Selection.ShapeRange.Width = 920
    Selection.ShapeRange.Top = 0
    Selection.ShapeRange.Left = 1

    Sheets(Hojas1).Activate
    Range("B200").Select
    
End Sub
Sub acomoda_etiqueta_encabezado(hoja, aladerechae, alturae, anchoe)

    Hojas1 = ActiveSheet.Name
    Sheets(hoja).Activate
    
    Call acomoda_forma(hoja, "sector", alturae, anchoe, 1, aladerechae)
        Range("B200").Select
    
    'ETIQUETA SERIE
    Call acomoda_forma(hoja, "serie", alturae, anchoe, 20, aladerechae)
        Range("B200").Select
    
    'ETIQUETA SUBSERIE
    Call acomoda_forma(hoja, "subserie", alturae, anchoe, 35, aladerechae)
        Range("B200").Select
    
    'ETIQUETA REPORTE
    Call acomoda_forma(hoja, "reporte", alturae + 10, anchoe, 50, aladerechae)
        Range("B200").Select

            If hoja = "Notas" Then
                'Nota de Regresar
                Call acomoda_forma(hoja, "Regresar", alturae - 10, 80, 130, 1)
                    Range("B6").Select
                'Nota del T|fffd|tulo de Notas
                Call acomoda_forma(hoja, "TituloNotas", alturae - 10, 80, 105, aladerechae + aladerechae + 20)
                    Range("B6").Select
            Else
                Range("B200").Select
            End If

    Sheets(Hojas1).Activate
    

End Sub


Sub tamcombo()
'Tama|fffd|o de los Combos
'inicializa
    Sheets(hojaprincipal).Activate
'ActiveWindow.FreezePanes = False
    
On Error Resume Next

    'Filtro
    If Range("BD!B1").Value <> "" Or Range("BD!B4").Value <> "" Or Range("BD!B5").Value <> "" Or Range("Query!K25").Value <> "" Then
        ActiveSheet.Shapes("Filtro").Visible = True
            Call acomoda_forma(hojaprincipal, "Filtro", 16, 19, 15, 710 + 125)
    Else
        ActiveSheet.Shapes("Filtro").Visible = False
    End If

    Call acomoda_logo(hojaprincipal, "Logo")
    Call acomoda_logo("Notas", "LogoNotas")
    
    'ENCABEZADO
        alturae = 30
        anchoe = 570
        aladerechae = 220
        haciaabajo = 69 + 16
        lineas = 15
    'MEDIDAS COMBOS
        hacia_abajo_combo = 87.75 + 16
        altura = 44
        ancho = 170
    'MEDIDAS ETIQUETAS
        alturan = 15
        anchon = 165

    Call acomoda_5_lineas(hojaprincipal, lineas)
    Call acomoda_5_lineas("Notas", lineas)
    '**********
    Call acomoda_etiqueta_encabezado(hojaprincipal, aladerechae, alturae, anchoe)
    Call acomoda_etiqueta_encabezado("Notas", aladerechae, alturae, anchoe)
    
    'BOTON ACEPTAR
    Call acomoda_forma(hojaprincipal, "cmd_Aceptar", altura, (ancho - 102.25), hacia_abajo_combo, 10)
        Range("B200").Select

    'Acomoda la Etiqueta de la Fecha de Actualizaci|fffd|n
    acom_fecha

    If activocombo1 <> "" Then
        'COMBO1
        ActiveSheet.Shapes("ListBoxCombo1").Select
        Selection.ShapeRange.LockAspectRatio = msoFalse
        Selection.ShapeRange.Height = 300
        Selection.ShapeRange.Width = 300
        
        Call acomoda_forma(hojaprincipal, "ListBoxCombo1", altura, ancho, hacia_abajo_combo, 90)
            Range("B200").Select
            'ETIQUETA COMBO 1
            Call acomoda_forma(hojaprincipal, "TextoCombo1", alturan, anchon, haciaabajo - 1, 97)
                Selection.Text = "" & EtiquetaCombo1
                    Range("B200").Select
                    
            If UCase(tiposeleccioncombo1) = "MULTIPLE" Then
                    'B_ALL
                    Call acomoda_forma(hojaprincipal, "CB1", 10, 10, haciaabajo + 5, 87 + 5)
                        Range("B200").Select
            End If
    End If
    
    If activocombo2 <> "" Then
        'COMBO2
        ActiveSheet.Shapes("ListBoxCombo2").Select
        Selection.ShapeRange.LockAspectRatio = msoFalse
        Selection.ShapeRange.Height = 300
        Selection.ShapeRange.Width = 300
        
            Call acomoda_forma(hojaprincipal, "ListBoxCombo2", altura, ancho, hacia_abajo_combo, 270)
            Range("B200").Select
            'ETIQUETA COMBO 2
            Call acomoda_forma(hojaprincipal, "TextoCombo2", alturan, anchon, haciaabajo - 1, 277)
                Selection.Text = "" & EtiquetaCombo2
                    Range("B200").Select

            If UCase(tiposeleccioncombo2) = "MULTIPLE" Then
                'B_ALL
                    Call acomoda_forma(hojaprincipal, "CB2", 10, 10, haciaabajo + 5, 267 + 5)
                        Range("B200").Select
            
            End If
    End If

    If activocombo3 <> "" Then
        ' COMBO3
        ActiveSheet.Shapes("ListBoxCombo3").Select
        Selection.ShapeRange.LockAspectRatio = msoFalse
        Selection.ShapeRange.Height = 300
        Selection.ShapeRange.Width = 300
        
        Call acomoda_forma(hojaprincipal, "ListBoxCombo3", altura, ancho, hacia_abajo_combo, 450)
        Range("B200").Select
        'ETIQUETA COMBO 3
        Call acomoda_forma(hojaprincipal, "TextoCombo3", alturan, anchon, haciaabajo - 1, 458)
            Selection.Text = "" & EtiquetaCombo3
                Range("B200").Select
        
            If UCase(tiposeleccioncombo2) = "MULTIPLE" Then
                'B_ALL
                    Call acomoda_forma(hojaprincipal, "CB3", 10, 10, haciaabajo + 5, 448 + 5)
                        Range("B200").Select
            End If
    End If

    If activocombo4 <> "" Then
        ' COMBO4
        ActiveSheet.Shapes("ListBoxCombo4").Select
        Selection.ShapeRange.LockAspectRatio = msoFalse
        Selection.ShapeRange.Height = 300
        Selection.ShapeRange.Width = 300
        
        Call acomoda_forma(hojaprincipal, "ListBoxCombo4", altura, ancho, hacia_abajo_combo, 630)
        Range("B200").Select
        'ETIQUETA COMBO 4
        Call acomoda_forma(hojaprincipal, "TextoCombo4", alturan, anchon, haciaabajo - 1, 637)
            Selection.Text = "" & EtiquetaCombo4
                Range("B200").Select

            If UCase(tiposeleccioncombo2) = "MULTIPLE" Then
                'B_ALL
                    Call acomoda_forma(hojaprincipal, "CB4", 10, 10, haciaabajo + 5, 627 + 5)
                        Range("B200").Select
            End If
    End If

Call acomoda_forma(hojaprincipal, "TextodeMonedas", 15, 200, 162 + 16, 15)
    Range("B200").Select
    
Call acomoda_forma(hojaprincipal, "SpinButton1", 17, 13.25, 162 + 16, 4)
    Range("B200").Select

    ActiveWindow.SmallScroll ToRight:=3
    ActiveWindow.SmallScroll ToLeft:=3
    ActiveWindow.SmallScroll Down:=3
    ActiveWindow.SmallScroll Up:=3

    Range(posicion).Offset(0, 1).Select

End Sub

Sub acomoda_forma(hoja, forma, v_altura, v_ancho, v_hacia_abajo, v_izquierda)

    Sheets(hoja).Shapes(forma).Select
    Selection.ShapeRange.LockAspectRatio = msoFalse
    Selection.ShapeRange.Height = v_altura
    Selection.ShapeRange.Width = v_ancho
    Selection.ShapeRange.Top = v_hacia_abajo
    Selection.ShapeRange.Left = v_izquierda

End Sub


Sub proceso_abrir_libro()

        desBloquea
        inicializa
            
    If Estado_actual <> 1 Then
        Combos_Llenos = False
    End If
    
        ActiveWindow.Zoom = 100

    ThisWorkbook.Sheets(hojaprincipal).Select

    'CDCS
    'Si esta guardando el reporte, solo que ponga los primeros valores del Combo en la Tabla
    If UCase(Range("Query!B28").Value) = "V" And Estado_actual = 2 Then
        
        limpia_combos
        
'        For T = O To numero_de_combos_activos - 1
'            Call define_combo(T + 1, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)
'            Call primer_valor_TRUE_en_el_PIVOT("TR01", cvecombo, arreglo)
'        Next
    Else
    
        'CDCS
        Call Formato_Tabla_R01("P5", "TR01")
        
        rangotabla1 = ThisWorkbook.Sheets("BD").PivotTables("TR01").TableRange1
        renglones1 = UBound(rangotabla1)
        'Revisar
        
        If UCase(Range("Query!B28").Value) = "V" Then
            For T = O To numero_de_combos_activos - 1
                Call define_combo(T + 1, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)
                Call todo_a_TRUE_en_el_PIVOT("TR01", cvecombo, arreglo)
            Next
        End If
        'Valida si la Tabla R01 esta vacia
        If renglones1 = 2 Then
            valor_error = "NO HAY INFORMACI|fffd|N EN TR01"
            ThisWorkbook.Sheets(hojaprincipal).Range(posicion).Offset(2, 2).Value = "NO HAY INFORMACI|fffd|N PARA MOSTRAR"
            GoTo FIN
        End If
    
        revisa_y_llena_combos
        limpia_combos
        
        
    End If


    Sheets(hojaprincipal).Select
    Range("C10").Select
    tamcombo
    
    cb = "CB" & X
    
    selecciona_todo_en_el_combo

                        click_genera
            Bloquea
    ThisWorkbook.Sheets(hojaprincipal).Activate
    

FIN:

End Sub
'Sub calcula_participacion(formato, total, menos_x, suma_al_final)
'
'    salir1 = False
'
'    If UCase(menos_x) = "I" Or UCase(menos_x) = "P" Then
'        menos = 0
'    Else
'        Selection.Offset(-1, 0).Select
'    End If
'
'    If total = "%" Then
'
'        Call selecciona_columna(a, b, c)
'
'        If b <> c Then
'            Range(a).Select
'            datosL = Range(b).Offset(0, -1).Value
'        Else
'            datosL = "0"
'        End If
'
'        FIN = b
'    Else
'        If total = "&" Then
'            ActiveCell.Offset(menos, 0).Select
'            datosL = Selection.Offset(0, -1).Value
'            FIN = Selection.Offset(0, 0).Address
'        End If
'    End If
'
'If datosL <> "0" Then
'
'    k = 0
'    Do Until Selection.Offset(k, 0).Address = b
'        If salir1 <> True Then
'
'        If Selection.Offset(k, -1).Value <> "" Then
'            Selection.Offset(k, 0).Value = Selection.Offset(k, -1).Value / datosL * 100
'            suma = suma + Selection.Offset(k, 0).Value
'        End If
'
'            If FIN = Selection.Offset(k, -1).Address Then salir1 = True
'
'        Else
'            Exit Do
'        End If
'
'        k = k + 1
'    Loop
'
'    Selection.Offset(k + menos, 0).Value = suma / formato
'
'End If
'
'
'End Sub
'******************* ANTERIOR *******************

Sub sacar_el_numero_de_renglones_datos()

    celda_actual = ActiveCell.Address
    
    Range(posicion).Offset(0, 1).Select
    
                    Call selecciona_columna(a, b, c)
                    
    salir = False
    renglones_datos = 0
    
    Do Until salir
        renglones_datos = renglones_datos + 1
        ActiveCell.Offset(-1, 0).Select
            If ActiveCell.Address = a Then salir = True
    Loop

    Range(celda_actual).Select

End Sub

Sub calcula_participacion(formato, total, menos, suma_al_final)
    
    salir1 = False
    Selection.Offset(1, 0).Select

    If UCase(menos) = "I" Or UCase(menos) = "P" Then
        menos = 0
    Else
        Selection.Offset(-1, 0).Select
    End If

    sacar_el_numero_de_renglones_datos

    If total = "%" Then
        datosL = Selection.Offset(renglones_datos - menos, -1).Value
        FIN = Selection.Offset(renglones_datos - menos, -1).Address
    Else
        If total = "&" Then
            ActiveCell.Offset(menos, 0).Select
            datosL = Selection.Offset(0, -1).Value
            FIN = Selection.Offset(0, 0).Address
        End If
    End If

If datosL <> "0" Then
    For k = 0 To renglones_datos
        If salir1 <> True Then

        If Selection.Offset(k, -1).Value <> "" Then
            Selection.Offset(k, 0).Value = Selection.Offset(k, -1).Value / datosL * 100
            Selection.Offset(k, 0).Value = Selection.Offset(k, 0).Value / formato
            Selection.Offset(k, 0).NumberFormat = "#,##0.0"
            suma = suma + Selection.Offset(k, 0).Value
        End If

            If FIN = Selection.Offset(k, -1).Address Then salir1 = True

        Else
            Exit For
        End If

    Next

End If

    If UCase(suma_al_final) = "SUMA" Then
        'Pone el total
        Selection.Offset(k + menos, 0).Value = suma / formato
        Else
            If UCase(total) = "&" Or UCase(total) = "%" Or UCase(total) <> "0" Then
                If UCase(total) = "&" Then
                    Selection.Offset(k - menos, 0).Value = ""
                Else
                    Selection.Offset(k + menos, 0).Value = ""
                End If
            End If
    End If

End Sub

Sub borra_hasta(rango)
    Range("IU1").Select
        Selection.End(xlToRight).Select
        Selection.End(xlDown).Select
        Range(Range(rango), Selection.Offset(0, 0)).Clear
    Range("A1").Select
End Sub

Sub cuenta_lugares(inicio, posiciones, hacia)
'Saca la cuenta hacia la derecha(1) o hacia abajo(2)

Range(inicio).Select
posiciones = 0
salir = 0
p1 = 0
valorx = 0
valory = 0

Do Until salir = 4
    p2 = 0
    p1 = salir
    X = 0
    Y = 0

    celda = ActiveCell.Offset(p1, p2).Value

    Do Until celda = ""
            
            If hacia = "1" Then
                p2 = p2 + 1
                X = X + 1
            Else
            If hacia = "2" Then
                Y = Y + 1
                p1 = p1 + 1
            End If
            End If
            celda = ActiveCell.Offset(p1, p2).Value

    Loop

    If hacia = "1" Then
        If salir = 0 Then num_pivotes = X
    End If
    
    If valorx < X Then valorx = X
    If valory < Y Then valory = Y
    If valory = 4 Then salir = valory - 1


salir = salir + 1

Loop
            If hacia = "1" Then
                posiciones = valorx
            Else
            If hacia = "2" Then
                posiciones = valory
            End If
            End If

End Sub
Sub acomdaR01(tabla)

ActiveWorkbook.Sheets("BD").Activate
ActiveSheet.PivotTables(tabla).ClearTable

        With ActiveSheet.PivotTables(tabla)
            .InGridDropZones = True
            .RowAxisLayout xlTabularRow
        End With
checa_sumas = False
Y = 0
For X = 0 To der_tabla + 2

    If X = 0 Then
    Y = 0
    Do Until formato_tabla(X, Y) = "SD"
        campo = LTrim(formato_tabla(X, Y))
        campo = RTrim(formato_tabla(X, Y))
        ActiveSheet.PivotTables(tabla).PivotFields(campo).Orientation = xlPageField
    Y = Y + 1
        If Y >= der_tabla + 1 Then
            Exit Do
        End If
    Loop
    Else
    
    If X = 1 Then
    Y = 0
    Do Until formato_tabla(X, Y) = "SD"
        campoX = LTrim(formato_tabla(X, Y))
        campoX = RTrim(formato_tabla(X, Y))
        ActiveSheet.PivotTables(tabla).PivotFields(campoX).Orientation = xlRowField
        ActiveSheet.PivotTables(tabla).PivotFields(campoX).Subtotals = Array(False, False, False, False, False, _
        False, False, False, False, False, False, False)

        
    Y = Y + 1
        If Y >= der_tabla + 1 Then
            Exit Do
        End If
    Loop
    Else
    If X = 2 Then
    Y = 0
    Do Until formato_tabla(X, Y) = "SD"
        ActiveSheet.PivotTables(tabla).RowGrand = True
        campo_a_sumar = LTrim(formato_tabla(X, Y))
        campo_a_sumar = RTrim(formato_tabla(X, Y))
        letrero_de_suma = "Suma de " & campo_a_sumar
        ActiveSheet.PivotTables(tabla).AddDataField ActiveSheet.PivotTables(tabla).PivotFields(campo_a_sumar), letrero_de_suma, xlSum
    Y = Y + 1
    If Y > 1 Then checa_sumas = True
        If Y >= der_tabla + 1 Then
            
            Exit Do
        End If
    Loop
    Else
    Y = 0
    If X = 3 Then
    antx = X
    X = 3
    ActiveSheet.PivotTables(tabla).RowGrand = True
        If UCase(formato_tabla(X, Y)) = "SI" Then
            ActiveSheet.PivotTables(tabla).ColumnGrand = True
        Else
        If UCase(formato_tabla(X, Y)) = "NO" Then
            ActiveSheet.PivotTables(tabla).ColumnGrand = False
        End If
        End If
        X = antx
        
    End If
    End If
    End If
    End If
Next
    If checa_sumas Then
        ActiveSheet.PivotTables(tabla).DataPivotField.Orientation = xlColumnField
    End If

    
End Sub

Sub pon_bonito_el_encabezado()

    On Error Resume Next

        If hay_listado = 1 Then
            Range(Cells(9, columna_inicial), Cells(9 + renglones_encabezado - 2, columna_inicial + total_de_columnas - 1)).Select
        Else
            Range(Cells(9, columna_inicial), Cells(9 + renglones_encabezado - 1, columna_inicial + total_de_columnas - 1)).Select
        End If

    With Selection.Interior
        .Pattern = xlSolid
        .PatternColorIndex = xlAutomatic
        .Color = 15329983
        .TintAndShade = 0
        .PatternTintAndShade = 0
    End With
    Selection.Font.Bold = True
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter
        .WrapText = True
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = True
        .ColumnWidth = 15
        '.AutoFit = True
        .ReadingOrder = xlContext
    End With
    With Selection.Font
        .Name = "Arial"
        .Size = 10
        .Strikethrough = False
        .Superscript = False
        .Subscript = False
        .OutlineFont = False
        .Shadow = False
        .Underline = xlUnderlineStyleNone
        .ThemeColor = xlThemeColorLight1
        .TintAndShade = 0
        .ThemeFont = xlThemeFontNone
    End With
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    With Selection.Borders(xlEdgeLeft)
        .LineStyle = xlContinuous
        .ThemeColor = 1
        .TintAndShade = 0
        .Weight = xlThick
    End With
    With Selection.Borders(xlEdgeTop)
        .LineStyle = xlContinuous
        .ThemeColor = 1
        .TintAndShade = 0
        .Weight = xlThick
    End With
    With Selection.Borders(xlEdgeBottom)
        .LineStyle = xlContinuous
        .ThemeColor = 1
        .TintAndShade = 0
        .Weight = xlThick
    End With
    With Selection.Borders(xlEdgeRight)
        .LineStyle = xlContinuous
        .ThemeColor = 1
        .TintAndShade = 0
        .Weight = xlThick
    End With
    With Selection.Borders(xlInsideVertical)
        .LineStyle = xlContinuous
        .ThemeColor = 1
        .TintAndShade = 0
        .Weight = xlThick
    End With
    With Selection.Borders(xlInsideHorizontal)
        .LineStyle = xlContinuous
        .ThemeColor = 1
        .TintAndShade = 0
        .Weight = xlThick
    End With
    
    Range(posicion, posicion.End(xlDown)).Select
    With Selection.Font
        .Name = "Arial"
        .Size = 10
        .Underline = xlUnderlineStyleNone
        .ThemeColor = xlThemeColorLight1
        .TintAndShade = 0
        .ThemeFont = xlThemeFontNone
    End With
    
 On Error GoTo 0
 
End Sub

Sub AplicaFormato(columna)

    Call pon_bonito_el_encabezado
    
    ubicacion = columna_inicial - 1
    cuenta = 1

    Range(posicion).Offset(0, ubicacion).Select

    If Left(UCase(Cells(renglon_inicio + renglones_encabezado - 1 + renglones_datos, 2)), 5) = "TOTAL" Then
        total_automatico = 1
    Else
        total_automatico = 0
    End If

    If UCase(Range("Query!B28").Value) = "V" Then
        restar = TCP - quitar_columnas
    Else
        restar = TCP - quitar_columnas - 1
    End If

    For X = 0 To restar
    
        If ActiveCell.Offset(-1, 0).Value <> "" Then
        
        Select Case UCase(formatocol(cuenta - 1, 0))
        Case "N"

                Call selecciona_columna(a, b, c)
                If b <> c Then
                    divide = 1
                    If formatocol(cuenta - 1, 2) <> "" Then
                            divide = 10 ^ formatocol(cuenta - 1, 2)
                    End If
                    
                    Do Until ActiveCell.Address = c
                
                        If ActiveCell.Value <> "" And ActiveCell.Value <> "(en blanco)" Then
                            ActiveCell.Value = ActiveCell.Value / divide
                        End If
                        ActiveCell.Offset(-1, 0).Select
                    Loop
                        Range(a, b).NumberFormat = "#,##0"
                        
                        If UCase(Range("Query!B28").Value) <> "C" And UCase(Range("Query!B28").Value) <> "V" Then
                            If UCase(formatocol(cuenta - 1, 1)) <> "T" And UCase(formatocol(cuenta - 1, 1)) <> "%" And UCase(formatocol(cuenta - 1, 1)) <> "&" Then
                                Range(b).Value = ""
                            End If
                        End If
                        
                        If total_automatico = 1 Then
                            Range(b).Font.Bold = True
                        End If
                End If
            
        Case "M"

                Call selecciona_columna(a, b, c)
                If b <> c Then
                    divide = 1
                    If formatocol(cuenta - 1, 2) <> "" Then
                            divide = 10 ^ formatocol(cuenta - 1, 2)
                    End If

                    Do Until ActiveCell.Address = c
                        If ActiveCell.Value <> "" Then
                            ActiveCell.Value = ActiveCell.Value / divide
                        End If
                        ActiveCell.Offset(-1, 0).Select
                    Loop
                        Range(a, b).NumberFormat = "#,##0"
                        If UCase(Range("Query!B28").Value) <> "C" And UCase(Range("Query!B28").Value) <> "V" Then
                            If UCase(formatocol(cuenta - 1, 1)) <> "T" And UCase(formatocol(cuenta - 1, 1)) <> "%" And UCase(formatocol(cuenta - 1, 1)) <> "&" Then
                                Range(b).Value = ""
                            End If
                        End If
                        If total_automatico = 1 Then
                            Range(b).Font.Bold = True
                        End If
                End If


        Case "P"

                Call selecciona_columna(a, b, c)
                If b <> c Then
                    divide = 1
                    If formatocol(cuenta - 1, 2) <> "" Then
                            divide = 10 ^ formatocol(cuenta - 1, 2)
                    End If

                    Do Until ActiveCell.Address = c
                                If ActiveCell.Value <> "" Then
                                    ActiveCell.Value = ActiveCell.Value / divide
                                End If
                        ActiveCell.Offset(-1, 0).Select
                    Loop
                        Range(a, b).NumberFormat = "#,##0.0"
                        If UCase(Range("Query!B28").Value) <> "C" And UCase(Range("Query!B28").Value) <> "V" Then
                            If UCase(formatocol(cuenta - 1, 1)) <> "T" And UCase(formatocol(cuenta - 1, 1)) <> "%" And UCase(formatocol(cuenta - 1, 1)) <> "&" Then
                                Range(b).Value = ""
                            End If
                        End If
                        If total_automatico = 1 Then
                            Range(b).Font.Bold = True
                        End If
                End If



        Case "C"

                Call selecciona_columna(a, b, c)
                If b <> c Then
                        If UCase(Range("Query!B28").Value) <> "C" And UCase(Range("Query!B28").Value) <> "V" Then
                            If UCase(formatocol(cuenta - 1, 1)) <> "T" And UCase(formatocol(cuenta - 1, 1)) <> "%" And UCase(formatocol(cuenta - 1, 1)) <> "&" Then
                                Range(b).Value = ""
                            End If
                        End If
                        If total_automatico = 1 Then
                            Range(b).Font.Bold = True
                        End If
                End If

        Case "I"
        
                Call selecciona_columna(a, b, c)
                If b <> c Then

                    divide = 1
                    If formatocol(cuenta - 1, 2) <> "" Then
                            divide = 10 ^ formatocol(cuenta - 1, 2)
                    End If

                    Do Until ActiveCell.Address = c
                        If ActiveCell.Value <> "" Then
                            ActiveCell.Value = ActiveCell.Value / divide
                        End If
                        ActiveCell.Offset(-1, 0).Select
                    Loop
                        Range(a, b).NumberFormat = "#,##0.00"
                        If UCase(Range("Query!B28").Value) <> "C" And UCase(Range("Query!B28").Value) <> "V" Then
                            If UCase(formatocol(cuenta - 1, 1)) <> "T" And UCase(formatocol(cuenta - 1, 1)) <> "%" And UCase(formatocol(cuenta - 1, 1)) <> "&" Then
                                Range(b).Value = ""
                            End If
                        End If
                        If total_automatico = 1 Then
                            Range(b).Font.Bold = True
                        End If
                End If

        End Select

            If UCase(formatocol(cuenta - 1, 1)) = "%" Or UCase(formatocol(cuenta - 1, 1)) = "&" Then
                divide = 1
                If formatocol(cuenta - 1, 2) <> "" Then
                        divide = 10 ^ formatocol(cuenta - 1, 2)
                End If
  
                Call calcula_participacion(divide, UCase(formatocol(cuenta - 1, 1)), formatocol(cuenta - 1, 0), formatocol(cuenta - 1, 3))
                If total_automatico = 1 Then
                    Call selecciona_columna(a, b, c)
                    Range(b).Font.Bold = True
                End If
            
            End If

        Range(a).Select
        'Si viene del Formato V que no entre Aqui
        If formatocol(cuenta - 1, 3) <> "" And UCase(formatocol(cuenta - 1, 3)) <> "SUMA" And UCase(Range("Query!B28").Value) <> "V" Then
            Call selecciona_columna(a, b, c)
                Range(a).Select
            If ActiveCell.Value <> "" Then
                Dat = ThisWorkbook.Sheets("BD").PivotTables(formatocol(cuenta - 1, 3)).TableRange1
                reng = UBound(Dat)
                l = 0

                    Do Until ActiveCell.Address = Range(b).Offset(1, 0).Address
                            clave = ActiveCell.Value
                            If clave <> "" Then
                                For n = 3 To reng
                                    If clave = Dat(n, 1) Then
                                        ActiveCell.Value = Dat(n, 2)
                                        Exit For
                                    End If
                                Next n
                            End If
                        l = l + 1

                        ActiveCell.Offset(1, 0).Select
                    Loop
            Selection.Columns.EntireColumn.AutoFit

            End If
        End If

            Selection.Columns.EntireColumn.AutoFit
            
        
        If cuenta < columnas_encabezado Then
            cuenta = cuenta + 1
        Else
            cuenta = 1
        End If
            ubicacion = ubicacion + 1
        Range(posicion).Offset(0, ubicacion).Select
        
        End If

    Next
        
        On Error GoTo 0
        
    ThisWorkbook.Sheets(hojaprincipal).Activate
        
'    Call adecua_encabezados("C10")

'    Range("b11").Select
    'Selection.Rows.EntireRow.NumberFormat = "mmm-yy"
'    Range("c1").Select
'    Selection.ColumnWidth = 70
'    Range("b11").Select
'    Selection.Rows.EntireRow.AutoFit

End Sub

Sub prepara_tabla()

    Sheets("BD").Select

For X = 1 To numero_de_combos_activos

abrir_tabla = ""
buscar = False

'inicio_c:

Select Case X
    Case 1
        cve = cve_en_combo1
        valor = DatoCombo1
        
        If cve <> "" Then
        For p = 0 To cves_encabezado - 1
            Call define_combo(p + 1, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)
        

                    If cvecombo = cve Then
                            If UCase(Range("Query!B28").Value) <> "V" Then
                                    abrir_tabla = listar
    
                            End If
                            If DC(3, p) = "" Then
                                abrir_tabla = listar
    
                            End If
                        Exit For
                    End If
            Next
        Else
            cve = DC(2, 0)
            abrir_tabla = 5
        End If

    Case 2
        cve = cve_en_combo2
        valor = DatoCombo2
        
        If cve <> "" Then
            For p = 0 To cves_encabezado - 1
                Call define_combo(p + 1, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)
                
                    If cvecombo = cve Then
                            If UCase(Range("Query!B28").Value) <> "V" Then
                                    abrir_tabla = listar
    
                            End If
                            If DC(3, p) = "" Then
                                abrir_tabla = listar
    
                            End If
                        Exit For
                    End If
            Next
        Else
            cve = DC(2, 1)
            abrir_tabla = 5
        End If

    Case 3
        cve = cve_en_combo3
        valor = DatoCombo3
        If cve <> "" Then
            For p = 0 To cves_encabezado - 1
                Call define_combo(p + 1, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)
                
                    If cvecombo = cve Then
                            If UCase(Range("Query!B28").Value) <> "V" Then
                                    abrir_tabla = listar
                            End If
                            If DC(3, p) = "" Then
                                abrir_tabla = listar
    
                            End If
                        Exit For
                    End If
            Next
        Else
            cve = DC(2, 2)
            abrir_tabla = 5
        End If
    
    Case 4
        cve = cve_en_combo4
        valor = DatoCombo4
        If cve <> "" Then
            For p = 0 To cves_encabezado - 1
                Call define_combo(p + 1, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)
                
                    If cvecombo = cve Then
                            If UCase(Range("Query!B28").Value) <> "V" Then
                                    abrir_tabla = listar
                            End If
                            If DC(3, p) = "" Then
                                abrir_tabla = listar
    
                            End If
                        Exit For
                    End If
            Next
        Else
            cve = DC(2, 3)
            abrir_tabla = 5
        End If

End Select
    

    If abrir_tabla = "" Then 'Or UCase(Range("Query!B28").Value) = "V" Then
        ThisWorkbook.Sheets("BD").PivotTables("TR01").PivotFields(cve).CurrentPage = valor
    Else
        If abrir_tabla <> 5 Then
            ThisWorkbook.Sheets("BD").PivotTables("TR01").PivotFields(cve).CurrentPage = "all"
        End If
    End If

Next
    
FIN:
    rangotabla1 = ThisWorkbook.Sheets("BD").PivotTables("TR01").TableRange1
    renglones1 = UBound(rangotabla1)
    columnas_en_tabla = UBound(rangotabla1, 2) - 1

End Sub
Sub formatocolumnas(columnas, renglones_encabezado)

    i = renglones_encabezado
    hoja_de_trabajo = ActiveSheet.Name
    
    
    ActiveWorkbook.Sheets(hojaprincipal).Select
    
    If ActiveSheet.Shapes("TextodeMonedas").Visible = True Then
    
        ActiveSheet.Shapes("TextodeMonedas").Select
        formato_de_monedas = Selection.Characters.Text
        ActiveWorkbook.Sheets(hoja_de_trabajo).Select
    
        Select Case formato_de_monedas
            Case ""
                valor = 0
            Case "Montos en pesos"
                valor = 0
            Case "Montos en miles de pesos"
                valor = 3
            Case "Montos en millones de pesos"
                valor = 6
            Case "Montos en miles de millones de pesos"
                valor = 9
        End Select

    End If
    
    renglon = ThisWorkbook.Sheets("Formato").Range("A1").Offset(i, 0).Address
    
    
For k = 0 To columnas_encabezado - 1
    a = ThisWorkbook.Sheets("Formato").Range("A1").Offset(i + 1, 0).Offset(0, k).Address

    formatocol(k, 0) = ThisWorkbook.Sheets("Formato").Range(renglon).Offset(1, k)
    
        'Asigna el formato de la Etiqueta a la hoja de Formato y lo cambia (funci|fffd|n del SPIN)
            If UCase(formatocol(k, 0)) = "M" Then
                ThisWorkbook.Sheets("Formato").Range(renglon).Offset(3, k) = valor
            End If

    'Obtiene cifras de control
    formatocol(k, 2) = ThisWorkbook.Sheets("Formato").Range(renglon).Offset(3, k)
    'Obtiene la Tabla para convertir la columna
    formatocol(k, 3) = ThisWorkbook.Sheets("Formato").Range(renglon).Offset(4, k)
    'Para poder Totales o Participaci|fffd|n
    columnas(k, 1) = ThisWorkbook.Sheets("Formato").Range(renglon).Offset(2, k)

 If UCase(formatocol(k, 0)) = "M" Then
    columnas(k + 1, 2) = valor
Else
    If UCase(formatocol(k, 0)) = "P" Then
        columnas(k + 1, 2) = ThisWorkbook.Sheets("Formato").Range(renglon).Offset(3, k)
    End If
 End If


Next k

End Sub


Sub acomodar_tabla()

Call tomar_datos_tabla

tabla = "R01"

der_tabla = der - 1
aba_tabla = aba - 1

ReDim formato_tabla(aba_tabla, der_tabla)


End Sub

Sub revisar_variables_en_encabezado()

ThisWorkbook.Sheets("Formato").Activate
linea1 = Range("a1").Value
linea2 = Range("a2").Value

linea1_cve = Left(linea1, 3)
linea2_cve = Left(linea2, 3)
cves_encabezado = 0

If linea1_cve = "cve" Then
    cves_encabezado = cves_encabezado + 1
        If linea2_cve = "cve" Then
            cves_encabezado = cves_encabezado + 1
        End If
End If

ThisWorkbook.Sheets(hojaprincipal).Activate

End Sub

Function valida_num_columnas()

a = columnas_encabezado
jk = columna_inicial + 1
contador = 1

        If numero_de_datos_en_combo1 <> 0 Then
            contador = contador * numero_de_datos_en_combo1
        End If
        If numero_de_datos_en_combo2 <> 0 Then
            contador = contador * numero_de_datos_en_combo2
        End If
        If numero_de_datos_en_combo3 <> 0 Then
            contador = contador * numero_de_datos_en_combo3
        End If
        If numero_de_datos_en_combo4 <> 0 Then
            contador = contador * numero_de_datos_en_combo4
        End If
        numero_real_de_elementos = contador

        If listar_combo1en_b <> "" Or listar_combo2en_b <> "" Or listar_combo3en_b <> "" Or listar_combo4en_b <> "" Then
            If listar_combo1en_b <> "" Then
                anterior_c1 = numero_de_datos_en_combo1
                numero_de_datos_en_combo1 = 1
            End If
            If listar_combo2en_b <> "" Then
                anterior_c2 = numero_de_datos_en_combo2
                numero_de_datos_en_combo2 = 1
            End If
            If listar_combo3en_b <> "" Then
                anterior_c3 = numero_de_datos_en_combo3
                numero_de_datos_en_combo3 = 1
            End If
            If listar_combo4en_b <> "" Then
                anterior_c4 = numero_de_datos_en_combo4
                numero_de_datos_en_combo4 = 1
            End If
        End If
    contador = 1

If numero_de_datos_en_combo1 <> 0 Then
    contador = contador * numero_de_datos_en_combo1
End If
If numero_de_datos_en_combo2 <> 0 Then
    contador = contador * numero_de_datos_en_combo2
End If
If numero_de_datos_en_combo3 <> 0 Then
    contador = contador * numero_de_datos_en_combo3
End If
If numero_de_datos_en_combo4 <> 0 Then
    contador = contador * numero_de_datos_en_combo4
End If

    contador = contador * columnas_encabezado

total_de_columnas = contador

    If UCase(Range("Query!B28").Value) = "V" Then
    
        Call contar_vertical(total_de_datos)
        
            total_de_columnas = total_de_datos
            contador = total_de_columnas
    End If

If contador < 256 Then
    valida_num_columnas = True
    valor_error = ""
Else
    valida_num_columnas = False
    valor_error = "Mas de 250 Columnas a pintar"
End If



End Function
Sub contar_vertical(total_de_datos)

    Call sacar_arreglo_de_datos_en_combo(numero_de_datos_en_combos)


total_de_datos = num_columnas_encabezado

                    For d = 0 To numero_de_combos_activos - 1
                        For g = 0 To numero_de_combos_activos - 1
                            If numero_de_datos_en_combos(d, 1) = cve_del_combo(g, 0) Then
                                If cve_del_combo(g, 1) = "p" Then
                                    total_de_datos = total_de_datos * numero_de_datos_en_combos(d, 0)
                                End If
                            End If
                            
                        Next
                    Next



End Sub

Sub spin()
desBloquea

    inicializa
                click_genera

Bloquea

End Sub

Sub obtienearreglos()
    Sheets(hojaprincipal).Select

For w = 1 To numero_de_combos_activos

    Call define_combo(w, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)

        n = 0
        Y = 0
        
        For x1 = 0 To combo.ListCount - 1
            If combo.Selected(x1) = True Then
                Y = Y + 1
            End If
        Next
        
            If Y = 0 Then
                    MsgBox "Por lo menos debe de seleccionar 1 elemento en el combo " & w
                    valor_error = "No se han seleccionado elementos en el combo"
                n = ""
                GoTo SIN_ELEMENTOS
            End If

        ReDim arrCombo(Y - 1, 1)
    
        n = 0
        For x1 = 0 To combo.ListCount - 1
            If combo.Selected(x1) = True Then
                arrCombo(n, 0) = combo.List(x1, 0)
                arrCombo(n, 1) = combo.List(x1, 1)
                n = n + 1
            End If
        Next
        
SIN_ELEMENTOS:

    If Y <> "" Then
        Select Case w
        Case 1
            numero_de_datos_en_combo1 = Y
            arrCombo1 = arrCombo
            
        Case 2
            numero_de_datos_en_combo2 = Y
            arrCombo2 = arrCombo
        
        Case 3
            numero_de_datos_en_combo3 = Y
            arrCombo3 = arrCombo
        
        Case 4
            numero_de_datos_en_combo4 = Y
            arrCombo4 = arrCombo
        End Select
    End If

    If cvecombo = "cve_estado" Then
        estado_para_municipios = arrCombo(0, 1)
    End If

Next

End Sub
Sub revisa_y_llena_combos()
salir = False
X = 4

Do Until salir
    Call define_combo(X, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)
        ligado = ""
        inicio = 1

    If X = 1 Then
        activo = activocombo1
        cve = cvecombo1
        dl = dlcombo1
        orden_combo = orden_combo1
        
    Else
        If X = 2 Then
        activo = activocombo2
        cve = cvecombo2
        dl = dlcombo2
        ligado = ThisWorkbook.Sheets("Query").Range("E10").Value
        orden_combo = orden_combo2
        
    Else
        If X = 3 Then
        activo = activocombo3
        cve = cvecombo3
        dl = dlcombo3
        ligado = ThisWorkbook.Sheets("Query").Range("G10").Value
        orden_combo = orden_combo3
        
    Else
        If X = 4 Then
        activo = activocombo4
        cve = cvecombo4
        dl = dlcombo4
        ligado = ThisWorkbook.Sheets("Query").Range("I10").Value
        orden_combo = orden_combo4

    End If
    End If
    End If
    End If

    Call define_tabla_de_datos(X, tabla)

    If activo <> "" Then
        If ligado = "" Then
            llenar = True
        Else
            llenar = False
        End If
        
        Call llena_combos(tabla, combo, cve, dl)
    End If
    X = X - 1
    If X = 0 Then
        salir = True
    End If
Loop
    Combos_Llenos = True

End Sub

Sub llena_combos(tabla, combo, cve, dl)

If llenar = False Then
    GoTo FIN
End If
    '*******************    LLENA ListBoxPeriodos
    Set pivot = ThisWorkbook.Worksheets("BD").PivotTables(tabla)
    Sheets(hojaprincipal).Activate
    combo.Clear
    
    rangotabla1 = ThisWorkbook.Sheets("BD").PivotTables(tabla).TableRange1
    
'PARA LLENAR CUALQUIER COMBO CON PERIODOS
If cve = "cve_periodo" Then

    If orden_combo = "DESCENDENTE" Or orden_combo = "" Then
        ActiveWorkbook.Worksheets("BD").PivotTables("TR01").PivotFields(cve).AutoSort xlDescending, cve '"cve_periodo"
        
    Else
    If orden_combo = "ASCENDENTE" Then
        ActiveWorkbook.Worksheets("BD").PivotTables("TR01").PivotFields(cve).AutoSort xlAscending, cve '"cve_periodo"
    End If
    End If
    
    For Each pvtitem In pivot.PivotFields(cve).PivotItems
        datos_p_combo = datos_p_combo + 1
    Next
    
    ReDim periodos_a_meter_en_combo(datos_p_combo - 1, 1)

    For Each pvtitem In pivot.PivotFields(cve).PivotItems
    
        If pvtitem.Name > 1 Then
            If limitar_periodos = "SI" Then
                If periodol <> "" Then
                    If pvtitem.Value <= periodol Then
                        If pvtitem.Value >= periodoantl Then
                            periodos_a_meter_en_combo(cuenta_datos, 0) = pvtitem.Name
                            periodos_a_meter_en_combo(cuenta_datos, 1) = pvtitem.Name
                            cuenta_datos = cuenta_datos + 1
                        End If
                    End If
                Else
                    If pvtitem.Value >= periodoantl Then
                        periodos_a_meter_en_combo(cuenta_datos, 0) = pvtitem.Name
                        periodos_a_meter_en_combo(cuenta_datos, 1) = pvtitem.Name
                        cuenta_datos = cuenta_datos + 1
                    End If
                End If
            Else
                periodos_a_meter_en_combo(cuenta_datos, 0) = pvtitem.Name
                periodos_a_meter_en_combo(cuenta_datos, 1) = pvtitem.Name
                cuenta_datos = cuenta_datos + 1
            End If
        End If
    Next
    
    ReDim datos_a_meter_en_combo(cuenta_datos - 1, 1)

        For X = 0 To cuenta_datos - 1
            datos_a_meter_en_combo(X, 0) = periodos_a_meter_en_combo(X, 0)
            datos_a_meter_en_combo(X, 1) = periodos_a_meter_en_combo(X, 1)
        Next
        
'PARA LLENAR LOS COMBOS
Else

    If orden_combo = "ASCENDENTE" Or orden_combo = "" Then
        ActiveWorkbook.Worksheets("BD").PivotTables(tabla).PivotFields(dl).AutoSort xlAscending, dl
    Else
    If orden_combo = "DESCENDENTE" Then
        ActiveWorkbook.Worksheets("BD").PivotTables(tabla).PivotFields(dl).AutoSort xlDescending, dl
    End If
    End If

    If tabla = "Instituciones" Then

        Call Filtrar_Instituciones(numero_de_datos_meter, claves_quitar, datos_a_quitar)

        ReDim datos_a_meter_en_combo(numero_de_datos_meter, 1)

        If numero_de_datos_meter = datos_a_quitar Or numero_de_datos_meter = 0 Then
                datos_a_meter_en_combo(0, 1) = rangotabla1(3, 3)
                datos_a_meter_en_combo(0, 0) = rangotabla1(3, 2)
        End If

        For X = 3 To UBound(rangotabla1)
                
            For Y = 0 To numero_de_datos_meter - 1
                If rangotabla1(X, 3) <> claves_quitar(Y) Then
                    meter = True
                Else
                    meter = False
                    Exit For
                End If
            
            Next

            If meter Then
                datos_a_meter_en_combo(posdato, 1) = rangotabla1(X, 3)
                datos_a_meter_en_combo(posdato, 0) = rangotabla1(X, 2)
                posdato = posdato + 1
            End If
        Next
        
        gcv = claves_quitar

    Else

        ReDim datos_a_meter_en_combo(UBound(rangotabla1) - 3, 1)

        For X = 3 To UBound(rangotabla1)
            datos_a_meter_en_combo(X - 3, 1) = rangotabla1(X, 2)
            datos_a_meter_en_combo(X - 3, 0) = rangotabla1(X, 1)
        Next

    End If

End If


    dimen_el_combo = True
    combo.List = datos_a_meter_en_combo
    combo.ColumnCount = 2
                ant = Estado_actual
                Estado_actual = 1
        combo.BoundColumn = 2
        combo.TextColumn = 2
        combo.TopIndex = 0
        combo.Selected(0) = True
                Estado_actual = ant
    dimen_el_combo = True
    
FIN:
    
End Sub

Sub Filtrar_Instituciones(numero_de_datos_meter, claves_quitar, datos_a_quitar)

On Error GoTo con_error

ReDim claves_poner(UBound(rangotabla1) - 3)
ReDim claves_quitar(UBound(rangotabla1) - 3)
numero_de_datos_meter = UBound(claves_poner)

    'Revisando las opciones
'INCLUIR SOFOMES
'ThisWorkbook.Sheets("BD").Range ("B4")
    X = 0
    If UCase(ThisWorkbook.Sheets("BD").Range("B4").Value) <> "S" And UCase(ThisWorkbook.Sheets("BD").Range("B4").Value) <> "SI" Then
            For X = 3 To UBound(rangotabla1)
                If rangotabla1(X, 4) = "S" Then
                    claves_quitar(datos_S) = rangotabla1(X, 3)
                    datos_S = datos_S + 1
                End If
            Next
    End If
'EXCLUIR VIRTUALES
'ThisWorkbook.Sheets("BD").Range ("B5")
    X = 0
    If UCase(ThisWorkbook.Sheets("BD").Range("B5").Value) = "S" Or UCase(ThisWorkbook.Sheets("BD").Range("B5").Value) = "SI" Then
            For X = 3 To UBound(rangotabla1)
                If rangotabla1(X, 4) = "V" Then
                    claves_quitar(datos_S + datos_V) = rangotabla1(X, 3)
                    datos_V = datos_V + 1
                End If
            Next
    End If
'EXCLUIR INSTITUCIONES
'ThisWorkbook.Sheets("Query").Range ("K25")
    X = 0
    Do While ThisWorkbook.Sheets("Query").Range("K25").Offset(datos_I, 0).Value <> ""
        If ThisWorkbook.Sheets("Query").Range("K25").Offset(datos_I, 0).Value <> "" Then
            claves_quitar(datos_S + datos_V + datos_I) = "" & ThisWorkbook.Sheets("Query").Range("K25").Offset(datos_I, 0).Value
            datos_I = datos_I + 1
        End If
    Loop

numero_de_datos_meter = numero_de_datos_meter - datos_S - datos_V - datos_I
datos_a_quitar = datos_S + datos_V + datos_I

GoTo FIN:

con_error:

    valor_error = "Error al Filtrar Instituciones"

FIN:

End Sub

Sub ListadoDeDatos(arrCombo1, arrCombo2, arrCombo3, arrCombo4, con_totales)

Dim arreglo

    If ThisWorkbook.Sheets("Query").Range("C9").Value <> "" Then
        arreglo = arrCombo1
        numero_de_datos = anterior_c1
    Else
        If ThisWorkbook.Sheets("Query").Range("E9").Value <> "" Then
            arreglo = arrCombo2
            numero_de_datos = anterior_c2
        Else
            If ThisWorkbook.Sheets("Query").Range("G9").Value <> "" Then
                arreglo = arrCombo3
                numero_de_datos = anterior_c3
            Else
                If ThisWorkbook.Sheets("Query").Range("I9").Value <> "" Then
                    arreglo = arrCombo4
                    numero_de_datos = anterior_c4
                End If
            End If
        End If
    End If

    Sheets(hojaprincipal).Activate
    
    If UCase(Range("Query!B28").Value) <> "V" Then
        borra_hasta (posicion)
        d = posicion
    Else
        otros_en_encabezado = renglones_encabezado - cves_encabezado
        d = Range(posicion).Offset(-cves_encabezado + otros_en_encabezado, 0).Address
        borra_hasta (d)

    End If
    
        Selection.End(xlToRight).Select
        Selection.End(xlDown).Select
        Range(Selection.Offset(0, 0), d).Select
        
        Selection.Clear
    
    listado = False
    Y = 0
    X = ActiveCell.Row
    cprincipalA = "A" & X
    cprincipalB = "B" & X


For Y = 0 To numero_de_datos - 1

    listado = arreglo(Y, 0)
            Range(cprincipalA).NumberFormat = "@"
            'Range(cprincipalA).NumberFormat = "#_-"
            ActiveWorkbook.Sheets(hojaprincipal).Range(cprincipalA).Value = arreglo(Y, 1)
            ActiveWorkbook.Sheets(hojaprincipal).Range(cprincipalB).Value = arreglo(Y, 0)
    'End If
    
        X = X + 1
    cprincipalA = "A" & X
    cprincipalB = "B" & X
Next

If UCase(con_totales) = "PIVOT" Then
    ActiveWorkbook.Sheets(hojaprincipal).Range(cprincipalB).Value = "Total"
End If
If UCase(con_totales) = "CALCULADO" Then
    ActiveWorkbook.Sheets(hojaprincipal).Range(cprincipalB).Value = "Total"
End If

TERMINAR:

    ActiveSheet.Range(posicion).Select

End Sub

Sub revisa_llenado_de_combo_dinamico(valor)

    'inicializa

If Combos_Llenos = True Then

obtienearreglos

Select Case valor
    Case 2
        If ThisWorkbook.Sheets("Query").Range("E10").Value <> "" Then
            campo_de_liga = ThisWorkbook.Sheets("Query").Range("E10").Value
            cve = cvecombo2
            dl = dlcombo2
            lista_datos_en_combo = 2
            tabla = "TCOMBO2"
            DatoCombo = arrCombo1(0, 1)
        End If
    Case 3
        If ThisWorkbook.Sheets("Query").Range("G10").Value <> "" Then
            campo_de_liga = ThisWorkbook.Sheets("Query").Range("G10").Value
            cve = cvecombo3
            dl = dlcombo3
            lista_datos_en_combo = 3
            tabla = "TCOMBO3"
            DatoCombo = DatoCombo2
        End If
    Case 4
        If ThisWorkbook.Sheets("Query").Range("I10").Value <> "" Then
            campo_de_liga = ThisWorkbook.Sheets("Query").Range("I10").Value
            cve = cvecombo3
            dl = dlcombo3
            lista_datos_en_combo = 4
            tabla = "TCOMBO4"
            DatoCombo = DatoCombo3
        End If
End Select

    
    Call define_combo(valor, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)

    ThisWorkbook.Sheets("BD").PivotTables(tabla).PivotFields(campo_de_liga).CurrentPage = DatoCombo
    rangotabla1 = ThisWorkbook.Sheets("BD").PivotTables(tabla).TableRange1
    
    Call llena_combos(tabla, combo, cve, dl)

End If

End Sub


Sub convierte_claves(columnas)

    Call selecciona_columna(a, b, c)

    For k = 1 To columnas_encabezado
        If formatocol(k, 3) <> "" Then
            Dat = ThisWorkbook.Sheets("BD").PivotTables(formatocol(k, 3)).TableRange1
            reng = UBound(Dat)
            
            For l = 0 To Round((columnas - columna_inicial) / columnas_encabezado, 0) - 1
                For m = 0 To renglones_datos - 1
                
                    Range(posicion).Offset(m, columna_inicial + k + columnas_encabezado * l - 2).Select
                    clave = Range(posicion).Offset(m, columna_inicial + k + columnas_encabezado * l - 2)
                    For n = 3 To reng
                       a = Dat(n, 1)
                        If clave = Dat(n, 1) Then
                            Range(posicion).Offset(m, columna_inicial + k + columnas_encabezado * l - 2) = Dat(n, 2)
                            Exit For
                        End If
                    Next n
                Next m
            Next l

        End If
    Next k

End Sub

Sub selecciona_columna(a, b, c)

    a = ActiveCell.Address
    c = ActiveCell.Offset(-1, 0).Address
        celda = "" & Left(a, 3) & "65536"
        Range(celda).Select
        Selection.End(xlUp).Select
    b = ActiveCell.Address
    
End Sub

Sub exportar_datos_TR01()
'EXPORTAR
'inicializa
Application.ScreenUpdating = False
Call libro_nuevo(principal, nuevo)
Call querys_depruebas(principal, nuevo)
Call copiar_formato(principal, nuevo)
Call copia_de_formas(principal, nuevo)
Call formato_de_exportar(principal, nuevo)
        Range("A1").Select
Application.ScreenUpdating = True

End Sub

Sub copia_de_formas(principal, nuevo)
'EXPORTAR
        Windows(principal).Activate

    Call copia_y_pega_formas("Logo", principal, nuevo)
    Call copia_y_pega_formas("sector", principal, nuevo)
    Call copia_y_pega_formas("serie", principal, nuevo)
    Call copia_y_pega_formas("subserie", principal, nuevo)
    Call copia_y_pega_formas("reporte", principal, nuevo)


    ActiveSheet.Shapes("Logo").Select
    Selection.ShapeRange.ScaleWidth 1, msoFalse, msoScaleFromTopLeft
    Selection.ShapeRange.Height = 70
    Selection.ShapeRange.Width = 275
    Selection.ShapeRange.Top = 0
    Selection.ShapeRange.Left = 1
    alturae = 30
    anchoe = 570
    aladerechae = 220
    haciaabajo = 69
    lineas = 15
    altura = 44
    ancho = 170
    alturan = 15
    anchon = 150
    Rows("1:1").RowHeight = (lineas + 10)
    Rows("2:2").RowHeight = lineas
    Rows("3:3").RowHeight = lineas
    Rows("4:4").RowHeight = lineas
    Rows("5:5").RowHeight = (lineas + 53)
    
ActiveSheet.Shapes("sector").Select
Selection.ShapeRange.ScaleWidth 1, msoFalse, msoScaleFromTopLeft
    Selection.ShapeRange.LockAspectRatio = msoFalse
    Selection.ShapeRange.Top = 1
    Selection.ShapeRange.Left = aladerechae
    Selection.ShapeRange.Height = alturae
    Selection.ShapeRange.Width = anchoe
    Range("B200").Select
ActiveSheet.Shapes("serie").Select
Selection.ShapeRange.ScaleWidth 1, msoFalse, msoScaleFromTopLeft
    Selection.ShapeRange.LockAspectRatio = msoFalse
    Selection.ShapeRange.Top = 20
    Selection.ShapeRange.Left = aladerechae
    Selection.ShapeRange.Height = alturae
    Selection.ShapeRange.Width = anchoe
    Range("B200").Select
ActiveSheet.Shapes("subserie").Select
Selection.ShapeRange.ScaleWidth 1, msoFalse, msoScaleFromTopLeft
    Selection.ShapeRange.LockAspectRatio = msoFalse
    Selection.ShapeRange.Top = 35
    Selection.ShapeRange.Left = aladerechae
    Selection.ShapeRange.Height = alturae
    Selection.ShapeRange.Width = anchoe
    Range("B200").Select
ActiveSheet.Shapes("reporte").Select
Selection.ShapeRange.ScaleWidth 1, msoFalse, msoScaleFromTopLeft
    Selection.ShapeRange.LockAspectRatio = msoFalse
    Selection.ShapeRange.Top = 50
    Selection.ShapeRange.Left = aladerechae
    Selection.ShapeRange.Height = alturae
    Selection.ShapeRange.Width = anchoe
    Range("B200").Select

End Sub
Sub acomoda_formas()


Selection.ShapeRange.ScaleWidth 1, msoFalse, msoScaleFromTopLeft
    Selection.ShapeRange.LockAspectRatio = msoFalse
    Selection.ShapeRange.Top = 50
    Selection.ShapeRange.Left = aladerechae
    Selection.ShapeRange.Height = alturae
    Selection.ShapeRange.Width = anchoe
    Range("B200").Select
    
End Sub
Sub copia_y_pega_formas(forma, principal, nuevo)

    ActiveSheet.Shapes(forma).Select
        Selection.Copy
        Windows(nuevo).Activate
        Range("E8").Select
        ActiveSheet.Paste
        Windows(principal).Activate
        
End Sub

Sub libro_nuevo(principal, nuevo)
    Workbooks.Add
    Sheets.Add
    ActiveSheet.Name = hojaprincipal
    Sheets(Array("Hoja1", "Hoja2", "Hoja3")).Delete
    nuevo = ActiveWorkbook.Name
    principal = ThisWorkbook.Name
End Sub

Sub formato_de_exportar(principal, nuevo)

        Windows(nuevo).Activate
Sheets(hojaprincipal).Activate
Range(Cells(8, 1), Cells(8, columna)).Select
    With Selection.Interior
        .Pattern = xlSolid
        .PatternColorIndex = xlAutomatic
        .Color = 15329983
        .TintAndShade = 0
        .PatternTintAndShade = 0
    End With
    Selection.Font.Bold = True
    With Selection
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter
        .WrapText = True
        .Orientation = 0
        .AddIndent = False
        .IndentLevel = 0
        .ShrinkToFit = True
        .ColumnWidth = 15
        .ReadingOrder = xlContext
    End With

End Sub
Sub copiar_formato(principal, nuevo)
        ThisWorkbook.Sheets(hojaprincipal).Activate
        Range(Cells(1, 2), Cells(5, 13)).Copy
        Windows(nuevo).Activate
        Range("A1").Select
        ActiveSheet.Paste
End Sub

Sub querys_depruebas(principal, nuevo)
    Dim miTR01 As Recordset
    Windows(nuevo).Activate
    Set MiConexion = New ADODB.Connection
    MiConexion.ConnectionString = "DSN=destecnica;UID=procesos_dgaex;PWD=Xeagd!;DB=dbdgaex;ApplicationName=DBISQL"
    MiConexion.Open
    MiConexion.CommandTimeout = 0
    Set miTR01 = MiConexion.Execute(queryR01)
        fldCount = miTR01.Fields.Count
        For iCol = 1 To fldCount
            Range(posicion).Offset(-4, iCol - 1).Value = miTR01.Fields(iCol - 1).Name
        Next
        Range(posicion).Offset(-3, 0).CopyFromRecordset miTR01
        columna = fldCount
    miTR01.Close
End Sub
Sub obtiene_encabezado(renglon, valor, veces, contador, ubicacion, num_combo, conteo)


    cols = columnas_encabezado
    cuenta = 0

    If listar_combo1en_b <> "" Or listar_combo2en_b <> "" Or listar_combo3en_b <> "" Or listar_combo4en_b <> "" Then
        veces = total_de_columnas
    End If

    For vueltas = 0 To veces - 1

        r_inicio = renglon_inicio - 1
    
        cuenta1 = 0
        X = 0

        ThisWorkbook.Sheets("Formato").Select
        ThisWorkbook.Sheets("Formato").Range("A1").Select
        Selection.Offset(renglon, 0).Select
    
    
    Do While cuenta1 < cols
    
        ThisWorkbook.Sheets("Formato").Activate

        dato = Selection.Offset(X, vueltas).Value
             ThisWorkbook.Sheets("Formato").Select
             If X > 0 Then
              Selection.Offset(0, 1).Select
             End If

            dato = Selection(1, 1).Value
            
            dif = Selection.Offset(0, 1).Column - Selection.Column

            ThisWorkbook.Sheets(hojaprincipal).Select

            cifra = columna_inicial + (ubicacion * cols) + (contador * veces * cols) + cuenta


            If hay_listado = 1 And UCase(Range("Query!B28").Value) <> "V" Then
                ThisWorkbook.Sheets(hojaprincipal).Cells(r_inicio + renglon, cifra).Select
            Else
                If UCase(Range("Query!B28").Value) = "H" Then
                    ThisWorkbook.Sheets(hojaprincipal).Cells(r_inicio + renglon + 1 - cves_encabezado, cifra).Select
                Else
                    ThisWorkbook.Sheets(hojaprincipal).Cells(r_inicio + renglon + 1, cifra).Select
                End If
            End If

        Range(Selection, Selection.Offset(0, dif - 1)).UnMerge

            If hay_listado = 1 And UCase(Range("Query!B28").Value) <> "V" Then
                ThisWorkbook.Sheets(hojaprincipal).Cells(r_inicio + renglon, cifra).Select
            Else
                If UCase(Range("Query!B28").Value) = "H" Then
                    ThisWorkbook.Sheets(hojaprincipal).Cells(r_inicio + renglon + 1 - cves_encabezado, cifra).Select
                Else
                    ThisWorkbook.Sheets(hojaprincipal).Cells(r_inicio + renglon + 1, cifra).Select
                End If
            End If

        Range(Selection, Selection.Offset(0, dif - 1)).Merge
            cuenta = cuenta + dif
            cuenta1 = cuenta1 + dif
            
            If Left(dato, 4) = "cve_" Then
                Selection.Value = valor
            Else
                Selection.Value = dato
            End If

                X = X + 1
            
                vueltas = vueltas + 1
                If cuenta >= veces Then
                    vueltas = vueltas + 1
                    Exit For
                End If
                
        Loop
        vueltas = vueltas - 1
    Next
    
conteo = cuenta1

End Sub
Sub pintar_encabezado(avanza_cols_encabezado)

    If hay_listado = 1 Then
        posicion_encabezado = Range(posicion).Offset(-renglones_encabezado, columna_inicial - 1).Address
    Else
        posicion_encabezado = Range(posicion).Offset(-renglones_encabezado - 1, columna_inicial - 1).Address
    End If
    borra_hasta (posicion_encabezado)

        Call revisa_combos_asigna_valores(TCPB, TCP, BLO)
        Pintar = BLO
        
EA = TCPB
en_combo = 1
STCP = TCP
BLOAP = TCP
BLOS = TCP / columnas_encabezado


        For Y = 0 To cves_encabezado - 1
        
                avanza = avanza_cols_encabezado(Y)
        
            For X = 0 To TCP - 1

                If quitar_cve(linea) <> "eliminar" Then

                    posicion1 = Range(posicion_encabezado).Offset(pintados + 1, siguiente).Address
                    Range(posicion_encabezado).Offset(pintados + 1, siguiente).Value = pintar_cves_en_el_encabezado(Y, siguiente)
                        siguiente = siguiente + avanza
                    posicion2 = Range(posicion_encabezado).Offset(pintados + 1, siguiente - 1).Address
                    Range(posicion1, posicion2).Merge
                Else
                    Exit For
                
                End If
                If siguiente >= TCP Then
                    pintados = pintados + 1
                    Exit For
                End If
                
            Next
                linea = linea + 1
                siguiente = 0
        Next

    For p = cves_encabezado To renglones_encabezado - 1
    'p es el valor que se asigna al renglon donde estan los datos (no claves)
        pintado_formato = True
        Call obtiene_encabezado(p, valor, total_de_columnas, j, i, num_combo, conteo)
        
    Next p

End Sub



Sub revisa_combos_asigna_valores(columnas_totales_por_bloque, TCP, BLO)

    TCP = 0
    BLO = 0

    Call sacar_arreglo_de_datos_en_combo(numero_de_datos_en_combos)
    


    If UCase(activocombo1) <> "S" Then
        numero_de_datos_en_combo1 = 1
    End If

    If UCase(activocombo2) <> "S" Then
        numero_de_datos_en_combo2 = 1
    End If

    If UCase(activocombo3) <> "S" Then
        numero_de_datos_en_combo3 = 1
    End If
    
    If UCase(activocombo4) <> "S" Then
        numero_de_datos_en_combo4 = 1
    End If

    If UCase(Range("Query!B28").Value) <> "V" Then
        If listar_combo1en_b <> "" Or listar_combo2en_b <> "" Or listar_combo3en_b <> "" Or listar_combo4en_b <> "" Then
        

                If listar_combo1en_b <> "" Then
                    total_de_columnas = total_de_columnas / numero_de_datos_en_combo1
                    numero_de_datos_en_combo1 = 1
                End If
                If listar_combo2en_b <> "" Then
                    total_de_columnas = total_de_columnas / numero_de_datos_en_combo2
                    numero_de_datos_en_combo2 = 1
                End If
                If listar_combo3en_b <> "" Then
                    total_de_columnas = total_de_columnas / numero_de_datos_en_combo3
                    numero_de_datos_en_combo3 = 1
                End If
                If listar_combo4en_b <> "" Then
                    total_de_columnas = total_de_columnas / numero_de_datos_en_combo4
                    numero_de_datos_en_combo4 = 1
                End If

            
        End If
    Else
                If cves_encabezado <> numero_de_combos_activos Then
                    'Ya tenemos el n|fffd|mero de columnas para el Formato "V"
                    Call contar_vertical(total_de_datos)
                    total_de_columnas = total_de_datos
                    contador = total_de_columnas
                End If
    End If
'Si el Combo1 esta activo
If UCase(activocombo1) = "S" Then

    If UCase(Range("Query!B28").Value) <> "V" Then
        columnas_totales_por_bloque = numero_de_datos_en_combo1
        
        If columnas_totales_por_bloque < numero_de_datos_en_combo2 Then
            columnas_totales_por_bloque = numero_de_datos_en_combo2
        End If
        
        If columnas_totales_por_bloque < numero_de_datos_en_combo3 Then
            columnas_totales_por_bloque = numero_de_datos_en_combo3
        End If
        If columnas_totales_por_bloque < numero_de_datos_en_combo4 Then
            columnas_totales_por_bloque = numero_de_datos_en_combo4
        End If
    
        TCP = numero_de_datos_en_combo1 * numero_de_datos_en_combo2 * numero_de_datos_en_combo3 * numero_de_datos_en_combo4 * columnas_encabezado
        BLO = TCP / columnas_totales_por_bloque
    Else
        TCP = total_de_columnas
        BLO = TCP / columnas_encabezado
    End If
End If

End Sub
Sub selecciona_todo_en_el_combo()

    If UCase(sel_todo_combo1) = "S" Or UCase(sel_todo_combo2) = "S" Or UCase(sel_todo_combo3) = "S" Or UCase(sel_todo_combo4) = "S" Then
        For X = 1 To numero_de_combos_activos
            Call define_combo(X, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)
                If UCase(seleccionar) = "S" Then
                    Select Case X
                        Case 1
                            ThisWorkbook.Sheets("MINFO").CB1.Value = False
                            ThisWorkbook.Sheets("MINFO").CB1.Value = True
                        Case 2
                            ThisWorkbook.Sheets("MINFO").CB2.Value = False
                            ThisWorkbook.Sheets("MINFO").CB2.Value = True
                        Case 3
                            ThisWorkbook.Sheets("MINFO").CB3.Value = False
                            ThisWorkbook.Sheets("MINFO").CB3.Value = True
                        Case 4
                            ThisWorkbook.Sheets("MINFO").CB4.Value = False
                            ThisWorkbook.Sheets("MINFO").CB4.Value = True
                    End Select
                End If
        Next
    End If

End Sub


Sub tomar_todos_los_datos_de_la_tabla()
    rangotabla1 = ThisWorkbook.Sheets("BD").PivotTables("TR01").TableRange1
    renglones1 = UBound(rangotabla1)
    datos_de_la_tabla = renglones1 - 3
    columnas_en_tabla = UBound(rangotabla1, 2) - 1
 contador = 0

    ThisWorkbook.Sheets(hojaprincipal).Select
    Range(posicion).Select
For Y = 0 To columnas_en_tabla - quitar_columnas
    For X = 0 To renglones1 - 3
        Range(posicion).Offset(X, Y + columna - 1).Value = rangotabla1(X + 3, Y + 1)
            If Range(posicion).Offset(X, Y + columna - 1).Value <> rangotabla1(X + 3, Y + 1) Then
                Range(posicion).Offset(X, Y + columna - 1).NumberFormat = "@"
                Range(posicion).Offset(X, Y + columna - 1).Value = "" & rangotabla1(X + 3, Y + 1)
            End If
    Next
Next

End Sub

Sub conceptos_directos(resultados, totales)
datos_de_la_tabla = 0
     Do While Not IsEmpty(ActiveCell)

        
        For i = 3 To renglones1
        
        If UCase(Range("Query!M13").Value) = "ALFANUMERICO" Then
            claveins = "" & ActiveCell.Value
            w = "" & rangotabla1(i, 1)
        Else
            claveins = ActiveCell.Value
            w = rangotabla1(i, 1)
        End If
        
            If claveins = w Then
                For X = 1 To columnas_en_tabla - quitar_columnas
                
                    If rangotabla1(i, 1 + X) <> "(en blanco)" Then
                        resultados(X) = rangotabla1(i, 1 + X)
                        totales(X) = totales(X) + resultados(X)
                    End If
                Next
                
                Exit For
            Else
                For X = 1 To columnas_en_tabla - quitar_columnas
                    resultados(X) = ""
                Next
            End If
        Next

        For X = 1 To columnas_encabezado - quitar_columnas
            If resultados(X) <> "" And resultados(X) <> "(en blanco)" Then
                        ActiveCell.Offset(0, columna - 2 + X).Value = resultados(X)
            End If
        Next

        ActiveCell.Offset(1, 0).Select
        datos_de_la_tabla = datos_de_la_tabla + 1
    Loop
    
    For X = 1 To columnas_encabezado - quitar_columnas
        If totales(X) <> "" And totales(X) <> "(en blanco)" Then
                        ActiveCell.Offset(0, columna - 2 + X).Value = totales(X)
        End If
    Next
    
End Sub

Sub info_enR01()

    Call Formato_Tabla_R01("P5", "TR01")
    If renglones1 = UBound(rangotabla1) Then
        valor_error = "EL REPORTE NO PRESENTA INFORMACI|fffd|N"
    End If

End Sub


Sub valores_a_pintar(avanza_cols_encabezado)

    If valida_num_columnas = False Then
        Errores_generales
        GoTo FIN
    End If

    If numero_de_combos_activos > 0 Then
        Call revisa_combos_asigna_valores(TCPB, TCP, BLO)

        Pintar = BLO
        
EA = TCPB
en_combo = 1
STCP = TCP
BLOAP = TCP
BLOS = TCP / columnas_encabezado

'ARREGLO CON VALORES A PINTAR ACVP
    ReDim ACVP(numero_de_combos_activos - 1, TCP - 1)
    ReDim pintar_cves_en_el_encabezado(numero_de_combos_activos - 1, TCP - 1)
'Variables que tiene los datos para Avanzar en el pintado del encabezado
    ReDim avanza_cols_encabezado(numero_de_combos_activos - 1)
    ReDim ACNP(numero_de_combos_activos - 1)
'ARREGLO CON CVES QUE LLEVA EL ENCABEZADO Y SU RESE|fffd|A (SI SE PINTA O SE ELIMINA)
    ReDim quitar_cve(numero_de_combos_activos)

    For repeticiones = 0 To numero_de_combos_activos - 1
    encontrado = False
Do Until encontrado

        Call define_combo(en_combo, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)

                        'cdcs
                        If cves_encabezado <> numero_de_combos_activos Then
                            dat_enc = numero_de_combos_activos - repeticiones - 1
                        Else
                            dat_enc = cves_encabezado - repeticiones - 1
                        End If
                
                dat_enc_ingresando = 0
                contando = 0
                If dat_enc < 0 Then
                    GoTo ERROR_EN_CVES
                End If
                
                If datos_en_encabezado(dat_enc) = cvecombo Then

                    If listar <> "" Then quitar_cve(dat_enc) = "eliminar"

                    ACNP(dat_enc) = cvecombo
                    avanza = (TCP / BLOS)
                        'Asignar el n|fffd|mero de posiciones a desplazar cada T|fffd|tulo
                        avanza_cols_encabezado(dat_enc) = avanza
                    
                        'Asignar el n|fffd|mero de posiciones a desplazar cada T|fffd|tulo
                    salir = False
                Do Until salir

                    For NE = 0 To elementos_en_combo - 1
                            ACVP(dat_enc, siguiente) = arreglo(posicion_en_el_arreglo, 1)
                                siguiente = siguiente + avanza
                                            If avanza >= 1 Then
                                            'If avanza > 1 Then
                                                For ingresando = 0 To avanza - 1
                                                    ACVP(dat_enc, dat_enc_ingresando) = arreglo(posicion_en_el_arreglo, 1)
                                                    pintar_cves_en_el_encabezado(dat_enc, dat_enc_ingresando) = arreglo(posicion_en_el_arreglo, 0)
                                                    dat_enc_ingresando = dat_enc_ingresando + 1
                                                    contando = contando + 1
                                                Next
                                            End If

                            posicion_en_el_arreglo = posicion_en_el_arreglo + 1
                    Next
                    posicion_en_el_arreglo = 0
                    If siguiente >= TCP Then
                        salir = True
                    End If
                Loop
                    BLOS = BLOS / elementos_en_combo
                encontrado = True
                Else
                    If en_combo > 5 Then
                        'cdcs
                        If cves_encabezado <> numero_de_combos_activos Then
                            Exit Do
                        End If
                        
ERROR_EN_CVES:
                        MsgBox "Error en valores de Combos / Claves para pintar incorrectas / Revisar hoja de Formato"
                        Exit Do
                    Else
                        en_combo = en_combo + 1
                    End If
                End If

Loop

en_combo = 1
siguiente = 0

Next

revisando = ACVP
revisando1 = pintar_cves_en_el_encabezado
revisando_otro = avanza_cols_encabezado

    End If
    
FIN:
End Sub



Sub define_tabla_de_datos(X, tabla)
    If X = 1 Then
        If querycombo1 <> "" Or monedas_en_combo1 <> "" Or conceptos_en_combo1 <> "" Or estados_en_combo1 <> "" Or municipios_en_combo1 <> "" Or localidades_en_combo1 <> "" Then
                tabla = "TCOMBO1"
            Else
            If monedas_en_combo1 <> "" Then
                    tabla = "TMONEDAS"
                Else
                If conceptos_en_combo1 <> "" Then
                    tabla = "TCONCEPTOS"
                Else
                    If estados_en_combo1 <> "" Then
                        tabla = "TESTADOS"
                    Else
                        If municipios_en_combo1 <> "" Then
                            tabla = "TMUNICIPIOS"
                        Else
                            If localidades_en_combo1 <> "" Then
                                tabla = "TLOCALIDADES"
                            Else
                                If periodos_en_combo1 <> "" Then
                                    tabla = "TR01"
                                Else
                                    If instituciones_en_combo1 <> "" Then
                                        tabla = "Instituciones"
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
    Else
    
    If X = 2 Then
        If querycombo2 <> "" Or monedas_en_combo2 <> "" Or conceptos_en_combo2 <> "" Or estados_en_combo2 <> "" Or municipios_en_combo2 <> "" Or localidades_en_combo2 <> "" Then
            tabla = "TCOMBO2"
        Else
            If monedas_en_combo2 <> "" Then
                tabla = "TMONEDAS"
            Else
                If conceptos_en_combo2 <> "" Then
                    tabla = "TCONCEPTOS"
                Else
                    If estados_en_combo2 <> "" Then
                        tabla = "TESTADOS"
                    Else
                        If municipios_en_combo2 <> "" Then
                            tabla = "TMUNICIPIOS"
                        Else
                            If localidades_en_combo2 <> "" Then
                                tabla = "TLOCALIDADES"
                            Else
                                If periodos_en_combo2 <> "" Then
                                    tabla = "TR01"
                                Else
                                    If instituciones_en_combo2 <> "" Then
                                        tabla = "Instituciones"
                                    End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
    End If

    Else
    If X = 3 Then

        If querycombo3 <> "" Or monedas_en_combo3 <> "" Or conceptos_en_combo3 <> "" Or estados_en_combo3 <> "" Or municipios_en_combo3 <> "" Or localidades_en_combo3 <> "" Then
            tabla = "TCOMBO3"
        Else
            If monedas_en_combo3 <> "" Then
                tabla = "TMONEDAS"
            Else
                If conceptos_en_combo3 <> "" Then
                    tabla = "TCONCEPTOS"
                Else
                    If estados_en_combo3 <> "" Then
                        tabla = "TESTADOS"
                    Else
                        If municipios_en_combo3 <> "" Then
                            tabla = "TMUNICIPIOS"
                        Else
                            If localidades_en_combo3 <> "" Then
                                tabla = "TLOCALIDADES"
                            Else
                                If periodos_en_combo3 <> "" Then
                                    tabla = "TR01"
                                Else
                                    If instituciones_en_combo3 <> "" Then
                                        tabla = "Instituciones"
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
    Else
    If X = 4 Then
        
        If querycombo4 <> "" Or monedas_en_combo4 <> "" Or conceptos_en_combo4 <> "" Or estados_en_combo4 <> "" Or municipios_en_combo4 <> "" Or localidades_en_combo4 <> "" Then
            tabla = "TCOMBO4"
        Else
            If monedas_en_combo4 <> "" Then
                tabla = "TMONEDAS"
            Else
                If conceptos_en_combo4 <> "" Then
                    tabla = "TCONCEPTOS"
                Else
                    If estados_en_combo4 <> "" Then
                        tabla = "TESTADOS"
                    Else
                        If municipios_en_combo4 <> "" Then
                            tabla = "TMUNICIPIOS"
                        Else
                            If localidades_en_combo4 <> "" Then
                                tabla = "TLOCALIDADES"
                            Else
                                If periodos_en_combo4 <> "" Then
                                    tabla = "TR01"
                                Else
                                    If instituciones_en_combo4 <> "" Then
                                        tabla = "Instituciones"
                                    End If
                                End If
                            End If
                        End If
                    End If
                End If
            End If
        End If
        
    End If
    End If
    End If
    End If


End Sub
Sub llena_listado_qextra()

ActiveWorkbook.Unprotect (dgaex)
If Sheets("Query").Visible = False Then Sheets("Query").Visible = True

    Dim listado(5)
    
        listado(0) = "QExtra1"
        listado(1) = "QExtra2"
        listado(2) = "QExtra3"
        listado(3) = "QExtra4"
        listado(4) = "QExtra5"
        listado(5) = "QExtra6"
    ThisWorkbook.Sheets("Query").Activate
    Set combo = ThisWorkbook.Sheets("Query").QExtra

    combo.List = listado

If Sheets("Query").Visible = True Then Sheets("Query").Visible = False
ActiveWorkbook.Protect (dgaex), Structure:=True


End Sub

Sub tabla_fija_a_listar(entabla)
    
    If UCase(listar_tabla_estados) = "S" Then
        entabla = "TESTADOS"
        GoTo FIN
    End If
    
    If UCase(listar_tabla_municipios) = "S" Then
        entabla = "TMUNICIPIOS"
        GoTo FIN
    End If
    
    'If UBound(listar_tabla_instituciones) = "S" Then
    '    entabla = "Instituciones"
    '    GoTo FIN
    'End If
    
    If UCase(listar_tabla_conceptos) = "S" Then
        entabla = "TCONCEPTOS"
        GoTo FIN
    End If

FIN:

End Sub

Sub lista_en_columna_AyB(columnaA, columnaB, tabla, orden)

    If tabla = "TMUNICIPIOS" Then
        ThisWorkbook.Sheets("BD").PivotTables("TMUNICIPIOS").PivotFields("cve_estado").CurrentPage = estado_para_municipios
    End If


    Set pvttable = ThisWorkbook.Sheets("BD").PivotTables(tabla)

    rangotabla = pvttable.TableRange1
    renglones = UBound(rangotabla)

    j = 0
    ReDim arreglo(renglones - 4, 1)
    ThisWorkbook.Sheets(hojaprincipal).Select
    Range(posicion).Select
        Call selecciona_columna(a, b, c)
        d = Range(b).Offset(1, 1).Address
        
    Range(a, d).Delete

    Range(posicion).Select
    
    For i = 3 To renglones
        Selection.Offset(i - 3, 0).NumberFormat = "@"
        Selection.Offset(i - 3, 0) = rangotabla(i, 2) ' Columna A
        Selection.Offset(i - 3, 1) = rangotabla(i, 1) ' Columna B
        j = j + 1
    Next

    Call selecciona_columna(a, b, c)
        Range(b).Offset(1, 1).Value = "Total"
        
        Range(a, d).Select
        Selection.Font.Bold = False
        
        Range(b).Offset(1, 1).Font.Bold = True

        Range(posicion).Offset(i - 3, 1).Select
       
End Sub



Sub maxima_columna_en_10_lineas(max, lineas_en_encabezado)
'Reducir - Hacer eficiente
Dim linea(9)

    muevete_hasta_y_regresa ("IV1")
        linea(0) = ActiveCell.Column
    muevete_hasta_y_regresa ("IV2")
        linea(1) = ActiveCell.Column
    muevete_hasta_y_regresa ("IV3")
        linea(2) = ActiveCell.Column
    muevete_hasta_y_regresa ("IV4")
        linea(3) = ActiveCell.Column
    muevete_hasta_y_regresa ("IV5")
        linea(4) = ActiveCell.Column
    muevete_hasta_y_regresa ("IV6")
        linea(5) = ActiveCell.Column
    muevete_hasta_y_regresa ("IV7")
        linea(6) = ActiveCell.Column
    muevete_hasta_y_regresa ("IV8")
        linea(7) = ActiveCell.Column
    muevete_hasta_y_regresa ("IV9")
        linea(8) = ActiveCell.Column
    muevete_hasta_y_regresa ("IV10")
        linea(9) = ActiveCell.Column

    Call saca_el_maximo(linea, max)
    Call saca_el_numero_de_lineas_en_encabezado(linea, lineas_en_encabezado)

End Sub
Sub saca_el_numero_de_lineas_en_encabezado(arreglo, lineas_en_encabezado)

    lineas_en_encabezado = 0
    For X = 0 To 6
        If arreglo(X) = arreglo(X + 2) And arreglo(X + 1) = 1 Then
            lineas_en_encabezado = X + 1
            Exit For
        End If
    Next

End Sub

Sub saca_el_maximo(arreglo, max)

    max = 0
    For X = 0 To 9
        If max < arreglo(X) Then max = arreglo(X)
    Next

End Sub
Sub muevete_hasta_y_regresa(celda_linea)
    ActiveSheet.Range(celda_linea).Select
    Selection.End(xlToLeft).Select
End Sub

Sub tomar_todos_los_datos_de_la_tabla_hacia_abajo(resultados, totales)

    rangotabla1 = ThisWorkbook.Sheets("BD").PivotTables("TR01").TableRange1
    renglones1 = UBound(rangotabla1)
    columnas1 = UBound(rangotabla1, 2)
    
        'CDCS
        quitar_columnas = Range("Query!B29").Value
        quitar_columnas_der = Range("Query!C29").Value
    
    
    
    'Nuevo Arreglo
    ReDim datos_a_pintar(renglones1 - 2, columnas1 - quitar_columnas - quitar_columnas_der - 1)
    
    For cols = 0 To columnas1 - quitar_columnas - quitar_columnas_der - 1
        For lineas = 0 To renglones1 - 3
            datos_a_pintar(lineas, cols) = rangotabla1(lineas + 3, cols + 1 + quitar_columnas)
            'CDCS
'            datos_a_pintar(lineas, cols) = rangotabla1(lineas + 3, cols + 1 + quitar_columnas - quitar_columnas_der)
            
            If formatocol(cols, 3) <> "" And UCase(formatocol(cols, 3)) <> "SUMA" Then
                If ya_se_busco_un_dato = 1 Then
                    If datos_a_pintar(lineas, cols) = dato_cambiado Then
                        datos_a_pintar(lineas, cols) = dato_nuevo
                        cambio = 1
                    Else
                        cambio = 0
                    End If
                End If
                
                If cambio = 0 Then
                    If datos_a_pintar(lineas, cols) <> "" Then
                    'CDCS
'                        Call cambiar_dato(rang otabla1(lineas + 3, cols + 1 + quitar_columnas + quitar_columnas_der), formatocol(cols, 3), dato_nuevo)
                        Call cambiar_dato(rangotabla1(lineas + 3, cols + 1 + quitar_columnas), formatocol(cols, 3), dato_nuevo)
                            dato_cambiado = rangotabla1(lineas + 3, cols + 1 + quitar_columnas + quitar_columnas_der)
                            datos_a_pintar(lineas, cols) = dato_nuevo
                                ya_se_busco_un_dato = 1
                                cambio = 0
                    End If

                End If
            End If

        Next
    Next
   
    Range(Range(posicion2), Range(posicion2).Offset(renglones1 - 3, columnas1 - quitar_columnas - quitar_columnas_der - 1)).Select
    Range(Range(posicion2), Range(posicion2).Offset(renglones1 - 3, columnas1 - quitar_columnas - quitar_columnas_der - 1)).Value = datos_a_pintar

    Range(posicion2).Offset(0, columnas1 - quitar_columnas - quitar_columnas_der).Select
    posicion2 = ActiveCell.Address

    
End Sub
Sub cambiar_dato(dato_original, tabla, dato_nuevo)


    D_O = "" & dato_original
    Dat = ThisWorkbook.Sheets("BD").PivotTables(tabla).TableRange1
                reng = UBound(Dat)
                l = 0
                encontrado = False

                    Do Until encontrado
                            clave = D_O
                            If clave <> "" Then
                                For n = 3 To reng
'                                    contra = "" & Dat(n, 1)
                                    
                                    If clave = "" & Dat(n, 1) Then
                                        dato_nuevo = Dat(n, 2)
                                        encontrado = True
                                        Exit For
                                    End If
                                    'El dato no se encontro
                                    If n = reng Then
                                        'Marca el dato con la leyenda N/D - No dispobible
                                            dato_nuevo = "N/D"
                                        encontrado = True
                                    End If

                                Next n
                            End If
                        l = l + 1
                    Loop

End Sub

Sub cambiar_cve_de_columna_B(posicion_columna, tabla, hoja_de_la_tabla, hoja_de_trabajo, tipo_cadena)

ThisWorkbook.Sheets(hoja_de_trabajo).Activate
Range(posicion_columna).Select

Call selecciona_columna(a, b, c)
FIN = Range(b).Offset(1, 0).Address

Range(a).Select

        Do Until ActiveCell.Address = FIN

            If ActiveCell.Value <> "" Then
                Dat = ThisWorkbook.Sheets(hoja_de_la_tabla).PivotTables(tabla).TableRange1
                reng = UBound(Dat)
                l = 0

                    Do Until ActiveCell.Address = FIN
                            If tipo_cadena = "alfanumerica" Then
                                clave = "0" & ActiveCell.Value
                            Else
                                clave = ActiveCell.Value
                            End If
                            If clave <> "" Then
                                For n = 3 To reng
                                    If clave = Dat(n, 3) Then
                                        ActiveCell.Value = Dat(n, 2)
                                        Exit For
                                    End If
                                Next n
                            End If
                        l = l + 1

                        ActiveCell.Offset(1, 0).Select
                    Loop
            End If
            
        Loop

    Range(a).Select
    
End Sub
'Sub encabezado_vertical()
'    'pintar las columnas del encabezado sin cves
'        posicion_encabezado = Range(posicion).Offset(-renglones_encabezado, columna_inicial - 1).Address
'        borra_hasta (posicion_encabezado)
'
'        Worksheets("Formato").Activate
'        Range("A1").Offset(cves_encabezado, 0).Select
'
'        'Range(Cells(9, columna_inicial), Cells(9 + renglones_encabezado - 2, columna_inicial + total_de_columnas - 1)).Select
'        'range(range("A1").Offset(cves_encabezado
'
'        Range(Selection, Selection.End(xlToRight)).Select
'        Range(Selection, Selection.End(xlDown)).Select
'
'            Selection.Copy
'        Sheets(hojaprincipal).Select
'            ActiveSheet.Paste
'
'
'
'        For p = cves_encabezado To renglones_encabezado - 1
'                'p es el valor que se asigna al renglon donde estan los datos (no claves)
'                Call obtiene_encabezado(p, valor, total_de_columnas, j, i, num_combo, conteo)
'        Next p
'    'pintar las columnas del encabezado sin cves
'
'
'
'End Sub

Sub click_genera()

 Application.ScreenUpdating = False
 
    Worksheets(hojaprincipal).Activate
    Range("C6").FormulaR1C1 = ""

    obtienearreglos
    
    If valida_num_columnas = False Then
        Errores_generales
        GoTo FIN
    End If

    con_totales = Range("Query!A29").Value
    'Listar Tabla de Query Extra en la Columna B
    'Se debe de dar la CVE, El DL, la Tabla que se esta usando y el orden en la columna B
    If listar_combo1en_b <> "" Or listar_combo2en_b <> "" Or listar_combo3en_b <> "" Or listar_combo4en_b <> "" Then
        Call ListadoDeDatos(arrCombo1, arrCombo2, arrCombo3, arrCombo4, con_totales)
    End If

        Call llena_Hojas

    If cerrado = 1 Then
        Bloquea
    End If
GoTo FIN
ERRORES:

MsgBox "Tiene problemas para presentar la informaci|fffd|n"
        Bloquea

FIN:

End Sub


Sub valores_a_pintar_para_comisionistas(avanza_cols_encabezado)

    If valida_num_columnas = False Then
        Errores_generales
        GoTo FIN
    End If

    If numero_de_combos_activos > 0 Then
        Call revisa_combos_asigna_valores(TCPB, TCP, BLO)

        Pintar = BLO
        
        EA = TCPB
        en_combo = 1
        STCP = TCP
        BLOAP = TCP
        BLOS = TCP / columnas_encabezado

'ARREGLO CON VALORES A PINTAR ACVP
    ReDim ACVP(numero_de_combos_activos - 1, TCP - 1)
    ReDim pintar_cves_en_el_encabezado(numero_de_combos_activos - 1, TCP - 1)
'Variables que tiene los datos para Avanzar en el pintado del encabezado
    ReDim avanza_cols_encabezado(numero_de_combos_activos - 1)
    
    ReDim ACNP(numero_de_combos_activos - 1)
'ARREGLO CON CVES QUE LLEVA EL ENCABEZADO Y SU RESE|fffd|A (SI SE PINTA O SE ELIMINA)
    ReDim quitar_cve(numero_de_combos_activos)


For repeticiones = 0 To numero_de_combos_activos - 1
    encontrado = False
Do Until encontrado

        Call define_combo(en_combo, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)

                dat_enc = cves_encabezado - repeticiones - 1
                dat_enc_ingresando = 0
                contando = 0
                If dat_enc < 0 Then
                    GoTo ERROR_EN_CVES
                End If
                
                If datos_en_encabezado(dat_enc) = cvecombo Then

                    'If listar <> "" Then quitar_cve(dat_enc) = "eliminar"

                    ACNP(dat_enc) = cvecombo
                    avanza = (TCP / BLOS)
                        'Asignar el n|fffd|mero de posiciones a desplazar cada T|fffd|tulo
                        avanza_cols_encabezado(dat_enc) = avanza
                    
                        'Asignar el n|fffd|mero de posiciones a desplazar cada T|fffd|tulo
                        salir = False
                                            Do Until salir
                            
                                                For NE = 0 To elementos_en_combo - 1
                                                        ACVP(dat_enc, siguiente) = arreglo(posicion_en_el_arreglo, 1)
                                                            siguiente = siguiente + avanza
                                                                        If avanza >= 1 Then
                                                                        'If avanza > 1 Then
                                                                            For ingresando = 0 To avanza - 1
                                                                                ACVP(dat_enc, dat_enc_ingresando) = arreglo(posicion_en_el_arreglo, 1)
                                                                                pintar_cves_en_el_encabezado(dat_enc, dat_enc_ingresando) = arreglo(posicion_en_el_arreglo, 0)
                                                                                dat_enc_ingresando = dat_enc_ingresando + 1
                                                                                contando = contando + 1
                                                                            Next
                                                                        End If
                            
                                                        posicion_en_el_arreglo = posicion_en_el_arreglo + 1
                                                Next
                                                posicion_en_el_arreglo = 0
                                                If siguiente >= TCP Then
                                                    salir = True
                                                End If
                                            Loop
                    BLOS = BLOS / elementos_en_combo
                    encontrado = True
                    
                Else
                    If en_combo > 5 Then
ERROR_EN_CVES:
                        MsgBox "Error en valores de Combos / Claves para pintar incorrectas / Revisar hoja de Formato"
                        Exit Do
                    Else
                        en_combo = en_combo + 1
                    End If
                End If

Loop

en_combo = 1
siguiente = 0

Next

revisando = ACVP
revisando1 = pintar_cves_en_el_encabezado
revisando_otro = avanza_cols_encabezado

    End If
    
FIN:
End Sub

Sub archivo_formato(archivo, nombre_archivo, tipo_archivo)

    archivo = ActiveWorkbook.Name
        posici|fffd|n = InStrRev(archivo, ".")
        tama|fffd|o = Len(archivo)
    nombre_archivo = Left(archivo, posici|fffd|n - 1)
    tipo_archivo = Right(archivo, tama|fffd|o - posici|fffd|n)

End Sub

Sub ultimafechaactualizacion(formato, idioma)

'formato = 1
'    Cadena DATIME = 0
'    Cadena MES EXPANDIDO = 1
'idioma = 0
'    Cadena en espa|fffd|ol = 0
'    Cadena en ingles = 1

On Error GoTo conError

                '*********************************************************************
                'Revisa el Nombre y Tipo de Archivo
                '*********************************************************************
                    Call archivo_formato(rep_ingresar, nombre_archivo, tipo_archivo)
                '*********************************************************************

    'DATOS PARA CONEXI|fffd|N
        Set MiConexion = New ADODB.Connection
        Call lee(st_linea, db_donde, numero_de_lineas)
        MiConexion.ConnectionString = "" & db_donde

        'MiConexion.ConnectionString = "DSN=destecnica;UID=procesos_dgaex;PWD=Xeagd!;DB=dbdgaex;ApplicationName=DBISQL"
        'MiConexion.ConnectionString = "DSN=destecnica;UID=idex8068;PWD=ex8068;DB=dbdgaex;ApplicationName=DBISQL"
        MiConexion.Open
        MiConexion.CommandTimeout = 0

Sheets(hojaprincipal).Select

'*********************************************************************
'Armado del Query, Ejecuta el Query y Acomoda la Tabla Din|fffd|mica
'*********************************************************************
    TR01 = "exec sp_fecha_actualizacion '" & nombre_archivo & "'"
    TR01 = TR01 & "," & formato & "," & idioma
        Set miTR01 = MiConexion.Execute(TR01)

        'Set miTR01 = MiConexion.Execute("exec sp_fecha_actualizacion '013_1a_R2',1,0")

        Range("M2").CopyFromRecordset miTR01

    'Acomoda la Etiqueta de la Fecha de Actualizaci|fffd|n
    acom_fecha

    Selection.Characters.Text = "Fecha de Actualizaci|fffd|n: " & Range("M2").Value
        Range("M2").Value = ""
    'Selection.Characters.Text = "Fecha de Actualizaci|fffd|n: " & Format(Date, "dd mmmm yyyy")

    MiConexion.Close
'*********************************************************************

    Sheets("BD").Select

GoTo FIN:

conError:

    ActiveSheet.Shapes("fechaactualizacion").Select
    Selection.Characters.Text = "Fecha de Actualizaci|fffd|n: "

FIN:

End Sub
Sub tamcombo_combos()

    activocombo1 = Range("Query!C4").Value
    activocombo2 = Range("Query!E4").Value
    activocombo3 = Range("Query!G4").Value
    activocombo4 = Range("Query!I4").Value

        hacia_abajo_combo = 87.75 + 16
        altura = 44
        ancho = 170
        
        hojaprincipal = ActiveSheet.Name
        
    If activocombo1 <> "" Then
        ActiveSheet.Shapes("ListBoxCombo1").Select
        Selection.ShapeRange.LockAspectRatio = msoFalse
        Selection.ShapeRange.Height = 300
        Selection.ShapeRange.Width = 300
        
        Call acomoda_forma(hojaprincipal, "ListBoxCombo1", altura, ancho, hacia_abajo_combo, 90)
'            Range("B2000").Select
    End If
    
    If activocombo2 <> "" Then
        ActiveSheet.Shapes("ListBoxCombo2").Select
        Selection.ShapeRange.LockAspectRatio = msoFalse
        Selection.ShapeRange.Height = 300
        Selection.ShapeRange.Width = 300
        
            Call acomoda_forma(hojaprincipal, "ListBoxCombo2", altura, ancho, hacia_abajo_combo, 270)
'            Range("B2000").Select
    End If

    If activocombo3 <> "" Then
        ActiveSheet.Shapes("ListBoxCombo3").Select
        Selection.ShapeRange.LockAspectRatio = msoFalse
        Selection.ShapeRange.Height = 300
        Selection.ShapeRange.Width = 300
        
        Call acomoda_forma(hojaprincipal, "ListBoxCombo3", altura, ancho, hacia_abajo_combo, 450)
'            Range("B2000").Select
    End If

    If activocombo4 <> "" Then
        ActiveSheet.Shapes("ListBoxCombo4").Select
        Selection.ShapeRange.LockAspectRatio = msoFalse
        Selection.ShapeRange.Height = 300
        Selection.ShapeRange.Width = 300
        Call acomoda_forma(hojaprincipal, "ListBoxCombo4", altura, ancho, hacia_abajo_combo, 630)
'            Range("B2000").Select
    End If
    
    ActiveWindow.SmallScroll ToRight:=3
    ActiveWindow.SmallScroll ToLeft:=3
    ActiveWindow.SmallScroll Down:=3
    ActiveWindow.SmallScroll Up:=3

    
End Sub



Sub arreglo_de_datos_en_combos(DC)
'Sub arreglo_de_datos_en_combos()


    'Esta Subrutina solo se debe de correr despu|fffd|s de tener los combos llenos
    'Arreglo principal con datos de los combos
    Dim arreglo_info_combos(7, 3)
    numero_de_combos_activos = 0

    'Toma la informaci|fffd|n para N|fffd|mero de Combo, Activo y Cve de Combo
        For X = 0 To 3
                arreglo_info_combos(1, X) = Range("Query!A4").Offset(0, Y + 2).Value
                
                If arreglo_info_combos(1, X) <> "" Then
                    arreglo_info_combos(2, X) = Range("Query!A6").Offset(0, Y + 2).Value
                    arreglo_info_combos(0, X) = X + 1
                End If
            Y = Y + 2
        Next
'**************************************************************************
    'Define las CVEs a pintar en el encabezado
    renglones_avanza = 0
    posibilidades_en_encabezado = 9
    ReDim datos_en_encabezado(posibilidades_en_encabezado)

            Sheets("Formato").Activate

    Do Until ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 0).Value = "" And ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 1).Value = "" And ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 2).Value = ""
        datos_en_encabezado(renglones_avanza) = ThisWorkbook.Sheets("Formato").Range("a1").Offset(renglones_avanza, 0).Value

                    linea_cve = Left(datos_en_encabezado(renglones_avanza), 3)

                        If linea_cve = "cve" Then
                            cves_encabezado = cves_encabezado + 1
                            'Identifica el Combo
                            For X = 0 To 3
                                If arreglo_info_combos(2, X) = datos_en_encabezado(renglones_avanza) Then
                                    arreglo_info_combos(3, X) = renglones_avanza + 1
                                Exit For
                                End If
                            Next

                        End If
    renglones_avanza = renglones_avanza + 1
    Loop
'**************************************************************************
    arreglo_info_combos(4, 0) = numero_de_datos_en_combo1
    arreglo_info_combos(4, 1) = numero_de_datos_en_combo2
    arreglo_info_combos(4, 2) = numero_de_datos_en_combo3
    arreglo_info_combos(4, 3) = numero_de_datos_en_combo4

DC = arreglo_info_combos

End Sub

Sub sacar_arreglo_de_datos_en_combo(numero_de_datos_en_combos)

        Dim a(3, 2)

        a(0, 0) = numero_de_datos_en_combo1
        a(1, 0) = numero_de_datos_en_combo2
        a(2, 0) = numero_de_datos_en_combo3
        a(3, 0) = numero_de_datos_en_combo4
        a(0, 1) = cvecombo1
        a(1, 1) = cvecombo2
        a(2, 1) = cvecombo3
        a(3, 1) = cvecombo4

numero_de_datos_en_combos = a


End Sub

Sub ordenar(celda_inicial, num_cols)

Range(celda_inicial).Select


Call selecciona_columna(a, b, c)

Range(a).Select
'selecciona todo el rango

'        Range(Range(a).Offset(0, 0), Range(b).Offset(0, num_cols - 1)).Select

                    orden = xlAscending
                    hoja = "MINFO"
    ActiveWorkbook.Worksheets(hoja).Sort.SortFields.Clear
                    
        For X = 0 To num_cols - 1
            If formatocol(X, 3) <> "" Then

                    'Extrae la Letra de la posici|fffd|n de la Celda
                    posici|fffd|n = InStrRev(a, "$")
                    tama|fffd|o_de_palabra = Len(a)
                    columna_a = Left(a, posici|fffd|n - 1)
                    posici|fffd|n = InStrRev(columna_a, "$")
                    tama|fffd|o_de_palabra = Len(columna_a)
                    columna_a = Right(columna_a, tama|fffd|o_de_palabra - posici|fffd|n)
                    rango = "" & columna_a & Range(a).Row & ":" & columna_a & Range(b).Row
                    
                    ActiveWorkbook.Worksheets(hoja).Sort.SortFields.Add Key:=Range(rango) _
                        , SortOn:=xlSortOnValues, Order:=orden, DataOption:=xlSortNormal

            End If
        Next

    posici|fffd|n = InStrRev(a, "$")
            tama|fffd|o_de_palabra = Len(a)
    columna1 = Left(a, posici|fffd|n - 1)
    posici|fffd|n = InStrRev(columna1, "$")
            tama|fffd|o_de_palabra = Len(columna1)
    columna1 = Right(columna1, tama|fffd|o_de_palabra - posici|fffd|n)

    uc = Range(a).Offset(0, num_cols - 1).Address

    posici|fffd|n = InStrRev(uc, "$")
            tama|fffd|o_de_palabra = Len(uc)
    columna2 = Left(uc, posici|fffd|n - 1)
    posici|fffd|n = InStrRev(columna2, "$")
            tama|fffd|o_de_palabra = Len(columna2)
    columna2 = Right(columna2, tama|fffd|o_de_palabra - posici|fffd|n)

    nrango = "" & columna1 & Range(a).Row & ":" & columna2 & Range(b).Row

    Range(Range(a).Offset(0, 0), Range(b).Offset(0, num_cols - 1)).Select
    
            With ActiveWorkbook.Worksheets("MINFO").Sort
                .SetRange Range(nrango)
                .Header = xlYes
                .MatchCase = False
                .Orientation = xlTopToBottom
                .SortMethod = xlPinYin
                .Apply
            End With

End Sub

Sub todo_a_TRUE_en_el_PIVOT(tabla, campo, datos)


    ThisWorkbook.Worksheets("BD").PivotTables(tabla).PivotFields(campo).CurrentPage = _
        "(All)"
        'Se pone como TRUE el primer valor que se escogio del COMBO que se esta usando
            elementos_en_el_Combo = UBound(datos)
    Set pivot = ThisWorkbook.Worksheets("BD").PivotTables(tabla)
    
    'Pone los valores en FALSE y solo deja el primer elemento del COMBO que se esta usando
    For Each pvtitem In pivot.PivotFields(campo).PivotItems
            pvtitem.Visible = True
    Next

End Sub


Sub primer_valor_TRUE_en_el_PIVOT(tabla, campo, datos)


    ThisWorkbook.Worksheets("BD").PivotTables(tabla).PivotFields(campo).CurrentPage = _
        "(All)"

'    elementos_en_el_Combo = UBound(datos)
    
    Set pivot = ThisWorkbook.Worksheets("BD").PivotTables(tabla)

    For Each pvtitem In pivot.PivotFields(campo).PivotItems
        ThisWorkbook.Sheets("BD").PivotTables("TR01").PivotFields(campo).CurrentPage = pvtitem.Name
        Exit For
    Next

End Sub



Sub Manda_variosDatos_a_Tabla(tabla, campo, datos)


    ThisWorkbook.Worksheets("BD").PivotTables(tabla).PivotFields(campo).CurrentPage = _
        "(All)"
        'Se pone como TRUE el primer valor que se escogio del COMBO que se esta usando
        ThisWorkbook.Sheets("BD").PivotTables("TR01").PivotFields(campo).PivotItems(datos(0, 1)).Visible = True
        
            elementos_en_el_Combo = UBound(datos)
        
    Set pivot = ThisWorkbook.Worksheets("BD").PivotTables(tabla)
    
    'Pone los valores en FALSE y solo deja el primer elemento del COMBO que se esta usando
    For Each pvtitem In pivot.PivotFields(campo).PivotItems
        dato_pivot = "" & pvtitem
        dato_revisar = "" & datos(0, 1)
        If dato_pivot <> dato_revisar Then
            pvtitem.Visible = False
        End If
        n_datos = n_datos + 1
    Next
    
    'Pone en TRUE los valores que se escogier|fffd|n del COMBO que se esta usando
    For X = 0 To elementos_en_el_Combo
        ThisWorkbook.Sheets("BD").PivotTables("TR01").PivotFields(campo).PivotItems(datos(X, 1)).Visible = True
    Next

End Sub

Sub pinta_solo_encabezado_de_columnas()

    For p = 0 To renglones_encabezado - 1
    'p es el valor que se asigna al renglon donde estan los datos (no claves)
        pintado_formato = True
        Call obtiene_encabezado(p, valor, total_de_columnas, j, i, num_combo, conteo)
        
    Next p

End Sub







Attribute VB_Name = "FrmContrasena"
Attribute VB_Base = "0{47E3A1C6-2516-4FBD-B330-25A9AE975AB0}{A9C97A3F-CD19-4BED-9904-E13105917FCC}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub CmdAceptar_Click()

Dim st_linea As String

Call lee(st_linea, db_donde, numero_de_lineas)

    If FrmContrasena.tbPass.Value = st_linea Then
        FrmContrasena.Hide
        Call Actualiza_TD
    Else
        If FrmContrasena.tbPass.Value = st_linea Then
            FrmContrasena.Hide
            Call desBloquea
                inicializa
        Else
        
        MsgBox "Su contrase|fffd|a es incorrecta, por favor intentelo de nuevo", 0, "Error"
        FrmContrasena.tbPass.Value = ""
        FrmContrasena.tbPass.SetFocus
        End If
    End If
End Sub


Private Sub UserForm_Click()

End Sub

Private Sub verQuerys_Click()

Application.ScreenUpdating = False

Dim st_linea As String

Call lee(st_linea, db_donde, numero_de_lineas)

    If FrmContrasena.tbPass.Value = st_linea Then
        FrmContrasena.Hide
        Call desBloquea
            inicializa
    Else
    
        MsgBox "Su contrase|fffd|a es incorrecta, por favor intentelo de nuevo", 0, "Error"
        FrmContrasena.tbPass.Value = ""
        FrmContrasena.tbPass.SetFocus
        
        
    End If
    
Application.ScreenUpdating = True

End Sub

Private Sub CmdCancelar_Click()
    End
End Sub




Attribute VB_Name = "Hoja1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "ListBoxCombo2, 5938, 0, MSForms, ListBox"
Attribute VB_Control = "cmd_Aceptar, 5936, 1, MSForms, CommandButton"
Attribute VB_Control = "ListBoxCombo1, 5937, 2, MSForms, ListBox"
Attribute VB_Control = "ListBoxCombo3, 5939, 3, MSForms, ListBox"
Attribute VB_Control = "ListBoxCombo4, 5940, 4, MSForms, ListBox"
Attribute VB_Control = "SpinButton1, 17251, 5, MSForms, SpinButton"
Attribute VB_Control = "CB1, 20697, 6, MSForms, ToggleButton"
Attribute VB_Control = "CB2, 20698, 7, MSForms, ToggleButton"
Attribute VB_Control = "CB3, 20699, 8, MSForms, ToggleButton"
Attribute VB_Control = "CB4, 20700, 9, MSForms, ToggleButton"
Sub Cmd_Aceptar_Click()

Application.ScreenUpdating = False
        inicializando = "SI"
        ActiveWindow.FreezePanes = False

'On Error GoTo ERRORES

        desBloquea
        
        inicializa
        
    click_genera
        Bloquea

GoTo FIN
ERRORES:

MsgBox "Tiene problemas para presentar la informaci|fffd|n"
    If Sheets("Formato").Visible <> False Then
        Bloquea
    End If

FIN:

    tamcombo
    
        inicializando = "NO"
    Application.ScreenUpdating = True
    
    Range(posicion).Offset(2, 2).Select
End Sub
Private Sub ListBoxCombo1_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single)
    cambiocombo
End Sub
Private Sub ListBoxCombo2_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single)
    cambiocombo
End Sub
Private Sub ListBoxCombo3_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single)
    cambiocombo
End Sub
Private Sub ListBoxCombo4_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single)
    cambiocombo
End Sub
Sub cambiocombo()
    ThisWorkbook.Sheets(1).Range("C6").FormulaR1C1 = "La Informaci|fffd|n mostrada no corresponde con las opciones seleccionadas"
    Range("C6").Font.Bold = True
End Sub


Private Sub SpinButton1_Change()

Application.ScreenUpdating = False


Select Case SpinButton1.Value
    Case 0
    valor = ""
    Case 1
    valor = "Montos en pesos"
    Case 2
    valor = "Montos en miles de pesos"
    Case 3
    valor = "Montos en millones de pesos"
    Case 4
    valor = "Montos en miles de millones de pesos"
End Select

ActiveSheet.Shapes("TextodeMonedas").Select
Selection.Characters.Text = "" & valor

    spin

    tamcombo

Application.ScreenUpdating = True

End Sub
Private Sub CB1_Click()

If Estado_actual <> 2 Then Application.ScreenUpdating = False

    inicializa
    selecciona_todo = True
    If CB1.Value = True Then
        Call llena_combo(1, 1)
    Else
        Call llena_combo(1, 2)
    End If
    
    tamcombo
    
If Estado_actual <> 2 Then Application.ScreenUpdating = True

End Sub
Private Sub CB2_Click()

If Estado_actual <> 2 Then Application.ScreenUpdating = False


    inicializa
    selecciona_todo = True
    If CB2.Value = True Then
        Call llena_combo(2, 1)
    Else
        Call llena_combo(2, 2)
    End If
    
    tamcombo
    
If Estado_actual <> 2 Then Application.ScreenUpdating = True

End Sub
Private Sub CB3_Click()

If Estado_actual <> 2 Then Application.ScreenUpdating = False

    inicializa
    selecciona_todo = True
    If CB3.Value = True Then
        Call llena_combo(3, 1)
    Else
        Call llena_combo(3, 2)
    End If
    
    tamcombo
    
If Estado_actual <> 2 Then Application.ScreenUpdating = True


End Sub
Private Sub CB4_Click()

If Estado_actual <> 2 Then Application.ScreenUpdating = False
    
    
    inicializa
    selecciona_todo = True
    If CB4.Value = True Then
        Call llena_combo(4, 1)
    Else
        Call llena_combo(4, 2)
    End If
    
    tamcombo
    
If Estado_actual <> 2 Then Application.ScreenUpdating = True

End Sub

Private Sub Worksheet_Activate()

    If inicializando <> "SI" Then
    Application.ScreenUpdating = False
    tamcombo_combos
                    Range("B7").Select
    
    Application.ScreenUpdating = True

    
    End If

End Sub

Attribute VB_Name = "Hoja123"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Hoja3"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "CommandButton1, 3380, 2, MSForms, CommandButton"
Attribute VB_Control = "Filtros, 4315, 3, MSForms, CommandButton"
Private Sub CommandButton1_Click()
    
    FrmContrasena.Show
    
End Sub

    

Private Sub Filtros_Click()

Application.ScreenUpdating = False
    Call proceso_abrir_libro
Application.ScreenUpdating = True

End Sub

Attribute VB_Name = "Hoja4"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Worksheet_Change(ByVal Target As Range)
Application.ScreenUpdating = False

                                inicializa
            
    For X = 0 To columnas_encabezado - 1

            Select Case UCase(formatocol(X, lin))
                Case "M"
                    mostrar_spin = 1
            End Select
    Next
    If mostrar_spin > 0 Then
        ActiveSheet.Shapes("SpinButton1").Visible = True
        ActiveSheet.Shapes("TextodeMonedas").Visible = True
    Else
        ActiveSheet.Shapes("SpinButton1").Visible = False
        ActiveSheet.Shapes("TextodeMonedas").Visible = False
    End If

'HOJA DE CALIDAD
si_no ("B27")
If valor_error <> "" Then GoTo Error

    exportar = Range("Query!A3").Value

    If UCase(exportar) <> "EXPORTAR" Then
        If UCase(exportar) <> "" Then
            valor_error = 6
    End If
    End If


'COMBO 1
If UCase(activocombo1) = "S" Then
    Call tipo_seleccion("Query!C4", "CB1", "ListBoxCombo1", "TextoCombo1", 1)
        If valor_error <> "" Then GoTo Error
        
            If UCase(activocombo2) = "S" Then
                Call tipo_seleccion("Query!E4", "CB2", "ListBoxCombo2", "TextoCombo2", 2)
                    If valor_error <> "" Then GoTo Error
                    
                        If UCase(activocombo3) = "S" Then
                            Call tipo_seleccion("Query!G4", "CB3", "ListBoxCombo3", "TextoCombo3", 3)
                                If valor_error <> "" Then GoTo Error

                                    If UCase(activocombo4) = "S" Then
                                        Call tipo_seleccion("Query!I4", "CB4", "ListBoxCombo4", "TextoCombo4", 4)
                                    Else
                                            si_no ("Query!I4")
                                            If valor_error <> "" Then GoTo Error
                                        Call oculta_combo("CB4", "ListBoxCombo4", "TextoCombo4", 4)
                                    End If
                        Else
                                si_no ("Query!G4")
                                If valor_error <> "" Then GoTo Error
                            Call oculta_combo("CB3", "ListBoxCombo3", "TextoCombo3", 3)
                            Call oculta_combo("CB4", "ListBoxCombo4", "TextoCombo4", 4)
                        End If
            Else
                    si_no ("Query!E4")
                    If valor_error <> "" Then GoTo Error
                Call oculta_combo("CB2", "ListBoxCombo2", "TextoCombo2", 2)
                Call oculta_combo("CB3", "ListBoxCombo3", "TextoCombo3", 3)
                Call oculta_combo("CB4", "ListBoxCombo4", "TextoCombo4", 4)
            End If
Else

        si_no ("Query!C4")
        If valor_error <> "" Then GoTo Error
    Call oculta_combo("CB1", "ListBoxCombo1", "TextoCombo1", 1)
    Call oculta_combo("CB2", "ListBoxCombo2", "TextoCombo2", 2)
    Call oculta_combo("CB3", "ListBoxCombo3", "TextoCombo3", 3)
    Call oculta_combo("CB4", "ListBoxCombo4", "TextoCombo4", 4)

End If

GoTo FIN

Error:
Select Case valor_error
    Case 1
        MsgBox "El tipo de Selecci|fffd|n no esta permitido, debe de ser SIMPLE / MULTIPLE"
        GoTo FIN
    Case 2
        MsgBox "Selecci|fffd|n invalida para Mostrar Hoja de Calidad"
    Case 3
        MsgBox "El tipo de Selecci|fffd|n no esta permitido, debe de ser S / N"
    Case 4
        MsgBox "El tipo de Selecci|fffd|n no esta permitido, debe de ser ASCENDENTE / DESCENDENTE"
    Case 5
        MsgBox "El tipo de Selecci|fffd|n no esta permitido, debe de ser ALFANUMERICO / NUMERICO"
    Case 6
        MsgBox "El tipo de Selecci|fffd|n no esta permitido, debe de ser EXPORTAR"

End Select

FIN:
    Sheets("Query").Activate
    Application.ScreenUpdating = True

End Sub


Sub tipo_seleccion(rango, boton_all, combo, texto, numero_de_combo)

If Range(rango).Value <> "" Then

    si_no (rango)
    
    If valor_error <> "" Then GoTo FIN
    
        ActiveWorkbook.Sheets(hojaprincipal).Shapes(combo).Visible = True
        ActiveWorkbook.Sheets(hojaprincipal).Shapes(texto).Visible = True
        ActiveWorkbook.Sheets(hojaprincipal).Shapes(boton_all).Visible = True
        
        ActiveWorkbook.Sheets(hojaprincipal).Shapes(texto).Select
        Selection.Text = "" & Range(rango).Offset(4, 0).Value
        ActiveSheet.Range("B7").Select
    
        'combo_a_usar = combo
    
        Call define_combo(numero_de_combo, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)
            'SIMPLE / MULTIPLE
            If UCase(Range(rango).Offset(1, 0).Value) = "SIMPLE" Then
                combo.MultiSelect = fmMultiSelectSingle
                ActiveSheet.Shapes(boton_all).Visible = False
                Else
                       If UCase(Range(rango).Offset(1, 0).Value) = "MULTIPLE" Then
                            combo.MultiSelect = fmMultiSelectMulti
                            ActiveSheet.Shapes(boton_all).Visible = True
                    Else
                        
                        If UCase(Range(rango).Offset(1, 0).Value) <> "" Then
                        valor_error = "1"
                        GoTo FIN
                End If
            End If
            'ASCENDENTE / DESCENDENTE
            If UCase(Range(rango).Offset(7, 0).Value) = "ASCENDENTE" Then
                Else
                       If UCase(Range(rango).Offset(7, 0).Value) = "DESCENDENTE" Then
                    Else
                        If Range(rango).Offset(7, 0).Value <> "" Then
                            valor_error = "4"
                       GoTo FIN
                        End If
                    End If
            End If
            'ALFANUMERICO / NUMERICO
            If UCase(Range(rango).Offset(8, 0).Value) = "ALFANUMERICO" Then
                Else
                       If UCase(Range(rango).Offset(8, 0).Value) = "NUMERICO" Then
                    Else
                        If Range(rango).Offset(8, 0).Value <> "" Then
                            valor_error = ""
                       GoTo FIN
                        End If
                    End If
            End If

            
    End If
    
        
Else
        Call oculta_combo(boton_all, combo, texto, numero_de_combo)
End If

FIN:
End Sub

Sub oculta_combo(boton_all, combo, texto, numero_combo)
        ActiveWorkbook.Sheets(hojaprincipal).Shapes(combo).Visible = False
        ActiveWorkbook.Sheets(hojaprincipal).Shapes(texto).Visible = False
        ActiveSheet.Shapes(boton_all).Visible = False
End Sub

Sub si_no(rango)
valor_error = ""

    If rango = "B27" Then
        If UCase(Range(rango).Value) = "S" Then
            Sheets("Calidad de Informaci|fffd|n").Visible = True
        Else
        If UCase(Range(rango).Value) = "N" Or Range(rango).Value = "" Then
            Sheets("Calidad de Informaci|fffd|n").Visible = False
        Else
            valor_error = "2"
        End If
        End If
    Else
    
    If UCase(Range(rango).Value) = "S" Or UCase(Range(rango).Value) = "N" Or Range(rango).Value = "" Then

        Else
            valor_error = "3"
        End If

    End If
    
End Sub


Attribute VB_Name = "Hoja5"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Hoja7"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Hoja8"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Muestra_datos"

Sub llena_Hojas()
    
        Call valores_a_pintar(avanza_cols_encabezado)
        Call pintar_encabezado(avanza_cols_encabezado)

    Sheets(hojaprincipal).Select
    columna = columna_inicial
    en_arreglo = 1

    'ESTA SUBRUTINA SE USA PARA LISTAR UNA TABLA EN LA COLUMNA A Y B, EN EL ORDEN ESPECIFICO
    'EJEMPLO: Call lista_en_columna_AyB(columnaA, columnaB, tabla, orden)
    'Call lista_en_columna_AyB(columnaA, columnaB, tabla, orden)

    If listar_tabla_fija = 1 Then
        Call tabla_fija_a_listar(entabla)
        Call lista_en_columna_AyB(columnaA, columnaB, entabla, orden)
        ActiveCell = "Total"
    End If

    If UCase(Range("Query!B28").Value) <> "V" Then
        Range(posicion).Offset(0, columna_inicial - 1).Select
            g = Range(posicion).Offset(0, columna_inicial - 1).Address
            make_times = total_de_columnas - 1
    Else
        If cves_encabezado = numero_de_combos_activos Then
            Range(posicion).Offset(0 - numero_de_combos_activos + 1, columna_inicial - 1).Select
            g = Range(posicion).Offset(0, columna_inicial - 1).Address
        Else
            Range(posicion).Offset(0 - cves_encabezado + 1, columna_inicial - 1).Select
            g = Range(posicion).Offset(0 - cves_encabezado + 1, columna_inicial - 1).Address
        End If
            make_times = TCP - 1
                Call sacar_arreglo_de_datos_en_combo(numero_de_datos_en_combos)
                    For r = 0 To numero_de_combos_activos - 1
                    encontrado = False
                        For e = 0 To numero_de_combos_activos - 1
                            If numero_de_datos_en_combos(r, 1) = cves_de_combos_activos(e, 0) Then
                                If cves_de_combos_activos(e, 1) <> "" Then
                                    For Z = 0 To cves_encabezado
                                        If numero_de_datos_en_combos(r, 1) = cve_del_combo(Z, 0) Then
                                            encontrado = True
                                            Exit For
                                        End If
                                    Next
                                    If encontrado = False Then
                                        Call define_combo(r + 1, combo, arreglo, cvecombo, elementos_en_combo, activo, seleccionar, listar)
                                        Call Manda_variosDatos_a_Tabla("TR01", cvecombo, arreglo)
                                    Else
                                        Exit For
                                    End If
                                    
                                End If
                            End If
                            
                        Next
                    Next
    End If

            atras = columna_inicial - 2
            congelar = Range(g).Offset(0, -atras).Address

        borra_hasta (g)

posicion2 = Range(posicion).Offset(0, 1).Address
pos_cve_combo = 0


Call arreglo_de_datos_en_combos(DC)
combos_activos


For repeticiones = 0 To total_de_columnas - 1

    For l = 1 To numero_de_combos_activos
        Select Case l
            Case 1
                                If DC(3, 0) <> "" Then
                                    DatoCombo1 = ACVP(DC(3, 0) - 1, en_arreglo - 1)
                                        cve_en_combo1 = ACNP(DC(3, 0) - 1)
                                End If
            Case 2
                                If DC(3, 1) <> "" Then
                                    DatoCombo2 = ACVP(DC(3, 1) - 1, en_arreglo - 1)
                                        cve_en_combo2 = ACNP(DC(3, 1) - 1)
                                End If
            Case 3
                                If DC(3, 2) <> "" Then
                                    DatoCombo3 = ACVP(DC(3, 2) - 1, en_arreglo - 1)
                                        cve_en_combo3 = ACNP(DC(3, 2) - 1)
                                End If
            Case 4
                                If DC(3, 3) <> "" Then
                                    DatoCombo4 = ACVP(DC(3, 3) - 1, en_arreglo - 1)
                                        cve_en_combo4 = ACNP(DC(3, 3) - 1)
                                End If
        End Select
    Next

    Call busca_concepto

    If UCase(Range("Query!B28").Value) = "V" Then
    
        rangotabla1 = ThisWorkbook.Sheets("BD").PivotTables("TR01").TableRange1
        columnas1 = UBound(rangotabla1, 2)
    
        celda_i = ActiveCell.Offset(-1, 1 - columnas1).Address
'        celda_i = ActiveCell.Offset(-1, columnas1 - 1).Address
            Call ordenar(celda_i, columnas1 - quitar_columnas - quitar_columnas_der)
    End If

        columna = columna + columnas_encabezado
    
    en_arreglo = en_arreglo + columnas_encabezado
    
    If columna >= total_de_columnas + columna_inicial Or en_el_elemento >= numero_real_de_elementos Then
        Exit For
    End If

Next

    'Formato Estandar(no modificable)
    Worksheets(hojaprincipal).Activate
    '************************************************************************
    Call AplicaFormato(columna)
    '************************************************************************
    'Formato Personalizado
    '************************************************************************
    Call AplicaFormato_local(columna)
    '************************************************************************
    Worksheets(hojaprincipal).Activate

    With ActiveWindow
        .LargeScroll Up:=1000, ToLeft:=256
    End With

    Worksheets(hojaprincipal).Rows(Range(posicion).Row).Select
    
    If ActiveWindow.Height >= 410 Then
        Rows(Right(posicion, 2)).Select
        ActiveWindow.FreezePanes = True
    End If
        Range("C6").FormulaR1C1 = ""


End Sub
Sub busca_concepto()

    ReDim resultados(columnas_encabezado)
    ReDim totales(columnas_encabezado)
    
    total_1 = 0
    total_2 = 0
    If UCase(Range("Query!B28").Value) <> "V" Or cves_encabezado > 0 Then
        Call prepara_tabla
    Else
        'No hay Claves y por lo tanto ya mando todos los datos a la Tabla
    End If

    Sheets(hojaprincipal).Select
    Range(posicion).Select

    ReDim Total_General(columnas_encabezado)
    
    If UCase(Range("Query!B28").Value) = "C" Then
            tomar_todos_los_datos_de_la_tabla
        Else
            If UCase(Range("Query!B28").Value) = "D" Then
                Call conceptos_directos(resultados, totales)
            Else
                If UCase(Range("Query!B28").Value) = "V" Then
                    
                    Call tomar_todos_los_datos_de_la_tabla_hacia_abajo(resultados, totales)
                Else
                    tomar_todos_los_datos_de_la_tabla_local
                End If
            End If
    End If

End Sub
Sub AplicaFormato_local(columna)

'columna = 0
'
'Range(posicion).Select
'
'For repeticiones = 0 To total_de_columnas - 1
'
'
'Range(posicion).Offset(0, columna + columnas_encabezado).Select
''    Columns("G:G").Select
'    Selection.ColumnWidth = 15.57
'
'    columna = columna + columnas_encabezado
'
'
'    If columna >= total_de_columnas + columna_inicial Or en_el_elemento >= numero_real_de_elementos Then
'        Exit For
'    End If
'
'Next


End Sub
Sub tomar_todos_los_datos_de_la_tabla_local()


End Sub

Function mes_relativo(periodo, movimiento)
    
    a|fffd|o = Left(periodo, 4)
    mes = Right(periodo, 2)
    
    If movimiento >= 12 Then
        mueve_a|fffd|o = Int(movimiento / 12)
    Else
        mueve_a|fffd|o = 0
    End If
    mueve_meses = movimiento - (Int(movimiento / 12) * 12)
    
    If mes - mueve_meses < 1 Then
        a|fffd|o = a|fffd|o - mueve_a|fffd|o - 1
        mes = mes + 12 - mueve_meses
'        mueve_a|fffd|os = mueve_a|fffd|os + 1
'        mueve_meses = mueve_meses
    Else
        a|fffd|o = a|fffd|o - mueve_a|fffd|o
        mes = mes - mueve_meses
    
    End If
    
'    nuevo_a = a|fffd|o - mueve_a|fffd|os
'    nuevo_m = mes + 12 - mueve_a|fffd|os
    
'      X = (a|fffd|o - mueve_a|fffd|os) * 100
'      a = Right(X, 2)
'      Y = (mes + mueve_meses)
    Select Case mes
        Case "1"
            mes_relativo = "Ene-" & a|fffd|o
        Case "2"
            mes_relativo = "Feb-" & a|fffd|o
        Case "3"
            mes_relativo = "Mar-" & a|fffd|o
        Case "4"
            mes_relativo = "Abr-" & a|fffd|o
        Case "5"
            mes_relativo = "May-" & a|fffd|o
        Case "6"
            mes_relativo = "Jun-" & a|fffd|o
        Case "7"
            mes_relativo = "Jul-" & a|fffd|o
        Case "8"
            mes_relativo = "Ago-" & a|fffd|o
        Case "9"
            mes_relativo = "Sep-" & a|fffd|o
        Case "10"
            mes_relativo = "Oct-" & a|fffd|o
        Case "11"
            mes_relativo = "Nov-" & a|fffd|o
        Case "12"
            mes_relativo = "Dic-" & a|fffd|o
        End Select
'mes_relativo = (a|fffd|o - mueve_a|fffd|os) * 100 + (mes + mueve_meses)

End Function

Sub adecua_encabezados(posicion)
'Sub adecua_encabezados()
' posicion = "C10"
    cadena = ""
    periodo = Range(posicion).Value
    Range(posicion).Offset(1, 0).Select
    dato = Selection.Value
    
    aa = 0
    Do While dato <> "" 'aa < 256 Or dato = ""
    
        dato = Selection.Offset(0, aa).Value
        Selection.Offset(0, aa).NumberFormat = "mmm-yyyy"
'        dato = Selection.Value
            
        Select Case dato
            Case "actual"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 0)
            Case "-1"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 1)
            Case "-2"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 2)
            Case "-3"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 3)
            Case "-4"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 4)
            Case "-5"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 5)
            Case "-6"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 6)
            Case "-7"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 7)
            Case "-8"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 8)
            Case "-9"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 9)
            Case "-10"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 10)
            Case "-11"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 11)
            Case "-12"
                Selection.Offset(0, aa).Value = mes_relativo(periodo, 12)
                
        End Select
        Selection.Offset(0, aa).Columns.ColumnWidth = 100
        Selection.Offset(0, aa).EntireColumn.AutoFit
        aa = aa + 1
    Loop
    

End Sub



Attribute VB_Name = "Seguridad"
Sub ACT()
Attribute ACT.VB_ProcData.VB_Invoke_Func = "l\n14"
'
' ACT Macro
'
' Acceso directo: CTRL+l

Application.ScreenUpdating = False

macro_para_actualizar = True

desBloquea

'On Error Resume Next
Call Seguridadact

Estado_actual = 10

Bloquea
Range(posicion).Offset(2, 2).Select

macro_para_actualizar = False

Application.ScreenUpdating = True

End Sub

Sub lee(st_linea, db_donde, numero_de_lineas)

    Dim lineas_en_archivo As FileSystemObject
    Dim archivo_de_texto As TextStream
    Dim vr_documento As String
    
    vr_linealectura = FreeFile
    
    Set lineas_en_archivo = New FileSystemObject
    
    vr_documento = "\\sector5\DGAIN\MINFO\dgaex.txt"
    Open vr_documento For Input As #vr_linealectura

    Line Input #vr_linealectura, st_linea
    Line Input #vr_linealectura, db_donde
    
End Sub




Attribute VB_Name = "ThisWorkbook"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Sub Workbook_Open()

    Bloquea

    ActiveWindow.WindowState = xlMaximized

    With ActiveWindow
        .LargeScroll Up:=1000, ToLeft:=256
    End With

Application.ScreenUpdating = False

        ActiveWindow.FreezePanes = False

On Error GoTo FIN
Estado_actual = 5

desBloquea
        inicializa
Call proceso_abrir_libro

GoTo FIN

Errores_generales


FIN:

Bloquea

tamcombo


Estado_actual = 0
Range(posicion).Offset(2, 2).Select
Application.ScreenUpdating = True
End Sub

Private Sub Workbook_BeforeSave(ByVal SaveAsUI As Boolean, Cancel As Boolean)

    'Si no esta actualizando con la Macro, acomoda el documento
    If UCase(Range("MINFO!a1")) <> "A" Then
        If macro_para_actualizar = False Then
            If Estado_actual <> 10 Then

        With ActiveWindow
            .LargeScroll Up:=1000, ToLeft:=256
        End With

        Application.ScreenUpdating = False
                Estado_actual = 2

                proceso_abrir_libro

                ThisWorkbook.Sheets(1).Select

                tamcombo

                    'Esconde columna A
                    Columns("A:A").EntireColumn.Hidden = True

                Application.ScreenUpdating = True
            End If
        End If
    End If
Estado_actual = 0
Range(posicion).Offset(2, 2).Select

End Sub



INQUEST-PP=macro
