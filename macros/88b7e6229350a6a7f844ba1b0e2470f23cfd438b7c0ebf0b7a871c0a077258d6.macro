Attribute VB_Name = "Feuil1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
'  AUTOEXECUTION MACRO IMPORT BDD SI ON CHANGE LE NOM DE CLIENT
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

Sub Worksheet_Change(ByVal Target As Range)
            If Not Application.Intersect(Target, Range("E1")) Is Nothing Then
            Application.ScreenUpdating = False
            PrepareCallImportDepuisFRS
'            'ImportBDDversCLT  'Se fera tout seul dans l'autre feuille
            Application.EnableEvents = True '
  ''              End If
            ThisWorkbook.Worksheets("FRS").Activate
 End If
End Sub



Attribute VB_Name = "Feuil10"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True




Attribute VB_Name = "Feuil11"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True




Private Sub CommandButton2_Click()

End Sub

Private Sub CommandButton3_Click()

End Sub
Attribute VB_Name = "Feuil12"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True




Attribute VB_Name = "Feuil13"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True




Attribute VB_Name = "Feuil28"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
'  AUTOEXECUTION MACRO IMPORT BDD SI ON CHANGE LE NOM DE CLIENT
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

Private Sub Worksheet_Change(ByVal Target As Range)
    If Not Application.Intersect(Target, Range("E2")) Is Nothing Then
    ImportBDDversCLT
    End If
End Sub
Attribute VB_Name = "Feuil3"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Module1_PRETE"


'=======ENSEMBLE MACROS VERIFICATION AUTOMATIQUE A L OUVERTURE DEVIS VIERGE=======================

'LISTE DES MACROS
'Sub Auto_Open()                    'Si "DEVISVIERGE" Alors incr|fffd|menter.
'Sub Incr|fffd|menterNum|fffd|roDeDevis()     'Incrementation pour Auto_Open
'Sub CheminR|fffd|pertoireSOCIETE        'Ne peut etre utilis|fffd| car perd la variable en cheangant de macro "DirSoc"
'OuvrirFichierClientAvecV|fffd|rif()
'RechercherDansFichierCLIENTS()
'ImportClientDansFichierActuelSansCr|fffd|ationNouveauDevis()  'Supprim|fffd| pour pr|fffd|server "DEVISVIERGE"
'ImportClientDansFichierActuel()    'Remis AVEC demande produit
'RechercherDansFichierCLIENTS_et_ImportClient()         'Fera d'office un nouveau devis pour pr|fffd|server le devis vierge
'RechercherDansFichierCLIENTS_et_ImportClientSansCr|fffd|erDevis() 'Supprim|fffd| pour pr|fffd|server "DEVISVIERGE"
'ExporterNouveauVersClient()
'ModifierClient()
'M|fffd|meAdresseDeFacturation()
'TrouverDerniereLigne()
'ImprimerEnPdfCreator()
'ImprimerPdf_et_Mailer1Pdf()
'ImprimerPdf_FACTURE_et_Mailer_Admin_Pdf()
'ImprimerPdf_RELANCE_et_Mailer_Admin_Pdf()
'EnregistrerNouveauDevis()
'EnregistrerCommande()              'Supprim|fffd| voir avant 2019
'ExporterNouveauVersPROSPECT()      'Supprim|fffd| voir avant 2019
'ImprimerPdf_et_Mailer2Pdf()        'Supprim|fffd| voir avant 2019


'Option Explicit  'INUTILE impose de d|fffd|clarer les valeurs au pr|fffd|alable
'DECLARATION DE VARIABLES COMMUNES A TOUS LES MODULES
    Public new_fiche As Boolean 'D|fffd|finit 2 |fffd|tats : true (l'|fffd|tat vrai) et false (l'|fffd|tat faux).
    Public List_open As Boolean 'D|fffd|finit 2 |fffd|tats : true (l'|fffd|tat vrai) et false (l'|fffd|tat faux).
    Public Const DerChamp = 109 'Dernier champ pour la FICHE F  'Ne peut pas se faire dans ThisWorkbook  car 'les constantes definies par l'utilisateur ne sont pas autoris|fffd|e comme membre public de module objet
    Public Const DerCli = 1000  'Dernier champ pour la BDD
    Public BDD As String        'BDD Acces  'Sera initialis|fffd|e par ouverture ThisWorkbook
    Public Chemin As String

'=======ENSEMBLE MACROS VERIFICATION AUTOMATIQUE A L OUVERTURE DEVIS VIERGE=======================

Sub Auto_Open() 'MAJ Numero de devis en d|fffd|clenchement automatique |fffd| l'ouverture du classeur
' VERIFIE AUTOMATIQUEMENT SI LE FICHIER ACTUEL QUI S'OUVRE S'APPELE "!DEVIS VIERGE.xls"
' et dans ce cas mettre |fffd| jour le num|fffd|ro de devis

'METTRE EN SUSPEND LA MISE EN FORME CONDITIONNELLE
'Worksheet.EnableFormatConditionsCalculation = False 'suspendre
'Worksheet.EnableFormatConditionsCalculation = True 'R|fffd|activer

'VERIFIER QU'ON EST BIEN EN DEVIS VIERGE ET DANS CE CAS METTRE A JOUR DATE ET SAUVER
    If ActiveWorkbook.Name = "!DEVIS VIERGE.xls" Then
        'MET A JOUR LA DATE DU DEVIS    'Pour qu'elle soit fig|fffd|e.
        ThisWorkbook.Worksheets("FRS").Range("e5") = Date
        'MET A JOUR LE NUMERO DE DEVIS
        ThisWorkbook.Worksheets("FRS").Range("e6") = ThisWorkbook.Worksheets("FRS").Range("f4")
        'Call Incr|fffd|menterNum|fffd|roDeDevis
        ActiveWorkbook.Save     'On enregistre le DEVIS VIERGE incr|fffd|ment|fffd| mais sans le refermer
        Else
        'MsgBox "Ce n'est pas un !DEVIS VIERGE.xls  Donc ne pas incr|fffd|menter"
    End If
End Sub   'Fin de AUTO_Open()MAJ Numero de devis en d|fffd|clenchement automatique
'====================================================

'Suite de la macro Auto Open
Sub Incr|fffd|menterNum|fffd|roDeDevis()    'Incr|fffd|mente le compteur du Devis Vierge et SAUVE
'MET A JOUR LA DATE DU DEVIS    'Pour qu'elle soit fig|fffd|e.
    ThisWorkbook.Worksheets("FRS").Range("e5") = Date
    'ThisWorkbook.Worksheets("FRS").Range("e5").NumberFormat = "dddd mmmm yyyy"
        
'INCREMENTER LE NUMERO DE DEVIS ACTUEL
    ThisWorkbook.Worksheets("FRS").Range("e6") = ThisWorkbook.Worksheets("FRS").Range("f4")
        
'ENREGISTRER AVEC LE NUMERO AUGMENTE      'Laisser macro ci dessus le faire
'        chemin = ThisWorkbook.Path
'        fichier = ActiveWorkbook.Name
'            'Thisworkbook.Name rel|fffd|ve le nom du fichier o|fffd| s'ex|fffd|cute la macro.
'            'ActiveWorkbook.Name par contre r|fffd|l|fffd|ve le nom du dernier fichier ouvert
'        'Sauvegarder
'        ActiveWorkbook.Save
'            'ThisWorkbook.SaveCopyAs fichier
'            'chemin = ThisWorkbook.Path & "\"     ' Fichier contenant la macro
'            'ThisWorkbook.SaveAs chemin & fichier
            
End Sub 'Fin de Incr|fffd|menterNum|fffd|roDeDevis()
'FIN ENSEMBLE MACROS VERIFICATION AUTOMATIQUE A L OUVERTURE et INCREMENTATION A L OUVERTURE DU DEVIS VIERGE====================================
'====================================================



'====================================================
Sub OuvrirFichierClientAvecV|fffd|rif()  'OUVRIR FICHIER CLIENTS EN VERIFIANT SI FERME 'OK '

'***TROUVER LE CHEMIN REPERTOIRE DIRECTORY DE LA SOCIETE URANUS |fffd| partir du chemin relatif du dossier en cours
        'POSITION dans le chemin relatif en cours de l'occurence de la soci|fffd|t|fffd| URANUS
        Dim PoSoc As String
        PoSoc = InStrRev(ThisWorkbook.Path, "URANUS", [-1], [vbTextCompare])
            '[-1] Optionnel. C'est la position de d|fffd|part pour la recherche. -1 Si ce param|fffd|tre est omis, la recherche commencera |fffd| la position -1, qui est la derni|fffd|re position du caract|fffd|re.
            '[vbTextCompare] compare le texte et non plus du binaire
            'MsgBox P  '18  car dans le chemin '\\192.168.92.205\URANUS\Devis\Devis en cours,
            'l'occurrence URANUS commence a la 18 ieme position
                      
        'VERIFIER QUE L'ON EST BIEN DANS LE REPERTOIRE DE LA SOCIETE
            If PoSoc = 0 Then  'Dire erreur emplacement
            MsgBox "Mauvais emplacement de fichier. Votre soci|fffd|t|fffd| est introuvable dans ce repertoire. Assurez vous que fichier utilis|fffd| se trouve bien dans le r|fffd|pertoire de votre soci|fffd|t|fffd|"
            Exit Sub
            Else   'rien
            End If
                        
        'CHEMIN REEL DU REPERTOIRE DE LA SOCIETE URANUChemin r|fffd|el du dossier Soci|fffd|t|fffd|
        Dim DirSoc As String
        DirSoc = Left(ThisWorkbook.Path, PoSoc + 5)   '+5 Pour laisser les 5 lettres de la soci|fffd|t|fffd| URANUS
            'MsgBox "DirSoc : " & DirSoc   '\\192.168.92.205\uranus
            'ChDir DirSoc    'Changer la Directory pour le chemin par d|fffd|faut d'enregistrement du fichier
'***Fin de TROUVER LE CHEMIN DIRECTORY DE LA SOCIETE  DirSoc


'DEFINIR LES CHEMINS RELATIFS pour les dossiers DEVIS et CLIENTS
    Dim CheminClient As String
    CheminClient = DirSoc & "\Clients\Clients en cours\"

'VERIFIER SI LE FICHIER CLIENT EST BIEN FERME AVANT DE L OUVRIR , SINON L ACTIVER
    Dim Fich As Variant
    'Dim estouvert As String
    estouvert = False
    Fichier_CLIENTS = "Clients.xls"    'Sauf si PROSPECT.xls
    'V|fffd|rifier que le fichier "Clients.xls" ne soit pas d|fffd|j|fffd| ouvert
        For Each Fich In Workbooks    'Pour chaque fichier dans le Book de travail, v|fffd|rifier que son nom n'est pas "CLIENTS"
        If Fich.Name = Fichier_CLIENTS Then estouvert = True  'Si "Nom du fichier" = CLIENTS alors est ouvert prend la variable VRAI
        Next
    
    If estouvert = False Then  'Si la variable estouvert est encore = false alors le fichier n'est pas encore ouvert
    Workbooks.Open Filename:=CheminClient & Fichier_CLIENTS  'OUVRIR le fichier CLIENTS    'Workbooks.Open Filename:=CheminClient & "Clients.xls"  'OUVRIR le fichier CLIENTS    'Workbooks.Open Filename:=CheminClient & "Clients.xls"  'OUVRIR le fichier CLIENTS
    'Workbooks.Open Filename:=CheminClient & "Clients.xls"
    'WORKBOOKs.Open (chemin & "\" & "Clients.xls")   dans ancien excel
    Else
    Workbooks(Fichier_CLIENTS).Activate  'Activer le fichier CLIENTS qui est ouvert
    End If

End Sub     'FIN de OuvrirFichierClientAvecV|fffd|rif()
'===============================================================================



'===============================================================================
Sub RechercherDansFichierCLIENTS() 'Depuis Devis Pour importer dans DEVIS le CLIENT a RECHERCHER

'MEMORISER LE NOM DE DOSSIER A RECHERCHER
    Dim Rech As Range
    Dim NomDeDossierAchercher As String
    'v|fffd|rifier qu'on a bien renseign|fffd| un nom de dossier
    NomDeDossierAchercher = Range("E5")
        If IsEmpty(NomDeDossierAchercher) Then
        MsgBox "Aucun client renseign|fffd| ...": Exit Sub
        End If

Call OuvrirFichierClientAvecV|fffd|rif

'CHERCHER LA VALEUR EXACTE Range("C5") dans la feuille "clients"
    'Set Rech = Sheets("CLIENTS").Columns(2).Find(what:=NomDeDossierAchercher, LookAt:=xlWhole, LookIn:=xlValues) 'Pour valeur Exacte
    'Set Rech = Workbooks("Clients.xls").Sheets("CLIENTS").Columns(2).Find(what:=Workbooks("!Devis Vierge.xls").Worksheets("CLT").Range("E5").Value, LookAt:=xlWhole, LookIn:=xlValues) 'Pour valeur Exacte
Set Rech = Workbooks("Clients.xls").Sheets("CLIENTS").Columns(2).Find(what:=ThisWorkbook.Worksheets("CLT").Range("E5").Value, LookAt:=xlWhole, LookIn:=xlValues) 'Pour valeur Exacte
    'Set Rech = Sheets("CLIENTS").Columns(2).Find(what:=Range("C5").Value, LookAt:=xlPart, LookIn:=xlValues) 'Pour valeur Approch|fffd|e
    'xlWhole signifie nom exact     et    xlPart     pour valeur approch|fffd|e
    'lookat:=xlWhole, LookIn:=xlValues) permet de pr|fffd|ciser si on veut comparer avec les formules ou avec le r|fffd|sultat

'Si elle ne trouve rien, Rechercher la valeur approch|fffd|e
    If Rech Is Nothing Then
    'CHERCHER LA VALEUR APPROCHEE "NomDeDossierAchercher" dans la feuille "clients"
    Set Rech = Sheets("CLIENTS").Columns(2).Find(what:=ThisWorkbook.Worksheets("CLT").Range("E5").Value, LookAt:=xlPart, LookIn:=xlValues) 'Pour valeur Approch|fffd|e
    'MsgBox ("La recherche PARTIELLE a trouv|fffd| : " & Rech)
    End If

        'Si elle ne trouve rien, le dire et arr|fffd|ter la macro
        If Rech Is Nothing Then
         MsgBox "Le client n'a pas |fffd|t|fffd| trouv|fffd| ...": Exit Sub
        End If

'ACTIVER LA CELLULE TROUVEE DANS DOSSIER
    Workbooks("Clients.xls").Sheets("CLIENTS").Activate     'Active la feuille "CLIENTS" pour se positionner
    Rech.Select         'se positionne sur la cellule trouv|fffd|e  ("rech")

'Dans CLIENTS  d|fffd|terminer la rang|fffd|e de la Cellule active   (row = ligne du client actif)
    LigneClient = ActiveCell.Row
    PageCLIENTouFRS = ActiveSheet.Name
    'MsgBox (" LigneClient trouv|fffd|e = ActiveCell.Row  donne : ") & LigneClient

End Sub  'RechercherDansFichierCLIENTS()
'=======================================================


'=======================================================
Sub ImportClientDansFichierActuel()
'CETTE MACRO CONSTITUE L'ETAPE 2 DE LA MACRO PRECEDENTE
'ELLE CREE D OFFICE UN NOUVEAU DEVIS DE MANIERE A PRESERVER LE DEVIS VIERGE
Application.ScreenUpdating = False

Dim LigneClient As String
Dim CheminClient As String
Dim CheminDevis As String
Dim PageCLIENTouFRS As String
Dim i As Integer

'Dans CLIENTS  d|fffd|terminer la rang|fffd|e de la Cellule active   (row = ligne du client actif)
    LigneClient = ActiveCell.Row
    PageCLIENTouFRS = ActiveSheet.Name
   

'***TROUVER LE CHEMIN REPERTOIRE DIRECTORY DE LA SOCIETE URANUS |fffd| partir du chemin relatif du dossier en cours
        'POSITION dans le chemin relatif en cours de l'occurence de la soci|fffd|t|fffd| URANUS
        Dim PoSoc As String
        PoSoc = InStrRev(ThisWorkbook.Path, "URANUS", [-1], [vbTextCompare])
            '[-1] Optionnel. C'est la position de d|fffd|part pour la recherche. -1 Si ce param|fffd|tre est omis, la recherche commencera |fffd| la position -1, qui est la derni|fffd|re position du caract|fffd|re.
            '[vbTextCompare] compare le texte et non plus du binaire
            'MsgBox P  '18  car dans le chemin '\\192.168.92.205\URANUS\Devis\Devis en cours,
            'l'occurrence URANUS commence a la 18 ieme position
                      
        'VERIFIER QUE L'ON EST BIEN DANS LE REPERTOIRE DE LA SOCIETE
            If PoSoc = 0 Then  'Dire erreur emplacement
            MsgBox "Mauvais emplacement de fichier. Votre soci|fffd|t|fffd| est introuvable dans ce repertoire. Assurez vous que fichier utilis|fffd| se trouve bien dans le r|fffd|pertoire de votre soci|fffd|t|fffd|"
            Exit Sub
            Else   'rien
            End If
                        
        'CHEMIN REEL DU REPERTOIRE DE LA SOCIETE URANUChemin r|fffd|el du dossier Soci|fffd|t|fffd|
        Dim DirSoc As String
        DirSoc = Left(ThisWorkbook.Path, PoSoc + 5)   '+5 Pour laisser les 5 lettres de la soci|fffd|t|fffd| URANUS
            'MsgBox "DirSoc : " & DirSoc   '\\192.168.92.205\uranus
            'ChDir DirSoc    'Changer la Directory pour le chemin par d|fffd|faut d'enregistrement du fichier
'***Fin de TROUVER LE CHEMIN DIRECTORY DE LA SOCIETE  DirSoc

'D|fffd|finir les chemins RELATIFS pour les dossiers CLIENTS et DEVIS
    CheminClient = DirSoc & "\Clients\Clients en cours"
    'CheminClient = ThisWorkbook.Path
        MsgBox ("CheminClient = " & CheminClient)
    CheminDevis = DirSoc & "\Devis\Devis en Cours"
        MsgBox ("CheminDevis = " & CheminDevis)

' Copier Cellules Client dans DEVIS
   For i = 0 To 100
    ' Cellule_a_Copier = Workbooks("Clients.xls").Worksheets("CLIENTS").Range("b" & LigneClient).Offset(0, i)
    Workbooks("!Devis Vierge.xls").Worksheets("CLT").Range("e5").Offset(i, 0) = Workbooks("Clients.xls").Worksheets("CLIENTS").Range("b" & LigneClient).Offset(0, i)
    'Workbooks("!Devis Vierge.xls").Worksheets("CLT").Range("e5").Offset(i, 0) = Workbooks("Clients.xls").Worksheets(PageCLIENTouFRS).Range("b" & LigneClient).Offset(0, i)
    Next i
   
' DEMANDE VALEUR PRODUIT()
    Dim Produit As String
    Produit = InputBox("Pr|fffd|ciser le Produit :  Installation t|fffd|l|fffd|phonique ou autre", "CHOIX DU PRODUIT", "Installation t|fffd|l|fffd|phonique")  'La variable re|fffd|oit la valeur entr|fffd|e dans l'InputBox
        If Produit <> "" Then 'Si la valeur est diff|fffd|rente de "" on affiche l'Objet
        End If
    ThisWorkbook.Worksheets("FRS").Range("e8") = Produit   'Noter Produit dans "DEVIS VIERGE"
' Fin DEMANDE VALEUR PRODUIT()

' ENREGISTRER CE NOUVEAU DEVIS
    ' La macro est dans le fichier client et elle enregistre donc toujours le fichier client au lieu du nouveau devis >Faire Application.Run au lieu de CALL
    'Application.Run ("'!DEVIS VIERGE.xls'!EnregistrerNouveauDevis")     'Sauve le devis Client en cours
    Call EnregistrerNouveauDevis     'Sauve le devis Client en cours
    
' FERMER FICHIER CLIENT
    'Workbooks("CLIENTS.xls").Save   'On enregistre m|fffd|me si on a pas modifi|fffd| pour pouvoir fermer sans alerte le fichier CLIENTS
    'Workbooks("CLIENTS.xls").Close
    
    'fermer sans enregistrer
        'Annule toutes les alertes Excel
        Application.DisplayAlerts = False
        'Ferme le classeur
        Workbooks("CLIENTS.xls").Close
        'Restaure l'affichage des Alertes
        Application.DisplayAlerts = True
     
End Sub  'ImportClientDansFichierActuel()
'=======================================================


'=======================================================
Sub RechercherDansFichierCLIENTS_et_ImportClient()  'OK fonctionne avec chemin DirSoc
'Pour importer dans DEVIS le CLIENT a RECHERCHER et cr|fffd|er d'office un nouveau devis de mani|fffd|re |fffd| pr|fffd|server "Devis Vierge"

'Etape 1 : RECHERCHER DANS FICHIER "CLIENTS"
    Call RechercherDansFichierCLIENTS

'Etape 2 :'APPLIQUER LA MACRO EXPORT CLIENT vers DEVIS
    Application.ScreenUpdating = False  'pour ne pas voir d|fffd|filer les pages de recherche
    'Application.Run ("'Clients.xls'!ExporterClientVersDevisAvecDemandeProduit")  'Applique la macro du fichier "CLIENTS.xls"
    Call ImportClientDansFichierActuel
    'Run ExporterClientVersDevisAvecDemandeProduit

End Sub       'FIN de "RechercherDansFichierCLIENTS_et_ImportClient"
'===============================================================================

'===============================================================================
Sub ExporterNouveauVersClient()      '32 Colonnes |fffd| droite
Application.ScreenUpdating = False
       
'OUVRIR FICHIER CLIENTS
    Call OuvrirFichierClientAvecV|fffd|rif
       
'REPERER LA DERNIERE LIGNE VIDE DU FICHIER CLIENTS
    Dim LigneClient As String
        'Dans DEVIS d|fffd|terminer la rang|fffd|e de la Cellule active : pas besoin de row c'est toujours la 3
        'Dans CLIENTS D|fffd|terminer la derni|fffd|re Ligne CLIENT
        'Variable qui calcule la derni|fffd|re cellule non vide de la colonne A de la feuille 1
    LigneClient = Workbooks("Clients.xls").Worksheets("CLIENTS").Range("B65000").End(xlUp).Row
    LigneClient = LigneClient + 1     'pour prendre la ligne Vide qui suit la derni|fffd|re non vide
        'MsgBox ("derligne clients = " & LigneClient)
        
'TRANSPOSITION PAR MACRO dans DEVIS pour mettre la colonne Client en ligne export (Ligne3)
     For i = 0 To 120
     ThisWorkbook.Worksheets("CLT").Range("b3").Offset(0, i) = ThisWorkbook.Worksheets("CLT").Range("e5").Offset(i, 0)
     Next i
    
'COPIER LA LIGNE D EXPORT (LIGNE3) VERS CLIENTS DERNIERE LIGNE TROUVEE
    ThisWorkbook.Worksheets("CLT").Range("b3:AL3").Copy   'La ligne Export client du devis est copi|fffd|e
    'Coller EN VALEUR cette ligne dans le Fichier "CLIENTS"
    Workbooks("Clients.xls").Worksheets("CLIENTS").Range("b" & LigneClient).PasteSpecial Paste:=xlPasteValues

'METTRE EN COULEUR ROUGE pourle nom en attente RETOUR CONTRAT de compl|fffd|ment Num|fffd|ro de T|fffd|l|fffd|gestion.
    Workbooks("Clients.xls").Worksheets("CLIENTS").Range("b" & LigneClient).Font.ColorIndex = 3  'Police en ROUGE
    'WORKBOOKs("Clients.xls").Worksheets("CLIENTS").Range("b" & LigneClient).Interior.Color = RGB(255, 102, 0)  'Int|fffd|rieur en ORANGE
     'Rendre cette derni|fffd|re ligne active
       'Workbooks("Clients.xls").Worksheets("CLIENTS").Range("b" & LigneClient).Select 'S|fffd|lectionne la ligne mais ne l'affiche pas encore car c'est dans le fichier client et non pas celui de la macro(DEVIS)
' ACTIVER LA PAGE CLIENT
    Workbooks("Clients.xls").Sheets("CLIENTS").Activate
' CENTRER LA VUE SUR LE NOUVEAU CLIENT
    Dim R As Range       'R sera la Cellule (B, ligne client) sur laquelle on veut "Zoomer"
    Set R = Workbooks("Clients.xls").Worksheets("CLIENTS").Range("b" & LigneClient)
  
    Dim iRow As Integer
    Dim iCol As Integer
    iRow = R.Row - ActiveWindow.VisibleRange.Rows.Count / 2
    If iRow < 1 Then iRow = 1
    iCol = R.Column - ActiveWindow.VisibleRange.Columns.Count / 2
    If iCol < 1 Then iCol = 1
    ActiveWindow.ScrollColumn = iCol
    ActiveWindow.ScrollRow = iRow

End Sub   'ExporterNouveauVersClient()
'===============================================================================

'================================================================================================================================================================================================
Sub ModifierClient()  'PERMET DE FAIRE UNE MISE A JOUR DE LA LIGNE CLIENT DEPUIS UNE MODIFICATION DANS DEVIS

'MEMORISER LE NOM DE DOSSIER CLIENT A RECHERCHER
    Dim Rech As Range
    Dim NomDeDossierAchercher As String
    NomDeDossierAchercher = Worksheets("CLT").Range("E5")
    'MsgBox ("NON DE DOSSIER A CHERCHER : " & NomDeDossierAchercher)
            'VERIFIER qu'on a bien renseign|fffd| un nom de dossier SINON SORTIR
           ' If IsEmpty(NomDeDossierAchercher)Then
                If IsEmpty(Worksheets("CLT").Range("E5")) Then
                    MsgBox ("Aucun client renseign|fffd| ! LA MODIFICATION NECESSITE UN NOM DE DOSSIER")
                    Exit Sub
                End If

'MEMORISER LE NOM DU DEVIS ACTUEL
    Dim DevisActuel As String
    DevisActuel = ThisWorkbook.Name    'montre nom exact du dossier devis utilis|fffd| ex :"!Devis Vierge.xls"
    'MsgBox "DevisActuel =  " & DevisActuel

'OUVRIR LE FICHIER CLIENTS AVEC VERIF
    Call OuvrirFichierClientAvecV|fffd|rif


'CHERCHER LA VALEUR EXACTE DU "NomDeDossierAchercher" dans la feuille "clients"
    Set Rech = Sheets("CLIENTS").Columns(2).Find(what:=NomDeDossierAchercher, LookAt:=xlWhole, LookIn:=xlValues) 'Pour valeur Exacte
    'Set Rech = Workbooks("Clients.xls").Sheets("CLIENTS").Columns(2).Find(what:=NomDeDossierAchercher, LookAt:=xlWhole, LookIn:=xlValues) 'Pour valeur Exacte
    'Set Rech = Sheets("CLIENTS").Columns(2).Find(what:=NomDeDossierAchercher, LookAt:=xlWhole, LookIn:=xlValues) 'Pour valeur Exacte
    'Set Rech = Workbooks("Clients.xls").Sheets("CLIENTS").Columns(2).Find(what:=Workbooks(DevisActuel).Worksheets("CLT").NomDeDossierAchercher.Value, LookAt:=xlWhole, LookIn:=xlValues) 'Pour valeur Exacte
    ' MsgBox "Rech contient : " & Rech
    'Si elle ne trouve rien, Rechercher la valeur approch|fffd|e
    If Rech Is Nothing Then
    MsgBox "AUCUN DOSSIER AVEC CE NOM ENTIER DANS FICHIER CLIENTS. RECHERCHE DE VALEUR APPROCHEE."
    'CHERCHER LA VALEUR APPROCHEE "NomDeDossierAchercher" dans la feuille "clients"
    Set Rech = Sheets("CLIENTS").Columns(2).Find(what:=NomDeDossierAchercher, LookAt:=xlPart, LookIn:=xlValues)  'Pour valeur Approch|fffd|e
    'MsgBox ("La recherche PARTIELLE a trouv|fffd| : " & Rech)
                'Si elle ne trouve toujours rien, le dire et arr|fffd|ter la macro
                If Rech Is Nothing Then
                MsgBox "Aucun DOSSIER CLIENT M|fffd|me PARTIEL avec ce nom n'a pas |fffd|t|fffd| trouv|fffd| dans le fichier CLIENTS. STOP"
                Exit Sub
                End If
    'AFFICHER LE NOM PARTIEL TROUVE ET PROPOSER D ARRETER SI CE NOM NE CONVIENT PAS
    MsgBox ("La recherche PARTIELLE a trouv|fffd| :  [ " & Rech & " ]                                       Si ce nom ne convient pas ARRETER AVEC [ Ctrl + Pause ]")
    End If
'ACTIVER LA CELLULE TROUVEE DANS DOSSIER
    Workbooks("Clients.xls").Sheets("CLIENTS").Activate     'Active la feuille "CLIENTS" pour se positionner
    Rech.Select                         'se positionne sur la cellule trouv|fffd|e  ("rech")

'PROVISOIRE  MONTRER
    'MsgBox (" POSITIONNEMENT SUR RECH de macro (RECHERCHER dans fichier client): " & Rech)


'Dans CLIENTS  d|fffd|terminer la rang|fffd|e de la Cellule active   (row = ligne du client actif)
    LigneClient = ActiveCell.Row
    PageCLIENTouFRS = ActiveSheet.Name
    'MsgBox (" LigneClient = ActiveCell.Row  donne : ") & LigneClient
    'FIN DE   RechercherDansFichierCLIENTS()

'RESTE A COPIER LA COLONNE CLT ACTIVE DANS LA COLONNE DEVIS avec Offset(0, n)
     'Copier Cellules Client dans DEVIS
     Dim n As Integer
      For n = 0 To 120
     '    Cellule_a_Copier = Workbooks("Clients.xls").Worksheets("CLIENTS").Range("b" & LigneClient).Offset(0, n)
         Workbooks("Clients.xls").Worksheets(PageCLIENTouFRS).Range("b" & LigneClient).Offset(0, n) = Workbooks(DevisActuel).Worksheets("CLT").Range("e5").Offset(n, 0)
        Next n
    
     Workbooks("CLIENTS.xls").Save
     'Workbooks("CLIENTS.xls").Close

End Sub      'FIN DE MACRO "MODIFIER CLIENTS"
'===============================================================================


'=================================================================================================================
 Sub M|fffd|meAdresseDeFacturation() 'adresse de facturation = adresse installation
    For i = 0 To 11     'On va recopier en E26 le nom E5 puis en E27 le nom B6 ect 11 fois
    ThisWorkbook.Worksheets("CLT").Range("e26").Offset(i, 0) = ThisWorkbook.Worksheets("CLT").Range("e6").Offset(i, 0)
    Next i

 End Sub    'M|fffd|meAdresseDeFacturation()
'=================================================================================================================

'===DEFINIR LA DERNIERE CELLULE NON VIDE DU DOCUMENT 'ET NE CONTENANT PAS DE " " Li|fffd| |fffd| UNE FORMULE NULLE
Sub TrouverDerniereLigne()
    Dim DerLig As Long, i As Long
    DerLig = 0   'pour r|fffd|initialiser
    DerLig = ActiveSheet.Cells.SpecialCells(xlCellTypeLastCell).Row
    'DerLig = Range("B65000").End(xlUp).Row   ' donne 59 car voit une formule en range(B59) =SI(FRS!$E$7=1;"Formule Location avec assistance technique";"")
    For i = DerLig To 2 Step -1
        If Not ActiveSheet.Cells(i, 1).Value = "" Or IsEmpty(ActiveSheet.Cells(i, 1)) Then
            DerLig = i  'la derniere ligne i n'est pas vide donc on s'arr|fffd|te de remonter (on sort de la boucle)
            Exit For
        End If
    Next i
    
    MsgBox "La derni|fffd|re ligne utilis|fffd|e est la ligne " & DerLig
End Sub   'Fin de 'TrouverDerniereLigne 'DERNIERE CELLULE NON VIDE ET SANS FORMULE
'=================================================================================================================
 
'=================================================================================================================
Sub ImprimerEnPdfCreator()

'RMQ :
'compatible avec version PDFCreator 1.1.1 |fffd| 1.7.3
'Un lecteur pdf doit |fffd|tre install|fffd| sur le PC qui veut utiliser cette macro, sinon on aura un bogue dans le PC ou s'enregistre la macro qui fera  "fichier.pdf.pdf" car l'option d'affichage des fichiers est "Ne pas afficher l'extension des fichiers connus"

Dim JobPDF As Object
Dim sNomPDF As String
Dim sCheminPDF As String
Dim Client As String
Dim Objet_du_devis As String  'type de travaux ou service


' DEFINIR LES VARIABLES ET LE CHEMIN POUR L IMPRESSION
    Client = Worksheets("CLT").Range("e6")              'Cherche le nom du client
    Objet_du_devis = Worksheets("FRS").Range("e8")      'Cherche l'objet du devis
    sNomPDF = Client & "_" & Objet_du_devis & ".pdf"    'Nom que prendra le fichier pdf
    sCheminPDF = ThisWorkbook.Path & "\"                'Chemin ou il sera enregistr|fffd|
 
    If IsEmpty(ActiveSheet.UsedRange) Then Exit Sub   'Si la page est vide, sortir
 
    Set JobPDF = CreateObject("PDFCreator.clsPDFCreator")
    
         ''''''
         ' JobPDF  est le  mod|fffd|le objet FileSystemObject |fffd| cr|fffd|er
         ' "PDFCreator.  est le nom de la biblioth|fffd|que de types
         ' .clsPDFCreator ""  est le nom de l'objet dont vous voulez cr|fffd|er une instance.
         '''''

       With JobPDF
       
                'Pr|fffd|venir si le processus ne s'enclenche pas
                If .cStart("/NoProcessingAtStartup") = False Then
                    MsgBox "Initialisation de PDFCreator impossible", vbCritical + vbOKOnly, "PDFCreator"
                    Exit Sub
                End If
           
           .cOption("UseAutosave") = 1     'Options exclusives PDFCr|fffd|ator et pas les autres PDF
           .cOption("UseAutosaveDirectory") = 1
           .cOption("AutosaveDirectory") = sCheminPDF
           .cOption("AutosaveFilename") = sNomPDF
    
           '   0=PDF, 1=Png, 2=jpg, 3=bmp, 4=pcx, 5=tif, 6=ps, 7=eps, 8=txt
           .cOption("AutosaveFormat") = 0
           .cClearCache
       End With
      
' IMPRIMER
   ActiveWorkbook.ActiveSheet.PrintOut COPIES:=1, ActivePrinter:="PDFCreator"
   
 ''''''
 '  IMPRESSION PAR ENREGISTREUR
 '  ActiveSheet.PageSetup.PrintArea = "$A$1:$B$3"
 '   ActiveWindow.SelectedSheets.PrintOut Copies:=1, Collate:=True
 ''''
   
   'Range("A1:I" & DerLig).PrintOut Copies:=1, ActivePrinter:="PDFCreator"
    'Fichier dans la file d'attente
        Do Until JobPDF.cCountOfPrintjobs = 1  'attent que l'impression soit dans la file d'attente de pdf cr|fffd|ator
        DoEvents
        Loop
    JobPDF.cPrinterStop = False
    
    'Attendre que la file d'attente soit vide (surtout pour Workbook entier)
        Do Until JobPDF.cCountOfPrintjobs = 0 'Attendre que la file d'attente soit vide (surtout pour Workbook entier)
            DoEvents
        Loop
    JobPDF.cClose
    Set JobPDF = Nothing
    MsgBox ("Le PDF a |fffd|t|fffd| cr|fffd||fffd| dans Devis en cours ")
End Sub 'FIN ImprimerEnPdfCreator()
'=================================================================================================================
'=================================================================================================================
Sub ImprimerPdf_et_Mailer1Pdf()   'Pour 1 PDF
''COMPIL DES DEUX MACROS 'Imprimer pdf' et 'Envoyer par Mail'
'PLAN
    'ENREGISTRER LE FICHIER AVEC DATE
    'ETAPE 1 : IMPRIMER LE PDF
    'DEFINIR LES VARIABLES ET LE CHEMIN POUR L IMPRESSION
    'IMPRIMER  PDF
    'OUVRIR OUTLOOK ET REDIGER MESSAGE  OK
    'ATTACHER PIECE A JOINDRE
    'FIN DE  ImprimerPdf_et_Mailer1Pdf()


'ENREGISTRER LE FICHIER AVEC DATE
        Client = ThisWorkbook.Worksheets("CLT").Range("e6")  'Nom dans Fichier contenant la macro
        Libell|fffd| = ThisWorkbook.Worksheets("FRS").Range("e8")    'Libell|fffd| de la proposition
        DateEtHre = Format(Now, "yymmddhhmm")                   'DateEtHeureActuelle
        N_devis = DateEtHre
       'Figer le N devis avant enregistrement
        ThisWorkbook.Worksheets("FRS").Range("e6") = N_devis
        Chemin = ThisWorkbook.Path & "\"                        'Chemin = chemin actuel du fichier contenant la macro
        Fichier = Client & " " & Libell|fffd| & " " & N_devis & ".xls"  'fichier = Nom complet du fichier |fffd| enrtegistrer
        'Sauvegarder
        ThisWorkbook.SaveAs Chemin & Fichier


'ETAPE 1 : IMPRIMER LE PDF
    Dim JobPDF As Object
    Dim JobPDF2 As Object
    Dim sNomPDF As String
    Dim sNomPDF2 As String
    Dim sCheminPDF As String
    Dim Objet_du_devis As String
 
    
'DEFINIR LES VARIABLES ET LE CHEMIN POUR L IMPRESSION
    sNomPDF = Client & "_" & Libell|fffd| & "_" & N_devis & ".pdf"  'Nom que prendra le fichier pdf
    sCheminPDF = Chemin               'Chemin ou il sera enregistr|fffd|
 
    If IsEmpty(ActiveSheet.UsedRange) Then Exit Sub    'Si la cellule active est vide sortir de la macro
 
        Set JobPDF = CreateObject("PDFCreator.clsPDFCreator")
 
        With JobPDF
           If .cStart("/NoProcessingAtStartup") = False Then
               MsgBox "Initialisation de PDFCreator impossible", vbCritical + vbOKOnly, "PDFCreator"
               Exit Sub
           End If
           
           .cOption("UseAutosave") = 1
           .cOption("UseAutosaveDirectory") = 1
           .cOption("AutosaveDirectory") = sCheminPDF
           .cOption("AutosaveFilename") = sNomPDF
    
           '   0=PDF, 1=Png, 2=jpg, 3=bmp, 4=pcx, 5=tif, 6=ps, 7=eps, 8=txt
           .cOption("AutosaveFormat") = 0
           .cClearCache
       End With

      
    'IMPRIMER  PDF
    'Range("A1:I" & DerLig).PrintOut Copies:=1, ActivePrinter:="PDFCreator"
    ActiveWorkbook.ActiveSheet.PrintOut COPIES:=1, ActivePrinter:="PDFCreator"
    'Fichier dans la file d'attente
    Do Until JobPDF.cCountOfPrintjobs = 1
        DoEvents
    Loop
    JobPDF.cPrinterStop = False
    
    'Attendre que la file d'attente soit vide (surtout pour Workbook entier)
    Do Until JobPDF.cCountOfPrintjobs = 0
        DoEvents
    Loop
    JobPDF.cClose
    Set JobPDF = Nothing     'LE DOCUMENT EST PRET A ETRE ENVOYE


'OUVRIR OUTLOOK ET REDIGER MESSAGE  OK
    Dim MonOutlook As Object
    Dim MonMessage As Object
    Dim Corps As String
    Dim piece_jointe As String
    Dim MailClient As String
    Set MonOutlook = CreateObject("Outlook.Application")
    Set MonMessage = MonOutlook.createitem(0)
    
    MonMessage.To = Worksheets("CLT").Range("e18")    'Note le destinataire de lEmail
    MonMessage.Subject = Libell|fffd|     'Note l'objet de lEmail  'variable d|fffd|j|fffd| d|fffd|finie plus haut pour L'impression pdf
    MonMessage.body = "Cher(e) client(e), " & vbCrLf & vbCrLf & "Suite |fffd| votre demande, vous trouverez ci joint notre proposition concernant" & vbCrLf & "votre " & Libell|fffd| & vbCrLf & "Esp|fffd|rant que cette proposition retienne toute votre attention,  " & vbCrLf & "je vous prie d'agr|fffd|er mes meilleures salutations. " & vbCrLf & vbCrLf
    MonMessage.body = MonMessage.body & "Gabriel PUGIN" & vbCrLf & "URANUS - www.uranus.fr" & vbCrLf & "T|fffd|l|fffd|phone : 03 88 34 99 72" & vbCrLf & "T|fffd|l|fffd|copie  : 03 88 34 99 73" & vbCrLf & "Messagerie : uranus@uranus.fr"

'ATTACHER PIECE A JOINDRE
    sCheminPDF = ThisWorkbook.Path & "\"     'Chemin ou il est enregistr|fffd|
    '  piece_jointe = "D:\URANUS_P\Devis\Devis en Cours\" & sNomPDF
    piece_jointe = sCheminPDF & "\" & sNomPDF      'KO car le  "\" ne sort pas
    'MsgBox "piece jointe" & piece_jointe
    MonMessage.Attachments.Add piece_jointe  'Attache la piece jointe au mail

    MonMessage.Display  'affiche le message et il ne reste qu'|fffd| le corriger et envoyer
    'Set Raccourci = Nothing
    Set MonOutlook = Nothing
    
End Sub   'FIN DE  ImprimerPdf_et_Mailer1Pdf()
'==================================================================

'======IMPRESSION FACTURE ET MAILER===============================
Sub ImprimerPdf_FACTURE_et_Mailer_Admin_Pdf()

'ETAPE 0 : IMPORTER DERNIERE MISE A JOUR DU CLIENT DANS FICHIER CLIENT
'Reste a faire   Mais cel|fffd| risque de ralentir s|fffd|rienusement la Macro pour les factures r|fffd|currentes qu'il faudra donc faire avec une autre macro sans cel|fffd| car elle utilisera de toutre fa|fffd|on une maj r|fffd|cente.

'ETAPE 1 : IMPRIMER LE PDF
Dim JobPDF As Object
Dim sNomPDF As String
Dim sCheminPDF As String
Dim Objet_du_mail As String  'type de travaux ou service
Dim NumFacture As String
Dim Produit As String
Dim Client As String
Dim Chemin As String
Dim Fichier As String
Dim Extension As String
Dim Ann|fffd|e As String
Dim Jour As String
Dim colonne As String
Dim OngletActif As String
Dim DateFacture As String

' DEFINIR LES VARIABLES ET LE CHEMIN POUR L IMPRESSION
    OngletActif = ActiveSheet.Name  'Onglet actuel
    DateFacture = Range("b14")
    NumFacture = Range("b15")
    Client = Worksheets("CLT").Range("e6")              'Cherche le nom du client
    Objet_du_mail = "Votre Facture N|fffd| " & NumFacture & " du " & DateFacture   'Cherche l'objet du devis
    sNomPDF = NumFacture & "_" & Client & "_" & OngletActif & ".pdf" 'Nom que prendra le fichier pdf
    sCheminPDF = ThisWorkbook.Path & "\"                 'Chemin ou il sera enregistr|fffd|
 
    If IsEmpty(ActiveSheet.UsedRange) Then Exit Sub    'Si la cellule active est vide sortir de la macro
 
    Set JobPDF = CreateObject("PDFCreator.clsPDFCreator")
 
       With JobPDF
           If .cStart("/NoProcessingAtStartup") = False Then
               MsgBox "Initialisation de PDFCreator impossible", vbCritical + vbOKOnly, "PDFCreator"
               Exit Sub
           End If
           
           .cOption("UseAutosave") = 1
           .cOption("UseAutosaveDirectory") = 1
           .cOption("AutosaveDirectory") = sCheminPDF
           .cOption("AutosaveFilename") = sNomPDF
    
           '   0=PDF, 1=Png, 2=jpg, 3=bmp, 4=pcx, 5=tif, 6=ps, 7=eps, 8=txt
           .cOption("AutosaveFormat") = 0
           .cClearCache
       End With
      
   ' IMPRIMER  PDF
    'Range("A1:J" & DerLig).PrintOut Copies:=1, ActivePrinter:="PDFCreator"
    ActiveWorkbook.ActiveSheet.PrintOut COPIES:=1, ActivePrinter:="PDFCreator"
    'Fichier dans la file d'attente
    Do Until JobPDF.cCountOfPrintjobs = 1
        DoEvents
    Loop
    JobPDF.cPrinterStop = False
    
    'Attendre que la file d'attente soit vide (surtout pour Workbook entier)
    Do Until JobPDF.cCountOfPrintjobs = 0
        DoEvents
    Loop
    JobPDF.cClose
    Set JobPDF = Nothing     'LE DOCUMENT EST PRET A ETRE ENVOYE

'OUVRIR OUTLOOK ET ENVOYER PIECES JOINTES OK
    Dim MonOutlook As Object
    Dim MonMessage As Object
    Dim Corps As String
    Dim piece_jointe As String
    Dim Mail_Site As String
    Dim Mail_Admin As String
    Dim Mail_Fact As String
    Dim AcceptMail As String
    
    Mail_Fact = Worksheets("CLT").Range("e41")
'    Mail_Admin = Worksheets("CLT").Range("e38")
'    Mail_Site = Worksheets("CLT").Range("e18")
    AcceptMail = Worksheets("CLT").Range("e40")
    'MsgBox "Mail_Fact =" & Mail_Fact
    
        If Mail_Fact = "" Or IsEmpty(Worksheets("CLT").Range("e41")) Then  'Le mail admistratif n'est pas renseign|fffd| prendre le mail d'installation
        'Mail_Fact = Worksheets("CLT").Range("e41")
        Mail_Fact = Worksheets("CLT").Range("e38")
        End If
        
        If Mail_Fact = "" Or IsEmpty(Worksheets("CLT").Range("e38")) Then  'Le mail admistratif n'est pas renseign|fffd| prendre le mail d'installation
        'Mail_Fact = Worksheets("CLT").Range("e41")
        Mail_Fact = Worksheets("CLT").Range("e18")
        End If
    
    Set MonOutlook = CreateObject("Outlook.Application")
    Set MonMessage = MonOutlook.createitem(0)
    
    MonMessage.To = Mail_Fact
    MonMessage.Subject = Objet_du_mail     'variable d|fffd|j|fffd| d|fffd|finie plus haut pour L'impression pdf
    MonMessage.body = "Cher(e) client(e), " & vbCrLf & vbCrLf & _
    "Veuillez trouver ci joint votre Facture N|fffd| " & NumFacture & " du " & DateFacture & vbCrLf _
    & vbCrLf & "Si vous optez pour un r|fffd|glement par virement bancaire, n'omettez pas de mentionner le num|fffd|ro de la facture dans l'objet du virement. " & vbCrLf _
    & "Nos coordonn|fffd|es bancaires sont indiqu|fffd|es sur le document." & vbCrLf _
    & vbCrLf & vbCrLf & "Nous restons |fffd| votre enti|fffd|re disposition pour de plus amples informations." & vbCrLf & _
    "Meilleures salutations." & vbCrLf & vbCrLf & _
    "Service comptabilit|fffd|." & vbCrLf & vbCrLf
    MonMessage.body = MonMessage.body & vbCrLf & "URANUS - www.uranus.fr" & vbCrLf & "T|fffd|l|fffd|phone : 03 88 34 99 72" & vbCrLf & "T|fffd|l|fffd|copie  : 03 88 34 99 73" & vbCrLf & "Messagerie : uranus@uranus.fr"

    'ATTACHER PIECE A JOINDRE
    sCheminPDF = ThisWorkbook.Path & "\"     'Chemin ou il est enregistr|fffd|
    '  piece_jointe = "D:\URANUS_P\Devis\Devis en Cours\" & sNomPDF
    piece_jointe = sCheminPDF & "\" & sNomPDF      'KO car le  "\" ne sort pas
    MonMessage.Attachments.Add piece_jointe  'Attache la piece jointe

    MonMessage.Display  'affiche le message et il ne reste qu'|fffd| le corriger et envoyer
    'Set Raccourci = Nothing
    Set MonOutlook = Nothing
    
End Sub  '======'FIN ImprimerPdf_FACTURE_et_Mailer_Admin_Pdf()======================
'=================================================================================================================
 
'======IMPRESSION RELANCE FACTURE ET MAILER===============================
Sub ImprimerPdf_RELANCE_et_Mailer_Admin_Pdf()

'ETAPE 1 : IMPRIMER LE PDF
Dim JobPDF As Object
Dim sNomPDF As String
Dim sCheminPDF As String
Dim Objet_du_mail As String  'type de travaux ou service

Dim NumFacture As String
Dim Produit As String
Dim Client As String
Dim Chemin As String
Dim Fichier As String
Dim Extension As String
Dim Ann|fffd|e As String
Dim Jour As String
Dim colonne As String
Dim OngletActif As String
Dim DateFacture As String
 
'METTRE A JOUR LA DATE DE RELANCE ET SAUVEGARDER CETTE DATE
ThisWorkbook.Worksheets("relance").Range("i25") = Date
ThisWorkbook.Worksheets("relance").Range("l24") = "Suite relance du " & Date
ThisWorkbook.Save
 
'DEFINIR LES VARIABLES ET LE CHEMIN POUR L IMPRESSION
    OngletActif = ActiveSheet.Name  'Onglet actuel
    DateEtHre = Format(Now, "dd/mm/yy")
    DateFacture = DateEtHre    'Range("b14")
    NumFacture = Range("b15")
    Client = Worksheets("CLT").Range("e6")              'Cherche le nom du client
    Objet_du_mail = "Relance comptabilit|fffd|. "
    sNomPDF = Client & "_" & OngletActif & "_" & Format(Date, "dd-mmmm-yyyy") & ".pdf"     'Nom que prendra le fichier pdf
    sCheminPDF = ThisWorkbook.Path & "\"               'Chemin ou il sera enregistr|fffd|
    'sCheminPDF = ThisWorkbook.Path & Format(Date, "dd-mmmm-yyyy")
 
 'CREER AVEC DATE
        'MkDir (Chemin & "\" & "00 Fact R|fffd|current " & Ann|fffd|e & "_" & Format(Date, "dd-mmmm-yyyy") & "_" & Format(Time, "hh-mm"))
 
    If IsEmpty(ActiveSheet.UsedRange) Then Exit Sub    'Si la cellule active est vide sortir de la macro
 
    Set JobPDF = CreateObject("PDFCreator.clsPDFCreator")
 
       With JobPDF
           If .cStart("/NoProcessingAtStartup") = False Then
               MsgBox "Initialisation de PDFCreator impossible", vbCritical + vbOKOnly, "PDFCreator"
               Exit Sub
           End If
           
           .cOption("UseAutosave") = 1
           .cOption("UseAutosaveDirectory") = 1
           .cOption("AutosaveDirectory") = sCheminPDF
           .cOption("AutosaveFilename") = sNomPDF
    
           '   0=PDF, 1=Png, 2=jpg, 3=bmp, 4=pcx, 5=tif, 6=ps, 7=eps, 8=txt
           .cOption("AutosaveFormat") = 0
           .cClearCache
       End With
      
   'IMPRIMER  PDF
    'Range("A1:J" & DerLig).PrintOut Copies:=1, ActivePrinter:="PDFCreator"
    ActiveWorkbook.ActiveSheet.PrintOut COPIES:=1, ActivePrinter:="PDFCreator"
    'Fichier dans la file d'attente
    Do Until JobPDF.cCountOfPrintjobs = 1
        DoEvents
    Loop
    JobPDF.cPrinterStop = False
    
    'Attendre que la file d'attente soit vide (surtout pour Workbook entier)
    Do Until JobPDF.cCountOfPrintjobs = 0
        DoEvents
    Loop
    JobPDF.cClose
    Set JobPDF = Nothing     'LE DOCUMENT EST PRET A ETRE ENVOYE

'OUVRIR OUTLOOK ET ENVOYER PIECES JOINTES OK
    Dim MonOutlook As Object
    Dim MonMessage As Object
    Dim Corps As String
    Dim piece_jointe As String
    Dim Mail_Fact As String
    
    Mail_Fact = Worksheets("CLT").Range("e38")
    'MsgBox "Mail_Fact =" & Mail_Fact
        If Mail_Fact = "" Or IsEmpty(Worksheets("CLT").Range("e38")) Then  'Le mail admistratif n'est pas renseign|fffd| prendre le mail d'installation
        Mail_Fact = Worksheets("CLT").Range("e18")
        End If
    
    Set MonOutlook = CreateObject("Outlook.Application")
    Set MonMessage = MonOutlook.createitem(0)
    
    MonMessage.To = Mail_Fact
    MonMessage.Subject = Objet_du_mail     'variable d|fffd|j|fffd| d|fffd|finie plus haut pour L'impression pdf
    MonMessage.body = "Cher(e) client(e), " & vbCrLf & vbCrLf & _
    "Veuillez trouver ci joint le d|fffd|tail d'un r|fffd|glement qui n'aurait pas |fffd|t|fffd| effectu|fffd| |fffd| ce jour. " & vbCrLf _
    & vbCrLf & "Si vous optez pour un r|fffd|glement par virement bancaire, n'omettez pas de mentionner le num|fffd|ro de la facture dans l'objet du virement. " _
    & "Nos coordonn|fffd|es bancaires sont indiqu|fffd|es sur le document." & vbCrLf _
    & vbCrLf & vbCrLf & "Nous restons |fffd| votre enti|fffd|re disposition pour de plus amples informations." & vbCrLf & _
    "Meilleures salutations." & vbCrLf & vbCrLf & _
    "Service comptabilit|fffd|." & vbCrLf & vbCrLf
    MonMessage.body = MonMessage.body & vbCrLf & "URANUS - www.uranus.fr" & vbCrLf & "T|fffd|l|fffd|phone : 03 88 34 99 72" & vbCrLf & "T|fffd|l|fffd|copie  : 03 88 34 99 73" & vbCrLf & "Messagerie : uranus@uranus.fr"

    'ATTACHER PIECE A JOINDRE
    sCheminPDF = ThisWorkbook.Path & "\"     'Chemin ou il est enregistr|fffd|
    '  piece_jointe = "D:\URANUS_P\Devis\Devis en Cours\" & sNomPDF
    piece_jointe = sCheminPDF & "\" & sNomPDF      'KO car le  "\" ne sort pas
    MonMessage.Attachments.Add piece_jointe  'Attache la piece jointe

    MonMessage.Display  'affiche le message et il ne reste qu'|fffd| le corriger et envoyer
    'Set Raccourci = Nothing
    Set MonOutlook = Nothing
    
    'MEMORISER LA RELANCE
        'Le fichier de relance est d|fffd|j|fffd| automatiquement conserv|fffd| |fffd| cot|fffd| de la facture.
        'La date a |fffd|t|fffd| ajust|fffd|e au d|fffd|but et sauvegard|fffd|e.
End Sub  'FIN DE ImprimerPdf_RELANCE_et_Mailer_Admin_Pdf()
'=================================================================================================================
 

'=================================================================================================================
 Sub EnregistrerNouveauDevis() 'ENREGISTRER LE NOUVEAU DEVIS au d|fffd|part,pour |fffd|viter d'effacer "devis vierge"

'***TROUVER LE CHEMIN REPERTOIRE DIRECTORY DE LA SOCIETE URANUS |fffd| partir du chemin relatif du dossier en cours
        'POSITION dans le chemin relatif en cours de l'occurence de la soci|fffd|t|fffd| URANUS
        Dim PoSoc As String
        PoSoc = InStrRev(ThisWorkbook.Path, "URANUS", [-1], [vbTextCompare])
            '[-1] Optionnel. C'est la position de d|fffd|part pour la recherche. -1 Si ce param|fffd|tre est omis, la recherche commencera |fffd| la position -1, qui est la derni|fffd|re position du caract|fffd|re.
            '[vbTextCompare] compare le texte et non plus du binaire
            'MsgBox P  '18  car dans le chemin '\\192.168.92.205\URANUS\Devis\Devis en cours,
            'l'occurrence URANUS commence a la 18 ieme position
        'VERIFIER QUE L'ON EST BIEN DANS LE REPERTOIRE DE LA SOCIETE
            If PoSoc = 0 Then  'Dire erreur emplacement
            MsgBox "Mauvais emplacement de fichier. Votre soci|fffd|t|fffd| est introuvable dans ce repertoire. Assurez vous que fichier utilis|fffd| se trouve bien dans le r|fffd|pertoire de votre soci|fffd|t|fffd|"
            Exit Sub
            Else   'rien
            End If
        'CHEMIN REEL DU REPERTOIRE DE LA SOCIETE URANUChemin r|fffd|el du dossier Soci|fffd|t|fffd|
        Dim DirSoc As String
        DirSoc = Left(ThisWorkbook.Path, PoSoc + 5)   '+5 Pour laisser les 5 lettres de la soci|fffd|t|fffd| URANUS
            'MsgBox "DirSoc : " & DirSoc   '\\192.168.92.205\uranus
            'ChDir DirSoc    'Changer la Directory pour le chemin par d|fffd|faut d'enregistrement du fichier
'***Fin de TROUVER LE CHEMIN DIRECTORY DE LA SOCIETE
             
'PREPARER LES VARIABLES POUR ENREGISTREMENT DU FICHIER
        NomClient = ThisWorkbook.Worksheets("CLT").Range("e6")  'Nom dans Fichier contenant la macro
        Libell|fffd| = ThisWorkbook.Worksheets("FRS").Range("e8")
        Chemin = DirSoc & "\Devis\Devis en cours\"
        Fichier = NomClient & " " & Libell|fffd| & ".xls"   'Nom du Fichier pour enregistrement
        On Error GoTo SortirDuDoublon   'Aller en bas de macro pour sortir et dire que la doublon n'a pas |fffd|t|fffd| remplac|fffd|.
        'Sinon on est pas en erreur donc continuer |fffd| sauver le fichier
'ENREGISTRER LE FICHIER
        ThisWorkbook.SaveAs Chemin & Fichier
'VERIFIER QUE NOM DE DEVIS N'EXISTE PAS DEJA CAR SI DOUBLON ET QU'ON REPOND QU'ON NE VEUT PAS LE REMPLACER Il doit aller a "sortir" en bas de la macro
        'A Faire
'SELECTIONNER LES CELLULES POUR ETRE PRET A EFFACER
        Application.Goto ThisWorkbook.Worksheets("FRS").Range("C15:F37") 'pour etre pr|fffd|t |fffd| l'effacer
Exit Sub
'DOUBLON > Le dire et sortir On ne passe ici que si erreur fichier existant et qu'on a r|fffd|pondu qu'on ne veut pas le Remplacer
SortirDuDoublon:
    MsgBox ("DOUBLON : Un devis |fffd| ce nom existe d|fffd|j|fffd| Il n a donc pas |fffd|t|fffd| remplac|fffd|")
    End
End Sub   'FIN DE EnregistrerNouveauDevis()
'=================================================================================================================

Attribute VB_Name = "Module2_TRAVAIL"
'====================================================
'TRAVAIL SUR LES MACROS
'====================================================

'FACTURER
Public Fmax As Integer
Public SsDosMax As String
Public NumDosMax As Integer
Public NomDosMax As String
Public ChemDosMax As String
Public DebNom As String
Public Ds, Ch, Di, SsDos 'pour recherche SOUS Dossiers
Public NomFact As String

Sub Facturer()
    Fmax = 0
'DEMANDER LA DATE DE FACTURATION
    Dim DateF As Date
    DateF = InputBox("Saisissez la date de facture : 01/01/2010", "Date De Facture", "01/01/2010")
'EXTRAIRE LE MOIS ET ANNEE POUR PREPARER CHEMIN DossFact
    Dim Mois As Variant
    Mois = Month(DateF)                 'affiche 1
    An = Right(Year(DateF), 2)          'affiche 19
    MoisTexte = Left(MonthName(Month(DateF)), 4) 'affiche janv
    NM2Chif = Format((Mois), "00")      'Affiche 11
    DossFact = NM2Chif & " Fact " & MoisTexte & " " & An 'Affiche "01 Fact janv 19"
    'MsgBox "DossFact : " & DossFact
'DEMANDER LE PRODUIT AVEC VERIF   'Proposer plutot un choix
    Dim Produit As Variant
    Produit = InputBox("Saisissez le Produit :", "PRODUIT", "Insta, Loc, Entr ... ")
    'MsgBox Produit
'RECHERCHER DANS SOUS DOSSIERS DE FACTURES EN COUR LE DERNIER NUMERO DE FACTURE Fmax
    'Dim CheminFact As String D|fffd|j|fffd| d|fffd|fini
    CheminFact = "\\192.168.92.205\uranus\Factures\Fact en Cours"
    Chemin = "\\192.168.92.205\uranus\Factures\Fact en Cours"
    Rech_DansSOUSDossiers
    'MsgBox "FMax en fin de macro  = " & Fmax
    'MsgBox "ChemDosMax : " & ChemDosMax  '"\\192.168.92.205\uranus\Factures\Fact en Cours\10 Fact Oct 19\"
    'MsgBox "NomDosMax : " & NomDosMax ' "\10 Fact Oct 19\"
    DebNom = Left(NomDosMax, 3)  ' "\10"
    'MsgBox "DebNom: " & DebNom  ' "10"
    NumDosMax = Right(DebNom, 2)
    'MsgBox "NumDosMax : " & NumDosMax
    'DebNom = Left(Right(NomDosMax, 1), 2)
    'MsgBox "NumDosMax: " & NumDosMax
'VERIFIER SI CE MOIS EXISTE DEJA ET DANS CE CAS RECHERCHER LE DERNIER NUMERO DE FACTURE FAITE
    'MsgBox "Mois: " & Mois
'SINON CREER LE MOIS M ET RECHERCHER LE DERNIER NUMERO DE FACTURE FAITE DANS M-1

'CONTEXTE
    If ActiveSheet.Name = "Options" Then Feuille = "Fact"
    If ActiveSheet.Name = "Desc." Then
        'DEMANDER SI C'EST UNE LOCATION
            Dim location As Long
            'CREATION D'UNE MSGBOX LOCATION ? "Oui - Non ":
                location = MsgBox(Prompt:="Est ce une location ? ", Buttons:=vbYesNo)
                'Si on a cliqu|fffd| sur Oui, on souhaite loue:
                If location = vbYes Then
                    'Feuille = "F.loc"
                    Feuille = "F.inst"  'On facture d abord la main d'oeuvre
                    Produit = "Insta"
                    'MsgBox "location. oui " & Feuille
                    'Faire une boucle pour facturer Insta puis loc
                Else
                    Feuille = "Fact"
                    Produit = "Insta"
                End If
        Else
        End If
    'Exit Sub
'DEMANDER LE TYPE DE FACTURE A FAIRE
    'UserForm1_Produit.Show
    'Dim TypeF As String
    'TypeF = InputBox("Saisissez le Type :", "TypeF", "MO Installation")
     'MsgBox "Type" & TypeF
    'Else 'Alors on est dans 'Options
    'Feuille = "Fact"
'End If
'Exit Sub

'COLLER LES INFORMATIONS dans la feuille de facture
    'DATE
    ThisWorkbook.Worksheets(Feuille).Range("B14") = DateF
    'NUMERO DE FACTURE
    ThisWorkbook.Worksheets(Feuille).Range("B15") = Fmax + 1
    'PRODUIT
    ThisWorkbook.Worksheets(Feuille).Range("M1") = "Produit"
'VERIFIER SI CETTE FACTURE EXISTE DANS LE REALISE ET SINON COMPLETER

'PREPARER LE CHEMIN POUR L'ENREGISTREMENT ET LE NOM DE FACTURE SI MOIS INCHANGE
    CheminFact = "\\192.168.92.205\uranus\Factures\Fact en Cours"
    NomFact = Fmax + 1 & " " & ThisWorkbook.Worksheets("CLT").Range("e5") & ".xls"
    'ChemF = CheminFact & NomDosMax & "\" & NomFact
     ChemF = CheminFact & "\" & DossFact
'    MsgBox "ChemF : " & ChemF
'CREER LE SOUS DOSSIER SI IL N'EXISTE PAS
    On Error Resume Next  'si le dossier existe alors erreur donc ne pas cr|fffd|er
    MkDir ChemF
'COMPLETER AVEC LE NOM DE FACTURE
    ChemF = ChemF & "\" & NomFact
   'Exit Sub
'ENREGISTRER LE FICHIER
    ThisWorkbook.SaveAs ChemF
    Sheets(Feuille).Activate
    'TransformerCeDevisEnFactureN
End Sub

Sub Rech_DansSOUSDossiers()  ' factures .xls ou .xlsx
'REPERTORIER LES SOUS DOSSIERS DE L'OBJET FOLDER rep|fffd|r|fffd| par "chemin"
    'Dim Ds, Ch, Di, SsDos  'D|fffd|j|fffd| d|fffd|clar|fffd|s en haut
    Set Ds = CreateObject("Scripting.FileSystemObject")  'Cr|fffd|er objet
    Set Ch = Ds.GetFolder(Chemin)   'GETFOLDER renvoie l'objet FOLDER du fichier "Chemin"
    Set SsDos = Ch.SubFolders '= SousDossiers du dossier Ch
'RECHERCHER POUR CHAQUE SOUS DOSSIER "Di" contenu dans la liste des SOUS DOSSIERS
    For Each Di In SsDos   '\\192.168.92.205\uranus\Factures\Fact en Cours\00 Fact rec ...
        Chemin = Di & "\"
        BoucleRech_FactureMax
    'MsgBox "ch  " & Ch
    'MsgBox "Di  " & Di
   ' MsgBox "Replace di ch rien  " & Replace(Di, Ch, "")
    'MsgBox "SsDos  " & SsDos
    Next
End Sub  'Rech_DansSOUSDossiers

Sub BoucleRech_FactureMax()
        CptFich = 1  'initial pour le premier fichier |fffd| comparer
        CptFichMax = NombreFichiers(Chemin) 'Appelle la macro compteur de fichier pour savoir quand sortir de la boucle
        'fichierN = Dir(Chemin & "*19*" & "*.xls*")  'Facture a chercher .xls ou .xlsx
        'Fich = Dir(Chemin & "*.xls*")    'Fichiers .xls* trouv|fffd|s dans repertoire
        Fich = Dir(Chemin & "*.xls*")     'Fichiers .xls* trouv|fffd|s dans repertoire
        'MsgBox "fICH & Fichier N  " & Fich & " / " & fichierN
'BOUCLER SUR TOUS LES FICHIERS .xls ou .xlsx du repertoire
    Do While Len(Fich) > 0   'Donc Tant que des fichiers .xls ou xlsx sont trouv|fffd|s v|fffd|rifier si |fffd|gaux N
        Num = Left(Fich, 5)

   '  If Fich = "" Or Num = 0 Or Num = "" Then
     'MsgBox "ne rien faire" 'ne rien faire car cel|fffd| remettrait le compteur a 0
   '  Else
            If Num > Fmax Then       'Facture max 1 trouv|fffd|e
                Fmax = Num
                ChemDosMax = Chemin
                'NumDosMax = NumDosMax
                'NumDosMax = Chemin
                NomDosMax = Replace(Di, Ch, "")
            Else   'Ce fichier n'est pas sup|fffd|rieur fichier suivant
            End If
   ' End If
    'REINITIALISE Fich |fffd| "" avant de boucler |fffd| la recherche du fichier suivant
    Fich = Dir()     'Passe au fichier suivant du DOSSIER
    Loop 'Until CptFich = CptFichMax
End Sub  'BoucleRech_FichierN_DossierX

'FONCTION POUR CALCULER LE NOMBRE DE FICHIERS A UTILISER DANS MACROS SUIVANTES
Function NombreFichiers(ByVal Dossier As String) As Long 'pour calculer les fichier de macro pr|fffd|c|fffd|dente
    Set FSO = CreateObject("Scripting.FileSystemObject")
    NombreFichiers = FSO.GetFolder(Dossier).Files.Count
    Set FSO = Nothing
End Function



Sub TransformerCeDevisEnFactureN()
Application.ScreenUpdating = False
    Dim CheminClient As String
    Dim CheminDevis As String
'TROUVER LE CHEMIN REPERTOIRE DIRECTORY DE LA SOCIETE URANUS |fffd| partir du chemin relatif du dossier en cours
    'POSITION dans le chemin relatif en cours de l'occurence de la soci|fffd|t|fffd| URANUS
        Dim PoSoc As String
        PoSoc = InStrRev(Chemin, "URANUS", [-1], [vbTextCompare])
        
        
        CheminCLT = "\\192.168.92.205\uranus\Clients\Clients en cours"
        CheminFact = "\\192.168.92.205\uranus\Factures\Fact en Cours"
        BDD = CheminCLT & "\BaseAccess.accdb"
        
        
    'VERIFIER QUE L'ON EST BIEN DANS LE REPERTOIRE DE LA SOCIETE
            If PoSoc = 0 Then  'Dire erreur emplacement
            MsgBox "Mauvais emplacement de fichier. Votre soci|fffd|t|fffd| est introuvable dans ce repertoire. Assurez vous que fichier utilis|fffd| se trouve bien dans le r|fffd|pertoire de votre soci|fffd|t|fffd|"
            Exit Sub
            Else   'rien
            End If
    'CHEMIN DirSoc REEL DU REPERTOIRE DE LA SOCIETE URANUChemin r|fffd|el du dossier Soci|fffd|t|fffd|
        Dim DirSoc As String
        DirSoc = Left(Chemin, PoSoc + 5)   '+5 Pour laisser les 5 lettres de la soci|fffd|t|fffd| URANUS
'DEFINIR LES CHEMINS pour les dossiers CLIENTS, DEVIS Et FACTURES
    'MEMORISER LE CHEMIN du dossier CLIENTS ACTUEL
    CeDevis = ThisWorkbook.Name    'Pour refermer ce classeur
    CheminClient = DirSoc & "\" & "Clients\Clients en cours"
    CheminDevis = DirSoc & "\" & "Devis\Devis en Cours\"
    Chemin = DirSoc & "\" & "Factures\Fact en Cours\Factures "
    Chemin = Replace(Chemin, "\\\", "\\")     'Pour |fffd|viter d'avoir selon la version Excel  ... uranus\\\Factures ....
    sCheminPDF = Chemin & "\" & "\00 Fact R|fffd|current " & Ann|fffd|e & "\PDF"
    'Si LE DOSSIER EXISTE DEJA AVERTIR  A faire plus bas
'VERIFIER SI "!DEVIS VIERGE.xls" EST DEJA OUVERT. V|fffd|rifier si la liste des fichiers ouverts contient d|fffd|j|fffd| "!DEVIS VIERGE.xls"
        Dim Fich As Variant
        estouvert = False
        Nom_Du_Fichier = "!DEVIS VIERGE.xls"
        'MsgBox ("Nom du fichier pour v|fffd|rif fich ouvert = " & Nom_Du_Fichier)
        For Each Fich In Workbooks         ' On a un s |fffd| workbooks  dans un autre tuto
            'MsgBox ("Fich.name = " & Fich.Name)
            If Fich.Name = Nom_Du_Fichier Then estouvert = True
        Next
            '- Si la variable estouvert est encore True (vrai) alors le fichier DEVIS VIERGE est juste |fffd| activer
            If estouvert = True Then   'Le fichier "Clients.xls" est ouvert. L'activer
                Workbooks(Nom_Du_Fichier).Activate
                Else       'Sinon (Estouvert=False)Il faut l'ouvrir
                 Workbooks.Open Filename:=CheminDevis & "!DEVIS VIERGE.xls"  'Commande OK depuis PC13 mais longue
            End If
' COPIER LES CELLULES DU CLIENT "F" dans "!DEVIS VIERGE.xls"
' DEMANDE DE VALEUR PRODUIT()
'FIGER LA DATE DANS LE "DEVIS VIERGE" AVANT ENREGISTREMENT
    Workbooks("!Devis Vierge.xls").Worksheets("FRS").Range("e5") = Workbooks("!Devis Vierge.xls").Worksheets("FRS").Range("e5")
'ENREGISTRER CE NOUVEAU DEVIS APRES INCREMENTATION DU NUMERO DE DEVIS
    Application.Run ("'!DEVIS VIERGE.xls'!EnregistrerNouveauDevis")     'Sauve le devis Client en cours
    'application.run ne s'utilise que pour appeller une macro d'un autre document sinon faire un CALL
'FERMER "clients" SANS ENREGISTRER
        Application.DisplayAlerts = False   'Annule toutes les alertes Excel
        Workbooks(CeDevis).Close            'Ferme le classeur
        Application.DisplayAlerts = True    'Restaure l'affichage des Alertes
End Sub 'ExporterClientVersDevisAvecDemandeProduit




Sub ExporterFVersDevisAvecDemandeProduit()
Application.ScreenUpdating = False
    Dim CheminClient As String
    Dim CheminDevis As String
'TROUVER LE CHEMIN REPERTOIRE DIRECTORY DE LA SOCIETE URANUS |fffd| partir du chemin relatif du dossier en cours
    'POSITION dans le chemin relatif en cours de l'occurence de la soci|fffd|t|fffd| URANUS
        Dim PoSoc As String
        PoSoc = InStrRev(Chemin, "URANUS", [-1], [vbTextCompare])
    'VERIFIER QUE L'ON EST BIEN DANS LE REPERTOIRE DE LA SOCIETE
            If PoSoc = 0 Then  'Dire erreur emplacement
            MsgBox "Mauvais emplacement de fichier. Votre soci|fffd|t|fffd| est introuvable dans ce repertoire. Assurez vous que fichier utilis|fffd| se trouve bien dans le r|fffd|pertoire de votre soci|fffd|t|fffd|"
            Exit Sub
            Else   'rien
            End If
    'CHEMIN DirSoc REEL DU REPERTOIRE DE LA SOCIETE URANUChemin r|fffd|el du dossier Soci|fffd|t|fffd|
        Dim DirSoc As String
        DirSoc = Left(Chemin, PoSoc + 5)   '+5 Pour laisser les 5 lettres de la soci|fffd|t|fffd| URANUS
'DEFINIR LES CHEMINS pour les dossiers CLIENTS, DEVIS Et FACTURES
    'MEMORISER LE CHEMIN du dossier CLIENTS ACTUEL
    CeDevis = ThisWorkbook.Name    'Pour refermer ce classeur
    CheminClient = DirSoc & "\" & "Clients\Clients en cours"
    CheminDevis = DirSoc & "\" & "Devis\Devis en Cours\"
    Chemin = DirSoc & "\" & "Factures\Fact en Cours\Factures "
    Chemin = Replace(Chemin, "\\\", "\\")     'Pour |fffd|viter d'avoir selon la version Excel  ... uranus\\\Factures ....
    sCheminPDF = Chemin & "\" & "\00 Fact R|fffd|current " & Ann|fffd|e & "\PDF"
    'Si LE DOSSIER EXISTE DEJA AVERTIR  A faire plus bas
'VERIFIER SI "!DEVIS VIERGE.xls" EST DEJA OUVERT. V|fffd|rifier si la liste des fichiers ouverts contient d|fffd|j|fffd| "!DEVIS VIERGE.xls"
        Dim Fich As Variant
        estouvert = False
        Nom_Du_Fichier = "!DEVIS VIERGE.xls"
        'MsgBox ("Nom du fichier pour v|fffd|rif fich ouvert = " & Nom_Du_Fichier)
        For Each Fich In Workbooks         ' On a un s |fffd| workbooks  dans un autre tuto
            'MsgBox ("Fich.name = " & Fich.Name)
            If Fich.Name = Nom_Du_Fichier Then estouvert = True
        Next
            '- Si la variable estouvert est encore True (vrai) alors le fichier DEVIS VIERGE est juste |fffd| activer
            If estouvert = True Then   'Le fichier "Clients.xls" est ouvert. L'activer
                Workbooks(Nom_Du_Fichier).Activate
                Else       'Sinon (Estouvert=False)Il faut l'ouvrir
                 Workbooks.Open Filename:=CheminDevis & "!DEVIS VIERGE.xls"  'Commande OK depuis PC13 mais longue
            End If
' COPIER LES CELLULES DU CLIENT "F" dans "!DEVIS VIERGE.xls"
    Dim i As Integer
    For i = 0 To DerChamp - 1
    Workbooks("!Devis Vierge.xls").Worksheets("CLT").Range("e5").Offset(i, 0) = ThisWorkbook.Worksheets("F").Range("C5").Offset(i, 0)
    Next i
' DEMANDE DE VALEUR PRODUIT()
    Dim Produit As String
    Produit = InputBox("Pr|fffd|ciser le Produit :  Installation t|fffd|l|fffd|phonique ou autre", "CHOIX DU PRODUIT", "Installation t|fffd|l|fffd|phonique")  'La variable re|fffd|oit la valeur entr|fffd|e dans l'InputBox
    If Produit <> "" Then 'Si la valeur est diff|fffd|rente de "" on affiche l'Objet
    End If
'NOTER LE PRODUIT DANS LE "DEVIS VIERGE"
    Workbooks("!Devis Vierge.xls").Worksheets("FRS").Range("e8") = Produit 'Noter Produit dans "DEVIS VIERGE"
'FIGER LA DATE DANS LE "DEVIS VIERGE" AVANT ENREGISTREMENT
    Workbooks("!Devis Vierge.xls").Worksheets("FRS").Range("e5") = Workbooks("!Devis Vierge.xls").Worksheets("FRS").Range("e5")
'INCREMENTER LE NUMERO DEVIS
    Application.Run ("'!DEVIS VIERGE.xls'!Incr|fffd|menterNum|fffd|roDeDevis")    'Incr|fffd|mente le compteur du Devis Vierge et SAUVE le DEVIS VIERGE
'ENREGISTRER CE NOUVEAU DEVIS APRES INCREMENTATION DU NUMERO DE DEVIS
    Application.Run ("'!DEVIS VIERGE.xls'!EnregistrerNouveauDevis")     'Sauve le devis Client en cours
    'application.run ne s'utilise que pour appeller une macro d'un autre document sinon faire un CALL
'FERMER "clients" SANS ENREGISTRER
        Application.DisplayAlerts = False   'Annule toutes les alertes Excel
        Workbooks(CeDevis).Close            'Ferme le classeur
        Application.DisplayAlerts = True    'Restaure l'affichage des Alertes
End Sub 'ExporterClientVersDevisAvecDemandeProduit

'APPELER LE FICHIER TARIFS
Sub OuvrirTarifG|fffd|n|fffd|ral()
   ' Workbooks(clt).Worksheets("Clients").Range(Cells(6, 1), Cells(derlin, DerChamp)).Open
Workbooks.Open Filename:="\\192.168.92.205\uranus\Tarifs\" & "\Tarifs G|fffd|n|fffd|ral.xls"
'Tarifs = "\\192.168.92.205\uranus\Tarifs\"
'Workbooks.Open Filename:=Tarifs
End Sub

Sub OuvrirTarifs()
Dim MonDossier As String
Dim Tarifs As String
Tarifs = "\\192.168.92.205\uranus\Tarifs\"
    If Len(Dir(Tarifs, vbDirectory)) > 0 Then 'v|fffd|rifie si le Dossier existe
       Shell Environ("WINDIR") & "\explorer.exe " & Tarifs, vbNormalFocus
    End If
End Sub

Attribute VB_Name = "Module4_ImportBDDclt"
'  FEUILLE  IMPORT BDD vers CLT
'''''''''''''''''''''''''''''''''''''

'NETTOYER TOUTE LES PLAGES DU FORMULAIRE "CLT"
Sub NettoyerF()
    Worksheets("CLT").Activate  'Ouvre la feuille F  'sinon bogue pour nettoyage
    'MsgBox ("corriger ici car 3 nettoyage successifs a l'ouverture du fichier")
    Worksheets("CLT").Range(Cells(4, 5), Cells(4 + DerChamp, 5)).ClearContents
End Sub  'NettoyerF

'EXTRAIRE LES CHAMPS POUR LES METTRES DANS EXCEL pour un nom de dossier C3 modifi|fffd| dans combo "ListDossiers"
Sub ImportBDDversCLT()
Application.ScreenUpdating = False 'pour ne pas voir le d|fffd|filement lors de la recherche
    Dim critere As String   'critere servira |fffd| m|fffd|moriser la Clause WHERE
    Dim Val As String    'Valeur a rechercher
    Dim C As String  'Pour copier les champs de la BDD
    Dim enr As Recordset    'pour manipuler les enregistrements  >vba >menu Projets > R|fffd|f|fffd|rences : "Microsoft AtiveX Data Objects 2.x Library"
    Dim base As Database   'Type defini par l utilisateur non defini  > Necessite de cocher la r|fffd|f|fffd|rence "Microsoft DAO 3.6 Object library" dans le menu VBA OUTILS / R|fffd|f|fffd|rence
'D|fffd|sactive les |fffd|v|fffd|nements
  Application.EnableEvents = False
'MEMORISER LE NOM DE DOSSIER AVANT NETTOYAGE
     Val = Worksheets("CLT").Range("e2").Value 'NomDossier
'APPELER LA PROCEDURE NettoyerF  pour vider la zone d extraction
    NettoyerF
'CHARGER LA VARIABLE CRITERE EN FONCTION DES CELLULES DE CRITERE RENSEIGNEES  MEME quelques lettre et n'importe o|fffd| dans le texte !
    'Le critere regardera si le nombre de lettres cons|fffd|cutives communes aux deux valeurs est postif.
    'Val = Range("e5").Value 'NomDossier
    critere = " WHERE InStr(Ch2,'" & Val & "'" & ") <> 0"  'Donc on a au moins quelques lettres communes
'INITIALISATION DE LA BASE DE DONNEES
    Set base = DBEngine.OpenDatabase(BDD)
    Set enr = base.OpenRecordset("SELECT * FROM Clients" & critere, dbOpenDynaset)
'SI RIEN TROUVE SORTIR ET REMETTRE UNE VALEUR ANCIENNE
     'If enr.Fields("Id").Value = "<Aucun enregistrement en cours.>" Then Exit Sub
'BOUCLE POUR TRAITEMENT ITERATIF DES ENREGISTREMENTS
        On Error Resume Next  'Pour ne pas sortir a la premi|fffd|re case vide
        Worksheets("CLT").Cells(4, 5).Value = enr.Fields("Id").Value
        On Error Resume Next  'Pour ne pas sortir a la premi|fffd|re case vide
        'Worksheets("CLT").Cells(11, 3).Value = Replace(enr.Fields("Ch8").Value, "#", "")
        For i = 2 To DerChamp  'ENR.EOF = True
            C = i
            Champ = "Ch" & i
            Worksheets("CLT").Cells(C + 3, 5).Value = Replace(enr.Fields(Champ).Value, "#", "")
        Next i
'TERMINER LES CONNEXIONS avec La m|fffd|thode Close des objets de base de donn|fffd|es.
    enr.Close
    base.Close
'REAFFECTATION DES VARIABLES A NOTHING pour les purger de la m|fffd|moire et lib|fffd|rer les ressources.
    Set enr = Nothing    'pour economiser de la ressource
    Set base = Nothing
'R|fffd|active les |fffd|v|fffd|nementsActive
    Worksheets("CLT").Range("e2").Value = ""
    Application.EnableEvents = True '
End Sub 'ImportBDDversCLT

Sub AppelerFicheClients()
    Chemin = "\\192.168.92.205\uranus\Clients\Clients en cours"
    FichSource = ThisWorkbook.Name
    FichDestination = "FicheClient.xlsm"
    ChemDestin = Chemin & "\" & FichDestination
    Workbooks.Open Filename:=ChemDestin
    Windows(FichSource).Activate
    Sheets("CLT").Select
    Range("e5").Select
    Selection.Copy
    Dossier = Range("e5").Value
    Windows(FichDestination).Activate
    Sheets("F").ListDossiers = Dossier
    'Sheets("F").Select
    'ActiveSheet.Paste Range("c10")
    'ActiveSheet.Paste ListDossiers
End Sub
Sub CorrigerBDDFicheClients()
    Chemin = "\\192.168.92.205\uranus\Clients\Clients en cours"
    FichSource = ThisWorkbook.Name
    FichDestination = "FicheClient.xlsm"
    ChemDestin = Chemin & "\" & FichDestination
Workbooks.Open Filename:=ChemDestin
    Windows(FichSource).Activate
    Sheets("CLT").Select
    Range("e4:e120").Select
    'Range("e5").Select
    Selection.Copy
    'dossier = Range("e5").Value
    Dossier = Range("e4:e120")
Windows(FichDestination).Activate
    'Sheets("F").ListDossiers = dossier
    'Range("e4:e120").Select
    Sheets("F").Select
    'ActiveSheet.Paste c
    Sheets("F").Range("c4:c120") = Dossier
    'Call FicheClient.xlsm!ValidationF
    'Application.Run ("Macro tps de cycle.xls!test")
    Application.Run "FicheClient.xlsm!ValidationF"
    'Sheets("F").Select
    'ActiveSheet.Paste Range("c10")
    'ActiveSheet.Paste ListDossiers
End Sub

Sub PrepareCallImportDepuisFRS()
Application.EnableEvents = False 'pour |fffd|viter que les deux macros a effet automatique s'enclenchent l'une dans l'autre, ce qui bogue
    ThisWorkbook.Worksheets("FRS").Range("e1").Copy   'OK
    ThisWorkbook.Worksheets("CLT").Activate
    Range("e2").Select
    ActiveCell.PasteSpecial Paste:=xlPasteValues  '  OK
    Application.EnableEvents = True '
    ThisWorkbook.Worksheets("CLT").Activate
    'PUIS RECOLLER POUR LANCER LA MAJ MAIS CETTE FOIS EN AUTORISANT LES EVENEMENTS
    ThisWorkbook.Worksheets("CLT").Range("e2").Copy   'OK
    ThisWorkbook.Worksheets("CLT").Activate
    Range("E2").Select
    ActiveCell.PasteSpecial Paste:=xlPasteValues
End Sub

Sub test4()
    Chemin = "\\192.168.92.205\uranus\Clients\Clients en cours"
    FichSource = ThisWorkbook.Name
    FichDestination = "FicheClient.xlsm"
    ChemDestin = Chemin & "\" & FichDestination
Workbooks.Open Filename:=ChemDestin
    Windows(FichSource).Activate
    Sheets("CLT").Select
    Range("e5").Select
    Selection.Copy
Windows(FichDestination).Activate
    Sheets("F").Select
    ActiveSheet.Paste Range("c10")
End Sub


Attribute VB_Name = "ThisWorkbook"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
'MACRO AUTO EXECUTION A L'OUVERTURE
Public Sub Workbook_Open()   'Public pour qu'il soit reconnu dans tous les modules  = d|fffd|j|fffd| par d|fffd|faut
'DECLARATION DES VARIABLES COMMUNES A TOUTES LES MACROS 'pas toutes autoris|fffd|es ici
    'Voir Module 1 D|fffd|clarations   car tout ne passe pas ici surtout
    'Public Const DerChamp = 109 'Dernier champ pour la FICHE F
    'les constantes definies par l'utilisateur ne sont pas autoris|fffd|e comme membre public de module objet
'INITIALISATION DE LA DECLARATION BDD, d|fffd|s l'ouverture du fichier Excel pour |fffd|viter de la refaire |fffd| chaque macro
    'Chemin relatif
     '   Chemin = ActiveWorkbook.Path
    'Chemin absolu
        'DirSoc = "\\192.168.92.205\uranus"
        CheminCLT = "\\192.168.92.205\uranus\Clients\Clients en cours"
        CheminFact = "\\192.168.92.205\uranus\Factures\Fact en Cours"
        BDD = CheminCLT & "\BaseAccess.accdb"
'REINITIALISATION ET OUVERTURE DE LA FEUILLE F
    'reinitialiserListDossiers 'Pr|fffd|pare la liste pour Combo ListDossiers dans module3 'Validation'
'SELECTIONNER L'INDEX 0 de "Listedossier"
   ' Sheets("CLT").ListDossiers.ListIndex = 0 'Ainsi on aura par d|fffd|faut "S|fffd|lectionnez un Dossier"
'REINITIALISER LES CELLULES DE CRITERE DANS LA ZONE DE CRITERES
 '   Range("C3").Value = ""      'Cellule de crit|fffd|re "DOSSIER" r|fffd|initialis|fffd|e
 '   NettoyerF     'Proc|fffd|dure du module1 pour nettoyer la zone d extraction
'VERIFICATION D'UTILISATION LEGITIME
    'COMPARER AVEC BASE DECLAREE
    BDDfixe = "\\192.168.92.205\uranus\Clients\...." & "\BaseAccess.accdb"
        If Left(BDD, 20) = Left(BDDfixe, 20) Then 'OK ne rien faire
        Else
            EnvoieMailSignalement 'EnvoieMailSignalement
            MsgBox ("MAUVAISE UTILISATION DU FICHIER")
            'MsgBox ("ATTENTION : LE FICHIER CLIENT EST UTILISE DANS UN CONTEXTE INTERDIT")
            Exit Sub
        End If
End Sub

Sub EnvoieMailSignalement()
    Dim Objet_du_mail As String  'type de travaux ou service
    Dim MonOutlook As Object
    Dim MonMessage As Object
    Dim Corps As String
    Dim Adr_Mail As String
'OUVRIR OUTLOOK ET ENVOYER PIECES JOINTES OK
    Adr_Mail = "pugingabriel@gmail.com"
    Objet_du_mail = "Mauvaise Utilisation fichier"
    Set MonOutlook = CreateObject("Outlook.Application")
    Set MonMessage = MonOutlook.createitem(0)
    MonMessage.To = Adr_Mail
    MonMessage.Subject = Objet_du_mail     'variable d|fffd|j|fffd| d|fffd|finie plus haut pour L'impression pdf
            MonMessage.body = "Bonjour, " & vbCrLf & vbCrLf & _
            "Nous avons d|fffd|tect|fffd| une mauvaise utilisation de ce fichier " & "  " & vbCrLf _
            & vbCrLf & Chemin & vbCrLf _
            & "." & vbCrLf _
            & vbCrLf & vbCrLf & "" & vbCrLf & _
            "Salutations." & vbCrLf & vbCrLf & _
            " " & vbCrLf & vbCrLf
    MonMessage.body = MonMessage.body & vbCrLf & "URANUS.."
    'MonMessage.Display
    MonMessage.Send
    Set MonOutlook = Nothing
End Sub  '_FIN EnvoieMailSignalement()____

Attribute VB_Name = "UserForm1_Produit"
Attribute VB_Base = "0{DABC9BDE-D5D7-4FA6-87AC-49150F5F46CA}{C17E2A3F-41B4-4662-B365-5CFF6DC51031}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
    
 Private Sub UserForm_Initialize()
    ComboBox1.AddItem "BACKUP"
    ComboBox1.AddItem "CABLA"
    ComboBox1.AddItem "COPIES"
    ComboBox1.AddItem "ENTRET"
    ComboBox1.AddItem "INSTA"
    ComboBox1.AddItem "Loc"
    ComboBox1.AddItem "Loc.COPIE"
    ComboBox1.AddItem "MUSIQUE"
    ComboBox1.AddItem "Rem"
    ComboBox1.AddItem "SOUS TR"
    ComboBox1.AddItem "SDSL"
    ComboBox1.AddItem "STUDIO"
    ComboBox1.AddItem "VOIX"
End Sub

' InQuest injected base64 decoded content
' )bz{@

INQUEST-PP=macro
