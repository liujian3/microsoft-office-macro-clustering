Attribute VB_Name = "Breakdown"
Sub create_breakdown()

    Dim j As Integer
    Dim i As Integer
    Dim k As Integer
    Dim l As Integer
    
    Dim oCn As ADODB.Connection
    Dim oRS As ADODB.Recordset
    Dim ConnString As String
    Dim SQL As String
    Dim intloop
    Dim intloop2
    Dim strcount
    Dim strrow
    Dim strcol
    Dim region_code
    Dim orig_reg
    Dim dest_reg
    Dim strrepdim
    Dim strrepfilter
   Dim strr
   Dim strc
   
   Dim strcrit
   Dim strmainval
   
   Dim str_product_filter
   Dim str_date
   
   Dim str_orig_field
   Dim str_dest_field
   
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    
  
  With Application
    .DecimalSeparator = "."
    .ThousandsSeparator = ","
End With

  
   Sheets("Trend_data").Range("B1:CI10") = ""
    
    
  strr = "R"
  strc = "C"
  
    'define product field
  
   
   'define filter
  
   If Sheets("Setup").Range("I8").Value = "" Then
  strcrit = 0.955
  Else
  strcrit = Sheets("Setup").Range("I8").Value
  End If
   
   
   
    'define measure field
    
    
   str_product_filter = ""
   str_date = ""
   str_orig_field = ""
   str_dest_field = ""
   'str_direction = ""
   str_filter = ""
   strdimension = ""
   strproduct = ""
    strrepdim = ""
    strrepfilter = ""
   
   strproduct = "[" & Application.WorksheetFunction.VLookup(Sheets("TrendAnalysis").Range("R7").Value, Sheets("LOV").Range("Y:Z"), 2, 0) & "]"
   
   If Sheets("TrendAnalysis").Range("B7").Value = "Origin Region" Then
   str_orig_field = "[Origin Region Name]"
   Else
   str_orig_field = "[Origin Country/Territory Name]"
   End If
   If Sheets("TrendAnalysis").Range("K7").Value = "Destination Region" Then
   str_dest_field = "[Destination Region Name]"
   Else
   str_dest_field = "[Destination Country/Territory Name]"
   End If
   
'   If Sheets("TrendAnalysis").Range("Z7") = "DHL Controllable" And Application.WorksheetFunction.Match("Delay Code", Sheets("LOV").Range("AC:AC")) > 1 Then
'    strrepdim = ",[DHL Controllable Delay Flag]"
'    strrepfilter = " AND [DHL Controllable Delay Flag] > 0 "
'   End If
'   If Sheets("TrendAnalysis").Range("Z7") = "DHL Uncontrollable" And Application.WorksheetFunction.Match("Delay Codee", Sheets("LOV").Range("AC:AC")) > 1 Then
'    strrepdim = ",[DHL Uncontrollable Delay Flag]"
'    strrepfilter = " AND [DHL Uncontrollable Delay Flag] > 0 "
'   End If
'   If Sheets("TrendAnalysis").Range("Z7") = "Customer Controllable" And Application.WorksheetFunction.Match("Delay Code", Sheets("LOV").Range("AC:AC")) > 1 Then
'    strrepdim = ",[DHL Controllable Delay Flag]"
'    strrepfilter = " AND [Customer Controllable Delay Flag] > 0 "
'   End If
   
   If Sheets("TrendAnalysis").Range("T7").Value <> "ALL" Then
   str_product_filter = strproduct & " = '" & Sheets("TrendAnalysis").Range("T7").Value & "' "
   Else
   str_product_filter = strproduct & " <> '' "
   End If
   
    
   
   
   If Sheets("TrendAnalysis").Range("F7").Value <> "ALL" And Sheets("TrendAnalysis").Range("O7").Value <> "ALL" Then
   str_direction = "(" & str_orig_field & " = '" & Sheets("TrendAnalysis").Range("F7").Value & "' " & Sheets("TrendAnalysis").Range("I7").Value & " " & str_dest_field & " = '" & Sheets("TrendAnalysis").Range("O7").Value & "') "
   
   Else
   If Sheets("TrendAnalysis").Range("F7").Value <> "ALL" And Sheets("TrendAnalysis").Range("O7").Value = "ALL" Then
   str_direction = str_orig_field & " = '" & Sheets("TrendAnalysis").Range("F7").Value & "' "
   Else
   If Sheets("TrendAnalysis").Range("F7").Value = "ALL" And Sheets("TrendAnalysis").Range("O7").Value <> "ALL" Then
    str_direction = str_dest_field & " = '" & Sheets("TrendAnalysis").Range("O7").Value & "' "
   Else
   str_direction = str_orig_field & " <> '' AND " & str_dest_field & " <> '' "
   End If
   End If
   End If
   
   
   
    'define measure field
    
    

   
   If Sheets("TrendAnalysis").Range("V7").Value = "Weekly" Then
   str_date = " [Startclock Week] "
   Else
   If Sheets("TrendAnalysis").Range("V7").Value = "Daily" Then
   str_date = " [Startclock Date] "
   Else
   str_date = " Left([Startclock Month],2) "
   End If
   End If
   
    
  
   strmainval = Application.WorksheetFunction.VLookup(Sheets("TrendAnalysis").Range("Z7").Value, Sheets("LOV").Range("F:H"), 3, 0)
      
  
    'define current period
    
  
       
        
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
     
       
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    SQL = ""
    SQL = SQL & " SELECT [Startclock Year], " & str_date & ", sum([Customer Controllable Delay Flag]),sum([DHL Controllable Delay Flag]), Sum([DHL Uncontrollable Delay Flag]), sum([On Time Volume]) as raw_ot, sum([On Time Volume]+[DHL Uncontrollable Delay Flag]+[Customer Controllable Delay Flag]) as net_ot , sum([Net Monitored Volume]),Sum([Count of Shipments]), " & strmainval & strrepdim
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_product_filter & strrepfilter & " AND " & str_direction & " GROUP BY [Startclock Year], " & str_date & strrepdim & " ORDER BY [Startclock Year] ASC, " & str_date & "  ASC "
   


    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 1
    j = 2
    
   ' On Error Resume Next
    oRS.Open
    intloop = 0
    
    If Sheets("TrendAnalysis").Range("Z7").Value = "Shipments" Then
    Sheets("Trend_data").Cells(i + 2, 1) = "On Time"
    Else
      
    Sheets("Trend_data").Cells(i + 2, 1) = Sheets("TrendAnalysis").Range("Z7").Value
    End If
    
    Do Until oRS.EOF
        
        
        
        If Application.WorksheetFunction.Max(Sheets("Trend_data").Range("B1:BG1")) <> oRS(0).Value Then
        Sheets("Trend_data").Cells(i, j) = oRS(0).Value
        End If
        Sheets("Trend_data").Cells(i + 1, j) = "'" & oRS(1).Value
        If Sheets("TrendAnalysis").Range("Z7").Value = "Shipments" Then
        Sheets("Trend_data").Rows("4:7").EntireRow.Hidden = False
        Sheets("Trend_data").Cells(i + 2, j) = oRS(5).Value
        Sheets("Trend_data").Cells(i + 3, j) = oRS(4).Value
        Sheets("Trend_data").Cells(i + 4, j) = oRS(2).Value
       ' Sheets("Trend_data").Cells(i + 5, j) = oRS(9).Value - oRS(7).Value
        Sheets("Trend_data").Cells(i + 5, j) = oRS(3).Value
        Else
        
        Sheets("Trend_data").Cells(i + 2, j) = oRS(9).Value
        Sheets("Trend_data").Rows("4:6").EntireRow.Hidden = True
        End If
        
        If oRS(7).Value <> 0 Then
        Sheets("Trend_data").Cells(i + 6, j) = "=" & oRS(6).Value & "/" & oRS(7).Value
        Sheets("Trend_data").Cells(i + 7, j) = "=" & oRS(5).Value & "/" & oRS(7).Value
        End If
        Sheets("Trend_data").Cells(i + 8, j) = strcrit
        
        
      j = j + 1
      
    oRS.MoveNext
    Loop
    oCn.Close
   
         
   Set oRS = Nothing
   Set oCn = Nothing
   
   
   
   
   If Sheets("Setup").Range("I9").Value <> "Y" Then
   Sheets("Trend_data").Rows("8:8").EntireRow.Hidden = True
   Else
   Sheets("Trend_data").Rows("8:8").EntireRow.Hidden = False
   End If
   
   intloop = 0
   
   For i = 1 To 58
   If Sheets("Trend_data").Cells(2, 2 + i) = "" Then
   Sheets("Trend_data").Columns(2 + i).EntireColumn.Hidden = True
   
   Else
   Sheets("Trend_data").Columns(2 + i).EntireColumn.Hidden = False
   intloop = intloop + 1
   End If
   
   Next
   
   
   
    Sheets("TrendAnalysis").Range("B2:BI2").NumberFormat = "0"
    If Sheets("TrendAnalysis").Range("V7").Value <> "Monthly" Then
    If intloop > 16 Then
    Sheets("TrendAnalysis").Range("B2:BI2").NumberFormat = "0"
    Sheets("TrendAnalysis").ChartObjects("B_Down_Chart").Activate
    With ActiveChart
         .Axes(xlValue, xlSecondary).MinimumScale = Application.WorksheetFunction.Min(Sheets("Trend_data").Range("B8:BG10")) - 0.1
         .Axes(xlValue, xlSecondary).MaximumScale = 1
         .Axes(xlValue, xlSecondary).TickLabels.NumberFormat = "0.0%"
        .SetElement (msoElementDataTableNone)
        .SetElement (msoElementLegendBottom)
      '   .SetElement (msoElementDataTableWithLegendKeys)
    End With
    
    Else
    Sheets("TrendAnalysis").ChartObjects("B_Down_Chart").Activate
     With ActiveChart
         .Axes(xlValue, xlSecondary).MinimumScale = Application.WorksheetFunction.Min(Sheets("Trend_data").Range("B8:BG10")) - 0.1
         .Axes(xlValue, xlSecondary).MaximumScale = 1
         .Axes(xlValue, xlSecondary).TickLabels.NumberFormat = "0.0%"
      '  .SetElement (msoElementDataTableNone)
         .SetElement (msoElementLegendNone)
         .SetElement (msoElementDataTableWithLegendKeys)
         .DataTable.HasBorderOutline = False
    End With
    End If
    Else
    Sheets("TrendAnalysis").ChartObjects("B_Down_Chart").Activate
    With ActiveChart
         .Axes(xlValue, xlSecondary).MinimumScale = Application.WorksheetFunction.Min(Sheets("Trend_data").Range("B8:BG10")) - 0.1
         .Axes(xlValue, xlSecondary).MaximumScale = 1
         .Axes(xlValue, xlSecondary).TickLabels.NumberFormat = "0.0%"
      '  .SetElement (msoElementDataTableNone)
         .SetElement (msoElementLegendNone)
         .SetElement (msoElementDataTableWithLegendKeys)
         .DataTable.HasBorderOutline = False
    End With
  
    
     
    For i = 1 To 13
     If Sheets("Trend_data").Cells(2, i + 1).Value = 1 Then Sheets("Trend_data").Cells(2, i + 1) = "Jan"
     If Sheets("Trend_data").Cells(2, i + 1).Value = 2 Then Sheets("Trend_data").Cells(2, i + 1) = "Feb"
     If Sheets("Trend_data").Cells(2, i + 1).Value = 3 Then Sheets("Trend_data").Cells(2, i + 1) = "Mar"
     If Sheets("Trend_data").Cells(2, i + 1).Value = 4 Then Sheets("Trend_data").Cells(2, i + 1) = "Apr"
     If Sheets("Trend_data").Cells(2, i + 1).Value = 5 Then Sheets("Trend_data").Cells(2, i + 1) = "May"
     If Sheets("Trend_data").Cells(2, i + 1).Value = 6 Then Sheets("Trend_data").Cells(2, i + 1) = "Jun"
     If Sheets("Trend_data").Cells(2, i + 1).Value = 7 Then Sheets("Trend_data").Cells(2, i + 1) = "Jul"
     If Sheets("Trend_data").Cells(2, i + 1).Value = 8 Then Sheets("Trend_data").Cells(2, i + 1) = "Aug"
     If Sheets("Trend_data").Cells(2, i + 1).Value = 9 Then Sheets("Trend_data").Cells(2, i + 1) = "Sep"
     If Sheets("Trend_data").Cells(2, i + 1).Value = 10 Then Sheets("Trend_data").Cells(2, i + 1) = "Oct"
     If Sheets("Trend_data").Cells(2, i + 1).Value = 11 Then Sheets("Trend_data").Cells(2, i + 1) = "Nov"
     If Sheets("Trend_data").Cells(2, i + 1).Value = 12 Then Sheets("Trend_data").Cells(2, i + 1) = "Dec"
    Next
    
    End If
  
 
Application.UseSystemSeparators = True
Application.Calculation = xlCalculationAutomatic
Sheets("TrendAnalysis").ChartObjects("B_Down_Chart").Activate
ActiveChart.SetSourceData Source:=Sheets("Trend_data").Range("$A$1:$BG$9")


Application.ScreenUpdating = True
    
    
End Sub
Attribute VB_Name = "Create_Map"
Sub BuildMaps()
Application.Calculation = xlCalculationAutomatic
Prepare_Map_Data
Application.Calculation = xlCalculationAutomatic
BuildMap_OB
Application.Calculation = xlCalculationAutomatic

End Sub

Function Rangename(r As Range) As String
    Rangename = "[" & r.Parent.Name & "$" & _
                r.address(False, False) & "]"
End Function

Sub Prepare_Map_Data()

    Dim j As Integer
    Dim i As Integer
    Dim k As Integer
    Dim l As Integer
    Dim ii As Integer
    
    Dim oCn As ADODB.Connection
    Dim oRS As ADODB.Recordset
    Dim ConnString As String
    Dim SQL As String
    Dim intloop
    Dim intloop2
    Dim strcount
    Dim strrow
    Dim strcol

    Dim str_direction
    Dim str_product_filter
    Dim str_date

    Dim strmeasure
    Dim strmeasurecnt
   
    Dim strmainval
    Dim str_view
    Dim strcp1
    Dim strpp1
    
    Dim Revcol As Integer
    Dim rFind As Range
    Dim revflag As Integer
    Dim RevSQL As String
    Dim OrderSQL As String
    Dim selvar As String
    
    ReDim str_nm(7)
    ReDim str_val(7, 3)
   
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    
    With Application
    .DecimalSeparator = "."
    .ThousandsSeparator = ","
    End With

    selvar = "Billing Net Invoiced Amount"
    
    'Flag for no Billing Net Invoiced Amount
    With Sheets("Setup").Range("E9:E26")
    Set rFind = .Find(What:=selvar, LookAt:=xlWhole, MatchCase:=False, SearchFormat:=False)
    If rFind Is Nothing Then
    revflag = 1
        'Delete column if billing amount column is found in map set-up
        With Sheets("Map_Setup").Range("N1:AM1")
        Set rFind = .Find(What:=selvar, LookAt:=xlWhole, MatchCase:=False, SearchFormat:=False)
        If Not rFind Is Nothing Then
        Revcol = rFind.Column
        Sheets("Map_Setup").Columns(Revcol).EntireColumn.Delete
        End If
        End With
    Else
    revflag = 0
    End If
    End With

     
   Sheets("Map_Setup").Range("N2:AM1000") = ""
   Sheets("Map_Setup").Range("A12:D19") = ""
   Sheets("Map_Setup").Activate
    
   str_product_filter = ""
   str_date = ""
   str_direction = ""
   
   
   strproduct = "[" & Application.WorksheetFunction.VLookup(Sheets("WorldMap").Range("E7").Value, Sheets("LOV").Range("Y:Z"), 2, 0) & "]"
   
   
   If Sheets("WorldMap").Range("G7").Value <> "ALL" Then
   str_product_filter = " AND " & strproduct & " = '" & Sheets("WorldMap").Range("G7").Value & "' "
   Else
   str_product_filter = " AND " & strproduct & " <> '' "
   End If
  
   
   If Sheets("WorldMap").Range("I7").Value = "Week" Then
   str_date = " AND [Startclock Year] = " & Left(Sheets("WorldMap").Range("L7").Value, 4) & " AND [Startclock Week] = " & Trim(Right(Sheets("WorldMap").Range("L7").Value, 2)) & " "
   Else
   If Sheets("WorldMap").Range("I7").Value = "Year" Then
   str_date = " AND [Startclock Year] = " & Sheets("WorldMap").Range("L7").Value & " "
   Else
   If Sheets("WorldMap").Range("I7").Value = "Month" Then
   str_date = " AND [Startclock Year] = " & Left(Application.WorksheetFunction.VLookup(Sheets("WorldMap").Range("L7").Value, Sheets("LOV").Range("M:O"), 2, 0), 4) & " "
   str_date = str_date & " AND [Startclock Month] = '" & Application.WorksheetFunction.VLookup(Sheets("WorldMap").Range("L7").Value, Sheets("LOV").Range("M:O"), 3, 0) & "' "
   Else
   If Sheets("WorldMap").Range("I7").Value = "Last 3 Months" Then
   str_date = " AND (([Startclock Year] = " & Left(Sheets("LOV").Cells(2, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(2, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(3, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(3, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(4, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(4, 15).Value & "'))  "
   Else
   If Sheets("WorldMap").Range("I7").Value = "Last 6 Months" Then
   str_date = " AND (([Startclock Year] = " & Left(Sheets("LOV").Cells(2, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(2, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(3, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(3, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(4, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(4, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(5, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(5, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(6, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(6, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(7, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(7, 15).Value & "'))  "
   End If
   End If
   End If
   End If
   End If
   
   If Sheets("WorldMap").Range("C7").Value = "Outbound" Then
   str_direction = "[CTRYData] = [Origin Country/Territory Code]"
   str_view = "[Origin Region Name],[Origin Region Name]"
   Else
   If Sheets("WorldMap").Range("C7").Value = "Inbound" Then
   str_direction = "[CTRYData] = [Destination Country/Territory Code]"
   str_view = "[Destination Region Name],[Destination Region Name]"
   Else
   str_direction = "([CTRYData] = [Origin Country/Territory Code] OR [CTRYData] = [Destination Country/Territory Code])"
   str_view = "[Origin Region Name],[Destination Region Name]"
   End If
   End If
   
   'Define SQL if Rev remove is selected.
   If revflag = 1 Then
        RevSQL = ""
        OrderSQL = "Sum([Net Monitored Volume])"
        Else
        RevSQL = ", Sum(Iif([Billing Net Invoiced Amount] is null,0,[Billing Net Invoiced Amount]))"
        OrderSQL = "Sum([Billing Net Invoiced Amount])"
    End If

   
   
  strr = "R"
  strc = "C"
  
   'dynamic measures
  
  
  strmeasurecnt = Application.WorksheetFunction.CountA(Sheets("LOV").Range("F:F")) - 1

  ReDim str_measure(1, strmeasurecnt)
  
  'Define dropdown list
  For i = 2 To strmeasurecnt + 1
  str_measure(1, i - 1) = Sheets("LOV").Cells(i, 6).Value
  str_measure(0, i - 1) = Sheets("LOV").Cells(i, 10).Value
  Sheets("Map_Setup").Cells(1, 20 + i) = Sheets("LOV").Cells(i, 6).Value
  If i = 2 Then
  strmeasure = Sheets("LOV").Cells(i, 8).Value
  Else
  strmeasure = strmeasure & "," & Sheets("LOV").Cells(i, 8).Value
  End If
  Next
      
  
          
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
   
       
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    SQL = ""
    SQL = SQL & " SELECT [CTRYData],Sum([Net Monitored Volume]),Sum([DHL Controllable Delay Flag]), " & strmeasure
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "],  " & Rangename(Sheets("Map_Setup").Range("I1:I229"))
    SQL = SQL & " WHERE " & str_direction & " " & str_product_filter & " " & str_date & " GROUP BY [CTRYData]"
   


    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 2
    j = 19
    
   On Error Resume Next
    oRS.Open
    intloop = 0
    
   
   
    
    For i = 2 To 229
    oRS.Filter = "[CTRYData] = '" & Sheets("Map_Setup").Cells(i, 9).Value & "'   "
    
    If oRS.EOF = False Then
    For ii = 1 To strmeasurecnt + 2
    Sheets("Map_Setup").Cells(i, j + ii) = oRS(ii).Value
    Next
    Else
    For ii = 1 To measurecnt
    Sheets("Map_Setup").Cells(i, j + ii) = 0
    Next
    
    End If
        
      
     Next

    oCn.Close
   
   
   
   
   
   
   Set oRS = Nothing
   Set oCn = Nothing

'regional splits


ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

'UPDATE SQL STRING
    SQL = ""
    SQL = SQL & " SELECT " & str_view & RevSQL & ", Sum([Net Monitored Volume]), Sum([Billed Weight])"
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE 1=1 " & str_product_filter & " " & str_date & " GROUP BY " & str_view & " ORDER BY " & OrderSQL & " DESC "

   


    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 2
    j = 20
    
 '   On Error Resume Next
    oRS.Open
    intloop = 0
    
    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 1
    j = 2
    
   ' On Error Resume Next
    oRS.Open
    
    
    For i = 0 To 7
    str_nm(i) = ""
    str_val(i, 1) = 0
    str_val(i, 2) = 0
    str_val(i, 3) = 0
    
    Next
    intloop = 0
    Do Until oRS.EOF
        
        
    intloop = intloop + 1
    If intloop < 7 Then
        
    
    If Sheets("WorldMap").Range("C7").Value = "Outbound" Or Sheets("WorldMap").Range("C7").Value = "Inbound" Then
    str_nm(intloop) = oRS(0).Value
    Else
    str_nm(intloop) = oRS(0).Value & "-" & oRS(1).Value
        
    End If
     
   
    str_val(intloop, 1) = oRS(2).Value
    str_val(intloop, 2) = oRS(3).Value
    str_val(intloop, 3) = oRS(4).Value
   
   End If
   
    If oRS.EOF Then Exit Sub
   If intloop > 6 Then
   
   str_nm(7) = "Other"
   str_val(7, 1) = str_val(7, 1) + oRS(2).Value
   str_val(7, 2) = str_val(7, 2) + oRS(3).Value
   str_val(7, 3) = str_val(7, 3) + oRS(4).Value
      
   End If
   
   str_nm(0) = "Total"
    str_val(0, 1) = str_val(0, 1) + oRS(2).Value
    str_val(0, 2) = str_val(0, 2) + oRS(3).Value
    str_val(0, 3) = str_val(0, 3) + oRS(4).Value
    
    oRS.MoveNext
    Loop
    oCn.Close
   
         
   Set oRS = Nothing
   Set oCn = Nothing
   
    
'Paste value for charts
    For i = 1 To 7
   'Region Split
   Sheets("Map_Setup").Cells(11 + i, 1) = str_nm(i)
   'Spend
    If revflag = 1 Then
        Sheets("Map_Setup").Cells(11 + i, 2) = ""
        Else
        Sheets("Map_Setup").Cells(11 + i, 2) = str_val(i, 1)
        End If
   'Shipment
   If revflag = 1 Then
        Sheets("Map_Setup").Cells(11 + i, 3) = str_val(i, 1)
        Else
        Sheets("Map_Setup").Cells(11 + i, 3) = str_val(i, 2)
        End If
   'Weight
   If revflag = 1 Then
        Sheets("Map_Setup").Cells(11 + i, 4) = str_val(i, 2)
        Else
        Sheets("Map_Setup").Cells(11 + i, 4) = str_val(i, 3)
        End If
   Next

   
    On Error Resume Next
      
   Application.UseSystemSeparators = True
      
    Sheets("WorldMap").ChartObjects("Shipments").Activate
     k = Application.WorksheetFunction.CountA(Sheets("Map_Setup").Range("A12:A18"))
     ActiveChart.SetSourceData Source:=Sheets("Map_Setup").Range("A11:A" & 11 + k & ",C11:C" & 11 + k)
    
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 108
    ActiveChart.Legend.Height = 143
    ActiveChart.PlotBy = xlColumns
    
    For i = 1 To 7
    
    If Sheets("Map_Setup").Range("C" & 11 + i).Value / Application.WorksheetFunction.Sum(Sheets("Map_Setup").Range("C12:C18")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("WorldMap").ChartObjects("Weight").Activate
    ActiveChart.SetSourceData Source:=Sheets("Map_Setup").Range("A11:A" & 11 + k & ",D11:D" & 11 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 108
    ActiveChart.Legend.Height = 143
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Map_Setup").Range("D" & 11 + i).Value / Application.WorksheetFunction.Sum(Sheets("Map_Setup").Range("D12:D18")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("WorldMap").ChartObjects("Spend").Activate
    ActiveChart.SetSourceData Source:=Sheets("Map_Setup").Range("A11:A" & 11 + k & ",B11:B" & 11 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 108
    ActiveChart.Legend.Height = 143
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Map_Setup").Range("B" & 11 + i).Value / Application.WorksheetFunction.Sum(Sheets("Map_Setup").Range("B12:B18")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next


    'Hide spend chart if rev flag is 1
    Sheets("WorldMap").Activate
    If revflag = 1 Then
    Sheets("WorldMap").ChartObjects("Spend").Visible = False
    ActiveSheet.Shapes.Range(Array("TextBox 462")).Visible = False
        Else
    End If


Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic
    
 
    
Application.UseSystemSeparators = True
     
    



End Sub



Sub BuildMap_OB()
'macro for building map

Application.Calculation = xlCalculationManual
Application.ScreenUpdating = False



Dim RowCount As Long
Dim i, j As Integer
' Fill in colors by indexes from spreadsheet
Dim Colors As Variant
Colors = Array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15)
i = 2
Do
    Colors(Worksheets("Map_Setup").Range("B" & (i)).Value) = Array(Worksheets("Map_Setup").Range("C" & (i)).Value, Worksheets("Map_Setup").Range("D" & (i)).Value, Worksheets("Map_Setup").Range("E" & (i)).Value)
    i = i + 1
Loop While Worksheets("Map_Setup").Range("A" & (i)) <> ""


' get country colors
Dim Countries As Variant
Dim Country As String
Dim ColorIndex As Integer

Dim strcomments
Dim strval(5)

Dim ttl
Dim cc
Dim dc
Dim du
Dim odd

i = 2
j = 0


Worksheets("WorldMap").Activate
Sheets("WorldMap").Range("A1").Select
On Error Resume Next
Do
    Country = Worksheets("Map_Setup").Range("I" & (i)).Value
    ColorIndex = Worksheets("Map_Setup").Range("L" & (i)).Value
     
 ttl = Worksheets("Map_Setup").Range("T" & (i)).Value
 cc = Application.WorksheetFunction.HLookup("Customer Controllable", Worksheets("Map_Setup").Range("I:AM"), (i), 0)
 dc = Application.WorksheetFunction.HLookup("DHL Controllable", Worksheets("Map_Setup").Range("I:AM"), (i), 0)
 du = Application.WorksheetFunction.HLookup("DHL Uncontrollable", Worksheets("Map_Setup").Range("I:AM"), (i), 0)
 odd = Application.WorksheetFunction.HLookup("On Demand Deliveries", Worksheets("Map_Setup").Range("I:AM"), (i), 0)
     
     
    strcomments = Worksheets("Map_Setup").Range("J" & (i)).Value & vbCrLf _
        & Sheets("WorldMap").Range("C7").Value & ": " & FormatNumber(ttl, 0, vbFalse, vbUseDefault, vbUseDefault) & " (" & FormatPercent(1 - (dc / ttl), 1) & ")" & vbCrLf _
        & "DHL Uncontrollable: " & FormatNumber(du, 0, vbFalse, vbUseDefault, vbUseDefault) & " (" & FormatPercent(du / ttl, 1) & ")" & vbCrLf _
        & "Customer Controllable: " & FormatNumber(cc, 0, vbFalse, vbUseDefault, vbUseDefault) & " (" & FormatPercent(cc / ttl, 1) & ")" & vbCrLf _
        & "DHL Controllable: " & FormatNumber(dc, 0, vbFalse, vbUseDefault, vbUseDefault) & " (" & FormatPercent(dc / ttl, 1) & ")" & vbCrLf _
        & "OnDemand Deliveries: " & FormatNumber(odd, 0, vbFalse, vbUseDefault, vbUseDefault) & " (" & FormatPercent(odd / ttl, 1) & ")" & vbCrLf
        
    On Error Resume Next
    Worksheets("WorldMap").Shapes(Country).Select
    
    Selection.ShapeRange.Fill.ForeColor.RGB = RGB(Colors(ColorIndex)(0), Colors(ColorIndex)(1), Colors(ColorIndex)(2))
    ActiveSheet.Hyperlinks.Add Anchor:=Selection.ShapeRange.Item(1), address:= _
        "", SubAddress:="WorldMap!V" & 12 + i, ScreenTip:=strcomments
   
    If (Country = "MA" Or Country = "YE") Then
        Worksheets("WorldMap").Shapes(Country & "1").Select
        Selection.ShapeRange.Fill.ForeColor.RGB = RGB(Colors(ColorIndex)(0), Colors(ColorIndex)(1), Colors(ColorIndex)(2))
    End If

    Worksheets("WorldMap").Shapes("DUMMY").Select ' selecting dummy
    
    
    
    i = i + 1
Loop While Worksheets("Map_Setup").Range("I" & (i)) <> ""

Worksheets("WorldMap").Range("D2").Select


'Worksheets("Map").Activate


Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
Sheets("WorldMap").Range("A1") = 1
'Sheets("WorldMap").Select

End Sub


Sub BuildMap_IB()
'macro for building map

Application.Calculation = xlCalculationManual
Application.ScreenUpdating = False



Dim RowCount As Long
Dim i, j As Integer
' Fill in colors by indexes from spreadsheet
Dim Colors As Variant
Colors = Array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15)
i = 2
Do
    Colors(Worksheets("Map_Setup").Range("B" & (i)).Value) = Array(Worksheets("Map_Setup").Range("C" & (i)).Value, Worksheets("Map_Setup").Range("D" & (i)).Value, Worksheets("Map_Setup").Range("E" & (i)).Value)
    i = i + 1
Loop While Worksheets("Map_Setup").Range("A" & (i)) <> ""


' get country colors
Dim Countries As Variant
Dim Country As String
Dim ColorIndex As Integer

Dim strcomments
Dim strval(5)

i = 2
j = 0


Worksheets("WorldMap").Activate
Sheets("WorldMap").Range("A1").Select

Do
    Country = Worksheets("Map_Setup").Range("I" & (i)).Value
    ColorIndex = Worksheets("Map_Setup").Range("N" & (i)).Value
     
    strcomments = "Outbound: " & FormatPercent(Worksheets("Map_Setup").Range("M" & (i)).Value, 1) & vbCrLf _
        & "Inbound: " & FormatPercent(Worksheets("Map_Setup").Range("O" & (i)).Value, 1) & vbCrLf _
        & "Total: " & FormatPercent(Worksheets("Map_Setup").Range("Q" & (i)).Value, 1) & vbCrLf

       
    On Error Resume Next
    Worksheets("WorldMap").Shapes(Country).Select
    
    Selection.ShapeRange.Fill.ForeColor.RGB = RGB(Colors(ColorIndex)(0), Colors(ColorIndex)(1), Colors(ColorIndex)(2))
    ActiveSheet.Hyperlinks.Add Anchor:=Selection.ShapeRange.Item(1), address:= _
        "", SubAddress:="", ScreenTip:=strcomments
   
    If (Country = "MA" Or Country = "YE") Then
        Worksheets("WorldMap").Shapes(Country & "1").Select
        Selection.ShapeRange.Fill.ForeColor.RGB = RGB(Colors(ColorIndex)(0), Colors(ColorIndex)(1), Colors(ColorIndex)(2))
    End If

    Worksheets("WorldMap").Shapes("DUMMY").Select ' selecting dummy
    
    i = i + 1
Loop While Worksheets("Map_Setup").Range("I" & (i)) <> ""

Worksheets("WorldMap").Range("D2").Select


'Worksheets("Map").Activate


Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True

Sheets("WorldMap").Select

End Sub

Sub BuildMap_IB_OB()
'macro for building map

Application.Calculation = xlCalculationManual
Application.ScreenUpdating = False



Dim RowCount As Long
Dim i, j As Integer
' Fill in colors by indexes from spreadsheet
Dim Colors As Variant
Colors = Array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15)
i = 2
Do
    Colors(Worksheets("Map_Setup").Range("B" & (i)).Value) = Array(Worksheets("Map_Setup").Range("C" & (i)).Value, Worksheets("Map_Setup").Range("D" & (i)).Value, Worksheets("Map_Setup").Range("E" & (i)).Value)
    i = i + 1
Loop While Worksheets("Map_Setup").Range("A" & (i)) <> ""


' get country colors
Dim Countries As Variant
Dim Country As String
Dim ColorIndex As Integer

Dim strcomments
Dim strval(5)

i = 2
j = 0


Worksheets("WorldMap").Activate
Sheets("WorldMap").Range("A1").Select

Do
    Country = Worksheets("Map_Setup").Range("I" & (i)).Value
    ColorIndex = Worksheets("Map_Setup").Range("P" & (i)).Value
     
    strcomments = "Outbound: " & FormatPercent(Worksheets("Map_Setup").Range("M" & (i)).Value, 1) & vbCrLf _
        & "Inbound: " & FormatPercent(Worksheets("Map_Setup").Range("O" & (i)).Value, 1) & vbCrLf _
        & "Total: " & FormatPercent(Worksheets("Map_Setup").Range("Q" & (i)).Value, 1) & vbCrLf

       
    On Error Resume Next
    Worksheets("WorldMap").Shapes(Country).Select
    
    Selection.ShapeRange.Fill.ForeColor.RGB = RGB(Colors(ColorIndex)(0), Colors(ColorIndex)(1), Colors(ColorIndex)(2))
    ActiveSheet.Hyperlinks.Add Anchor:=Selection.ShapeRange.Item(1), address:= _
        "", SubAddress:="", ScreenTip:=strcomments
   
    If (Country = "MA" Or Country = "YE") Then
        Worksheets("WorldMap").Shapes(Country & "1").Select
        Selection.ShapeRange.Fill.ForeColor.RGB = RGB(Colors(ColorIndex)(0), Colors(ColorIndex)(1), Colors(ColorIndex)(2))
    End If

    Worksheets("WorldMap").Shapes("DUMMY").Select ' selecting dummy
    
    i = i + 1
Loop While Worksheets("Map_Setup").Range("I" & (i)) <> ""

Worksheets("WorldMap").Range("A9").Select


'Worksheets("Map").Activate


Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True

Sheets("WorldMap").Select

End Sub






Attribute VB_Name = "Dashboard"
Sub Dashboard_data()

    Dim j As Integer
    Dim i As Integer
    Dim k As Integer
    Dim l As Integer
    
    Dim oCn As ADODB.Connection
    Dim oRS As ADODB.Recordset
    Dim ConnString As String
    Dim SQL As String
    Dim intloop
    Dim intloop2
    Dim strcount
    Dim strrow
    Dim strcol
    Dim region_code
    Dim orig_reg
    Dim dest_reg
     
    Dim strr
    Dim strc
   
    Dim strcrit
    Dim strmainval
    
    Dim MeaSel
    Dim SvcValue
    Dim OrgValue
    Dim DstValue
    Dim str_product_filter
    Dim str_date
   
   Dim str_orig_field
   Dim str_dest_field
   Dim str_direction
   Dim str_filter
   
   Dim str_fields
   Dim str_group
   
   ReDim str_val(7, 3)
   ReDim str_nm(7)
 
    Dim custom_int
   
   
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    
    With Application
    .DecimalSeparator = "."
    .ThousandsSeparator = ","
    End With

    
    'Clear dashboard data
    If Sheets("Dashboard").Range("H1").Value = 1 Then
        Sheets("Dashboard_Data").Range("A4:I15") = ""
    Else
        Sheets("Dashboard_Data").Range("A4:AP15") = ""
    End If
    Sheets("Dashboard_Data").Range("B1,B2") = ""
    
    strr = "R"
    strc = "C"
  
    'define product field
  
   
   'define filter
    If Sheets("Setup").Range("I8").Value = "" Then
    strcrit = 0.955
    Else
    strcrit = Sheets("Setup").Range("I8").Value
    End If
   

    Dim rFind As Range
    Dim GhostCol As Integer
    Dim GhostRow As Integer
    Dim ghostall As Long
   
    'Find the columns for ghost in raw data
    With Sheets("Raw_Data").Rows("1:1")
    Set rFind = .Find(What:="Ghost Flag", LookAt:=xlWhole, MatchCase:=False, SearchFormat:=False)
    If Not rFind Is Nothing Then
        GhostCol = rFind.Column
        Dim ColumnLetter As String
        GhostLetter = Split(Cells(1, GhostCol).address, "$")(1)
        ghostall = Excel.WorksheetFunction.Sum(Sheets("Raw_Data").Range(GhostLetter & "2:" & GhostLetter & "200000"))
        Else
        GoTo no_ghost
    End If
    End With
   
   'if sum of all ghost flag = 0
   If ghostall = 0 And Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("A:A")) > 1 Then
        With Sheets("Setup").Range("E9:E25")
        Set rFind = .Find(What:="Ghost Shipments", LookAt:=xlWhole, MatchCase:=False, SearchFormat:=False)
        If Not rFind Is Nothing Then
            GhostRow = rFind.Row
            Sheets("Setup").Range("I" & GhostRow) = "N"
        End If
        End With
    End If
   
no_ghost:
   
    'get value of the measures selection on Cell I7
    If Sheets("Dashboard").Range("I7").Value = "Services" Then
        If Sheets("Dashboard").Range("L7").Value = "Service Name" Then
            Sheets("Dashboard").Range("G1").Value = "Service Name"
            Else
            Sheets("Dashboard").Range("G1").Value = Sheets("Dashboard").Range("L7").Value
        End If
    ElseIf Sheets("Dashboard").Range("I7").Value = "Origins" Then
        Sheets("Dashboard").Range("G2").Value = Sheets("Dashboard").Range("L7").Value
    ElseIf Sheets("Dashboard").Range("I7").Value = "Destinations" Then
        Sheets("Dashboard").Range("G3").Value = Sheets("Dashboard").Range("L7").Value
    End If
    
    'Capture selection from the hidden cells
    SvcValue = Sheets("Dashboard").Range("G1").Value
    OrgValue = Sheets("Dashboard").Range("G2").Value & " Code"
    DstValue = Sheets("Dashboard").Range("G3").Value & " Code"
   
    'define measure field
    str_product_filter = ""
    str_date = ""
    str_orig_field = ""
    str_dest_field = ""
    str_direction = ""
    str_filter = ""
   
   
   str_product_filter = "[" & SvcValue & "] <> '' AND [" & SvcValue & "] <> 'UNKNOWN' AND [" & SvcValue & "] <> 'OTHERS' AND [" & SvcValue & "] <> 'OTH'"
   
   If Sheets("Dashboard").Range("C7").Value = "Week" Then
   str_date = " AND [Startclock Year] = " & Left(Sheets("Dashboard").Range("E7").Value, 4) & " AND [Startclock Week] = " & Trim(Right(Sheets("Dashboard").Range("E7").Value, 2)) & " "
   Else
   If Sheets("Dashboard").Range("C7").Value = "Year" Then
   str_date = " AND [Startclock Year] = " & Sheets("Dashboard").Range("E7").Value & " "
   Else
   If Sheets("Dashboard").Range("C7").Value = "Month" Then
   str_date = " AND [Startclock Year] = " & Left(Application.WorksheetFunction.VLookup(Sheets("Dashboard").Range("E7").Value, Sheets("LOV").Range("M:O"), 2, 0), 4) & " "
   str_date = str_date & " AND [Startclock Month] = '" & Application.WorksheetFunction.VLookup(Sheets("Dashboard").Range("E7").Value, Sheets("LOV").Range("M:O"), 3, 0) & "' "
   Else
   If Sheets("Dashboard").Range("C7").Value = "Last 3 Months" Then
   str_date = " AND (([Startclock Year] = " & Left(Sheets("LOV").Cells(2, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(2, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(3, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(3, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(4, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(4, 15).Value & "'))  "
   Else
   If Sheets("Dashboard").Range("C7").Value = "Last 6 Months" Then
   str_date = " AND (([Startclock Year] = " & Left(Sheets("LOV").Cells(2, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(2, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(3, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(3, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(4, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(4, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(5, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(5, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(6, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(6, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(7, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(7, 15).Value & "'))  "
   Else
    If Sheets("Dashboard").Range("C7").Value = "Full Period" Then
    str_date = " "
    End If
    End If
    End If
    End If
    End If
    End If
    
    
    'Services and Net
    strmainval = "Sum([Count of Shipments]),Sum([Net Monitored Volume]),sum([DHL Controllable Delay Flag])"
    str_fields = "[" & SvcValue & "]"
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
  
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    SQL = ""
    SQL = SQL & " SELECT " & str_fields & ", " & strmainval
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_product_filter & " " & str_date & " GROUP BY " & str_fields & " order by Sum([Count of Shipments]) DESC "
   

    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
    ' Debug.Print SQL
    ' oRS.Open
    ' strcount = oRS.RecordCount
    ' oRS.Close

    i = 1
    j = 2
    
    On Error Resume Next
    oRS.Open
    intloop = 0
    
    For i = 0 To 7
    str_nm(i) = ""
    str_val(i, 1) = 0
    str_val(i, 2) = 0
    str_val(i, 3) = 0
    
    Next
    intloop = 0
    Do Until oRS.EOF
    If oRS.EOF Then Exit Sub
        
    intloop = intloop + 1
      If intloop < 7 Then
        
       str_nm(intloop) = oRS(0).Value
       str_val(intloop, 1) = oRS(1).Value
       str_val(intloop, 2) = oRS(2).Value
       str_val(intloop, 3) = oRS(3).Value
      End If
   
      
   If intloop > 6 Then
   
    str_nm(7) = "Others"
    str_val(7, 1) = str_val(7, 1) + oRS(1).Value
    str_val(7, 2) = str_val(7, 2) + oRS(2).Value
    str_val(7, 3) = str_val(7, 3) + oRS(3).Value
      
   End If
   
   str_nm(0) = "Total"
   str_val(0, 1) = str_val(0, 1) + oRS(1).Value
   str_val(0, 2) = str_val(0, 2) + oRS(2).Value
   str_val(0, 3) = str_val(0, 3) + oRS(3).Value
         
    oRS.MoveNext
    Loop
    oCn.Close
   
         
   Set oRS = Nothing
   Set oCn = Nothing
   
   
    Sheets("Dashboard_Data").Cells(5, 1) = "Services"
   For i = 1 To 7
   If str_val(i, 1) <> 0 Then
    If SvcValue = "Service Name" Then 'if service name is selected vlookup service name to the friendly shortform
        Sheets("Dashboard_Data").Cells(5 + i, 1) = Application.WorksheetFunction.VLookup(str_nm(i), Sheets("LOV").Range("AP:AQ"), 2, 0)
    Else
        Sheets("Dashboard_Data").Cells(5 + i, 1) = str_nm(i) 'Else just use the fields
    End If
   Sheets("Dashboard_Data").Cells(5 + i, 2) = str_val(i, 1)
   End If
   Next
   
   Sheets("Dashboard_Data").Cells(2, 2) = str_val(0, 3)
   Sheets("Dashboard_Data").Cells(1, 2) = str_val(0, 2) - str_val(0, 3)
   Sheets("Dashboard_Data").Cells(1, 3) = str_val(0, 1)
   
   
 'Origins
    
    strmainval = "Sum([Count of Shipments])"
    str_fields = "[" & OrgValue & "]"
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
       
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

     SQL = ""
    SQL = SQL & " SELECT " & str_fields & ", " & strmainval
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_product_filter & " " & str_date & " GROUP BY " & str_fields & " order by " & strmainval & " DESC "
   

    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 1
    j = 2
    
   ' On Error Resume Next
    oRS.Open
    intloop = 0
    
    For i = 0 To 7
    str_nm(i) = ""
    str_val(i, 1) = 0
   
    
    Next
    intloop = 0
    Do Until oRS.EOF
        
        
        intloop = intloop + 1
      If intloop < 7 Then
        
       str_nm(intloop) = oRS(0).Value
       str_val(intloop, 1) = oRS(1).Value
       
      End If
   
    
        
   If intloop > 6 Then
   
   str_nm(7) = "Others"
   str_val(7, 1) = str_val(7, 1) + oRS(1).Value
  
      
   End If
   
   str_nm(0) = "Total"
   str_val(0, 1) = str_val(0, 1) + oRS(1).Value
  
         
    oRS.MoveNext
    Loop
    oCn.Close
   
         
   Set oRS = Nothing
   Set oCn = Nothing
   
   Sheets("Dashboard_Data").Cells(5, 4) = "Origins"
   For i = 1 To 7
   If str_val(i, 1) <> 0 Then
   Sheets("Dashboard_Data").Cells(5 + i, 4) = str_nm(i)
   Sheets("Dashboard_Data").Cells(5 + i, 5) = str_val(i, 1)
   End If
   Next
   
     
   'Destinations
   
    strmainval = "Sum([Count of Shipments])"
    str_fields = "[" & DstValue & "]"
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
   
       
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    SQL = ""
    SQL = SQL & " SELECT " & str_fields & ", " & strmainval
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_product_filter & " " & str_date & " GROUP BY " & str_fields & " order by " & strmainval & " DESC "
   

    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 1
    j = 2
    
   ' On Error Resume Next
    oRS.Open
    intloop = 0
    
    For i = 0 To 7
    str_nm(i) = ""
    str_val(i, 1) = 0
    
    
    Next
    intloop = 0
    Do Until oRS.EOF
        
        intloop = intloop + 1
      If intloop < 7 Then
        
       str_nm(intloop) = oRS(0).Value
       str_val(intloop, 1) = oRS(1).Value
       
      End If
   
    
        
   If intloop > 6 Then
   
   str_nm(7) = "Others"
   str_val(7, 1) = str_val(7, 1) + oRS(1).Value
   
      
   End If
   
   str_nm(0) = "Total"
   str_val(0, 1) = str_val(0, 1) + oRS(1).Value
  
         
    oRS.MoveNext
    Loop
    oCn.Close
   
         
   Set oRS = Nothing
   Set oCn = Nothing
   
   Sheets("Dashboard_Data").Cells(5, 7) = "Destinations"
   For i = 1 To 7
   If str_val(i, 1) <> 0 Then
   Sheets("Dashboard_Data").Cells(5 + i, 7) = str_nm(i)
   Sheets("Dashboard_Data").Cells(5 + i, 8) = str_val(i, 1)
   End If
   Next
   
   
   If Sheets("Dashboard").Range("H1").Value = 1 Then
    GoTo SkipCharts
   Else
   End If
    
    
    'custom loop
   
   k = 10
   
   For custom_int = 10 To 26
   
   If Sheets("Setup").Cells(custom_int, 9).Value = "Y" And Sheets("Setup").Cells(custom_int, 5).Value <> "Billing Net Invoiced Amount" Then 'Updated
   
    strmainval = Application.WorksheetFunction.VLookup(Sheets("Setup").Cells(custom_int, 5).Value, Sheets("LOV").Range("F:I"), 3, 0)
    str_fields = "[" & Application.WorksheetFunction.VLookup(Sheets("Setup").Cells(custom_int, 5).Value, Sheets("LOV").Range("F:I"), 4, 0) & "]"
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
          
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    SQL = ""
    SQL = SQL & " SELECT " & str_fields & ", " & strmainval
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_product_filter & " " & str_date & " GROUP BY " & str_fields & " HAVING " & strmainval & " <> 0 order by " & strmainval & " DESC "
   

    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 1
    j = 2
    
   ' On Error Resume Next
    oRS.Open
    intloop = 0
    
    For i = 0 To 7
    str_nm(i) = ""
    str_val(i, 1) = 0
    str_val(i, 2) = 0
    str_val(i, 3) = 0
    
    Next
    intloop = 0
    Do Until oRS.EOF
        
        
        intloop = intloop + 1
      If intloop < 7 Then
        
       str_nm(intloop) = oRS(0).Value
       str_val(intloop, 1) = oRS(1).Value
      
      End If
   
    
        
   If intloop > 6 Then
   
   str_nm(7) = "Others"
   str_val(7, 1) = str_val(7, 1) + oRS(1).Value
   
      
   End If
   
   str_nm(0) = "Total"
   str_val(0, 1) = str_val(0, 1) + oRS(1).Value
   
         
    oRS.MoveNext
    Loop
    oCn.Close
   
         
   Set oRS = Nothing
   Set oCn = Nothing
   
   If InStr(1, "Dest", str_fields, vbTextCompare) > 0 Then Sheets("Dashboard_Data").Cells(4, k) = "(Destinations)"
   If InStr(1, "Orig", str_fields, vbTextCompare) > 0 Then Sheets("Dashboard_Data").Cells(4, k) = "(Origins)"
   Sheets("Dashboard_Data").Cells(5, k) = Sheets("Setup").Cells(custom_int, 5).Value
   
   For i = 1 To 7
   If str_val(i, 1) <> 0 Then
   Sheets("Dashboard_Data").Cells(5 + i, k) = str_nm(i)
   Sheets("Dashboard_Data").Cells(5 + i, k + 1) = str_val(i, 1)
   End If
   Next
   k = k + 3
   End If
   Next
   
   
    
SkipCharts:
   
    On Error Resume Next
   
    
    Sheets("Dashboard_Data").Range("C5") = "=SUM(B6:B12)/$C$1"
    Sheets("Dashboard").ChartObjects("Services").Activate
    k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("A7:A12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("A6:B" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 63
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("B" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("B6:B12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("Dashboard_Data").Range("F5") = "=SUM(E6:E12)/$C$1"
    Sheets("Dashboard").ChartObjects("Origins").Activate
    k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("D7:D12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("D6:E" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
     ActiveChart.Legend.Width = 41
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("E" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("E6:E12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("Dashboard_Data").Range("I5") = "=SUM(H6:H12)/$C$1"
    Sheets("Dashboard").ChartObjects("Destinations").Activate
    k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("G7:G12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("G6:H" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 41
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("H" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("H6:H12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    
   If Sheets("Dashboard").Range("H1").Value = 1 Then
    GoTo SkipCharts2
   Else
   End If
   
    Sheets("Dashboard_Data").Range("L5") = "=SUM(K6:K12)/$C$1"
     Sheets("Dashboard").ChartObjects("ODD").Activate
     k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("J7:J12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("J6:K" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 41
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("K" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("K6:K12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("Dashboard_Data").Range("O5") = "=SUM(N6:N12)/$C$1"
     Sheets("Dashboard").ChartObjects("Ecom").Activate
     k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("M7:M12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("M6:N" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 41
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("N" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("N6:N12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("Dashboard_Data").Range("R5") = "=SUM(Q6:Q12)/$C$1"
    Sheets("Dashboard").ChartObjects("Undel").Activate
    k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("P7:P12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("P6:Q" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 41
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("Q" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("Q6:Q12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("Dashboard_Data").Range("U5") = "=SUM(T6:T12)/$C$1"
     Sheets("Dashboard").ChartObjects("Pickup").Activate
     k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("S7:S12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("S6:T" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 41
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("T" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("T6:T12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("Dashboard_Data").Range("X5") = "=SUM(W6:W12)/$C$1"
     Sheets("Dashboard").ChartObjects("Damaged").Activate
     k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("V7:V12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("V6:W" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 41
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("W" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("W6:W12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("Dashboard_Data").Range("AA5") = "=SUM(Z6:Z12)/$C$1"
    Sheets("Dashboard").ChartObjects("Remote").Activate
    k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("Y7:Y12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("Y6:Z" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 41
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("Z" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("Z6:Z12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("Dashboard_Data").Range("AD5") = "=SUM(AC6:AC12)/$C$1"
    Sheets("Dashboard").ChartObjects("3rdParty").Activate
    k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("AB7:AB12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("AB6:AC" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 41
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("AC" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("AC6:AC12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("Dashboard_Data").Range("AG5") = "=SUM(AF6:AF12)/$C$1"
     Sheets("Dashboard").ChartObjects("Duty").Activate
     k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("AE7:AE12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("AE6:AF" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 41
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("AF" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("AF6:AF12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("Dashboard_Data").Range("AJ5") = "=SUM(AI6:AI12)/$C$1"
    Sheets("Dashboard").ChartObjects("Ghost").Activate
    k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("AH7:AH12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("AH6:AI" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 41
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("AI" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("AI6:AI12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    Sheets("Dashboard_Data").Range("AM5") = "=SUM(AL6:AL12)/$C$1"
    Sheets("Dashboard").ChartObjects("AgreeDel").Activate
    k = Application.WorksheetFunction.CountA(Sheets("Dashboard_Data").Range("AK7:AK12"))
    ActiveChart.SetSourceData Source:=Sheets("Dashboard_data").Range("AK6:AL" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.Legend.Width = 41
    ActiveChart.Legend.Height = 119
    ActiveChart.PlotBy = xlColumns
    For i = 1 To 7
    If Sheets("Dashboard_data").Range("AL" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("Dashboard_data").Range("AL6:AL12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next

SkipCharts2:

   If Application.WorksheetFunction.CountA(Sheets("Setup").Range("E10:E25")) = 0 Then
    Sheets("Dashboard").ChartObjects("ODD").Visible = False
    Sheets("Dashboard").ChartObjects("Ecom").Visible = False
    Sheets("Dashboard").ChartObjects("Undel").Visible = False
    Sheets("Dashboard").ChartObjects("Pickup").Visible = False
    Sheets("Dashboard").ChartObjects("Damaged").Visible = False
    Sheets("Dashboard").ChartObjects("Remote").Visible = False
    Sheets("Dashboard").ChartObjects("3rdParty").Visible = False
    Sheets("Dashboard").ChartObjects("Duty").Visible = False
    Sheets("Dashboard").ChartObjects("Ghost").Visible = False
    Sheets("Dashboard").ChartObjects("AgreeDel").Visible = False
   End If
  
  If Application.WorksheetFunction.CountA(Sheets("Setup").Range("E10:E25")) = 1 Then
    Sheets("Dashboard").ChartObjects("ODD").Visible = True
    Sheets("Dashboard").ChartObjects("Ecom").Visible = False
    Sheets("Dashboard").ChartObjects("Undel").Visible = False
    Sheets("Dashboard").ChartObjects("Pickup").Visible = False
    Sheets("Dashboard").ChartObjects("Damaged").Visible = False
    Sheets("Dashboard").ChartObjects("Remote").Visible = False
    Sheets("Dashboard").ChartObjects("3rdParty").Visible = False
    Sheets("Dashboard").ChartObjects("Duty").Visible = False
    Sheets("Dashboard").ChartObjects("Ghost").Visible = False
    Sheets("Dashboard").ChartObjects("AgreeDel").Visible = False
   End If
  
   If Application.WorksheetFunction.CountA(Sheets("Setup").Range("E10:E25")) = 2 Then
    Sheets("Dashboard").ChartObjects("ODD").Visible = True
    Sheets("Dashboard").ChartObjects("Ecom").Visible = True
    Sheets("Dashboard").ChartObjects("Undel").Visible = False
    Sheets("Dashboard").ChartObjects("Pickup").Visible = False
    Sheets("Dashboard").ChartObjects("Damaged").Visible = False
    Sheets("Dashboard").ChartObjects("Remote").Visible = False
    Sheets("Dashboard").ChartObjects("3rdParty").Visible = False
    Sheets("Dashboard").ChartObjects("Duty").Visible = False
    Sheets("Dashboard").ChartObjects("Ghost").Visible = False
    Sheets("Dashboard").ChartObjects("AgreeDel").Visible = False
   End If
   
   If Application.WorksheetFunction.CountA(Sheets("Setup").Range("E10:E25")) = 3 Then
    Sheets("Dashboard").ChartObjects("ODD").Visible = True
    Sheets("Dashboard").ChartObjects("Ecom").Visible = True
    Sheets("Dashboard").ChartObjects("Undel").Visible = True
    Sheets("Dashboard").ChartObjects("Pickup").Visible = False
    Sheets("Dashboard").ChartObjects("Damaged").Visible = False
    Sheets("Dashboard").ChartObjects("Remote").Visible = False
    Sheets("Dashboard").ChartObjects("3rdParty").Visible = False
    Sheets("Dashboard").ChartObjects("Duty").Visible = False
    Sheets("Dashboard").ChartObjects("Ghost").Visible = False
    Sheets("Dashboard").ChartObjects("AgreeDel").Visible = False
   End If

If Application.WorksheetFunction.CountA(Sheets("Setup").Range("E10:E25")) = 4 Then
    Sheets("Dashboard").ChartObjects("ODD").Visible = True
    Sheets("Dashboard").ChartObjects("Ecom").Visible = True
    Sheets("Dashboard").ChartObjects("Undel").Visible = True
    Sheets("Dashboard").ChartObjects("Pickup").Visible = True
    Sheets("Dashboard").ChartObjects("Damaged").Visible = False
    Sheets("Dashboard").ChartObjects("Remote").Visible = False
    Sheets("Dashboard").ChartObjects("3rdParty").Visible = False
    Sheets("Dashboard").ChartObjects("Duty").Visible = False
    Sheets("Dashboard").ChartObjects("Ghost").Visible = False
    Sheets("Dashboard").ChartObjects("AgreeDel").Visible = False
   End If
   
 If Application.WorksheetFunction.CountA(Sheets("Setup").Range("E10:E25")) = 5 Then
    Sheets("Dashboard").ChartObjects("ODD").Visible = True
    Sheets("Dashboard").ChartObjects("Ecom").Visible = True
    Sheets("Dashboard").ChartObjects("Undel").Visible = True
    Sheets("Dashboard").ChartObjects("Pickup").Visible = True
    Sheets("Dashboard").ChartObjects("Damaged").Visible = True
    Sheets("Dashboard").ChartObjects("Remote").Visible = False
    Sheets("Dashboard").ChartObjects("3rdParty").Visible = False
    Sheets("Dashboard").ChartObjects("Duty").Visible = False
    Sheets("Dashboard").ChartObjects("Ghost").Visible = False
    Sheets("Dashboard").ChartObjects("AgreeDel").Visible = False
   End If

If Application.WorksheetFunction.CountA(Sheets("Setup").Range("E10:E25")) = 6 Then
    Sheets("Dashboard").ChartObjects("ODD").Visible = True
    Sheets("Dashboard").ChartObjects("Ecom").Visible = True
    Sheets("Dashboard").ChartObjects("Undel").Visible = True
    Sheets("Dashboard").ChartObjects("Pickup").Visible = True
    Sheets("Dashboard").ChartObjects("Damaged").Visible = True
    Sheets("Dashboard").ChartObjects("Remote").Visible = True
    Sheets("Dashboard").ChartObjects("3rdParty").Visible = False
    Sheets("Dashboard").ChartObjects("Duty").Visible = False
    Sheets("Dashboard").ChartObjects("Ghost").Visible = False
    Sheets("Dashboard").ChartObjects("AgreeDel").Visible = False
   End If

If Application.WorksheetFunction.CountA(Sheets("Setup").Range("E10:E25")) = 7 Then
    Sheets("Dashboard").ChartObjects("ODD").Visible = True
    Sheets("Dashboard").ChartObjects("Ecom").Visible = True
    Sheets("Dashboard").ChartObjects("Undel").Visible = True
    Sheets("Dashboard").ChartObjects("Pickup").Visible = True
    Sheets("Dashboard").ChartObjects("Damaged").Visible = True
    Sheets("Dashboard").ChartObjects("Remote").Visible = True
    Sheets("Dashboard").ChartObjects("3rdParty").Visible = True
    Sheets("Dashboard").ChartObjects("Duty").Visible = False
    Sheets("Dashboard").ChartObjects("Ghost").Visible = False
    Sheets("Dashboard").ChartObjects("AgreeDel").Visible = False
   End If
   
 If Application.WorksheetFunction.CountA(Sheets("Setup").Range("E10:E25")) = 8 Then
    Sheets("Dashboard").ChartObjects("ODD").Visible = True
    Sheets("Dashboard").ChartObjects("Ecom").Visible = True
    Sheets("Dashboard").ChartObjects("Undel").Visible = True
    Sheets("Dashboard").ChartObjects("Pickup").Visible = True
    Sheets("Dashboard").ChartObjects("Damaged").Visible = True
    Sheets("Dashboard").ChartObjects("Remote").Visible = True
    Sheets("Dashboard").ChartObjects("3rdParty").Visible = True
    Sheets("Dashboard").ChartObjects("Duty").Visible = True
    Sheets("Dashboard").ChartObjects("Ghost").Visible = False
    Sheets("Dashboard").ChartObjects("AgreeDel").Visible = False
   End If
   
  If Application.WorksheetFunction.CountA(Sheets("Setup").Range("E10:E25")) > 8 Then
    Sheets("Dashboard").ChartObjects("ODD").Visible = True
    Sheets("Dashboard").ChartObjects("Ecom").Visible = True
    Sheets("Dashboard").ChartObjects("Undel").Visible = True
    Sheets("Dashboard").ChartObjects("Pickup").Visible = True
    Sheets("Dashboard").ChartObjects("Damaged").Visible = True
    Sheets("Dashboard").ChartObjects("Remote").Visible = True
    Sheets("Dashboard").ChartObjects("3rdParty").Visible = True
    Sheets("Dashboard").ChartObjects("Duty").Visible = True
    Sheets("Dashboard").ChartObjects("Ghost").Visible = True
    Sheets("Dashboard").ChartObjects("AgreeDel").Visible = False
   End If
   
     If Application.WorksheetFunction.CountA(Sheets("Setup").Range("E10:E25")) > 9 Then
    Sheets("Dashboard").ChartObjects("ODD").Visible = True
    Sheets("Dashboard").ChartObjects("Ecom").Visible = True
    Sheets("Dashboard").ChartObjects("Undel").Visible = True
    Sheets("Dashboard").ChartObjects("Pickup").Visible = True
    Sheets("Dashboard").ChartObjects("Damaged").Visible = True
    Sheets("Dashboard").ChartObjects("Remote").Visible = True
    Sheets("Dashboard").ChartObjects("3rdParty").Visible = True
    Sheets("Dashboard").ChartObjects("Duty").Visible = True
    Sheets("Dashboard").ChartObjects("Ghost").Visible = True
    Sheets("Dashboard").ChartObjects("AgreeDel").Visible = True
   End If

    Sheets("Dashboard").Range("H1") = 0

Sheets("Dashboard").Range("B9").Select
Application.UseSystemSeparators = True
Application.ScreenUpdating = True
Application.Calculation = xlCalculationAutomatic
    
End Sub


Attribute VB_Name = "Deep_dive"
Sub DeepDive_data()


    Dim j As Integer
    Dim i As Integer
    Dim k As Integer
    Dim l As Integer
    
    Dim oCn As ADODB.Connection
    Dim oRS As ADODB.Recordset
    Dim ConnString As String
    Dim SQL As String
    Dim intloop
    Dim intloop2
    Dim strcount
    Dim strrow
    Dim strcol
    Dim region_code
    Dim orig_reg
    Dim dest_reg
     
   Dim strr
   Dim strc
   
   Dim strcrit
   Dim strmainval
   
   Dim str_product_filter
   Dim str_date
   
   Dim str_orig_field
   Dim str_dest_field
   Dim str_direction
   Dim str_filter
   Dim strdimension
   Dim strproduct
   Dim str_fields
   Dim str_group
   
   ReDim str_val(7)
   ReDim str_nm(7)
 
   
   
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    With Application
    .DecimalSeparator = "."
    .ThousandsSeparator = ","
End With

  
   Sheets("DeepDive_data").Range("A6:K15") = ""
    
    
  strr = "R"
  strc = "C"
  
    'define product field
  
   
   'define filter
  
  If Sheets("Setup").Range("I8").Value = "" Then
  strcrit = 0.955
  Else
  strcrit = Sheets("Setup").Range("I8").Value
  End If
   
   
   
   
    'define measure field
    
    
   str_product_filter = ""
   str_date = ""
   str_orig_field = ""
   str_dest_field = ""
   'str_direction = ""
   str_filter = ""
   strdimension = ""
   strproduct = ""
   
   
   strproduct = "[" & Application.WorksheetFunction.VLookup(Sheets("DeepDive").Range("R7").Value, Sheets("LOV").Range("Y:Z"), 2, 0) & "]"
   
   If Sheets("DeepDive").Range("B7").Value = "Origin Region" Then
   str_orig_field = "[Origin Region Name]"
   Else
   str_orig_field = "[Origin Country/Territory Name]"
   End If
   If Sheets("DeepDive").Range("K7").Value = "Destination Region" Then
   str_dest_field = "[Destination Region Name]"
   Else
   str_dest_field = "[Destination Country/Territory Name]"
   End If
   
   If Sheets("DeepDive").Range("E11").Value = "Lane" Then
   strdimension = str_orig_field & "," & str_dest_field
   Else
   If Sheets("DeepDive").Range("E11").Value = "Origin" Then
   strdimension = str_orig_field & "," & str_orig_field
   Else
   If Sheets("DeepDive").Range("E11").Value = "Destination" Then
   strdimension = str_dest_field & "," & str_dest_field
   Else
   If Sheets("DeepDive").Range("E11").Value = "Services" Then
   strdimension = strproduct & "," & strproduct
   Else
   If Sheets("DeepDive").Range("E11").Value = "Weight Type" Then
   strdimension = "[Shipment Weight Type],[Shipment Weight Type]"
   Else
   If Sheets("DeepDive").Range("E11").Value = "Service Area" Then
   strdimension = "[Origin Service Area Name],[Destination Service Area Name]"
    Else
   If Sheets("DeepDive").Range("E11").Value = "Program" Then
   strdimension = "[OPMC Program],[OPMC Program]"
    Else
   If Sheets("DeepDive").Range("E11").Value = "Account" Then
   strdimension = "[Billing Account Number],[Billing Account Name]"
   Else
   If Sheets("DeepDive").Range("E11").Value = "Delay Code" Then
   strdimension = "[Reporting Code],[Reporting Code Description]"
  
   End If
   End If
   End If
   End If
   End If
   End If
   End If
   End If
   End If
  
   
        
      
   
   If Sheets("DeepDive").Range("T7").Value <> "ALL" Then
   str_product_filter = " AND " & strproduct & " = '" & Sheets("DeepDive").Range("T7").Value & "' "
   Else
   str_product_filter = " AND " & strproduct & " <> '' "
   End If
   
   If Sheets("DeepDive").Range("V7").Value = "Week" Then
   str_date = " AND [Startclock Year] = " & Left(Sheets("DeepDive").Range("Y7").Value, 4) & " AND [Startclock Week] = " & Trim(Right(Sheets("DeepDive").Range("Y7").Value, 2)) & " "
   Else
   If Sheets("DeepDive").Range("S7").Value = "Year" Then
   str_date = " AND [Startclock Year] = " & Sheets("DeepDive").Range("Y7").Value & " "
   Else
   If Sheets("DeepDive").Range("V7").Value = "Month" Then
   str_date = " AND [Startclock Year] = " & Left(Application.WorksheetFunction.VLookup(Sheets("DeepDive").Range("Y7").Value, Sheets("LOV").Range("M:O"), 2, 0), 4) & " "
   str_date = str_date & " AND [Startclock Month] = '" & Application.WorksheetFunction.VLookup(Sheets("DeepDive").Range("Y7").Value, Sheets("LOV").Range("M:O"), 3, 0) & "' "
   Else
   If Sheets("DeepDive").Range("V7").Value = "Last 3 Months" Then
   str_date = " AND (([Startclock Year] = " & Left(Sheets("LOV").Cells(2, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(2, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(3, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(3, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(4, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(4, 15).Value & "'))  "
   Else
   If Sheets("DeepDive").Range("V7").Value = "Last 6 Months" Then
   str_date = " AND (([Startclock Year] = " & Left(Sheets("LOV").Cells(2, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(2, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(3, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(3, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(4, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(4, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(5, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(5, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(6, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(6, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(7, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(7, 15).Value & "'))  "
   Else
   If Sheets("DeepDive").Range("V7").Value = "Full Period" Then
   str_date = " "
   End If
   End If
   End If
   End If
   End If
   End If
   
   
   
   If Sheets("DeepDive").Range("F7").Value <> "ALL" And Sheets("DeepDive").Range("O7").Value <> "ALL" Then
   str_direction = "(" & str_orig_field & " = '" & Sheets("DeepDive").Range("F7").Value & "' " & Sheets("DeepDive").Range("I7").Value & " " & str_dest_field & " = '" & Sheets("DeepDive").Range("O7").Value & "') "
   
   Else
   If Sheets("DeepDive").Range("F7").Value <> "ALL" And Sheets("DeepDive").Range("O7").Value = "ALL" Then
   str_direction = str_orig_field & " = '" & Sheets("DeepDive").Range("F7").Value & "' "
   Else
   If Sheets("DeepDive").Range("F7").Value = "ALL" And Sheets("DeepDive").Range("O7").Value <> "ALL" Then
    str_direction = str_dest_field & " = '" & Sheets("DeepDive").Range("O7").Value & "' "
   Else
   str_direction = str_orig_field & " <> '' AND " & str_dest_field & " <> '' "
   End If
   End If
   End If
  
   
      
  
    'define current period
    
  
    strmainval = "Sum([On Time Volume])"
        
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
           
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

     SQL = ""
    SQL = SQL & " SELECT " & strdimension & ", " & strmainval
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_direction & " " & str_product_filter & " " & str_date & " GROUP BY " & strdimension & " order by " & strmainval & " DESC "
   

    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 1
    j = 2
    
   ' On Error Resume Next
    oRS.Open
    intloop = 0
    
    For i = 0 To 7
    str_nm(i) = ""
    str_val(i) = 0
    
    Next
    intloop = 0
    Do Until oRS.EOF
        
        
        intloop = intloop + 1
        If intloop < 7 Then
        
    If Sheets("DeepDive").Range("E11").Value = "Lane" Then
    str_nm(intloop) = oRS(0).Value & "-" & oRS(1).Value
    Else
    str_nm(intloop) = oRS(0).Value
   
    End If
  
   str_val(intloop) = oRS(2).Value
    
   
   End If
   
        
   If intloop > 6 Then
   
   str_nm(7) = "Other"
   str_val(7) = str_val(7) + oRS(2).Value
      
   End If
   
   str_nm(0) = "Total"
    str_val(0) = str_val(0) + oRS(2).Value
         
    oRS.MoveNext
    Loop
    oCn.Close
   
         
   Set oRS = Nothing
   Set oCn = Nothing
   
   
   For i = 1 To 7
   Sheets("DeepDive_Data").Cells(5 + i, 1) = str_nm(i)
   Sheets("DeepDive_Data").Cells(5 + i, 2) = str_val(i)
   
   Next
   
   Sheets("DeepDive_Data").Cells(2, 1) = "OT"
   Sheets("DeepDive_Data").Cells(2, 2) = str_val(0)
   
   'next is DC
   
    strmainval = "Sum([DHL Controllable Delay Flag])"
        
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    SQL = ""
    SQL = SQL & " SELECT " & strdimension & ", " & strmainval
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_direction & " " & str_product_filter & " " & str_date & " AND [DHL Controllable Delay Flag] > 0 GROUP BY " & strdimension & " order by " & strmainval & " DESC "
   

    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
    '  Debug.Print SQL
    '   oRS.Open
    '  strcount = oRS.RecordCount
    '   oRS.Close

    i = 1
    j = 2
    
    On Error Resume Next
    oRS.Open
   
    
     For i = 0 To 7
    str_nm(i) = ""
    str_val(i) = 0
    
    Next
   intloop = 0
    Do Until oRS.EOF
        
    If oRS.EOF Then Exit Sub
        intloop = intloop + 1
    If intloop < 7 Then
        
    If Sheets("DeepDive").Range("E11").Value = "Lane" Or Sheets("DeepDive").Range("E11").Value = "Account" Or Sheets("DeepDive").Range("E11").Value = "Service Area" Or Sheets("DeepDive").Range("E11").Value = "Delay Code" Then
    str_nm(intloop) = oRS(0).Value & "-" & oRS(1).Value
    Else
    str_nm(intloop) = oRS(0).Value
        
    End If

    str_val(intloop) = oRS(2).Value
      
   End If
          
   If intloop > 6 Then
   
   str_nm(7) = "Other"
   str_val(7) = str_val(7) + oRS(2).Value
      
   End If
   
   str_nm(0) = "Total"
    str_val(0) = str_val(0) + oRS(2).Value
         
    oRS.MoveNext
    Loop
    oCn.Close
   
         
   Set oRS = Nothing
   Set oCn = Nothing
   
   
   For i = 1 To 7
   Sheets("DeepDive_Data").Cells(5 + i, 4) = str_nm(i)
   Sheets("DeepDive_Data").Cells(5 + i, 5) = str_val(i)
   
   Next
   
   Sheets("DeepDive_Data").Cells(2, 4) = "Within DHL Control"
   Sheets("DeepDive_Data").Cells(2, 5) = str_val(0)
   

 'next is DU
   
    strmainval = "Sum([DHL Uncontrollable Delay Flag])"
        
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
    
       
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

     SQL = ""
    SQL = SQL & " SELECT " & strdimension & ", " & strmainval
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_direction & " " & str_product_filter & " " & str_date & " AND [DHL Uncontrollable Delay Flag] > 0 GROUP BY " & strdimension & " order by " & strmainval & " DESC "
   

    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 1
    j = 2
    
   ' On Error Resume Next
    oRS.Open
    
     For i = 0 To 7
    str_nm(i) = ""
    str_val(i) = 0
    
    Next
    intloop = 0
    Do Until oRS.EOF
        
        
      intloop = intloop + 1
    If intloop < 7 Then
        
    If Sheets("DeepDive").Range("E11").Value = "Lane" Or Sheets("DeepDive").Range("E11").Value = "Account" Or Sheets("DeepDive").Range("E11").Value = "Service Area" Or Sheets("DeepDive").Range("E11").Value = "Delay Code" Then
    str_nm(intloop) = oRS(0).Value & "-" & oRS(1).Value
    Else
    str_nm(intloop) = oRS(0).Value
        
    End If

    str_val(intloop) = oRS(2).Value
      
   End If
          
   If intloop > 6 Then
   
   str_nm(7) = "Other"
   str_val(7) = str_val(7) + oRS(2).Value
      
   End If
   
   str_nm(0) = "Total"
    str_val(0) = str_val(0) + oRS(2).Value
         
    oRS.MoveNext
    Loop
    oCn.Close
   
         
   Set oRS = Nothing
   Set oCn = Nothing
   
   
   For i = 1 To 7
   Sheets("DeepDive_Data").Cells(5 + i, 7) = str_nm(i)
   Sheets("DeepDive_Data").Cells(5 + i, 8) = str_val(i)
   
   Next
   
   Sheets("DeepDive_Data").Cells(2, 7) = "DU"
   Sheets("DeepDive_Data").Cells(2, 8) = str_val(0)
   


 'next is CC
   
    strmainval = "Sum([Customer Controllable Delay Flag])"
        
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
     
       
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

     SQL = ""
    SQL = SQL & " SELECT " & strdimension & ", " & strmainval
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_direction & " " & str_product_filter & " " & str_date & " AND [Customer Controllable Delay Flag] > 0 GROUP BY " & strdimension & " order by " & strmainval & " DESC "
   

    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 1
    j = 2
    
   ' On Error Resume Next
    oRS.Open
    
    
     For i = 0 To 7
    str_nm(i) = ""
    str_val(i) = 0
    
    Next
    intloop = 0
    Do Until oRS.EOF
        
        
       intloop = intloop + 1
    If intloop < 7 Then
        
    If Sheets("DeepDive").Range("E11").Value = "Lane" Or Sheets("DeepDive").Range("E11").Value = "Account" Or Sheets("DeepDive").Range("E11").Value = "Service Area" Or Sheets("DeepDive").Range("E11").Value = "Delay Code" Then
    str_nm(intloop) = oRS(0).Value & "-" & oRS(1).Value
    Else
    str_nm(intloop) = oRS(0).Value
        
    End If
 
    str_val(intloop) = oRS(2).Value
      
   End If
          
   If intloop > 6 Then
   
   str_nm(7) = "Other"
   str_val(7) = str_val(7) + oRS(2).Value
      
   End If
   
   str_nm(0) = "Total"
    str_val(0) = str_val(0) + oRS(2).Value
         
    oRS.MoveNext
    Loop
    oCn.Close
   
         
   Set oRS = Nothing
   Set oCn = Nothing
   
   
   
   For i = 1 To 7
   Sheets("DeepDive_Data").Cells(5 + i, 10) = str_nm(i)
   Sheets("DeepDive_Data").Cells(5 + i, 11) = str_val(i)
   
   Next
   
   On Error Resume Next
   
   Sheets("DeepDive_Data").Cells(2, 10) = "CC"
   Sheets("DeepDive_Data").Cells(2, 11) = str_val(0)
   
    Sheets("DeepDive").ChartObjects("DU").Activate
    k = Application.WorksheetFunction.CountA(Sheets("DeepDive_Data").Range("G7:G12"))
    ActiveChart.SetSourceData Source:=Sheets("DeepDive_Data").Range("G6:H" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.HasLegend = True
    ActiveChart.Legend.Width = 108
    ActiveChart.Legend.Height = 139
    For i = 1 To 7
    If Sheets("DeepDive_data").Range("H" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("DeepDive_data").Range("H6:H12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    ActiveChart.PlotBy = xlColumns
    
    Sheets("DeepDive").ChartObjects("CC").Activate
    k = Application.WorksheetFunction.CountA(Sheets("DeepDive_Data").Range("J7:J12"))
    ActiveChart.SetSourceData Source:=Sheets("DeepDive_Data").Range("J6:K" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.HasLegend = True
    ActiveChart.Legend.Width = 108
    ActiveChart.Legend.Height = 139
    For i = 1 To 7
    If Sheets("DeepDive_data").Range("K" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("DeepDive_data").Range("K6:K12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    ActiveChart.PlotBy = xlColumns
    Sheets("DeepDive").ChartObjects("DC").Activate
    k = Application.WorksheetFunction.CountA(Sheets("DeepDive_Data").Range("D7:D12"))
    ActiveChart.SetSourceData Source:=Sheets("DeepDive_Data").Range("D6:E" & 6 + k)
    ActiveChart.SetElement (msoElementDataLabelNone)
    ActiveChart.SetElement (msoElementDataLabelShow)
    ActiveChart.SeriesCollection(1).DataLabels.ShowPercentage = True
    ActiveChart.SeriesCollection(1).DataLabels.ShowValue = False
    ActiveChart.HasLegend = True
    ActiveChart.Legend.Width = 108
    ActiveChart.Legend.Height = 139
    For i = 1 To 7
    If Sheets("DeepDive_data").Range("E" & 5 + i).Value / Application.WorksheetFunction.Sum(Sheets("DeepDive_data").Range("E6:E12")) < 0.04 Then
    ActiveChart.SeriesCollection(1).Points(i).DataLabel.Delete
    End If
    Next
    ActiveChart.PlotBy = xlColumns



Application.UseSystemSeparators = True

Sheets("Deep_Dive").Range("A9").Select


Application.ScreenUpdating = True
Application.Calculation = xlCalculationAutomatic
    




End Sub


Sub top_20()

  Dim j As Integer
    Dim i As Integer
    Dim ii As Integer
    
    Dim k As Integer
    Dim l As Integer
    
    Dim oCn As ADODB.Connection
    Dim oRS As ADODB.Recordset
    Dim ConnString As String
    Dim SQL As String
    Dim intloop
    Dim intloop2
    Dim strcount
    Dim strrow
    Dim strcol
    Dim region_code
    Dim orig_reg
    Dim dest_reg
     
    Dim strr
    Dim strc
   
    Dim strcrit
    Dim strmainval
    Dim strorderval
    Dim str_product_filter
    Dim str_date
    Dim strmeasures
    Dim strmeasurecnt
   
    Dim str_orig_field
    Dim str_dest_field
    Dim str_direction
    Dim str_filter
   
    Dim str_fields
    Dim str_group
    Dim strrepfilter
    Dim strdimension
    Dim strproduct

    Dim TopNo
    Dim TabLast
    Dim TabTot
    Dim TabOther
    Dim answer As Integer
    
    Dim FieldSel
    Dim TopSel

    TabOther = 0
    
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    With Application
    .DecimalSeparator = "."
    .ThousandsSeparator = ","
    End With
    
    'unhide table rows
    Sheets("DeepDive").Rows(12 & ":215").EntireRow.Hidden = False
    
    FieldSel = Sheets("DeepDive").Range("T12").Value
    TopNo = Sheets("DeepDive").Range("S12").Value
    TopSel = Sheets("DeepDive").Range("S12").Value
    
    If (FieldSel = "Weight Type") And (TopNo = "Top 50" Or TopNo = "Top 100" Or TopNo = "Top 200") Then
        TopNo = "Top 20"
    ElseIf (FieldSel = "Services" Or FieldSel = "Customer Controllable" Or FieldSel = "DHL Controllable" Or FieldSel = "DHL Uncontrollable") And (TopNo = "Top 100" Or TopNo = "Top 200") Then
        TopNo = "Top 50"
    ElseIf (FieldSel = "Program") And (TopNo = "Top 200") Then
        TopNo = "Top 100"
    Else
    End If
    
    Application.StatusBar = "Calculating values for " & TopSel & " " & FieldSel & " table...Please be patient..."
    
    'Hard coding the table formatting to Top 20, top50, top100 and top200 selection
    If TopNo = "Top 20" Then
        TabTot = 20
        TabLast = 34
        'Format for Top 20 total BOLD
        Sheets("DeepDive").Range("S34:AR34").Font.Bold = True
        With Sheets("DeepDive").Range("S34:AR34").Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .ThemeColor = xlThemeColorDark1
            .TintAndShade = -0.249977111117893
            .PatternTintAndShade = 0
        End With
        'Format for Top 20 Others BOLD
        Sheets("DeepDive").Range("S33:AR33").Font.Bold = True
        With Sheets("DeepDive").Range("S33:AR33").Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 50 total
        Sheets("DeepDive").Range("S64:AR64").Font.Bold = False
        With Sheets("DeepDive").Range("S64:AR64").Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = 10092543
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 50 Others
        Sheets("DeepDive").Range("S63:AR63").Font.Bold = False
        With Sheets("DeepDive").Range("S63:AR63").Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 100 total
        Sheets("DeepDive").Range("S114:AR114").Font.Bold = False
        With Sheets("DeepDive").Range("S114:AR114").Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = 10092543
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 100 Others
        Sheets("DeepDive").Range("S113:AR113").Font.Bold = False
        With Sheets("DeepDive").Range("S113:AR113").Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        
    ElseIf TopNo = "Top 50" Then
        TabTot = 50
        TabLast = 64
        'Format for Top 20 total
        Sheets("DeepDive").Range("S34:AR34").Font.Bold = False
        With Sheets("DeepDive").Range("S34:AR34").Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = 10092543
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 20 Others
        Sheets("DeepDive").Range("S33:AR33").Font.Bold = False
        With Sheets("DeepDive").Range("S33:AR33").Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 50 total BOLD
        Sheets("DeepDive").Range("S64:AR64").Font.Bold = True
        With Sheets("DeepDive").Range("S64:AR64").Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .ThemeColor = xlThemeColorDark1
            .TintAndShade = -0.249977111117893
            .PatternTintAndShade = 0
        End With
        'Format for Top 50 Others BOLD
        Sheets("DeepDive").Range("S63:AR63").Font.Bold = True
        With Sheets("DeepDive").Range("S63:AR63").Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 100 total
        Sheets("DeepDive").Range("S114:AR114").Font.Bold = False
        With Sheets("DeepDive").Range("S114:AR114").Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = 10092543
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 100 Others
        Sheets("DeepDive").Range("S113:AR113").Font.Bold = False
        With Sheets("DeepDive").Range("S113:AR113").Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        
    ElseIf TopNo = "Top 100" Then
        TabTot = 100
        TabLast = 114
        'Format for Top 20 total
        Sheets("DeepDive").Range("S34:AR34").Font.Bold = False
        With Sheets("DeepDive").Range("S34:AR34").Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = 10092543
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 20 Others
        Sheets("DeepDive").Range("S33:AR33").Font.Bold = False
        With Sheets("DeepDive").Range("S33:AR33").Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 50 total
        Sheets("DeepDive").Range("S64:AR64").Font.Bold = False
        With Sheets("DeepDive").Range("S64:AR64").Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = 10092543
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 50 Others
        Sheets("DeepDive").Range("S63:AR63").Font.Bold = False
        With Sheets("DeepDive").Range("S63:AR63").Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 100 total BOLD
        Sheets("DeepDive").Range("S114:AR114").Font.Bold = True
        With Sheets("DeepDive").Range("S114:AR114").Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .ThemeColor = xlThemeColorDark1
            .TintAndShade = -0.249977111117893
            .PatternTintAndShade = 0
        End With
        'Format for Top 100 Others BOLD
        Sheets("DeepDive").Range("S113:AR113").Font.Bold = True
        With Sheets("DeepDive").Range("S113:AR113").Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        
        If Sheets("DeepDive").Range("Q1").Value <> 1 Then
            answer = MsgBox("Generating a table with Top 100 " & FieldSel & " details may hereon cause every clicks on the table to run longer." & vbNewLine & vbNewLine & "Do you still wish to continue?", vbQuestion + vbYesNo, "Long processing time")
            If answer = vbYes Then
                GoTo Continue
            ElseIf answer = vbNo Then Sheets("DeepDive").Range("S12").Value = TopSel
            Exit Sub
            End If
        End If
          
    ElseIf TopNo = "Top 200" Then
        TabTot = 200
        TabLast = 214
        'Format for Top 20 total
        Sheets("DeepDive").Range("S34:AR34").Font.Bold = False
        With Sheets("DeepDive").Range("S34:AR34").Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = 10092543
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 20 Others
        Sheets("DeepDive").Range("S33:AR33").Font.Bold = False
        With Sheets("DeepDive").Range("S33:AR33").Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 50 total
        Sheets("DeepDive").Range("S64:AR64").Font.Bold = False
        With Sheets("DeepDive").Range("S64:AR64").Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = 10092543
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 50 Others
        Sheets("DeepDive").Range("S63:AR63").Font.Bold = False
        With Sheets("DeepDive").Range("S63:AR63").Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 100 total
        Sheets("DeepDive").Range("S114:AR114").Font.Bold = False
        With Sheets("DeepDive").Range("S114:AR114").Interior
            .Pattern = xlSolid
            .PatternColorIndex = xlAutomatic
            .Color = 10092543
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        'Format for Top 100 Others
        Sheets("DeepDive").Range("S113:AR113").Font.Bold = False
        With Sheets("DeepDive").Range("S113:AR113").Interior
            .Pattern = xlNone
            .TintAndShade = 0
            .PatternTintAndShade = 0
        End With
        
        If Sheets("DeepDive").Range("Q1").Value <> 2 Then
            answer = MsgBox("Generating a table with Top 200 " & FieldSel & " details may hereon cause every clicks on the table to run longer." & vbNewLine & vbNewLine & "Do you still wish to continue?", vbQuestion + vbYesNo, "Long processing time")
            If answer = vbYes Then
                GoTo Continue
            ElseIf answer = vbNo Then Sheets("DeepDive").Range("S12").Value = TopSel
            Exit Sub
            End If
        End If
    End If
    
    
Continue:

    ReDim str_nm(TabTot + 1) 'NEW for top 200
    ReDim str_nm_o(TabTot + 1) 'NEW for top 200
    ReDim str_nm_d(TabTot + 1) 'NEW for top 200
   
   Sheets("DeepDive").Range("S13:S214") = "" 'NEW for top 200
   Sheets("DeepDive").Range("Y12:AS214") = "" 'NEW for top 200
   Sheets("DeepDive").Range("T13:T214") = "" 'NEW for top 200
   Sheets("DeepDive").Range("Q13:R214") = "" 'NEW for top 200
    
    'Create Row number dynamically
    Dim a, myRange() As Integer         'NEW for top 200
    ReDim myRange(1 To TabTot + 12)     'NEW for top 200
     For a = 1 To TabTot:               'NEW for top 200
        myRange(a) = a                  'NEW for top 200
    Next a                              'NEW for top 200
    
    'Use Transpose to shift the 1d array into a column
    Worksheets("DeepDive").Range("S13:S" & UBound(myRange)).Value = _
    Application.WorksheetFunction.Transpose(myRange)
    
  strr = "R"
  strc = "C"
  
    'define product field
  
   
   'define filter
  
  If Sheets("Setup").Range("I8").Value = "" Then
  strcrit = 0.955
  Else
  strcrit = Sheets("Setup").Range("I8").Value
  End If
   
   
'define measure field
   strrepfilter = ""
   str_product_filter = ""
   str_date = ""
   str_orig_field = ""
   str_dest_field = ""
   'str_direction = ""
   str_filter = ""
   strdimension = ""
   strproduct = ""
   
   
   strproduct = "[" & Application.WorksheetFunction.VLookup(Sheets("DeepDive").Range("R7").Value, Sheets("LOV").Range("Y:Z"), 2, 0) & "]"
   
   If Sheets("DeepDive").Range("B7").Value = "Origin Region" Then
   str_orig_field = "[Origin Region Name]"
   Else
   str_orig_field = "[Origin Country/Territory Name]"
   End If
   If Sheets("DeepDive").Range("K7").Value = "Destination Region" Then
   str_dest_field = "[Destination Region Name]"
   Else
   str_dest_field = "[Destination Country/Territory Name]"
   End If
   
   If Sheets("DeepDive").Range("T12").Value = "Lane" Then
    strdimension = str_orig_field & "," & str_dest_field
    ActiveWorkbook.Names("DDTopNumber").RefersToR1C1 = "=OFFSET(LOV!R1C30,1,0,COUNTA(LOV!C30)-1,1)"
    '=OFFSET(LOV!$Y$1,1,0,COUNTA(LOV!$Y:$Y)-1,1)
    Else
   If Sheets("DeepDive").Range("T12").Value = "Origin" Then
   strdimension = str_orig_field & "," & str_orig_field
    ActiveWorkbook.Names("DDTopNumber").RefersToR1C1 = "=OFFSET(LOV!R1C30,1,0,COUNTA(LOV!C30)-1,1)"
    Else
   If Sheets("DeepDive").Range("T12").Value = "Destination" Then
    strdimension = str_dest_field & "," & str_dest_field
    ActiveWorkbook.Names("DDTopNumber").RefersToR1C1 = "=OFFSET(LOV!R1C30,1,0,COUNTA(LOV!C30)-1,1)"
   Else
   If Sheets("DeepDive").Range("T12").Value = "Services" Then
   strdimension = strproduct & "," & strproduct
    ActiveWorkbook.Names("DDTopNumber").RefersToR1C1 = "=OFFSET(LOV!R1C30,1,0,2,1)"
    Else
   'If Sheets("DeepDive").Range("T12").Value = "Product" Then
   'strdimension = strproduct & "," & strproduct
   ' ActiveWorkbook.Names("DDTopNumber").RefersToR1C1 = "=OFFSET(LOV!R1C30,1,0,2,1)"
   ' Else
   If Sheets("DeepDive").Range("T12").Value = "Weight Type" Then
   strdimension = "[Shipment Weight Type],[Shipment Weight Type]"
    ActiveWorkbook.Names("DDTopNumber").RefersToR1C1 = "=OFFSET(LOV!R1C30,1,0,1,1)"
    
   Else
   If Sheets("DeepDive").Range("T12").Value = "Service Area" Then
   strdimension = "[Origin Service Area Name] & '(' & [Origin Service Area Code] & ')' , [Destination Service Area Name] & '(' & [Destination Service Area Code] & ')'"
    ActiveWorkbook.Names("DDTopNumber").RefersToR1C1 = "=OFFSET(LOV!R1C30,1,0,COUNTA(LOV!C30)-1,1)"
    Else
   If Sheets("DeepDive").Range("T12").Value = "Program" Then
   strdimension = "[OPMC Program],[OPMC Program]"
    ActiveWorkbook.Names("DDTopNumber").RefersToR1C1 = "=OFFSET(LOV!R1C30,1,0,3,1)"
    Else
   If Sheets("DeepDive").Range("T12").Value = "Account" Then
   strdimension = "[Billing Account Number],[Billing Account Name]"
    ActiveWorkbook.Names("DDTopNumber").RefersToR1C1 = "=OFFSET(LOV!R1C30,1,0,COUNTA(LOV!C30)-1,1)"
    Else
   If Sheets("DeepDive").Range("T12").Value = "Customer Controllable" Then
   strdimension = "[Reporting Code],[Reporting Code Description]"
   strrepfilter = " AND [Customer Controllable Delay Flag] > 0 "
    ActiveWorkbook.Names("DDTopNumber").RefersToR1C1 = "=OFFSET(LOV!R1C30,1,0,2,1)"
    Else
   If Sheets("DeepDive").Range("T12").Value = "DHL Controllable" Then
   strdimension = "[Reporting Code],[Reporting Code Description]"
   strrepfilter = " AND [DHL Controllable Delay Flag] > 0 "
    ActiveWorkbook.Names("DDTopNumber").RefersToR1C1 = "=OFFSET(LOV!R1C30,1,0,2,1)"
   Else
   If Sheets("DeepDive").Range("T12").Value = "DHL Uncontrollable" Then
   strdimension = "[Reporting Code],[Reporting Code Description]"
   strrepfilter = " AND [DHL Uncontrollable Delay Flag] > 0 "
    ActiveWorkbook.Names("DDTopNumber").RefersToR1C1 = "=OFFSET(LOV!R1C30,1,0,2,1)"
   End If
   End If
   End If
   End If
   End If
   End If
   End If
   End If
   End If
   End If
   End If
   
        
   If Sheets("DeepDive").Range("T7").Value <> "ALL" Then
   str_product_filter = " AND " & strproduct & " = '" & Sheets("DeepDive").Range("T7").Value & "' "
   Else
   str_product_filter = " AND " & strproduct & " <> '' "
   End If
   
   If Sheets("DeepDive").Range("V7").Value = "Week" Then
   str_date = " AND [Startclock Year] = " & Left(Sheets("DeepDive").Range("Y7").Value, 4) & " AND [Startclock Week] = " & Trim(Right(Sheets("DeepDive").Range("Y7").Value, 2)) & " "
   Else
   If Sheets("DeepDive").Range("V7").Value = "Year" Then
   str_date = " AND [Startclock Year] = " & Sheets("DeepDive").Range("Y7").Value & " "
   Else
   If Sheets("DeepDive").Range("V7").Value = "Month" Then
   str_date = " AND [Startclock Year] = " & Left(Application.WorksheetFunction.VLookup(Sheets("DeepDive").Range("Y7").Value, Sheets("LOV").Range("M:O"), 2, 0), 4) & " "
   str_date = str_date & " AND [Startclock Month] = '" & Application.WorksheetFunction.VLookup(Sheets("DeepDive").Range("Y7").Value, Sheets("LOV").Range("M:O"), 3, 0) & "' "
   Else
   If Sheets("DeepDive").Range("V7").Value = "Last 3 Months" Then
   str_date = " AND (([Startclock Year] = " & Left(Sheets("LOV").Cells(2, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(2, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(3, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(3, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(4, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(4, 15).Value & "'))  "
   Else
   If Sheets("DeepDive").Range("V7").Value = "Last 6 Months" Then
   str_date = " AND (([Startclock Year] = " & Left(Sheets("LOV").Cells(2, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(2, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(3, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(3, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(4, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(4, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(5, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(5, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(6, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(6, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(7, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(7, 15).Value & "'))  "
   End If
   End If
   End If
   End If
   End If
   
   If Sheets("DeepDive").Range("F7").Value <> "ALL" And Sheets("DeepDive").Range("O7").Value <> "ALL" Then
   str_direction = "(" & str_orig_field & " = '" & Sheets("DeepDive").Range("F7").Value & "' " & Sheets("DeepDive").Range("I7").Value & " " & str_dest_field & " = '" & Sheets("DeepDive").Range("O7").Value & "') "
   
   Else
   If Sheets("DeepDive").Range("F7").Value <> "ALL" And Sheets("DeepDive").Range("O7").Value = "ALL" Then
   str_direction = str_orig_field & " = '" & Sheets("DeepDive").Range("F7").Value & "' "
   Else
   If Sheets("DeepDive").Range("F7").Value = "ALL" And Sheets("DeepDive").Range("O7").Value <> "ALL" Then
    str_direction = str_dest_field & " = '" & Sheets("DeepDive").Range("O7").Value & "' "
   Else
   str_direction = str_orig_field & " <> '' AND " & str_dest_field & " <> '' "
   End If
   End If
   End If
  
  
  'dynamic measures
  strmeasurecnt = Application.WorksheetFunction.CountA(Sheets("LOV").Range("F:F"))
  ReDim str_val(TabTot + 1, strmeasurecnt) 'NEW for top 200
  ReDim str_measure(1, strmeasurecnt)
  
  '!!! Populating columns header
  Sheets("DeepDive").Cells(12, 25) = Sheets("LOV").Cells(2, 6).Value
  Sheets("DeepDive").Cells(12, 26) = Sheets("LOV").Cells(3, 6).Value
 ' Sheets("DeepDive").Cells(12, 26) = Sheets("LOV").Cells(4, 6).Value
  
  For i = 3 To strmeasurecnt + 1
  If i < 5 Then
  Sheets("DeepDive").Cells(12, 25 + i) = Sheets("LOV").Cells(i + 1, 6).Value
  Else
  If i > 5 Then
  Sheets("DeepDive").Cells(12, 25 + i) = Sheets("LOV").Cells(i, 6).Value
  Else
  Sheets("DeepDive").Cells(12, 25 + i) = "Net Performance"
  End If
  End If
  
  Next
  
  For i = 2 To strmeasurecnt + 1
  If i - 1 < 5 Then
  str_measure(1, i - 1) = Sheets("LOV").Cells(i, 6).Value
  str_measure(0, i - 1) = Sheets("LOV").Cells(i, 10).Value
  Else
  If i - 1 > 5 Then
  str_measure(1, i - 1) = Sheets("LOV").Cells(i - 1, 6).Value
  str_measure(0, i - 1) = Sheets("LOV").Cells(i - 1, 10).Value
  Else
  str_measure(1, i - 1) = "Net Performance"
  str_measure(0, i - 1) = "p"
  End If
  End If
  
  If i = 2 Then
  strmeasure = Sheets("LOV").Cells(i, 8).Value
  Else
  If i < 6 Then
  strmeasure = strmeasure & "," & Sheets("LOV").Cells(i, 8).Value
  Else
  If i > 6 And Sheets("LOV").Cells(i - 1, 6).Value <> "" Then
  strmeasure = strmeasure & "," & Sheets("LOV").Cells(i - 1, 8).Value
  Else
  strmeasure = strmeasure & ",Sum([On Time Volume]+[DHL Uncontrollable Delay Flag]+[Customer Controllable Delay Flag])"
  End If
  End If
  End If
  Next
      
      'Find if data have billing invoice number and not allow table to sort by billed invoice amount
        With Sheets("Raw_Data").Range("1:1")
        Set rFind = .Find(What:="Billing Net Invoiced Amount", LookAt:=xlWhole, MatchCase:=False, SearchFormat:=False)
        If rFind Is Nothing And Sheets("DeepDive").Range("O1").Value = "Billing Net Invoiced Amount" Then
            Sheets("DeepDive").Range("O1").Value = "Net Monitored Volume"
        End If
        End With
  
    'define current period
    
    If Sheets("DeepDive").Range("O1").Value = "Net Performance" Then
    strmainval = "Sum([Net Monitored Volume])"
    Else
    strmainval = "Sum([" & Sheets("DeepDive").Range("O1").Value & "])"
    End If
   
    strorderval = strmainval
    ' If Sheets("DeepDive").Range("O1").Value = "Pickup Before Cutoff Flag" Then strorderval = "Iif(Sum([Net Monitored Volume])=0,0," & strmainval & "/Sum([Net Monitored Volume]))"
    ' If Sheets("DeepDive").Range("O1").Value = "Ghost Flag" Then strorderval = "Iif(Sum([Net Monitored Volume])=0,0," & strmainval & "/Sum([Net Monitored Volume]))"
    ' If Sheets("DeepDive").Range("O1").Value = "DHL Uncontrollable Delay Flag" Then strorderval = "Iif(Sum([Net Monitored Volume])=0,0," & strmainval & "/Sum([Net Monitored Volume]))"
    ' If Sheets("DeepDive").Range("O1").Value = "DHL Controllable Delay Flag" Then strorderval = "Iif(Sum([Net Monitored Volume])=0,0," & strmainval & "/Sum([Net Monitored Volume]))"
    ' If Sheets("DeepDive").Range("O1").Value = "Customer Controllable Delay Flag" Then strorderval = "Iif(Sum([Net Monitored Volume])=0,0," & strmainval & "/Sum([Net Monitored Volume]))"
    ' If Sheets("DeepDive").Range("O1").Value = "Has ST ODD Flag" Then strorderval = "Iif(Sum([Net Monitored Volume])=0,0," & strmainval & "/Sum([Net Monitored Volume]))"
    ' If Sheets("DeepDive").Range("O1").Value = "Attempted Delivery Count" Then strorderval = "Iif(Sum([Net Monitored Volume])=0,0," & strmainval & "/Sum([Net Monitored Volume]))"
    ' If Sheets("DeepDive").Range("O1").Value = "Has BA Flag" Then strorderval = "Iif(Sum([Net Monitored Volume])=0,0," & strmainval & "/Sum([Net Monitored Volume]))"
    ' If Sheets("DeepDive").Range("O1").Value = "Has BN Flag" Then strorderval = "Iif(Sum([Net Monitored Volume])=0,0," & strmainval & "/Sum([Net Monitored Volume]))"
    ' If Sheets("DeepDive").Range("O1").Value = "Has HP Flag" Then strorderval = "Iif(Sum([Net Monitored Volume])=0,0," & strmainval & "/Sum([Net Monitored Volume]))"
    ' If Sheets("DeepDive").Range("O1").Value = "eCom Flag" Then strorderval = "Iif(Sum([Net Monitored Volume])=0,0," & strmainval & "/Sum([Net Monitored Volume]+[Ghost Flag]))"
    If Sheets("DeepDive").Range("O1").Value = "Net Performance" Then strorderval = "Sum([Net Monitored Volume])"  'This code like no longer valid.
        
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
    
       
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    

    SQL = ""
    SQL = SQL & " SELECT " & strdimension & ", " & strmeasure
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_direction & " " & str_product_filter & " " & str_date & strrepfilter & " GROUP BY " & strdimension & " order by " & strorderval & " DESC "
   


    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
    ' Debug.Print SQL
    '   oRS.Open
    '  strcount = oRS.RecordCount
    '   oRS.Close
    
    i = 1
    j = 2
    
    On Error Resume Next
    oRS.Open
    intloop = 0
    
    'Refresh all array
    For i = 0 To 7
    str_nm(i) = ""
    For ii = 0 To strmeasurecnt
    str_val(i, ii) = 0
    Next
    Next
    intloop = 0
    Do Until oRS.EOF
    If oRS.EOF Then Exit Sub
        
        intloop = intloop + 1
        If intloop < TabTot + 1 Then 'NEW for top 200
    

    
    If Sheets("DeepDive").Range("T12").Value = "Lane" Or Sheets("DeepDive").Range("T12").Value = "Service Area" Or Sheets("DeepDive").Range("T12").Value = "Account" Or Sheets("DeepDive").Range("T12").Value = "Customer Controllable" Or Sheets("DeepDive").Range("T12").Value = "DHL Controllable" Or Sheets("DeepDive").Range("T12").Value = "DHL Uncontrollable" Then
        str_nm(intloop) = oRS(0).Value & " - " & oRS(1).Value
    Else
    str_nm(intloop) = oRS(0).Value
        
    End If
    
    
    If Sheets("DeepDive").Range("T12").Value = "Service Area" Then
        str_nm_o(intloop) = Left(oRS(0).Value, Len(oRS(0).Value) - 5)
        str_nm_d(intloop) = Left(oRS(1).Value, Len(oRS(1).Value) - 5)
    Else
        str_nm_o(intloop) = oRS(0).Value
        str_nm_d(intloop) = oRS(1).Value
    End If
    
    
   For ii = 1 To strmeasurecnt
    str_val(intloop, ii) = oRS(1 + ii).Value
   Next
   
   End If
    
    If intloop > TabTot Then 'NEW for top 200
   
    str_nm(TabTot + 1) = "Other" 'NEW for top 200
    For ii = 1 To strmeasurecnt
    str_val(TabTot + 1, ii) = str_val(TabTot + 1, ii) + oRS(1 + ii).Value 'NEW for top 200
    TabOther = 1
    Next
    End If
   
    str_nm(0) = "Total"
    For ii = 1 To strmeasurecnt
    str_val(0, ii) = str_val(0, ii) + oRS(1 + ii).Value
    Next
    oRS.MoveNext
    Loop
    oCn.Close
   
         
   Set oRS = Nothing
   Set oCn = Nothing
   

   
   'populate table cell values
  On Error Resume Next
   For i = 1 To TabTot + 1 'NEW for top 200
   Sheets("DeepDive").Cells(12 + i, 20) = str_nm(i)
   
   Sheets("DeepDive").Cells(12 + i, 17) = str_nm_o(i)
   Sheets("DeepDive").Cells(12 + i, 18) = str_nm_d(i)
   Sheets("DeepDive").Cells(12 + i, 25) = str_val(i, 1)
   Sheets("DeepDive").Cells(12 + i, 26) = str_val(i, 2)
   
   For ii = 3 To strmeasurecnt
   Sheets("DeepDive").Cells(12 + i, 25 + ii) = str_val(i, ii)
   
   If str_measure(0, ii) = "i" Then
    Sheets("DeepDive").Cells(12 + i, 25 + ii).Style = "Comma"
    Sheets("DeepDive").Cells(12 + i, 25 + ii).NumberFormat = "_(* #,##0_);_(* (#,##0);_(* ""-""??_);_(@_)"
    
   If str_val(i, ii) <> "" Then Sheets("DeepDive").Cells(12 + i, 25 + ii) = "=" & str_val(i, ii)
   Else
    Sheets("DeepDive").Cells(12 + i, 25 + ii).Style = "Percent"
    Sheets("DeepDive").Cells(12 + i, 25 + ii).NumberFormat = "0.0%"
   If str_measure(1, ii) = "e-Shipping Solution" Or str_measure(1, ii) = "Ghost Shipments" Then
   If str_val(i, ii) <> "" Then Sheets("DeepDive").Cells(12 + i, 25 + ii) = "=IFERROR(" & str_val(i, ii) & "/" & Sheets("DeepDive").Cells(12 + i, 25).Value + str_val(i, ii) & ",0)"
   Else
   If str_val(i, ii) <> "" Then Sheets("DeepDive").Cells(12 + i, 25 + ii) = "=IFERROR(" & str_val(i, ii) & "/" & Sheets("DeepDive").Cells(12 + i, 25).Value & ",0)"
   End If
   End If
   If str_nm(i) = "" Then
   Sheets("DeepDive").Rows(12 + i).EntireRow.Hidden = True
   Else
   Sheets("DeepDive").Rows(12 + i).EntireRow.Hidden = False
   End If
   Next
   Next
   
   Sheets("DeepDive").Rows(TabLast + TabOther + 1 & ":215").EntireRow.Hidden = True 'Hide all the rows after Total
   
   
   Sheets("DeepDive").Cells(TabLast, 20) = str_nm(0) 'NEW for top 200
   Sheets("DeepDive").Cells(TabLast, 25) = str_val(0, 1) 'NEW for top 200
   Sheets("DeepDive").Cells(TabLast, 26) = str_val(0, 2) 'NEW for top 200
   For ii = 3 To strmeasurecnt
   Sheets("DeepDive").Cells(TabLast, 25 + ii) = str_val(0, ii) 'NEW for top 200
      
   If str_measure(0, ii) = "i" Then
   Sheets("DeepDive").Cells(TabLast, 25 + ii).Style = "Comma" 'NEW for top 200
   Sheets("DeepDive").Cells(TabLast, 25 + ii).NumberFormat = "_(* #,##0_);_(* (#,##0);_(* ""-""??_);_(@_)" 'NEW for top 200
   If str_val(TabLast, ii) <> "" Then Sheets("DeepDive").Cells(TabLast, 25 + ii) = "=" & str_val(0, ii) 'NEW for top 200
   Else
   Sheets("DeepDive").Cells(TabLast, 25 + ii).Style = "Percent" 'NEW for top 200
   Sheets("DeepDive").Cells(TabLast, 25 + ii).NumberFormat = "0.0%" 'NEW for top 200
   If str_measure(0, ii) = "e-Shipping Solution" Or str_measure(1, ii) = "Ghost Shipments" Then
   If str_val(TabLast, ii) <> "" Then Sheets("DeepDive").Cells(TabLast, 25 + ii) = "=IFERROR(" & str_val(0, ii) & "/" & Sheets("DeepDive").Cells(TabLast, 25).Value + str_val(0, ii) & ",0)" 'NEW for top 200
   Else
   If str_val(TabLast, ii) <> "" Then Sheets("DeepDive").Cells(TabLast, 25 + ii) = "=IFERROR(" & str_val(0, ii) & "/" & Sheets("DeepDive").Cells(TabLast, 25).Value & ",0)" 'NEW for top 200
   End If
   End If
  Next
   
    If TopNo = "Top 20" Or TopNo = "Top 50" Then
        Sheets("DeepDive").Range("Q1").Value = 0
    ElseIf TopNo = "Top 100" Then
        Sheets("DeepDive").Range("Q1").Value = 1
    ElseIf TopNo = "Top 200" Then
        Sheets("DeepDive").Range("Q1").Value = 2
    End If
    
    Sheets("DeepDive").Range("A9").Select

Application.UseSystemSeparators = True

Application.ScreenUpdating = True
Application.Calculation = xlCalculationAutomatic
    

End Sub

Attribute VB_Name = "List_of_Values"
Sub lov()

    Dim j As Integer
    Dim i As Integer
    Dim k As Integer
    Dim l As Integer
    
    Dim oCn As ADODB.Connection
    Dim oRS As ADODB.Recordset
    Dim ConnString As String
    Dim SQL As String
    Dim intloop
    Dim intloop2
    Dim strcount
    Dim strrow
    Dim strcol
    Dim SvcNmflag

    ReDim str_period(5)

   
   Dim strmainval
   
   Dim strcp1
   Dim strpp1
   
    Application.ScreenUpdating = False
  
    
     'If Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("A:A")) > 1 Then
    If Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("A:A")) > 1 And (Sheets("Raw_Data").Range("A2").Value = "Waybill Number" Or Sheets("Raw_Data").Range("A2").Value = "Startclock Day of Week" Or Sheets("Raw_Data").Range("A2").Value = "Product Line" Or Sheets("Raw_Data").Range("A2").Value = "Service Line") Then
    Sheets("Raw_Data").Rows("1:1").Delete
    End If
  
    Sheets("Raw_Data").Rows("1:1").Replace What:="Product", Replacement:="Service", LookAt:=xlPart _
        , SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, _
        ReplaceFormat:=False
        
    Sheets("Raw_Data").Rows("1:1").Replace What:=" Country ", Replacement:=" Country/Territory ", LookAt:=xlPart _
        , SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, _
        ReplaceFormat:=False
    
    Sheets("Raw_Data").Rows("1:1").Replace What:="Elapsed ", Replacement:="", LookAt:=xlPart _
        , SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, _
        ReplaceFormat:=False
  

    Sheets("Raw_Data").Rows("1:1").RowHeight = 107
  
  
    With Sheets("Raw_Data").Rows("1:1").Interior
        .Pattern = xlSolid
        .PatternColorIndex = xlAutomatic
        .ThemeColor = xlThemeColorDark1
        .TintAndShade = -0.149998474074526
        .PatternTintAndShade = 0
    End With
    Sheets("Raw_Data").Rows("1:1").AutoFilter


'lookup service name
    With Sheets("Raw_Data").Range("1:1")
        Set rFind = .Find(What:="Service Name", LookAt:=xlWhole, MatchCase:=False, SearchFormat:=False)
        If Not rFind Is Nothing Then
            SvcNmflag = 1
            ActiveWorkbook.Names("ServiceType").RefersToR1C1 = "=OFFSET(LOV!R1C25,1,0,COUNTA(LOV!C25)-1,1)"
        Else
            SvcNmflag = 0
            ActiveWorkbook.Names("ServiceType").RefersToR1C1 = "=OFFSET(LOV!R1C25,1,0,COUNTA(LOV!C25)-2,1)"
        End If
    End With

  'measures - clean up irrelevant ones
    If Sheets("LOV").Cells(2, 37) > 0 Then
    i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(2, 33), Sheets("LOV").Range("AC:AC"), 0)
    Sheets("LOV").Cells(i, 29).Delete Shift:=xlUp
    End If
    
    If Sheets("LOV").Cells(3, 37) > 0 Then
    i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(3, 33), Sheets("LOV").Range("AC:AC"), 0)
    Sheets("LOV").Cells(i, 29).Delete Shift:=xlUp
    End If
    
    If Sheets("LOV").Cells(4, 37) > 0 Then
    i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(4, 33), Sheets("LOV").Range("AC:AC"), 0)
    Sheets("LOV").Cells(i, 29).Delete Shift:=xlUp
    End If
    
    If Sheets("LOV").Cells(5, 37) > 0 Then
    i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(5, 33), Sheets("LOV").Range("AC:AC"), 0)
    Sheets("LOV").Cells(i, 29).Delete Shift:=xlUp
    End If
    
    If Sheets("LOV").Cells(6, 37) > 0 Then
    i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(6, 33), Sheets("LOV").Range("AC:AC"), 0)
    Sheets("LOV").Cells(i, 29).Delete Shift:=xlUp
    End If
 'If Sheets("LOV").Cells(7, 37) > 0 Then
 'i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(7, 33), Sheets("LOV").Range("AA:AA"), 0)
 'Sheets("LOV").Cells(i, 27).Delete Shift:=xlUp
 'End If
    
    If Sheets("LOV").Cells(8, 37) > 0 Then
    i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(8, 33), Sheets("LOV").Range("R:R"), 0)
    Sheets("LOV").Cells(i, 18).Delete Shift:=xlUp
    End If
    
    If Sheets("LOV").Cells(9, 37) > 0 Then
    i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(9, 33), Sheets("LOV").Range("R:R"), 0)
    Sheets("LOV").Cells(i, 18).Delete Shift:=xlUp
    End If

    If Sheets("LOV").Cells(10, 37) > 0 Then
    i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(10, 33), Sheets("LOV").Range("R:R"), 0)
    Sheets("LOV").Cells(i, 18).Delete Shift:=xlUp
    End If

    If Sheets("LOV").Cells(11, 37) > 0 Then
    i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(11, 33), Sheets("LOV").Range("R:R"), 0)
    Sheets("LOV").Cells(i, 18).Delete Shift:=xlUp
    End If

    If Sheets("LOV").Cells(12, 37) > 0 Then
    i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(12, 33), Sheets("LOV").Range("R:R"), 0)
    Sheets("LOV").Cells(i, 18).Delete Shift:=xlUp
    End If

    If Sheets("LOV").Cells(13, 37) > 0 Then
    i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(13, 33), Sheets("LOV").Range("R:R"), 0)
    Sheets("LOV").Cells(i, 18).Delete Shift:=xlUp
    End If
 
    If Sheets("LOV").Cells(14, 37) > 0 Then
    i = Application.WorksheetFunction.Match(Sheets("LOV").Cells(14, 33), Sheets("LOV").Range("R:R"), 0)
    Sheets("LOV").Cells(i, 18).Delete Shift:=xlUp
    End If
  
  
   Sheets("LOV").Range("A3:E1000") = "" 'Country/Region
   Sheets("LOV").Range("K2:Q1000") = "" 'Calendar/Dates
   Sheets("LOV").Range("S3:S1000") = "" 'Service Line
   Sheets("LOV").Range("T3:T1000") = "" 'Period
   Sheets("LOV").Range("AA2:AA1000") = "" 'Breakdown
   Sheets("LOV").Range("AE3:AE1000") = "" 'Product name
   Sheets("LOV").Activate
    
    
    strr = "R"
    strc = "C"
  
    'count all rows
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
'define product group
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    'Define query fo product group
    SQL = ""
    SQL = SQL & " SELECT distinct [Service Group]"
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE [Service Group]<> '' AND [Service Group]<> 'UNKNOWN' ORDER BY [Service Group] ASC "
   
    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
    i = 3   'Starting Row in LOV
    j = 1   'LOV Column number
    
    '   On Error Resume Next
    oRS.Open
    intloop = 0
    
    Do Until oRS.EOF
    'strmainval = oRS(5).Value
    '2016-06-16 code change to replace SSA and APEC
    '      If oRS(0).Value = "SB" Then
    '          region_code = "SSA"
    '      ElseIf oRS(0).Value = "AC" Then
    '          region_code = "APEC"
    '      Else
    '          region_code = oRS(0).Value
    '      End If
        
    Sheets("LOV").Cells(i, j) = oRS(0).Value
     
    i = i + 1
    intloop = intloop + 1 '??not sure why need interloop
        oRS.MoveNext
        Loop

    oCn.Close
    Set oRS = Nothing
    Set oCn = Nothing

'define product lines
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open
    
    'Define query fo product Line
    SQL = ""
    SQL = SQL & " SELECT distinct [Service Line Description]"
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE [Service Line Description]<> '' AND [Service Line Description]<> 'UNKNOWN' ORDER BY [Service Line Description] ASC "
   
    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic

    i = 3    'Starting Row in LOV
    j = 19   'LOV Column number
    
    '   On Error Resume Next
    oRS.Open
    intloop = 0
    
    Do Until oRS.EOF
    'strmainval = oRS(5).Value
    '2016-06-16 code change to replace SSA and APEC
    '      If oRS(0).Value = "SB" Then
    '          region_code = "SSA"
    '      ElseIf oRS(0).Value = "AC" Then
    '          region_code = "APEC"
    '      Else
    '          region_code = oRS(0).Value
    '      End If
        
    Sheets("LOV").Cells(i, j) = oRS(0).Value
     
    i = i + 1
    intloop = intloop + 1
        oRS.MoveNext
        Loop
    
    oCn.Close

    Set oRS = Nothing
    Set oCn = Nothing

'define product names
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

If SvcNmflag = 0 Then
    GoTo NoSvcName
    End If
    
    'Define query fo product Line
    SQL = ""
    SQL = SQL & " SELECT distinct [Service Name]"
    SQL = SQL & " FROM [Raw_Data$"
    SQL = SQL & "] WHERE [Service Name]<> '' AND [Service Name]<> 'UNKNOWN' ORDER BY [Service Name] ASC "
   
    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic

    i = 3    'Starting Row in LOV
    j = 31   'LOV Column number
    
    '   On Error Resume Next
    oRS.Open
    intloop = 0
    
    Do Until oRS.EOF
    'strmainval = oRS(5).Value
    '2016-06-16 code change to replace SSA and APEC
    '      If oRS(0).Value = "SB" Then
    '          region_code = "SSA"
    '      ElseIf oRS(0).Value = "AC" Then
    '          region_code = "APEC"
    '      Else
    '          region_code = oRS(0).Value
    '      End If
        
    Sheets("LOV").Cells(i, j) = oRS(0).Value
     
    i = i + 1
    intloop = intloop + 1
        oRS.MoveNext
        Loop
    
    oCn.Close

    Set oRS = Nothing
    Set oCn = Nothing


NoSvcName:

'define countries
   ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    SQL = ""
    SQL = SQL & " SELECT distinct [Origin Country/Territory Code] as ctry_code,[Origin Country/Territory Name] as ctry_name"
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE [Origin Country/Territory Code]<> '' AND [Origin Country/Territory Code]<> 'UNKNOWN' "
    SQL = SQL & " UNION SELECT distinct [Destination Country/Territory Code] as ctry_code,[Destination Country/Territory Name] as ctry_name"
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE [Destination Country/Territory Code]<> '' AND [Destination Country/Territory Code]<> 'UNKNOWN' ORDER BY ctry_name ASC "
   

    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 3
    j = 2
    
'    On Error Resume Next
    oRS.Open
    intloop = 0
    
    
    Do Until oRS.EOF
 ' strmainval = oRS(5).Value
        '2016-06-16 code change to replace SSA and APEC
  '      If oRS(0).Value = "SB" Then
  '          region_code = "SSA"
  '      ElseIf oRS(0).Value = "AC" Then
  '          region_code = "APEC"
  '      Else
  '          region_code = oRS(0).Value
  '      End If
        
        Sheets("LOV").Cells(i, j) = oRS(1).Value
        Sheets("LOV").Cells(i, j + 1) = oRS(0).Value
     
          
      i = i + 1
      intloop = intloop + 1
        oRS.MoveNext
        Loop

    oCn.Close
   
         
   Set oRS = Nothing
   Set oCn = Nothing


'define regions

   ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    SQL = ""
    SQL = SQL & " SELECT distinct [Origin Region Code] as ctry_code,[Origin Region Name] as ctry_name"
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE [Origin Region Code]<> '' AND [Origin Region Code]<> 'UNKNOWN' "
    SQL = SQL & " UNION SELECT distinct [Destination Region Code] as ctry_code,[Destination Region Name] as ctry_name"
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE [Destination Region Code]<> '' AND [Destination Region Code]<> 'UNKNOWN' ORDER BY ctry_name ASC "
   


    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 3
    j = 4
    
'    On Error Resume Next
    oRS.Open
    intloop = 0
    
   
   
    
    Do Until oRS.EOF
 ' strmainval = oRS(5).Value
        '2016-06-16 code change to replace SSA and APEC
  '      If oRS(0).Value = "SB" Then
  '          region_code = "SSA"
  '      ElseIf oRS(0).Value = "AC" Then
  '          region_code = "APEC"
  '      Else
  '          region_code = oRS(0).Value
  '      End If
        
        Sheets("LOV").Cells(i, j) = oRS(1).Value
        Sheets("LOV").Cells(i, j + 1) = oRS(0).Value
     
          
      i = i + 1
      intloop = intloop + 1
        oRS.MoveNext
        Loop

    oCn.Close
   
   
   
         
   Set oRS = Nothing
   Set oCn = Nothing



'define period - weekly
 
          
        
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
   
       
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    SQL = ""
    SQL = SQL & " SELECT distinct [Startclock Year]*100 + [Startclock Week], [Startclock Year] & ' Week ' & [Startclock Week]"
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] ORDER BY [Startclock Year]*100 + [Startclock Week] DESC "
   


    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
  ' Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 2
    j = 11
    
 '   On Error Resume Next
    oRS.Open
    intloop = 0
    
   
   
    
    Do Until oRS.EOF
  'strmainval = oRS(5).Value
        '2016-06-16 code change to replace SSA and APEC
  '      If oRS(0).Value = "SB" Then
  '          region_code = "SSA"
  '      ElseIf oRS(0).Value = "AC" Then
  '          region_code = "APEC"
  '      Else
  '          region_code = oRS(0).Value
  '      End If
        
        Sheets("LOV").Cells(i, j) = oRS(1).Value
        Sheets("LOV").Cells(i, j + 1) = oRS(0).Value
     
          
      i = i + 1
      intloop = intloop + 1
        oRS.MoveNext
        Loop

    oCn.Close
   
   
   
         
   Set oRS = Nothing
   Set oCn = Nothing

'define period - monthly

           
        
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
  
       
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    SQL = ""
    SQL = SQL & " SELECT distinct [Startclock Year]*100 + left([Startclock Month],2), [Startclock Month],[Startclock Year]"
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] ORDER BY [Startclock Year]*100 +  left([Startclock Month],2)  DESC "
   


    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
  ' Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 2
    j = 13
    
 '   On Error Resume Next
    oRS.Open
    intloop = 0
    
   
   
    
    Do Until oRS.EOF
  'strmainval = oRS(5).Value
        '2016-06-16 code change to replace SSA and APEC
  '      If oRS(0).Value = "SB" Then
  '          region_code = "SSA"
  '      ElseIf oRS(0).Value = "AC" Then
  '          region_code = "APEC"
  '      Else
  '          region_code = oRS(0).Value
  '      End If
        
        Sheets("LOV").Cells(i, j + 1) = oRS(0).Value
        
        If Right(oRS(0).Value, 2) = "01" Then Sheets("LOV").Cells(i, j) = "Jan '" & Right(oRS(2).Value, 2)
        If Right(oRS(0).Value, 2) = "02" Then Sheets("LOV").Cells(i, j) = "Feb '" & Right(oRS(2).Value, 2)
        If Right(oRS(0).Value, 2) = "03" Then Sheets("LOV").Cells(i, j) = "Mar '" & Right(oRS(2).Value, 2)
        If Right(oRS(0).Value, 2) = "04" Then Sheets("LOV").Cells(i, j) = "Apr '" & Right(oRS(2).Value, 2)
        If Right(oRS(0).Value, 2) = "05" Then Sheets("LOV").Cells(i, j) = "May '" & Right(oRS(2).Value, 2)
        If Right(oRS(0).Value, 2) = "06" Then Sheets("LOV").Cells(i, j) = "Jun '" & Right(oRS(2).Value, 2)
        If Right(oRS(0).Value, 2) = "07" Then Sheets("LOV").Cells(i, j) = "Jul '" & Right(oRS(2).Value, 2)
        If Right(oRS(0).Value, 2) = "08" Then Sheets("LOV").Cells(i, j) = "Aug '" & Right(oRS(2).Value, 2)
        If Right(oRS(0).Value, 2) = "09" Then Sheets("LOV").Cells(i, j) = "Sep '" & Right(oRS(2).Value, 2)
        If Right(oRS(0).Value, 2) = "10" Then Sheets("LOV").Cells(i, j) = "Oct '" & Right(oRS(2).Value, 2)
        If Right(oRS(0).Value, 2) = "11" Then Sheets("LOV").Cells(i, j) = "Nov '" & Right(oRS(2).Value, 2)
        If Right(oRS(0).Value, 2) = "12" Then Sheets("LOV").Cells(i, j) = "Dec '" & Right(oRS(2).Value, 2)
        
        Sheets("LOV").Cells(i, j + 2) = "'" & oRS(1).Value
          
      i = i + 1
      intloop = intloop + 1
        oRS.MoveNext
        Loop

    oCn.Close
    Set oRS = Nothing
    Set oCn = Nothing


'determine available periods
'On Error Resume Next
'str_period(1) = Sheets("LOV").Range("AM2").Value

If Sheets("LOV").Range("AM2").Value = False Then str_period(1) = "Year"
If Application.WorksheetFunction.CountA(Sheets("LOV").Range("L:L")) > 4 Then str_period(2) = "Month"
If Application.WorksheetFunction.CountA(Sheets("LOV").Range("L:L")) > 1 Then str_period(3) = "Week"
If Application.WorksheetFunction.CountA(Sheets("LOV").Range("N:N")) > 3 Then str_period(4) = "Last 3 Months"
If Application.WorksheetFunction.CountA(Sheets("LOV").Range("N:N")) > 6 Then str_period(5) = "Last 6 Months"
intloop = 0

For i = 1 To 5
If str_period(i) <> "" Then
Sheets("LOV").Cells(3 + intloop, 20) = str_period(i)
If str_period(i) = "Year" Then Sheets("LOV").Range("P2") = Left(Sheets("LOV").Range("N2"), 4)
intloop = intloop + 1
End If

Next

On Error Resume Next

For i = 1 To 3
str_period(i) = ""
Next

If Application.WorksheetFunction.CountA(Sheets("LOV").Range("M:M")) > 1 Then str_period(1) = "Monthly"
If Application.WorksheetFunction.CountA(Sheets("LOV").Range("K:K")) > 1 Then str_period(2) = "Weekly"
If Sheets("LOV").Range("AM3").Value = False Then
str_period(3) = "Daily"
i = Application.WorksheetFunction.Match("Startclock Date", Sheets("Raw_Data").Range("1:1"), 0)
Sheets("Raw_Data").Columns(i).NumberFormat = "yyyy-mm-dd"
End If

If Sheets("LOV").Range("AM4").Value = False Then
i = Application.WorksheetFunction.Match("Committed Delivery Date", Sheets("Raw_Data").Range("1:1"), 0)
Sheets("Raw_Data").Columns(i).NumberFormat = "yyyy-mm-dd"
End If


intloop = 0

For i = 1 To 3
If str_period(i) <> "" Then
Sheets("LOV").Cells(2 + intloop, 27) = str_period(i)
intloop = intloop + 1
End If

Next

'intloop = Application.WorksheetFunction.CountA(Sheets("LOV").Range("F:F"))

'For i = 1 To intloop
'Sheets("Setup").Cells(9 + i, 5) = Sheets("LOV").Cells(1 + i, 6)
'Next
  Application.Calculation = xlCalculationAutomatic


End Sub



Attribute VB_Name = "Navigation"
Sub Dashboard_nav()
If Sheets("Dashboard").Range("A1") = 0 Then
Sheets("Dashboard").Range("B1") = 0
Sheets("Dashboard").Range("C7") = Sheets("LOV").Range("T2").Value
If Sheets("LOV").Range("T2").Value = "Year" Then Sheets("Dashboard").Range("E7") = Sheets("LOV").Range("P2").Value
If Sheets("LOV").Range("T2").Value = "Month" Then Sheets("Dashboard").Range("E7") = Sheets("LOV").Range("M2").Value
If Sheets("LOV").Range("T2").Value = "Week" Then Sheets("Dashboard").Range("E7") = Sheets("LOV").Range("K2").Value
Sheets("Dashboard").Range("A1") = 1
'Sheets("Dashboard").Activate
Application.StatusBar = "Refreshing Dashboard information..."
Dashboard_data
Application.StatusBar = "Dashboard information has been updated!"

Sheets("Dashboard").Range("B1") = 1
Else
Application.StatusBar = ""

End If
Sheets("Dashboard").Activate
ActiveWindow.ScrollRow = 9 'scroll to top

End Sub
Sub Worldmap_nav()
If Sheets("WorldMap").Range("A1") = 0 Then
Sheets("WorldMap").Range("B1") = 0
Sheets("WorldMap").Range("C7") = "Outbound"
Sheets("WorldMap").Range("E7") = Sheets("LOV").Range("Y2").Value
Sheets("WorldMap").Range("G7") = "ALL"

Sheets("WorldMap").Range("I7") = Sheets("LOV").Range("T2").Value
If Sheets("LOV").Range("T2").Value = "Year" Then Sheets("WorldMap").Range("L7") = Sheets("LOV").Range("P2").Value
If Sheets("LOV").Range("T2").Value = "Month" Then Sheets("WorldMap").Range("L7") = Sheets("LOV").Range("M2").Value
If Sheets("LOV").Range("T2").Value = "Week" Then Sheets("WorldMap").Range("L7") = Sheets("LOV").Range("K2").Value

Sheets("WorldMap").Range("A1") = 1
Sheets("WorldMap").Range("B1") = 1

Application.StatusBar = "Refreshing WorldMap information..."
BuildMaps
Application.StatusBar = "WorldMap information has been updated!"

Else
Application.StatusBar = ""
End If
Sheets("WorldMap").Activate
Sheets("WorldMap").Range("A9").Select

End Sub

Sub TradeLanes_nav()
If Sheets("TradeLanes").Range("A1") = 0 Then
Sheets("TradeLanes").Range("B1") = 0

Sheets("TradeLanes").Range("AB2") = Sheets("LOV").Range("F2").Value
Sheets("TradeLanes").Range("G2") = "ALL"
Sheets("TradeLanes").Range("C2") = Sheets("LOV").Range("Y2").Value

Sheets("TradeLanes").Range("N2") = Sheets("LOV").Range("T2").Value
If Sheets("LOV").Range("T2").Value = "Year" Then Sheets("TradeLanes").Range("T2") = Sheets("LOV").Range("P2").Value
If Sheets("LOV").Range("T2").Value = "Month" Then Sheets("TradeLanes").Range("T2") = Sheets("LOV").Range("M2").Value
If Sheets("LOV").Range("T2").Value = "Week" Then Sheets("TradeLanes").Range("T2") = Sheets("LOV").Range("K2").Value


Sheets("TradeLanes").Range("AL2") = Sheets("LOV").Range("AB2").Value
Sheets("TradeLanes").Activate
Application.StatusBar = "Refreshing TradeLanes information..."
Tradelane_data
Application.StatusBar = "TradeLanes information has been updated!"
Sheets("TradeLanes").Range("A1") = 1
Sheets("TradeLanes").Range("B1") = 1
Else
Application.StatusBar = ""
End If
Sheets("TradeLanes").Activate

End Sub

Sub Breakdown_nav()
If Sheets("TrendAnalysis").Range("A1") = 0 Then
Sheets("TrendAnalysis").Range("B1") = 0

Sheets("TrendAnalysis").Range("Z7") = Sheets("LOV").Range("F2").Value
Sheets("TrendAnalysis").Range("V7") = Sheets("LOV").Range("AA2").Value
Sheets("TrendAnalysis").Range("T7") = "ALL"
Sheets("TrendAnalysis").Range("R7") = Sheets("LOV").Range("Y2").Value
Sheets("TrendAnalysis").Range("O7") = "ALL"
Sheets("TrendAnalysis").Range("F7") = "ALL"
Sheets("TrendAnalysis").Range("B7") = Sheets("LOV").Range("W2").Value
Sheets("TrendAnalysis").Range("K7") = Sheets("LOV").Range("X2").Value


'Sheets("TrendAnalysis").Activate
Application.StatusBar = "Refreshing TrendAnalysis information..."
create_breakdown
Application.StatusBar = "TrendAnalysis information has been updated!"
Sheets("TrendAnalysis").Range("B1") = 1
Sheets("TrendAnalysis").Range("A1") = 1
Else
Application.StatusBar = ""
End If
Sheets("TrendAnalysis").Activate

End Sub
Sub DeepDive_nav()

Dim Revcol As Integer
Dim rFind As Range

If Sheets("DeepDive").Range("A1") = 0 Then
Sheets("DeepDive").Range("B1") = 0

Sheets("DeepDive").Range("B7") = Sheets("LOV").Range("W2").Value
Sheets("DeepDive").Range("K7") = Sheets("LOV").Range("X2").Value
Sheets("DeepDive").Range("F7") = "ALL"
Sheets("DeepDive").Range("O7") = "ALL"
Sheets("DeepDive").Range("T7") = "ALL"

Sheets("DeepDive").Range("R7") = Sheets("LOV").Range("Y2").Value


Sheets("DeepDive").Range("V7") = Sheets("LOV").Range("T2").Value
If Sheets("LOV").Range("T2").Value = "Year" Then Sheets("DeepDive").Range("Y7") = Sheets("LOV").Range("P2").Value
If Sheets("LOV").Range("T2").Value = "Month" Then Sheets("DeepDive").Range("Y7") = Sheets("LOV").Range("M2").Value
If Sheets("LOV").Range("T2").Value = "Week" Then Sheets("DeepDive").Range("Y7") = Sheets("LOV").Range("K2").Value

Sheets("DeepDive").Range("E11") = Sheets("LOV").Range("R2").Value
Sheets("DeepDive").Range("T12") = Sheets("LOV").Range("R2").Value


'Delete one column from table when no Billing Net Invoiced Amount
    With Sheets("Setup").Range("E9:E26")
    Set rFind = .Find(What:="Billing Net Invoiced Amount", LookAt:=xlWhole, MatchCase:=False, SearchFormat:=False)
    If rFind Is Nothing Then
        Sheets("DeepDive").Range("AR:AR").Delete
    End If
    End With


'Sheets("DeepDive").Activate
Application.StatusBar = "Refreshing DeepDive information..."
DeepDive_data
top_20
Application.StatusBar = "DeepDive information has been updated!"
Sheets("DeepDive").Range("A1") = 1
Sheets("DeepDive").Range("B1") = 1
Else
Application.StatusBar = ""
End If
Sheets("DeepDive").Activate

End Sub
Sub Improvement_nav()

Sheets("Improvement").Activate
Application.StatusBar = ""
End Sub
Sub Reference_nav()

Sheets("Reference").Activate
Application.StatusBar = ""
End Sub
Sub Support_nav()

Sheets("Support").Activate
Application.StatusBar = ""
End Sub
Sub Setup_nav()

Sheets("Setup").Activate
Application.StatusBar = ""
End Sub

Sub reset_report()

Dim str_count
Scroll_reset

str_count = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("A:A"))

If str_count > 1 Then
Sheets("Raw_Data").Rows("2:" & str_count).ClearContents
End If

Sheets("Setup").Range("F30") = ""
Sheets("Setup").Range("F27") = ""

Sheets("Dashboard").Range("A1") = 0
Sheets("WorldMap").Range("A1") = 0
Sheets("TradeLanes").Range("A1") = 0
Sheets("Setup").Range("A1") = 0
Sheets("TrendAnalysis").Range("A1") = 0
Sheets("DeepDive").Range("S12") = "Top 20"
Sheets("DeepDive").Range("A1") = 0
Sheets("DeepDive").Range("Q1") = 0

Sheets("Setup").Activate
ActiveWindow.TabRatio = 0

End Sub

Sub reset_count()

Sheets("Dashboard").Range("A1") = 0
Sheets("WorldMap").Range("A1") = 0
Sheets("TradeLanes").Range("A1") = 0
Sheets("Setup").Range("A1") = 0
Sheets("TrendAnalysis").Range("A1") = 0
Sheets("DeepDive").Range("A1") = 0

End Sub

Sub Scroll_reset()
    Sheets("Setup").Select
    ActiveWindow.ScrollRow = 1
    ActiveWindow.ScrollColumn = 1
    
    Sheets("Dashboard").Select
    ActiveWindow.ScrollColumn = 1
    ActiveWindow.ScrollRow = 9
    
    Sheets("Worldmap").Select
    ActiveWindow.ScrollRow = 9
    ActiveWindow.ScrollColumn = 1
    
    Sheets("TradeLanes").Select
    ActiveWindow.ScrollRow = 4
    ActiveWindow.ScrollColumn = 1
    
    Sheets("TrendAnalysis").Select
    ActiveWindow.ScrollRow = 9
    ActiveWindow.ScrollColumn = 1
    
    Sheets("Deepdive").Select
    ActiveWindow.ScrollRow = 9
    ActiveWindow.ScrollColumn = 1
    
    Sheets("Raw_Data").Select
    ActiveWindow.ScrollRow = 2
    ActiveWindow.ScrollColumn = 1
    
    Sheets("Improvement").Select
    ActiveWindow.ScrollRow = 6
    ActiveWindow.ScrollColumn = 1
    
    Sheets("Reference").Select
    ActiveWindow.ScrollRow = 6
    ActiveWindow.ScrollColumn = 1
    
    Sheets("Support").Select
    ActiveWindow.ScrollRow = 6
    ActiveWindow.ScrollColumn = 1
    
End Sub

Attribute VB_Name = "Sheet1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Worksheet_Activate()
If Range("A1") = 0 Then
Dashboard_nav
End If

End Sub

Private Sub Worksheet_Change(ByVal Target As Range)

 'Application.Calculation = xlCalculationAutomatic
 ' Application.ScreenUpdating = False
   If Range("B1") <> 0 Then
   If Not Intersect(Target, Me.Range("DB_intersect")) Is Nothing Then
   Application.StatusBar = "Refreshing Dashboard information..."
   Dashboard_data
   Application.StatusBar = "Dashboard information has been updated!"
   
   ElseIf Not Intersect(Target, Me.Range("DB_intersect2")) Is Nothing Then
   Application.StatusBar = "Refreshing Dashboard information..."
   Sheets("Dashboard").Range("H1") = 1
   
   Dashboard_data
   Application.StatusBar = "Dashboard information has been updated!"
   End If
   
   If Not Intersect(Target, Me.Range("C7")) Is Nothing Then
   If Sheets("Dashboard").Range("C7") = "Last 3 Months" Or Sheets("Dashboard").Range("C7") = "Last 6 Months" Then
   Sheets("Dashboard").Range("E7") = Sheets("Dashboard").Range("C7").Value
   Else
   If Sheets("Dashboard").Range("C7") = "Full Period" Then
   Sheets("Dashboard").Range("E7") = "All"
   End If
   End If
   End If
   
   End If
  
End Sub


Attribute VB_Name = "Sheet10"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet11"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet12"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet13"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Worksheet_BeforeRightClick(ByVal Target As Range, Cancel As Boolean)

Dim strfield
Dim strrow

Dim Report As Worksheet 'Create a variable for the worksheet
Set Report = Excel.ActiveSheet 'Assign the worksheet to our variable
Dim i As Integer 'Create a variable for our row number

strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("A:A"))


If Not Intersect(Target, Me.Range("2:" & 1 + strrow)) Is Nothing Then

On Error Resume Next
strfield = Application.WorksheetFunction.Match("Waybill Number", Sheets("Raw_Data").Range("1:1"), 0)

Dim address As String 'Create a variable for our address
address = "http://www.dhl.com/en/express/tracking.shtml?AWB=" & Cells(Target.Row, strfield).Value & "&brand=I"

ActiveWorkbook.FollowHyperlink address:=address, NewWindow:=True 'Send the user to the URL you specified (with the URL parameter at the end).
Cancel = True

End If


End Sub




Attribute VB_Name = "Sheet14"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet15"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet2"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Worksheet_Change(ByVal Target As Range)

Dim strval
Dim strvalrow
Dim strvalcolumn
Dim Revcol As Integer
Dim rFind As Range

On Error Resume Next
If Not Intersect(Target, Me.Range("I9:I25")) Is Nothing Then
If Cells(Target.Row, Target.Column).Value = "N" Then

strval = Application.WorksheetFunction.VLookup(Cells(Target.Row, 5).Value, Sheets("LOV").Range("F:G"), 2, 0)
strvalrow = Application.WorksheetFunction.Match(strval, Sheets("LOV").Range("G:G"), 0)
Sheets("LOV").Cells(strvalrow, 6).Delete Shift:=xlUp
Sheets("LOV").Cells(strvalrow, 7).Delete Shift:=xlUp
Sheets("LOV").Cells(strvalrow, 8).Delete Shift:=xlUp
Sheets("LOV").Cells(strvalrow, 9).Delete Shift:=xlUp
Sheets("LOV").Cells(strvalrow, 10).Delete Shift:=xlUp 'UPDATED
strvalcolumn = Application.WorksheetFunction.Match(strval, Sheets("Raw_Data").Rows("1:1"), 0)
Sheets("Raw_Data").Columns(strvalcolumn).EntireColumn.Delete

If Cells(Target.Row, 5) = "Remote Areas" Then
strvalcolumn = Application.WorksheetFunction.Match("Has TP Flag", Sheets("Raw_Data").Rows("1:1"), 0)
Sheets("Raw_Data").Columns(strvalcolumn).EntireColumn.Delete
End If
If Cells(Target.Row, 5) = "Damaged Shipments" Then
strvalcolumn = Application.WorksheetFunction.Match("Has DM Flag", Sheets("Raw_Data").Rows("1:1"), 0)
Sheets("Raw_Data").Columns(strvalcolumn).EntireColumn.Delete
End If
Sheets("Setup").Cells(Target.Row, 5) = ""
Sheets("Setup").Cells(Target.Row, Target.Column).Clear
Sheets("Setup").Cells(Target.Row, Target.Column + 1).Clear


Sheets("Dashboard").Range("A1") = 0
Sheets("WorldMap").Range("A1") = 0
Sheets("TradeLanes").Range("A1") = 0
Sheets("TrendAnalysis").Range("A1") = 0
Sheets("DeepDive").Range("A1") = 0

End If
End If
   
End Sub
Attribute VB_Name = "Sheet3"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Worksheet_Activate()
If Range("A1") = 0 Then
Worldmap_nav
End If

End Sub

Private Sub Worksheet_Change(ByVal Target As Range)

 'Application.Calculation = xlCalculationAutomatic
 ' Application.ScreenUpdating = False
  
   If Range("B1") <> 0 Then
   If Not Intersect(Target, Me.Range("wm_intersect")) Is Nothing Then
   Application.StatusBar = "Refreshing WorldMap information..."
   BuildMaps
   Application.StatusBar = "WorldMap information has been updated!"
   End If
   If Not Intersect(Target, Me.Range("I7")) Is Nothing Then
   If Sheets("WorldMap").Range("I7") = "Last 3 Months" Or Sheets("WorldMap").Range("I7") = "Last 6 Months" Then
   Sheets("WorldMap").Range("L7") = Sheets("WorldMap").Range("I7").Value
    Else
   If Sheets("WorldMap").Range("I7") = "Full Period" Then
   Sheets("WorldMap").Range("L7") = "All"
   End If
   End If
   End If
   End If
End Sub


Private Sub Worksheet_SelectionChange(ByVal Target As Range)

If Not Intersect(Target, Me.Range("V12:V250")) Is Nothing Then
   
  ' BuildMaps
Sheets("DeepDive").Range("B1") = 0
Sheets("DeepDive").Range("B7") = "Origin Country/Territory"
Sheets("DeepDive").Range("K7") = "Destination Country/Territory"
Sheets("DeepDive").Range("R7") = Sheets("WorldMap").Range("E7").Value
Sheets("DeepDive").Range("T7") = Sheets("WorldMap").Range("G7").Value
Sheets("DeepDive").Range("V7") = Sheets("WorldMap").Range("I7").Value
Sheets("DeepDive").Range("Y7") = Sheets("WorldMap").Range("L7").Value
Sheets("DeepDive").Range("AB7") = "Lane"
If Sheets("WorldMap").Range("C7").Value = "Outbound" Then
Sheets("DeepDive").Range("F7") = Range("U" & Target.Row).Value
Sheets("DeepDive").Range("O7") = "ALL"
Sheets("DeepDive").Range("I7") = "AND"
Else
If Sheets("WorldMap").Range("C7").Value = "Inbound" Then
Sheets("DeepDive").Range("O7") = Range("U" & Target.Row).Value
Sheets("DeepDive").Range("F7") = "ALL"
Sheets("DeepDive").Range("I7") = "AND"
Else
Sheets("DeepDive").Range("O7") = Range("U" & Target.Row).Value
Sheets("DeepDive").Range("F7") = Range("U" & Target.Row).Value
Sheets("DeepDive").Range("I7") = "OR"
End If
End If
Application.StatusBar = "Refreshing Deepdive information..."
Sheets("DeepDive").Range("A1") = 1
Sheets("DeepDive").Activate
   DeepDive_data
   top_20
   Application.StatusBar = "Deepdive information has been updated!"
Sheets("DeepDive").Range("B1") = 1
    
    
End If
 

End Sub
Attribute VB_Name = "Sheet4"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Worksheet_Activate()
If Range("A1") = 0 Then
TradeLanes_nav
End If

End Sub

Private Sub Worksheet_Change(ByVal Target As Range)

 'Application.Calculation = xlCalculationAutomatic
 ' Application.ScreenUpdating = False
  
   If Range("B1") <> 0 Then
   
   If Not Intersect(Target, Me.Range("tl_intersect")) Is Nothing Then
   Application.StatusBar = "Refreshing TradeLane information..."
   Tradelane_data
   Application.StatusBar = "TradeLane information has been updated!"
   End If
   If Not Intersect(Target, Me.Range("N2")) Is Nothing Then
   If Sheets("TradeLanes").Range("N2") = "Last 3 Months" Or Sheets("TradeLanes").Range("N2") = "Last 6 Months" Then
   Sheets("TradeLanes").Range("T2") = Sheets("TradeLanes").Range("N2").Value
    Else
   If Sheets("TradeLanes").Range("N2") = "Full Period" Then
   Sheets("TradeLanes").Range("T2") = "All"
   End If
   End If
   End If
   
   End If
End Sub
Private Sub Worksheet_BeforeRightClick(ByVal Target As Range, Cancel As Boolean)

Dim str_orig_val
Dim str_dest_val
 
str_dest_val = Cells(5, Target.Column).Value
str_orig_val = Cells(Target.Row, 3).Value
 
 If Not Intersect(Target, Me.Range("C5:CN157")) Is Nothing Then
   
     
   
   If Len(str_dest_val) > 1 And Len(str_orig_val) > 1 Then
   
   If Sheets("TradeLanes").Range("AL2").Value = "Region" Then
   
   If str_dest_val = "APEC" Then str_dest_val = "AC"
   If str_dest_val = "SSA" Then str_dest_val = "SB"
   If str_orig_val = "APEC" Then str_orig_val = "AC"
   If str_orig_val = "SSA" Then str_orig_val = "SB"
   Sheets("DeepDive").Range("A1") = 1
   Sheets("DeepDive").Range("B1") = 0
   Sheets("DeepDive").Range("B7") = "Origin Region"
   Sheets("DeepDive").Range("K7") = "Destination Region"
   Sheets("DeepDive").Range("F7") = Sheets("LOV").Cells(Application.WorksheetFunction.Match(str_orig_val, Sheets("LOV").Range("E:E"), 0), 4).Value
   Sheets("DeepDive").Range("O7") = Sheets("LOV").Cells(Application.WorksheetFunction.Match(str_dest_val, Sheets("LOV").Range("E:E"), 0), 4).Value
   
   Else
   Sheets("DeepDive").Range("A1") = 1
   Sheets("DeepDive").Range("B1") = 0
   Sheets("DeepDive").Range("B7") = "Origin Country/Territory"
   Sheets("DeepDive").Range("K7") = "Destination Country/Territory"
   Sheets("DeepDive").Range("F7") = Sheets("LOV").Cells(Application.WorksheetFunction.Match(str_orig_val, Sheets("LOV").Range("C:C"), 0), 2).Value
   Sheets("DeepDive").Range("O7") = Sheets("LOV").Cells(Application.WorksheetFunction.Match(str_dest_val, Sheets("LOV").Range("C:C"), 0), 2).Value
   
   End If
   
   
   
   Sheets("DeepDive").Range("V7") = Sheets("TradeLanes").Range("N2").Value
   Sheets("DeepDive").Range("Y7") = Sheets("TradeLanes").Range("T2").Value
   Sheets("DeepDive").Range("R7") = Sheets("TradeLanes").Range("C2").Value
   Sheets("DeepDive").Range("T7") = Sheets("TradeLanes").Range("G2").Value
   Sheets("DeepDive").Range("I7") = "AND"
   Sheets("DeepDive").Range("AB7") = "Lane"
   Sheets("DeepDive").Range("T12") = "Lane"
   DeepDive_data
   top_20
   Sheets("DeepDive").Range("B1") = 1
   
   End If
   Cancel = True
 End If

End Sub
Attribute VB_Name = "Sheet5"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Worksheet_Activate()
If Range("A1") = 0 Then
Breakdown_nav
End If
End Sub

Private Sub Worksheet_Change(ByVal Target As Range)

 'Application.Calculation = xlCalculationAutomatic
 ' Application.ScreenUpdating = False
  
   If Range("B1") <> 0 Then
   If Not Intersect(Target, Me.Range("bd_intersect")) Is Nothing Then
   Application.StatusBar = "Refreshing Breakdown information..."
   create_breakdown
   Application.StatusBar = "Breakdown information has been updated!"
   End If
   End If
End Sub

Attribute VB_Name = "Sheet6"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet7"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Worksheet_Activate()
If Range("A1") = 0 Then
DeepDive_nav
End If

End Sub
Private Sub Worksheet_Change(ByVal Target As Range)

 'Application.Calculation = xlCalculationAutomatic
 ' Application.ScreenUpdating = False
  
   If Range("B1") <> 0 Then
   If Not Intersect(Target, Me.Range("dd_intersect")) Is Nothing Then
   Application.StatusBar = "Refreshing Deepdive information..."
   DeepDive_data
   top_20
   Application.StatusBar = "Deepdive information has been updated!"
   End If
   If Not Intersect(Target, Me.Range("V7")) Is Nothing Then
   If Sheets("DeepDive").Range("V7") = "Last 3 Months" Or Sheets("DeepDive").Range("V7") = "Last 6 Months" Then
   Sheets("DeepDive").Range("Y7") = Sheets("DeepDive").Range("V7").Value
   Else
   If Sheets("DeepDive").Range("V7") = "Full Period" Then
   Sheets("DeepDive").Range("Y7") = "ALL"
   End If
   End If
   End If
   
   End If
   

   
End Sub

Private Sub Worksheet_BeforeRightClick(ByVal Target As Range, Cancel As Boolean)

If Not Intersect(Target, Me.Range("Y12:AR12")) Is Nothing Then
'If Not Intersect(Target, Me.Range("V12:AR12")) Is Nothing Then
   If Cells(12, Target.Column).Value = "Net Performance" Then
   Sheets("DeepDive").Range("O1") = "Net Performance"
   Else
    On Error Resume Next
   Sheets("DeepDive").Range("O1") = Application.WorksheetFunction.VLookup(Cells(12, Target.Column).Value, Sheets("LOV").Range("F:G"), 2, 0)
   End If
   
   top_20
   Cancel = True
 End If
 
 If Not Intersect(Target, Me.Range("V13:AR32")) Is Nothing Then
 
 
 strrec = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("A:A"))
 
 Sheets("Raw_Data").Range("A1").AutoFilter

 
 strorg = ""
 strdest = ""
 strprodval = ""
 stryear = ""
 strmonth = ""
 strweek = ""
 strdimension = ""
 strperiodval = ""
 
 If Sheets("DeepDive").Range("F7") <> "ALL" Then
 If Sheets("DeepDive").Range("B7") = "Origin Country/Territory" Then
 strorg = Application.WorksheetFunction.Match("Origin Country/Territory Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strorg, Criteria1:=Sheets("Deepdive").Range("F7").Value
 Else
 strorg = Application.WorksheetFunction.Match("Origin Region Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strorg, Criteria1:=Sheets("Deepdive").Range("F7").Value
 End If
 End If

 If Sheets("DeepDive").Range("O7") <> "ALL" Then
 If Sheets("DeepDive").Range("K7") = "Destination Country/Territory" Then
 strdest = Application.WorksheetFunction.Match("Destination Country/Territory Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdest, Criteria1:=Sheets("Deepdive").Range("O7").Value
 Else
 strdest = Application.WorksheetFunction.Match("Destination Region Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdest, Criteria1:=Sheets("Deepdive").Range("O7").Value
 End If
 End If

If Sheets("DeepDive").Range("T7") <> "ALL" Then
 If Sheets("DeepDive").Range("R7") = "Service Line" Then
 strprodval = Application.WorksheetFunction.Match("Service Line Description", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strprodval, Criteria1:=Sheets("Deepdive").Range("T7").Value
 Else
 strprodval = Application.WorksheetFunction.Match("Service Group", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strprodval, Criteria1:=Sheets("Deepdive").Range("T7").Value
 End If
 End If

stryear = Application.WorksheetFunction.Match("Startclock Year", Sheets("Raw_Data").Range("1:1"), 0)
strmonth = Application.WorksheetFunction.Match("Startclock Month", Sheets("Raw_Data").Range("1:1"), 0)
strweek = Application.WorksheetFunction.Match("Startclock Week", Sheets("Raw_Data").Range("1:1"), 0)

Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter

If Sheets("DeepDive").Range("V7") = "Year" Then
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=stryear, Criteria1:=Sheets("Deepdive").Range("Y7").Value
End If
If Sheets("DeepDive").Range("V7") = "Week" Then
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=stryear, Criteria1:=Left(Sheets("DeepDive").Range("Y7").Value, 4)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strweek, Criteria1:=Trim(Right(Sheets("DeepDive").Range("Y7").Value, 2))
End If
If Sheets("DeepDive").Range("V7") = "Month" Then
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=stryear, Criteria1:=Left(Application.WorksheetFunction.VLookup(Sheets("DeepDive").Range("Y7").Value, Sheets("LOV").Range("M:O"), 2, 0), 4)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strmonth, Criteria1:=Application.WorksheetFunction.VLookup(Sheets("DeepDive").Range("Y7").Value, Sheets("LOV").Range("M:O"), 3, 0)
End If
If Sheets("DeepDive").Range("V7") = "Last 3 Months" Then
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=stryear, Criteria1:=Array(Left(Sheets("LOV").Range("N2").Value, 4), Left(Sheets("LOV").Range("N3").Value, 4), Left(Sheets("LOV").Range("N4").Value, 4)), Operator:=xlFilterValues
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strmonth, Criteria1:=Array(Sheets("LOV").Range("O2").Value, Sheets("LOV").Range("O3").Value, Sheets("LOV").Range("O4").Value), Operator:=xlFilterValues
End If
If Sheets("DeepDive").Range("V7") = "Last 6 Months" Then
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=stryear, Criteria1:=Array(Left(Sheets("LOV").Range("N2"), 4), Left(Sheets("LOV").Range("N3"), 4), Left(Sheets("LOV").Range("N4"), 4), Left(Sheets("LOV").Range("N5"), 4), Left(Sheets("LOV").Range("N6"), 4), Left(Sheets("LOV").Range("N7"), 4)), Operator:=xlFilterValues
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strmonth, Criteria1:=Array(Left(Sheets("LOV").Range("O2"), 4), Left(Sheets("LOV").Range("O3"), 4), Left(Sheets("LOV").Range("O4"), 4), Left(Sheets("LOV").Range("O5"), 4), Left(Sheets("LOV").Range("O6"), 4), Left(Sheets("LOV").Range("O7"), 4)), Operator:=xlFilterValues
End If
 

If Sheets("DeepDive").Range("B7") = "Origin Country/Territory" Then
 strorg = Application.WorksheetFunction.Match("Origin Country/Territory Name", Sheets("Raw_Data").Range("1:1"), 0)

 Else
 strorg = Application.WorksheetFunction.Match("Origin Region Name", Sheets("Raw_Data").Range("1:1"), 0)

 End If
If Sheets("DeepDive").Range("K7") = "Destination Country/Territory" Then
 strdest = Application.WorksheetFunction.Match("Destination Country/Territory Name", Sheets("Raw_Data").Range("1:1"), 0)
 
 Else
 strdest = Application.WorksheetFunction.Match("Destination Region Name", Sheets("Raw_Data").Range("1:1"), 0)

 End If
If Sheets("DeepDive").Range("T12") = "Lane" Then
 
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strorg, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 17)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdest, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 18)
 
End If
If Sheets("DeepDive").Range("T12") = "Services" Then
If Sheets("DeepDive").Range("R7") = "Service Line" Then
 strprodval = Application.WorksheetFunction.Match("Service Line Description", Sheets("Raw_Data").Range("1:1"), 0)
 Else
 strprodval = Application.WorksheetFunction.Match("Service Group", Sheets("Raw_Data").Range("1:1"), 0)
 End If
Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strprodval, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 20).Value

End If
If Sheets("DeepDive").Range("T12") = "Origin" Then
If Sheets("DeepDive").Range("B7") = "Origin Country/Territory" Then
 strorg = Application.WorksheetFunction.Match("Origin Country/Territory Name", Sheets("Raw_Data").Range("1:1"), 0)
 Else
 strorg = Application.WorksheetFunction.Match("Origin Region Name", Sheets("Raw_Data").Range("1:1"), 0)
 End If
Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strorg, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 20)
 
End If
If Sheets("DeepDive").Range("T12") = "Destination" Then
If Sheets("DeepDive").Range("K7") = "Destination Country/Territory" Then
 strdest = Application.WorksheetFunction.Match("Destination Country/Territory Name", Sheets("Raw_Data").Range("1:1"), 0)
 Else
 strdest = Application.WorksheetFunction.Match("Destination Region Name", Sheets("Raw_Data").Range("1:1"), 0)
 End If
Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdest, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 20)
 
End If
If Sheets("DeepDive").Range("T12") = "Weight Type" Then
strdimension = Application.WorksheetFunction.Match("Shipment Weight Type", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 20).Value
 
End If
If Sheets("DeepDive").Range("T12") = "Service Area" Then
strdimension = Application.WorksheetFunction.Match("Origin Service Area Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 17)
strdimension = Application.WorksheetFunction.Match("Destination Service Area Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 18)
 
End If
If Sheets("DeepDive").Range("T12") = "Program" Then
 strdimension = Application.WorksheetFunction.Match("OPMC Program", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 20).Value
 
End If
If Sheets("DeepDive").Range("T12") = "Account" Then
 strdimension = Application.WorksheetFunction.Match("Billing Account Number", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 17).Value
 
End If
If Sheets("DeepDive").Range("T12") = "DHL Controllable" Or Sheets("DeepDive").Range("T12") = "DHL Uncontrollable" Or Sheets("DeepDive").Range("T12") = "Customer Controllable" Then
 
 strdimension = Application.WorksheetFunction.Match("Reporting Code", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 17).Value
 If Sheets("Deepdive").Range("F7") <> "ALL" Then Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strorg, Criteria1:=Sheets("Deepdive").Range("F7")
 If Sheets("Deepdive").Range("O7") <> "ALL" Then Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdest, Criteria1:=Sheets("Deepdive").Range("O7")
 
End If
 Sheets("Raw_Data").Activate
  Cancel = True
  
 End If
 

End Sub

Private Sub Worksheet_BeforeDoubleClick(ByVal Target As Range, Cancel As Boolean)

Dim strorg
Dim strdest
Dim strprodval
Dim stryear
Dim strmonth
Dim strweek
Dim strdimension
Dim strdimensionval
Dim strrec




If Not Intersect(Target, Me.Range("t20_intersect")) Is Nothing Then
     
   Sheets("DeepDive").Range("O1") = Application.WorksheetFunction.VLookup(Cells(12, Target.Column).Value, Sheets("LOV").Range("F:G"), 2, 0)
   
  If Sheets("DeepDive").Range("T12") <> "DHL Controllable" And Sheets("DeepDive").Range("T12") <> "DHL Uncontrollable" And Sheets("DeepDive").Range("T12") <> "Customer Controllable" Then
   
 '  Sheets("TrendAnalysis").Activate
    Sheets("TrendAnalysis").Range("B1") = 0
    Sheets("TrendAnalysis").Range("B7") = Sheets("DeepDive").Range("B7").Value
    Sheets("TrendAnalysis").Range("K7") = Sheets("DeepDive").Range("K7").Value
    Sheets("TrendAnalysis").Range("I7") = Sheets("DeepDive").Range("I7").Value
    Sheets("TrendAnalysis").Range("R7") = Sheets("DeepDive").Range("R7").Value
   
   
   
   If Target.Row = 34 Then
   Sheets("TrendAnalysis").Range("F7") = Sheets("DeepDive").Range("F7").Value
   Sheets("TrendAnalysis").Range("O7") = Sheets("DeepDive").Range("O7").Value
   Else
   If Sheets("DeepDive").Range("T12") = "Lane" Or Sheets("DeepDive").Range("T12") = "Origin" Or Sheets("DeepDive").Range("T12") = "Destination" Then
   Sheets("TrendAnalysis").Range("F7") = Sheets("DeepDive").Cells(Target.Row, 17).Value
   Sheets("TrendAnalysis").Range("O7") = Sheets("DeepDive").Cells(Target.Row, 18).Value
   End If
   End If
   
   If Sheets("DeepDive").Range("V7").Value = "Month" Or Sheets("DeepDive").Range("V7").Value = "Last 3 Months" Or Sheets("DeepDive").Range("V7").Value = "Last 6 Months" Or Sheets("DeepDive").Range("V7").Value = "Year" Then
   Sheets("TrendAnalysis").Range("V7") = "Monthly"
   Else
   Sheets("TrendAnalysis").Range("V7") = "Weekly"
   End If
  
   Sheets("TrendAnalysis").Range("I7") = Sheets("DeepDive").Range("I7").Value
  
   Sheets("TrendAnalysis").Range("Z7") = Sheets("DeepDive").Cells(12, Target.Column).Value
   If Sheets("DeepDive").Range("T12") = "Lane" Or Sheets("DeepDive").Range("T12") = "Origin" Or Sheets("DeepDive").Range("T12") = "Destination" Or Target.Row = 34 Then
   create_breakdown
   Sheets("TrendAnalysis").Range("B1") = 1
   End If
   End If
  
 If Sheets("DeepDive").Range("T12") <> "DHL Controllable" And Sheets("DeepDive").Range("T12") <> "DHL Uncontrollable" And Sheets("DeepDive").Range("T12") <> "Customer Controllable" And Target.Row = 34 Then Exit Sub
 
  
 
 strrec = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("A:A"))
 
 Sheets("Raw_Data").Range("A1").AutoFilter
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter

 
  If Sheets("DeepDive").Range("F7") <> "ALL" Then
 If Sheets("DeepDive").Range("B7") = "Origin Country/Territory" Then
 strorg = Application.WorksheetFunction.Match("Origin Country/Territory Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strorg, Criteria1:=Sheets("Deepdive").Range("F7").Value
 Else
 strorg = Application.WorksheetFunction.Match("Origin Region Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strorg, Criteria1:=Sheets("Deepdive").Range("F7").Value
 End If
 End If

 If Sheets("DeepDive").Range("O7") <> "ALL" Then
 If Sheets("DeepDive").Range("K7") = "Destination Country/Territory" Then
 strdest = Application.WorksheetFunction.Match("Destination Country/Territory Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdest, Criteria1:=Sheets("Deepdive").Range("O7").Value
 Else
 strdest = Application.WorksheetFunction.Match("Destination Region Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdest, Criteria1:=Sheets("Deepdive").Range("O7").Value
 End If
 End If

If Sheets("DeepDive").Range("T7") <> "ALL" Then
 If Sheets("DeepDive").Range("R7") = "Service Line" Then
 strprodval = Application.WorksheetFunction.Match("Service Line Description", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strprodval, Criteria1:=Sheets("Deepdive").Range("T7").Value
 Else
 strprodval = Application.WorksheetFunction.Match("Service Group", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strprodval, Criteria1:=Sheets("Deepdive").Range("T7").Value
 End If
 End If

stryear = Application.WorksheetFunction.Match("Startclock Year", Sheets("Raw_Data").Range("1:1"), 0)
strmonth = Application.WorksheetFunction.Match("Startclock Month", Sheets("Raw_Data").Range("1:1"), 0)
strweek = Application.WorksheetFunction.Match("Startclock Week", Sheets("Raw_Data").Range("1:1"), 0)


If Sheets("DeepDive").Range("V7") = "Year" Then
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=stryear, Criteria1:=Sheets("Deepdive").Range("Y7").Value
End If
If Sheets("DeepDive").Range("V7") = "Week" Then
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=stryear, Criteria1:=Left(Sheets("DeepDive").Range("Y7").Value, 4)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strweek, Criteria1:=Trim(Right(Sheets("DeepDive").Range("Y7").Value, 2))
End If
If Sheets("DeepDive").Range("V7") = "Month" Then
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=stryear, Criteria1:=Left(Application.WorksheetFunction.VLookup(Sheets("DeepDive").Range("Y7").Value, Sheets("LOV").Range("M:O"), 2, 0), 4)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strmonth, Criteria1:=Application.WorksheetFunction.VLookup(Sheets("DeepDive").Range("Y7").Value, Sheets("LOV").Range("M:O"), 3, 0)
End If
If Sheets("DeepDive").Range("V7") = "Last 3 Months" Then
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=stryear, Criteria1:=Array(Left(Sheets("LOV").Range("N2"), 4), Left(Sheets("LOV").Range("N3"), 4), Left(Sheets("LOV").Range("N4"), 4)), Operator:=xlFilterValues
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strmonth, Criteria1:=Array(Sheets("LOV").Range("O2").Value, Sheets("LOV").Range("O3").Value, Sheets("LOV").Range("O4").Value), Operator:=xlFilterValues
End If
If Sheets("DeepDive").Range("V7") = "Last 6 Months" Then
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=stryear, Criteria1:=Array(Left(Sheets("LOV").Range("N2"), 4), Left(Sheets("LOV").Range("N3"), 4), Left(Sheets("LOV").Range("N4"), 4), Left(Sheets("LOV").Range("N5"), 4), Left(Sheets("LOV").Range("N6"), 4), Left(Sheets("LOV").Range("N7"), 4)), Operator:=xlFilterValues
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strmonth, Criteria1:=Array(Sheets("LOV").Range("O2").Value, Sheets("LOV").Range("O3").Value, Sheets("LOV").Range("O4").Value, Sheets("LOV").Range("O5").Value, Sheets("LOV").Range("O6").Value, Sheets("LOV").Range("O7").Value), Operator:=xlFilterValues
End If
 
If Sheets("DeepDive").Range("T12") = "Lane" Then

If Sheets("DeepDive").Range("B7") = "Origin Country/Territory" Then
 strorg = Application.WorksheetFunction.Match("Origin Country/Territory Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strorg, Criteria1:=Sheets("Deepdive").Range("F7").Value
 Else
 strorg = Application.WorksheetFunction.Match("Origin Region Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strorg, Criteria1:=Sheets("Deepdive").Range("F7").Value
 End If
If Sheets("DeepDive").Range("K7") = "Destination Country/Territory" Then
 strdest = Application.WorksheetFunction.Match("Destination Country/Territory Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdest, Criteria1:=Sheets("Deepdive").Range("O7").Value
 Else
 strdest = Application.WorksheetFunction.Match("Destination Region Name", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdest, Criteria1:=Sheets("Deepdive").Range("O7").Value
 End If
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strorg, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 17)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdest, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 18)
 
End If
If Sheets("DeepDive").Range("T12") = "Services" Then
If Sheets("DeepDive").Range("R7") = "Service Line" Then
 strprodval = Application.WorksheetFunction.Match("Service Line Description", Sheets("Raw_Data").Range("1:1"), 0)
 Else
 strprodval = Application.WorksheetFunction.Match("Service Group", Sheets("Raw_Data").Range("1:1"), 0)
 End If
Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strprodval, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 20).Value

End If
If Sheets("DeepDive").Range("T12") = "Origin" Then
If Sheets("DeepDive").Range("B7") = "Origin Country/Territory" Then
 strorg = Application.WorksheetFunction.Match("Origin Country/Territory Name", Sheets("Raw_Data").Range("1:1"), 0)
 Else
 strorg = Application.WorksheetFunction.Match("Origin Region Name", Sheets("Raw_Data").Range("1:1"), 0)
 End If
Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strorg, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 20)
 
End If
If Sheets("DeepDive").Range("T12") = "Destination" Then
If Sheets("DeepDive").Range("K7") = "Destination Country/Territory" Then
 strdest = Application.WorksheetFunction.Match("Destination Country/Territory Name", Sheets("Raw_Data").Range("1:1"), 0)
 Else
 strdest = Application.WorksheetFunction.Match("Destination Region Name", Sheets("Raw_Data").Range("1:1"), 0)
 End If
Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdest, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 20)
 
End If
If Sheets("DeepDive").Range("T12") = "Weight Type" Then
strdimension = Application.WorksheetFunction.Match("Shipment Weight Type", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 20).Value
 
End If
If Sheets("DeepDive").Range("T12") = "Service Area" Then
    strdimension = Application.WorksheetFunction.Match("Origin Service Area Name", Sheets("Raw_Data").Range("1:1"), 0)
    Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 17)
    strdimension = Application.WorksheetFunction.Match("Destination Service Area Name", Sheets("Raw_Data").Range("1:1"), 0)
    Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 18)
 
End If
If Sheets("DeepDive").Range("T12") = "Program" Then
 strdimension = Application.WorksheetFunction.Match("OPMC Program", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 20).Value
 
End If
If Sheets("DeepDive").Range("T12") = "Account" Then
 strdimension = Application.WorksheetFunction.Match("Billing Account Number", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 17).Value
 
End If
If Sheets("DeepDive").Range("T12") = "DHL Controllable" Or Sheets("DeepDive").Range("T12") = "DHL Uncontrollable" Or Sheets("DeepDive").Range("T12") = "Customer Controllable" Then
 If Target.Row <> 34 Then
 strdimension = Application.WorksheetFunction.Match("Reporting Code", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("Deepdive").Cells(Target.Row, 17).Value
 Else
 strdimension = Application.WorksheetFunction.Match("Reporting Code Category Description", Sheets("Raw_Data").Range("1:1"), 0)
 Sheets("Raw_Data").Range("$A$1:$BQ$" & strrec).AutoFilter Field:=strdimension, Criteria1:=Sheets("DeepDive").Range("T12").Value
 End If
End If
 Sheets("Raw_Data").Activate

  Cancel = True
  
 End If
' End If
    ActiveWindow.ScrollColumn = 1
    ActiveWindow.ScrollRow = 2
 
End Sub
Attribute VB_Name = "Sheet8"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet9"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "ThisWorkbook"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Workbook_Open()
Application.DisplayAlerts = False
ActiveWorkbook.Save
Application.DisplayAlerts = True

If Sheets("Setup").Range("A1").Value = 0 Then
Sheets("Setup").Activate

Application.StatusBar = "Preparing Report Data..."
Sheets("Setup").Range("F30") = "Preparing Report for first time use..."


lov 'Call LOV

Sheets("Setup").Range("A1").Value = 1
Application.StatusBar = "Data Preparation complete!"
Sheets("Setup").Range("F30") = "Data preparation completed!"
Sheets("Setup").Activate

End If
End Sub
Attribute VB_Name = "Tradelanes"
Sub Tradelane_data()

    Dim j As Integer
    Dim i As Integer
    Dim k As Integer
    Dim l As Integer
    
    Dim oCn As ADODB.Connection
    Dim oRS As ADODB.Recordset
    Dim ConnString As String
    Dim SQL As String
    Dim intloop
    Dim intloop2
    Dim strcount
    Dim strrow
    Dim strcol
    Dim region_code
    Dim orig_reg
    Dim dest_reg
     
    Dim strr
    Dim strc
   
    Dim strcrit
    Dim strmainval
   
    Dim strcp1
    Dim strpp1
   
    Dim str_product_filter
    Dim str_date
    Dim str_orig_field
    Dim str_dest_field
   
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    With Application
    .DecimalSeparator = "."
    .ThousandsSeparator = ","
End With

  
   Sheets("Tradelanes").Range("C5:CW1000") = ""
   
    Sheets("Tradelanes").Activate
    
     With Sheets("Tradelanes").Range(Cells(9, 3), Cells(107, 92)).Interior
        .Pattern = xlNone
        .TintAndShade = 0
        .PatternTintAndShade = 0
         End With
    
  strr = "R"
  strc = "C"
  
    'define product field
  
   
   'define filter
  
   If Sheets("Setup").Range("I8").Value = "" Then
  strcrit = 0.955
  Else
  strcrit = Sheets("Setup").Range("I8").Value
  End If
   
   
   
     'define measure field
    
    
   str_product_filter = ""
   str_date = ""
   str_orig_field = ""
   str_dest_field = ""
   'str_direction = ""
   str_filter = ""
   strdimension = ""
   strproduct = ""
   
   
   strproduct = "[" & Application.WorksheetFunction.VLookup(Sheets("TradeLanes").Range("C2").Value, Sheets("LOV").Range("Y:Z"), 2, 0) & "]"
   
        
   If Sheets("TradeLanes").Range("G2").Value <> "ALL" Then
   str_product_filter = " AND " & strproduct & " = '" & Sheets("TradeLanes").Range("G2").Value & "' "
   Else
   str_product_filter = " AND " & strproduct & " <> '' "
   End If
   
   If Sheets("TradeLanes").Range("N2").Value = "Week" Then
   str_date = " AND [Startclock Year] = " & Left(Sheets("TradeLanes").Range("T2").Value, 4) & " AND [Startclock Week] = " & Trim(Right(Sheets("TradeLanes").Range("T2").Value, 2)) & " "
   Else
   If Sheets("TradeLanes").Range("N2").Value = "Year" Then
   str_date = " AND [Startclock Year] = " & Sheets("TradeLanes").Range("T2").Value & " "
   Else
   If Sheets("TradeLanes").Range("N2").Value = "Month" Then
   str_date = " AND [Startclock Year] = " & Left(Application.WorksheetFunction.VLookup(Sheets("TradeLanes").Range("T2").Value, Sheets("LOV").Range("M:O"), 2, 0), 4) & " "
   str_date = str_date & " AND [Startclock Month] = '" & Application.WorksheetFunction.VLookup(Sheets("TradeLanes").Range("T2").Value, Sheets("LOV").Range("M:O"), 3, 0) & "' "
   Else
   If Sheets("TradeLanes").Range("N2").Value = "Last 3 Months" Then
   str_date = " AND (([Startclock Year] = " & Left(Sheets("LOV").Cells(2, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(2, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(3, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(3, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(4, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(4, 15).Value & "'))  "
   Else
   If Sheets("TradeLanes").Range("N2").Value = "Last 6 Months" Then
   str_date = " AND (([Startclock Year] = " & Left(Sheets("LOV").Cells(2, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(2, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(3, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(3, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(4, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(4, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(5, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(5, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(6, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(6, 15).Value & "')  "
   str_date = str_date & " OR ([Startclock Year] = " & Left(Sheets("LOV").Cells(7, 14).Value, 4) & " AND [Startclock Month] = '" & Sheets("LOV").Cells(7, 15).Value & "'))  "
   End If
   End If
   End If
   End If
   End If
   
   
  
   
   
   
  
   If Sheets("TradeLanes").Range("AL2").Value = "Region" Then
   str_orig_field = "[Origin Region Code]"
   str_dest_field = "[Destination Region Code]"
   Else
   str_orig_field = "[Origin Country/Territory Code]" 'updated with territory
   str_dest_field = "[Destination Country/Territory Code]" 'updated with territory
   End If
   
        
  
   strmainval = Application.WorksheetFunction.VLookup(Sheets("TradeLanes").Range("AB2").Value, Sheets("LOV").Range("F:H"), 3, 0)
      
  
    'define current period
    
  
       
        
    strrow = Application.WorksheetFunction.CountA(Sheets("Raw_Data").Range("C:C"))
    
    
       
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    SQL = ""
    SQL = SQL & " SELECT top 30 " & str_dest_field & ", sum([Customer Controllable Delay Flag]),sum([DHL Controllable Delay Flag]), Sum([DHL Uncontrollable Delay Flag]), sum([On Time Volume]) as raw_ot, sum([On Time Volume]+[DHL Uncontrollable Delay Flag]+[Customer Controllable Delay Flag]) as net_ot, sum([Net Monitored Volume]),Sum([Count of Shipments]), " & strmainval
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_dest_field & " <> '' AND " & str_dest_field & " <> 'UNKNOWN' "
    SQL = SQL & " " & str_product_filter & str_date & " GROUP BY " & str_dest_field & " ORDER BY " & strmainval & " DESC "
   


    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 5
    j = 5
    
    On Error Resume Next
    oRS.Open
    intloop = 0
    
    Sheets("Tradelanes").Range("B5") = Sheets("Tradelanes").Range("AB2").Value
   
    
    Do Until oRS.EOF Or intloop > 29
    intloop = intloop + 1
  strmainval = oRS(6).Value
        '2016-06-16 code change to replace SSA and APEC
        If oRS(0).Value = "SB" Then
            region_code = "SSA"
        ElseIf oRS(0).Value = "AC" Then
            region_code = "APEC"
        Else
            region_code = oRS(0).Value
        End If
        
        Sheets("Tradelanes").Cells(i, j) = region_code
        If oRS(6).Value <> 0 Then
        If intloop > 30 Then Exit Sub
        Sheets("Tradelanes").Cells(i + 1, j) = "=" & oRS(5).Value & "/" & oRS(6).Value
        Else
        Sheets("Tradelanes").Cells(i + 1, j) = "0"
        End If
        Sheets("Tradelanes").Cells(i + 2, j) = oRS(8).Value
        
        'now for colouring
        
        If oRS(6).Value <> 0 Then
        If strmainval / oRS(6) >= strcrit Then
         ' dark green
       With Sheets("Tradelanes").Cells(i + 1, j).Font
        .Color = 5287936
        .Bold = True
        
       End With
       Else
        If oRS(5) / oRS(6) < strcrit * 0.97 Then
         ' red
       With Sheets("Tradelanes").Cells(i + 1, j).Font
        .ThemeColor = xlThemeColorDark1
        .Color = 255
        .Bold = True
      
       End With
       Else
        If oRS(5) / oRS(6) >= strcrit * 0.97 Then
         ' amber
       With Sheets("Tradelanes").Cells(i + 1, j).Font
        .ThemeColor = xlThemeColorAccent2
        .Bold = True
      
       End With
       End If
       End If
       End If
       End If
       
          
      j = j + 3
      
        oRS.MoveNext
        Loop

    oCn.Close
   
   
   
         
   Set oRS = Nothing
   Set oCn = Nothing
   
 strmainval = Application.WorksheetFunction.VLookup(Sheets("TradeLanes").Range("AB2").Value, Sheets("LOV").Range("F:H"), 3, 0)
      
   
    ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open

    SQL = ""
    SQL = SQL & " SELECT top 30 " & str_orig_field & ", sum([Customer Controllable Delay Flag]),sum([DHL Controllable Delay Flag]), Sum([DHL Uncontrollable Delay Flag]), sum([On Time Volume]) as raw_ot, sum([On Time Volume]+[DHL Uncontrollable Delay Flag]+[Customer Controllable Delay Flag]) as net_ot, sum([Net Monitored Volume]),Sum([Count of Shipments]), " & strmainval
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_orig_field & " <> '' AND " & str_orig_field & " <> 'UNKNOWN' "
    SQL = SQL & " " & str_product_filter & str_date & " GROUP BY " & str_orig_field & " ORDER BY " & strmainval & " DESC "
   


    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 9
    j = 3
    
    oRS.Open
    intloop = 0
    
       
    Do Until oRS.EOF Or intloop > 30
       
       
  strmainval = oRS(8).Value
        '2016-06-16 code change to replace SSA and APEC
        If oRS(0).Value = "SB" Then
            region_code = "SSA"
        ElseIf oRS(0).Value = "AC" Then
            region_code = "APEC"
        Else
            region_code = oRS(0).Value
        End If
 
        Sheets("Tradelanes").Cells(i, j) = region_code
          
        If oRS(6).Value <> 0 Then
        Sheets("Tradelanes").Cells(i + 2, j) = "=" & oRS(5).Value & "/" & oRS(6).Value
        Else
        Sheets("Tradelanes").Cells(i + 2, j) = 0
        End If
        Sheets("Tradelanes").Cells(i + 3, j) = oRS(8).Value
                  
           If oRS(5) / oRS(6) >= strcrit Then
         ' dark green
       With Sheets("Tradelanes").Cells(i + 2, j).Font
        .Color = 5287936
      .Bold = True
      
       End With
       Else
        If oRS(5) / oRS(6) < strcrit * 0.97 Then
         ' red
       With Sheets("Tradelanes").Cells(i + 2, j).Font
        .Color = 255
        .Bold = True
      
       End With
       Else
        If oRS(5) / oRS(6) >= strcrit * 0.97 Then
         ' amber
       With Sheets("Tradelanes").Cells(i + 2, j).Font
        .ThemeColor = xlThemeColorAccent2
        .Bold = True
      
       End With
       End If
       End If
       End If
          
          
          
          
          
      i = i + 5
     intloop = intloop + 1
        oRS.MoveNext
        Loop

    oCn.Close
   
  
         
   Set oRS = Nothing
   Set oCn = Nothing
   
  strmainval = Application.WorksheetFunction.VLookup(Sheets("TradeLanes").Range("AB2").Value, Sheets("LOV").Range("F:H"), 3, 0)
    
   
       ConnString = "Provider=Microsoft.ACE.OLEDB.12.0;Data Source=" & ThisWorkbook.Path & "\" & ThisWorkbook.Name & " ;Extended Properties=""Excel 12.0 Macro;HDR=YES"";"
    Set oCn = New ADODB.Connection
    oCn.ConnectionString = ConnString
    oCn.Open


    SQL = ""
    SQL = SQL & " SELECT " & str_orig_field & "," & str_dest_field & ", sum([Customer Controllable Delay Flag]),sum([DHL Controllable Delay Flag]), Sum([DHL Uncontrollable Delay Flag]), sum([On Time Volume]) as raw_ot, sum([On Time Volume]+[DHL Uncontrollable Delay Flag]+[Customer Controllable Delay Flag]) as net_ot, sum([Net Monitored Volume]),Sum([Count of Shipments]), " & strmainval
    SQL = SQL & " FROM [Raw_Data$" ' & ctsheet
    SQL = SQL & "] WHERE " & str_orig_field & " <> '' AND " & str_orig_field & " <> 'UNKNOWN' "
    SQL = SQL & " " & str_product_filter & str_date & " GROUP BY " & str_orig_field & "," & str_dest_field
   
    Set oRS = New ADODB.Recordset
    oRS.Source = SQL
    oRS.ActiveConnection = oCn

    oRS.CursorLocation = adUseClient
    oRS.CursorType = adOpenStatic
    
 '  Debug.Print SQL
    
  '   oRS.Open
    
 '  strcount = oRS.RecordCount
 '   oRS.Close

    i = 9
    j = 5
    k = i
    l = j
    
    
    oRS.Open
  
  
  For intloop = 1 To 30
  j = 5
  For intloop2 = 1 To 30
  If Sheets("Tradelanes").Cells(i, 3).Value = "SSA" Then
            orig_reg = "SB"
        ElseIf Sheets("Tradelanes").Cells(i, 3).Value = "APEC" Then
            orig_reg = "AC"
        Else
            orig_reg = Sheets("Tradelanes").Cells(i, 3).Value
        End If
        
      If Sheets("Tradelanes").Cells(5, j).Value = "SSA" Then
            dest_reg = "SB"
        ElseIf Sheets("Tradelanes").Cells(5, j).Value = "APEC" Then
            dest_reg = "AC"
        Else
            dest_reg = Sheets("Tradelanes").Cells(5, j).Value
        End If

    oRS.Filter = str_dest_field & " = '" & dest_reg & "' AND " & str_orig_field & " = '" & orig_reg & "'"
   
        If oRS.EOF = False Then
              
  
  strmainval = oRS(8).Value
  
 
        If oRS(7).Value <> 0 Then
       
        Sheets("Tradelanes").Cells(i, j) = "=" & oRS(6).Value & "/" & oRS(7).Value
    '    Sheets("Tradelanes").Cells(i, j + 1) = "=" & oRS(2).Value & "/" & oRS(7).Value
    '    Sheets("Tradelanes").Cells(i + 1, j + 1) = "=" & oRS(3).Value & "/" & oRS(7).Value
    '    Sheets("Tradelanes").Cells(i + 2, j + 1) = "=" & oRS(4).Value & "/" & oRS(7).Value
        
        
       If oRS(6) / oRS(7) >= strcrit Then
         ' dark green
       With Sheets("Tradelanes").Range(Cells(i, j), Cells(i + 2, j)).Interior
        .Pattern = xlSolid
        .PatternColorIndex = xlAutomatic
        .Color = 65280
        .TintAndShade = 0
        .PatternTintAndShade = 0
       End With
       With Sheets("Tradelanes").Range(Cells(i, j), Cells(i + 2, j)).Font
        .Color = vbBlack
        .Bold = True
       End With
       Else
          
      If oRS(6) / oRS(7) < strcrit * 0.97 Then
         ' dark red
       With Sheets("Tradelanes").Range(Cells(i, j), Cells(i + 2, j)).Interior
         .Pattern = xlSolid
        .PatternColorIndex = xlAutomatic
        .Color = 255
        .TintAndShade = 0
        .PatternTintAndShade = 0
       End With
       With Sheets("Tradelanes").Range(Cells(i, j), Cells(i + 2, j)).Font
        .Color = vbWhite
        .Bold = True
       End With
       
       Else
         'amber
       With Sheets("Tradelanes").Range(Cells(i, j), Cells(i + 2, j)).Interior
         .Pattern = xlSolid
        .PatternColorIndex = xlAutomatic
        .Color = 65535
        .TintAndShade = 0
        .PatternTintAndShade = 0
       End With
       With Sheets("Tradelanes").Range(Cells(i, j), Cells(i + 2, j)).Font
        .Color = vbBlack
        .Bold = True
       End With
       
       
       
       End If
       End If
      
     
        
        Else
        Sheets("Tradelanes").Cells(i, j) = 0
     '   Sheets("Tradelanes").Cells(i, j + 1) = 0
     '   Sheets("Tradelanes").Cells(i + 1, j + 1) = 0
     '   Sheets("Tradelanes").Cells(i + 2, j + 1) = 0
             'no colour
        With Sheets("Tradelanes").Range(Cells(i, j), Cells(i + 2, j)).Interior
        .Pattern = xlNone
        .TintAndShade = 0
        .PatternTintAndShade = 0
         End With
         
        End If
        
        
        Sheets("Tradelanes").Cells(i + 3, j) = oRS(9).Value
    
        Else
   
         'no colour
        With Sheets("Tradelanes").Range(Cells(i, j), Cells(i + 2, j)).Interior
        .Pattern = xlNone
        .TintAndShade = 0
        .PatternTintAndShade = 0
         End With
        
        End If
  j = j + 3
  
  Next
  i = i + 5
  
  Next
    
       
 
    oCn.Close
   
  
         
   Set oRS = Nothing
   Set oCn = Nothing
   
   Application.UseSystemSeparators = True
 Application.Calculation = xlCalculationAutomatic


Application.ScreenUpdating = True


End Sub



INQUEST-PP=macro
