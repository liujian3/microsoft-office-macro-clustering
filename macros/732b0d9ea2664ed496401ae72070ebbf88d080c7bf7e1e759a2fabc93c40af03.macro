Attribute VB_Name = "ThisDocument"
Attribute VB_Base = "1Normal.ThisDocument"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = True
Attribute VB_Customizable = True
Dim oDoc As Document
' Funktion deklarieren, aus der DLL "urlmon", die im Systemverzeichnis liegt,
' um Bilder downloaden zu k|fffd|nnen.
Private Declare Function URLDownloadToFile Lib "urlmon" Alias "URLDownloadToFileA" _
   (ByVal pCaller As Long, ByVal szURL As String, ByVal szFileName As String, _
      ByVal dwReserved As Long, ByVal lpfnCB As Long) As Long
      
      Dim XMLFile As String
      Dim myBookmark As Bookmark

Private Sub ReadFile()
    On Error Resume Next
    
    Dim oRoot As IXMLDOMNodeList
    Dim oElemNN As IXMLDOMElement
    Dim oElemData As IXMLDOMElement
    Dim oElemSubData As IXMLDOMElement
    Dim oElemKnoten As IXMLDOMNode
    Dim intCounter As Integer
   
    Dim doKnotenListe As IXMLDOMNodeList
    Dim doKnoten As IXMLDOMNode
    Dim doPositionen As IXMLDOMNodeList
    Dim doPos As IXMLDOMNode
    Dim doAbezListe As IXMLDOMNodeList
    Dim doAbez As IXMLDOMNode
    Dim doPtListe As IXMLDOMNodeList
    Dim doPt As IXMLDOMNode
    Dim doZuaListe As IXMLDOMNodeList
    Dim doZua As IXMLDOMNode
    Dim doSBNR As IXMLDOMNode
    Dim doKDNR As IXMLDOMNode
    Dim doKDAdrListe As IXMLDOMNodeList
    Dim doKDAdr As IXMLDOMNode
    Dim doENDE As IXMLDOMNode
    
    Dim strTemp As String
    Dim strAdr As String
    Dim strSoar As String
    Dim strSvSoar As String
    
    Dim i As Long
    
    Set doXML = New DOMDocument
    
    'xml-datei importieren
    doXML.async = False
    doXML.Load XMLFile
    
    Set oRoot = doXML.SelectNodes("Angebot")
    
    'Es wird davon ausgegangen, dass jede XML-Datei nur ein Angebot enthaelt
    'Sollen pro Datei mehr Angebote enthalten sein, muss hier eine for each..next-Schleife hin
    
    Set doSBNR = oRoot(0).selectSingleNode("Sachbearbeiter")
    Set doKDNR = oRoot(0).selectSingleNode("Kundendaten")
    Set doPositionen = oRoot(0).SelectNodes("Position")
    Set doENDE = oRoot(0).selectSingleNode("EndeDaten")
    
'   Verarbeitung der Sachbearbeiterdaten
'   ====================================
    
'   Verkaufsberater + P4SBNA einf|fffd|gen
    oDoc.Bookmarks.Item("bmSbname").Select
    oDoc.Bookmarks.Item("bmSbname").Delete
    Selection.Collapse Direction:=wdCollapseEnd
    Selection.InsertAfter doSBNR.selectSingleNode("SBTName").Text & vbCrLf
    Selection.InsertAfter doSBNR.selectSingleNode("SBName").Text & vbCrLf & vbCrLf

'   Telefonnr. des Sachbearbeiters P4TELF
    If doSBNR.selectSingleNode("SBTelefon").Text <> "" Then
        Selection.InsertAfter doSBNR.selectSingleNode("SBTTelefon").Text & " " & _
        doSBNR.selectSingleNode("SBTelefon").Text & vbCrLf
    End If
    
'   Faxnr. des Sachbearbeiters P4TFAX
    If doSBNR.selectSingleNode("SBFax").Text <> "" Then
        Selection.InsertAfter doSBNR.selectSingleNode("SBTFax").Text & " " & _
        doSBNR.selectSingleNode("SBFax").Text & vbCrLf
    End If
    
'   E-Mail des Sachbearbeiters P4EMAI
    If doSBNR.selectSingleNode("SBEMail").Text <> "" Then
        Selection.InsertAfter doSBNR.selectSingleNode("SBTEMail").Text & " " & _
        doSBNR.selectSingleNode("SBEMail").Text & vbCrLf
    End If
    
    Selection.Sections.First.ProtectedForForms = True
    Selection.Collapse Direction:=wdCollapseEnd
    Selection.InsertBreak Type:=wdSectionBreakContinuous
    
'   Bereichs-Ort einf|fffd|gen P3ORTX
    oDoc.Bookmarks.Item("bmOrt").Select
    Selection.Collapse Direction:=wdCollapseEnd
    Selection.InsertAfter doSBNR.selectSingleNode("SBOrt").Text
    Selection.Sections.First.ProtectedForForms = False
    
'   Tagesdatum einf|fffd|gen
    oDoc.Bookmarks.Item("bmDatum").Select
    Selection.Collapse Direction:=wdCollapseEnd
    Selection.InsertAfter Date
    Selection.Sections.First.ProtectedForForms = False

'   Verarbeitung der Kundendaten
'   ============================
    
'   Kundennummer einf|fffd|gen AKKDNR
    oDoc.Bookmarks.Item("bmKdnr").Select
    Selection.Collapse Direction:=wdCollapseEnd
    Selection.InsertAfter doKDNR.selectSingleNode("Kundennummer").Text
    Selection.Sections.First.ProtectedForForms = False
    
'   Angebotsnummer einf|fffd|gen AKAUFN
    oDoc.Bookmarks.Item("bmAngnr").Select
    Selection.InsertBreak Type:=wdSectionBreakContinuous
    Selection.Collapse Direction:=wdCollapseEnd
    Selection.InsertAfter doKDNR.selectSingleNode("Txt1Angebot").Text & _
                        "  " & doKDNR.selectSingleNode("Angebotsnummer").Text & _
                        "  " & doKDNR.selectSingleNode("Txt2Angebot").Text
    Selection.Sections.First.ProtectedForForms = True
    Selection.Collapse Direction:=wdCollapseEnd
    Selection.InsertBreak Type:=wdSectionBreakContinuous
    Selection.Sections.First.ProtectedForForms = False
    Selection.Collapse Direction:=wdCollapseEnd

'   Kundenbestelldatum einf|fffd|gen AKKBDT
    oDoc.Bookmarks.Item("bmBDatum").Select
    Selection.Collapse Direction:=wdCollapseEnd
    If doKDNR.selectSingleNode("BDatum").Text <> "" Then
        Selection.InsertAfter doKDNR.selectSingleNode("BDatum").Text
    End If
    If doKDNR.selectSingleNode("KDBestnr").Text <> "" Then
        Selection.InsertAfter " / " & doKDNR.selectSingleNode("KDBestnr").Text
    End If
    Selection.Sections.First.ProtectedForForms = False

'   Anrede der Kontaktperson Sehr geehrte ...
'    oDoc.Bookmarks.Item("bmKPAnrede").Select
'    Selection.Collapse Direction:=wdCollapseEnd
'    Selection.InsertAfter doKDNR.selectSingleNode("KPAnrede").Text
'    Selection.Sections.First.ProtectedForForms = False

'   Kundenbestelldatum einf|fffd|gen AKPRST
    oDoc.Bookmarks.Item("bmPrst").Select
    Selection.Collapse Direction:=wdCollapseEnd
    Selection.InsertAfter doKDNR.selectSingleNode("Preisstellung").Text
    Selection.Sections.First.ProtectedForForms = False

'   Zahlungsziel des Kunden ZAZBT1 + ZAZBT2
    oDoc.Bookmarks.Item("bmZaziel").Select
    Selection.Collapse Direction:=wdCollapseEnd
    Set doKnotenListe = doKDNR.SelectNodes("Zahlungsziel")
    Selection.InsertAfter doKnotenListe.Item(0).Text
    If doKnotenListe.Length > 1 Then
        For i = 1 To doKnotenListe.Length - 1
            Selection.InsertAfter vbCrLf & vbTab & doKnotenListe.Item(i).Text
        Next
    End If
    Selection.Sections.First.ProtectedForForms = True
    
'   Katalognummer P2KTNR
    oDoc.Bookmarks.Item("bmKatalog").Select
    Selection.Collapse Direction:=wdCollapseEnd
    Selection.InsertAfter doKDNR.selectSingleNode("Katalog").Text
    Selection.Sections.First.ProtectedForForms = True

'   Kundenadresse 1 - 8 einf|fffd|gen
    strAdr = ""
    Set doKDAdrListe = Nothing
    Set doKDAdrListe = doKDNR.SelectNodes("KDAdresse")
    If doKDAdrListe.Length > 0 Then
        For Each doKDAdr In doKDAdrListe
            strAdr = strAdr + doKDAdr.Text + vbCrLf
        Next
    End If
        
    oDoc.Bookmarks.Item("bmAdr").Select
    Selection.Collapse Direction:=wdCollapseEnd
        
    Selection.InsertAfter strAdr
    
    Selection.Sections.First.ProtectedForForms = False

'   Anfangstexte
'   ============
    Set doKnotenListe = oRoot(0).SelectNodes("AnfangsText")
    oDoc.Bookmarks.Item("bmAt").Select
    Selection.Collapse Direction:=wdCollapseEnd
    
    For Each doKnoten In doKnotenListe
        Selection.InsertAfter doKnoten.Text + vbCrLf
    Next
    Selection.Sections.First.ProtectedForForms = False
    
'   Positionsdaten
'   ==============
    Dim strPos As String
    Dim strKzAlternativ As String
    Dim iPosNr As Integer
    strPos = ""
    strSvSoar = ""
    strKzAlternativ = ""
    iPosNr = 0
 
    'Auswahl der Textmarke die den Anfang der ersten Position markiert
    'Zugriff ueber das Objekt 'Selection'
    If oDoc.Bookmarks.Exists("bmPos1") Then
        oDoc.Bookmarks.Item("bmPos1").Select
        'Selection.Sections.First.ProtectedForForms = False
    End If

    For Each doPos In doPositionen
        strPos = ""
        strSoar = ""
        iPosNr = iPosNr + 1
        If doPos.selectSingleNode("KZAlternativ").Text = "X" Then
            strKzAlternativ = "X"
            strPos = doPos.selectSingleNode("TxtAlternativ").Text + vbCrLf
        End If
        strPos = strPos + doPos.selectSingleNode("Positionsnummer").Text + vbTab + _
        doPos.selectSingleNode("Menge").Text + vbTab + _
        doPos.selectSingleNode("Artikelbezeichnung1").Text + vbTab + _
        doPos.selectSingleNode("Artikelnummer").Text + vbTab + _
        doPos.selectSingleNode("Seite").Text + vbTab + _
        doPos.selectSingleNode("Einzelpreis").Text + vbTab + _
        doPos.selectSingleNode("Gesamtpreis").Text + vbTab + _
        doPos.selectSingleNode("Waehrung").Text
        
 'Artikelbezeichnung 2 und -3 in Position schreiben
        strTemp = ""
        strTemp = doPos.selectSingleNode("Artikelbezeichnung2").Text
        If strTemp <> "" Then
            strPos = strPos + vbCrLf + vbTab + vbTab + strTemp
        End If
        strTemp = ""
        strTemp = doPos.selectSingleNode("Artikelbezeichnung3").Text
        If strTemp <> "" Then
            strPos = strPos + vbCrLf + vbTab + vbTab + strTemp
        End If
 'Bei Sonderartikel einen Absatz f|fffd|r Zusatzinfos einf|fffd|gen
         If doPos.selectSingleNode("Artikelnummer").Attributes.getNamedItem("Sonderartikel").nodeValue = "J" Then
           writePosN doPos.selectSingleNode("Positionsnummer").Text, strPos, "A"
            strPos = ""
            strSoar = "J"
            strSvSoar = "J"
         End If
            
 'Zu-/Abschl|fffd|ge in Position mit aufnehmen
        Set doZuaListe = Nothing
        Set doZuaListe = doPos.SelectNodes("ZuAbschlaege")
        If doZuaListe.Length > 0 Then
            For Each doZua In doZuaListe
                'ACHTUNG: Nicht-Pflicht-Felder muessen erst abgefragt werden!
                'Wenn Sonderartikel, dann ohne CRLF, da vorher Absatz eingef|fffd|gt wurde
                If strSoar = "J" Then
                    strSoar = ""
                    strPos = vbTab + vbTab + _
                    doZua.selectSingleNode("ZABezeichnung").Text + " "
                Else
                    strPos = strPos + vbCrLf + vbTab + vbTab + _
                    doZua.selectSingleNode("ZABezeichnung").Text + " "
                End If
                strTemp = ""
                strTemp = doZua.selectSingleNode("ZAProzent").Text
                    strPos = strPos + strTemp + vbTab
                
                strPos = strPos + vbTab + vbTab + vbTab + doZua.selectSingleNode("ZAWert").Text _
                + vbTab + doPos.selectSingleNode("Waehrung").Text
            Next
            strPos = strPos + vbCrLf + vbTab + vbTab + doPos.selectSingleNode("TxtSumme").Text + vbTab + vbTab + vbTab + vbTab + _
            doPos.selectSingleNode("Summe").Text + vbTab _
            + doPos.selectSingleNode("Waehrung").Text
        End If

        If doPos.selectSingleNode("Artikelnummer").Attributes.getNamedItem("Sonderartikel").nodeValue = "N" Then
            strPos = strPos + vbCrLf + vbTab + vbTab + doPos.selectSingleNode("Lieferwochen").Text
        End If
        
        If doPos.selectSingleNode("Artikelnummer").Attributes.getNamedItem("Sonderartikel").nodeValue = "J" Then
'            strPos = strPos + vbCrLf + vbTab + vbTab + doPos.selectSingleNode("Lieferdatum").Text
            strPos = strPos + vbTab + vbTab + doPos.selectSingleNode("Lieferwochen").Text
        End If

        strTemp = ""
        strTemp = doPos.selectSingleNode("PrstPos").Text
        If strTemp <> "" Then
            strPos = strPos + vbCrLf + vbTab + vbTab + strTemp
        End If

'   Positionstexte aus LTP und ATP einf|fffd|gen
        Set doPtListe = Nothing
        Set doPtListe = doPos.SelectNodes("Positionstext")
        If doPtListe.Length > 0 Then
            strPos = strPos + vbCrLf
            For Each doPt In doPtListe
                strPos = strPos + vbCrLf + vbTab + vbTab + doPt.Text
            Next
        End If
        
        If strSvSoar = "J" Then
            writePosN doPos.selectSingleNode("Positionsnummer").Text, strPos, "B"
            strSvSoar = " "
        Else
            writePosN doPos.selectSingleNode("Positionsnummer").Text, strPos, "A"
        End If
        
        'Bild einf|fffd|gen
        Dim strBild As String
        strTemp = ""
        strBild = ""
        strTemp = doPos.selectSingleNode("URLBild").Text
        If strTemp <> "" Then
            
            strBild = doPos.selectSingleNode("Artikelnummer").Text & ".jpg"
            getPicture strTemp, strBild, doPos.selectSingleNode("Positionsnummer").Text
            
            Selection.InsertBreak Type:=wdSectionBreakContinuous
            Selection.Sections.First.ProtectedForForms = False
            Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
            
        End If
        
'       Hyperlinks f|fffd|r Massblatt und weitere Informationen einf|fffd|gen
'       =================================================================
'       Es wird unterschieden, ob der Link eingebettet oder als Hyperlink dargestellt werden soll.
      
      'Array mit Links f|fffd|llen
        Set doLnkListe = Nothing
        Set doLnkListe = doPos.SelectNodes("Positionslink")
        If doLnkListe.Length > 0 Then
            Dim strLnk As String
            Dim strInfo As String
            Dim strNr As String
            Dim l As Integer
            l = 0
            For Each doLnk In doLnkListe
                l = l + 1
                strNr = "L" & CStr(l)
                strLnk = ""
                strLnk = doLnk.selectSingleNode("PLinkUrl").Text
                strInfo = doPos.selectSingleNode("Artikelnummer").Text & ".pdf"
                If doLnk.selectSingleNode("PLinkEmbed").Text = "E" Then
                    getLnkInfo strLnk, strInfo, doPos.selectSingleNode("Positionsnummer").Text, strNr
                Else
                    oDoc.Hyperlinks.Add Anchor:=Selection.Range, Address:=strLnk, _
                    SubAddress:="", ScreenTip:="", TextToDisplay:=""
                End If
                Selection.InsertBreak Type:=wdSectionBreakContinuous
                Selection.Sections.First.ProtectedForForms = False
                Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
                Selection.InsertAfter vbCrLf
            Next
'           Markierung durch Sprung an Zeilenende aufheben und Absatz einf|fffd|gen
            Selection.EndKey Unit:=wdLine
            Selection.InsertBreak Type:=wdSectionBreakContinuous
            Selection.Sections.First.ProtectedForForms = False
        End If 'doLnkListe.Length > 0
    Next
    
'   EndeDaten einf|fffd|gen
'  ====================
    Dim strSumme As String
    strSumme = ""
  
    oDoc.Bookmarks.Item("bmSumme").Select
    'Textmarke hier l|fffd|schen, um sie weiter unten wieder hinzuf|fffd|gen zu k|fffd|nnen wegen Update-Funktion
    oDoc.Bookmarks.Item("bmSumme").Delete
    
    strSumme = vbTab + doENDE.selectSingleNode("TxtEndsumme").Text + vbTab + doENDE.selectSingleNode("EndBetrag").Text + vbTab + doENDE.selectSingleNode("EndWaehrung").Text + vbCrLf
    strSumme = strSumme + vbTab + doENDE.selectSingleNode("TxtEndsummeEuro").Text + vbTab _
                + doENDE.selectSingleNode("EndBetragEuro").Text + vbTab _
                + doENDE.selectSingleNode("EndBetragEuroWaehrung").Text + vbCrLf
    If strKzAlternativ = "X" Then
       strSumme = strSumme + vbTab + doENDE.selectSingleNode("TxtAlternativSumme").Text & vbCrLf
    End If

    If (strSumme <> "") Then
        Selection.Collapse Direction:=wdCollapseStart
        Selection.InsertBreak Type:=wdSectionBreakContinuous
        
        'Tabstops loeschen
        Selection.Paragraphs.TabStops.ClearAll
    
        'Tabstops neu festlegen
        With Selection.Paragraphs.TabStops
            .Add Position:=CentimetersToPoints(5), Alignment:=wdAlignTabLeft         'Artikelnr.
            .Add Position:=CentimetersToPoints(15.5), Alignment:=wdAlignTabDecimal   'Gesamtpreis
            .Add Position:=CentimetersToPoints(16.2), Alignment:=wdAlignTabLeft      'W|fffd|hrung
        End With
    
        'Auswahl freigeben
        Selection.Collapse Direction:=wdCollapseEnd
    
        'Text einfuegen
        Selection.InsertAfter strSumme
    
        'Abschnitt schuetzen
        Selection.Sections.First.ProtectedForForms = True
        'neue Textmarke wegen Update Funktion
        Set myBookmark = Selection.Bookmarks.Add("bmSumme")

        Selection.Collapse Direction:=wdCollapseEnd

        'neuer Absatz??
        Selection.InsertBreak Type:=wdSectionBreakContinuous
        Selection.Sections.First.ProtectedForForms = False

    End If


'   EndeTexte einf|fffd|gen
    Set doKnotenListe = oRoot(0).SelectNodes("EndeText")
    oDoc.Bookmarks.Item("bmEt").Select
    Selection.Collapse Direction:=wdCollapseEnd
         
    For Each doKnoten In doKnotenListe
        Selection.InsertAfter doKnoten.Text + vbCrLf
    Next
    
    Selection.Sections.First.ProtectedForForms = False

'       Hyperlinks f|fffd|r Massblatt und weitere Informationen am Ende einf|fffd|gen
'       =================================================================
'       Es wird unterschieden, ob der Link eingebettet oder als Hyperlink dargestellt werden soll.
        oDoc.Bookmarks.Item("bmEnde").Select
        Selection.Collapse Direction:=wdCollapseEnd
      
        'Array mit Links f|fffd|llen
        Set doLnkListe = Nothing
        Set doLnkListe = oRoot(0).SelectNodes("EndeLinks")
        If doLnkListe.Length > 0 Then
            l = 0
            For Each doLnk In doLnkListe
                l = l + 1
                strNr = "E" & CStr(l)
                strLnk = ""
                strLnk = doLnk.selectSingleNode("ELinkUrl").Text
                strInfo = doLnk.selectSingleNode("ELinkArtikel").Text & ".pdf"
                
                Selection.InsertAfter doLnk.selectSingleNode("ELinkText").Text + vbCrLf
                
                If doLnk.selectSingleNode("ELinkEmbed").Text = "E" Then
                    getLnkInfo strLnk, strInfo, doLnk.selectSingleNode("ELinkPos").Text, strNr
                Else
                    Selection.Collapse Direction:=wdCollapseEnd
                    oDoc.Hyperlinks.Add Anchor:=Selection.Range, Address:=strLnk, _
                    SubAddress:="", ScreenTip:="", TextToDisplay:=""
                End If
                
                Selection.InsertBreak Type:=wdSectionBreakContinuous
                Selection.Sections.First.ProtectedForForms = False
                Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
            
                Selection.InsertAfter vbCrLf
            Next
        End If 'doLnkListe.Length > 0
    
    'Dokumentenschutz einschalten
    oDoc.Protect Password:="Felix", NoReset:=False, Type:=wdAllowOnlyFormFields
End Sub

Private Sub writePosN(iPos As String, strPosition As String, strSoar As String)
    Dim strTemp As String
    
    'Auswahl erweitern
    Selection.Collapse Direction:=wdCollapseStart
    Selection.InsertBreak Type:=wdSectionBreakContinuous
        
    'Tabstops loeschen
    Selection.Paragraphs.TabStops.ClearAll
    
    'Tabstops neu festlegen
    With Selection.Paragraphs.TabStops
        .Add Position:=CentimetersToPoints(0), Alignment:=wdAlignTabDecimal   'Position
        .Add Position:=CentimetersToPoints(1.3), Alignment:=wdAlignTabDecimal    'Menge
        .Add Position:=CentimetersToPoints(2), Alignment:=wdAlignTabLeft         'Artikelbez.
        .Add Position:=CentimetersToPoints(9.4), Alignment:=wdAlignTabLeft       'Artikelnr.
        .Add Position:=CentimetersToPoints(11.6), Alignment:=wdAlignTabRight     'Kat. Seite
        .Add Position:=CentimetersToPoints(13.35), Alignment:=wdAlignTabDecimal  'Einzelpreis
        .Add Position:=CentimetersToPoints(15.5), Alignment:=wdAlignTabDecimal   'Gesamtpreis
        .Add Position:=CentimetersToPoints(16.2), Alignment:=wdAlignTabLeft      'W|fffd|hrung
    End With
    
    'Auswahl freigeben
    Selection.Collapse Direction:=wdCollapseEnd
    
    'Text einfuegen
    strPosition = strPosition + vbCrLf
    Selection.InsertAfter strPosition
    
    'Abschnitt schuetzen
    Selection.Sections.First.ProtectedForForms = True
    
    'neue Textmarke
    Set myBookmark = Selection.Bookmarks.Add("Position" & iPos & strSoar, Selection.Range)
    
    Selection.Collapse Direction:=wdCollapseEnd

    'neuer Absatz??
    Selection.InsertBreak Type:=wdSectionBreakContinuous
    Selection.Sections.First.ProtectedForForms = False
    
    'Loeschen des UNDO-Speichers
    oDoc.UndoClear
End Sub

Private Sub getPicture(strUrl As String, strName As String, strPos As String)
    Dim oShape As Shape
    Dim rc As Long
    'tempor|fffd|r lokal Speichern
    strpath = Options.DefaultFilePath(wdTempFilePath) & "\" & strName
    
    'Bild herunterladen
    rc = URLDownloadToFile(0, strUrl, strpath, 0, 0)
    If rc = 0 And Not Dir(strpath) = "" Then 'wenn Download des Bilds ok und vorhanden
        Application.ScreenUpdating = True
        Selection.InsertParagraphAfter
        Selection.Collapse Direction:=wdCollapseEnd
        Selection.Range.Collapse Direction:=wdCollapseStart

        ' Bild zentriert einf|fffd|gen
        Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter

        Selection.InlineShapes.AddPicture FileName:= _
        strpath, LinkToFile:=False, SaveWithDocument:=True
        Selection.TypeBackspace
        
        'neue Textmarke
        Set myBookmark = Selection.Bookmarks.Add("Bild" & strPos, Selection.Range)

        Selection.Sections.First.ProtectedForForms = False
        Selection.Collapse Direction:=wdCollapseEnd
        Application.ScreenUpdating = True
    Else
        MsgBox "Fehler beim Download des Artikelbildes " & strName & _
            vbCrLf & "(Fehlercode: " & rc & ")"
    End If
End Sub

Private Sub UpdateDoc()
    On Error Resume Next
    
    Dim oRoot As IXMLDOMNodeList
    Dim oElemNN As IXMLDOMElement
    Dim oElemData As IXMLDOMElement
    Dim oElemSubData As IXMLDOMElement
    Dim oElemKnoten As IXMLDOMNode
    Dim intCounter As Integer
  
    Dim doKnotenListe As IXMLDOMNodeList
    Dim doKnoten As IXMLDOMNode
    Dim doPositionen As IXMLDOMNodeList
    Dim doPos As IXMLDOMNode
    Dim doAbezListe As IXMLDOMNodeList
    Dim doAbez As IXMLDOMNode
    Dim doPtListe As IXMLDOMNodeList
    Dim doPt As IXMLDOMNode
    Dim doZuaListe As IXMLDOMNodeList
    Dim doZua As IXMLDOMNode
    Dim doSBNR As IXMLDOMNode
    Dim doKDNR As IXMLDOMNode
    Dim doKDAdrListe As IXMLDOMNodeList
    Dim doKDAdr As IXMLDOMNode
    Dim doENDE As IXMLDOMNode
    
    Dim strTemp As String
    Dim strAdr As String
    Dim strSoar As String
    Dim strSvSoar As String
    
    Dim i As Long
    
    oDoc.Unprotect Password:="Felix"
    Set doXML = New DOMDocument
    
    'xml-datei importieren
    doXML.async = False
    doXML.Load XMLFile
    
    Set oRoot = doXML.SelectNodes("Angebot")
    
    'Es wird davon ausgegangen, dass jede XML-Datei nur ein Angebot enthaelt
    'Sollen pro Datei mehr Angebote enthalten sein, muss hier eine for each..next-Schleife hin
    
    Set doSBNR = oRoot(0).selectSingleNode("Sachbearbeiter")
    Set doKDNR = oRoot(0).selectSingleNode("Kundendaten")
    Set doPositionen = oRoot(0).SelectNodes("Position")
    Set doENDE = oRoot(0).selectSingleNode("EndeDaten")
    
'   Positionsdaten
'   ==============
    Dim strPos As String
    Dim strKzAlternativ As String
    Dim iPosNr As Integer
    Dim iPosx As Integer
    strPos = ""
    strSvSoar = ""
    strKzAlternativ = ""
    iPosNr = 0
 
    'Auswahl der Textmarke die den Anfang der ersten Position markiert
    'Zugriff ueber das Objekt 'Selection'
    If oDoc.Bookmarks.Exists("bmPos1") Then
        oDoc.Bookmarks.Item("bmPos1").Select
        'Selection.Sections.First.ProtectedForForms = False
    Else
        MsgBox "Start-Position nicht gefunden! Verarbeitung wird abgebrochen", vbOKOnly
        GoTo Ende
    End If

    For Each doPos In doPositionen
        strPos = ""
        strSoar = ""
        iPosNr = iPosNr + 1
        iPosx = doPos.selectSingleNode("Positionsnummer").Text
        
        While (iPosNr < iPosx)
            
            If oDoc.Bookmarks.Exists("Position" + CStr(iPosNr) + "A") Then
                oDoc.Bookmarks.Item("Position" + CStr(iPosNr) + "A").Select
                Selection.Sections.First.ProtectedForForms = False
                Selection.Delete
                oDoc.Bookmarks.Item("Position" + CStr(iPosNr) + "A").Delete
            End If
            
            If oDoc.Bookmarks.Exists("Position" + CStr(iPosNr) + "B") Then
                oDoc.Bookmarks.Item("Position" + CStr(iPosNr) + "B").Select
                Selection.Sections.First.ProtectedForForms = False
                Selection.Delete
                oDoc.Bookmarks.Item("Position" + CStr(iPosNr) + "B").Delete
            End If
            
            If oDoc.Bookmarks.Exists("Bild" + CStr(iPosNr)) Then
                oDoc.Bookmarks.Item("Bild" + CStr(iPosNr)).Select
                Selection.Delete
                oDoc.Bookmarks.Item("Bild" + CStr(iPosNr)).Delete
            End If
                    
            'Links l|fffd|schen
            Dim l As Integer
            l = 0
                While l < 5
                l = l + 1
                If oDoc.Bookmarks.Exists("Link" + CStr(iPosNr) + "L" + CStr(l)) Then
                    oDoc.Bookmarks.Item("Link" + CStr(iPosNr) + "L" + CStr(l)).Select
                    Selection.Delete
                    oDoc.Bookmarks.Item("Link" + CStr(iPosNr) + "L" + CStr(l)).Delete
                End If
            Wend

            iPosNr = iPosNr + 1
        Wend
        
        If oDoc.Bookmarks.Exists("Position" + doPos.selectSingleNode("Positionsnummer").Text + "A") Then
            oDoc.Bookmarks.Item("Position" + doPos.selectSingleNode("Positionsnummer").Text + "A").Select
            Selection.Delete
            Selection.EndKey Unit:=wdLine, Extend:=wdExtend
            Selection.Delete Unit:=wdCharacter, Count:=1
        Else
            Selection.InsertBreak Type:=wdSectionBreakContinuous    'Leerzeile einf|fffd|gen f|fffd|r neue Position
        End If
        
        If doPos.selectSingleNode("KZAlternativ").Text = "X" Then
            strKzAlternativ = "X"
            strPos = doPos.selectSingleNode("TxtAlternativ").Text + vbCrLf
        End If
        strPos = strPos + doPos.selectSingleNode("Positionsnummer").Text + vbTab + _
        doPos.selectSingleNode("Menge").Text + vbTab + _
        doPos.selectSingleNode("Artikelbezeichnung1").Text + vbTab + _
        doPos.selectSingleNode("Artikelnummer").Text + vbTab + _
        doPos.selectSingleNode("Seite").Text + vbTab + _
        doPos.selectSingleNode("Einzelpreis").Text + vbTab + _
        doPos.selectSingleNode("Gesamtpreis").Text + vbTab + _
        doPos.selectSingleNode("Waehrung").Text
        
 'Artikelbezeichnung 2 und -3 in Position schreiben
        strTemp = ""
        strTemp = doPos.selectSingleNode("Artikelbezeichnung2").Text
        If strTemp <> "" Then
            strPos = strPos + vbCrLf + vbTab + vbTab + strTemp
        End If
        strTemp = ""
        strTemp = doPos.selectSingleNode("Artikelbezeichnung3").Text
        If strTemp <> "" Then
            strPos = strPos + vbCrLf + vbTab + vbTab + strTemp
        End If
 'Bei Sonderartikel einen Absatz f|fffd|r Zusatzinfos einf|fffd|gen
        If doPos.selectSingleNode("Artikelnummer").Attributes.getNamedItem("Sonderartikel").nodeValue = "J" Then
            updatePosN iPosNr, strPos, "A"
            strPos = ""
            strSoar = "J"
            strSvSoar = "J"
            If oDoc.Bookmarks.Exists("Position" + doPos.selectSingleNode("Positionsnummer").Text + "B") Then
                oDoc.Bookmarks.Item("Position" + doPos.selectSingleNode("Positionsnummer").Text + "B").Select
                Selection.Delete
                Selection.EndKey Unit:=wdLine, Extend:=wdExtend
                Selection.Delete Unit:=wdCharacter, Count:=1
            Else
                Selection.InsertBreak Type:=wdSectionBreakContinuous    'Leerzeile einf|fffd|gen f|fffd|r neue Position
            End If
        Else
            If oDoc.Bookmarks.Exists("Position" + doPos.selectSingleNode("Positionsnummer").Text + "B") Then
                oDoc.Bookmarks.Item("Position" + doPos.selectSingleNode("Positionsnummer").Text + "B").Select
                oDoc.Bookmarks.Item("Position" + doPos.selectSingleNode("Positionsnummer").Text + "B").Delete
                Selection.Delete
                Selection.EndKey Unit:=wdLine, Extend:=wdExtend
                Selection.Delete Unit:=wdCharacter, Count:=1
            End If

        End If
            
 'Zu-/Abschl|fffd|ge in Position mit aufnehmen
        Set doZuaListe = Nothing
        Set doZuaListe = doPos.SelectNodes("ZuAbschlaege")
        If doZuaListe.Length > 0 Then
            For Each doZua In doZuaListe
                'ACHTUNG: Nicht-Pflicht-Felder muessen erst abgefragt werden!
                'Wenn Sonderartikel, dann ohne CRLF, da vorher Absatz eingef|fffd|gt wurde
                If strSoar = "J" Then
                    strSoar = ""
                    strPos = vbTab + vbTab + _
                    doZua.selectSingleNode("ZABezeichnung").Text + " "
                Else
                    strPos = strPos + vbCrLf + vbTab + vbTab + _
                    doZua.selectSingleNode("ZABezeichnung").Text + " "
                End If
                strTemp = ""
                strTemp = doZua.selectSingleNode("ZAProzent").Text
                    strPos = strPos + strTemp + vbTab
                
                strPos = strPos + vbTab + vbTab + vbTab + doZua.selectSingleNode("ZAWert").Text _
                + vbTab + doPos.selectSingleNode("Waehrung").Text
            Next
            strPos = strPos + vbCrLf + vbTab + vbTab + doPos.selectSingleNode("TxtSumme").Text + vbTab + vbTab + vbTab + vbTab + _
            doPos.selectSingleNode("Summe").Text + vbTab _
            + doPos.selectSingleNode("Waehrung").Text
        End If

        If doPos.selectSingleNode("Artikelnummer").Attributes.getNamedItem("Sonderartikel").nodeValue = "N" Then
            strPos = strPos + vbCrLf + vbTab + vbTab + doPos.selectSingleNode("Lieferwochen").Text
        End If
        
        If doPos.selectSingleNode("Artikelnummer").Attributes.getNamedItem("Sonderartikel").nodeValue = "J" Then
'            strPos = strPos + vbCrLf + vbTab + vbTab + doPos.selectSingleNode("Lieferdatum").Text
            strPos = strPos + vbTab + vbTab + doPos.selectSingleNode("Lieferwochen").Text
        End If

        strTemp = ""
        strTemp = doPos.selectSingleNode("PrstPos").Text
        If strTemp <> "" Then
            strPos = strPos + vbCrLf + vbTab + vbTab + strTemp
        End If

'   Positionstexte aus LTP und ATP einf|fffd|gen
        Set doPtListe = Nothing
        Set doPtListe = doPos.SelectNodes("Positionstext")
        If doPtListe.Length > 0 Then
            strPos = strPos + vbCrLf
            For Each doPt In doPtListe
                strPos = strPos + vbCrLf + vbTab + vbTab + doPt.Text
            Next
        End If
        
        If strSvSoar = "J" Then
            updatePosN iPosNr, strPos, "B"
            strSvSoar = " "
        Else
            updatePosN iPosNr, strPos, "A"
        End If
        
        'Bild einf|fffd|gen
        If oDoc.Bookmarks.Exists("Bild" + doPos.selectSingleNode("Positionsnummer").Text) Then
            oDoc.Bookmarks.Item("Bild" + doPos.selectSingleNode("Positionsnummer").Text).Select
            Selection.Delete
            oDoc.Bookmarks.Item("Bild" + doPos.selectSingleNode("Positionsnummer").Text).Delete
        End If
       
        Dim strBild As String
        strTemp = ""
        strBild = ""
        strTemp = doPos.selectSingleNode("URLBild").Text
        If strTemp <> "" Then
            strBild = doPos.selectSingleNode("Artikelnummer").Text & ".jpg"
            getPicture strTemp, strBild, doPos.selectSingleNode("Positionsnummer").Text
            Selection.InsertBreak Type:=wdSectionBreakContinuous
            Selection.Sections.First.ProtectedForForms = False
            Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
        End If
        
'       Hyperlinks f|fffd|r Montageanleitung bzw. Zusatzinformationen einf|fffd|gen
'       =================================================================
'       Der Text wird aus der M0P |fffd|bergeben und in das Dokument eingef|fffd|gt.
        
            l = 0
                While l < 5
                l = l + 1
                If oDoc.Bookmarks.Exists("Link" + doPos.selectSingleNode("Positionsnummer").Text + "L" + CStr(l)) Then
                    oDoc.Bookmarks.Item("Link" + doPos.selectSingleNode("Positionsnummer").Text + "L" + CStr(l)).Select
                    Selection.Delete
                    oDoc.Bookmarks.Item("Link" + doPos.selectSingleNode("Positionsnummer").Text + "L" + CStr(l)).Delete
                End If
            Wend
        
        'Array mit Links f|fffd|llen
        Set doLnkListe = Nothing
        Set doLnkListe = doPos.SelectNodes("Positionslink")
        If doLnkListe.Length > 0 Then
            Dim strLnk As String
            Dim strInfo As String
            Dim strNr As String
            
            l = 0
            For Each doLnk In doLnkListe
                l = l + 1
                strNr = "L" & CStr(l)
                strLnk = ""
                strLnk = doLnk.selectSingleNode("PLinkUrl").Text
                strInfo = doPos.selectSingleNode("Artikelnummer").Text & ".pdf"
                
                If doLnk.selectSingleNode("PLinkEmbed").Text = "E" Then
                    getLnkInfo strLnk, strInfo, doPos.selectSingleNode("Positionsnummer").Text, strNr
                Else
                    oDoc.Hyperlinks.Add Anchor:=Selection.Range, Address:=strLnk, _
                    SubAddress:="", ScreenTip:="", TextToDisplay:=""
                End If
                
                Selection.InsertBreak Type:=wdSectionBreakContinuous
                Selection.Sections.First.ProtectedForForms = False
                Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
            
                Selection.InsertAfter vbCrLf
            Next
'           Markierung durch Sprung an Zeilenende aufheben und Absatz einf|fffd|gen
            Selection.EndKey Unit:=wdLine
            Selection.InsertBreak Type:=wdSectionBreakContinuous
            Selection.Sections.First.ProtectedForForms = False
        End If 'doLnkListe.Length > 0
    Next 'N|fffd|chste Position verarbeiten
    
'   Pr|fffd|fen, ob noch Positionen im Dokument stehen, die gel|fffd|scht werden m|fffd|ssen.
    iPosNr = iPosNr + 1
    While (iPosNr < 999)
        If oDoc.Bookmarks.Exists("Position" + CStr(iPosNr) + "A") Then
            oDoc.Bookmarks.Item("Position" + CStr(iPosNr) + "A").Select
            Selection.Sections.First.ProtectedForForms = False
            Selection.Delete
            oDoc.Bookmarks.Item("Position" + CStr(iPosNr) + "A").Delete
        End If
            
        If oDoc.Bookmarks.Exists("Position" + CStr(iPosNr) + "B") Then
            oDoc.Bookmarks.Item("Position" + CStr(iPosNr) + "B").Select
            Selection.Sections.First.ProtectedForForms = False
            Selection.Delete
            oDoc.Bookmarks.Item("Position" + CStr(iPosNr) + "B").Delete
        End If
        iPosNr = iPosNr + 1
    Wend

'   EndeDaten einf|fffd|gen
    Dim strSumme As String
    strSumme = ""
  
    oDoc.Bookmarks.Item("bmSumme").Select
    Selection.Delete
    oDoc.Bookmarks.Item("bmSumme").Delete
 
    strSumme = vbTab + doENDE.selectSingleNode("TxtEndsumme").Text + vbTab + doENDE.selectSingleNode("EndBetrag").Text + vbTab + doENDE.selectSingleNode("EndWaehrung").Text + vbCrLf
    strSumme = strSumme + vbTab + doENDE.selectSingleNode("TxtEndsummeEuro").Text + vbTab _
                + doENDE.selectSingleNode("EndBetragEuro").Text + vbTab _
                + doENDE.selectSingleNode("EndBetragEuroWaehrung").Text + vbCrLf
    If strKzAlternativ = "X" Then
       strSumme = strSumme + vbTab + doENDE.selectSingleNode("TxtAlternativSumme").Text & vbCrLf
    End If

    If (strSumme <> "") Then
        Selection.Collapse Direction:=wdCollapseStart
        'Tabstops loeschen
        Selection.Paragraphs.TabStops.ClearAll
    
        'Tabstops neu festlegen
        With Selection.Paragraphs.TabStops
            .Add Position:=CentimetersToPoints(5), Alignment:=wdAlignTabLeft         'Artikelnr.
            .Add Position:=CentimetersToPoints(15.5), Alignment:=wdAlignTabDecimal   'Gesamtpreis
            .Add Position:=CentimetersToPoints(16.2), Alignment:=wdAlignTabLeft      'W|fffd|hrung
        End With
    
        'Auswahl freigeben
        Selection.Collapse Direction:=wdCollapseEnd
    
        'Text einfuegen
        Selection.InsertAfter strSumme
    
        'Abschnitt schuetzen
        Selection.Sections.First.ProtectedForForms = True
    
        'neue Textmarke wegen Update Funktion
        Set myBookmark = Selection.Bookmarks.Add("bmSumme")

        Selection.Collapse Direction:=wdCollapseEnd

        'neuer Absatz??
        Selection.InsertBreak Type:=wdSectionBreakContinuous
        Selection.Sections.First.ProtectedForForms = False

    End If 'strSumme <> ""

    'Hyperlinks f|fffd|r Massblatt und weitere Informationen am Ende einf|fffd|gen
    '=================================================================
    'Es wird unterschieden, ob der Link eingebettet oder als Hyperlink dargestellt werden soll.
      
    'Alle EndeLinks l|fffd|schen
    Dim m As Integer
    m = 0
    While (m < 999)
        l = 0
        m = m + 1
        While (l < 5)
            l = l + 1
            If oDoc.Bookmarks.Exists("Link" + CStr(m) + "E" + CStr(l)) Then
                oDoc.Bookmarks.Item("Link" + CStr(m) + "E" + CStr(l)).Select
                Selection.Delete
                oDoc.Bookmarks.Item("Link" + CStr(m) + "E" + CStr(l)).Delete
            End If
        Wend
    Wend
        
    oDoc.Bookmarks.Item("bmEnde").Select
    Selection.Collapse Direction:=wdCollapseEnd
      
    'Array mit Links f|fffd|llen
    Set doLnkListe = Nothing
    Set doLnkListe = oRoot(0).SelectNodes("EndeLinks")
    If doLnkListe.Length > 0 Then
        l = 0
        For Each doLnk In doLnkListe
            l = l + 1
            strNr = "E" & CStr(l)
            strLnk = ""
            strLnk = doLnk.selectSingleNode("ELinkUrl").Text
            strInfo = doLnk.selectSingleNode("ELinkArtikel").Text & ".pdf"
            
            Selection.InsertAfter doLnk.selectSingleNode("ELinkText").Text + vbCrLf
            
            If doLnk.selectSingleNode("ELinkEmbed").Text = "E" Then
                getLnkInfo strLnk, strInfo, doLnk.selectSingleNode("ELinkPos").Text, strNr
            Else
                Selection.Collapse Direction:=wdCollapseEnd
                oDoc.Hyperlinks.Add Anchor:=Selection.Range, Address:=strLnk, _
                SubAddress:="", ScreenTip:="", TextToDisplay:=""
            End If
                
            Selection.InsertBreak Type:=wdSectionBreakContinuous
            Selection.Sections.First.ProtectedForForms = False
            Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
            
            Selection.InsertAfter vbCrLf
        Next
    End If 'doLnkListe.Length > 0

    'Dokumentenschutz einschalten
    oDoc.Protect Password:="Felix", NoReset:=False, Type:=wdAllowOnlyFormFields

Ende:      'Ende Sprungpunkt bei Fehler
    
End Sub

Private Sub updatePosN(iPos As Integer, strPosition As String, strSoar As String)
    Dim strTemp As String
    
    'Auswahl erweitern
    Selection.Collapse Direction:=wdCollapseStart
    Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
    Selection.Font.Name = "Arial"
    Selection.Font.Size = 10
    Selection.Font.Bold = False
    Selection.Font.Italic = False
    Selection.Font.Underline = wdUnderlineNone

    'Selection.InsertBreak Type:=wdSectionBreakContinuous
        
    'Tabstops loeschen
    Selection.Paragraphs.TabStops.ClearAll
    
    'Tabstops neu festlegen
    With Selection.Paragraphs.TabStops
        .Add Position:=CentimetersToPoints(0), Alignment:=wdAlignTabDecimal   'Position
        .Add Position:=CentimetersToPoints(1.3), Alignment:=wdAlignTabDecimal    'Menge
        .Add Position:=CentimetersToPoints(2), Alignment:=wdAlignTabLeft         'Artikelbez.
        .Add Position:=CentimetersToPoints(9.4), Alignment:=wdAlignTabLeft       'Artikelnr.
        .Add Position:=CentimetersToPoints(11.6), Alignment:=wdAlignTabRight     'Kat. Seite
        .Add Position:=CentimetersToPoints(13.35), Alignment:=wdAlignTabDecimal  'Einzelpreis
        .Add Position:=CentimetersToPoints(15.5), Alignment:=wdAlignTabDecimal   'Gesamtpreis
        .Add Position:=CentimetersToPoints(16.2), Alignment:=wdAlignTabLeft      'W|fffd|hrung
    End With
    
    'Auswahl freigeben
    Selection.Collapse Direction:=wdCollapseEnd
    
    'Text einfuegen
    Selection.InsertAfter strPosition + vbCrLf
    Selection.ParagraphFormat.Alignment = wdAlignParagraphLeft
    Selection.Font.Name = "Arial"
    Selection.Font.Size = 10
    Selection.Font.Bold = False
    Selection.Font.Italic = False
    Selection.Font.Underline = wdUnderlineNone
    
    'Abschnitt schuetzen
    Selection.Sections.First.ProtectedForForms = True
    
    'neue Textmarke
    Set myBookmark = Selection.Bookmarks.Add("Position" & iPos & strSoar, Selection.Range)
    
    Selection.Collapse Direction:=wdCollapseEnd

    'neuer Absatz??
    Selection.InsertBreak Type:=wdSectionBreakContinuous
    Selection.Sections.First.ProtectedForForms = False
    
    'Loeschen des UNDO-Speichers
    oDoc.UndoClear
End Sub
Private Sub getLnkInfo(strUrl As String, strName As String, strPos As String, strNr As String)
    Dim oShape As Shape
    Dim rc As Long
    'tempor|fffd|r lokal Speichern
    strpath = Options.DefaultFilePath(wdTempFilePath) & "\" & strName
    
    'PDF-Datei f|fffd|r Ma|fffd|blatt herunterladen
    rc = URLDownloadToFile(0, strUrl, strpath, 0, 0)
    If rc = 0 And Not Dir(strpath) = "" Then 'wenn Download des Ma|fffd|blatts ok und vorhanden
        Application.ScreenUpdating = True
        Selection.InsertParagraphAfter
        Selection.Collapse Direction:=wdCollapseEnd
        Selection.Range.Collapse Direction:=wdCollapseStart

        ' OLE-Objekt zentriert einf|fffd|gen
        Selection.ParagraphFormat.Alignment = wdAlignParagraphCenter
        Selection.InlineShapes.AddOLEObject ClassType:="AcroExch.Document.7", _
        FileName:=strpath, LinkToFile:=False, DisplayAsIcon:=False

        Selection.TypeBackspace
        
        'neue Textmarke
        Set myBookmark = Selection.Bookmarks.Add("Link" & strPos & strNr, Selection.Range)

        Selection.Sections.First.ProtectedForForms = False
        Selection.Collapse Direction:=wdCollapseEnd
        Application.ScreenUpdating = True
    Else
        MsgBox "Fehler beim Download des Linkes f|fffd|r Artikel " & strName & _
            vbCrLf & "(Fehlercode: " & rc & ")"
    End If
End Sub

Private Sub Document_Open()
    On Error Resume Next
    
    Dim strPfad As String
    strPfad = Environ("TEMP") + "\KZUPDT.txt"
    Dim kzUpdate As String
    Dim docName As String
    
    Open strPfad For Input As #1    ' Datei zum Lesen |fffd|ffnen.
    kzUpdate = Input(1, #1)     ' N|fffd|chstes Zeichen lesen.
    docName = Input(8, #1)      ' Die n|fffd|chsten 8 Zeichen lesen.
    Close #1    ' Datei schlie|fffd|en.
    
    Set oDoc = ThisDocument
    If Application.Documents.Count > 1 Then
        Dim i As Long
        i = 1
        Set oDoc = Application.Documents(i)
        
        While (Not oDoc.Bookmarks.Exists("bmAngnr")) And _
                i < Application.Documents.Count And _
                Not (Right$(oDoc.FullName, 12) = (Trim(docName + ".doc")))
            i = i + 1
            Set oDoc = Application.Documents(i)
        Wend
    Else
        Set oDoc = ThisDocument
    End If
    
    XMLFile = Left$(oDoc.FullName, Len(oDoc.FullName) - 3) + "xml"

    If oDoc.Bookmarks.Exists("bmSbname") Then
        ReadFile
    Else
        If kzUpdate = "U" Then
            UpdateDoc
        End If
    End If
End Sub


INQUEST-PP=macro
