Attribute VB_Name = "Common"
Option Base 0

Type RangeAmount
  Column As Integer
  Amount As Currency
End Type

Public Function CR() As String
  CR = Chr(13) + Chr(10)
End Function

Public Sub SaveToFile(FileName As String, Value As String)
  Const TristateUseDefault = -2, TristateTrue = -1, TristateFalse = 0
  Dim fs, F, ts, s
    
  Set fs = CreateObject("Scripting.FileSystemObject")
  fs.CreateTextFile FileName 'Create a file
  Set F = fs.GetFile(FileName)
  Set ts = F.OpenAsTextStream(2, TristateUseDefault)
  ts.Write Value
  ts.Close
End Sub

Public Function CurrToStr(Value As Currency) As String
  If Value <> 0 Then
    CurrToStr = CStr(FormatNumber(Value, 2, , , vbFalse))
  Else
    CurrToStr = CStr(FormatNumber(Value, 0, , , vbFalse))
  End If
End Function

Public Function CurrToStrScale(Value As Currency, Digits As Integer) As String
  If Value <> 0 Then
    CurrToStrScale = CStr(FormatNumber(Value, Digits, , , vbFalse))
  Else
    CurrToStrScale = CStr(FormatNumber(Value, 0, , , vbFalse))
  End If
End Function

Public Function CurrToKopeksStr(Value As Currency) As String
  CurrToKopeksStr = CStr(FormatNumber(Value * 100, 0, , , vbFalse))
End Function

Public Function VarToCurr(Value As Variant) As Currency
  On Error GoTo ErrHandler
  VarToCurr = CCur(Value)
  Exit Function
ErrHandler:
  VarToCurr = 0
End Function

Function GetAttribute(Elem As MSXML2.IXMLDOMElement, AttrName As String, _
Optional DefaultValue As String) As String
  GetAttribute = ""
  On Error Resume Next
  GetAttribute = Elem.GetAttribute(AttrName)
  On Error GoTo 0
  If (GetAttribute = "") And (Not IsEmpty(DefaultValue)) Then GetAttribute = DefaultValue
End Function

Public Function GetRangeByName(ByRef sh As Worksheet, ByVal Name As String, _
Optional ByRef Top As Integer, Optional ByRef Left As Integer, _
Optional ByRef Bottom As Integer, Optional ByRef Right As Integer) As Boolean
    
  Dim i As Long
  GetRangeByName = False
    
  Top = 0
  Bottom = 0
  Left = 0
  Right = 0
    
  With sh.Names
    For i = 1 To .Count
      If (.Item(i).Name = "'" + sh.Name + "'!" + Name) Or (.Item(i).Name = sh.Name + "!" + Name) Then
        With sh.Range(Name)
          Left = .Columns(1).Column
          Right = .Columns(.Columns.Count).Column
          Top = .Rows(1).Row
          Bottom = .Rows(.Rows.Count).Row
        End With
        GetRangeByName = True
        Exit For
      End If
    Next i
  End With
End Function

Public Function SetAmount(ws As Worksheet, Row As Integer, Arr() As RangeAmount) As Boolean
Dim i As Integer
  
  SetAmount = False
  For i = LBound(Arr) To UBound(Arr)
    If Arr(i).Column > 0 Then
      Arr(i).Amount = VarToCurr(ws.Cells(Row, Arr(i).Column))
    Else
      Arr(i).Amount = 0
    End If
    If Not SetAmount And (Arr(i).Amount <> 0) Then SetAmount = True
  Next i

End Function

Public Function ListToArray(Str As String, splitter As String) As Collection
  Dim pos, beg, spCount As Long, ArrCount As Long
  Dim Store As New Collection
  
  If (Str <> "") And (splitter <> "") Then
   
    spCount = Len(splitter)
    beg = 1
    ArrCount = 0
   
    Do
      pos = InStr(beg, Str, splitter)
      If pos <> 0 Then
        ArrCount = ArrCount + 1
'        If UBound(tmpArray) < ArrCount Then
'          ReDim Preserve tmpArray(UBound(tmpArray) + delta)
'        End If
'        tmpArray(ArrCount) = Mid(Str, beg, pos - beg)
        Store.Add Item:=Mid(Str, beg, pos - beg), Key:=CStr(ArrCount)
        beg = pos + spCount
      Else
'        ReDim Preserve tmpArray(ArrCount + 1)
'        tmpArray(ArrCount + 1) = Mid(Str, beg)
        ArrCount = ArrCount + 1
        Store.Add Item:=Mid(Str, beg), Key:=CStr(ArrCount)
        Exit Do
      End If
    Loop
  End If
  Set ListToArray = Store
End Function

Public Function GetNamedValue(ws As Worksheet, Name As String) As Variant
  If Not ws Is Nothing And Name <> "" Then
    On Error GoTo Err
    GetNamedValue = ws.Range(Name).Value
  End If
  Exit Function
Err:
  GetNamedValue = Empty
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| ParamStr |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Lst. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| ("&" + Symb). |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "&", |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| "&&". |fffd|
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| "&". |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'"&&" |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|.
Public Sub SplitParamsStr(ParamStr As String, Symb As String, Lst As Collection)
  Length = Len(ParamStr)
  s = ""
  i = 1
  While i <= Length
    c = Mid$(ParamStr, i, 1)
    If c = "&" Then
      If i = Length Then
        s = s & c
        Lst.Add (s)
      Else
        i = i + 1
        c1 = Mid$(ParamStr, i, 1)
        If c1 = "&" Then
          s = s & c
        ElseIf c1 = Symb Then
          Lst.Add (s)
          s = ""
        Else
          s = s & c & c1
        End If
      End If
    Else
      s = s & c
    End If
    i = i + 1
  Wend
  Lst.Add (s)
  GetParamsFromStr = ""
End Sub

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| ParamName |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| ParamStr. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
'|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| "&:", |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| "&=".
'|fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| "&", |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd|
'|fffd||fffd||fffd||fffd| "&&". |fffd||fffd||fffd||fffd||fffd||fffd|:
'GetParamFromStr(
'AUTHOR_ID&=1&:RESPPERSONS&=|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|=|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|&&:|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|=|fffd||fffd||fffd||fffd||fffd||fffd| |3f8||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|&:MODE&=1, _
'"RESPPERSONS")
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|=|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|&:|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|=|fffd||fffd||fffd||fffd||fffd||fffd| |3f8||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Function GetParamFromStr(ByVal ParamStr As String, ByVal ParamName As String) As String
  Dim s As String
  Dim Lst As New Collection
  Dim Lst1 As Collection
  GetParamsFromStr = ""
  Call SplitParamsStr(ParamStr, ":", Lst)
  i = 1
  n = Lst.Count
  While i <= n And GetParamsFromStr = ""
    s = Lst.Item(i)
    Set Lst1 = New Collection
    Call SplitParamsStr(s, "=", Lst1)
    If Lst1.Count = 2 And Lst1.Item(1) = ParamName Then GetParamFromStr = Lst1.Item(2)
    Set Lst1 = Nothing
    i = i + 1
  Wend
  Set Lst = Nothing
  GetParamsFromStr = ""
End Function

Public Sub ShowError()
  Dim msg As String
  If Err.Number <> 0 Then
    If Err.Number = 70 Then
      msg = "|fffd||fffd||fffd||fffd||fffd||fffd| #70: |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|."
      MsgBox msg, , "Error", Err.HelpFile, Err.HelpContext
    Else
      msg = "Error # " & Str(Err.Number) & " was generated by " & Err.Source & Chr(13) & Err.Description
      MsgBox msg, , "Error", Err.HelpFile, Err.HelpContext
    End If
  End If
End Sub

Attribute VB_Name = "FinTex"
Option Base 0

Public Const HEADER_TAG = "HEADER", BODY_TAG = "BODY", FOOTER_TAG = "FOOTER", _
REPFORM_CODE_ATTR = "REPFORM_CODE", PERIOD_ATTR = "PERIOD", _
REG_DATE_ATTR = "REG_DATE", REPORT_SRC_KIND_ATTR = "REPORT_SRC_KIND", _
SRC_CODE_ATTR = "SRC_CODE", PRP_ATTR = "PRP", OKATO_ATTR = "OKATO", _
TABLE_TAG = "TABLE", SECTION_NAME_ATTR = "NAME", _
FUNC_NAME_ATTR = "FUNC_NAME", RANGE_TAG = "RANGE", _
BEGIN_NAME_ATTR = "BEGIN_NAME", END_NAME_ATTR = "END_NAME", _
FILE_NAME_ATTR = "FILE_NAME", SHEET_NAME_ATTR = "SHEET_NAME", _
IS_NOT_OUT_TABLE_PREFIX = "NOT_OUT_TABLE_PREFIX", _
IS_NOT_OUT_TABLE_POSTFIX = "NOT_OUT_TABLE_POSTFIX", _
KSBU_CODE_ATTR = "KSBU_CODE", TERR_NAME_ATTR = "TERR_NAME", TERR_CODE_ATTR = "TERR_CODE", _
SECTION_CAPTION_ATTR = "SECTION_CAPTION", _
MINFIN_FORMAT = 1, UFK_FORMAT = 2, VB_CODE_ATTR = "VB_CODE"

Public Sub RunExport(wb As Workbook, XML As String)
  RunExportNew wb, XML, MINFIN_FORMAT
End Sub

Public Sub RunExportNew(wb As Workbook, XML As String, Format As Integer)
  Dim Result As String
  Dim Doc As New MSXML2.DOMDocument
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim DocElem As IXMLDOMElement
  Dim NodeList As IXMLDOMNodeList
  Dim i As Integer
  Dim Name As String
  Dim FileName As String
     
  'Set ElemHeader = Nothing
  'Set ElemBody = Nothing
  'Set ElemFooter = Nothing
  
  'XML = "<DOCUMENT><SHEET TMPSHEET='Sheet1' NEWSHEET='|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|'><RANGE REF='1,1,2,2'><ITEM REF='1,1' VALUE='GGGGG'/></RANGE></SHEET></DOCUMENT>"
  If Doc.loadXML(XML) Then
     Set DocElem = Doc.DocumentElement
     For i = 0 To DocElem.childNodes.Length - 1
       If DocElem.childNodes.Item(i).nodeType = NODE_ELEMENT Then
         Name = DocElem.childNodes(i).NodeName
         If Name = HEADER_TAG Then
           Set ElemHeader = DocElem.childNodes.Item(i)
         ElseIf Name = BODY_TAG Then
           Set ElemBody = DocElem.childNodes.Item(i)
         ElseIf Name = FOOTER_TAG Then
           Set ElemFooter = DocElem.childNodes.Item(i)
         End If
       End If
    Next i
    
    If Not ElemHeader Is Nothing And _
       Not ElemBody Is Nothing _
    Then
      If Format = MINFIN_FORMAT Then
        If ElemFooter Is Nothing Then
          Result = _
            GetHeader(ElemHeader) + _
            GetBody(wb, ElemBody, MINFIN_FORMAT)
        Else
          Result = _
            GetHeader(ElemHeader) + _
            GetBody(wb, ElemBody, MINFIN_FORMAT) + _
            GetFooter(DocElem, ElemFooter)
        End If
      End If
      If Format = UFK_FORMAT And _
         Not ElemFooter Is Nothing _
      Then
        Result = _
          GetHeaderUFK(ElemHeader) + _
          GetBody(wb, ElemBody, UFK_FORMAT) + _
          GetFooterUFK(ElemFooter)
      End If
      FileName = GetAttribute(DocElem, FILE_NAME_ATTR)
      SaveToFile FileName, Result
    
    End If
  End If
End Sub

Public Function GetHeader(Element As IXMLDOMElement) As String
'  Dim ReportCode As String, Period As String, _
'    RegDate As String, ReportSrcKind As String, SrcCode As String
  GetHeader = _
    "#%" + CR + _
    "|fffd||fffd||fffd||fffd|=" + GetAttribute(Element, REPFORM_CODE_ATTR) + CR + _
    "|fffd||fffd||fffd|=" + GetAttribute(Element, PERIOD_ATTR) + CR + _
    "|fffd||fffd||fffd|=" + GetAttribute(Element, REG_DATE_ATTR) + CR + _
    "|fffd||fffd||fffd|=" + GetAttribute(Element, REPORT_SRC_KIND_ATTR) + CR + _
    "|fffd||fffd||fffd|=" + GetAttribute(Element, SRC_CODE_ATTR) + CR
  If GetAttribute(Element, VB_CODE_ATTR) <> "" Then
    GetHeader = GetHeader + "|fffd||fffd|=" + GetAttribute(Element, VB_CODE_ATTR) + CR
  End If
  If ReportTask.ExportKSBU = True Then
    GetHeader = GetHeader + "|fffd||fffd||fffd||fffd|=" + GetAttribute(Element, KSBU_CODE_ATTR) + CR
  End If
  If GetAttribute(Element, PRP_ATTR) <> "" Then
    GetHeader = GetHeader + "|fffd||fffd||fffd|=" + GetAttribute(Element, PRP_ATTR) + CR
  End If
  If GetAttribute(Element, OKATO_ATTR) <> "" Then
    GetHeader = GetHeader + "|fffd||fffd||fffd||fffd||fffd|=" + GetAttribute(Element, OKATO_ATTR) + CR
  End If
  GetHeader = GetHeader + "#" + CR
End Function

Public Function GetHeaderUFK(Element As IXMLDOMElement) As String
'  Dim ReportCode As String, Period As String, _
'    RegDate As String, ReportSrcKind As String, SrcCode As String
  GetHeaderUFK = _
    GetAttribute(Element, TERR_NAME_ATTR) + CR + _
    "|fffd||fffd|=" + GetAttribute(Element, TERR_CODE_ATTR) + CR + _
    "|fffd||fffd|=" + GetAttribute(Element, REG_DATE_ATTR) + CR
  If GetAttribute(Element, VB_CODE_ATTR) <> "" Then
    GetHeaderUFK = GetHeaderUFK + "|fffd||fffd|=" + GetAttribute(Element, VB_CODE_ATTR) + CR
  End If
    
  If ReportTask.ExportKSBU = True Then
    GetHeaderUFK = GetHeaderUFK + "|fffd||fffd||fffd||fffd|=" + GetAttribute(Element, KSBU_CODE_ATTR) + CR
  End If
  GetHeaderUFK = GetHeaderUFK + CR
End Function

Public Function GetFooter(DocumentElement As IXMLDOMElement, Element As IXMLDOMElement) As String
  Dim UserData As String
  
  GetFooter = _
    "#&" + CR + _
    GetResppersons(DocumentElement) + _
    UserData + CR + _
    "#" + CR + _
    "#~" + CR + _
    "|fffd||fffd||fffd|=|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd| 2" + CR + _
    "#" + CR + _
    "##" + CR
End Function

Public Function GetFooterUFK(Element As IXMLDOMElement) As String
  Dim UserData As String, Comment As String
  
  GetFooterUFK = CR + _
    "|fffd||fffd|=80" + CR + _
    UserData + CR + _
    "#" + CR + _
    Comment
End Function

Public Function GetBody(wb As Workbook, Element As IXMLDOMElement, Format As Integer) As String
  Dim i As Integer
  Dim SheetName As String
  Dim ws As Worksheet
  
   For i = 0 To Element.childNodes.Length - 1
     If Element.childNodes.Item(i).nodeType = NODE_ELEMENT And _
        Element.childNodes.Item(i).NodeName = TABLE_TAG _
     Then
       SheetName = GetAttribute(Element.childNodes.Item(i), SHEET_NAME_ATTR)
       If SheetName <> "" Then
         Set ws = wb.Worksheets(SheetName)
         If Format = MINFIN_FORMAT Then
           GetBody = GetBody & ProcessB(ws, Element.childNodes.Item(i))
         End If
         If Format = UFK_FORMAT Then
           GetBody = GetBody & ProcessUFK(ws, Element.childNodes.Item(i))
         End If
       End If
     End If
   Next i
  
End Function

Public Function GetResppersons(Element As IXMLDOMElement) As String
  Dim Lst As Collection
  GetResppersons = ""
  Set Lst = New Collection
  Call SplitParamsStr(GetParamFromStr(GetAttribute(Element, "PARAMS"), "RESPPERSONS"), ":", Lst)
  n = Lst.Count
  For i = 1 To n
    If i > 1 Then GetResppersons = GetResppersons & CR
    GetResppersons = GetResppersons & Lst.Item(i)
  Next i
  Set Lst = Nothing
End Function

Private Function ProcessB(ws As Worksheet, Element As IXMLDOMElement) As String
  Dim SectionName As String, BeginRow As Integer, EndRow As Integer, funcName As String
  Dim i As Integer
  Dim RangeList As IXMLDOMNodeList
  Dim ElemRange As IXMLDOMElement
  Dim BeginName As String, EndName As String, RowData As String
    
  If IsOutTablePart(Element, IS_NOT_OUT_TABLE_PREFIX) Then
    SectionName = GetAttribute(Element, SECTION_NAME_ATTR)
    ProcessB = ProcessB + "#@" + CR + "|fffd||fffd|=" + SectionName + CR + "#$" + CR
  End If
  
  funcName = GetAttribute(Element, FUNC_NAME_ATTR)
  Set RangeList = Element.getElementsByTagName(RANGE_TAG)
  For k = 0 To RangeList.Length - 1
    Set ElemRange = RangeList.Item(k)
    BeginName = GetAttribute(ElemRange, BEGIN_NAME_ATTR)
    EndName = GetAttribute(ElemRange, END_NAME_ATTR)
    If BeginName <> "" And EndName <> "" Then
      If GetRangeByName(sh:=ws, Name:=BeginName, Top:=BeginRow) And _
         GetRangeByName(sh:=ws, Name:=EndName, Bottom:=EndRow) _
      Then
        On Error Resume Next
        For i = BeginRow To EndRow
          If funcName = "tools.xla!GetRangeRow0503117" Or funcName = "tools.xla!GetRangeRow264Year" Or funcName = "tools.xla!GetRangeRow0503127" Or funcName = "tools.xla!GetRangeRow0503137" Then
            If ws.Cells(i, 2) <> "" Then
              rowCode = ws.Cells(i, 2)
            End If
            RowData = Application.Run(funcName, ws, i, SectionName, rowCode)
          Else
            RowData = Application.Run(funcName, ws, i, SectionName)
          End If
          If RowData <> "" Then ProcessB = ProcessB + RowData + CR
        Next i
        On Error GoTo 0
      End If
    End If
  Next k

  If IsOutTablePart(Element, IS_NOT_OUT_TABLE_POSTFIX) Then
    ProcessB = ProcessB + "#" + CR
  End If
End Function

Private Function ProcessUFK(ws As Worksheet, Element As IXMLDOMElement) As String
  Dim SectionName As String, SectionCaption As String, BeginRow As Integer, EndRow As Integer, funcName As String
  Dim i As Integer
  Dim RangeList As IXMLDOMNodeList
  Dim ElemRange As IXMLDOMElement
  Dim BeginName As String, EndName As String, RowData As String, rowCode As String, data As String
    
  SectionName = GetAttribute(Element, SECTION_NAME_ATTR)
  SectionCaption = GetAttribute(Element, SECTION_CAPTION_ATTR)
  
  funcName = GetAttribute(Element, FUNC_NAME_ATTR)
  Set RangeList = Element.getElementsByTagName(RANGE_TAG)
  For k = 0 To RangeList.Length - 1
    Set ElemRange = RangeList.Item(k)
    BeginName = GetAttribute(ElemRange, BEGIN_NAME_ATTR)
    EndName = GetAttribute(ElemRange, END_NAME_ATTR)
    If BeginName <> "" And EndName <> "" Then
      If GetRangeByName(sh:=ws, Name:=BeginName, Top:=BeginRow) And _
         GetRangeByName(sh:=ws, Name:=EndName, Bottom:=EndRow) _
      Then
        On Error Resume Next
        For i = BeginRow To EndRow
          If (funcName = "tools.xla!GetRangeRow0503124" Or funcName = "tools.xla!GetRangeRow0503134" Or funcName = "tools.xla!GetRangeRow0503137") Then
            If ws.Cells(i, 2) <> "" Then
              rowCode = ws.Cells(i, 2)
            End If
            RowData = Application.Run(funcName, ws, i, SectionName, rowCode)
          Else
            RowData = Application.Run(funcName, ws, i, SectionName)
          End If
          If RowData <> "" Then data = data + RowData + CR
        Next i
        On Error GoTo 0
      End If
    End If
  Next k
  
  If (data <> "") And IsOutTablePart(Element, IS_NOT_OUT_TABLE_PREFIX) Then
    ProcessUFK = ProcessUFK + "|fffd||fffd|=" + SectionName + CR + "* " + SectionCaption + CR + data
  End If

End Function

Private Function IsOutTablePart(Elem As MSXML2.IXMLDOMElement, AttrName As String) As Boolean
  On Error GoTo ErrorHandler
  If Elem.GetAttribute(AttrName) = "1" Or UCase(Elem.GetAttribute(AttrName)) = "TRUE" Then
    IsOutTablePart = False
  Else
    IsOutTablePart = True
  End If
  Exit Function
ErrorHandler:
  IsOutTablePart = True
End Function

Attribute VB_Name = "ReportTask"
'v 2.0 |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" AMG 28/12/2005

Option Base 0
Public ExportKSBU As Boolean

Private Sub SetHeaderData(Elem As IXMLDOMElement, ws As Worksheet)
  On Error Resume Next
  Elem.setAttribute FinTex.REPFORM_CODE_ATTR, ws.Range("FORM_CODE").Value
  Elem.setAttribute FinTex.PERIOD_ATTR, ws.Range("PERIOD").Value
  Elem.setAttribute FinTex.REG_DATE_ATTR, ws.Range("REG_DATE").Value
  Elem.setAttribute FinTex.REPORT_SRC_KIND_ATTR, Range("EXPORT_SRC_KIND").Value
  Elem.setAttribute FinTex.SRC_CODE_ATTR, Range("EXPORT_SRC_CODE").Value
  Elem.setAttribute FinTex.VB_CODE_ATTR, Range("EXPORT_VB_CODE").Value
End Sub

Private Sub SetHeaderDataUFK(Elem As IXMLDOMElement, ws As Worksheet)
  On Error Resume Next
  Elem.setAttribute FinTex.TERR_NAME_ATTR, ws.Range("TERR_NAME").Value
  Elem.setAttribute FinTex.TERR_CODE_ATTR, ws.Range("TERR_CODE").Value
  Elem.setAttribute FinTex.REG_DATE_ATTR, ws.Range("REG_DATE").Value
  Elem.setAttribute FinTex.VB_CODE_ATTR, Range("EXPORT_VB_CODE").Value
End Sub

Private Sub SetFooterData(Elem As IXMLDOMElement, data As String)
  Elem.appendChild Elem.ownerDocument.createCDATASection(data)
End Sub

Private Sub SetCommonTableAttr(Element As IXMLDOMElement, SheetName As String, _
SectionName As String, funcName As String)
  Element.setAttribute FinTex.SHEET_NAME_ATTR, SheetName
  Element.setAttribute FinTex.SECTION_NAME_ATTR, SectionName
  Element.setAttribute FinTex.FUNC_NAME_ATTR, funcName
End Sub

Private Sub SetCommonTableAttrUFK(Element As IXMLDOMElement, SheetName As String, _
SectionName As String, SectionCaption As String, funcName As String)
  Element.setAttribute FinTex.SHEET_NAME_ATTR, SheetName
  Element.setAttribute FinTex.SECTION_NAME_ATTR, SectionName
  Element.setAttribute FinTex.SECTION_CAPTION_ATTR, SectionCaption
  Element.setAttribute FinTex.FUNC_NAME_ATTR, funcName
End Sub

Private Sub SetCommonRangeAttr(Element As IXMLDOMElement, BeginNameAttr As String, _
EndNameAttr As String)
    Element.setAttribute FinTex.BEGIN_NAME_ATTR, BeginNameAttr
    Element.setAttribute FinTex.END_NAME_ATTR, EndNameAttr
End Sub

Private Sub SetCommonRange(ElemTable As IXMLDOMElement, sh As Worksheet)
  On Error Resume Next
  Dim RangeNames As String
  Dim RangeColl As Collection
  Dim Element As IXMLDOMElement
  Dim x
  RangeNames = sh.Range("RANGE_NAMES").Value
  Set RangeColl = ListToArray(RangeNames, ",")
  For Each x In RangeColl
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_" & x, "REND_" & x
  Next
End Sub

Private Function GetCellTextValue(ws As Worksheet, Row As Integer, Col As Integer) As String
  GetCellTextValue = GetCellTextValueExt(ws, Row, Col, "-")
End Function

Private Function GetCellTextValueExt(ws As Worksheet, Row As Integer, Col As Integer, DefValue As String) As String
  Dim Result As String
  Result = Trim(ws.Cells(Row, Col))
  If Result = "" Or Result = "X" Or Result = "x" Or Result = "|fffd|" Or Result = "|fffd|" Then
    Result = DefValue
  End If
  GetCellTextValueExt = Result
End Function
    
'ReportForm 0521430 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|**************************************************************
Public Sub DoReport0521430Year(wb As Workbook)
  Report0521430 wb, "tools.xla!GetRangeRow430Year"
End Sub

Public Function GetRangeRow430Year(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 3).Value <> "" Then
    Dim i As Integer
    Dim Arr() As RangeAmount
    ReDim Arr(39)
    For i = 0 To 39
      Arr(i).Column = 4 + i
    Next i
    
    'Arr(0).Column = 3 + 1
    'Arr(1).Column = 4 + 1
    'Arr(2).Column = 5 + 1
    'Arr(3).Column = 6 + 1
    'Arr(4).Column = 7 + 1
    'Arr(5).Column = 8 + 1
    'Arr(6).Column = 9 + 1
    'Arr(7).Column = 10 + 1
    'Arr(8).Column = 11 + 1
    'Arr(9).Column = 12 + 1
    'Arr(10).Column = 13 + 1
    'Arr(11).Column = 14 + 1
    'Arr(12).Column = 15 + 1
    'Arr(13).Column = 16 + 1
    'Arr(14).Column = 17 + 1
    'Arr(15).Column = 18 + 1
    'Arr(16).Column = 19 + 1
    'Arr(17).Column = 20 + 1
    'Arr(18).Column = 21 + 1
    'Arr(19).Column = 22 + 1
    'Arr(20).Column = 23 + 1
    'Arr(21).Column = 24 + 1
    'Arr(22).Column = 25 + 1
    'Arr(23).Column = 26 + 1
    'Arr(24).Column = 27 + 1
    'Arr(25).Column = 28 + 1
    'Arr(26).Column = 29 + 1
    'Arr(27).Column = 30 + 1
    
    If SetAmount(ws, Row, Arr) Then
      GetRangeRow430Year = ws.Cells(Row, 3).Value + "|"
      For i = LBound(Arr) To UBound(Arr)
        GetRangeRow430Year = GetRangeRow430Year + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
  End If
End Function


'ReportForm 0521430 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|**************************************************************
Public Sub DoReport0521430(wb As Workbook)
  Report0521430 wb, "tools.xla!GetRangeRow430"
End Sub

Public Function GetRangeRow430(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 3).Value <> "" Then
    Dim i As Integer
    Dim Arr() As RangeAmount
    ReDim Arr(27)
    Arr(0).Column = 4
    Arr(1).Column = 7
    Arr(2).Column = 10
    Arr(3).Column = 11
    Arr(4).Column = 14
    Arr(5).Column = 15
    Arr(6).Column = 16
    Arr(7).Column = 17
    Arr(8).Column = 18
    Arr(9).Column = 19
    Arr(10).Column = 20
    Arr(11).Column = 21
    Arr(12).Column = 22
    Arr(13).Column = 23
    
    Arr(14).Column = 24
    Arr(15).Column = 27
    Arr(16).Column = 30
    Arr(17).Column = 31
    Arr(18).Column = 34
    Arr(19).Column = 35
    Arr(20).Column = 36
    Arr(21).Column = 37
    Arr(22).Column = 38
    Arr(23).Column = 39
    Arr(24).Column = 40
    Arr(25).Column = 41
    Arr(26).Column = 42
    Arr(27).Column = 43
    
    If SetAmount(ws, Row, Arr) Then
      GetRangeRow430 = ws.Cells(Row, 3).Value + "|"
      For i = LBound(Arr) To UBound(Arr)
        GetRangeRow430 = GetRangeRow430 + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
  End If
End Function

Private Sub Report0521430(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets("Active")
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    'Err.Raise Number:=101, Description:="|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets("Active")
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_POSTFIX, "1"
    
    ' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd|), |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets("Passive").Name, "", funcName
    SetCommonRange ElemTable, wb.Worksheets("Passive")
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_PREFIX, "1"
    
    'MsgBox Elem.XML
    RunExport wb, Elem.XML
  End If
  Exit Sub
ErrorHandler:
    ShowError
End Sub

'ReportForm 0521421 - |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub DoReport0521421Year(wb As Workbook)
  Report0521421 wb, "tools.xla!GetRangeRow421Year"
End Sub

Public Function GetRangeRow421Year(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 4).Value <> "" Then
    Dim i As Integer
    Dim Kes As String
    Dim Arr() As RangeAmount
    ReDim Arr(19)
    For i = 0 To 19
      Arr(i).Column = 6 + i
    Next i
    'Arr(0).Column = 5 + 2
    'Arr(1).Column = 6 + 2
    'Arr(2).Column = 7 + 2
    'Arr(3).Column = 8 + 2
    'Arr(4).Column = 9 + 2
    'Arr(5).Column = 10 + 2
    'Arr(6).Column = 11 + 2
    'Arr(7).Column = 12 + 2
    'Arr(8).Column = 13 + 2
    'Arr(9).Column = 14 + 2
    'Arr(10).Column = 15 + 2
    'Arr(11).Column = 16 + 2
    'Arr(12).Column = 17 + 2
    'Arr(13).Column = 18 + 2
     
    If SetAmount(ws, Row, Arr) Then
      Kes = ws.Cells(Row, 5).Value
      If Trim(Kes) = "" Then
        Kes = "000"
      End If
      
      GetRangeRow421Year = ws.Cells(Row, 4).Value + "|" + Kes + "|"
      
      For i = LBound(Arr) To UBound(Arr)
        GetRangeRow421Year = GetRangeRow421Year + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
  End If
End Function

'ReportForm 0521421 - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub DoReport0521421(wb As Workbook)
  Report0521421 wb, "tools.xla!GetRangeRow421"
End Sub

Public Function GetRangeRow421(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 4).Value <> "" Then
    Dim i As Integer
    Dim Kes As String
    Dim Arr() As RangeAmount
    ReDim Arr(13)
    Arr(0).Column = 6
    Arr(1).Column = 9
    Arr(2).Column = 12
    Arr(3).Column = 13
    Arr(4).Column = 16
    Arr(5).Column = 17
    Arr(6).Column = 18
    Arr(7).Column = 19
    Arr(8).Column = 20
    Arr(9).Column = 21
    Arr(10).Column = 22
    Arr(11).Column = 23
    Arr(12).Column = 24
    Arr(13).Column = 25
     
    If SetAmount(ws, Row, Arr) Then
      Kes = ws.Cells(Row, 5).Value
      If Trim(Kes) = "" Then
        Kes = "000"
      End If
      
      GetRangeRow421 = ws.Cells(Row, 4).Value + "|" + Kes + "|"
      
      For i = LBound(Arr) To UBound(Arr)
        GetRangeRow421 = GetRangeRow421 + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
  End If
End Function

Private Sub Report0521421(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets("Consolidated")
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    'Err.Raise Number:=101, Description:="|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets("Consolidated")
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    'MsgBox Elem.XML
    RunExport wb, Elem.XML
  End If
  Exit Sub
ErrorHandler:
    ShowError
End Sub

'ReportForm 0521428 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| *******************************************
Public Sub DoReport0521428(wb As Workbook)
  Report0521428 wb, "tools.xla!GetRangeRow428"
End Sub

'ReportForm 0521428 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| *******************************************
Public Sub DoReport0521428V(wb As Workbook)
  Report0521428 wb, "tools.xla!GetRangeRow428V"
End Sub

'ReportForm 0521428 |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| *******************************************
Public Sub DoReport0521428Year(wb As Workbook)
  Report0521428 wb, "tools.xla!GetRangeRow428Year"
End Sub

'ReportForm 0521428 |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| *******************************************
Public Sub DoReport0521428YearV(wb As Workbook)
  Report0521428 wb, "tools.xla!GetRangeRow428YearV"
End Sub

Private Sub Report0521428(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(3).Name, "03", funcName
    SetCommonRange ElemTable, ParamsSheet
    'MsgBox Elem.XML
    RunExport wb, Elem.XML
  End If
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow428(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 2).Value <> "" Or ws.Cells(Row, 3).Value <> "" Then
    Dim i As Integer, code As String, Arr() As RangeAmount, Result As String, _
    CodeRow As String
    Static LastCodeRow As String
    
    ReDim Arr(15)
    Arr(0).Column = 4
    Arr(1).Column = 5
    Arr(2).Column = 6
    Arr(3).Column = 7
    Arr(4).Column = 8
    Arr(5).Column = 9
    Arr(6).Column = 10
    Arr(7).Column = 12
    Arr(8).Column = 13
    Arr(9).Column = 14
    Arr(10).Column = 15
    Arr(11).Column = 16
    Arr(12).Column = 17
    Arr(13).Column = 18
    Arr(14).Column = 19
    Arr(15).Column = 21
    
    If SetAmount(ws, Row, Arr) Then
      code = ws.Cells(Row, 3).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      If Len(code) = 20 Then
        If SectionName = "02" Then
          code = "000" & "|" & Mid(code, 4, 4) & "|" & "0000000" & "|" & "000" & "|" & Right(code, 3)
        Else
          code = "000" & "|" & Right(code, 17)
        End If
        
      End If
      
      CodeRow = Trim(ws.Cells(Row, 2).Value)
      If Len(CodeRow) = 0 Then CodeRow = LastCodeRow Else LastCodeRow = CodeRow
      Result = CodeRow + "|" + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
    GetRangeRow428 = Result
  End If
End Function

Public Function GetRangeRow428V(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 2).Value <> "" Or ws.Cells(Row, 3).Value <> "" Then
    Dim i As Integer, code As String, Arr() As RangeAmount, Result As String, _
    CodeRow As String
    Static LastCodeRow As String
    
    ReDim Arr(15)
    Arr(0).Column = 4
    Arr(1).Column = 5
    Arr(2).Column = 6
    Arr(3).Column = 7
    Arr(4).Column = 8
    Arr(5).Column = 9
    Arr(6).Column = 10
    Arr(7).Column = 12
    Arr(8).Column = 13
    Arr(9).Column = 14
    Arr(10).Column = 15
    Arr(11).Column = 16
    Arr(12).Column = 17
    Arr(13).Column = 18
    Arr(14).Column = 19
    Arr(15).Column = 21
    
    If SetAmount(ws, Row, Arr) Then
      code = ws.Cells(Row, 3).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      If Len(code) = 20 Then
        If SectionName = "02" Then
          code = "000" & "|" & "0000" & "|" & "0000000" & "|" & "000" & "|" & Right(code, 3)
        Else
          code = "000" & "|" & Right(code, 17)
        End If
        
      End If
      
      CodeRow = Trim(ws.Cells(Row, 2).Value)
      If Len(CodeRow) = 0 Then CodeRow = LastCodeRow Else LastCodeRow = CodeRow
      Result = CodeRow + "|" + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
    GetRangeRow428V = Result
  End If
End Function

Public Function GetRangeRow428Year(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 2).Value <> "" Or ws.Cells(Row, 3).Value <> "" Then
    Dim i As Integer, code As String, Arr() As RangeAmount, Result As String, _
    CodeRow As String
    Static LastCodeRow As String
    
    ReDim Arr(17)
    Arr(0).Column = 4
    Arr(1).Column = 5
    Arr(2).Column = 6
    Arr(3).Column = 7
    Arr(4).Column = 8
    Arr(5).Column = 9
    Arr(6).Column = 10
    Arr(7).Column = 11
    Arr(8).Column = 12
    Arr(9).Column = 13
    Arr(10).Column = 14
    Arr(11).Column = 15
    Arr(12).Column = 16
    Arr(13).Column = 17
    Arr(14).Column = 18
    Arr(15).Column = 19
    Arr(16).Column = 20
    Arr(17).Column = 21
    
    If SetAmount(ws, Row, Arr) Then
      code = ws.Cells(Row, 3).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      If Len(code) = 20 Then
        If SectionName = "02" Then
          code = "000" & "|" & Mid(code, 4, 4) & "|" & Mid(code, 8, 7) & "|" & Mid(code, 15, 3) & "|" & Right(code, 3)
        Else
          code = "000" & "|" & Right(code, 17)
        End If
        
      End If
      
      CodeRow = Trim(ws.Cells(Row, 2).Value)
      If Len(CodeRow) = 0 Then CodeRow = LastCodeRow Else LastCodeRow = CodeRow
      Result = CodeRow + "|" + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
    GetRangeRow428Year = Result
  End If
End Function

Public Function GetRangeRow428YearV(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 2).Value <> "" Or ws.Cells(Row, 3).Value <> "" Then
    Dim i As Integer, code As String, Arr() As RangeAmount, Result As String, _
    CodeRow As String
    Static LastCodeRow As String
    
    ReDim Arr(17)
    Arr(0).Column = 4
    Arr(1).Column = 5
    Arr(2).Column = 6
    Arr(3).Column = 7
    Arr(4).Column = 8
    Arr(5).Column = 9
    Arr(6).Column = 10
    Arr(7).Column = 11
    Arr(8).Column = 12
    Arr(9).Column = 13
    Arr(10).Column = 14
    Arr(11).Column = 15
    Arr(12).Column = 16
    Arr(13).Column = 17
    Arr(14).Column = 18
    Arr(15).Column = 19
    Arr(16).Column = 20
    Arr(17).Column = 21
    
    If SetAmount(ws, Row, Arr) Then
      code = ws.Cells(Row, 3).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      If Len(code) = 20 Then
        If SectionName = "02" Then
          code = "000" & "|" & "0000" & "|" & "0000000" & "|" & "000" & "|" & Right(code, 3)
        Else
          code = "000" & "|" & Right(code, 17)
        End If
        
      End If
      
      CodeRow = Trim(ws.Cells(Row, 2).Value)
      If Len(CodeRow) = 0 Then CodeRow = LastCodeRow Else LastCodeRow = CodeRow
      Result = CodeRow + "|" + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
    GetRangeRow428YearV = Result
  End If
End Function

Public Function GetRangeRow414(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 2).Value <> "" Or ws.Cells(Row, 3).Value <> "" Then
    Dim i As Integer, code As String, Arr() As RangeAmount, Result As String

    ReDim Arr(2)
    Arr(0).Column = 12
    Arr(1).Column = 13
    Arr(2).Column = 14
    
    If SetAmount(ws, Row, Arr) Then
      code = ws.Cells(Row, 2).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      If Len(code) = 20 Then
        If (SectionName = "01" Or SectionName = "04" Or SectionName = "05") Then
          code = "000" & Right(code, 17)
        End If
      End If
      
      Result = code + "|" + ws.Cells(Row, 3).Value + "|" + ws.Cells(Row, 4).Value + "|"
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
    GetRangeRow414 = Result
  End If
End Function

'ReportForm 0524314 *** |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 428 ***
Public Sub DoReport0524314(wb As Workbook)
  Report0524314 wb
End Sub

Private Sub Report0524314(wb As Workbook)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim Element As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(4)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, ParamsSheet
    
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", "tools.xla!GetRangeRow414"
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_1", "REND_1"
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "02", "tools.xla!GetRangeRow414"
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_2", "REND_2"
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "04", "tools.xla!GetRangeRow414"
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_4", "REND_4"
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "05", "tools.xla!GetRangeRow414"
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_5", "REND_5"
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "06", "tools.xla!GetRangeRow414"
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_6", "REND_6"
    
    RunExport wb, Elem.XML
  End If
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow487(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 2).Value <> "" Or ws.Cells(Row, 4).Value <> "" Then
    Dim i As Integer, code As String, Arr() As RangeAmount, Result As String, _
    CodeRow As String
    Static LastCodeRow As String
    
    ReDim Arr(11)
    Arr(0).Column = 5
    Arr(1).Column = 6
    Arr(2).Column = 7
    Arr(3).Column = 8
    Arr(4).Column = 9
    Arr(5).Column = 10
    Arr(6).Column = 11
    Arr(7).Column = 12
    Arr(8).Column = 13
    Arr(9).Column = 14
    Arr(10).Column = 15
    Arr(11).Column = 16
    
    If SetAmount(ws, Row, Arr) Then
      code = ws.Cells(Row, 4).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      If Len(code) = 20 Then
        If (SectionName = "02" Or SectionName = "03") Then
          code = ""
        Else
          code = "000" & "|" & Mid(code, 4, 4) & "|" & Mid(code, 8, 7) & "|" & Mid(code, 15, 3) & "|" & Right(code, 3)
        End If
      End If
      
      CodeRow = Trim(ws.Cells(Row, 2).Value)
      If Len(CodeRow) = 0 Then CodeRow = LastCodeRow Else LastCodeRow = CodeRow
      Result = CodeRow + "|"
      If (code <> "") Then Result = Result + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
    GetRangeRow487 = Result
  End If
End Function

'ReportForm 0503387 *** |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 428  |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|***
Public Sub DoReport0503387(wb As Workbook)
  Report0503387 wb
End Sub


Private Sub Report0503387(wb As Workbook)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim Element As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(4)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, ParamsSheet
    
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", "tools.xla!GetRangeRow487"
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_1", "REND_1"
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "02", "tools.xla!GetRangeRow487"
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_2", "REND_2"
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "03", "tools.xla!GetRangeRow487"
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_3", "REND_3"
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|)
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "04", "tools.xla!GetRangeRow487"
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_4", "REND_4"
    
    RunExport wb, Elem.XML
  End If
  Exit Sub
ErrorHandler:
    ShowError
End Sub

' -------------------------- |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 72|fffd|  -------------------------------

Private Sub Report0503317(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    Elem.setAttribute "PARAMS", GetNamedValue(ParamsSheet, "PARAMS")
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(3).Name, "03", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| ConsTable
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(4).Name, "04", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

'ReportForm 0503317 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub DoReport0503317Year(wb As Workbook)
  Report0503317 wb, "tools.xla!GetRangeRow317Year"
End Sub

Public Function GetRangeRow317Year(ws As Worksheet, Row As Integer, SectionName As String) As String
  If SectionName = "04" Then
    GetRangeRow317Year = GetRangeRow317Cons(ws, Row, SectionName)
  ElseIf ws.Cells(Row, 2).Value <> "" Or ws.Cells(Row, 3).Value <> "" Then
    Dim i As Integer, code As String, Arr() As RangeAmount, Result As String, _
    rc As String, FirstCodePath As String, CodeLen As Integer
    Static LastCodeRow As String
    
    ReDim Arr(19)
    Arr(0).Column = 5
    Arr(1).Column = 6
    Arr(2).Column = 7
    Arr(3).Column = 8
    Arr(4).Column = 9
    Arr(5).Column = 10
    Arr(6).Column = 11
    Arr(7).Column = 12
    Arr(8).Column = 13
    Arr(9).Column = 14
    Arr(10).Column = 15
    Arr(11).Column = 16
    Arr(12).Column = 17
    Arr(13).Column = 18
    Arr(14).Column = 19
    Arr(15).Column = 20
    Arr(16).Column = 21
    Arr(17).Column = 22
    Arr(18).Column = 23
    Arr(19).Column = 24
    
    rc = Trim(ws.Cells(Row, 2).Value)
    If SetAmount(ws, Row, Arr) Or rc = "010" Or rc = "200" Or rc = "450" Or rc = "500" Or rc = "520" _
    Or rc = "620" Or rc = "700" Then
      code = ws.Cells(Row, 3).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      CodeLen = Len(code)
      If CodeLen = 20 Then
        FirstCodePath = Left(code, 3)
        If FirstCodePath <> "***" Then
          FirstCodePath = "000"
        End If
        If SectionName = "02" Then
          code = FirstCodePath & "|" & Mid(code, 4, 4) & "|" & Mid(code, 8, 7) & "|" & Mid(code, 15, 3) & "|" & Right(code, 3)
        Else
          code = FirstCodePath & "|" & Right(code, 17)
        End If
      ElseIf CodeLen = 0 Then
        If SectionName = "03" Then
          code = "000|00000000000000000"
        End If
      End If
      
      If Len(rc) = 0 Then rc = LastCodeRow Else LastCodeRow = rc
      Result = rc + "|" + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
    GetRangeRow317Year = Result
  End If
End Function


'ReportForm 0503317 |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub DoReport0503317Month(wb As Workbook)
  Report0503317 wb, "tools.xla!GetRangeRow317Month"
End Sub

Public Function GetRangeRow317Month(ws As Worksheet, Row As Integer, SectionName As String) As String
  If SectionName = "04" Then
    GetRangeRow317Month = GetRangeRow317Cons(ws, Row, SectionName)
  ElseIf ws.Cells(Row, 2).Value <> "" Or ws.Cells(Row, 3).Value <> "" Then
    Dim i As Integer, code As String, Arr() As RangeAmount, Result As String, _
    rc As String, FirstCodePath As String, CodeLen As Integer
    Static LastCodeRow As String
    
    ReDim Arr(19)
    Arr(0).Column = 5
    Arr(1).Column = 6
    Arr(2).Column = 7
    Arr(3).Column = 8
    Arr(4).Column = 9
    Arr(5).Column = 10
    Arr(6).Column = 11
    Arr(7).Column = 12
    Arr(8).Column = 13
    Arr(9).Column = 14
    Arr(10).Column = 15
    Arr(11).Column = 16
    Arr(12).Column = 17
    Arr(13).Column = 18
    Arr(14).Column = 19
    Arr(15).Column = 20
    Arr(16).Column = 21
    Arr(17).Column = 22
    Arr(18).Column = 23
    Arr(19).Column = 24
    
    rc = Trim(ws.Cells(Row, 2).Value)
    
    If SetAmount(ws, Row, Arr) Or rc = "010" Or rc = "200" Or rc = "450" Or rc = "500" Or rc = "520" _
    Or rc = "620" Or rc = "700" Then
      code = ws.Cells(Row, 3).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      CodeLen = Len(code)
      If CodeLen = 20 Then
        FirstCodePath = Left(code, 3)
        If FirstCodePath <> "***" Then
          FirstCodePath = "000"
        End If
        If SectionName = "02" Then
          code = FirstCodePath & "|" & Mid(code, 4, 4) & "|" & Mid(code, 8, 7) & "|" & Mid(code, 15, 3) & "|" & Right(code, 3)
        Else
          code = FirstCodePath & "|" & Right(code, 17)
        End If
      ElseIf CodeLen = 0 Then
        If SectionName = "03" Then
          code = "000|00000000000000000"
        End If
      End If
      
      If Len(rc) = 0 Then rc = LastCodeRow Else LastCodeRow = rc
      Result = rc + "|" + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
    GetRangeRow317Month = Result
  End If
End Function

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd| 0503317.
Public Function GetRangeRow317Cons(ws As Worksheet, Row As Integer, SectionName As String)
  Dim Result, code As String
  Dim i As Integer
  Dim Arr(6) As RangeAmount
  For i = 0 To 6
    Arr(i).Column = i + 4
  Next i
  If SetAmount(ws, Row, Arr) Then
    code = ws.Cells(Row, 3)
    If Len(code) > 2 Then
      Result = code + "|"
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
  End If
  GetRangeRow317Cons = Result
End Function


'ReportForm 0503314 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Public Sub DoReport0503314Year(wb As Workbook)
  Report0503314 wb, "tools.xla!GetRangeRow314Year"
End Sub

Private Sub Report0503314(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    Elem.setAttribute "PARAMS", GetNamedValue(ParamsSheet, "PARAMS")
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(3).Name, "03", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow314Year(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 2).Value <> "" Or ws.Cells(Row, 3).Value <> "" Then
    Dim i As Integer, code As String, Arr() As RangeAmount, Result As String, _
    rc As String, PPP As String, PRZ As String, KCSR As String, KVR As String, KOSGU As String
    Static LastCodeRow As String
    
    ReDim Arr(8)
    Arr(0).Column = 5
    Arr(1).Column = 6
    Arr(2).Column = 7
    Arr(3).Column = 8
    Arr(4).Column = 9
    Arr(5).Column = 10
    Arr(6).Column = 11
    Arr(7).Column = 12
    Arr(8).Column = 13
    
    rc = Trim(ws.Cells(Row, 2).Value)
    If SetAmount(ws, Row, Arr) Or rc = "010" Or rc = "200" Or rc = "450" Or rc = "500" _
     Or rc = "520" Or rc = "620" Or rc = "700" Then
      code = ws.Cells(Row, 3).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      If Len(code) = 20 Then
        PPP = Left(code, 3)
        If PPP <> "***" Then
          PPP = Left(code, 3)
        End If
        PRZ = Mid(code, 4, 4)
        KCSR = Mid(code, 8, 7)
        KVR = Mid(code, 15, 3)
        KOSGU = Right(code, 3)
        If SectionName = "02" Then
          code = PPP & "|" & PRZ & "|" & KCSR & "|" & KVR & "|" & KOSGU
        Else
          code = PPP & "|" & Right(code, 17)
        End If
        
      End If
      
      If Len(rc) = 0 Then rc = LastCodeRow Else LastCodeRow = rc
      Result = rc + "|" + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
    GetRangeRow314Year = Result
  End If
End Function

'ReportForm 0503320 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|**************************************************************
Public Sub DoReport0503320Year(wb As Workbook)
  Report0503320 wb, "tools.xla!GetRangeRow0503320Year"
End Sub

Private Sub Report0503320(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_POSTFIX, "1"
    
' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd|), |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "", funcName
    SetCommonRange ElemTable, ParamsSheet
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_PREFIX, "1"
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(3).Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(4).Name, "03", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503320Year(ws As Worksheet, Row As Integer, SectionName As String) As String
  Dim i As Integer
  Dim Arr() As RangeAmount
  If SectionName = "01" Or SectionName = "" Then
    If ws.Cells(Row, 2).Value <> "" Then
      ReDim Arr(19)
      For i = 0 To 9
        Arr(i).Column = i + 4
      Next i
      For i = 10 To 19
        Arr(i).Column = i + 6
      Next i
      If SetAmount(ws, Row, Arr) Then
        GetRangeRow0503320Year = ws.Cells(Row, 2).Value + "|"
        For i = LBound(Arr) To UBound(Arr)
          GetRangeRow0503320Year = GetRangeRow0503320Year + CurrToStr(Arr(i).Amount) + "|"
        Next i
      End If
    End If
  ElseIf SectionName = "02" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If ws.Cells(Row, 1).Value <> "1" And Trim(ws.Cells(Row, 3)) <> "" Then
      ReDim Arr(15)
      For i = 0 To 7
        Arr(i).Column = i + 4
      Next i
      For i = 8 To 15
        Arr(i).Column = i + 7
      Next i
      Call SetAmount(ws, Row, Arr)
      GetRangeRow0503320Year = ws.Cells(Row, 1) + "|" + ws.Cells(Row, 3) + "|"
      For i = LBound(Arr) To UBound(Arr)
        If ws.Cells(Row, Arr(i).Column) = "x" Then
          GetRangeRow0503320Year = GetRangeRow0503320Year + "-|"
        Else
          GetRangeRow0503320Year = GetRangeRow0503320Year + CurrToStr(Arr(i).Amount) + "|"
        End If
      Next i
    End If
  ElseIf SectionName = "03" Then
    Dim code As String
    code = ws.Cells(Row, 3)
    If code <> "" Then
      ReDim Arr(6)
      For i = LBound(Arr) To UBound(Arr)
        Arr(i).Column = i + 4
      Next i
      If SetAmount(ws, Row, Arr) Then
        GetRangeRow0503320Year = code + "|"
        For i = LBound(Arr) To UBound(Arr)
          GetRangeRow0503320Year = GetRangeRow0503320Year + CurrToStr(Arr(i).Amount) + "|"
        Next i
      End If
    End If
  End If
End Function

'ReportForm 0503321 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|**************************************************************
Public Sub DoReport0503321Year(wb As Workbook)
  Report0503321 wb, "tools.xla!GetRangeRow0503321Year"
End Sub

Private Sub Report0503321(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503321Year(ws As Worksheet, Row As Integer, SectionName As String) As String
  Dim i As Integer
  Dim Arr() As RangeAmount
  If SectionName = "01" Then
    If ws.Cells(Row, 2).Value <> "" Then
      Dim kesCode As String
      ReDim Arr(9)
      For i = 0 To 9
        Arr(i).Column = i + 7
      Next i
    
      If SetAmount(ws, Row, Arr) Then
        kesCode = ws.Cells(Row, 3).Value
        If kesCode = "" Then
          kesCode = "***"
        End If
        GetRangeRow0503321Year = ws.Cells(Row, 2).Value + "|" + kesCode + "|"
        For i = LBound(Arr) To UBound(Arr)
          GetRangeRow0503321Year = GetRangeRow0503321Year + CurrToStr(Arr(i).Amount) + "|"
        Next i
      End If
    End If
  ElseIf SectionName = "02" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Dim code As String
    code = ws.Cells(Row, 3).Value
    If Trim(code) <> "" Then
      ReDim Arr(6)
      For i = LBound(Arr) To UBound(Arr)
        Arr(i).Column = i + 4
      Next i
      If SetAmount(ws, Row, Arr) Then
        GetRangeRow0503321Year = code + "|"
        For i = LBound(Arr) To UBound(Arr)
          GetRangeRow0503321Year = GetRangeRow0503321Year + CurrToStr(Arr(i).Amount) + "|"
        Next i
      End If
    End If
  End If
End Function

'ReportForm 0503387 *** |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| 0503317  |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|***
Public Sub DoReport0503387_72N(wb As Workbook)
  Report0503387_72N wb
End Sub


Private Sub Report0503387_72N(wb As Workbook)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim Element As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(5)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, ParamsSheet
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", "tools.xla!GetRangeRow487_72N"
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_1", "REND_1"
    RunExport wb, Elem.XML
  End If
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow487_72N(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 2).Value <> "" Or ws.Cells(Row, 4).Value <> "" Then
    Dim i As Integer, code As String, Arr() As RangeAmount, Result As String, _
    CodeRow As String
    Static LastCodeRow As String
    
    ReDim Arr(23)
    Arr(0).Column = 5
    Arr(1).Column = 6
    Arr(2).Column = 7
    Arr(3).Column = 8
    Arr(4).Column = 9
    Arr(5).Column = 10
    Arr(6).Column = 11
    Arr(7).Column = 12
    Arr(8).Column = 13
    Arr(9).Column = 14
    Arr(10).Column = 15
    Arr(11).Column = 16
    Arr(12).Column = 17
    Arr(13).Column = 18
    Arr(14).Column = 19
    Arr(15).Column = 20
    Arr(16).Column = 21
    Arr(17).Column = 22
    Arr(18).Column = 23
    Arr(19).Column = 24
    Arr(20).Column = 25
    Arr(21).Column = 26
    Arr(22).Column = 27
    Arr(23).Column = 28
    
    If SetAmount(ws, Row, Arr) Then
      code = ws.Cells(Row, 4).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      If Len(code) = 20 Then
        code = "000" & "|" & Mid(code, 4, 4) & "|" & Mid(code, 8, 7) & "|" & Mid(code, 15, 3) & "|" & Right(code, 3)
      End If
      
      CodeRow = Trim(ws.Cells(Row, 2).Value)
      If Len(CodeRow) = 0 Then CodeRow = LastCodeRow Else LastCodeRow = CodeRow
      Result = CodeRow + "|"
      If (code <> "") Then Result = Result + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
    GetRangeRow487_72N = Result
  End If
End Function


'ReportForm 0503125 **************************************************************
Public Sub DoReport0503125Year(wb As Workbook)
  Report0503125 wb, "tools.xla!GetRangeRow0503125Year"
End Sub

Public Sub DoReport0503125GRBS(wb As Workbook)
  Report0503125GRBS wb, "tools.xla!GetRangeRow0503125GRBS"
End Sub


Private Sub Report0503125(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    ElemHeader.setAttribute FinTex.KSBU_CODE_ATTR, ParamsSheet.Range("KSBU_CODE").Value
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    ExportKSBU = True
    RunExport wb, Elem.XML
  End If
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Private Sub Report0503125GRBS(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", Replace(GetNamedValue(ParamsSheet, "FILE_NAME"), "425", "225"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    ElemHeader.setAttribute FinTex.REPFORM_CODE_ATTR, "225"
    ElemHeader.setAttribute FinTex.KSBU_CODE_ATTR, ParamsSheet.Range("KSBU_CODE").Value
    ElemHeader.setAttribute FinTex.REPORT_SRC_KIND_ATTR, Range("EXPORT_PARAM_SRC_KIND").Value
    ElemHeader.setAttribute FinTex.SRC_CODE_ATTR, Range("KADM").Value
    ElemHeader.setAttribute FinTex.PRP_ATTR, "500"
    ElemHeader.setAttribute FinTex.OKATO_ATTR, Range("SUBJ_OKATO").Value
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    ExportKSBU = True
    RunExportNew wb, Elem.XML, FinTex.MINFIN_FORMAT
  End If
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503125Year(ws As Worksheet, Row As Integer, SectionName As String) As String
    Dim i As Integer
    Dim Sums() As RangeAmount
    Dim OKATO1 As String
    Dim OKATO2 As String
    Dim PPP As String
    Dim EL As String
    Dim KIF As String
    Dim Account As String
    Dim Kes As String
    Dim NSBU() As String '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Dim tmp As String
    Dim isTotalRow As Boolean
    
    If ws.Range("RBEGIN_01").Row = Row Then
      isTotalRow = True
    Else
      isTotalRow = False
    End If
    
    ReDim Sums(2)
    Sums(0).Column = 6
    Sums(1).Column = 7
    
    ReDim NSBU(12)
    If SetAmount(ws, Row, Sums) Or isTotalRow Then
      
      NSBU(0) = ws.Range("SUBJ_OKATO").Value '|fffd||fffd||fffd||fffd||fffd|1
      If NSBU(0) = "" Or isTotalRow Then
        NSBU(0) = "********"
      End If
      
      NSBU(1) = ws.Cells(Row, 2) '|fffd||fffd||fffd|
      If NSBU(1) = "" Or isTotalRow Then
        NSBU(1) = "***"
      End If
      
      NSBU(2) = ws.Cells(Row, 3) '|fffd||fffd||fffd||fffd||fffd|2
      If NSBU(2) = "" Or isTotalRow Then
        NSBU(2) = "********"
      End If
      
      NSBU(3) = ws.Cells(Row, 4) '|fffd||fffd| - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
      If NSBU(3) = "" Or isTotalRow Then
        NSBU(3) = "**"
      End If
            
      tmp = ws.Cells(Row, 5).Value
      If Len(tmp) < 9 Or isTotalRow Then
        NSBU(4) = "***"                           '|fffd||fffd||fffd|
        NSBU(5) = "**************"                '|fffd||fffd||fffd|
        NSBU(6) = "*"                             '|fffd||fffd||fffd|
        NSBU(7) = "*****"                         '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        NSBU(8) = "***"                           '|fffd||fffd||fffd||fffd||fffd|
      ElseIf Len(tmp) < 26 Then
        tmp = Replace(tmp, ".", "")
        tmp = Replace(tmp, " ", "")
        tmp = Right(tmp, 9)
        NSBU(4) = "***"                           '|fffd||fffd||fffd|
        NSBU(5) = "**************"                '|fffd||fffd||fffd|
        NSBU(6) = Mid(tmp, 1, 1)                  '|fffd||fffd||fffd|
        NSBU(7) = Mid(tmp, 2, 5)                  '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        NSBU(8) = Right(tmp, 3)                   '|fffd||fffd||fffd||fffd||fffd|
      Else
        tmp = Replace(tmp, ".", "")
        tmp = Replace(tmp, " ", "")
        NSBU(4) = Mid(tmp, Len(tmp) - 26 + 1, 3)  '|fffd||fffd||fffd|
        NSBU(5) = Mid(tmp, Len(tmp) - 23 + 1, 14) '|fffd||fffd||fffd|
        NSBU(6) = Mid(tmp, Len(tmp) - 9 + 1, 1)   '|fffd||fffd||fffd|
        NSBU(7) = Mid(tmp, Len(tmp) - 8 + 1, 5)   '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        NSBU(8) = Right(tmp, 3)                   '|fffd||fffd||fffd||fffd||fffd|
      End If
      
      tmp = ws.Cells(Row, 8).Value
      If Len(tmp) < 9 Or isTotalRow Then
        NSBU(9) = "*"               '|fffd||fffd||fffd|
        NSBU(10) = "*****"          '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        NSBU(11) = "***"            '|fffd||fffd||fffd||fffd||fffd|
      Else
        tmp = Replace(tmp, ".", "")
        tmp = Replace(tmp, " ", "")
        NSBU(9) = Mid(tmp, Len(tmp) - 9 + 1, 1)
        NSBU(10) = Mid(tmp, Len(tmp) - 8 + 1, 5)
        NSBU(11) = Right(tmp, 3)
      End If
            
      
      GetRangeRow0503125Year = "|" + Join(NSBU, "|")
      For i = LBound(Sums) To UBound(Sums) - 1
        GetRangeRow0503125Year = GetRangeRow0503125Year + CurrToStr(Sums(i).Amount) + "|"
      Next i
    End If
End Function

Public Function GetRangeRow0503125GRBS(ws As Worksheet, Row As Integer, SectionName As String) As String
    Dim i As Integer
    Dim Sums() As RangeAmount
    Dim tmp As String
    Dim isTotalRow As Boolean
    
    If ws.Range("RBEGIN_01").Row = Row Then
      isTotalRow = True
    Else
      isTotalRow = False
    End If
    
    ReDim Sums(1)
    Sums(0).Column = 6
    Sums(1).Column = 7
    
    ReDim NSBU(10)
    If SetAmount(ws, Row, Sums) Or isTotalRow Then
      
      NSBU(0) = ws.Cells(Row, 2) '|fffd||fffd||fffd|
      If NSBU(0) = "" Or isTotalRow Then
        NSBU(0) = "***"
      End If
      
      NSBU(1) = ws.Cells(Row, 3) '|fffd||fffd||fffd||fffd||fffd|
      If NSBU(1) = "" Or isTotalRow Then
        NSBU(1) = "********"
      End If
      
      NSBU(2) = ws.Cells(Row, 4) '|fffd||fffd| - |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
      If NSBU(2) = "" Or isTotalRow Then
        NSBU(2) = "**"
      End If
      
      tmp = ws.Cells(Row, 5).Value
      If Len(tmp) < 9 Or isTotalRow Then
        NSBU(3) = "***"                           '|fffd||fffd||fffd| 2
        NSBU(4) = "**************"                '|fffd||fffd||fffd|
        NSBU(5) = "*"                             '|fffd||fffd||fffd||fffd|
        NSBU(6) = "*****"                         '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        NSBU(7) = "***"                           '|fffd||fffd||fffd||fffd||fffd|
      ElseIf Len(tmp) < 26 Then
        tmp = Replace(tmp, ".", "")
        tmp = Replace(tmp, " ", "")
        tmp = Right(tmp, 9)
        NSBU(3) = "***"                           '|fffd||fffd||fffd| 2
        NSBU(4) = "**************"                '|fffd||fffd||fffd|
        NSBU(5) = Mid(tmp, 1, 1)                  '|fffd||fffd||fffd||fffd|
        NSBU(6) = Mid(tmp, 2, 5)                  '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        NSBU(7) = Right(tmp, 3)                   '|fffd||fffd||fffd||fffd||fffd|
      Else
        tmp = Replace(tmp, ".", "")
        tmp = Replace(tmp, " ", "")
        NSBU(3) = Mid(tmp, 1, 3)                  '|fffd||fffd||fffd| 2
        NSBU(4) = Mid(tmp, Len(tmp) - 23 + 1, 14) '|fffd||fffd||fffd|
        NSBU(5) = Mid(tmp, Len(tmp) - 9 + 1, 1)   '|fffd||fffd||fffd||fffd|
        NSBU(6) = Mid(tmp, Len(tmp) - 8 + 1, 5)   '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        NSBU(7) = Right(tmp, 3)                   '|fffd||fffd||fffd||fffd||fffd|
      End If
      
      tmp = ws.Cells(Row, 8).Value
      If Len(tmp) < 9 Or isTotalRow Then
        NSBU(8) = "*"               '|fffd||fffd||fffd|
        NSBU(9) = "*****"           '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        NSBU(10) = "***"             '|fffd||fffd||fffd||fffd||fffd|
      Else
        tmp = Replace(tmp, ".", "")
        tmp = Replace(tmp, " ", "")
        NSBU(8) = Mid(tmp, Len(tmp) - 9 + 1, 1)
        NSBU(9) = Mid(tmp, Len(tmp) - 8 + 1, 5)
        NSBU(10) = Right(tmp, 3)
      End If
            
      
      GetRangeRow0503125GRBS = "|" + Join(NSBU, "|") + "|"
      For i = LBound(Sums) To UBound(Sums)
        GetRangeRow0503125GRBS = GetRangeRow0503125GRBS + CurrToStr(Sums(i).Amount) + "|"
      Next i
    End If
End Function

'ReportForm 0503182
Public Sub DoReport0503182(wb As Workbook, metodName As String)
  ReportPZ wb, metodName
End Sub

'ReportForm 0503164
Public Sub DoReport0503164(wb As Workbook, metodName As String)
  ReportPZ wb, metodName
End Sub

'ReportForm 0503179
Public Sub DoReport0503179(wb As Workbook, metodName As String)
  ReportPZ wb, metodName
End Sub

Public Function GetRangeRow264Year(ws As Worksheet, Row As Integer, SectionName As String, _
    rowCode As String) As String
  Dim isTotalRow As Boolean
  Dim code As String
  Dim Sums() As RangeAmount
  Dim Description As String
  If Trim(ws.Cells(Row, 1)) = "|fffd||fffd| |fffd||fffd||fffd|" Then
    Exit Function
  End If
  If ws.Range("RBEGIN_1").Row = Row Then
    isTotalRow = True
  End If
  '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If SectionName = "01" Then
    If isTotalRow Then
      GetRangeRow264Year = "010|***|85000000000000000|"
    Else
      code = ws.Cells(Row, 1)
      If rowCode <> "" Then
        GetRangeRow264Year = rowCode + "|" + Mid(code, 1, 3) + "|" + Mid(code, 5, 14) + Mid(code, 20, 3) + "|"
      End If
    End If
  Else
    '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If SectionName = "02" Then
      If isTotalRow Then
        GetRangeRow264Year = "200|***|9600|0000000|000|000|"
      Else
        If ws.Range("REND_1").Row = Row Then
          GetRangeRow264Year = "450|***|7900|0000000|000|000|"
        Else
          code = ws.Cells(Row, 1)
          If rowCode <> "" Then
            GetRangeRow264Year = rowCode + "|" + Mid(code, 1, 3) + "|" + Mid(code, 5, 4) + "|" + Mid(code, 10, 7) + "|" + _
                Mid(code, 18, 3) + "|" + Mid(code, 22, 3) + "|"
          End If
        End If
      End If
    Else
      '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
      If SectionName = "03" Then
        If isTotalRow Then
          GetRangeRow264Year = "500|***|90000000000000000|"
        Else
          code = ws.Cells(Row, 1)
          If rowCode <> "" Then
            If Trim(ws.Cells(Row, 2)) = "" Then
              GetRangeRow264Year = rowCode + "|" + Mid(code, 1, 3) + "|" + Mid(code, 5, 14) + Mid(code, 20, 3) + "|"
            Else
              If rowCode = "520" Then
                code = "|***|01000000000000000|"
              Else
                If rowCode = "620" Then
                  code = "|***|02000000000000000|"
                Else
                  code = "|***|*****************|"
                  rowCode = ""
                End If
              End If
              GetRangeRow264Year = rowCode + code
            End If
          End If
        End If
      End If
    End If
  End If
  ReDim Sums(4)
  For i = 1 To 4
    Sums(i).Column = i + 2
  Next i
  
  If GetRangeRow264Year <> "" And SetAmount(ws, Row, Sums) Then
    For i = 1 To UBound(Sums)
      GetRangeRow264Year = GetRangeRow264Year + CurrToStr(Sums(i).Amount) + "|"
    Next i
  Description = ws.Cells(Row, 7)
  If Description = "" Then
    Description = "-"
  End If
    GetRangeRow264Year = GetRangeRow264Year + Description + "|"
  End If
  
End Function


Public Function GetRangeRow280Year(ws As Worksheet, Row As Integer, SectionName As String) As String
  Dim isTotalRow As Boolean
  Dim code As String
  Dim rowCode As String
  Dim Amount As String
  Dim Description As String
  Dim Sums() As RangeAmount
  Dim i As Integer
  If ws.Range("RBEGIN_1").Row = Row Then
    isTotalRow = True
  End If
  '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If SectionName = "01" Then
    If isTotalRow Then
      GetRangeRow280Year = "***|850|00000|00|0000|000|010|"
    Else
      code = Replace(Replace(ws.Cells(Row, 1), ".", ""), " ", "")
      rowCode = ws.Cells(Row, 2)
      If rowCode <> "" Then
        GetRangeRow280Year = Mid(code, 1, 3) + "|" + Mid(code, 4, 3) + "|" + Mid(code, 7, 5) + "|" + _
            Mid(code, 12, 2) + "|" + Mid(code, 14, 4) + "|" + Mid(code, 18, 3) + "|" + rowCode + "|"
      End If
    End If
  Else
    '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If SectionName = "02" Then
      If isTotalRow Then
        GetRangeRow280Year = "***|9600|0000000|000|000|200|"
      Else
        If ws.Range("REND_1").Row = Row Then
          GetRangeRow280Year = "***|7900|0000000|000|000|450|"
        Else
          code = Replace(Replace(ws.Cells(Row, 1), ".", ""), " ", "")
          rowCode = ws.Cells(Row, 2)
          If rowCode <> "" Then
            GetRangeRow280Year = Mid(code, 1, 3) + "|" + Mid(code, 4, 4) + "|" + Mid(code, 8, 7) + "|" + _
                Mid(code, 15, 3) + "|" + Mid(code, 18, 3) + "|" + rowCode + "|"
          End If
        End If
      End If
    Else
      '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
      If SectionName = "03" Then
        If isTotalRow Then
          GetRangeRow280Year = "***|9000|0000|00|0000|000|500|"
        Else
          code = Replace(Replace(ws.Cells(Row, 1), ".", ""), " ", "")
          rowCode = ws.Cells(Row, 2)
          If rowCode <> "" Then
            GetRangeRow280Year = Mid(code, 1, 3) + "|" + Mid(code, 4, 4) + "|" + Mid(code, 8, 4) + "|" + _
            Mid(code, 12, 2) + "|" + Mid(code, 14, 4) + "|" + Mid(code, 18, 3) + "|" + rowCode + "|"
          End If
        End If
      End If
    End If
  End If
  ReDim Sums(4)
  For i = 1 To 4
    Sums(i).Column = i + 2
  Next i
  
  If GetRangeRow280Year <> "" And SetAmount(ws, Row, Sums) Then
    For i = 1 To UBound(Sums)
      GetRangeRow280Year = GetRangeRow280Year + CurrToStr(Sums(i).Amount) + "|"
    Next i
    Description = ws.Cells(Row, 7)
    If Description = "" Then
      Description = "-"
    End If
    GetRangeRow280Year = GetRangeRow280Year + Description + "|"
  End If
End Function

Public Function GetRangeRow279Year(ws As Worksheet, Row As Integer, SectionName As String) As String
  Dim isTotalRow As Boolean
  Dim code As String
  Dim rowCode As String
  Dim Amount As String
  Dim Description As String
  Dim Sums() As RangeAmount
  Dim i As Integer
  If ws.Range("RBEGIN_1").Row = Row Then
    isTotalRow = True
  End If
  '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
  If SectionName = "01" Then
    If isTotalRow Then
      GetRangeRow279Year = "000|850|00000|00|0000|000|010|"
    Else
      code = ws.Cells(Row, 1)
      rowCode = ws.Cells(Row, 2)
      If rowCode <> "" Then
        GetRangeRow279Year = Mid(code, 1, 3) + "|" + Mid(code, 5, 1) + Mid(code, 7, 2) + "|" + Mid(code, 10, 5) + "|" + _
            Mid(code, 16, 2) + "|" + Mid(code, 19, 4) + "|" + Mid(code, 24, 3) + "|" + rowCode + "|"
      End If
    End If
  Else
    '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If SectionName = "02" Then
      If isTotalRow Then
        GetRangeRow279Year = "000|9600|0000000|000|000|200|"
      Else
        If ws.Range("REND_1").Row = Row Then
          GetRangeRow279Year = "000|7900|0000000|000|000|450|"
        Else
          code = Replace(ws.Cells(Row, 1), ".", "")
          rowCode = ws.Cells(Row, 2)
          If rowCode <> "" Then
            GetRangeRow279Year = Mid(code, 1, 3) + "|" + Mid(code, 5, 4) + "|" + Mid(code, 10, 7) + "|" + Mid(code, 18, 3) + "|" + _
                Mid(code, 22, 3) + "|" + rowCode + "|"
          End If
        End If
      End If
    Else
      '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
      If SectionName = "03" Then
        If isTotalRow Then
          GetRangeRow279Year = "000|9000|0000|00|0000|000|500|"
        Else
          code = ws.Cells(Row, 1)
          rowCode = ws.Cells(Row, 2)
          If rowCode <> "" Then
            GetRangeRow279Year = Mid(code, 1, 3) + "|" + Mid(code, 4, 2) + Mid(code, 7, 2) + "|" + Mid(code, 10, 4) + "|" + _
                Mid(code, 15, 2) + "|" + Mid(code, 18, 4) + "|" + Mid(code, 23, 3) + "|" + rowCode + "|"
          End If
        End If
      End If
    End If
  End If
  ReDim Sums(10)
  For i = 1 To 10
    Sums(i).Column = i + 2
  Next i
  
  If GetRangeRow279Year <> "" And SetAmount(ws, Row, Sums) Then
    For i = 1 To UBound(Sums)
      GetRangeRow279Year = GetRangeRow279Year + CurrToStr(Sums(i).Amount) + "|"
    Next i
  End If
End Function

Private Sub ReportPZ(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
   
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    'Doc.Save "c:\asd.xml"
    
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(3).Name, "03", funcName
    SetCommonRange ElemTable, ParamsSheet
    'Doc.Save "c:\asd.xml"
    RunExport wb, Elem.XML
  End If
  
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
      
  Exit Sub
ErrorHandler:
    ShowError
End Sub

'ReportForm 0503323 **************************************************************
Public Sub DoReport0503323(wb As Workbook)
  Report0503323 wb, "tools.xla!GetRangeRow0503323"
End Sub


Private Sub Report0503323(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim Element As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_01", "REND_01"
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "02", funcName
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_02", "REND_02"
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "03", funcName
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_03", "REND_03"
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(3).Name, "04", funcName
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_1", "REND_1"
    
    RunExport wb, Elem.XML
  End If
  
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503323(ws As Worksheet, Row As Integer, SectionName As String) As String
  Dim i As Integer
  Dim Result As String
  Dim rowCode As String
  Dim Arr() As RangeAmount
  If SectionName = "04" Then
    rowCode = ws.Cells(Row, 3)
    If Trim(rowCode) <> "" Then
      ReDim Arr(6)
      For i = LBound(Arr) To UBound(Arr)
        Arr(i).Column = i + 4
      Next i
      If SetAmount(ws, Row, Arr) Then
        Result = rowCode + "|"
        For i = LBound(Arr) To UBound(Arr)
          Result = Result + CurrToStr(Arr(i).Amount) + "|"
        Next i
      End If
    End If
  ElseIf ws.Cells(Row, 2).Value <> "" Then
    Dim j As Integer, kesCode As String
    
    rowCode = ws.Cells(Row, 2)
    kesCode = ws.Cells(Row, 3)
    If kesCode = "" Then
        kesCode = "***"
    End If
      
    ReDim Arr(9)
    For i = 0 To 9
      Arr(i).Column = i + 6
    Next i
    
    If SetAmount(ws, Row, Arr) Then
      Result = rowCode + "|" + kesCode + "|"
      For j = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(j).Amount) + "|"
      Next j
    End If
  End If
  GetRangeRow0503323 = Result
End Function

'ReportForm 0503110 **************************************************************
Public Sub DoReport0503110(wb As Workbook)
  Report0503110 wb, "tools.xla!GetRangeRow0503110"
End Sub


Private Sub Report0503110(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets("|fffd|.110-1")
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets("|fffd|.110-1")
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd||fffd||fffd|
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_POSTFIX, "1"
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets("|fffd|.110-2").Name, "01", funcName
    SetCommonRangeAttr ElemTable, "RBEGIN_01", "REND_01"
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_PREFIX, "1"
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_POSTFIX, "1"
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets("|fffd|.110-2").Name, "02", funcName
    SetCommonRangeAttr ElemTable, "RBEGIN_01", "REND_01"
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_PREFIX, "1"
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "03", funcName
    SetCommonRange ElemTable, ParamsSheet
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_POSTFIX, "1"
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets("|fffd|.110-2").Name, "03", funcName
    SetCommonRangeAttr ElemTable, "RBEGIN_01", "REND_01"
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_PREFIX, "1"
    
    '|fffd||fffd||fffd||fffd||fffd|
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "04", funcName
    SetCommonRange ElemTable, ParamsSheet
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_POSTFIX, "1"
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets("|fffd|.110-2").Name, "", funcName
    SetCommonRange ElemTable, ParamsSheet
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_PREFIX, "1"
    
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503110(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Range("RBEGIN_01").Row <> Row Then
    Dim i As Integer, j As Integer, n As Integer, Arr() As RangeAmount, Result As String
    
    n = 15
    ReDim Arr(n)
    For i = 0 To n
      Arr(i).Column = i + 2
    Next i
    
    code = ws.Cells(Row, 1).Value
    If SetAmount(ws, Row, Arr) Or (Trim(code) <> "" And Trim(code) <> "|fffd||fffd||fffd||fffd||fffd|:") Then
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
    Else
      If Trim(code) <> "|fffd||fffd||fffd||fffd||fffd|:" Then code = ""
    End If
         
         
    anal_kind = Trim(ws.Cells(Row, 11).Value)
    If anal_kind <> "" And Replace(Trim(SectionName), "0", "") = anal_kind Then
 
      Select Case anal_kind
        Case "1"
          code = Mid(code, 1, 3) & "|" & Mid(code, 4, 3) & "|" & Mid(code, 7, 5) & "|" & Mid(code, 12, 2) & "|" & Mid(code, 14, 4) & "|" & Mid(code, 18, 1) & "|" & Mid(code, 19, 5) & "|" & Mid(code, 24, 3)
        Case "2"
          code = Mid(code, 1, 3) & "|" & Mid(code, 4, 4) & "|" & Mid(code, 8, 7) & "|" & Mid(code, 15, 3) & "|" & Mid(code, 18, 1) & "|" & Mid(code, 19, 5) & "|" & Mid(code, 24, 3)
        Case "3"
          code = Mid(code, 1, 3) & "|" & Mid(code, 4, 4) & "|" & Mid(code, 8, 4) & "|" & Mid(code, 12, 2) & "|" & Mid(code, 14, 4) & "|" & Mid(code, 18, 1) & "|" & Mid(code, 19, 5) & "|" & Mid(code, 24, 3)
      End Select
    Else
      If (Trim(code) = "|fffd||fffd||fffd||fffd||fffd|:" And SectionName = "04") Then
        code = "***|**************|*|*****|***"
      Else
        code = ""
      End If
    End If
    
    If code <> "" Then
      Result = code + "|"
      For j = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(j).Amount) + "|"
      Next j
    Else
      Result = ""
    End If
    
    GetRangeRow0503110 = Result
  End If
End Function

'ReportForm 0503121 **************************************************************
Public Sub DoReport0503121(wb As Workbook)
  Report0503121 wb, "tools.xla!GetRangeRow0503121"
End Sub


Private Sub Report0503121(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503121(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 2).Value <> "" Then
    Dim i As Integer, j As Integer, Arr() As RangeAmount, Result As String, rowCode As String, kesCode As String
    
    rowCode = ws.Cells(Row, 2)
    kesCode = ws.Cells(Row, 3)
    If kesCode = "" Then
        kesCode = "***"
    End If
      
    ReDim Arr(2)
    Arr(0).Column = 8
    Arr(1).Column = 10
    Arr(2).Column = 11
    If SetAmount(ws, Row, Arr) Then
      Result = rowCode + "|" + kesCode + "|"
      If SetAmount(ws, Row, Arr) Then
        For j = LBound(Arr) To UBound(Arr)
          Result = Result + CurrToStr(Arr(j).Amount) + "|"
        Next j
      End If
    End If
    GetRangeRow0503121 = Result
  End If
End Function

'ReportForm 0503130 **************************************************************
Public Sub DoReport0503130(wb As Workbook)
  Report0503130 wb, "tools.xla!GetRangeRow0503130"
End Sub


Private Sub Report0503130(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data

    ' |fffd||fffd||fffd||fffd||fffd|
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_POSTFIX, "1"
    
    ' |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "", funcName
    SetCommonRange ElemTable, ParamsSheet
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_PREFIX, "1"
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(3).Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503130(ws As Worksheet, Row As Integer, SectionName As String) As String
  Dim i As Integer, j As Integer, Arr1() As RangeAmount, Arr2() As RangeAmount
  Dim Result As String
  If SectionName = "02" Then
    If (ws.Range("RBEGIN_1").Row <> Row) And (ws.Cells(Row, 3).Value <> "") Then
      ReDim Arr2(1)
      For i = 0 To 1
        Arr2(i).Column = i + 5
      Next i
      If SetAmount(ws, Row, Arr2) Then
        Result = ws.Cells(Row, 1) + "|" + ws.Cells(Row, 3).Value + "|"
        For j = LBound(Arr2) To UBound(Arr2)
          Result = Result + CurrToStr(Arr2(j).Amount) + "|"
        Next j
      End If
    End If
  Else
    ReDim Arr1(5)
    For i = 0 To 5
      Arr1(i).Column = i + 4
    Next i
    If SetAmount(ws, Row, Arr1) Then
      Result = ws.Cells(Row, 2).Value + "|"
      For j = LBound(Arr1) To UBound(Arr1)
        Result = Result + CurrToStr(Arr1(j).Amount) + "|"
      Next j
    End If
  End If
  GetRangeRow0503130 = Result
End Function

Private Function FormatAmountUKF(amt As Currency) As String
  FormatAmountUKF = Replace(Format(amt, "#0.00"), ",", ".")
End Function

'ReportForm 0503124 **************************************************************
Public Sub DoReport0503124(wb As Workbook)
  Report0503124 wb, "tools.xla!GetRangeRow0503124"
End Sub

Private Sub Report0503124(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  Set ParamsSheet = wb.Worksheets(1)
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    Elem.setAttribute "PARAMS", GetNamedValue(ParamsSheet, "PARAMS")
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderDataUFK ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttrUFK ElemTable, ParamsSheet.Name, "1", "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttrUFK ElemTable, wb.Worksheets(2).Name, "2", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttrUFK ElemTable, wb.Worksheets(3).Name, "3", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", funcName
    SetCommonRange ElemTable, ParamsSheet
    'MsgBox Elem.XML
    RunExportNew wb, Elem.XML, FinTex.UFK_FORMAT
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503124(ws As Worksheet, Row As Integer, SectionName As String, rowCode As String) As String
  Dim i As Integer, j As Integer, Arr() As RangeAmount
  Dim Result As String, code As String, amt As String
  If SectionName = "1" Then
    ReDim Arr(1)
    Arr(0).Column = 5
    Arr(1).Column = 7
    If SetAmount(ws, Row, Arr) Then
      code = ws.Cells(Row, 3).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      code = Replace(code, "x", "")
      code = Replace(code, "X", "")
      If code = "" Then
        code = "***|*****************"
      Else
        code = Mid(code, 1, 3) & "|" & Mid(code, 4, 17)
      End If
      Result = rowCode + "|" + code + "|"
      For j = LBound(Arr) To UBound(Arr)
        Result = Result + FormatAmountUKF(Arr(j).Amount) + "|"
      Next j
    End If
  End If
  If SectionName = "2" Then
    ReDim Arr(3)
    For i = 0 To 3
      Arr(i).Column = i + 5
    Next i
    If SetAmount(ws, Row, Arr) Then
      code = ws.Cells(Row, 3).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      code = Replace(code, "x", "")
      code = Replace(code, "X", "")
      If code = "" Then
        code = "***|****|*******|***|***"
      Else
        code = Mid(code, 1, 3) & "|" & Mid(code, 4, 4) & "|" & Mid(code, 8, 7) & "|" & Mid(code, 15, 3) & "|" & Mid(code, 18, 3)
      End If
      Result = rowCode + "|" + code + "|"
      For j = LBound(Arr) To UBound(Arr)
        Result = Result + FormatAmountUKF(Arr(j).Amount) + "|"
      Next j
    End If
  End If
  If SectionName = "3" Then
    ReDim Arr(3)
    For i = 0 To 3
      Arr(i).Column = i + 4
    Next i
    If SetAmount(ws, Row, Arr) Then
      code = ws.Cells(Row, 3).Value
      code = Replace(code, " ", "")
      code = Replace(code, ".", "")
      code = Replace(code, "x", "")
      code = Replace(code, "X", "")
      If code = "" Then
        code = "***|*****************"
      Else
        code = Mid(code, 1, 3) & "|" & Mid(code, 4, 17)
      End If
      Result = rowCode + "|" + code + "|"
      For j = LBound(Arr) To UBound(Arr)
        Result = Result + FormatAmountUKF(Arr(j).Amount) + "|"
      Next j
    End If
  End If
  GetRangeRow0503124 = Result
End Function

'ReportForm 0503134 **************************************************************
Public Sub DoReport0503134(wb As Workbook)
  Report0503134 wb, "tools.xla!GetRangeRow0503134"
End Sub

Private Sub Report0503134(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  Set ParamsSheet = wb.Worksheets(1)
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    Elem.setAttribute "PARAMS", GetNamedValue(ParamsSheet, "PARAMS")
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderDataUFK ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttrUFK ElemTable, ParamsSheet.Name, "1", "|fffd||fffd||fffd||fffd||fffd||fffd|", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttrUFK ElemTable, wb.Worksheets(2).Name, "2", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttrUFK ElemTable, wb.Worksheets(3).Name, "3", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", funcName
    SetCommonRange ElemTable, ParamsSheet
    'MsgBox Elem.XML
    RunExportNew wb, Elem.XML, FinTex.UFK_FORMAT
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503134(ws As Worksheet, Row As Integer, SectionName As String, rowCode As String) As String
  Dim i As Integer, j As Integer, Arr() As RangeAmount
  Dim Result As String, code As String
  ReDim Arr(1)
  If SectionName = "1" Then
    Arr(0).Column = 5
    Arr(1).Column = 7
  End If
  If SectionName = "2" Then
    For i = 0 To 1
      Arr(i).Column = i + 5
    Next i
  End If
  If SectionName = "3" Then
    For i = 0 To 1
      Arr(i).Column = i + 4
    Next i
  End If
  If SetAmount(ws, Row, Arr) Then
    code = ws.Cells(Row, 3).Value
    code = Replace(code, " ", "")
    code = Replace(code, ".", "")
    If SectionName = "2" Then
      If code = "" Then
        code = "***|****|*******|***|***"
      Else
        code = Mid(code, 1, 3) & "|" & Mid(code, 4, 4) & "|" & Mid(code, 8, 7) & "|" & Mid(code, 15, 3) & "|" & Mid(code, 18, 3)
      End If
    Else
      If code = "" Then
        code = "***|*****************"
      Else
        code = Mid(code, 1, 3) & "|" & Mid(code, 4, 17)
      End If
    End If
    Result = rowCode + "|" + code + "|"
    For j = LBound(Arr) To UBound(Arr)
      Result = Result + FormatAmountUKF(Arr(j).Amount) + "|"
    Next j
  End If
  GetRangeRow0503134 = Result
End Function

'ReportForm 0503150 **************************************************************
Public Sub DoReport0503150(wb As Workbook)
  Report0503150 wb, "tools.xla!GetRangeRow0503150"
End Sub

Private Sub Report0503150(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  Set ParamsSheet = wb.Worksheets(1)
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderDataUFK ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttrUFK ElemTable, ParamsSheet.Name, "1", "|fffd||fffd||fffd||fffd||fffd|", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttrUFK ElemTable, wb.Worksheets(2).Name, "2", "|fffd||fffd||fffd||fffd||fffd||fffd|", funcName
    SetCommonRange ElemTable, ParamsSheet
    'MsgBox Elem.XML
    RunExportNew wb, Elem.XML, FinTex.UFK_FORMAT
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503150(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 2).Value <> "" Then
    Dim i As Integer, j As Integer, Arr() As RangeAmount, Result As String, rowCode As String
    
    rowCode = ws.Cells(Row, 2)
    ReDim Arr(5)
    For i = 0 To 5
      Arr(i).Column = i + 4
    Next i
    If SetAmount(ws, Row, Arr) Then
      Result = rowCode + "|"
      If SetAmount(ws, Row, Arr) Then
        For j = LBound(Arr) To UBound(Arr)
          Result = Result + FormatAmountUKF(Arr(j).Amount) + "|"
        Next j
      End If
    End If
    GetRangeRow0503150 = Result
  End If
End Function

'ReportForm 0503140 **************************************************************
Public Sub DoReport0503140(wb As Workbook)
  Report0503140 wb, "tools.xla!GetRangeRow0503140"
End Sub

Private Sub Report0503140(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  Set ParamsSheet = wb.Worksheets(1)
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderDataUFK ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttrUFK ElemTable, ParamsSheet.Name, "1", "|fffd||fffd||fffd||fffd||fffd|", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttrUFK ElemTable, wb.Worksheets(2).Name, "2", "|fffd||fffd||fffd||fffd||fffd||fffd|", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttrUFK ElemTable, wb.Worksheets(3).Name, "3", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|", funcName
    SetCommonRange ElemTable, ParamsSheet
    'MsgBox Elem.XML
    RunExportNew wb, Elem.XML, FinTex.UFK_FORMAT
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503140(ws As Worksheet, Row As Integer, SectionName As String) As String
  Dim i As Integer, j As Integer, Arr() As RangeAmount
  Dim Result As String
  If SectionName = "3" Then
    If ws.Range("RBEGIN_1").Row <> Row And ws.Cells(Row, 1) <> "" Then
      ReDim Arr(1)
      For i = 0 To 1
        Arr(i).Column = i + 5
      Next i
      If SetAmount(ws, Row, Arr) Then
        Result = ws.Cells(Row, 1) + "|" + ws.Cells(Row, 3).Value + "|"
        For j = LBound(Arr) To UBound(Arr)
          Result = Result + FormatAmountUKF(Arr(j).Amount) + "|"
        Next j
      End If
    End If
  Else
    ReDim Arr(5)
    For i = 0 To 5
      Arr(i).Column = i + 4
    Next i
    If SetAmount(ws, Row, Arr) Then
      Result = ws.Cells(Row, 2).Value + "|"
      For j = LBound(Arr) To UBound(Arr)
        Result = Result + FormatAmountUKF(Arr(j).Amount) + "|"
      Next j
    End If
  End If
  GetRangeRow0503140 = Result
End Function


'ReportForm 0503120 **************************************************************
Public Sub DoReport0503120(wb As Workbook)
  Report0503120 wb, "tools.xla!GetRangeRow0503120"
End Sub


Private Sub Report0503120(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  Set ParamsSheet = wb.Worksheets(1)
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    ' |fffd||fffd||fffd||fffd||fffd|
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_POSTFIX, "1"
    ' |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "", funcName
    SetCommonRange ElemTable, ParamsSheet
    ElemTable.setAttribute FinTex.IS_NOT_OUT_TABLE_PREFIX, "1"
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(3).Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503120(ws As Worksheet, Row As Integer, SectionName As String) As String
  Dim i As Integer, j As Integer, Arr() As RangeAmount
  Dim Result As String
  If SectionName = "01" Or SectionName = "" Then
    If ws.Cells(Row, 2).Value <> "" Then
      ReDim Arr(5)
      For i = 0 To 5
        Arr(i).Column = i + 4
      Next i
      If SetAmount(ws, Row, Arr) Then
        Result = ws.Cells(Row, 2).Value + "|"
        For j = LBound(Arr) To UBound(Arr)
          Result = Result + CurrToStr(Arr(j).Amount) + "|"
        Next j
      End If
    End If
  ElseIf SectionName = "02" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If ws.Cells(Row, 1).Value <> "1" And Trim(ws.Cells(Row, 3).Value) <> "" Then
      ReDim Arr(1)
      For i = LBound(Arr) To UBound(Arr)
        Arr(i).Column = i + 5
      Next i
      Call SetAmount(ws, Row, Arr)
      Result = ws.Cells(Row, 1).Value + "|" + ws.Cells(Row, 3).Value + "|"
      For i = LBound(Arr) To UBound(Arr)
        If ws.Cells(Row, Arr(i).Column) = "x" Then
          Result = Result + "-|"
        Else
          Result = Result + CurrToStr(Arr(i).Amount) + "|"
        End If
      Next i
    End If
  End If
  GetRangeRow0503120 = Result
End Function

'ReportForm 0503123 **************************************************************
Public Sub DoReport0503123(wb As Workbook)
  Report0503123 wb, "tools.xla!GetRangeRow0503123"
End Sub

Private Sub Report0503123(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim Element As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)

  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_1", "REND_1"
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "02", funcName
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_2", "REND_2"
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "03", funcName
    Set Element = ElemTable.appendChild(ElemTable.ownerDocument.createElement(FinTex.RANGE_TAG))
    SetCommonRangeAttr Element, "RBEGIN_3", "REND_3"
    
    RunExport wb, Elem.XML
  End If
  
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503123(ws As Worksheet, Row As Integer, SectionName As String) As String
  If ws.Cells(Row, 2).Value <> "" Then
    Dim i As Integer, j As Integer, Arr() As RangeAmount, Result As String, rowCode As String, kesCode As String
    
    rowCode = ws.Cells(Row, 2)
    kesCode = ws.Cells(Row, 3)
    If kesCode = "" Then
        kesCode = "***"
    End If
      
    ReDim Arr(0)
    Arr(0).Column = 8
    
    If SetAmount(ws, Row, Arr) Then
      Result = rowCode + "|" + kesCode + "|"
      For j = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(j).Amount) + "|"
      Next j
    End If
    GetRangeRow0503123 = Result
  End If
End Function

'ReportForm 0503117 **************************************************************
Public Sub DoReport0503117(wb As Workbook)
  Report0503117 wb, "tools.xla!GetRangeRow0503117"
End Sub

Private Sub Report0503117(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    Elem.setAttribute "PARAMS", GetNamedValue(ParamsSheet, "PARAMS")
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(3).Name, "03", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503117(ws As Worksheet, Row As Integer, SectionName As String, rowCode As String) As String
  Dim i As Integer, j As Integer, Arr() As RangeAmount
  Dim Result As String, code As String, kbk As String, rc As String
  
  kbk = ws.Cells(Row, 3).Value
  kbk = Replace(kbk, " ", "")
  kbk = Replace(kbk, ".", "")
  rc = Trim(ws.Cells(Row, 2).Value)
  
  If SectionName = "01" Then
    ReDim Arr(2)
    Arr(0).Column = 4
    Arr(1).Column = 5
    Arr(2).Column = 6
    If SetAmount(ws, Row, Arr) Or rc = "010" Then
      If rc = "010" Then
        code = "***|85000000000000000"
      Else
        code = Mid(kbk, 1, 3) + "|" + Mid(kbk, 4, 17)
      End If
      Result = rowCode + "|" + code + "|"
      For j = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(j).Amount) + "|"
      Next j
    End If
  End If
  If SectionName = "02" Then
    ReDim Arr(2)
    Arr(0).Column = 4
    Arr(1).Column = 5
    Arr(2).Column = 6
    If SetAmount(ws, Row, Arr) Or rc = "200" Or rc = "450" Then
      If rc = "200" Then
        code = "***|9600|0000000|000|000"
      Else
        If rc = "450" Then
          code = "***|7900|0000000|000|000"
        Else
          code = Mid(kbk, 1, 3) + "|" + Mid(kbk, 4, 4) + "|" + _
          Mid(kbk, 8, 7) + "|" + Mid(kbk, 15, 3) + "|" + Mid(kbk, 18, 3)
        End If
      End If
      Result = rowCode + "|" + code + "|"
      For j = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(j).Amount) + "|"
      Next j
    End If
  End If
  If SectionName = "03" Then
    ReDim Arr(2)
    Arr(0).Column = 4
    Arr(1).Column = 5
    Arr(2).Column = 6
    If SetAmount(ws, Row, Arr) Or rc = "500" Or rc = "520" Or rc = "620" Or rc = "700" Then
      If rc = "500" Then
        code = "***|90000000000000000"
      Else
        If rc = "520" Then
          code = "***|01000000000000000"
        Else
          If rc = "620" Then
            code = "***|02000000000000000"
          Else
            code = Mid(kbk, 1, 3) + "|" + Mid(kbk, 4, 17)
          End If
        End If
      End If
      Result = rowCode + "|" + code + "|"
      For j = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(j).Amount) + "|"
      Next j
    End If
  End If

  GetRangeRow0503117 = Result
End Function



'ReportForm 0505140 **************************************************************
Public Sub DoReport0505140(wb As Workbook)
  Report0505140 wb, "tools.xla!GetRangeRow0505140"
End Sub

Private Sub Report0505140(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
  Dim SectionCount As Integer
  Dim i As Integer
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd|")
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, ParamsSheet
    'Footer data
    'Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    'SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    SectionCount = 1
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, "|fffd||fffd||fffd||fffd||fffd||fffd|", GetCounter(SectionCount), funcName
    SetCommonRange ElemTable, ParamsSheet
    SectionCount = SectionCount + 1
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", GetCounter(SectionCount), funcName
    SetCommonRange ElemTable, ParamsSheet
    SectionCount = SectionCount + 1
    
    For i = 1 To 11
      '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
      Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
      SetCommonTableAttr ElemTable, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|-" & GetCounter(i), GetCounter(SectionCount), funcName
      SetCommonRange ElemTable, ParamsSheet
      SectionCount = SectionCount + 1
    Next i
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|-96", GetCounter(SectionCount), funcName
    SetCommonRange ElemTable, ParamsSheet
    SectionCount = SectionCount + 1
    
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Private Function GetCounter(i As Integer) As String
  Dim s As String
  s = CStr(i)
  If (Len(s) < 2) Then
    GetCounter = "0" & s
  Else
    GetCounter = s
  End If
End Function

Public Function GetRangeRow0505140(ws As Worksheet, Row As Integer, SectionName As String) As String
  Dim kbkStartCol As Integer, kbkEndCol As Integer, Digits As Integer
  Dim code As String
  Dim Arr() As RangeAmount

  Digits = Len(ws.Cells(2, 2))
  If Digits > 2 Then Digits = 2
  
  If Not (SectionName = "01") Then
    Row = Row - 1
  End If
  
  If (ws.Cells(Row, 5) = "") Then
    Exit Function
  End If
  
  code = ""
  If (SectionName = "01") Then
    For i = 3 To 9
      code = code & ws.Cells(Row, i)
    Next i
    kbkEndCol = 9
  Else
    If (SectionName = "02") Then
      For i = 3 To 10
        code = code & ws.Cells(Row, i)
      Next i
      kbkEndCol = 10
    Else
      code = ws.Cells(Row, 4) & ws.Cells(Row, 5) & "|" & ws.Cells(Row, 6) & "|" & ws.Cells(Row, 7) & "|" & ws.Cells(Row, 8)
      kbkEndCol = 8
    End If
  End If
  
  ReDim Arr(5)
  For i = 0 To 5
    Arr(i).Column = kbkEndCol + 1 + i
  Next i
  
  If SetAmount(ws, Row, Arr) Then
    GetRangeRow0505140 = code & "|"
    For i = LBound(Arr) To UBound(Arr)
      GetRangeRow0505140 = GetRangeRow0505140 & CurrToStrScale(Arr(i).Amount, Digits) & "|"
    Next i
  Else
    Exit Function
  End If
  
End Function

'ReportForm 0503128
Public Sub DoReport0503128(wb As Workbook)
  Report0503128 wb, "tools.xla!GetRangeRow0503128"
End Sub


Private Sub Report0503128(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    Elem.setAttribute "PARAMS", GetNamedValue(ParamsSheet, "PARAMS")
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    wb.Worksheets(1).Range("RANGE_NAMES").Value = "1"
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    wb.Worksheets(1).Range("RANGE_NAMES").Value = "2"
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    'MsgBox Elem.XML
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503128(ws As Worksheet, Row As Integer, SectionName As String) As String
  Dim i As Integer
  Dim Result, kbk, code As String
  Dim Arr(8) As RangeAmount
  For i = 0 To 8
    Arr(i).Column = i + 4
  Next i
  kbk = ws.Cells(Row, 3).Value
  kbk = Replace(kbk, " ", "")
  kbk = Replace(kbk, ".", "")
  If SectionName = "01" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If Trim(ws.Cells(Row, 2)) = "200" Then
      code = "***|9600|0000000|000|000"
      Call SetAmount(ws, Row, Arr)
      Result = "200|" + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        'If ws.Cells(Row, Arr(i).Column) = "x" Then
          'Result = Result + "-|"
        'Else
          Result = Result + CurrToStr(Arr(i).Amount) + "|"
        'End If
      Next i
    ElseIf SetAmount(ws, Row, Arr) Then
      code = Mid(kbk, 1, 3) + "|" + Mid(kbk, 4, 4) + "|" + _
        Mid(kbk, 8, 7) + "|" + Mid(kbk, 15, 3) + "|" + Mid(kbk, 18, 3)
      Result = "200|" + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        'If ws.Cells(Row, Arr(i).Column) = "x" Then
          'Result = Result + "-|"
        'Else
          Result = Result + CurrToStr(Arr(i).Amount) + "|"
        'End If
      Next i
    End If
  ElseIf SectionName = "02" Then
    If Trim(ws.Cells(Row, 2).Value) = "510" Then
      Result = "510|***|90000000000000000|"
      Call SetAmount(ws, Row, Arr)
      For i = LBound(Arr) To UBound(Arr)
        'If ws.Cells(Row, Arr(i).Column) = "x" Then
          'Result = Result + "-|"
        'Else
          Result = Result + CurrToStr(Arr(i).Amount) + "|"
        'End If
      Next i
    ElseIf Trim(ws.Cells(Row, 2).Value) = "999" Then
      Result = "999|***|*****************|"
      Call SetAmount(ws, Row, Arr)
      For i = LBound(Arr) To UBound(Arr)
        'If ws.Cells(Row, Arr(i).Column) = "x" Then
          'Result = Result + "-|"
        'Else
          Result = Result + CurrToStr(Arr(i).Amount) + "|"
        'End If
      Next i
    ElseIf (Len(kbk) = 20) And (SetAmount(ws, Row, Arr)) Then
      code = Mid(kbk, 1, 3) + "|" + Mid(kbk, 4, 17)
      Result = "510|" + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        'If ws.Cells(Row, Arr(i).Column) = "x" Then
          'Result = Result + "-|"
        'Else
          Result = Result + CurrToStr(Arr(i).Amount) + "|"
        'End If
      Next i
    End If
  End If
  GetRangeRow0503128 = Result
End Function

'ReportForm 0503138
Public Sub DoReport0503138(wb As Workbook)
  Report0503138 wb, "tools.xla!GetRangeRow0503138"
End Sub


Private Sub Report0503138(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    Elem.setAttribute "PARAMS", GetNamedValue(ParamsSheet, "PARAMS")
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    'MsgBox Elem.XML
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503138(ws As Worksheet, Row As Integer, SectionName As String) As String
  Dim i As Integer
  Dim Result, kbk, code As String
  Dim Arr(7) As RangeAmount
  Arr(0).Column = 4
  For i = 1 To 7
    Arr(i).Column = i + 5
  Next i
  Arr(0).Column = 4
  kbk = ws.Cells(Row, 3).Value
  kbk = Replace(kbk, " ", "")
  kbk = Replace(kbk, ".", "")
  If ws.Cells(Row, 2) = "200" Then
    code = "***|9600|0000000|000|000"
    Result = "200|" + code + "|"
    Call SetAmount(ws, Row, Arr)
    For i = LBound(Arr) To UBound(Arr)
      'If ws.Cells(Row, Arr(i).Column) = "x" Then
        'Result = Result + "-|"
      'Else
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      'End If
    Next i
  ElseIf SectionName = "01" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If SetAmount(ws, Row, Arr) Then
      code = Mid(kbk, 1, 3) + "|" + Mid(kbk, 4, 4) + "|" + _
      Mid(kbk, 8, 7) + "|" + Mid(kbk, 15, 3) + "|" + Mid(kbk, 18, 3)
      Result = "200|" + code + "|"
      For i = LBound(Arr) To UBound(Arr)
        'If ws.Cells(Row, Arr(i).Column) = "x" Then
          'Result = Result + "-|"
        'Else
          Result = Result + CurrToStr(Arr(i).Amount) + "|"
        'End If
      Next i
    End If
  End If
  GetRangeRow0503138 = Result
End Function


'ReportForm 0503127
Public Sub DoReport0503127(wb As Workbook)
  Report0503127 wb, "tools.xla!GetRangeRow0503127"
End Sub


Private Sub Report0503127(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    Elem.setAttribute "PARAMS", GetNamedValue(ParamsSheet, "PARAMS")
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(3).Name, "03", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    'MsgBox Elem.XML
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503127(ws As Worksheet, Row As Integer, SectionName As String, rowCode As String) As String
  Dim i As Integer
  Dim Result, kbk, code, rc As String
  Dim Arr() As RangeAmount
  
  If SectionName = "01" Then '|fffd||fffd||fffd||fffd||fffd||fffd|
    ReDim Arr(5)
    For i = 0 To 5
      Arr(i).Column = i + 5
    Next i
    If SetAmount(ws, Row, Arr) Or ws.Range("RBEGIN_1").Row = Row Then
      If ws.Range("RBEGIN_1").Row = Row Then
        Result = "010|***|85000000000000000|"
      Else
        kbk = ws.Cells(Row, 3).Value
        kbk = Replace(kbk, " ", "")
        kbk = Replace(kbk, ".", "")
        code = Mid(kbk, 1, 3) + "|" + Mid(kbk, 4, 17)
        Result = "010|" + code + "|"
      End If
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
  ElseIf SectionName = "02" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    ReDim Arr(7)
    For i = 0 To 7
      Arr(i).Column = i + 5
    Next i
    rc = Trim(ws.Cells(Row, 2).Value)
    If SetAmount(ws, Row, Arr) Or rc = "200" Or rc = "450" Then
      If rc = "200" Then
        Result = "200|***|9600|0000000|000|000|"
      ElseIf rc = "450" Then
        Result = "450|***|7900|0000000|000|000|"
      Else
        kbk = ws.Cells(Row, 3).Value
        kbk = Replace(kbk, " ", "")
        kbk = Replace(kbk, ".", "")
        code = Mid(kbk, 1, 3) + "|" + Mid(kbk, 4, 4) + "|" + Mid(kbk, 8, 7) + "|" + Mid(kbk, 15, 3) + "|" + Mid(kbk, 18, 3)
        Result = "200|" + code + "|"
      End If
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
  ElseIf SectionName = "03" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    ReDim Arr(5)
    Arr(0).Column = 4
    Arr(1).Column = 5
    Arr(2).Column = 6
    Arr(3).Column = 7
    Arr(4).Column = 8
    Arr(5).Column = 9
    rc = Trim(ws.Cells(Row, 2).Value)
    If SetAmount(ws, Row, Arr) Or rc = "500" Or rc = "520" Or rc = "620" Or rc = "700" _
    Or rc = "710" Or rc = "720" Or rc = "800" Or rc = "810" Or rc = "811" Or rc = "812" _
    Or rc = "820" Or rc = "821" Or rc = "822" Then
      kbk = ws.Cells(Row, 3).Value
      kbk = Replace(kbk, " ", "")
      kbk = Replace(kbk, ".", "")
      
      If kbk = "" Or kbk = "X" Or kbk = "x" Then
        If rc = "500" Then
          code = "***|90000000000000000"
        ElseIf rc = "520" Then
          code = "000|01000000000000000"
        ElseIf rc = "620" Then
          code = "000|02000000000000000"
        ElseIf rc = "800" Or rc = "810" Or rc = "811" Or rc = "812" Or rc = "820" Or rc = "821" Or rc = "822" Then
          code = "***|00000000000000000"
        Else
          code = "000|00000000000000000"
        End If
      Else
        code = Mid(kbk, 1, 3) + "|" + Mid(kbk, 4, 17)
      End If
      Result = rowCode + "|" + code + "|"
      For j = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(j).Amount) + "|"
      Next j
    End If
  End If
  GetRangeRow0503127 = Result
End Function

'ReportForm 0503137
Public Sub DoReport0503137(wb As Workbook)
  Report0503137 wb, "tools.xla!GetRangeRow0503137"
End Sub


Private Sub Report0503137(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    Elem.setAttribute "PARAMS", GetNamedValue(ParamsSheet, "PARAMS")
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(3).Name, "03", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    'MsgBox Elem.XML
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503137(ws As Worksheet, Row As Integer, SectionName As String, rowCode As String) As String
  Dim i As Integer
  Dim Result, kbk, code, rc As String
  Dim Arr() As RangeAmount
  
  rc = Trim(ws.Cells(Row, 2).Value)
  If SectionName = "01" Then '|fffd||fffd||fffd||fffd||fffd||fffd|
    ReDim Arr(5)
    For i = 0 To 5
      Arr(i).Column = i + 5
    Next i
    If SetAmount(ws, Row, Arr) Or rc = "010" Then
      If rc = "010" Then
        Result = "010|***|85000000000000000|"
      Else
        kbk = ws.Cells(Row, 3).Value
        kbk = Replace(kbk, " ", "")
        kbk = Replace(kbk, ".", "")
        code = Mid(kbk, 1, 3) + "|" + Mid(kbk, 4, 17)
        Result = "010|" + code + "|"
      End If
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
  ElseIf SectionName = "02" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    ReDim Arr(5)
    For i = 0 To 5
      Arr(i).Column = i + 5
    Next i
    If SetAmount(ws, Row, Arr) Or rc = "200" Or rc = "450" Then
      If rc = "200" Then
        Result = "200|***|9600|0000000|000|000|"
      ElseIf rc = "450" Then
        Result = "450|***|7900|0000000|000|000|"
      Else
        kbk = ws.Cells(Row, 3).Value
        kbk = Replace(kbk, " ", "")
        kbk = Replace(kbk, ".", "")
        code = Mid(kbk, 1, 3) + "|" + Mid(kbk, 4, 4) + "|" + Mid(kbk, 8, 7) + "|" + Mid(kbk, 15, 3) + "|" + Mid(kbk, 18, 3)
        Result = "200|" + code + "|"
      End If
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
  ElseIf SectionName = "03" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    ReDim Arr(5)
    Arr(0).Column = 4
    Arr(1).Column = 5
    Arr(2).Column = 6
    Arr(3).Column = 7
    Arr(4).Column = 8
    Arr(5).Column = 9
    If SetAmount(ws, Row, Arr) Or rc = "500" Or rc = "520" Or rc = "700" Or rc = "710" Or rc = "720" _
    Or rc = "820" Or rc = "821" Or rc = "822" Then
      kbk = ws.Cells(Row, 3).Value
      kbk = Replace(kbk, " ", "")
      kbk = Replace(kbk, ".", "")
      
      If kbk = "" Or kbk = "X" Or kbk = "x" Then
        If rc = "500" Then
          code = "***|90000000000000000"
        ElseIf rc = "520" Then
          code = "000|01000000000000000"
        ElseIf rc = "620" Then
          code = "000|02000000000000000"
        ElseIf rc = "800" Or rc = "810" Or rc = "811" Or rc = "812" Or rc = "820" Or rc = "821" Or rc = "822" Then
          code = "***|00000000000000000"
        Else
          code = "000|00000000000000000"
        End If
      Else
        code = Mid(kbk, 1, 3) + "|" + Mid(kbk, 4, 17)
      End If
      Result = rowCode + "|" + code + "|"
      For j = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(j).Amount) + "|"
      Next j
    End If
  End If
  GetRangeRow0503137 = Result
End Function

'ReportForm 0503324
Public Sub DoReport0503324(wb As Workbook)
  Report0503324 wb, "tools.xla!GetRangeRow0503324"
End Sub

Private Sub Report0503324(wb As Workbook, funcName As String)
  Dim Doc As New MSXML2.DOMDocument
  Dim Elem As IXMLDOMElement
  Dim ElemHeader As IXMLDOMElement
  Dim ElemBody As IXMLDOMElement
  Dim ElemRange As IXMLDOMElement
  Dim ElemFooter As IXMLDOMElement
  Dim ElemTable As IXMLDOMElement
  Dim ParamsSheet As Worksheet
  Dim FileName
   
  On Error GoTo ErrorHandler
  
  Set ParamsSheet = wb.Worksheets(1)
   
  FileName = InputBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", "|fffd||fffd||fffd|", GetNamedValue(ParamsSheet, "FILE_NAME"))
  If Len(FileName) = 0 Then
    Err.Clear
    Exit Sub
  End If
  
  If Doc.loadXML("<TASK/>") Then
    Set Elem = Doc.DocumentElement
    Elem.setAttribute "FILE_NAME", FileName
    Elem.setAttribute "PARAMS", GetNamedValue(ParamsSheet, "PARAMS")
    'Header data
    Set ElemHeader = Elem.appendChild(Doc.createElement(FinTex.HEADER_TAG))
    SetHeaderData ElemHeader, wb.Worksheets(1)
    'Footer data
    Set ElemFooter = Elem.appendChild(Doc.createElement(FinTex.FOOTER_TAG))
    SetFooterData ElemFooter, ""
    'Body data
    Set ElemBody = Elem.appendChild(Doc.createElement(FinTex.BODY_TAG))
    
    '|fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, ParamsSheet.Name, "01", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(2).Name, "02", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set ElemTable = ElemBody.appendChild(Doc.createElement(FinTex.TABLE_TAG))
    SetCommonTableAttr ElemTable, wb.Worksheets(3).Name, "03", funcName
    SetCommonRange ElemTable, ParamsSheet
    
    'MsgBox Elem.XML
    RunExport wb, Elem.XML
  End If
  MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| " + FileName + "."
  Exit Sub
ErrorHandler:
    ShowError
End Sub

Public Function GetRangeRow0503324(ws As Worksheet, Row As Integer, SectionName As String) As String
  Dim i As Integer, col1 As Integer, col2 As Integer
  Dim Result As String, kbk As String, code As String
  Dim Arr() As RangeAmount
  
  If SectionName = "01" Then '|fffd||fffd||fffd|
    
    ReDim Arr(8)
    
    If Range("COL_MODE") = 0 Then
      Arr(0).Column = 48
      Arr(1).Column = 61
      Arr(2).Column = 74
      Arr(3).Column = 88
      Arr(4).Column = 100
      Arr(5).Column = 114
      Arr(6).Column = 129
      Arr(7).Column = 144
      Arr(8).Column = 156
    Else
      Arr(0).Column = 59
      Arr(1).Column = 72
      Arr(2).Column = 85
      Arr(3).Column = 99
      Arr(4).Column = 111
      Arr(5).Column = 125
      Arr(6).Column = 140
      Arr(7).Column = 155
      Arr(8).Column = 167
    End If
    
    If SetAmount(ws, Row, Arr) Or rc = "010" Then
      
      Result = GetCellTextValueExt(ws, Row, 17, "***") + "|" + GetCellTextValueExt(ws, Row, 24, "*******") + "|"
      code = GetCellTextValue(ws, Row, 36)
      If Len(code) = 20 Then
        Result = Result + Mid(code, 1, 3) + "|" + Mid(code, 4) + "|"
      Else
        Result = Result + "***|*****************|"
      End If
      
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
  ElseIf SectionName = "02" Then '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|
    ReDim Arr(0)
    
    If Range("COL_MODE") = 0 Then
      Arr(0).Column = 70
    Else
      Arr(0).Column = 85
    End If
    
    If SetAmount(ws, Row, Arr) Then
      code = GetCellTextValue(ws, Row, 31)
      If Len(code) = 3 Then
        Result = code + "|"
      Else
        Result = "***|"
      End If
      code = GetCellTextValue(ws, Row, 41)
      If Len(code) = 20 Then
        Result = Result + Mid(code, 1, 3) + "|" + Mid(code, 4, 4) + "|" + Mid(code, 8, 7) + "|" + Mid(code, 15, 3) + "|" + Mid(code, 18, 3) + "|"
      Else
        Result = Result + "***|****|*******|***|***|"
      End If
      
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
    End If
  ElseIf SectionName = "03" Then '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    ReDim Arr(0)
    
    If Range("COL_MODE") = 0 Then
      Arr(0).Column = 52
      col1 = 68
      col2 = 84
    Else
      Arr(0).Column = 62
      col1 = 78
      col2 = 94
    End If
    
    If SetAmount(ws, Row, Arr) Then
      Result = "-|" + Replace(GetCellTextValue(ws, Row, 1), "|", " ") + "|" + GetCellTextValue(ws, Row, 25) + "|" + GetCellTextValue(ws, Row, 36) + "|"
      For i = LBound(Arr) To UBound(Arr)
        Result = Result + CurrToStr(Arr(i).Amount) + "|"
      Next i
      Result = Result + GetCellTextValue(ws, Row, col1) + "|" + GetCellTextValue(ws, Row, col2) + "|"
    End If
  End If
  GetRangeRow0503324 = Result
End Function


Attribute VB_Name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True


INQUEST-PP=macro
