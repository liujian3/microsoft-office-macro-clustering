Attribute VB_Name = "EstaPasta_de_trabalho"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

























Attribute VB_Name = "M|fffd|d1TabMista"
Public TabMist As Range
Public CompTab() As String
Public CompTabOp() As String
Public nInd As Single
'Vari|fffd|veis para visualizar |fffd|ndices
Public vNomeInd As String
Public nInd1 As Single
Public vUserFormTop As Single
Public vUserFormLeft As Single
Public vRange|fffd|nd As Range
Public DC As Single   'Resolve erro 2015

Public Sub TabMistVBA()
    NomeArqHist = "TabMist.hst"
    Set TabMist = Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("TabMist")
    Application.ScreenUpdating = False
    DirBD = Application.Evaluate(Workbooks("cpap_pri.mac").Names("DirBD").Value)    'DirP = ThisWorkbook.Path
    Application.ScreenUpdating = False
    If MyOpenFile(DirBD & "\banco\" & NomeArqHist, True) Then
        ActiveWindow.Close False
    End If
    Application.ScreenUpdating = True
    'Ajuda
    i = InStr(1, TabMist(2).Value, "!"): bHtmlHelp = Workbooks("cpap_pri.mac").Excel4MacroSheets(1).Range("bHtmlHelp").Value
    'Com o proj. proteg. essa instru|fffd||fffd|o falha. A solu|fffd||fffd|o foi colocar ..\cpap.hlp nas propriedades e fazer o diret|fffd|rio do cpap ativo.
    'Application.VBE.VBProjects("VBAProjectCxIdent").HelpFile = Left(TabMist(2,2).value, I - 1)
    If Mid(ThisWorkbook.Path, 2, 1) = ":" Then ChDrive ThisWorkbook.Path
    If Mid(ThisWorkbook.Path, 2, 1) = ":" Then ChDir ThisWorkbook.Path Else Application.Run "CPAP_EX8.MAC!DirectoryVBA", ThisWorkbook.Path, False
    nInd = TabMist(6).Value   'Aqui porque a pr|fffd|x. aciona o evento inicialize do form.
    UserForm1TabMista.HelpContextID = Right(TabMist(2).Value, Len(TabMist(2).Value) - i)

    UserForm1TabMista.TabMista_Cb.Value = TabMist(3).Value

    UserForm1TabMista.Caption = "Tabela Mista - " & IIf(TabMist(4).Value <> "", "Plano N|fffd| " & TabMist(5).Value & " de " & TabMist(4).Value, TabMist(5).Value)

    Application.ScreenUpdating = True
    UserForm1TabMista.Cancelar_Bt.SetFocus
    Application.StatusBar = False
    UserForm1TabMista.Show
    Application.ScreenUpdating = True
    TabMist(1) = BotAcionado
    If FecharArq Then TabMist(2) = "Fechar"
    If BotAcionado <> False Then
        Application.ScreenUpdating = False
        'Atualizar hist|fffd|rico
        Application.ScreenUpdating = False
        If MyOpenFile(DirBD & "\banco\" & NomeArqHist, False) Then
            SalvarHist = False
            AtuHist "TabMista", UserForm1TabMista.TabMista_Cb.Value, TabMist(3)
            If SalvarHist Then SalvandoHist Else Workbooks(NomeArqHist).Close False
        End If
        'Transferindo dados
        TabMist(3) = UserForm1TabMista.TabMista_Cb.Value

        Application.ScreenUpdating = False
    End If
    Unload UserForm1TabMista
    ThisWorkbook.Saved = True
End Sub

Function |fffd|ndicesDispon|fffd|veis(vNomeInd As String, nInd1 As Single)
    With Application.Workbooks("cpap_jap.mac").Sheets(1)
        Col = .Range("C|fffd|lRef").Column + 1
        If NmesIndMax = 0 Then NmesIndMax = Workbooks("cpap_pri.mac").Excel4MacroSheets(1).Range("NmesIndMax").Value
        Set vRange|fffd|nd = .Range(.Cells(5, Col), .Cells(4 + NmesIndMax, Col))
    End With
    DC = TabMist(7).Value
    Cfg = TabMist(8).Value
    If Len(Cfg) < 5 Then DInd = -1 Else DInd = Choose(Int(Mid(Cfg, 2, 1)), -2, -1, 0)
    i = Application.WorksheetFunction.Substitute(vNomeInd, " at|fffd| Entrg", " at|fffd| " & Format(DateSerial(Year(DC), Month(DC) + DInd, Day(DC)), "mm/yy")) _
            = vRange|fffd|nd.Cells(-2, 1).Value
    If i = False Then i = Application.Run("cpap_jap.mac!CaptTabM", vNomeInd, nInd1, DC, Cfg)
    If IsError(i) Then   'Aqui nunca ocorreu erro, mas fica em observ.
        |fffd|ndicesDispon|fffd|veis = "??"
        Exit Function
    End If
    If i Then
        vInd1 = ""
        vInd2 = ""
        vInd3 = ""
        For i = vRange|fffd|nd.Rows.Count To 1 Step -1
            vValor = vRange|fffd|nd.Cells(i, 1).Value
            If vValor <> "" And vInd1 = "" Then vInd1 = i
            If vValor = "" And vInd1 <> "" And vInd2 = "" Then vInd2 = i
            If vValor <> "" And vInd2 <> "" Then vInd3 = i
        Next
        If vInd1 <> "" Then
            vM|fffd|s1 = Format(Application.Run("CPAP_EX8.MAC!MyEdate", DateValue("01/05/1970") * 1, vInd1 - 1), "mmm/yy")
            vM|fffd|s2 = Format(Application.Run("CPAP_EX8.MAC!MyEdate", DateValue("01/05/1970") * 1, IIf(vInd2 = "", 0, vInd2)), "mmm/yy")
        End If
        If vInd3 <> "" Then
            vM|fffd|s2 = Format(Application.Run("CPAP_EX8.MAC!MyEdate", DateValue("01/05/1970") * 1, vInd2 - 1), "mmm/yy")
            vM|fffd|s3 = Format(Application.Run("CPAP_EX8.MAC!MyEdate", DateValue("01/05/1970") * 1, vInd3 - 1), "mmm/yy")
        End If
        If vInd1 = "" And vInd2 = "" And vInd3 = "" Then vRet = "Dispon|fffd|veis: Nenhum"
        If vInd1 <> "" And vInd3 = "" Then vRet = "Dispon|fffd|veis: " & vM|fffd|s2 & " a " & vM|fffd|s1
        If vInd1 <> "" And vInd3 <> "" Then vRet = "Disp.: " & vM|fffd|s3 & " a " & vM|fffd|s1 & " Falha! " & vM|fffd|s2
    Else
        vRet = "N|fffd|o Encontrada ou Faltam Componentes!"
    End If
    vRet = Application.WorksheetFunction.Substitute(vRet, " a dez/20", " ao fim")
    |fffd|ndicesDispon|fffd|veis = vRet
End Function

Sub DecomporTab(vNome As String)
    UM = Mid(vNome, 1, Application.WorksheetFunction.Find("//", vNome) - 1)
    vNome1 = vNome
    i = 0
    While Application.WorksheetFunction.Substitute(vNome1, " at|fffd| ", "|fffd|" & i & "|fffd|", 1) <> vNome1
        i = i + 1
        vNome1 = Application.WorksheetFunction.Substitute(vNome1, " at|fffd| ", "|fffd|" & i & "|fffd|", 1)
    Wend
    If i = 0 Then
        ReDim CompTab(i, 1)
        CompTab(0, 0) = vNome
        CompTab(0, 1) = ""
    Else
        ReDim CompTab(i - 1, 1)
        For k = 0 To i - 1
            If k = 0 Then
                CompTab(k, 0) = Left(vNome1, Application.WorksheetFunction.Find("|fffd|" & k + 1 & "|fffd|", vNome1) - 1)
                CompTab(k, 1) = Mid(vNome1, Application.WorksheetFunction.Find("|fffd|" & k + 1 & "|fffd|", vNome1) + 3, 5)
            Else
                CompTab(k, 0) = UM & "//" & Mid(vNome1, Application.WorksheetFunction.Find("|fffd|" & k & "|fffd|", vNome1) + 10, Application.WorksheetFunction.Find("|fffd|" & k + 1 & "|fffd|", vNome1) - Application.WorksheetFunction.Find("|fffd|" & k & "|fffd|", vNome1) - 10)
                CompTab(k, 1) = Mid(vNome1, Application.WorksheetFunction.Find("|fffd|" & k + 1 & "|fffd|", vNome1) + 3, 5)
            End If
        Next
    End If
End Sub

Sub ttt()
    DecomporTab "R$//INCC (FGV) at|fffd| 10/99, IGPm (FGV) at|fffd| 06/00, IGP-DI (FGV) at|fffd| o fim"
End Sub

Sub DecomporTabOp(vNome As String)
    UM = Mid(vNome, 1, Application.WorksheetFunction.Find("//", vNome) - 1)
    Ca = InStr(1, vNome, "[")
    cf = InStr(1, vNome, "]")
    MArit = Mid(vNome, cf + 2, 255)
    Nop = 0   'N|fffd|m. oper. 0-M|fffd|dia Aritm. 1-Adi|fffd||fffd|o Simples 2-Adi|fffd||fffd|o Composta 3-Subtra|fffd||fffd|o simp 4-Subtra|fffd||fffd|o comp.
    If InStr(1, vNome, " + ") > 0 Then
        Cop = " + ": Nop = 1: End If
    If InStr(1, vNome, " +|fffd| ") > 0 Then
        Cop = " +|fffd| ": Nop = 2: End If
    If InStr(1, vNome, " - ") > 0 Then
        Cop = " - ": Nop = 3: End If
    If InStr(1, vNome, " -|fffd| ") > 0 Then
        Cop = " -|fffd| ": Nop = 4: End If
    If Nop = 1 And MArit <> "" Then Nop = 0

    vNome1 = vNome
    i = 0
    If Cop <> "" Then
        While Application.WorksheetFunction.Substitute(vNome1, Cop, "|fffd|" & i & "|fffd|", 1) <> vNome1
            i = i + 1
            vNome1 = Application.WorksheetFunction.Substitute(vNome1, Cop, "|fffd|" & i & "|fffd|", 1)
        Wend
    End If
    If i = 0 Then
        ReDim CompTabOp(i + 1)
        CompTabOp(0) = vNome
        CompTabOp(1) = Nop
    Else
        ReDim CompTabOp(i + 1)
        For k = 0 To i
            Select Case k
            Case 0
                CompTabOp(k) = UM & "//" & Mid(vNome1, Ca + 1, Application.WorksheetFunction.Find("|fffd|" & k + 1 & "|fffd|", vNome1) - Ca - 1)
            Case 1 To i - 1
                CompTabOp(k) = UM & "//" & Mid(vNome1, Application.WorksheetFunction.Find("|fffd|" & k & "|fffd|", vNome1) + 3, Application.WorksheetFunction.Find("|fffd|" & k + 1 & "|fffd|", vNome1) - Application.WorksheetFunction.Find("|fffd|" & k & "|fffd|", vNome1) - 3)
            Case i
                cf = InStr(1, vNome1, "]")
                CompTabOp(k) = UM & "//" & Mid(vNome1, Application.WorksheetFunction.Find("|fffd|" & k & "|fffd|", vNome1) + 3, cf - Application.WorksheetFunction.Find("|fffd|" & k & "|fffd|", vNome1) - 3)
            End Select
        Next
        CompTabOp(i + 1) = Nop
    End If
End Sub

Sub tttop()
    DecomporTabOp "R$//[INCC (FGV) + IGPm (FGV) + IGP-DI (FGV)]/3"
End Sub
Sub tttop1()
    DecomporTabOp "R$//[INCC (FGV) + IGP-DI (FGV)]/2"
End Sub

Sub tttop2()
    DecomporTabOp "R$//INCC (FGV)"
End Sub

Sub Visual|fffd|ndices()
    Hlp = ThisWorkbook.Path & "\cpap.hlp!1232"
    DC = TabMist(7).Value
    Cfg = TabMist(8).Value
    If Len(Cfg) < 5 Then DInd = -1 Else DInd = Choose(Int(Mid(Cfg, 2, 1)), -2, -1, 0)
    i = Application.WorksheetFunction.Substitute(vNomeInd, " at|fffd| Entrg", " at|fffd| " & Format(DateSerial(Year(DC), Month(DC) + DInd, Day(DC)), "mm/yy")) _
            = vRange|fffd|nd.Cells(-2, 1).Value
    If i = False Then i = Application.Run("cpap_jap.mac!CaptTabM", vNomeInd, nInd1, DC, Cfg)
    If IsError(i) Then   'Ocorre erro 2015 s|fffd| no Excel97-port, necessita acionar o bot|fffd|o Calcular para captura a tabela. Foi resolvido com DC as Single
        MsgBox "Imposs|fffd|vel visualizar os |fffd|ndices dispon|fffd|veis.", vbCritical, "Erro Interno!"
        Exit Sub
    End If
    If i Then
        Application.ScreenUpdating = False
        UserForm2Visual|fffd|nd.Show
        'If Application.Workbooks("cpap_jap.mac").Sheets(1).Range("TabEdtda").Value Then |fffd|ndice_Cb_Click
    Else
        t1 = Application.Workbooks("cpap_jap.mac").Sheets(1).Range("PosTab").Offset(2, 0).Value
        MsgBox "A tabela ''" & t & "'' n|fffd|o foi encontrada ou faltam componentes (Falhou quando capturando " & t1 & ").", vbCritical, "FALHA!"
    End If
End Sub
Attribute VB_Name = "M|fffd|d2Comum"
Public Const MarcHist = "|fffd|Hist|fffd|rico|fffd|"
Public NomeArqHist As String
Public vEnableEvents As Boolean
Public BotAcionado As Variant
Public SalvarHist As Boolean
Public FormatoHist As String
Public HistEditCampo As String
Public vCloseMode As Integer
Public FecharArq As Boolean
Public NmesIndMax As Long: Public bHtmlHelp As Boolean

Sub AtuHist(vCampo As String, ValorCb As String, ValorOrig As String)
    If ValorCb = "" Or ValorCb = ValorOrig Then Exit Sub
    'Verificando exist|fffd|ncia - Sug. Fixas
    Set campo = ThisWorkbook.Sheets(NomeArqHist).Range(vCampo)
    j = 0
    For Each C In campo
        j = j + 1
        If j > 1 And IIf(IsError(C.Value), "", C.Value) = ValorCb Then Exit Sub
    Next

    'Verificando exist|fffd|ncia - Sug. Hist|fffd|ricas
    Set campo = ThisWorkbook.Sheets(NomeArqHist).Range(vCampo & "Hist", ThisWorkbook.Sheets(NomeArqHist).Range(vCampo & "Hist").End(xlDown))
    If campo.Rows.Count > 10000 Then Set campo = ThisWorkbook.Sheets(NomeArqHist).Range(vCampo & "Hist")
    j = 0
    For Each C In campo
        j = j + 1
        If j > 1 And IIf(IsError(C.Value), "", C.Value) = ValorCb Then Exit Sub
    Next
    'Adicionando |fffd| lista de hist|fffd|rico
    campo.Rows(2).Insert Shift:=xlDown
    campo.Rows(2).Value = "'" & ValorCb   'O ap|fffd|strofo arquivo tudo como texto, previnindo erro em caso de f|fffd|rmula e altera no formato de n|fffd|meros pela planilha
    NumM|fffd|x = ThisWorkbook.Sheets(NomeArqHist).Range(vCampo & "Hist").Offset(-1, 0).Value
    If campo.Rows.Count > NumM|fffd|x Then campo(NumM|fffd|x + 2).ClearContents
    SalvarHist = True
End Sub

Function MyOpenFile(vFileName As String, vReadOnly As Boolean)
    On Error Resume Next
Retry:
    Application.DisplayAlerts = False
    '                                                         bEnableEvents = Application.EnableEvents
    Application.Run "cpap_ex8.mac!EnableEventsVBA", False    'Application.EnableEvents = False
    Set i = Workbooks.Open(Filename:=vFileName, ReadOnly:=vReadOnly, Notify:=False)
    Application.Run "cpap_ex8.mac!EnableEventsVBA", True    'Application.EnableEvents = bEnableEvents

    'Testar integridade. Ver se abre como texto, se n|fffd|o existe o nome DadosHist, se A1&His<>Ahist
    t1 = i.FileFormat = xlCurrentPlatformText
    t2 = i.Sheets(1).Range("DadosHist").Value
    t2 = t2 = Empty
    If t2 = False Then t3 = i.Sheets(1).Range("DadosHist").Offset(1).Value <> i.Sheets(1).Range("A1").Value & "Hist" Else t3 = False
    If t1 Or t2 Or t3 Then i.Close False

    Application.DisplayAlerts = True
    If i.Name = "" Then
        Select Case MsgBox("O arquivo " & vFileName & " contendo o hist|fffd|rico das caixas de inclus|fffd|o n|fffd|o foi encontrado ou est|fffd| corrompido." & Chr(10) & Chr(10) & "Se acionar Ignorar, o arquivo ser|fffd| ignorado e um novo ser|fffd| gerado para iniciar outro hist|fffd|rico.", vbQuestion + vbAbortRetryIgnore + vbDefaultButton2, "CPAP|fffd| - Tentando Abrir Arquivo de Hist|fffd|rico")
        Case Is = vbRetry
            GoTo Retry
        Case Is = vbAbort
            MyOpenFile = False
            Exit Function
        Case Is = vbIgnore
            Application.Workbooks.Add xlWBATWorksheet
            ActiveWorkbook.Names.Add Name:="DadosHist", RefersToR1C1:=Cells(100, 1)
            If Dir(vFileName) <> "" Then Kill vFileName
            ActiveWorkbook.SaveAs vFileName, IIf(Val(Application.Version) >= 12, 56, xlWorkbookNormal)    'xlExcel8 56
            SalvandoHist
            GoTo Retry
        End Select
    End If
    On Error GoTo 0
    If vReadOnly = False And i.ReadOnly Then
        i.Close False
        j = j + 1
        If j < 4 Then
            Application.Wait Now + TimeValue("00:00:01")
            GoTo Retry
        Else
            If MsgBox("O arquivo " & vFileName & " contendo o hist|fffd|rico das caixas de inclus|fffd|o pode estar em uso por outra esta|fffd||fffd|o. Acione OK para continuar tentando ou Cancelar para desistir?", vbQuestion + vbOKCancel, "CPAP|fffd|") = vbOK Then
                GoTo Retry
            Else
                MyOpenFile = False
                Exit Function
            End If
        End If
    End If
    ActiveWorkbook.ActiveSheet.Unprotect "MP542"
    ThisWorkbook.Sheets(NomeArqHist).Range("DadosFixos").CurrentRegion.ClearContents
    Set CopyRng = Range("A1").CurrentRegion
    Set PasteRng = ThisWorkbook.Sheets(NomeArqHist).Range("DadosFixos")
    PasteRng.Resize(CopyRng.Rows.Count, CopyRng.Columns.Count).Value2 = CopyRng.Value2

    ThisWorkbook.Sheets(NomeArqHist).Range("DadosHist").CurrentRegion.ClearContents
    Set CopyRng = Range("DadosHist").CurrentRegion
    Set PasteRng = ThisWorkbook.Sheets(NomeArqHist).Range("DadosHist")
    PasteRng.Resize(CopyRng.Rows.Count, CopyRng.Columns.Count).Value2 = CopyRng.Value2
    MyOpenFile = True
End Function

Sub SalvandoHist()
    Workbooks(NomeArqHist).Sheets(1).Range("A1").CurrentRegion.ClearContents
    Set CopyRng = ThisWorkbook.Sheets(NomeArqHist).Range("DadosFixos").CurrentRegion
    Set PasteRng = Workbooks(NomeArqHist).Sheets(1).Range("A1")
    PasteRng.Resize(CopyRng.Rows.Count, CopyRng.Columns.Count).Value2 = CopyRng.Value2

    Workbooks(NomeArqHist).Sheets(1).Range("DadosHist").CurrentRegion.ClearContents
    i = ThisWorkbook.Sheets(NomeArqHist).Range("DadosHist").Row
    Workbooks(NomeArqHist).Names.Add Name:="DadosHist", RefersToR1C1:=Workbooks(NomeArqHist).Sheets(1).Cells(i, 1)
    Set CopyRng = ThisWorkbook.Sheets(NomeArqHist).Range("DadosHist").CurrentRegion
    Set PasteRng = Workbooks(NomeArqHist).Sheets(1).Range("DadosHist")
    PasteRng.Resize(CopyRng.Rows.Count, CopyRng.Columns.Count).Value2 = CopyRng.Value2

    Workbooks(NomeArqHist).Activate
    ActiveWorkbook.ActiveSheet.Protect "MP542"
    If Run("cpap_ex8.mac!SaveVBA") Then ActiveWorkbook.Close False
End Sub

Sub ConfHist(vComboBox As Object, vOriginal As String, Optional SemEditSring As Boolean = False, Optional Formato As String)
    i = InStr(1, vComboBox.Name, "_")
    HistEditCampo = Left(vComboBox.Name, i - 1)
    i = MsgBox("OK  -  Configurar sugest|fffd|es fixas e hist|fffd|ricas;" & Chr(10) & Chr(10) & "Cancelar - Restaurar inicial.", vbQuestion + vbOKCancel, "Hist|fffd|rico de Inclus|fffd|es no Campo " & HistEditCampo) = vbOK
    If i Then
        FormatoHist = Formato
        UserFormEditHist.Nova_Bt.Enabled = Not SemEditSring
        UserFormEditHist.SugFixas_Ct.Enabled = Not SemEditSring
        UserFormEditHist.SugHist_Ct.Enabled = Not SemEditSring
        UserFormEditHist.Show
        Unload UserFormEditHist
    End If
    vComboBox.Value = vOriginal
    If i Then ListandoComboBox vComboBox, Formato
    SendKeys "{RIGHT}"
End Sub

Sub ListandoComboBox(vComboBox As Object, Optional Formato As String)
    i = InStr(1, vComboBox.Name, "_")
    vCampo = Left(vComboBox.Name, i - 1)
    'Limpando comboboxes
    While vComboBox.ListCount >= 1
        vComboBox.RemoveItem (0)
    Wend
    'Listando comboboxes - Lista de sug. fixas
    Set campo = ThisWorkbook.Sheets(NomeArqHist).Range(vCampo, ThisWorkbook.Sheets(NomeArqHist).Range(vCampo).End(xlDown))
    If campo.Rows.Count < 100 Then
        j = 0
        For Each C In campo
            cf = Format(IIf(IsError(C.Value), "", C.Value), Formato)
            j = j + 1
            If j > 1 Then
                vRep = False
                For i = 1 To vComboBox.ListCount
                    If vComboBox.List(i - 1) = cf Then vRep = True
                Next
                If vRep = False And cf <> "" Then vComboBox.AddItem (cf)
            End If
        Next
    End If
    'Listando comboboxes - Lista de sug. hist|fffd|ricas
    vComboBox.AddItem (MarcHist)
    Set campo = ThisWorkbook.Sheets(NomeArqHist).Range(vCampo & "Hist", ThisWorkbook.Sheets(NomeArqHist).Range(vCampo & "Hist").End(xlDown))
    If campo.Rows.Count > 10000 Then Exit Sub
    j = 0
    For Each C In campo
        cf = Format(IIf(IsError(C.Value), "", C.Value), Formato)
        j = j + 1
        If j > 1 Then
            vRep = False
            For i = 1 To vComboBox.ListCount
                If vComboBox.List(i - 1) = cf Then vRep = True
            Next
            If vRep = False And cf <> "" Then vComboBox.AddItem (cf)
        End If
        Application.StatusBar = "Sugest|fffd|es Hist|fffd|ricas em " & vCampo & " " & j & "/" & campo.Rows.Count
    Next
    Application.StatusBar = False
End Sub


'EVENTOS DE CAIXA DE TEXTO PARA VALOR FINANCEIRO

Sub EvValor_Cb_MouseMove(Valor_Cb As Control, ByVal Button As Integer, ByVal Shift As Integer, ByVal x As Single, ByVal y As Single)
    Valor_Cb.Locked = False
    sd = Application.International(xlDecimalSeparator)
    If Valor_Cb.Text = "0" Or Valor_Cb.Text = "0" & sd & "00" Then
        Valor_Cb.SelStart = 0
        Valor_Cb.SelLength = Len(Valor_Cb.Text)
    End If
End Sub

Sub EvValor_Cb_KeyDown(Valor_Cb As Control, ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    sd = Application.International(xlDecimalSeparator)
    vKeyCode = IIf(sd = ",", 188, 190)
    Valor_Cb.Locked = False
    If KeyCode = 37 Or (Shift = 2 And KeyCode = 86) Or (Shift = 1 And KeyCode = 45) Or (Shift = 2 And KeyCode = 88) Then Exit Sub   'Seta Esquerda e teclas do clipboard
    If KeyCode = 110 Or KeyCode = 190 Then KeyCode = vKeyCode
    If KeyCode = 188 Then If InStr(1, Valor_Cb.Value, sd) > 0 Then Valor_Cb.Locked = True
    If (KeyCode >= 96 And KeyCode <= 105) _
            Or (KeyCode >= 48 And KeyCode <= 57 And Shift = 0) _
            Or KeyCode = 188 Or KeyCode = 8 Or KeyCode = 46 _
            Or KeyCode = 107 Or (KeyCode = 187 And Shift = 1) _
            Or KeyCode = 109 Or (KeyCode = 189 And Shift = 0) Then Else Valor_Cb.Locked = True
End Sub

Sub EvValor_Cb_Change(Valor_Cb As Control, Optional vAbs As Boolean = False)
    i = Valor_Cb.Value
    j = Valor_Cb.SelStart
    SinNeg = vAbs = False And InStr(1, i, "-") > 0 And InStr(1, i, "+") = 0
    i = Application.WorksheetFunction.Substitute(i, "-", "")
    i = Application.WorksheetFunction.Substitute(i, "+", "")
    PartInt = i
    sd = Application.International(xlDecimalSeparator)
    sm = Application.International(xlThousandsSeparator)
    k = InStr(1, i, sd)
    If k > 0 Then
        PartFrac = Mid(i, k + 1, 100)
        PartFrac = Application.WorksheetFunction.Substitute(PartFrac, sm, "")
        PartInt = Mid(i, 1, k - 1)
        If PartInt = "" Then PartInt = "0"
    End If
    TamPartInt = Len(PartInt)
    PartInt = Application.WorksheetFunction.Substitute(PartInt, sm, "")
    PartInt = Format(PartInt, "#,##0")
    RepCurs = Len(PartInt) - TamPartInt
    vEnableEvents = False
    Valor_Cb.Value = IIf(SinNeg, "-", "") & PartInt & IIf(PartInt = "" Or k = 0, "", sd) & PartFrac
    vEnableEvents = True
    j = -(j + RepCurs) * (j + RepCurs >= 0)
    If Left(Valor_Cb.Value, 2) = "0" & sd And j < 3 Then j = 2
    Valor_Cb.SelStart = j

    'Evita colar texto
    Static ValorOld
    If Valor_Cb.Value <> "" And Valor_Cb.Value <> "-" And Not (IsNumeric(Valor_Cb.Value)) Then
        MsgBox Valor_Cb.Value, vbCritical, "Valor Inv|fffd|lido!"
        Valor_Cb.Value = ValorOld
    Else
        ValorOld = Valor_Cb.Value
    End If
End Sub

Sub EvValor_Cb_Exit(Valor_Cb As Control, Cancel As MSForms.ReturnBoolean, Formato As String)
    If Valor_Cb.Value = "" Then Valor_Cb.Value = 0
    If IsNumeric(Valor_Cb.Value) Then
        If Valor_Cb.Value <> Format(Valor_Cb.Value, Formato) Then Valor_Cb.Value = Format(Valor_Cb.Value, Formato)
    Else
        MsgBox "Data inv|fffd|lida!", vbCritical, "CPAP|fffd|"
        Cancel = True
    End If
End Sub


Sub CalculadoraBtClick(vForm As Object, Valor_Cb As Control, Calculadora_Bt As Control, NumDecim As Integer)
    Calculadora_Bt.SpecialEffect = fmSpecialEffectSunken
    If IsNumeric(Valor_Cb.Value) Then CalculadoraValorIni = IIf(Valor_Cb.Value * 1 = 0, 0, Valor_Cb.Value) Else CalculadoraValorIni = 0
    Workbooks("cpap_pri.mac").Sheets(1).Range("CalcVal").Value = CalculadoraValorIni
    Workbooks("cpap_pri.mac").Sheets(1).Range("CalcDec").Value = NumDecim

    Application.ExecuteExcel4Macro ("cpap_pri.mac!CalcVBA()")

    Valor_Cb.Value = Workbooks("cpap_pri.mac").Sheets(1).Range("CalcVal").Value
    Valor_Cb.SetFocus
    Calculadora_Bt.SpecialEffect = fmSpecialEffectEtched
End Sub



'EVENTOS DE CAIXA DE TEXTO DO CALEND|fffd|RIO

Sub EvCalend_Cb_MouseMove(Data_Cb As Control, ByVal Button As Integer, ByVal Shift As Integer, ByVal x As Single, ByVal y As Single)
    Data_Cb.Locked = False
End Sub

Sub EvCalend_Cb_KeyDown(Data_Cb As Control, ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    j = Data_Cb.SelStart
    If KeyCode = 220 Or KeyCode = 191 Then KeyCode = 111   'Trocando \ por /
    If KeyCode = 8 Then KeyCode = 37    'Trocando Backspace por ser a esquerda

    'Setas, teclas do clipboard e /
    If KeyCode = 16 Or KeyCode = 17 _
            Or KeyCode = 37 Or KeyCode = 39 _
            Or (Shift = 2 And KeyCode = 67) _
            Or (Shift = 2 And KeyCode = 86) _
            Or (Shift = 1 And KeyCode = 45) _
            Or (Shift = 2 And KeyCode = 88) _
            Or (KeyCode = 111 And j > 0 And j < 8) Then
        Data_Cb.Locked = False
        Exit Sub
    End If
    If Data_Cb.SelLength > 1 Then Data_Cb.SelStart = j
    If j = 2 Or j = 5 Then Data_Cb.SelStart = j + 1
    Data_Cb.Locked = False
    If (KeyCode >= 96 And KeyCode <= 105) Or (KeyCode >= 48 And KeyCode <= 57 And Shift = 0) Then Else Data_Cb.Locked = True
    If j >= 8 Then Data_Cb.Locked = True
End Sub

Sub EvCalend_Cb_Change(Data_Cb As Control)
    If vEnableEvents = False Then Exit Sub
    i = Data_Cb.Value
    j = Data_Cb.SelStart
    'Eliminando barra dupla
    iSbd = Application.WorksheetFunction.Substitute(i, "//", "/")
    If i <> iSbd Then
        vEnableEvents = False
        Data_Cb.Value = iSbd
        vEnableEvents = True
        j = InStr(1, i, "//")
        Data_Cb.SelStart = j
        Exit Sub
    End If
    'Prevendo e para manter o formato dd/mm/yy, substituir
    If Len(i) > 8 And j > 0 Then
        vEnableEvents = False
        Data_Cb.Value = Left(i, j) & Mid(i, j + 2, 200)
        vEnableEvents = True
        If j = 2 Or j = 5 Then
            Data_Cb.SelStart = j + 1
        Else
            Data_Cb.SelStart = j
        End If
    End If
    'Tentando limitar a parte do dia
    i = Data_Cb.Value
    If Mid(i, 3, 1) = "/" And IsNumeric(Left(i, 2)) Then
        If Left(i, 2) > 31 And Left(i, 2) < 40 Then
            vEnableEvents = False
            Data_Cb.Value = "30" & Mid(i, 3, 200)
            vEnableEvents = True
            Data_Cb.SelStart = 1
        End If
        If Left(i, 2) > 39 Then
            vEnableEvents = False
            Data_Cb.Value = "0" & Left(i, 1) & Mid(i, 3, 200)
            vEnableEvents = True
            Data_Cb.SelStart = 3
        End If
    End If
    'Tentando limitar a parte do m|fffd|s
    If Mid(i, 3, 1) = "/" And Mid(i, 6, 1) = "/" And IsNumeric(Mid(i, 4, 2)) Then
        If Mid(i, 4, 2) > 12 And Mid(i, 4, 2) < 20 Then
            vEnableEvents = False
            Data_Cb.Value = Left(i, 3) & "12" & Mid(i, 6, 200)
            vEnableEvents = True
            Data_Cb.SelStart = 4
        End If
        If Mid(i, 4, 2) > 19 Then
            vEnableEvents = False
            Data_Cb.Value = Left(i, 3) & "0" & Mid(i, 4, 1) & Mid(i, 6, 200)
            vEnableEvents = True
            Data_Cb.SelStart = 6
        End If
    End If
End Sub

Sub EvCalend_Cb_Exit(Data_Cb As Control, ByVal Cancel As MSForms.ReturnBoolean, Optional DataIni As Date)
    If DataIni = 0 Then DataIni = Now
    i = Data_Cb.Value
    If IsDate(i) Then
        If NmesIndMax = 0 Then NmesIndMax = Workbooks("cpap_pri.mac").Excel4MacroSheets(1).Range("NmesIndMax").Value
        If DateValue(i) < DateSerial(1970, 5, 15) Or DateValue(Data_Cb.Value) > DateSerial(1970, 5 + NmesIndMax, 1) Then
            MsgBox "Data inv|fffd|lida. Digite uma data entre " & Format(DateSerial(1970, 5, 15), "dd/mm/yyyy") & " e " & Format(DateSerial(1970, 5 + NmesIndMax, 1), "dd/mm/yyyy") & ".", vbCritical, "CPAP|fffd|"
            Cancel = True
        End If
        If i <> Format(DateValue(i), "dd/mm/yy") Then Data_Cb.Value = Format(DateValue(i), "dd/mm/yy")
    Else
        'Tentando resolver final de m|fffd|s
        z = InStr(1, i, "/")
        If z > 1 Then
            I1 = Left(i, z - 1)
            i2 = Mid(i, z, 250)
            If IsNumeric(I1) Then
                If IsDate(I1 - 1 & i2) Then
                    Data_Cb.Value = Format(DateValue(I1 - 1 & i2), "dd/mm/yy")
                    Exit Sub
                End If
                If IsDate(I1 - 2 & i2) Then
                    Data_Cb.Value = Format(DateValue(I1 - 2 & i2), "dd/mm/yy")
                    Exit Sub
                End If
                If IsDate(I1 - 3 & i2) Then
                    Data_Cb.Value = Format(DateValue(I1 - 3 & i2), "dd/mm/yy")
                    Exit Sub
                End If
            End If
        End If
        If MsgBox("OK  -  Restaurar inicial, " & Format(DataIni, "dd/mm/yy") & ";" & Chr(10) & Chr(10) & "Cancelar - Voltar para alterar.", vbQuestion + vbOKCancel, "Data Inv|fffd|lida!  Campo: " & Left(Data_Cb.Name, InStr(1, Data_Cb.Name, "_") - 1)) = vbOK Then
            Data_Cb.Value = Format(DataIni, "dd/mm/yy")
        Else
            Cancel = True
        End If
    End If
End Sub


Sub CalendBtClick(vForm As Object, Data_Cb As Control, Calend_Bt As Control)
    Calend_Bt.SpecialEffect = fmSpecialEffectSunken
    CalendDataIni = IIf(IsDate(Data_Cb.Value), Data_Cb.Value, Date)
    Workbooks("cpap_pri.mac").Sheets(1).Range("CalendVal").Value = CalendDataIni

    Application.ExecuteExcel4Macro ("cpap_pri.mac!CalendVBA()")

    Data_Cb.Value = Format(Workbooks("cpap_pri.mac").Sheets(1).Range("CalendVal").Value, "dd/mm/yy")
    Data_Cb.SetFocus
    Calend_Bt.SpecialEffect = fmSpecialEffectEtched
End Sub



'EVENTOS DE CAIXA DE TEXTO PARA N|fffd|MERO DE TELEFONE

Sub EvFone_Cb_Change(Fone_Cb As Control)
    i = Fone_Cb.Value
    j = Fone_Cb.SelStart
    k = Len(i)
    i = Application.WorksheetFunction.Substitute(i, ".", "")
    i = Application.WorksheetFunction.Substitute(i, "-", "")
    vEnableEvents = False
    Fone_Cb.Value = IIf(Len(i) > 3, Left(i, 3) & "-" & Mid(i, 4, 20), i)
    If Len(i) > 7 Then Fone_Cb.Value = Left(i, Len(i) + 4 * (Len(i) > 4)) & "-" & Right(i, 4)
    vEnableEvents = True
    If j < k Then Fone_Cb.SelStart = j
End Sub

Sub EvFone_Cb_KeyDown(Fone_Cb As Control, ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Fone_Cb.Locked = False
    If KeyCode = 37 Or (Shift = 2 And KeyCode = 86) Or (Shift = 1 And KeyCode = 45) Or (Shift = 2 And KeyCode = 88) Then Exit Sub   'Seta Esquerda e teclas do clipboard
    If KeyCode = 188 Then If InStr(1, Fone_Cb.Value, sd) > 0 Then Fone_Cb.Locked = True
    If (KeyCode >= 96 And KeyCode <= 105) Or (KeyCode >= 48 And KeyCode <= 57 And Shift = 0) Or KeyCode = 188 Or KeyCode = 8 Or KeyCode = 46 Then Else Fone_Cb.Locked = True
End Sub

Sub DesvanecerMesmoPa|fffd|s(Fone_Cb As Control)
    Pa|fffd|sEmpr = Workbooks("Cpap_pri.mac").Excel4MacroSheets(1).Range("Pa|fffd|sEmpr").Value & ""
    Fone_Cb.BackColor = IIf(Fone_Cb.Value = Pa|fffd|sEmpr, &H8000000F, &H80000005)
    Fone_Cb.ForeColor = IIf(Fone_Cb.Value = Pa|fffd|sEmpr, &H80000016, &H80000008)
End Sub

Sub DesvanecerMesmaCid(Fone_Cb As Control)
    CidEmpr = Workbooks("Cpap_pri.mac").Excel4MacroSheets(1).Range("CidEmpr").Value & ""
    Fone_Cb.BackColor = IIf(Fone_Cb.Value = CidEmpr, &H8000000F, &H80000005)
    Fone_Cb.ForeColor = IIf(Fone_Cb.Value = CidEmpr, &H80000016, &H80000008)
End Sub


Attribute VB_Name = "M|fffd|d4Editada"
Sub Editada()
    Dim WbEditada As Workbook
    Set WbEditada = ThisWorkbook
    Windows(WbEditada.Windows(1).Caption).Visible = True
    WbEditada.Activate

    For Each Sh In WbEditada.Sheets
        'Este loop |fffd| usado s|fffd| onde houver planilha de hist|fffd|rico
        If Right(Sh.Name, 4) = ".hst" Then
            Sh.Activate
            NumCampos = Range("A1").CurrentRegion.Columns.Count
            NumSugPadr = Range("A1").CurrentRegion.Rows.Count
            Set Campos = Range(Cells(1, 1), Cells(1, NumCampos))

            'Limpando
            Range("DadosFixos").CurrentRegion.Clear
            Range("DadosHist").CurrentRegion.Clear
            For Each Nome In ActiveWorkbook.ActiveSheet.Names
                Nome.Delete
            Next
            With ActiveWindow
                .SplitColumn = 0
                .SplitRow = 12
            End With

            'Redefinindo
            LFix = 4 + 100   'N|fffd|m de linhas reservadas para sug. fixas. Pode ser alterado o c|fffd|digo |fffd| flex|fffd|vel
            With ActiveWorkbook.ActiveSheet.Names
                Ref = "=" & ActiveWorkbook.ActiveSheet.Name & "!" & Cells(NumSugPadr + 4, 1).Address(ReferenceStyle:=xlR1C1)
                .Add Name:="DadosFixos", RefersToR1C1:=Ref
                Ref = "=" & ActiveWorkbook.ActiveSheet.Name & "!" & Cells(NumSugPadr + 4 + LFix + 1, 1).Address(ReferenceStyle:=xlR1C1)
                .Add Name:="DadosHist", RefersToR1C1:=Ref


                For Each C In Campos
                    .Add Name:=C.Value, RefersToR1C1:=Cells(NumSugPadr + 4, C.Column)
                    .Add Name:=C.Value & "Hist", RefersToR1C1:=Cells(NumSugPadr + 4 + LFix + 2, C.Column)
                    C.Offset(NumSugPadr + 4 + LFix, 0).Value = 15
                    C.Offset(NumSugPadr + 4 + LFix + 1, 0).Value = C.Value & "Hist"
                Next
            End With
            Range("A1").CurrentRegion.Copy
            Range("DadosFixos").PasteSpecial xlPasteValues
            Application.CutCopyMode = False

            ActiveWindow.Panes(1).Activate
            Application.GoTo Reference:="DadosFixos", Scroll:=True
            ActiveWindow.Panes(3).Activate
            Application.GoTo Reference:="DadosHist", Scroll:=True
        End If
    Next

    If WbEditada.ReadOnly Then WbEditada.ChangeFileAccess xlReadWrite
    If Val(Application.Version) < 9 Then If MsgBox(WbEditada.Name & ".  Indenter? (Distanciar margens)", vbOKCancel) = vbOK Then Run "Indenter97.xla!IndentProject"
    WbEditada.Sheets(1).Select
    If MsgBox(WbEditada.Name & ".  Limpar C|fffd|digo?", vbOKCancel) = vbOK Then
        Application.OnTime Now, "VBACodeCleaner.xla!CodeCleanerMain"
    Else
        WbEditada.Save
    End If
End Sub
Attribute VB_Name = "Plan5"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

























Attribute VB_Name = "UserForm1TabMista"
Attribute VB_Base = "0{FDE0CFC8-D8AB-4DF0-8DFB-DC1F97C939B0}{396F6EA4-C4DD-4643-9422-83FC84CC47AF}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Dim UltDispM, UltDispS As String

'Necess|fffd|rio, devido bug Setfocus em textbox do Excel2k. Isto foi resolvido com SendKeys tamb|fffd|m
Dim ControleAtivo As Control

Private Sub UserForm_Activate()
    Top = 3: Left = 3
    Cancelar_Bt.SetFocus
    ControleAtivo.SetFocus
    Application.SendKeys "{HOME}"
End Sub
Private Sub UserForm_Deactivate()
    Set ControleAtivo = ActiveControl
End Sub

Private Sub UserForm_Initialize()
    vEnableEvents = True
    ListandoComboBox TabMista_Cb
    'ListandoComboBox |fffd|ndice_Cb
    nTab = Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("nTab").Value
    For i = 1 To nTab
        |fffd|ndice_Cb.AddItem (Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("Indices1").Item(i).Value)
    Next
    |fffd|ndice_Cb.AddItem ("Clicar aqui para atualizar esta rela|fffd||fffd|o")
    'Listando combobox MesesDbf_cb
    If NmesIndMax = 0 Then NmesIndMax = Workbooks("cpap_pri.mac").Excel4MacroSheets(1).Range("NmesIndMax").Value
    For i = 1 To NmesIndMax
        MesesDbf_Cb.AddItem (Format(DateSerial(1970, 4 + i, 1), "mm/yy"))
    Next
    Set ControleAtivo = TabMista_Cb
End Sub

Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    BotAcionado = False
End Sub

Private Sub Ok_Bt_Click()
'Criticar
    If CriticarTabMist(True) = "" Then
        Hide
        BotAcionado = 1
    End If
End Sub

Private Sub Cancelar_Bt_Click()
    Hide
    BotAcionado = False
End Sub

Private Sub Ajuda_Bt_Click()
    If bHtmlHelp Then Application.Run "CPAP_EX8.MAC!HelpVBA", ThisWorkbook.Path & "\CPAP.chm", HelpContextID, 2 Else Application.Help ThisWorkbook.Path & "\cpap.hlp", HelpContextID
End Sub

Private Sub MesesDbfCalend_Bt_Click()
    MesesDbf_Cb.Style = fmStyleDropDownCombo
    MesesDbf_Cb.MatchRequired = False
    MesesDbf_Cb.Value = "01/" & MesesDbf_Cb.Value
    CalendBtClick UserForm1TabMista, MesesDbf_Cb, MesesDbfCalend_Bt
    i = Application.Run("cpap_ex8.mac!M|fffd|sNoDbf", MesesDbf_Cb.Value)
    MesesDbf_Cb.Value = MesesDbf_Cb.List(i - 1)
    MesesDbf_Cb.Style = fmStyleDropDownList
    MesesDbf_Cb.MatchRequired = True
End Sub

Private Sub TabMista_Cb_Change()
    If vEnableEvents = False Then Exit Sub
    If TabMista_Cb.Value = MarcHist Then ConfHist TabMista_Cb, TabMist(3), True
    DecomporTab TabMista_Cb.Value

    'Limpando Listbox
    vEnableEvents = False
    Comp_LstB.ListIndex = -1
    While Comp_LstB.ListCount >= 1
        Comp_LstB.RemoveItem (0)
    Wend
    'Povoando listbox
    For i = 0 To UBound(CompTab(), 1)
        Comp_LstB.AddItem (CompTab(i, 0) & " at|fffd| " & Choose(1 - 1 * (CompTab(i, 1) = "") - 2 * (CompTab(i, 1) = "Entrg"), CompTab(i, 1), "o fim", "a Entrega do Bem"))
    Next
    vEnableEvents = True
    If UBound(CompTab(), 1) = 0 Then Comp_LstB.ListIndex = 0
    OcultarExibControles
End Sub
'Esses eventos impedem altera|fffd||fffd|es pelo teclado.
Private Sub TabMista_Cb_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    If KeyCode <> 9 Then TabMista_Cb.Locked = True   'TAB (KeyCode=9) n|fffd|o aciona evento KeyUp
End Sub
Private Sub TabMista_Cb_KeyUp(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    TabMista_Cb.Locked = False
End Sub

Private Sub Comp_LstB_Change()
    If vEnableEvents = False Then Exit Sub
    If Comp_LstB.ListIndex = -1 Then Exit Sub
    I1 = Left(Comp_LstB.Value, Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.Value) - 1)
    If InStr(1, I1, "//Nenhum") > 0 Then I1 = "$//Nenhum"
    vEnableEvents = False
    Err.Number = 0
    On Error Resume Next
    |fffd|ndice_Cb.Value = I1
    If Err.Number <> 0 Then
        If InStr(1, I1, "[") + InStr(1, I1, "@") = 0 Then MsgBox "A tabela de |fffd|ndices " & I1 & " n|fffd|o foi encontrada. Pode ter sido exclu|fffd|da ou seu nome alterado. Indique uma nova tabela.", vbCritical, "Falha"
        |fffd|ndice_Cb.ListIndex = -1
    End If
    nInd = |fffd|ndice_Cb.ListIndex + 1
    '   vEnableEvents = True
    i2 = Mid(Comp_LstB.Value, Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.Value) + 5, 255)
    At|fffd|Entrega_OpB.Value = i2 = "a Entrega do Bem"
    At|fffd|Final_OpB.Value = i2 = "o fim"
    If Not (At|fffd|Entrega_OpB.Value Or At|fffd|Final_OpB.Value) Then
        At|fffd|M|fffd|s_OpB = True
        MesesDbf_Cb.Value = i2
    End If
    vEnableEvents = True
    OcultarExibControles
End Sub

Private Sub ComporOp_ChB_Click()
    Dim TabOpI As String
    If vEnableEvents = False Then Exit Sub
    I1 = Comp_LstB.Value
    TabOpI = Mid(I1, 1, Application.WorksheetFunction.Find(" at|fffd| ", I1) - 1)
    If InStr(1, TabOpI, "//Nenhum") > 0 Then
        MsgBox "Defina uma tabela na linha selecionada para compor a opera|fffd||fffd|o.", vbCritical + vbOKOnly, "Tabela Indefinida"
        vEnableEvents = False: ComporOp_ChB.Value = False: vEnableEvents = True
        Exit Sub
    End If

    UserForm2TabMistaOp.HelpContextID = HelpContextID

    DecomporTabOp TabOpI
    UserForm2TabMistaOp.TabMistaOp_Cb.Value = TabOpI

    UserForm2TabMistaOp.Caption = Caption

    Application.ScreenUpdating = True
    UserForm1TabMista.Cancelar_Bt.SetFocus
    Application.StatusBar = False
    UserForm2TabMistaOp.Show
    Application.ScreenUpdating = True
    '   TabMist(1) = BotAcionado
    '   If FecharArq Then TabMist(2) = "Fechar"
    If BotAcionado <> False Then
        Application.ScreenUpdating = False
        'Atualizar hist|fffd|rico
        Application.ScreenUpdating = False
        DirBD = Application.Evaluate(Workbooks("cpap_pri.mac").Names("DirBD").Value)    'DirP = ThisWorkbook.Path
        If MyOpenFile(DirBD & "\banco\" & NomeArqHist, False) Then
            SalvarHist = False
            AtuHist "TabMistaOp", UserForm2TabMistaOp.TabMistaOp_Cb.Value, TabOpI
            If SalvarHist Then SalvandoHist Else Workbooks(NomeArqHist).Close False
        End If
        'Transferindo dados
        i2 = Mid(I1, Application.WorksheetFunction.Find(" at|fffd| ", I1) + 5, 255)
        k = Comp_LstB.ListIndex
        vEnableEvents = False
        Comp_LstB.List(k) = UserForm2TabMistaOp.TabMistaOp_Cb.Value & " at|fffd| " & i2
        vEnableEvents = True
        ComporTab
        Comp_LstB_Change
        Application.ScreenUpdating = True
    End If
    vEnableEvents = False: ComporOp_ChB.Value = False: vEnableEvents = True
    Unload UserForm2TabMistaOp
End Sub


Private Sub |fffd|ndice_Cb_Click()
    If vEnableEvents = False Then Exit Sub
    i = |fffd|ndice_Cb.ListIndex + 1
    nTab = Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("nTab").Value
    If i = nTab + 1 Then
        If nInd > 0 Then t = |fffd|ndice_Cb.List(nInd - 1)
        Application.ExecuteExcel4Macro ("cpap_jap.mac!BancoTab()")
        'Limpando comboboxes
        vEnableEvents = False
        |fffd|ndice_Cb.ListIndex = -1
        While |fffd|ndice_Cb.ListCount >= 1
            |fffd|ndice_Cb.RemoveItem (0)
        Wend
        'Repovoando
        nTab = Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("nTab").Value
        For j = 1 To nTab
            |fffd|ndice_Cb.AddItem (Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("Indices1").Item(j).Value)
        Next
        |fffd|ndice_Cb.AddItem ("Clicar aqui para atualizar esta rela|fffd||fffd|o")
        Err.Number = 0
        On Error Resume Next
        If nInd > 0 Then |fffd|ndice_Cb.Value = t
        If Err.Number <> 0 Then
            MsgBox "A tabela de |fffd|ndices " & t & " n|fffd|o foi encontrada. Pode ter sido exclu|fffd|da ou seu nome alterado. Indique uma nova tabela.", vbCritical, "Falha"
            |fffd|ndice_Cb.ListIndex = -1
        End If
        On Error GoTo 0
        vEnableEvents = True
        Application.ScreenUpdating = True
    Else
        k = Comp_LstB.ListIndex
        If k >= 0 Then
            i2 = Comp_LstB.List(k)
            UM = Left(i2, Application.WorksheetFunction.Find("//", i2) - 1)
            IndCbV = |fffd|ndice_Cb.Value
            If IndCbV = "$//Nenhum" Then IndCbV = UM & "//Nenhum"
            UM1 = Left(IndCbV, Application.WorksheetFunction.Find("//", IndCbV) - 1)
            If UM1 <> UM And UM <> "$" Then
                MsgBox "Voc|fffd| s|fffd| pode compor tabelas de mesma unidade monet|fffd|ria. Indique tabelas de " & UM & "!"
                I1 = Left(i2, Application.WorksheetFunction.Find(" at|fffd| ", i2) - 1)
                vEnableEvents = False
                IndCbV = I1
                |fffd|ndice_Cb.ListIndex = nInd - 1
                i = nInd
                vEnableEvents = True
                Exit Sub
            End If
            i2 = Mid(i2, Application.WorksheetFunction.Find(" at|fffd| ", i2) + 5, 255)
            vEnableEvents = False
            Comp_LstB.List(k) = IndCbV & " at|fffd| " & i2
            vEnableEvents = True
            ComporTab
        End If
        nInd = i
    End If
    OcultarExibControles
    On Error Resume Next
    Comp_LstB.SetFocus   'Isto, n|fffd|o sei porque, evita mensagem de propriedade inv|fffd|lida ao sugerir imediatamente uma tabela na lista de hist|fffd|rico
End Sub

Private Sub At|fffd|Entrega_OpB_Change()
    If vEnableEvents = False Then Exit Sub
    k = Comp_LstB.ListIndex
    If k >= 0 And At|fffd|Entrega_OpB.Value Then
        I1 = Left(Comp_LstB.Value, Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.Value) - 1)
        vEnableEvents = False
        Comp_LstB.List(k) = I1 & " at|fffd| " & "a Entrega do Bem"
        vEnableEvents = True
        ComporTab
        OcultarExibControles
    End If
End Sub

Private Sub At|fffd|Final_OpB_Change()
    If vEnableEvents = False Then Exit Sub
    k = Comp_LstB.ListIndex
    If k >= 0 And At|fffd|Final_OpB.Value Then
        I1 = Left(Comp_LstB.Value, Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.Value) - 1)
        vEnableEvents = False
        Comp_LstB.List(k) = I1 & " at|fffd| " & "o fim"
        vEnableEvents = True
        ComporTab
        OcultarExibControles
    End If
End Sub

Private Sub At|fffd|M|fffd|s_OpB_Change()
    If vEnableEvents = False Then Exit Sub
    k = Comp_LstB.ListIndex
    If k >= 0 And At|fffd|M|fffd|s_OpB.Value Then
        I1 = Left(Comp_LstB.Value, Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.Value) - 1)
        vEnableEvents = False
        If MesesDbf_Cb.Value = "" Then MesesDbf_Cb.Value = Format(DateSerial(Year(Date), Month(Date) - 1, 1), "mm/yy")
        Comp_LstB.List(k) = I1 & " at|fffd| " & MesesDbf_Cb.Value
        vEnableEvents = True
        ComporTab
        OcultarExibControles
    End If
End Sub

Private Sub MesesDbf_Cb_Change()
    If vEnableEvents = False Then Exit Sub
    At|fffd|M|fffd|s_OpB.Value = True
    k = Comp_LstB.ListIndex
    If k >= 0 And At|fffd|M|fffd|s_OpB.Value Then
        I1 = Left(Comp_LstB.Value, Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.Value) - 1)
        vEnableEvents = False
        Comp_LstB.List(k) = I1 & " at|fffd| " & MesesDbf_Cb.Value
        vEnableEvents = True
        ComporTab
        OcultarExibControles
    End If
End Sub

Private Sub Mover_Sb_SpinUp()
    i = Comp_LstB.ListIndex
    If i < 1 Then Exit Sub
    Comp_LstB.AddItem Comp_LstB.List(i), i - 1
    Comp_LstB.RemoveItem i + 1
    Comp_LstB.Selected(i - 1) = True
    ComporTab
    OcultarExibControles
End Sub

Private Sub Mover_Sb_SpinDown()
    i = Comp_LstB.ListIndex
    If i < 0 Or i + 1 >= Comp_LstB.ListCount Then Exit Sub
    Comp_LstB.AddItem Comp_LstB.List(i), i + 2
    Comp_LstB.RemoveItem i
    Comp_LstB.Selected(i + 1) = True
    ComporTab
    OcultarExibControles
End Sub

Private Sub Adicionar_Bt_Click()
    i2 = Comp_LstB.List(0)
    UM = Left(i2, Application.WorksheetFunction.Find("//", i2) - 1)
    If UM = "$" Then
        MsgBox "Indique uma tabela para a primeira linha antes de adicionar outra.", vbCritical, "Unidade Monet|fffd|ria Ainda Indefinida!"
        Exit Sub
    End If
    i = Comp_LstB.ListIndex
    If i < 0 Or i + 1 >= Comp_LstB.ListCount Then
        Comp_LstB.AddItem UM & "//Nenhum at|fffd| o fim"
        Comp_LstB.Selected(Comp_LstB.ListCount - 1) = True
    Else
        Comp_LstB.AddItem UM & "//Nenhum at|fffd| o fim", i + 1
        Comp_LstB.Selected(i + 1) = True
    End If
    ComporTab
    Static vTip As Boolean
    If vTip = False Then MsgBox "Uma linha para um novo componente foi acrescentada ao final da lista. Agora defina o nome da tabela e o limite de aplica|fffd||fffd|o da mesma. Em seguida, se necess|fffd|rio, mova para a posi|fffd||fffd|o desejada.", vbInformation + vbOKOnly, "Linha Adicionada"
    vTip = True
End Sub

Private Sub Excluir_Bt_Click()
    i = Comp_LstB.ListIndex
    If Comp_LstB.ListCount > 0 Then Comp_LstB.RemoveItem i
    If Comp_LstB.ListCount = 0 Then Comp_LstB.AddItem ("$//Nenhum at|fffd| o fim")
    ComporTab
    OcultarExibControles
End Sub

Private Sub Agenda_Click()
    Application.ExecuteExcel4Macro ("cpap_pri.mac!Calendario()")
End Sub

Sub ComporTab()
    n = Comp_LstB.ListCount
    TabC = ""
    For k = 0 To n - 1
        TabC = TabC & Comp_LstB.List(k) & IIf(k <> n - 1, ", ", "")
    Next
    TabC = Application.WorksheetFunction.Substitute(TabC, "a Entrega do Bem", "Entrg")
    If n = 1 Then TabC = Application.WorksheetFunction.Substitute(TabC, " at|fffd| o fim", "")
    UM = Mid(TabC, 1, Application.WorksheetFunction.Find("//", TabC) - 1)
    TabC = UM & "//" & Application.WorksheetFunction.Substitute(TabC, UM & "//", "")
    vEnableEvents = False
    TabMista_Cb.Value = TabC
    vEnableEvents = True
End Sub

Sub OcultarExibControles()
    If Comp_LstB.ListIndex < 0 Then
        ComporOp_ChB.Enabled = False
        vEnableEvents = False
        |fffd|ndice_Cb.ListIndex = -1
        nInd = 1
        MesesDbf_Cb.ListIndex = -1
        At|fffd|Final_OpB.Value = False
        At|fffd|Entrega_OpB.Value = False
        At|fffd|M|fffd|s_OpB = False
        vEnableEvents = True

        |fffd|ndice_Cb.Enabled = False
        At|fffd|Final_OpB.Enabled = False
        At|fffd|Entrega_OpB.Enabled = False
        At|fffd|M|fffd|s_OpB.Enabled = False
        MesesDbf_Cb.Enabled = False
        Mover_Sb.Enabled = False
        Excluir_Bt.Enabled = False
        VisualTab_Chb.Enabled = False
    Else
        ComporOp_ChB.Enabled = True
        |fffd|ndice_Cb.Enabled = True
        At|fffd|Final_OpB.Enabled = True
        At|fffd|Entrega_OpB.Enabled = True
        At|fffd|M|fffd|s_OpB.Enabled = True
        MesesDbf_Cb.Enabled = True
        Mover_Sb.Enabled = True
        Excluir_Bt.Enabled = True
        VisualTab_Chb.Enabled = True
    End If

    If |fffd|ndice_Cb.ListIndex < 1 Then |fffd|ndice_Lb.Caption = "Tabela de |fffd|ndices:"
    If |fffd|ndice_Cb.ListIndex > 0 And UltDispS <> |fffd|ndice_Cb.Value Then
        |fffd|ndice_Lb.Caption = "Tab. de |fffd|ndices: (" & |fffd|ndicesDispon|fffd|veis(|fffd|ndice_Cb.Value, nInd) & ")"
        UltDispS = |fffd|ndice_Cb.Value
    End If
    |fffd|ndice_Lb.ForeColor = IIf(InStr(1, |fffd|ndice_Lb.Caption, "!") > 0, &HFF&, &H80000012)
    If UltDispM <> TabMista_Cb.Value Then
        IndDisp = CriticarTabMist(False)
        nTab = Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("nTab").Value
        If IndDisp = "" Then IndDisp = |fffd|ndicesDispon|fffd|veis(TabMista_Cb.Value, 1 + nTab + 1)
        TabMista_Lb.Caption = "Tabela de |fffd|ndices Mista: (" & IndDisp & ")"
        TabMista_Lb.ForeColor = IIf(InStr(1, TabMista_Lb.Caption, "!") > 0, &HFF&, &H80000012)
        TabMista_Cb.ControlTipText = IIf(Len(TabMista_Cb.Value) < 110, "", TabMista_Cb.Value)
        UltDispM = TabMista_Cb.Value
    End If
    If Comp_LstB.ListIndex > -1 Then Comp_LstB.ControlTipText = IIf(Len(Comp_LstB.Value) < 50, "", Comp_LstB.Value) Else Comp_LstB.ControlTipText = ""
    Application.ScreenUpdating = True
End Sub

Function CriticarTabMist(ComAlert As Boolean)
    CriticarTabMist = ""
    '  String m|fffd|x. para XLM
    If Len(TabMista_Cb.Value) > 255 Then
        CriticarTabMist = "Falha! Nome > 255 caracteres"
        If ComAlert Then MsgBox "O nome da tabela cont|fffd|m mais de 255 caracteres. Verifique.", vbCritical + vbOKOnly, "Nome Muito Longo"
        Exit Function
    End If

    '  Verif. limite final
    i = Comp_LstB.ListCount
    i2 = Mid(Comp_LstB.List(i - 1), Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.List(i - 1)) + 5, 255)
    If i2 <> "o fim" Then
        CriticarTabMist = "Falha! Tab. final indefinida"
        If ComAlert = False Then Exit Function
        If MsgBox("A |fffd|ltima tabela da seq|fffd||fffd|ncia est|fffd| limitada a " & i2 & ". Tem certeza que n|fffd|o quer aplicar nenhuma tabela de |fffd|ndice ap|fffd|s este limite?", vbQuestion + vbYesNo, "Tabela Final") = vbYes Then
            I1 = Comp_LstB.List(0)
            UM = Left(I1, Application.WorksheetFunction.Find("//", I1) - 1)
            Comp_LstB.AddItem UM & "//Nenhum at|fffd| o fim"
            ComporTab
        Else
            Exit Function
        End If
    End If

    'Verif. limites repetidos
    For i = 0 To Comp_LstB.ListCount - 2
        L1 = Mid(Comp_LstB.List(i), Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.List(i)) + 5, 255)
        For k = i + 1 To Comp_LstB.ListCount - 1
            L2 = Mid(Comp_LstB.List(k), Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.List(k)) + 5, 255)
            If L1 = L2 Then
                CriticarTabMist = "Falha! H|fffd| tabelas com igual limite"
                If ComAlert Then MsgBox "H|fffd| tabelas usando o mesmo limite (" & L1 & "). Verifique.", vbCritical + vbOKOnly, "Incongru|fffd|ncia na Seq|fffd|encia de Tabelas"
                Exit Function
            End If
        Next
    Next

    'Verif. a seq. dos limites, ignorando entrg
    For i = 0 To Comp_LstB.ListCount - 2
        L1 = Mid(Comp_LstB.List(i), Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.List(i)) + 5, 255)
        If L1 <> "a Entrega do Bem" Then
            For k = i + 1 To Comp_LstB.ListCount - 2
                L2 = Mid(Comp_LstB.List(k), Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.List(k)) + 5, 255)
                If L2 <> "a Entrega do Bem" Then
                    If DateValue("01/" & L2) < DateValue("01/" & L1) Then
                        CriticarTabMist = "Falha! Limites fora de seq|fffd||fffd|ncia"
                        If ComAlert Then MsgBox "O limite " & L1 & " |fffd| posterior ao " & L2 & ", mas est|fffd| antes na seq|fffd||fffd|ncia de tabelas. Verifique os limites.", vbCritical + vbOKOnly, "Incongru|fffd|ncia na Seq|fffd|encia de Tabelas"
                        Exit Function
                    End If
                End If
            Next
        End If
    Next

    'Verif. tab. de mesmo nome em seq. imediata
    For i = 0 To Comp_LstB.ListCount - 2
        t1 = Left(Comp_LstB.List(i), Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.List(i)) - 1)
        t2 = Left(Comp_LstB.List(i + 1), Application.WorksheetFunction.Find(" at|fffd| ", Comp_LstB.List(i + 1)) - 1)
        If t1 = t2 Then
            CriticarTabMist = "Falha! Tabela repetida imediatamemente"
            If ComAlert Then MsgBox "A tabela " & t1 & " repete-se de forma imediata. Exclua uma delas.", vbCritical + vbOKOnly, "Incongru|fffd|ncia na Seq|fffd|encia de Tabelas"
            Exit Function
        End If
    Next
End Function

Private Sub VisualTab_Chb_Click()
    If vEnableEvents = False Then Exit Sub
    vNomeInd = |fffd|ndice_Cb.Value
    nInd1 = |fffd|ndice_Cb.ListIndex + 1
    vUserFormTop = Top
    vUserFormLeft = Left + |fffd|ndice_Cb.Left + |fffd|ndice_Cb.Width
    Visual|fffd|ndices
    If Application.Workbooks("cpap_jap.mac").Sheets(1).Range("TabEdtda").Value Then
        UltDispM = "": UltDispS = ""
        OcultarExibControles
    End If
    vEnableEvents = False
    VisualTab_Chb.Value = False
    vEnableEvents = True
End Sub

Private Sub VisualTabM_Chb_Click()
    If vEnableEvents = False Then Exit Sub
    If CriticarTabMist(True) = "" Then
        vNomeInd = TabMista_Cb.Value
        nTab = Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("nTab").Value
        nInd1 = 1 + nTab + 1
        vUserFormTop = Top
        vUserFormLeft = Left + TabMista_Cb.Left + TabMista_Cb.Width
        Visual|fffd|ndices
        If Application.Workbooks("cpap_jap.mac").Sheets(1).Range("TabEdtda").Value Then
            UltDispM = "": UltDispS = ""
            OcultarExibControles
        End If
    End If
    vEnableEvents = False
    VisualTabM_Chb.Value = False
    vEnableEvents = True
End Sub

Private Sub WhatsThis_Img_MouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As Single, ByVal y As Single)
    Static cHHelpWhatsThis1 As Object
    If cHHelpWhatsThis1 Is Nothing Then Set cHHelpWhatsThis1 = Application.Run("CPAP_EX8.MAC!New_cHHelpWhatsThis")
    cHHelpWhatsThis1.WhatsThis_Img_MouseDown Button, Shift, x, y, Me
    If WhatsThis_Img.BackStyle = fmBackStyleOpaque Then Set cHHelpWhatsThis1 = Nothing
End Sub

Attribute VB_Name = "UserForm2TabMistaOp"
Attribute VB_Base = "0{9DCA6BF1-238E-42C1-B6E1-CF920A85D496}{F02425F4-04BE-4BCA-B649-E9153A0F5825}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Dim UltDispM, UltDispS As String
Dim M|fffd|diaMontada As String
Dim M|fffd|diaMontadaIdx As Single

'Necess|fffd|rio, devido bug Setfocus em textbox do Excel2k. Isto foi resolvido com SendKeys tamb|fffd|m
Dim ControleAtivo As Control

Private Sub UserForm_Activate()
    Top = UserForm1TabMista.Top + UserForm1TabMista.Frame1.Top + UserForm1TabMista.Comp_LstB.Top + 35 + UserForm1TabMista.Comp_LstB.ListIndex * 9.5
    Left = UserForm1TabMista.Left
    Cancelar_Bt.SetFocus
    ControleAtivo.SetFocus
    Application.SendKeys "{HOME}"
End Sub
Private Sub UserForm_Deactivate()
    Set ControleAtivo = ActiveControl
End Sub

Private Sub UserForm_Initialize()
'  Listando Oper_ListBox
    Oper_LstB.AddItem ("M|fffd|dia Aritm|fffd|tica")
    Oper_LstB.AddItem ("Adi|fffd||fffd|o Simples")
    Oper_LstB.AddItem ("Adi|fffd||fffd|o Composta")
    Oper_LstB.AddItem ("Subtra|fffd||fffd|o Simples")
    Oper_LstB.AddItem ("Subtra|fffd||fffd|o Composta")
    ' Listando Avan|fffd|Ref_Cb
    Avan|fffd|Ref_Cb.AddItem (" ")
    For i = 1 To 12
        Avan|fffd|Ref_Cb.AddItem (i)
    Next
    For i = 1 To 12
        Avan|fffd|Ref_Cb.AddItem (-i)
    Next
    '  Listando MontarM|fffd|dia_Cb
    MontarM|fffd|dia_Cb.AddItem ("Como montar tabela com m|fffd|dia de um |fffd|nico |fffd|ndice")
    MontarM|fffd|dia_Cb.AddItem ("M|fffd|dia de dois |fffd|ltimos valores")
    MontarM|fffd|dia_Cb.AddItem ("M|fffd|dia de tr|fffd|s |fffd|ltimos valores")
    MontarM|fffd|dia_Cb.AddItem ("M|fffd|dia de quatro |fffd|ltimos valores")
    MontarM|fffd|dia_Cb.AddItem ("M|fffd|dia de cinco |fffd|ltimos valores")
    MontarM|fffd|dia_Cb.AddItem ("M|fffd|dia de seis |fffd|ltimos valores")
    vEnableEvents = False
    MontarM|fffd|dia_Cb.ListIndex = 0
    vEnableEvents = True

    ListandoComboBox TabMistaOp_Cb
    'ListandoComboBox |fffd|ndice_Cb
    nTab = Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("nTab").Value
    For i = 1 To nTab
        |fffd|ndice_Cb.AddItem (Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("Indices1").Item(i).Value)
    Next
    |fffd|ndice_Cb.AddItem ("Clicar aqui para atualizar esta rela|fffd||fffd|o")
    Set ControleAtivo = TabMistaOp_Cb
End Sub

Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    BotAcionado = False
End Sub

Private Sub Ok_Bt_Click()
'Criticar
    If CriticarTabMist(True) = "" Then
        Hide
        BotAcionado = 1
    End If
End Sub

Private Sub Cancelar_Bt_Click()
    Hide
    BotAcionado = False
End Sub

Private Sub Ajuda_Bt_Click()
    If bHtmlHelp Then Application.Run "CPAP_EX8.MAC!HelpVBA", ThisWorkbook.Path & "\CPAP.chm", HelpContextID, 2 Else Application.Help ThisWorkbook.Path & "\cpap.hlp", HelpContextID
End Sub

Private Sub TabMistaOp_Cb_Change()
    If vEnableEvents = False Then Exit Sub
    If TabMistaOp_Cb.Value = MarcHist Then ConfHist TabMistaOp_Cb, TabMist(3), True
    DecomporTabOp TabMistaOp_Cb.Value

    'Limpando Listbox
    vEnableEvents = False
    Comp_LstB.ListIndex = -1
    While Comp_LstB.ListCount >= 1
        Comp_LstB.RemoveItem (0)
    Wend
    'Povoando listbox
    For i = 0 To UBound(CompTabOp()) - 1
        Comp_LstB.AddItem (CompTabOp(i))
    Next
    Oper_LstB.ListIndex = CompTabOp(UBound(CompTabOp())) * 1
    vEnableEvents = True
    OcultarExibControles
End Sub
'Esses eventos impedem altera|fffd||fffd|es pelo teclado.
Private Sub TabMistaOp_Cb_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    If KeyCode <> 9 Then TabMistaOp_Cb.Locked = True   'TAB (KeyCode=9) n|fffd|o aciona evento KeyUp
End Sub
Private Sub TabMistaOp_Cb_KeyUp(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    TabMistaOp_Cb.Locked = False
End Sub

Private Sub Comp_LstB_Change()
    If vEnableEvents = False Then Exit Sub
    If Comp_LstB.ListIndex = -1 Then Exit Sub
    I1 = Comp_LstB.Value
    If InStr(1, I1, "//Nenhum") > 0 Then I1 = "$//Nenhum"
    i2 = InStr(1, I1, "@")
    If i2 = 0 Then Avan|fffd|o = 0 Else Avan|fffd|o = Mid(I1, i2 + 1, 255) * 1
    If i2 > 0 Then I1 = Left(I1, i2 - 1)
    vEnableEvents = False
    Err.Number = 0
    On Error Resume Next
    |fffd|ndice_Cb.Value = I1
    If Err.Number <> 0 Then
        MsgBox "A tabela de |fffd|ndices " & I1 & " n|fffd|o foi encontrada. Pode ter sido exclu|fffd|da ou seu nome alterado. Indique uma nova tabela.", vbCritical, "Falha"
        |fffd|ndice_Cb.ListIndex = -1
    End If
    nInd = |fffd|ndice_Cb.ListIndex + 1
    Avan|fffd|Ref_Cb.Value = IIf(Avan|fffd|o = 0, " ", Avan|fffd|o)
    vEnableEvents = True
    OcultarExibControles
End Sub

Private Sub |fffd|ndice_Cb_Click()
    If vEnableEvents = False Then Exit Sub
    i = |fffd|ndice_Cb.ListIndex + 1
    nTab = Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("nTab").Value
    If i = nTab + 1 Then
        If nInd > 0 Then t = |fffd|ndice_Cb.List(nInd - 1)
        Application.ExecuteExcel4Macro ("cpap_jap.mac!BancoTab()")
        'Limpando comboboxes
        vEnableEvents = False
        |fffd|ndice_Cb.ListIndex = -1
        While |fffd|ndice_Cb.ListCount >= 1
            |fffd|ndice_Cb.RemoveItem (0)
        Wend
        'Repovoando
        nTab = Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("nTab").Value
        For j = 1 To nTab
            |fffd|ndice_Cb.AddItem (Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("Indices1").Item(j).Value)
        Next
        |fffd|ndice_Cb.AddItem ("Clicar aqui para atualizar esta rela|fffd||fffd|o")
        Err.Number = 0
        On Error Resume Next
        If nInd > 0 Then |fffd|ndice_Cb.Value = t
        If Err.Number <> 0 Then
            MsgBox "A tabela de |fffd|ndices " & t & " n|fffd|o foi encontrada. Pode ter sido exclu|fffd|da ou seu nome alterado. Indique uma nova tabela.", vbCritical, "Falha"
            |fffd|ndice_Cb.ListIndex = -1
        End If
        On Error GoTo 0
        vEnableEvents = True
        Application.ScreenUpdating = True
    Else
        k = Comp_LstB.ListIndex
        If k >= 0 Then
            i2 = Comp_LstB.List(k)
            UM = Left(i2, Application.WorksheetFunction.Find("//", i2) - 1)
            IndCbV = |fffd|ndice_Cb.Value
            If IndCbV = "$//Nenhum" Then IndCbV = UM & "//Nenhum"
            UM1 = Left(IndCbV, Application.WorksheetFunction.Find("//", IndCbV) - 1)
            If UM1 <> UM And UM <> "$" Then
                MsgBox "Voc|fffd| s|fffd| pode compor tabelas de mesma unidade monet|fffd|ria. Indique tabelas de " & UM & "!"
                I1 = Left(i2, Application.WorksheetFunction.Find(" at|fffd| ", i2) - 1)
                vEnableEvents = False
                IndCbV = I1
                |fffd|ndice_Cb.ListIndex = nInd - 1
                i = nInd
                vEnableEvents = True
                Exit Sub
            End If
            vEnableEvents = False
            Comp_LstB.List(k) = IndCbV
            Avan|fffd|Ref_Cb.Value = " "
            vEnableEvents = True
            ComporTab
        End If
        nInd = i
    End If
    OcultarExibControles
    On Error Resume Next
    Comp_LstB.SetFocus   'Isto, n|fffd|o sei porque, evita mensagem de propriedade inv|fffd|lida ao sugerir imediatamente uma tabela na lista de hist|fffd|rico
End Sub

Private Sub Avan|fffd|Ref_Cb_Change()
    If vEnableEvents = False Then Exit Sub
    k = Comp_LstB.ListIndex
    If k >= 0 Then
        I1 = Comp_LstB.Value
        i2 = InStr(1, I1, "@")
        If i2 = 0 Then Avan|fffd|o = 0 Else Avan|fffd|o = Mid(I1, i2 + 1, 255) * 1
        If i2 > 0 Then I1 = Left(I1, i2 - 1)    '|fffd|ndice_Cb.Value
        vEnableEvents = False
        Comp_LstB.List(k) = IIf(Avan|fffd|Ref_Cb.Value = " ", I1, I1 & "@" & Avan|fffd|Ref_Cb.Value)
        vEnableEvents = True
        ComporTab
        OcultarExibControles
    End If
    Comp_LstB.SetFocus
End Sub

Private Sub Mover_Sb_SpinUp()
    i = Comp_LstB.ListIndex
    If i < 1 Then Exit Sub
    Comp_LstB.AddItem Comp_LstB.List(i), i - 1
    Comp_LstB.RemoveItem i + 1
    Comp_LstB.Selected(i - 1) = True
    ComporTab
    OcultarExibControles
End Sub

Private Sub Mover_Sb_SpinDown()
    i = Comp_LstB.ListIndex
    If i < 0 Or i + 1 >= Comp_LstB.ListCount Then Exit Sub
    Comp_LstB.AddItem Comp_LstB.List(i), i + 2
    Comp_LstB.RemoveItem i
    Comp_LstB.Selected(i + 1) = True
    ComporTab
    OcultarExibControles
End Sub

Private Sub Adicionar_Bt_Click()
    i2 = Comp_LstB.List(0)
    UM = Left(i2, Application.WorksheetFunction.Find("//", i2) - 1)
    If UM = "$" Then
        MsgBox "Indique uma tabela para a primeira linha antes de adicionar outra.", vbCritical, "Unidade Monet|fffd|ria Ainda Indefinida!"
        Exit Sub
    End If
    i = Comp_LstB.ListIndex
    If i < 0 Or i + 1 >= Comp_LstB.ListCount Then
        Comp_LstB.AddItem UM & "//Nenhum"
        Comp_LstB.Selected(Comp_LstB.ListCount - 1) = True
    Else
        Comp_LstB.AddItem UM & "//Nenhum", i + 1
        Comp_LstB.Selected(i + 1) = True
    End If
    ComporTab
    Static vTip As Boolean
    If vTip = False Then MsgBox "Uma linha para um novo componente foi acrescentada ao final da lista. Agora defina o nome da tabela e, se necess|fffd|rio, mova para a posi|fffd||fffd|o desejada.", vbInformation + vbOKOnly, "Linha Adicionada"
    vTip = True
End Sub

Private Sub Excluir_Bt_Click()
    If Comp_LstB.ListCount = 1 Then
        MsgBox "Antes de excluir a |fffd|ltima tabela, voc|fffd| deve adicionar outra.", vbCritical, "Imposs|fffd|vel Excluir"
        Exit Sub
    End If
    i = Comp_LstB.ListIndex
    If Comp_LstB.ListCount > 0 Then Comp_LstB.RemoveItem i
    If Comp_LstB.ListCount = 0 Then Comp_LstB.AddItem ("$//Nenhum")
    ComporTab
    OcultarExibControles
End Sub

Private Sub Oper_LstB_Click()
    If vEnableEvents = False Then Exit Sub
    ComporTab
    OcultarExibControles
End Sub

Private Sub Agenda_Click()
    Application.ExecuteExcel4Macro ("cpap_pri.mac!Calendario()")
End Sub

Sub ComporTab()
    n = Comp_LstB.ListCount
    Nop = Oper_LstB.ListIndex
    If Nop = 0 Then Cop = " + " Else Cop = Choose(Nop, " + ", " +|fffd| ", " - ", " -|fffd| ")
    TabC = ""
    For k = 0 To n - 1
        TabC = TabC & Comp_LstB.List(k) & IIf(k <> n - 1, Cop, "")
    Next
    UM = Mid(TabC, 1, Application.WorksheetFunction.Find("//", TabC) - 1)
    TabC = UM & "//" & IIf(n > 1, "[", "") & Application.WorksheetFunction.Substitute(TabC, UM & "//", "") & IIf(n > 1, "]" & IIf(Nop = 0, "/" & n, ""), "")
    vEnableEvents = False
    TabMistaOp_Cb.Value = TabC
    vEnableEvents = True
End Sub

Sub OcultarExibControles()
    If Comp_LstB.ListIndex < 0 Then
        vEnableEvents = False
        |fffd|ndice_Cb.ListIndex = -1
        nInd = 1
        Avan|fffd|Ref_Cb.ListIndex = 0
        vEnableEvents = True

        |fffd|ndice_Cb.Enabled = False
        Mover_Sb.Enabled = False
        Excluir_Bt.Enabled = False
        Avan|fffd|Ref_Cb.Enabled = False
        VisualTab_Chb.Enabled = False
    Else
        |fffd|ndice_Cb.Enabled = True
        Mover_Sb.Enabled = True
        Excluir_Bt.Enabled = True
        Avan|fffd|Ref_Cb.Enabled = True
        VisualTab_Chb.Enabled = True
    End If

    If Avan|fffd|Ref_Cb.Value = " " Or Avan|fffd|Ref_Cb.Value = "" Then
        Tip = "Avan|fffd|ar refer|fffd|ncia do |fffd|ndice. Um |fffd|ndice referente a um m|fffd|s passa a se referir a um outro m|fffd|s |fffd| frente"
    Else
        If Abs(Avan|fffd|Ref_Cb.Value * 1) > 1 Then Pl = " meses" Else Pl = " m|fffd|s"
        If Avan|fffd|Ref_Cb.Value * 1 < 0 Then Tip = "Recua" Else Tip = "Avan|fffd|a"
        Tip = Tip & " refer|fffd|ncia do |fffd|ndice em " & Avan|fffd|Ref_Cb.Value & Pl
    End If
    Avan|fffd|Ref_Cb.ControlTipText = Tip
    Avan|fffd|Ref_Lb.ControlTipText = Tip

    If |fffd|ndice_Cb.ListIndex < 1 Then |fffd|ndice_Lb.Caption = "Tabela de |fffd|ndices:"
    If |fffd|ndice_Cb.ListIndex > 0 And UltDispS <> Comp_LstB.Value Then
        |fffd|ndice_Lb.Caption = "Tab. de |fffd|ndices: (" & |fffd|ndicesDispon|fffd|veis(Comp_LstB.Value, nInd) & ")"
        UltDispS = Comp_LstB.Value
    End If
    |fffd|ndice_Lb.ForeColor = IIf(InStr(1, |fffd|ndice_Lb.Caption, "!") > 0, &HFF&, &H80000012)
    If UltDispM <> TabMistaOp_Cb.Value Then
        IndDisp = CriticarTabMist(False)
        nTab = Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("nTab").Value
        If IndDisp = "" Then IndDisp = |fffd|ndicesDispon|fffd|veis(TabMistaOp_Cb.Value, 1 + nTab + 1)
        TabMistaOp_Lb.Caption = "Tabela de |fffd|ndices Mista: (" & IndDisp & ")"
        TabMistaOp_Lb.ForeColor = IIf(InStr(1, TabMistaOp_Lb.Caption, "!") > 0, &HFF&, &H80000012)
        TabMistaOp_Cb.ControlTipText = IIf(Len(TabMistaOp_Cb.Value) < 105, "", TabMistaOp_Cb.Value)
        UltDispM = TabMistaOp_Cb.Value
    End If
    vEnableEvents = False
    MontarM|fffd|dia_Cb.ListIndex = IIf(TabMistaOp_Cb.Value <> M|fffd|diaMontada, 0, M|fffd|diaMontadaIdx)
    vEnableEvents = True
    Application.ScreenUpdating = True
End Sub

Function CriticarTabMist(ComAlert As Boolean)
    CriticarTabMist = ""
    'Verif. tab. indefinida
    For i = 0 To Comp_LstB.ListCount - 1
        t1 = Comp_LstB.List(i)
        If InStr(1, t1, "//Nenhum") > 0 Then
            CriticarTabMist = "Falha! Tabela " & i + 1 & " indefinida"
            If ComAlert Then MsgBox "A tabela " & i + 1 & " n|fffd|o foi definida. Defina ou exclua.", vbCritical + vbOKOnly, "Incongru|fffd|ncia na Seq|fffd|encia de Tabelas"
            Exit Function
        End If
    Next

    'Verif. tab. de mesmo nome
    For i = 0 To Comp_LstB.ListCount - 2
        t1 = Comp_LstB.List(i)
        For j = i + 1 To Comp_LstB.ListCount - 1
            t2 = Comp_LstB.List(j)
            If t1 = t2 Then
                'CriticarTabMist = "Falha! Tabela repetida"
                If ComAlert Then If MsgBox("A tabela " & t1 & " repete-se. Continua assim mesmo?", vbCritical + vbOKCancel, "Tabela Repetida") = vbCancel Then CriticarTabMist = "Falha! Tabela repetida"
            End If
        Next
    Next
End Function

Private Sub VisualTab_Chb_Click()
    If vEnableEvents = False Then Exit Sub
    vNomeInd = Comp_LstB.Value
    nInd1 = |fffd|ndice_Cb.ListIndex + 1
    vUserFormTop = Top
    vUserFormLeft = Left + |fffd|ndice_Cb.Left + |fffd|ndice_Cb.Width
    Visual|fffd|ndices
    If Application.Workbooks("cpap_jap.mac").Sheets(1).Range("TabEdtda").Value Then
        UltDispM = "": UltDispS = ""
        OcultarExibControles
    End If
    vEnableEvents = False
    VisualTab_Chb.Value = False
    vEnableEvents = True
End Sub

Private Sub VisualTabM_Chb_Click()
    If vEnableEvents = False Then Exit Sub
    If CriticarTabMist(True) = "" Then
        vNomeInd = TabMistaOp_Cb.Value
        nTab = Application.Workbooks("cpap_jap.mac").Excel4MacroSheets(1).Range("nTab").Value
        nInd1 = 1 + nTab + 1
        vUserFormTop = Top
        vUserFormLeft = Left + TabMistaOp_Cb.Left + TabMistaOp_Cb.Width
        Visual|fffd|ndices
        If Application.Workbooks("cpap_jap.mac").Sheets(1).Range("TabEdtda").Value Then
            UltDispM = "": UltDispS = ""
            OcultarExibControles
        End If
    End If
    vEnableEvents = False
    VisualTabM_Chb.Value = False
    vEnableEvents = True
End Sub

Private Sub MontarM|fffd|dia_Cb_Change()
    If vEnableEvents = False Then Exit Sub
    I1 = Comp_LstB.List(0)
    i2 = InStr(1, I1, "@")
    If i2 > 0 Then I1 = Left(I1, i2 - 1)
    i3 = Application.WorksheetFunction.Substitute(I1, "//", "//[")
    I1 = Mid(I1, Application.WorksheetFunction.Find("//", I1) + 2, 255)
    For i = 1 To MontarM|fffd|dia_Cb.ListIndex
        i3 = i3 & " + " & I1 & "@" & i
    Next
    i3 = i3 & "]/" & MontarM|fffd|dia_Cb.ListIndex + 1
    M|fffd|diaMontada = i3
    M|fffd|diaMontadaIdx = MontarM|fffd|dia_Cb.ListIndex
    TabMistaOp_Cb.Value = i3
End Sub

Private Sub WhatsThis_Img_MouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As Single, ByVal y As Single)
    Static cHHelpWhatsThis1 As Object
    If cHHelpWhatsThis1 Is Nothing Then Set cHHelpWhatsThis1 = Application.Run("CPAP_EX8.MAC!New_cHHelpWhatsThis")
    cHHelpWhatsThis1.WhatsThis_Img_MouseDown Button, Shift, x, y, Me
    If WhatsThis_Img.BackStyle = fmBackStyleOpaque Then Set cHHelpWhatsThis1 = Nothing
End Sub

Attribute VB_Name = "UserForm2Visual|fffd|nd"
Attribute VB_Base = "0{D9DD7F9D-8301-4F19-85DE-0E067B071A9D}{8A78C1E2-8979-4DDC-8249-A37456369170}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub Editar_Bt_Click()
    DC = TabMist(7).Value
    Cfg = TabMist(8).Value
    If Len(Cfg) < 5 Then DInd = -1 Else DInd = Choose(Int(Mid(Cfg, 2, 1)), -2, -1, 0)
    i = Application.WorksheetFunction.Substitute(vNomeInd, " at|fffd| Entrg", " at|fffd| " & Format(DateSerial(Year(DC), Month(DC) + DInd, Day(DC)), "mm/yy")) _
            = vRange|fffd|nd.Cells(-2, 1).Value
    If i = False Then i = Application.Run("cpap_jap.mac!CaptTabM", vNomeInd, nInd1, DC, Cfg)
    If IsError(i) Then   'Ocorre erro 2015 s|fffd| no Excel97-port, necessita acionar o bot|fffd|o Calcular para captura a tabela. Foi resolvido com DC as Single
        MsgBox "Imposs|fffd|vel editar |fffd|ndices a partir desta caixa, tente atrav|fffd|s do menu.", vbCritical, "Erro Interno!"
        Exit Sub
    End If
    If i Then
        Application.Run "cpap_jap.mac!Edit.Tab.Vis"
        If Application.Workbooks("cpap_jap.mac").Sheets(1).Range("TabEdtda").Value Then UserForm_Initialize
        AppActivate Caption
        Application.ScreenUpdating = True
    Else
        t1 = Application.Workbooks("cpap_jap.mac").Sheets(1).Range("PosTab").Offset(2, 0).Value
        MsgBox "A tabela ''" & t & "'' n|fffd|o foi encontrada ou faltam componentes (Falhou quando capturando " & t1 & ").", vbCritical, "FALHA!"
    End If
End Sub

Private Sub Fechar_Bt_Click()
    Unload UserForm2Visual|fffd|nd
End Sub

Private Sub UserForm_Activate()
'   Top = vUserFormTop
    Left = vUserFormLeft - 55
    Application.ScreenUpdating = True
End Sub

Private Sub UserForm_Initialize()
    Dim TempArray()
    If NmesIndMax = 0 Then NmesIndMax = Workbooks("cpap_pri.mac").Excel4MacroSheets(1).Range("NmesIndMax").Value
    ReDim TempArray(NmesIndMax - 1, 2)    'Atribuir valores a um array e depois adicionar a um listbox |fffd| bem mais r|fffd|pido do que diretamente
    Application.ScreenUpdating = False
    'Listando Valores_LstB
    With Application.Workbooks("cpap_jap.mac").Sheets(1)
        Col = .Range("C|fffd|lRef").Column + 1
        Set vRange|fffd|nd = .Range(.Cells(5, Col), .Cells(4 + NmesIndMax, Col))
    End With
    For i = 1 To NmesIndMax
        '      Valores_LstB.AddItem (Format(DateSerial(1970, 4 + I, 1), "mmm/yy"))
        TempArray(i - 1, 0) = Format(DateSerial(1970, 4 + i, 1), "mmm/yy")
        v = vRange|fffd|nd.Cells(i, 1).Value
        '      Valores_LstB.List(I - 1, 1) = Format(v, "#,##0.00##")
        TempArray(i - 1, 1) = Format(v, "#,##0.00##")
        If v <> "" Then k = i
    Next
    Valores_LstB.List = TempArray()
    Valores_LstB.ListIndex = k + 1 * (k >= NmesIndMax)
    Caption = vNomeInd
    Valores_LstB.ControlTipText = "|fffd|ndices em " & vNomeInd
    Editar_Bt.ControlTipText = "|fffd|ndices em " & vNomeInd
End Sub

Attribute VB_Name = "UserFormEditHist"
Attribute VB_Base = "0{BD42C58A-DC84-49D6-BCFB-E9163655DE3C}{81E2184E-549A-475C-B95E-5F57B7468D19}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private vListBox As Control
Private vTextBox As Control
Private SemAltera|fffd||fffd|es As Boolean


Private Sub Ajuda_Bt_Click()
    If bHtmlHelp Then Application.Run "CPAP_EX8.MAC!HelpVBA", ThisWorkbook.Path & "\CPAP.chm", HelpContextID, 2 Else Application.Help ThisWorkbook.Path & "\cpap.hlp", HelpContextID
End Sub

Private Sub UserForm_Initialize()
    vEnableEvents = True
    Caption = "Editando Sugest|fffd|es do Campo " & HistEditCampo
    'Listando listboxes - Lista de sug fixas
    Set campo = ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo, ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo).End(xlDown))
    If campo.Rows.Count < 100 Then
        j = 0
        For Each C In campo
            cf = Format(IIf(IsError(C.Value), "", C.Value), FormatoHist)
            j = j + 1
            If j > 1 Then
                vRep = False
                For i = 1 To SugFixas_Lb.ListCount
                    If SugFixas_Lb.List(i - 1) = cf Then vRep = True
                Next
                If vRep = False Then SugFixas_Lb.AddItem (cf)
            End If
        Next
    End If

    'Listando ListBox - Sugest Hist|fffd|ricas
    Set campo = ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo & "Hist", ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo & "Hist").End(xlDown))
    If campo.Rows.Count < 10000 Then
        j = 0
        For Each C In campo
            cf = Format(IIf(IsError(C.Value), "", C.Value), FormatoHist)
            j = j + 1
            If j > 1 Then
                vRep = False
                For i = 1 To SugHist_Lb.ListCount
                    If SugHist_Lb.List(i - 1) = cf Then vRep = True
                Next
                If vRep = False And cf <> "" Then SugHist_Lb.AddItem (cf)
            End If
        Next
    End If
    NumMax_Ct.Value = ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo & "Hist").Offset(-1, 0)
    MultiPage1.Value = 0
    MultiPage1_Change
    SemAltera|fffd||fffd|es = True
    OcultarExibControlesHist
End Sub

Private Sub NumMax_Ct_Change()
    SemAltera|fffd||fffd|es = False
End Sub

Private Sub NumMax_Ct_Exit(ByVal Cancel As MSForms.ReturnBoolean)
    If IsNumeric(NumMax_Ct.Value) Then
        If NumMax_Ct.Value < 0 Then NumMax_Ct.Value = 0
        If NumMax_Ct.Value > 100 Then NumMax_Ct.Value = 100
    Else
        NumMax_Ct.Value = 15
    End If
End Sub

Private Sub Fechar_Bt_Click()
    Hide
    If SemAltera|fffd||fffd|es = True Then Exit Sub
    If MsgBox("Salvar altera|fffd||fffd|es nas sugest|fffd|es para o campo " & HistEditCampo & "?", vbQuestion + vbOKCancel, "CPAP|fffd|") = vbCancel Then Exit Sub
    DirBD = Application.Evaluate(Workbooks("cpap_pri.mac").Names("DirBD").Value) 'DirP = ThisWorkbook.Path
    Application.ScreenUpdating = False
    If MyOpenFile(DirBD & "\banco\" & NomeArqHist, False) Then
        'Limpando c|fffd|lulas
        Set campo = ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo, ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo).End(xlDown))
        If campo.Rows.Count < 100 Then
            i = campo(1)
            campo.ClearContents
            campo(1) = i
        End If
        Set campo = ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo & "Hist", ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo & "Hist").End(xlDown))
        If campo.Rows.Count > 10000 Then
        Else
            i = campo(1)
            campo.ClearContents
            campo(1) = i
        End If

        'Descaregando comboboxes - Sug. Fixas
        k = 0
        NumM|fffd|x = ThisWorkbook.Sheets(NomeArqHist).Range("DadosHist").Row - ThisWorkbook.Sheets(NomeArqHist).Range("DadosFixos").Row - 3
        For j = 1 To SugFixas_Lb.ListCount
            If j > NumM|fffd|x Then Exit For
            vRep = False
            If j > 1 Then
                For i = 1 To j
                    If ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo).Offset(i, 0) = SugFixas_Lb.List(j - 1) Then vRep = True
                Next
            End If
            If vRep = False Then
                k = k + 1
                ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo).Offset(k, 0) = SugFixas_Lb.List(j - 1)
            End If
        Next

        'Descarregando comboboxes - Sug. Hist|fffd|ricas
        k = 0
        For j = 1 To SugHist_Lb.ListCount
            If j > NumMax_Ct.Value * 1 Then Exit For
            vRep = False
            If j > 1 Then
                For i = 1 To j
                    If ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo & "Hist").Offset(i, 0) = SugHist_Lb.List(j - 1) Then vRep = True
                Next
            End If
            If vRep = False Then
                k = k + 1
                ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo & "Hist").Offset(k, 0) = SugHist_Lb.List(j - 1)
            End If
        Next
    End If
    ThisWorkbook.Sheets(NomeArqHist).Range(HistEditCampo & "Hist").Offset(-1, 0) = NumMax_Ct.Value
    SalvandoHist
    Application.ScreenUpdating = True
End Sub

Private Sub Mover_Sb_SpinUp()
    i = vListBox.ListIndex
    If i < 1 Then Exit Sub
    vListBox.AddItem vListBox.List(i), i - 1
    vListBox.RemoveItem i + 1
    vListBox.Selected(i - 1) = True
    SemAltera|fffd||fffd|es = False
End Sub

Private Sub Mover_Sb_SpinDown()
    i = vListBox.ListIndex
    If i < 0 Or i + 1 >= vListBox.ListCount Then Exit Sub
    vListBox.AddItem vListBox.List(i), i + 2
    vListBox.RemoveItem i
    vListBox.Selected(i + 1) = True
    SemAltera|fffd||fffd|es = False
End Sub

Private Sub Transf_Bt_Click()
    i = vListBox.ListIndex
    If i < 0 Then Exit Sub
    If vListBox.Selected(i) Then
        I1 = vListBox.Value
        vListBox.RemoveItem i
        vEnableEvents = False
        If vListBox.ListIndex = -1 Then vTextBox.Value = ""
        vEnableEvents = True
    End If
    If MultiPage1.Value = 0 Then MultiPage1.Value = 1 Else MultiPage1.Value = 0
    vListBox.AddItem I1
    vListBox.Selected(vListBox.ListCount - 1) = True
    SemAltera|fffd||fffd|es = False
End Sub

Private Sub Excluir_Bt_Click()
    i = vListBox.ListIndex
    If i < 0 Then Exit Sub
    If vListBox.Selected(i) Then vListBox.RemoveItem i
    vEnableEvents = False
    If vListBox.ListIndex = -1 Then vTextBox.Value = ""
    vEnableEvents = True
    OcultarExibControlesHist
    SemAltera|fffd||fffd|es = False
End Sub

Private Sub Nova_Bt_Click()
    vListBox.AddItem "Nova Sugest|fffd|o" & vListBox.ListCount + 1
    vListBox.Selected(vListBox.ListCount - 1) = True
    SemAltera|fffd||fffd|es = False
End Sub

Private Sub MultiPage1_Change()
    If MultiPage1.Value = 0 Then
        Set vListBox = SugHist_Lb
        Set vTextBox = SugHist_Ct
    Else
        Set vListBox = SugFixas_Lb
        Set vTextBox = SugFixas_Ct
    End If
    OcultarExibControlesHist
End Sub

Private Sub SugFixas_Ct_Change()
    If vEnableEvents = False Then Exit Sub
    i = SugFixas_Lb.ListIndex
    I1 = SugFixas_Ct.SelStart
    If i < 0 Then
        j = SugFixas_Ct.Value
        Nova_Bt_Click
        SugFixas_Ct.Value = j
        i = SugFixas_Lb.ListCount - 1
    End If
    SugFixas_Lb.AddItem SugFixas_Ct.Value, i
    SugFixas_Lb.RemoveItem i + 1
    SugFixas_Lb.Selected(i) = True
    SugFixas_Ct.SelStart = I1
    SemAltera|fffd||fffd|es = False
End Sub

Private Sub SugFixas_Ct_Exit(ByVal Cancel As MSForms.ReturnBoolean)
    i = SugFixas_Lb.ListIndex
    If SugFixas_Ct.Value <> "" Or i < 0 Then Exit Sub
    SugFixas_Lb.RemoveItem i
End Sub

Private Sub SugFixas_LB_Click()
    vEnableEvents = False
    SugFixas_Ct.Value = SugFixas_Lb.Value
    If SugFixas_Ct.Enabled Then SugFixas_Ct.SetFocus
    vEnableEvents = True
    OcultarExibControlesHist
End Sub

Private Sub SugHist_Ct_Change()
    If vEnableEvents = False Then Exit Sub
    i = SugHist_Lb.ListIndex
    I1 = SugHist_Ct.SelStart
    If i < 0 Then
        j = SugHist_Ct.Value
        Nova_Bt_Click
        SugHist_Ct.Value = j
        i = SugHist_Lb.ListCount - 1
    End If
    SugHist_Lb.AddItem SugHist_Ct.Value, i
    SugHist_Lb.RemoveItem i + 1
    SugHist_Lb.Selected(i) = True
    SugHist_Ct.SelStart = I1
    SemAltera|fffd||fffd|es = False
End Sub

Private Sub SugHist_Ct_Exit(ByVal Cancel As MSForms.ReturnBoolean)
    i = SugHist_Lb.ListIndex
    If SugHist_Ct.Value <> "" Or i < 0 Then Exit Sub
    SugHist_Lb.RemoveItem i
End Sub

Private Sub SugHist_Lb_Click()
    vEnableEvents = False
    SugHist_Ct.Value = SugHist_Lb.Value
    If SugHist_Ct.Enabled Then SugHist_Ct.SetFocus
    vEnableEvents = True
    OcultarExibControlesHist
End Sub

Sub OcultarExibControlesHist()
    i = vListBox.ListIndex > -1
    Excluir_Bt.Enabled = i
    Mover_Sb.Enabled = i
    Mover_Lb.Enabled = i
    Transf_Bt.Enabled = i
    Transf_Bt.ControlTipText = "Transfere para " & IIf(MultiPage1.Value = 0, "Fixas", "Hist|fffd|ricas")
    WhatsThis_Img.Top = -50: If bHtmlHelp Then WhatsThis_Img.Top = -1: WhatsThis_Img.Left = Width - 10
End Sub

Private Sub WhatsThis_Img_MouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As Single, ByVal y As Single)
    Static cHHelpWhatsThis1 As Object
    If cHHelpWhatsThis1 Is Nothing Then Set cHHelpWhatsThis1 = Application.Run("CPAP_EX8.MAC!New_cHHelpWhatsThis")
    cHHelpWhatsThis1.WhatsThis_Img_MouseDown Button, Shift, x, y, Me
    If WhatsThis_Img.BackStyle = fmBackStyleOpaque Then Set cHHelpWhatsThis1 = Nothing
End Sub



INQUEST-PP=macro
