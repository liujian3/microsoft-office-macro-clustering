Attribute VB_Name = "Class1"
Attribute VB_Base = "0{FCFB3D2A-A0FA-1068-A738-08002B3371B5}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Attribute VB_Name = "Module1"
 Public Sub Rebalance_Click()
    
    If Sheet2.Range("AA41") = 0 Or Sheet2.Range("AA67") = 0 Then
        Err = MsgBox("Please enter in a fund to be able to calculate a rebalance instruction.", vbCritical, "Error")
    Else
    
    
    If Round(Sheet2.Range("H48"), 0) <> Round(Sheet2.Range("K67"), 0) Then
        Err = MsgBox("Please check that the total in the rebalance to portfolio is equivalent to amount/percentage in your solution portfolio", vbCritical, "Error")
    Else
    
    Sheet6.Activate
    Sheet3.Range("a14:s53").ClearContents
    Sheet3.Range("aa14:aq53").ClearContents
    Sheet11.Range("a16:s55").ClearContents
    
    
    Dim frm_portfolio(17, 9), to_portfolio(17, 6), test_portfolio(10, 3), temp_portfolio(10, 3)
    Dim transaction_log(70, 5), t, priority, fund_trans(17, 16, 3), original_portfolio(17, 8)

    Dim ws As Worksheet, transws As Worksheet
    
    Set ws = ThisWorkbook.Worksheets("Rebalance")
    'ws.Unprotect "retailplatform"
    Set transws = ThisWorkbook.Worksheets("Transactions")
    
'    If ws.Range("r37") = True Then
'        If ws.Range("ToTotal") > ws.Range("FromTotal") Then
'            MsgBox "TO portfolio can not be larger than FROM portfolio. PLease adjust amounts as neccessary"
'            GoTo esub
'        ElseIf ws.Range("ToTotal") < ws.Range("FromTotal") Then
'            MsgBox "To portfolio is less than From portfolio. Please note that any remain proceeds will be assigned to the Standard Bank Money Market fund"
'        End If
'    Else
'        If Round(ws.Range("ToTotal"), 2) > 1 Then
'            MsgBox "TO portfolio can not be larger than FROM portfolio. PLease adjust amounts as neccessary"
'           GoTo esub
'        ElseIf Round(ws.Range("ToTotal"), 2) < 1 Then
'            MsgBox "To portfolio is less than From portfolio. Please note that any remain proceeds will be assigned to the Standard Bank Money Market fund"
'        End If
'    End If
    
    t = 1
    '*******************************************************************************************
    For i = 1 To 15
    
        'copy values in from table into array frm_portfolio
        frm_portfolio(i, 1) = ws.Range("d26").Offset(i - 1, 0) 'manco
        frm_portfolio(i, 2) = ws.Range("w26").Offset(i - 1, 0) 'fund
        frm_portfolio(i, 3) = ws.Range("k26").Offset(i - 1, 0) 'units
        frm_portfolio(i, 4) = ws.Range("m26").Offset(i - 1, 0) 'unit price
        If ws.Range("ac26").Offset(i - 1, 0) = "No CGT" Then
            frm_portfolio(i, 5) = 0
            'ws.Range("o26").Offset(i - 1, 0).Value = 0
        Else
            frm_portfolio(i, 5) = ws.Range("o26").Offset(i - 1, 0) 'base cost
        End If
        
        If ws.Range("q26").Offset(i - 1, 0).Value <> "" Then
            frm_portfolio(i, 6) = ws.Range("q26").Offset(i - 1, 0).Value 'mkt value
        Else
            frm_portfolio(i, 6) = 0
        End If
        frm_portfolio(i, 7) = i
        
        frm_portfolio(i, 8) = ""
        frm_portfolio(i, 9) = ws.Range("z26").Offset(i - 1, 0) 'retail Jse Code
        
        'make a copy of frm_portfolio to original_portfolio
        For j = 1 To 8: original_portfolio(i, j) = frm_portfolio(i, j): Next j
        
        
        'create the to_portfolio array
        to_portfolio(i, 1) = ws.Range("d52").Offset(i - 1, 0) 'manco
        to_portfolio(i, 2) = ws.Range("o52").Offset(i - 1, 0) 'fund
        
        If ws.Range("K45") = True Then 'Rand Amount
            to_portfolio(i, 3) = ws.Range("k52").Offset(i - 1, 0) 'amount desired
        Else
            to_portfolio(i, 3) = ws.Range("k52").Offset(i - 1, 0) * ws.Range("q41")
        End If
        
        to_portfolio(i, 4) = 0 'amount allocated
        to_portfolio(i, 5) = to_portfolio(i, 3) ' amount still required
        to_portfolio(i, 6) = ws.Range("z52").Offset(i - 1, 0)
       
    Next i
    '*******************************************************************************************
    
    For i = 1 To 17
     For j = 0 To 8
            fund_trans(i, j, 0) = 0
            fund_trans(i, j, 1) = 0
            fund_trans(i, j, 2) = ""
        Next j
    Next i
    
    fund_trans(0, 0, 0) = 0
    fund_trans(0, 0, 1) = 0
    
    
    For i = 1 To 5: to_portfolio(16, i) = 0: Next i

    'clearing rows and columns for instructions
    For i = 1 To 42 'rows
        For j = 1 To 5 'columns
            transaction_log(i, j) = 0
        Next j
        
        'Clearing final portfolio in transaction sheet
        If i < 16 Then
            transws.Range("c60").Offset(i - 1, 0) = ""
            transws.Range("f60").Offset(i - 1, 0) = ""
            transws.Range("j60").Offset(i - 1, 0) = ""
        End If
        
        transws.Range("c14").Offset(i - 1, 0) = ""
        transws.Range("f14").Offset(i - 1, 0) = ""
        transws.Range("h14").Offset(i - 1, 0) = ""
        transws.Range("j14").Offset(i - 1, 0) = ""
        transws.Range("n14").Offset(i - 1, 0) = ""
        transws.Range("p14").Offset(i - 1, 0) = ""
        transws.Range("t14").Offset(i - 1, 0) = ""
        'CGT
        transws.Range("r14").Offset(i - 1, 0) = ""
    Next i
    
    '????????????????????????????????
    'move small balances into cash
    'small_bal
        
    'eliminate funds in to that are same
    For f = 1 To 15
        If to_portfolio(f, 2) <> "" Then
        'Call same_fund(i) - brought procedure in this code
        '****************************************************************************************
            Dim r As Range, c As Range

            Set ws = ThisWorkbook.Worksheets("Rebalance")
    
            'will build to portfolio fund by fund using from as building blocks
            
            '1st step
            'is the to fund in the from portfolio?
            
            'i = find_fund(to_portfolio(f, 2))
            '**************************************************************************************
            'FIND FUND FUNCTION
            
                l = 0: m = 0
                
                While (m = 0) And (l < 17)
                    l = l + 1
                    If frm_portfolio(l, 9) = to_portfolio(f, 6) And frm_portfolio(l, 6) > 0 Then m = 1
                Wend
                
                i = 0
                If m = 1 Then i = l
            
            '**************************************************************************************
            
            If i <> 0 Then
                'to fund is in from portfolio.
                'does client want to buy more units or sell units?
                
                If to_portfolio(f, 5) = frm_portfolio(i, 6) Then
                    'no change so just transfer untis from->to
                    
                    
                    proc = frm_portfolio(i, 6)
                    to_portfolio(f, 5) = 0
                    to_portfolio(f, 4) = frm_portfolio(i, 6)
                    frm_portfolio(i, 6) = 0
                    
                    If frm_portfolio(i, 8) = "" Then
                        transaction_log(t, 1) = "Inter Platform Switch"
                    Else
                        transaction_log(t, 1) = "No transaction"
                    End If
                    transaction_log(t, 2) = frm_portfolio(i, 2)
                    transaction_log(t, 3) = to_portfolio(f, 2)
                    transaction_log(t, 4) = proc
                    transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                    t = t + 1
                    '-------------------not sure whats happening here-----------------------
                    k = fund_trans(i, 0, 0) + 1
                    fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                    fund_trans(i, k, 1) = proc
                    fund_trans(i, k, 2) = to_portfolio(f, 2)
                    fund_trans(i, 0, 0) = k
                    fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                    '------------------------------------------------------------------------
                ElseIf to_portfolio(f, 5) < frm_portfolio(i, 6) Then
                    'client selling some units from this fund.
                    'transfer remaining units-> to. The rest will be sold later
                                
                    proc = to_portfolio(f, 5)
                    to_portfolio(f, 4) = to_portfolio(f, 5)
                    frm_portfolio(i, 6) = frm_portfolio(i, 6) - to_portfolio(f, 5)
                    to_portfolio(f, 5) = 0
                    
                    If frm_portfolio(i, 8) = "" Then
                        transaction_log(t, 1) = "Inter Platform Switch"
                    Else
                        transaction_log(t, 1) = "No transaction"
                    End If
        
                    transaction_log(t, 2) = frm_portfolio(i, 2)
                    transaction_log(t, 3) = to_portfolio(f, 2)
                    transaction_log(t, 4) = proc
                    transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                    t = t + 1
                    k = fund_trans(i, 0, 0) + 1
                    fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                    fund_trans(i, k, 1) = proc
                    fund_trans(i, k, 2) = to_portfolio(f, 2)
                    fund_trans(i, 0, 0) = k
                    fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                    
                ElseIf to_portfolio(f, 5) > frm_portfolio(i, 6) Then
                    'client is buying more units
                    'transfer from->to then remaining will be bought later
                               
                    proc = frm_portfolio(i, 6)
                    to_portfolio(f, 4) = frm_portfolio(i, 6)
                    to_portfolio(f, 5) = to_portfolio(f, 5) - frm_portfolio(i, 6)
                    frm_portfolio(i, 6) = 0
                    
                    If frm_portfolio(i, 8) = "" Then
                        transaction_log(t, 1) = "Inter Platform Switch"
                    Else
                        transaction_log(t, 1) = "No transaction"
                    End If
        
                    transaction_log(t, 2) = frm_portfolio(i, 2)
                    transaction_log(t, 3) = to_portfolio(f, 2)
                    transaction_log(t, 4) = proc
                    transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                    t = t + 1
                    k = fund_trans(i, 0, 0) + 1
                    fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                    fund_trans(i, k, 1) = proc
                    fund_trans(i, k, 2) = to_portfolio(f, 2)
                    fund_trans(i, 0, 0) = k
                    fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                End If
            End If
                        
        '****************************************************************************************
        End If
    Next f
    
    'intra manco switches
    For f = 1 To 17
        If to_portfolio(f, 2) <> "" Then
            'If priority = True Then sort_list
            'new_fund_intra_manco (i)
            '*************************************************************************************
            'new fund intra manco
                        
            Set ws = ThisWorkbook.Worksheets("Rebalance")
            
            'to fund not in from portfolio so must buy units using other funds
            '1st try intra manco switch
                
            'i = find_manco(to_portfolio(f, 1))
            '*************************************************************************************
            'FIND MANCO FUNCTION
            
                l = 0: m = 0
                
                While (m = 0) And (l < 17)
                    l = l + 1
                    If frm_portfolio(l, 1) = to_portfolio(f, 1) And frm_portfolio(l, 6) > 0 Then m = 1
                Wend
                
                i = 0
                If m = 1 Then i = l
            '*************************************************************************************
            
            While (i <> 0) And (to_portfolio(f, 5) > 0)
                'same manco exists so do the transfer
                
                If to_portfolio(f, 5) = frm_portfolio(i, 6) Then
                    'transfer all funds from->to
                    proc = frm_portfolio(i, 6)
                    to_portfolio(f, 5) = 0
                    to_portfolio(f, 4) = to_portfolio(f, 4) + frm_portfolio(i, 6)
                    frm_portfolio(i, 6) = 0
                    
                    transaction_log(t, 1) = "Intra manco switch"
                    transaction_log(t, 2) = frm_portfolio(i, 2)
                    transaction_log(t, 3) = to_portfolio(f, 2)
                    transaction_log(t, 4) = proc
                    transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                    t = t + 1
                    k = fund_trans(i, 0, 0) + 1
                    fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                    fund_trans(i, k, 1) = proc
                    fund_trans(i, k, 2) = to_portfolio(f, 2)
                    fund_trans(i, 0, 0) = k
                    fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                    
                ElseIf to_portfolio(f, 5) < frm_portfolio(i, 6) Then
                    'sell as many units as necessary.
                    'The rest will be sold later
                    proc = to_portfolio(f, 5)
                    to_portfolio(f, 4) = to_portfolio(f, 4) + to_portfolio(f, 5)
                    frm_portfolio(i, 6) = frm_portfolio(i, 6) - to_portfolio(f, 5)
                    to_portfolio(f, 5) = 0
                    
                    transaction_log(t, 1) = "Intra manco switch"
                    transaction_log(t, 2) = frm_portfolio(i, 2)
                    transaction_log(t, 3) = to_portfolio(f, 2)
                    transaction_log(t, 4) = proc
                    transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                    t = t + 1
                    k = fund_trans(i, 0, 0) + 1
                    fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                    fund_trans(i, k, 1) = proc
                    fund_trans(i, k, 2) = to_portfolio(f, 2)
                    fund_trans(i, 0, 0) = k
                    fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                    
                ElseIf to_portfolio(f, 5) > frm_portfolio(i, 6) Then
                    'Sell all from units
                    'remaining to units needed will be bought later
                    proc = frm_portfolio(i, 6)
                    to_portfolio(f, 4) = to_portfolio(f, 4) + frm_portfolio(i, 6)
                    to_portfolio(f, 5) = to_portfolio(f, 5) - frm_portfolio(i, 6)
                    frm_portfolio(i, 6) = 0
                    
                    transaction_log(t, 1) = "Intra manco switch"
                    transaction_log(t, 2) = frm_portfolio(i, 2)
                    transaction_log(t, 3) = to_portfolio(f, 2)
                    transaction_log(t, 4) = proc
                    transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                    t = t + 1
                    k = fund_trans(i, 0, 0) + 1
                    fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                    fund_trans(i, k, 1) = proc
                    fund_trans(i, k, 2) = to_portfolio(f, 2)
                    fund_trans(i, 0, 0) = k
                    fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                End If
                
                'i = find_manco(to_portfolio(f, 1))
                '*************************************************************************************
                'FIND MANCO FUNCTION
                
                    l = 0: m = 0
                    
                    While (m = 0) And (l < 17)
                        l = l + 1
                        If frm_portfolio(l, 1) = to_portfolio(f, 1) And frm_portfolio(l, 6) > 0 Then m = 1
                    Wend
                    
                    i = 0
                    If m = 1 Then i = l
                '*************************************************************************************
            Wend

            '*************************************************************************************
        End If
    Next f
    
    'inter manco switches
    For f = 1 To 17
        If to_portfolio(f, 2) <> "" Then
            'If priority = True Then sort_list
            'new_fund_inter_manco (i)
            '*************************************************************************************
            'new fund inter manco
            
            Set ws = ThisWorkbook.Worksheets("Rebalance")
            
            'to fund not in from portfolio so must buy units using other funds
            'do inter manco switch
            i = 1
            While (i <= 15) And (to_portfolio(f, 5) > 0)
                'sequentially do the switch until to fund is filled
                If frm_portfolio(i, 6) > 0 Then
                    If to_portfolio(f, 5) = frm_portfolio(i, 6) Then
                        'transfer all funds from->to
                        proc = frm_portfolio(i, 6)
                        to_portfolio(f, 5) = 0
                        to_portfolio(f, 4) = to_portfolio(f, 4) + frm_portfolio(i, 6)
                        frm_portfolio(i, 6) = 0
                        
                        transaction_log(t, 1) = "Inter manco switch"
                        transaction_log(t, 2) = frm_portfolio(i, 2)
                        transaction_log(t, 3) = to_portfolio(f, 2)
                        transaction_log(t, 4) = proc
                        transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                        t = t + 1
                        k = fund_trans(i, 0, 0) + 1
                        fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                        fund_trans(i, k, 1) = proc
                        fund_trans(i, k, 2) = to_portfolio(f, 2)
                        fund_trans(i, 0, 0) = k
                        fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                        
                    ElseIf to_portfolio(f, 5) < frm_portfolio(i, 6) Then
                        'sell as many units as necessary.
                        'The rest will be sold later
                        proc = to_portfolio(f, 5)
                        to_portfolio(f, 4) = to_portfolio(f, 4) + to_portfolio(f, 5)
                        frm_portfolio(i, 6) = frm_portfolio(i, 6) - to_portfolio(f, 5)
                        to_portfolio(f, 5) = 0
                        
                        transaction_log(t, 1) = "Inter manco switch"
                        transaction_log(t, 2) = frm_portfolio(i, 2)
                        transaction_log(t, 3) = to_portfolio(f, 2)
                        transaction_log(t, 4) = proc
                        transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                        t = t + 1
                        k = fund_trans(i, 0, 0) + 1
                        fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                        fund_trans(i, k, 1) = proc
                        fund_trans(i, k, 2) = to_portfolio(f, 2)
                        fund_trans(i, 0, 0) = k
                        fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                        
                    ElseIf to_portfolio(f, 5) > frm_portfolio(i, 6) Then
                        'Sell all from units
                        'remaining to units needed will be bought later
                        proc = frm_portfolio(i, 6)
                        to_portfolio(f, 4) = to_portfolio(f, 4) + frm_portfolio(i, 6)
                        to_portfolio(f, 5) = to_portfolio(f, 5) - frm_portfolio(i, 6)
                        frm_portfolio(i, 6) = 0
                        
                        transaction_log(t, 1) = "Inter manco switch"
                        transaction_log(t, 2) = frm_portfolio(i, 2)
                        transaction_log(t, 3) = to_portfolio(f, 2)
                        transaction_log(t, 4) = proc
                        transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                        t = t + 1
                        k = fund_trans(i, 0, 0) + 1
                        fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                        fund_trans(i, k, 1) = proc
                        fund_trans(i, k, 2) = to_portfolio(f, 2)
                        fund_trans(i, 0, 0) = k
                        fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                    End If
                End If
                i = i + 1
            Wend
    
            '*************************************************************************************
        End If
    Next f
        
    '???????????????????????
    'get_cash

'    For i = 1 To t - 1
'        ws.Range("b50").Offset(i - 1, 0) = transaction_log(i, 1)
'        ws.Range("e50").Offset(i - 1, 0) = transaction_log(i, 2)
'        ws.Range("i50").Offset(i - 1, 0) = transaction_log(i, 3)
'        ws.Range("m50").Offset(i - 1, 0) = transaction_log(i, 4)
'        ws.Range("o50").Offset(i - 1, 0) = transaction_log(i, 5)
'    Next i

    aa = 0
    For i = 1 To 17
        If fund_trans(i, 0, 0) > 0 Then
            k = fund_trans(i, 0, 0)
            'ws.Range("b62").Offset(aa, 0) = frm_portfolio(i, 2)
            'ws.Range("e62").Offset(aa, 0) = fund_trans(i, 0, 1)
            tbal = 0
            For j = 1 To k
                transws.Range("c14").Offset(aa, 0) = original_portfolio(i, 2)
                u = fund_trans(i, j, 1) / frm_portfolio(i, 4)
                
                If fund_trans(i, j, 3) = "Inter Platform Switch" Then
                    cgt = 0
                Else
                    cgt = u * (frm_portfolio(i, 4) - frm_portfolio(i, 5))
                End If
                
                transws.Range("f14").Offset(aa, 0) = fund_trans(i, 0, 1)
                transws.Range("h14").Offset(aa, 0) = Round(fund_trans(i, 0, 1) / original_portfolio(i, 6), 4)
                transws.Range("j14").Offset(aa, 0) = fund_trans(i, j, 2)
                transws.Range("n14").Offset(aa, 0) = fund_trans(i, j, 1)
                transws.Range("p14").Offset(aa, 0) = Round(fund_trans(i, j, 1) / original_portfolio(i, 6), 4)
                
                If j < k Then
                    tbal = tbal + transws.Range("p14").Offset(aa, 0)
                Else
                    transws.Range("p14").Offset(aa, 0) = 1 - tbal
                End If
                If ws.Range("f12").Value = "Classic Investment Plan" Then
                    transws.Range("r14").Offset(aa, 0) = cgt
                Else
                    transws.Range("r14").Offset(aa, 0) = 0
                End If
                transws.Range("t14").Offset(aa, 0) = fund_trans(i, j, 3)
                aa = aa + 1
            Next j
            'aa = aa + 1
        End If
    Next i
    '--------------------might change--------------------
    'transws.Range("r12").Value = aa
    '----------------------------------------------------
    
    For i = 1 To 15
        transws.Range("c60").Offset(i - 1, 0) = to_portfolio(i, 1)
        transws.Range("f60").Offset(i - 1, 0) = to_portfolio(i, 2)
        transws.Range("j60").Offset(i - 1, 0) = to_portfolio(i, 3)
    Next i
    
    'If to_portfolio(9, 3) > 0 Then
    '    ws.Range("b104") = to_portfolio(9, 1)
    '    ws.Range("e104") = to_portfolio(9, 2)
    '    ws.Range("i104") = to_portfolio(9, 3)
    'End If
'esub:
    'ws.Protect Password:="retailplatform", AllowFormattingCells:=True
    
    'Calculations for Instructions from Transactions sheet
    '********************************************************************************************************************************************
    
    i = 14
    n = 14
    
    Do
        If Sheet3.Cells(i, 25) = "" Then
            i = i + 1
        Else
            If Sheet3.Cells(i, 25) = "New Switch" Then
                Sheet3.Cells(n, 27) = Sheet3.Cells(i, 3)
                Sheet3.Cells(n, 30) = Sheet3.Cells(i, 6)
                Sheet3.Cells(n, 32) = Sheet3.Cells(i, 8)
                Sheet3.Cells(n, 34) = Sheet3.Cells(i, 10)
                Sheet3.Cells(n, 38) = Sheet3.Cells(i, 14)
                Sheet3.Cells(n, 40) = Sheet3.Cells(i, 16)
                Sheet3.Cells(n, 42) = Sheet3.Cells(i, 18)
                
                i = i + 1
                n = n + 1
            Else
                If Sheet3.Cells(i, 25) = "Same Switch" Then
                    Sheet3.Cells(n, 34) = Sheet3.Cells(i, 10)
                    Sheet3.Cells(n, 38) = Sheet3.Cells(i, 14)
                    Sheet3.Cells(n, 40) = Sheet3.Cells(i, 16)
                    Sheet3.Cells(n, 42) = Sheet3.Cells(i, 18)
                    i = i + 1
                    n = n + 1
                End If
            End If
        End If
    Loop Until Sheet3.Cells(i, 3) = ""
        
    i = 14
    n = 16
   
    Do
        ' To side
        If Sheet3.Cells(i, 44) = "Same Fund" Then
            Sheet11.Cells(n, 3) = Sheet3.Cells(i, 27)
            Sheet11.Cells(n, 6) = Sheet3.Cells(i, 45)
            Sheet11.Cells(n, 8) = Sheet3.Cells(i, 46)
            n = n + 1
            i = i + 2
        Else
            Sheet11.Cells(n, 3) = Sheet3.Cells(i, 27)
            Sheet11.Cells(n, 6) = Sheet3.Cells(i, 30)
            Sheet11.Cells(n, 8) = Sheet3.Cells(i, 32)
            n = n + 1
            i = i + 1
        End If
        
    Loop Until Sheet3.Cells(i, 26) = ""
    
    
    i = 14
    n = 16
   
    Do
        ' From Side
        If Sheet3.Cells(i, 47) = "Skip" Then
            i = i + 1
        Else
            Sheet11.Cells(n, 10) = Sheet3.Cells(i, 34)
            Sheet11.Cells(n, 14) = Sheet3.Cells(i, 48)
            Sheet11.Cells(n, 16) = Sheet3.Cells(i, 50)
            Sheet11.Cells(n, 18) = Sheet3.Cells(i, 51)
            n = n + 1
            i = i + 1
        End If
        
    Loop Until Sheet3.Cells(i, 26) = ""

'********************************************************************************************************************************************
    
    
    
    
    
    
    Sheet11.Rows("16:55").EntireRow.Hidden = False
    
        i = 16
        Do
            i = i + 1
        Loop Until Sheet11.Cells(i, 10).Value = ""
        Sheet11.Rows(i & ":55").EntireRow.Hidden = True

    
    Sheet11.Activate
    Sheet11.Range("C14").Select
    Sheet11.Range("B11") = "Rebalance Instructions"
    Sheet11.Range("B58") = "Rebalanced Portfolio"
    
    End If
    End If
End Sub

Attribute VB_Name = "Module2"
Sub First_Click()
    Dim d As Date, ws As Worksheet
    
    
     d = #9/6/2019#
          'MM/DD/YYYY
          
    If Now <= d Then
        MsgBox "Please note that this version of the STANLIB Switch/Rebalance Tool will expire on Septmeber 5, 2019"
        ThisWorkbook.Unprotect "retailplatform"
        Set ws = ThisWorkbook.Worksheets("Main")
        ws.Visible = xlSheetVisible
        ThisWorkbook.Protect "retailplatform", True
        ws.Activate
    Else
        MsgBox "This version of the STANLIB Switch/Rebalance Tool has expired. Please log on to STANLIB.com to download the latest version."
        ThisWorkbook.Close False
    End If
End Sub


Attribute VB_Name = "Module3"
Sub same_fund(f)
    Dim ws As Worksheet, r As Range, c As Range

    Set ws = ThisWorkbook.Worksheets("Main")
    
    'will build to portfolio fund by fund using from as building blocks
    
    '1st step
    'is the to fund in the from portfolio?
    i = find_fund(to_portfolio(f, 2))
    If i <> 0 Then
        'to fund is in from portfolio.
        'does client want to buy more units or sell units?
        
        If to_portfolio(f, 5) = frm_portfolio(i, 6) Then
            'no change so just transfer untis from->to
            
            
            proc = frm_portfolio(i, 6)
            to_portfolio(f, 5) = 0
            to_portfolio(f, 4) = frm_portfolio(i, 6)
            frm_portfolio(i, 6) = 0
            
            If frm_portfolio(i, 8) = "" Then
                transaction_log(t, 1) = "Inter Platform Switch"
            Else
                transaction_log(t, 1) = "No transaction"
            End If
            transaction_log(t, 2) = frm_portfolio(i, 2)
            transaction_log(t, 3) = to_portfolio(f, 2)
            transaction_log(t, 4) = proc
            transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
            t = t + 1
            '-------------------not sure whats happening here-----------------------
            k = fund_trans(i, 0, 0) + 1
            fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
            fund_trans(i, k, 1) = proc
            fund_trans(i, k, 2) = to_portfolio(f, 2)
            fund_trans(i, 0, 0) = k
            fund_trans(i, k, 3) = transaction_log(t - 1, 1)
            '------------------------------------------------------------------------
        ElseIf to_portfolio(f, 5) < frm_portfolio(i, 6) Then
            'client selling some units from this fund.
            'transfer remaining units-> to. The rest will be sold later
                        
            proc = to_portfolio(f, 5)
            to_portfolio(f, 4) = to_portfolio(f, 5)
            frm_portfolio(i, 6) = frm_portfolio(i, 6) - to_portfolio(f, 5)
            to_portfolio(f, 5) = 0
            
            If frm_portfolio(i, 8) = "" Then
                transaction_log(t, 1) = "Inter Platform Switch"
            Else
                transaction_log(t, 1) = "No transaction"
            End If

            transaction_log(t, 2) = frm_portfolio(i, 2)
            transaction_log(t, 3) = to_portfolio(f, 2)
            transaction_log(t, 4) = proc
            transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
            t = t + 1
            k = fund_trans(i, 0, 0) + 1
            fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
            fund_trans(i, k, 1) = proc
            fund_trans(i, k, 2) = to_portfolio(f, 2)
            fund_trans(i, 0, 0) = k
            fund_trans(i, k, 3) = transaction_log(t - 1, 1)
            
        ElseIf to_portfolio(f, 5) > frm_portfolio(i, 6) Then
            'client is buying more units
            'transfer from->to then remaining will be bought later
                       
            proc = frm_portfolio(i, 6)
            to_portfolio(f, 4) = frm_portfolio(i, 6)
            to_portfolio(f, 5) = to_portfolio(f, 5) - frm_portfolio(i, 6)
            frm_portfolio(i, 6) = 0
            
            If frm_portfolio(i, 8) = "" Then
                transaction_log(t, 1) = "Inter Platform Switch"
            Else
                transaction_log(t, 1) = "No transaction"
            End If

            transaction_log(t, 2) = frm_portfolio(i, 2)
            transaction_log(t, 3) = to_portfolio(f, 2)
            transaction_log(t, 4) = proc
            transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
            t = t + 1
            k = fund_trans(i, 0, 0) + 1
            fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
            fund_trans(i, k, 1) = proc
            fund_trans(i, k, 2) = to_portfolio(f, 2)
            fund_trans(i, 0, 0) = k
            fund_trans(i, k, 3) = transaction_log(t - 1, 1)
        End If
    End If
    
    MsgBox ("IN SAME FUND PROC")
    End
End Sub

Function find_fund(fund)
    i = 0: j = 0
    
    While (j = 0) And (i < 17)
        i = i + 1
        If frm_portfolio(i, 2) = fund And frm_portfolio(i, 6) > 0 Then j = 1
    Wend
    
    find_fund = 0
    If j = 1 Then find_fund = i
End Function


 Sub new_fund_inter_manco(f)
    Dim ws As Worksheet, r As Range, c As Range
    
    Set ws = ThisWorkbook.Worksheets("Main")
    
    'to fund not in from portfolio so must buy units using other funds
    'do inter manco switch
    i = 1
    While (i <= 17) And (to_portfolio(f, 5) > 0)
        'sequentially do the switch until to fund is filled
        If frm_portfolio(i, 6) > 0 Then
            If to_portfolio(f, 5) = frm_portfolio(i, 6) Then
                'transfer all funds from->to
                proc = frm_portfolio(i, 6)
                to_portfolio(f, 5) = 0
                to_portfolio(f, 4) = to_portfolio(f, 4) + frm_portfolio(i, 6)
                frm_portfolio(i, 6) = 0
                
                transaction_log(t, 1) = "Inter manco switch"
                transaction_log(t, 2) = frm_portfolio(i, 2)
                transaction_log(t, 3) = to_portfolio(f, 2)
                transaction_log(t, 4) = proc
                transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                t = t + 1
                k = fund_trans(i, 0, 0) + 1
                fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                fund_trans(i, k, 1) = proc
                fund_trans(i, k, 2) = to_portfolio(f, 2)
                fund_trans(i, 0, 0) = k
                fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                
            ElseIf to_portfolio(f, 5) < frm_portfolio(i, 6) Then
                'sell as many units as necessary.
                'The rest will be sold later
                proc = to_portfolio(f, 5)
                to_portfolio(f, 4) = to_portfolio(f, 4) + to_portfolio(f, 5)
                frm_portfolio(i, 6) = frm_portfolio(i, 6) - to_portfolio(f, 5)
                to_portfolio(f, 5) = 0
                
                transaction_log(t, 1) = "Inter manco switch"
                transaction_log(t, 2) = frm_portfolio(i, 2)
                transaction_log(t, 3) = to_portfolio(f, 2)
                transaction_log(t, 4) = proc
                transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                t = t + 1
                k = fund_trans(i, 0, 0) + 1
                fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                fund_trans(i, k, 1) = proc
                fund_trans(i, k, 2) = to_portfolio(f, 2)
                fund_trans(i, 0, 0) = k
                fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                
            ElseIf to_portfolio(f, 5) > frm_portfolio(i, 6) Then
                'Sell all from units
                'remaining to units needed will be bought later
                proc = frm_portfolio(i, 6)
                to_portfolio(f, 4) = to_portfolio(f, 4) + frm_portfolio(i, 6)
                to_portfolio(f, 5) = to_portfolio(f, 5) - frm_portfolio(i, 6)
                frm_portfolio(i, 6) = 0
                
                transaction_log(t, 1) = "Inter manco switch"
                transaction_log(t, 2) = frm_portfolio(i, 2)
                transaction_log(t, 3) = to_portfolio(f, 2)
                transaction_log(t, 4) = proc
                transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                t = t + 1
                k = fund_trans(i, 0, 0) + 1
                fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                fund_trans(i, k, 1) = proc
                fund_trans(i, k, 2) = to_portfolio(f, 2)
                fund_trans(i, 0, 0) = k
                fund_trans(i, k, 3) = transaction_log(t - 1, 1)
            End If
        End If
        i = i + 1
    Wend
End Sub

 Sub new_fund_intra_manco(f)
    Dim ws As Worksheet, r As Range, c As Range
    
    Set ws = ThisWorkbook.Worksheets("Main")
    
    'to fund not in from portfolio so must buy units using other funds
    '1st try intra manco switch
        
    i = find_manco(to_portfolio(f, 1))
    While (i <> 0) And (to_portfolio(f, 5) > 0)
        'same manco exists so do the transfer
        
        If to_portfolio(f, 5) = frm_portfolio(i, 6) Then
            'transfer all funds from->to
            proc = frm_portfolio(i, 6)
            to_portfolio(f, 5) = 0
            to_portfolio(f, 4) = to_portfolio(f, 4) + frm_portfolio(i, 6)
            frm_portfolio(i, 6) = 0
            
            transaction_log(t, 1) = "Intra manco switch"
            transaction_log(t, 2) = frm_portfolio(i, 2)
            transaction_log(t, 3) = to_portfolio(f, 2)
            transaction_log(t, 4) = proc
            transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
            t = t + 1
            k = fund_trans(i, 0, 0) + 1
            fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
            fund_trans(i, k, 1) = proc
            fund_trans(i, k, 2) = to_portfolio(f, 2)
            fund_trans(i, 0, 0) = k
            fund_trans(i, k, 3) = transaction_log(t - 1, 1)
            
        ElseIf to_portfolio(f, 5) < frm_portfolio(i, 6) Then
            'sell as many units as necessary.
            'The rest will be sold later
            proc = to_portfolio(f, 5)
            to_portfolio(f, 4) = to_portfolio(f, 4) + to_portfolio(f, 5)
            frm_portfolio(i, 6) = frm_portfolio(i, 6) - to_portfolio(f, 5)
            to_portfolio(f, 5) = 0
            
            transaction_log(t, 1) = "Intra manco switch"
            transaction_log(t, 2) = frm_portfolio(i, 2)
            transaction_log(t, 3) = to_portfolio(f, 2)
            transaction_log(t, 4) = proc
            transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
            t = t + 1
            k = fund_trans(i, 0, 0) + 1
            fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
            fund_trans(i, k, 1) = proc
            fund_trans(i, k, 2) = to_portfolio(f, 2)
            fund_trans(i, 0, 0) = k
            fund_trans(i, k, 3) = transaction_log(t - 1, 1)
            
        ElseIf to_portfolio(f, 5) > frm_portfolio(i, 6) Then
            'Sell all from units
            'remaining to units needed will be bought later
            proc = frm_portfolio(i, 6)
            to_portfolio(f, 4) = to_portfolio(f, 4) + frm_portfolio(i, 6)
            to_portfolio(f, 5) = to_portfolio(f, 5) - frm_portfolio(i, 6)
            frm_portfolio(i, 6) = 0
            
            transaction_log(t, 1) = "Intra manco switch"
            transaction_log(t, 2) = frm_portfolio(i, 2)
            transaction_log(t, 3) = to_portfolio(f, 2)
            transaction_log(t, 4) = proc
            transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
            t = t + 1
            k = fund_trans(i, 0, 0) + 1
            fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
            fund_trans(i, k, 1) = proc
            fund_trans(i, k, 2) = to_portfolio(f, 2)
            fund_trans(i, 0, 0) = k
            fund_trans(i, k, 3) = transaction_log(t - 1, 1)
        End If
        
        i = find_manco(to_portfolio(f, 1))
    Wend
End Sub

Function find_manco(manco)
    i = 0: j = 0
    
    While (j = 0) And (i < 17)
        i = i + 1
        If frm_portfolio(i, 1) = manco And frm_portfolio(i, 6) > 0 Then j = 1
    Wend
    
    find_manco = 0
    If j = 1 Then find_manco = i
End Function


Attribute VB_Name = "Module4"
Sub Inputs_Click()
    If Sheet1.Range("AD10").Value = "Rebalance" Then
        Sheet2.Activate
        Sheet2.Range("D26").Select
    Else
        If Sheet1.Range("AD10").Value = "Switch" Then
            Sheet8.Activate
            Sheet8.Range("D26").Select
        End If
    End If
    
End Sub
Attribute VB_Name = "Module5"
Sub Print_Click()
    Dim ws As Worksheet
       
    If Sheet1.Range("AD10").Value = "Rebalance" Then
    
        Set ws = ThisWorkbook.Worksheets("Proposal - R")
    Else
        If Sheet1.Range("AD10").Value = "Switch" Then
            Set ws = ThisWorkbook.Worksheets("Proposal - S")
        End If
    End If
    
    With ws.PageSetup
        '.CenterHorizontally = True
        .Orientation = xlPortrait
        '.FitToPagesWide = 1
    End With
    
    Application.Dialogs(xlDialogPrint).Show
End Sub
Sub Proposal_Click()
    
    If Sheet1.Range("AD10").Value = "Rebalance" Then
        Sheet14.Activate
        Sheet14.Range("D26").Select
        
        'Sheet13.Rows("31:45").EntireRow.Hidden = False
                
        'i = 31
        'Do
        '    i = i + 1
        'Loop Until Cells(i, 9).Value = ""
        'Sheet13.Rows(i & ":45").EntireRow.Hidden = True
        
    Else
        If Sheet1.Range("AD10").Value = "Switch" Then
        Sheet17.Activate
        'Sheet15.Rows("48:62").EntireRow.Hidden = False
        'Sheet15.Rows("68:82").EntireRow.Hidden = False
        Sheet17.Range("D26").Select
        
        'i = 48
        'Do
        '    i = i + 1
        'Loop Until Cells(i, 9).Value = ""
        'Sheet15.Rows(i & ":62").EntireRow.Hidden = True
        
        'i = 68
        'Do
        '    i = i + 1
        'Loop Until Cells(i, 9).Value = ""
        'Sheet15.Rows(i & ":82").EntireRow.Hidden = True
        
        
        End If
    End If
    
    
End Sub
Attribute VB_Name = "Module6"
Sub FirstSwitch_Click()
    Dim d As Date, ws As Worksheet
    
    d = #1/8/2020#
    'MM/DD/YYYY
    
    If Now <= d Then
        MsgBox "Please note that this version of the STANLIB Switch/Rebalance Tool will expire on January 7, 2020"
        ThisWorkbook.Unprotect "retailplatform"
        Set ws = ThisWorkbook.Worksheets("Switch")
        ws.Visible = xlSheetVisible
        ThisWorkbook.Protect "retailplatform", True
        ws.Activate
        Sheet1.Range("AD10").Value = "Switch"
    Else
        MsgBox "This version of the STANLIB Switch/Rebalance Tool has expired. Please log on to STANLIB.com to download the latest version."
        ThisWorkbook.Close False
    End If
End Sub
Sub FirstRebalance_Click()
    Dim d As Date, ws As Worksheet
    
    d = #1/8/2020#
    
    If Now <= d Then
        MsgBox "Please note that this version of the STANLIB Switch/Rebalance Tool will expire on January 7, 2020"
        ThisWorkbook.Unprotect "retailplatform"
        Set ws = ThisWorkbook.Worksheets("Rebalance")
        ws.Visible = xlSheetVisible
        ThisWorkbook.Protect "retailplatform", True
        ws.Activate
        Sheet1.Range("AD10").Value = "Rebalance"
    Else
        MsgBox "This version of the STANLIB Switch/Rebalance Tool has expired. Please log on to STANLIB.com to download the latest version."
        ThisWorkbook.Close False
    End If
End Sub
Attribute VB_Name = "Module7"
Public Sub Switch_Click()

    If Sheet8.Range("AA41") = 0 Or Sheet8.Range("AA67") = 0 Then
        Err = MsgBox("Please enter in a fund to be able to calculate a switch instruction.", vbCritical, "Error")
    Else
    
    If Round(Sheet8.Range("H48"), 0) <> Round(Sheet8.Range("K67"), 0) Then
        Err = MsgBox("Please check that the total in the switch to portfolio is equivalent to amount/percentage in your solution portfolio", vbCritical, "Error")
    Else
    
    Sheet6.Activate
    Sheet3.Range("a14:s53").ClearContents
    Sheet3.Range("aa14:aq53").ClearContents
    Sheet11.Range("a16:s55").ClearContents

    
    Dim frm_portfolio(17, 9), to_portfolio(17, 6), test_portfolio(10, 3), temp_portfolio(10, 3)
    Dim transaction_log(70, 5), t, priority, fund_trans(17, 16, 3), original_portfolio(17, 8)

    Dim ws As Worksheet, transws As Worksheet
    
    Set ws = ThisWorkbook.Worksheets("Switch")
    'ws.Unprotect "retailplatform"
    Set transws = ThisWorkbook.Worksheets("Transactions")
    
'    If ws.Range("r37") = True Then
'        If ws.Range("ToTotal") > ws.Range("FromTotal") Then
'            MsgBox "TO portfolio can not be larger than FROM portfolio. PLease adjust amounts as neccessary"
'            GoTo esub
'        ElseIf ws.Range("ToTotal") < ws.Range("FromTotal") Then
'            MsgBox "To portfolio is less than From portfolio. Please note that any remain proceeds will be assigned to the Standard Bank Money Market fund"
'        End If
'    Else
'        If Round(ws.Range("ToTotal"), 2) > 1 Then
'            MsgBox "TO portfolio can not be larger than FROM portfolio. PLease adjust amounts as neccessary"
'           GoTo esub
'        ElseIf Round(ws.Range("ToTotal"), 2) < 1 Then
'            MsgBox "To portfolio is less than From portfolio. Please note that any remain proceeds will be assigned to the Standard Bank Money Market fund"
'        End If
'    End If
    
    t = 1
    '*******************************************************************************************
    For i = 1 To 15
    
        'copy values in from table into array frm_portfolio
        frm_portfolio(i, 1) = ws.Range("d26").Offset(i - 1, 0) 'manco
        frm_portfolio(i, 2) = ws.Range("y26").Offset(i - 1, 0) 'fund
        frm_portfolio(i, 3) = ws.Range("k26").Offset(i - 1, 0) 'units
        frm_portfolio(i, 4) = ws.Range("m26").Offset(i - 1, 0) 'unit price
        If ws.Range("ac26").Offset(i - 1, 0) = "No CGT" Then
            frm_portfolio(i, 5) = 0
            'ws.Range("o26").Offset(i - 1, 0).Value = 0
        Else
            frm_portfolio(i, 5) = ws.Range("o26").Offset(i - 1, 0) 'base cost
        End If
        frm_portfolio(i, 6) = ws.Range("v26").Offset(i - 1, 0) 'mkt value
        frm_portfolio(i, 7) = i
        
        frm_portfolio(i, 8) = ""
        frm_portfolio(i, 9) = ws.Range("z26").Offset(i - 1, 0) 'Retail JSE Code
        
        'make a copy of frm_portfolio to original_portfolio
        For j = 1 To 8: original_portfolio(i, j) = frm_portfolio(i, j): Next j
        
        
        'create the to_portfolio array
        to_portfolio(i, 1) = ws.Range("d52").Offset(i - 1, 0) 'manco
        to_portfolio(i, 2) = ws.Range("o52").Offset(i - 1, 0) 'fund
        
        If ws.Range("K45") = True Then 'Rand Amount
            to_portfolio(i, 3) = ws.Range("k52").Offset(i - 1, 0) 'amount desired
        Else
            to_portfolio(i, 3) = ws.Range("k52").Offset(i - 1, 0) * ws.Range("v41")
        End If
        
        to_portfolio(i, 4) = 0 'amount allocated
        to_portfolio(i, 5) = to_portfolio(i, 3) ' amount still required
        to_portfolio(i, 6) = ws.Range("z52").Offset(i - 1, 0)
       
    Next i
    '*******************************************************************************************
    
    For i = 1 To 17
     For j = 0 To 8
            fund_trans(i, j, 0) = 0
            fund_trans(i, j, 1) = 0
            fund_trans(i, j, 2) = ""
        Next j
    Next i
    
    fund_trans(0, 0, 0) = 0
    fund_trans(0, 0, 1) = 0
    
    
    For i = 1 To 5: to_portfolio(16, i) = 0: Next i

    'clearing rows and columns for instructions
    For i = 1 To 42 'rows
        For j = 1 To 5 'columns
            transaction_log(i, j) = 0
        Next j
        
        'Clearing final portfolio in transaction sheet
        If i < 16 Then
            transws.Range("c60").Offset(i - 1, 0) = ""
            transws.Range("f60").Offset(i - 1, 0) = ""
            transws.Range("j60").Offset(i - 1, 0) = ""
        End If
        
        transws.Range("c14").Offset(i - 1, 0) = ""
        transws.Range("f14").Offset(i - 1, 0) = ""
        transws.Range("h14").Offset(i - 1, 0) = ""
        transws.Range("j14").Offset(i - 1, 0) = ""
        transws.Range("n14").Offset(i - 1, 0) = ""
        transws.Range("p14").Offset(i - 1, 0) = ""
        transws.Range("t14").Offset(i - 1, 0) = ""
        'CGT
        transws.Range("r14").Offset(i - 1, 0) = ""
    Next i
    
    '????????????????????????????????
    'move small balances into cash
    'small_bal
        
    'eliminate funds in to that are same
    For f = 1 To 15
        If to_portfolio(f, 2) <> "" Then
        'Call same_fund(i) - brought procedure in this code
        '****************************************************************************************
            Dim r As Range, c As Range

            Set ws = ThisWorkbook.Worksheets("Switch")
    
            'will build to portfolio fund by fund using from as building blocks
            
            '1st step
            'is the to fund in the from portfolio?
            
            'i = find_fund(to_portfolio(f, 2))
            '**************************************************************************************
            'FIND FUND FUNCTION
            
                l = 0: m = 0
                
                While (m = 0) And (l < 17)
                    l = l + 1
                    If frm_portfolio(l, 9) = to_portfolio(f, 6) And frm_portfolio(l, 6) > 0 Then m = 1
                Wend
                
                i = 0
                If m = 1 Then i = l
            
            '**************************************************************************************
            
            If i <> 0 Then
                'to fund is in from portfolio.
                'does client want to buy more units or sell units?
                
                If to_portfolio(f, 5) = frm_portfolio(i, 6) Then
                    'no change so just transfer untis from->to
                    
                    
                    proc = frm_portfolio(i, 6)
                    to_portfolio(f, 5) = 0
                    to_portfolio(f, 4) = frm_portfolio(i, 6)
                    frm_portfolio(i, 6) = 0
                    
                    If frm_portfolio(i, 8) = "" Then
                        transaction_log(t, 1) = "Inter Platform Switch"
                    Else
                        transaction_log(t, 1) = "No transaction"
                    End If
                    transaction_log(t, 2) = frm_portfolio(i, 2)
                    transaction_log(t, 3) = to_portfolio(f, 2)
                    transaction_log(t, 4) = proc
                    transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                    t = t + 1
                    '-------------------not sure whats happening here-----------------------
                    k = fund_trans(i, 0, 0) + 1
                    fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                    fund_trans(i, k, 1) = proc
                    fund_trans(i, k, 2) = to_portfolio(f, 2)
                    fund_trans(i, 0, 0) = k
                    fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                    '------------------------------------------------------------------------
                ElseIf to_portfolio(f, 5) < frm_portfolio(i, 6) Then
                    'client selling some units from this fund.
                    'transfer remaining units-> to. The rest will be sold later
                                
                    proc = to_portfolio(f, 5)
                    to_portfolio(f, 4) = to_portfolio(f, 5)
                    frm_portfolio(i, 6) = frm_portfolio(i, 6) - to_portfolio(f, 5)
                    to_portfolio(f, 5) = 0
                    
                    If frm_portfolio(i, 8) = "" Then
                        transaction_log(t, 1) = "Inter Platform Switch"
                    Else
                        transaction_log(t, 1) = "No transaction"
                    End If
        
                    transaction_log(t, 2) = frm_portfolio(i, 2)
                    transaction_log(t, 3) = to_portfolio(f, 2)
                    transaction_log(t, 4) = proc
                    transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                    t = t + 1
                    k = fund_trans(i, 0, 0) + 1
                    fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                    fund_trans(i, k, 1) = proc
                    fund_trans(i, k, 2) = to_portfolio(f, 2)
                    fund_trans(i, 0, 0) = k
                    fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                    
                ElseIf to_portfolio(f, 5) > frm_portfolio(i, 6) Then
                    'client is buying more units
                    'transfer from->to then remaining will be bought later
                               
                    proc = frm_portfolio(i, 6)
                    to_portfolio(f, 4) = frm_portfolio(i, 6)
                    to_portfolio(f, 5) = to_portfolio(f, 5) - frm_portfolio(i, 6)
                    frm_portfolio(i, 6) = 0
                    
                    If frm_portfolio(i, 8) = "" Then
                        transaction_log(t, 1) = "Inter Platform Switch"
                    Else
                        transaction_log(t, 1) = "No transaction"
                    End If
        
                    transaction_log(t, 2) = frm_portfolio(i, 2)
                    transaction_log(t, 3) = to_portfolio(f, 2)
                    transaction_log(t, 4) = proc
                    transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                    t = t + 1
                    k = fund_trans(i, 0, 0) + 1
                    fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                    fund_trans(i, k, 1) = proc
                    fund_trans(i, k, 2) = to_portfolio(f, 2)
                    fund_trans(i, 0, 0) = k
                    fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                End If
            End If
                        
        '****************************************************************************************
        End If
    Next f
    
    'intra manco switches
    For f = 1 To 17
        If to_portfolio(f, 2) <> "" Then
            'If priority = True Then sort_list
            'new_fund_intra_manco (i)
            '*************************************************************************************
            'new fund intra manco
                        
            Set ws = ThisWorkbook.Worksheets("Switch")
            
            'to fund not in from portfolio so must buy units using other funds
            '1st try intra manco switch
                
            'i = find_manco(to_portfolio(f, 1))
            '*************************************************************************************
            'FIND MANCO FUNCTION
            
                l = 0: m = 0
                
                While (m = 0) And (l < 17)
                    l = l + 1
                    If frm_portfolio(l, 1) = to_portfolio(f, 1) And frm_portfolio(l, 6) > 0 Then m = 1
                Wend
                
                i = 0
                If m = 1 Then i = l
            '*************************************************************************************
            
            While (i <> 0) And (to_portfolio(f, 5) > 0)
                'same manco exists so do the transfer
                
                If to_portfolio(f, 5) = frm_portfolio(i, 6) Then
                    'transfer all funds from->to
                    proc = frm_portfolio(i, 6)
                    to_portfolio(f, 5) = 0
                    to_portfolio(f, 4) = to_portfolio(f, 4) + frm_portfolio(i, 6)
                    frm_portfolio(i, 6) = 0
                    
                    transaction_log(t, 1) = "Intra manco switch"
                    transaction_log(t, 2) = frm_portfolio(i, 2)
                    transaction_log(t, 3) = to_portfolio(f, 2)
                    transaction_log(t, 4) = proc
                    transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                    t = t + 1
                    k = fund_trans(i, 0, 0) + 1
                    fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                    fund_trans(i, k, 1) = proc
                    fund_trans(i, k, 2) = to_portfolio(f, 2)
                    fund_trans(i, 0, 0) = k
                    fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                    
                ElseIf to_portfolio(f, 5) < frm_portfolio(i, 6) Then
                    'sell as many units as necessary.
                    'The rest will be sold later
                    proc = to_portfolio(f, 5)
                    to_portfolio(f, 4) = to_portfolio(f, 4) + to_portfolio(f, 5)
                    frm_portfolio(i, 6) = frm_portfolio(i, 6) - to_portfolio(f, 5)
                    to_portfolio(f, 5) = 0
                    
                    transaction_log(t, 1) = "Intra manco switch"
                    transaction_log(t, 2) = frm_portfolio(i, 2)
                    transaction_log(t, 3) = to_portfolio(f, 2)
                    transaction_log(t, 4) = proc
                    transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                    t = t + 1
                    k = fund_trans(i, 0, 0) + 1
                    fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                    fund_trans(i, k, 1) = proc
                    fund_trans(i, k, 2) = to_portfolio(f, 2)
                    fund_trans(i, 0, 0) = k
                    fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                    
                ElseIf to_portfolio(f, 5) > frm_portfolio(i, 6) Then
                    'Sell all from units
                    'remaining to units needed will be bought later
                    proc = frm_portfolio(i, 6)
                    to_portfolio(f, 4) = to_portfolio(f, 4) + frm_portfolio(i, 6)
                    to_portfolio(f, 5) = to_portfolio(f, 5) - frm_portfolio(i, 6)
                    frm_portfolio(i, 6) = 0
                    
                    transaction_log(t, 1) = "Intra manco switch"
                    transaction_log(t, 2) = frm_portfolio(i, 2)
                    transaction_log(t, 3) = to_portfolio(f, 2)
                    transaction_log(t, 4) = proc
                    transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                    t = t + 1
                    k = fund_trans(i, 0, 0) + 1
                    fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                    fund_trans(i, k, 1) = proc
                    fund_trans(i, k, 2) = to_portfolio(f, 2)
                    fund_trans(i, 0, 0) = k
                    fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                End If
                
                'i = find_manco(to_portfolio(f, 1))
                '*************************************************************************************
                'FIND MANCO FUNCTION
                
                    l = 0: m = 0
                    
                    While (m = 0) And (l < 17)
                        l = l + 1
                        If frm_portfolio(l, 1) = to_portfolio(f, 1) And frm_portfolio(l, 6) > 0 Then m = 1
                    Wend
                    
                    i = 0
                    If m = 1 Then i = l
                '*************************************************************************************
            Wend

            '*************************************************************************************
        End If
    Next f
    
    'inter manco switches
    For f = 1 To 17
        If to_portfolio(f, 2) <> "" Then
            'If priority = True Then sort_list
            'new_fund_inter_manco (i)
            '*************************************************************************************
            'new fund inter manco
            
            Set ws = ThisWorkbook.Worksheets("Switch")
            
            'to fund not in from portfolio so must buy units using other funds
            'do inter manco switch
            i = 1
            While (i <= 17) And (to_portfolio(f, 5) > 0)
                'sequentially do the switch until to fund is filled
                If frm_portfolio(i, 6) > 0 Then
                    If to_portfolio(f, 5) = frm_portfolio(i, 6) Then
                        'transfer all funds from->to
                        proc = frm_portfolio(i, 6)
                        to_portfolio(f, 5) = 0
                        to_portfolio(f, 4) = to_portfolio(f, 4) + frm_portfolio(i, 6)
                        frm_portfolio(i, 6) = 0
                        
                        transaction_log(t, 1) = "Inter manco switch"
                        transaction_log(t, 2) = frm_portfolio(i, 2)
                        transaction_log(t, 3) = to_portfolio(f, 2)
                        transaction_log(t, 4) = proc
                        transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                        t = t + 1
                        k = fund_trans(i, 0, 0) + 1
                        fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                        fund_trans(i, k, 1) = proc
                        fund_trans(i, k, 2) = to_portfolio(f, 2)
                        fund_trans(i, 0, 0) = k
                        fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                        
                    ElseIf to_portfolio(f, 5) < frm_portfolio(i, 6) Then
                        'sell as many units as necessary.
                        'The rest will be sold later
                        proc = to_portfolio(f, 5)
                        to_portfolio(f, 4) = to_portfolio(f, 4) + to_portfolio(f, 5)
                        frm_portfolio(i, 6) = frm_portfolio(i, 6) - to_portfolio(f, 5)
                        to_portfolio(f, 5) = 0
                        
                        transaction_log(t, 1) = "Inter manco switch"
                        transaction_log(t, 2) = frm_portfolio(i, 2)
                        transaction_log(t, 3) = to_portfolio(f, 2)
                        transaction_log(t, 4) = proc
                        transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                        t = t + 1
                        k = fund_trans(i, 0, 0) + 1
                        fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                        fund_trans(i, k, 1) = proc
                        fund_trans(i, k, 2) = to_portfolio(f, 2)
                        fund_trans(i, 0, 0) = k
                        fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                        
                    ElseIf to_portfolio(f, 5) > frm_portfolio(i, 6) Then
                        'Sell all from units
                        'remaining to units needed will be bought later
                        proc = frm_portfolio(i, 6)
                        to_portfolio(f, 4) = to_portfolio(f, 4) + frm_portfolio(i, 6)
                        to_portfolio(f, 5) = to_portfolio(f, 5) - frm_portfolio(i, 6)
                        frm_portfolio(i, 6) = 0
                        
                        transaction_log(t, 1) = "Inter manco switch"
                        transaction_log(t, 2) = frm_portfolio(i, 2)
                        transaction_log(t, 3) = to_portfolio(f, 2)
                        transaction_log(t, 4) = proc
                        transaction_log(t, 5) = proc - (proc / frm_portfolio(i, 4)) * frm_portfolio(i, 5)
                        t = t + 1
                        k = fund_trans(i, 0, 0) + 1
                        fund_trans(i, 0, 1) = fund_trans(i, 0, 1) + proc
                        fund_trans(i, k, 1) = proc
                        fund_trans(i, k, 2) = to_portfolio(f, 2)
                        fund_trans(i, 0, 0) = k
                        fund_trans(i, k, 3) = transaction_log(t - 1, 1)
                    End If
                End If
                i = i + 1
            Wend
    
            '*************************************************************************************
        End If
    Next f
        
    '???????????????????????
    'get_cash

'    For i = 1 To t - 1
'        ws.Range("b50").Offset(i - 1, 0) = transaction_log(i, 1)
'        ws.Range("e50").Offset(i - 1, 0) = transaction_log(i, 2)
'        ws.Range("i50").Offset(i - 1, 0) = transaction_log(i, 3)
'        ws.Range("m50").Offset(i - 1, 0) = transaction_log(i, 4)
'        ws.Range("o50").Offset(i - 1, 0) = transaction_log(i, 5)
'    Next i

    aa = 0
    For i = 1 To 17
        If fund_trans(i, 0, 0) > 0 Then
            k = fund_trans(i, 0, 0)
            'ws.Range("b62").Offset(aa, 0) = frm_portfolio(i, 2)
            'ws.Range("e62").Offset(aa, 0) = fund_trans(i, 0, 1)
            tbal = 0
            For j = 1 To k
                transws.Range("c14").Offset(aa, 0) = original_portfolio(i, 2)
                u = fund_trans(i, j, 1) / frm_portfolio(i, 4)
                
                If fund_trans(i, j, 3) = "Inter Platform Switch" Then
                    cgt = 0
                Else
                    cgt = u * (frm_portfolio(i, 4) - frm_portfolio(i, 5))
                End If
                
                transws.Range("f14").Offset(aa, 0) = fund_trans(i, 0, 1)
                transws.Range("h14").Offset(aa, 0) = Round(fund_trans(i, 0, 1) / original_portfolio(i, 6), 4)
                transws.Range("j14").Offset(aa, 0) = fund_trans(i, j, 2)
                transws.Range("n14").Offset(aa, 0) = fund_trans(i, j, 1)
                transws.Range("p14").Offset(aa, 0) = Round(fund_trans(i, j, 1) / original_portfolio(i, 6), 4)
                
                If j < k Then
                    tbal = tbal + transws.Range("p14").Offset(aa, 0)
                Else
                    transws.Range("p14").Offset(aa, 0) = 1 - tbal
                End If
                
                If ws.Range("f12").Value = "Classic Investment Plan" Then
                    transws.Range("r14").Offset(aa, 0) = cgt
                Else
                    transws.Range("r14").Offset(aa, 0) = 0
                End If
                
                transws.Range("t14").Offset(aa, 0) = fund_trans(i, j, 3)
                aa = aa + 1
            Next j
            'aa = aa + 1
        End If
    Next i
    '--------------------might change--------------------
    'transws.Range("r12").Value = aa
    '----------------------------------------------------
    
    For i = 1 To 15
        transws.Range("c60").Offset(i - 1, 0) = to_portfolio(i, 1)
        transws.Range("f60").Offset(i - 1, 0) = to_portfolio(i, 2)
        transws.Range("j60").Offset(i - 1, 0) = to_portfolio(i, 3)
    Next i
    
    'If to_portfolio(9, 3) > 0 Then
    '    ws.Range("b104") = to_portfolio(9, 1)
    '    ws.Range("e104") = to_portfolio(9, 2)
    '    ws.Range("i104") = to_portfolio(9, 3)
    'End If
'esub:
    'ws.Protect Password:="retailplatform", AllowFormattingCells:=True
    
    
    'Calculations for Instructions from Transactions sheet
    '********************************************************************************************************************************************
    
    i = 14
    n = 14
    
    Do
        If Sheet3.Cells(i, 25) = "" Then
            i = i + 1
        Else
            If Sheet3.Cells(i, 25) = "New Switch" Then
                Sheet3.Cells(n, 27) = Sheet3.Cells(i, 3)
                Sheet3.Cells(n, 30) = Sheet3.Cells(i, 6)
                Sheet3.Cells(n, 32) = Sheet3.Cells(i, 8)
                Sheet3.Cells(n, 34) = Sheet3.Cells(i, 10)
                Sheet3.Cells(n, 38) = Sheet3.Cells(i, 14)
                Sheet3.Cells(n, 40) = Sheet3.Cells(i, 16)
                Sheet3.Cells(n, 42) = Sheet3.Cells(i, 18)
                
                i = i + 1
                n = n + 1
            Else
                If Sheet3.Cells(i, 25) = "Same Switch" Then
                    Sheet3.Cells(n, 34) = Sheet3.Cells(i, 10)
                    Sheet3.Cells(n, 38) = Sheet3.Cells(i, 14)
                    Sheet3.Cells(n, 40) = Sheet3.Cells(i, 16)
                    Sheet3.Cells(n, 42) = Sheet3.Cells(i, 18)
                    i = i + 1
                    n = n + 1
                End If
            End If
        End If
    Loop Until Sheet3.Cells(i, 3) = ""
        
    i = 14
    n = 16
   
    Do
        ' To side
        If Sheet3.Cells(i, 44) = "Same Fund" Then
            Sheet11.Cells(n, 3) = Sheet3.Cells(i, 27)
            Sheet11.Cells(n, 6) = Sheet3.Cells(i, 45)
            Sheet11.Cells(n, 8) = Sheet3.Cells(i, 46)
            n = n + 1
            i = i + 2
        Else
            Sheet11.Cells(n, 3) = Sheet3.Cells(i, 27)
            Sheet11.Cells(n, 6) = Sheet3.Cells(i, 30)
            Sheet11.Cells(n, 8) = Sheet3.Cells(i, 32)
            n = n + 1
            i = i + 1
        End If
        
    Loop Until Sheet3.Cells(i, 26) = ""
    
    
    i = 14
    n = 16
   
    Do
        ' From Side
        If Sheet3.Cells(i, 47) = "Skip" Then
            i = i + 1
        Else
            Sheet11.Cells(n, 10) = Sheet3.Cells(i, 34)
            Sheet11.Cells(n, 14) = Sheet3.Cells(i, 48)
            Sheet11.Cells(n, 16) = Sheet3.Cells(i, 50)
            Sheet11.Cells(n, 18) = Sheet3.Cells(i, 51)
            n = n + 1
            i = i + 1
        End If
        
    Loop Until Sheet3.Cells(i, 26) = ""

'********************************************************************************************************************************************
    
    
    Sheet11.Rows("16:55").EntireRow.Hidden = False
    
        i = 16
        Do
            i = i + 1
        Loop Until Sheet11.Cells(i, 10).Value = ""
        Sheet11.Rows(i & ":55").EntireRow.Hidden = True

    
    Sheet11.Activate
    Sheet11.Range("C14").Select
    Sheet11.Range("B11") = "Switch Instructions"
    Sheet11.Range("B58") = "Switched Funds"
    
    
    End If
    End If
End Sub
Attribute VB_Name = "Module8"
Sub SwitchInputs_Click()
    Sheet8.Activate
    Sheet8.Range("D26").Select
    Sheet1.Range("AD10").Value = "Switch"
End Sub

Sub RebalanceInputs_Click()
    Sheet2.Activate
    Sheet2.Range("D26").Select
    Sheet1.Range("AD10").Value = "Rebalance"
End Sub
Attribute VB_Name = "Module9"
Sub models_R()
    Dim portfolio(15, 7)
    
    Set ws = ThisWorkbook.Worksheets("Rebalance")
    Set mws = ThisWorkbook.Worksheets("Models")

    For i = 1 To 15
        
        portfolio(i, 1) = ws.Range("d52").Offset(i - 1, 0) 'manco
        
        If portfolio(i, 1) = "Models" Then
            portfolio(i, 5) = 1
        Else
            portfolio(i, 5) = 0
            
        End If
        
        portfolio(i, 2) = ws.Range("o52").Offset(i - 1, 0) 'fund
        
        If ws.Range("K45") = True Then 'Rand Amount
            portfolio(i, 3) = ws.Range("k52").Offset(i - 1, 0) 'amount desired
        Else
            portfolio(i, 3) = ws.Range("k52").Offset(i - 1, 0) * ws.Range("q41")
        End If
                
        portfolio(i, 4) = ws.Range("z52").Offset(i - 1, 0) 'Retail JSE Code
    Next i
    
    m = 1
    For i = 1 To 15

        If portfolio(i, 1) = "Models" Then
        
        mws.Range("v4").Offset(m - 1, 0) = portfolio(i, 1)
        
    
    
    Next i
    
End Sub

Attribute VB_Name = "Sheet1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet10"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet11"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub CommandButton1_Click()
    
       
    i = 14
    n = 14
    
    Do
        If Sheet3.Cells(i, 25) = "" Then
            i = i + 1
        Else
            If Sheet3.Cells(i, 25) = "New Switch" Then
                Sheet3.Cells(n, 27) = Sheet3.Cells(i, 3)
                Sheet3.Cells(n, 30) = Sheet3.Cells(i, 6)
                Sheet3.Cells(n, 32) = Sheet3.Cells(i, 8)
                Sheet3.Cells(n, 34) = Sheet3.Cells(i, 10)
                Sheet3.Cells(n, 38) = Sheet3.Cells(i, 14)
                Sheet3.Cells(n, 40) = Sheet3.Cells(i, 16)
                Sheet3.Cells(n, 42) = Sheet3.Cells(i, 18)
                
                i = i + 1
                n = n + 1
            Else
                If Sheet3.Cells(i, 25) = "Same Switch" Then
                    Sheet3.Cells(n, 34) = Sheet3.Cells(i, 10)
                    Sheet3.Cells(n, 38) = Sheet3.Cells(i, 14)
                    Sheet3.Cells(n, 40) = Sheet3.Cells(i, 16)
                    Sheet3.Cells(n, 42) = Sheet3.Cells(i, 18)
                    i = i + 1
                    n = n + 1
                End If
            End If
        End If
    Loop Until Sheet3.Cells(i, 3) = ""
        
    i = 14
    n = 16
   
    Do
        ' To side
        If Sheet3.Cells(i, 44) = "Same Fund" Then
            Sheet11.Cells(n, 3) = Sheet3.Cells(i, 27)
            Sheet11.Cells(n, 6) = Sheet3.Cells(i, 45)
            Sheet11.Cells(n, 8) = Sheet3.Cells(i, 46)
            n = n + 1
            i = i + 2
        Else
            Sheet11.Cells(n, 3) = Sheet3.Cells(i, 27)
            Sheet11.Cells(n, 6) = Sheet3.Cells(i, 30)
            Sheet11.Cells(n, 8) = Sheet3.Cells(i, 32)
            n = n + 1
            i = i + 1
        End If
        
    Loop Until Sheet3.Cells(i, 26) = ""
    
    
    i = 14
    n = 16
   
    Do
        ' From Side
        If Sheet3.Cells(i, 47) = "Skip" Then
            i = i + 1
        Else
            Sheet11.Cells(n, 10) = Sheet3.Cells(i, 34)
            Sheet11.Cells(n, 14) = Sheet3.Cells(i, 48)
            Sheet11.Cells(n, 16) = Sheet3.Cells(i, 50)
            Sheet11.Cells(n, 18) = Sheet3.Cells(i, 42)
            n = n + 1
            i = i + 1
        End If
        
    Loop Until Sheet3.Cells(i, 26) = ""

End Sub
Attribute VB_Name = "Sheet12"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet13"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet14"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet15"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet16"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet17"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet2"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Public Sub OptionButton1R_Click()
    ThisWorkbook.Worksheets("Rebalance").Range("h48").NumberFormat = "[$R-1C09] #,##0;[$R-1C09] -#,##0.00"
    ThisWorkbook.Worksheets("Rebalance").Range("k52:l67").NumberFormat = "[$R-1C09] #,##0;[$R-1C09] -#,##0.00"
End Sub

Public Sub OptionButton2R_Click()
    ThisWorkbook.Worksheets("Rebalance").Range("h48").NumberFormat = "0.00%"
    ThisWorkbook.Worksheets("Rebalance").Range("k52:l67").NumberFormat = "0.00%"
End Sub

Attribute VB_Name = "Sheet3"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet4"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet5"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet6"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Worksheet_Activate()
   'WebBrowser1.Navigate "X:complete path image.GIF"
End Sub
Attribute VB_Name = "Sheet7"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet8"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True


Public Sub OptionButton1_Click()
    ThisWorkbook.Worksheets("Switch").Range("h48").NumberFormat = "[$R-1C09] #,##0;[$R-1C09] -#,##0"
    ThisWorkbook.Worksheets("Switch").Range("k52:l67").NumberFormat = "[$R-1C09] #,##0;[$R-1C09] -#,##0"
End Sub

Public Sub OptionButton2_Click()
    ThisWorkbook.Worksheets("Switch").Range("h48").NumberFormat = "0.00%"
    ThisWorkbook.Worksheets("Switch").Range("k52:l67").NumberFormat = "0.00%"
End Sub

Attribute VB_Name = "Sheet9"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "ThisWorkbook"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True


INQUEST-PP=macro
