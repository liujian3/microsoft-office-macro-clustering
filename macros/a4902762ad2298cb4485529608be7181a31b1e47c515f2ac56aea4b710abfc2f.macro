Attribute VB_Name = "Module1"
Private Sub StartScript_FCSTdownload()

Application.DisplayAlerts = False
Application.EnableEvents = False
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

Dim i As Integer
Dim KPA_Session As Integer
Dim KPAExists As Boolean
Dim QRFile As String
Dim ForecastTemp As String
Dim FileExists As Boolean
FileExists = True
Dim FilePath As String
Dim TestStr As String
Dim n As Integer

Dim Vendor As String
Dim Plant As String
Dim Plant2 As String
Dim Plant3 As String
Dim Plant4 As String
Dim WK As String
Dim MRPController As String
Dim Horison As Integer 'number of weeks to download
Dim ProfilVariant As String
Dim EEplant As String
Dim Category As String

'Unprotect sheets
Worksheets("Forecast").Unprotect
Worksheets("Planning").Unprotect
Worksheets("Supplier").Unprotect


' Clean all old data (forecast and supplier figures)
Sheets("Forecast").Activate
Range("A3:BF1000").ClearContents

Sheets("Supplier").Activate
Range("E3:F1000").ClearContents
Range("H3:BG1000").ClearContents


' Assign user setup values;
Vendor = Sheets("setup").Cells(3, 2).Value
Plant = Sheets("SETUP").Cells(5, 2).Value
Plant2 = Sheets("SETUP").Cells(5, 3).Value
Plant3 = Sheets("SETUP").Cells(5, 4).Value
Plant4 = Sheets("SETUP").Cells(5, 5).Value
WK = Sheets("SETUP").Cells(2, 2).Value
MRPController = Sheets("SETUP").Cells(10, 2).Value
Horison = Sheets("SETUP").Cells(11, 2).Value
ProfilVariant = Sheets("SETUP").Cells(12, 2).Value
EEplant = Sheets("SETUP").Cells(13, 2).Value
Category = Sheets("SETUP").Cells(14, 2).Value
QRFile = ActiveWorkbook.Name

' check Master Data
If Vendor = "" Then
    Worksheets("SETUP").Activate
    MsgBox "Vendor Code is missing!"
    Exit Sub
End If

If Plant = "" Then
    Worksheets("SETUP").Activate
    MsgBox "Plant Code is missing!"
    Exit Sub
End If

If Category = "" Then
    Worksheets("SETUP").Activate
    MsgBox "Category is missing!"
    Exit Sub
End If

On Error Resume Next

Application.StatusBar = "Downloading Forecast, please wait..."


'Checking if SAP KPA is opened
If Not IsObject(sapplication) Then
    Set SapGuiAuto = GetObject("SAPGUI")
    Set sapplication = SapGuiAuto.GetScriptingEngine
End If
KPAExists = False
For i = 0 To sapplication.Children.Count - 1
    If sapplication.Children(i + 0).Children(0).Info.SystemName = "KPA" Then
        KPA_Session = i
        KPAExists = True
    End If
Next i

    If KPAExists = False Then
        MsgBox "Please log in to KPA!"
        Exit Sub
    End If
    
    If Not IsObject(Connection) Then
       Set Connection = sapplication.Children(KPA_Session + 0)
    End If
    If Not IsObject(session) Then
       Set session = Connection.Children(0)
    End If
    If IsObject(WScript) Then
       WScript.ConnectObject session, "on"
       WScript.ConnectObject sapplication, "on"
    End If
    
On Error Resume Next
        
'Open the transaction in KPA
Application.StatusBar = "Open the transaction in KPA, please wait..."
session.findById("wnd[0]").maximize

'Check for EE plant (EE Plant uses different transaction)
If EEplant = "YES" Then
    session.findById("wnd[0]/tbar[0]/okcd").Text = "/nymm_delfcast_b"
    Else
    session.findById("wnd[0]/tbar[0]/okcd").Text = "/nymm_delfcast"
End If
session.findById("wnd[0]").sendVKey 0
session.findById("wnd[0]").sendVKey 0

'Copy the data
Application.StatusBar = "Copying data, please wait..."
If ProfilVariant = "" Then

session.findById("wnd[0]/usr/ctxtP_LIFNR").Text = Vendor
session.findById("wnd[0]/usr/ctxtS_WERKS-LOW").Text = Plant
session.findById("wnd[0]/usr/ctxtP_LIFNR").caretPosition = 6
session.findById("wnd[0]/usr/btn%_S_WERKS_%_APP_%-VALU_PUSH").press
session.findById("wnd[0]/usr/ctxtS_WERKS-LOW").SetFocus
session.findById("wnd[0]/usr/ctxtS_WERKS-LOW").caretPosition = 4
session.findById("wnd[0]/usr/ctxtS_WERKS-LOW").caretPosition = 4
session.findById("wnd[0]/usr/btn%_S_WERKS_%_APP_%-VALU_PUSH").press

session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,1]").Text = Plant2
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,2]").Text = Plant3
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,3]").Text = Plant4
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,1]").SetFocus
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,1]").caretPosition = 4
session.findById("wnd[1]/tbar[0]/btn[8]").press

session.findById("wnd[0]/usr/ctxtS_DISPO-LOW").Text = MRPController

session.findById("wnd[0]/usr/txtP_DAYS").Text = "0"
session.findById("wnd[0]/usr/txtP_WEEKS").Text = Horison
session.findById("wnd[0]/usr/txtP_MONTHS").Text = "0"
session.findById("wnd[0]/usr/ctxtS_DISPO-LOW").SetFocus
session.findById("wnd[0]/usr/ctxtS_DISPO-LOW").caretPosition = 0
session.findById("wnd[0]/tbar[1]/btn[8]").press

Else
session.findById("wnd[0]/tbar[1]/btn[17]").press
session.findById("wnd[1]/usr/txtV-LOW").Text = ProfilVariant
session.findById("wnd[1]/usr/txtENAME-LOW").Text = ""
session.findById("wnd[1]/usr/txtV-LOW").caretPosition = 11
session.findById("wnd[1]/tbar[0]/btn[8]").press
session.findById("wnd[0]/tbar[1]/btn[8]").press

End If
 
Dim x As String
If session.findById("wnd[0]/sbar").messagetype = "E" Then
    x = session.findById("wnd[0]/sbar").Text
    MsgBox "SAP Message: " & x
    Application.StatusBar = "Stopped."
    Exit Sub
Else
    'Export to Excel
    Application.StatusBar = "Exporting to Excel, please wait..."
    session.findById("wnd[0]").maximize
    session.findById("wnd[0]/usr/cntlCONT/shellcont/shell").pressToolbarContextButton "&MB_EXPORT"
    session.findById("wnd[0]/usr/cntlCONT/shellcont/shell").selectContextMenuItem "&XXL"

    'pick excel format
    session.findById("wnd[1]/usr/radRB_2").SetFocus
    session.findById("wnd[1]/usr/radRB_2").Select
    session.findById("wnd[1]/usr/radRB_OTHERS").SetFocus
    session.findById("wnd[1]/usr/radRB_OTHERS").Select
    session.findById("wnd[1]/usr/cmbG_LISTBOX").SetFocus
    session.findById("wnd[1]/usr/cmbG_LISTBOX").Key = "09"
    session.findById("wnd[1]/usr/cmbG_LISTBOX").SetFocus
    session.findById("wnd[1]/usr/cmbG_LISTBOX").Key = "10"
    session.findById("wnd[1]/tbar[0]/btn[0]").press


ForecastTemp = Vendor & "_Forecast_" & WK & ".xls"
FilePath = Application.ActiveWorkbook.Path & "\Forecast\" & ForecastTemp
session.findById("wnd[1]/usr/ctxtDY_PATH").Text = Application.ActiveWorkbook.Path & "\Forecast\"
session.findById("wnd[1]/usr/ctxtDY_FILENAME").Text = ForecastTemp
session.findById("wnd[1]/usr/ctxtDY_FILENAME").caretPosition = 10
session.findById("wnd[1]/tbar[0]/btn[11]").press



Application.StatusBar = "Copying forecast to QR file, please wait..."
Workbooks(QRFile).Sheets("Forecast").Range("A2:BF1000").ClearContents

'Adjusting format
Application.DecimalSeparator = "."
Application.ThousandsSeparator = ","
Application.UseSystemSeparators = False

    
' Change format of material code in MasterData into General
Workbooks(QRFile).Sheets("MasterData").Range("E2:E1000").Select
    With Selection
        .NumberFormat = "General"
        .Value = .Value
    End With
    
'Copy data from Forecast file to QR file
Dim xlApp As Application
Dim xlBook As Workbook
Dim Sh As Object

Set xlApp = CreateObject("Excel.Application")
Set xlBook = xlApp.Workbooks.Open(FilePath)
xlBook.Sheets(1).Range("A1:BF1000").Copy
xlApp.DisplayAlerts = False
xlBook.Close
xlApp.Quit
Set xlBook = Nothing
Set xlApp = Nothing
Set xlBook = ActiveWorkbook
Set Sh = xlBook.Sheets("Forecast")
Sh.Activate
Range("a2").Select
Sh.Paste
Range("A1").Select
'xlBook.Close
 
Application.UseSystemSeparators = True
 
Application.StatusBar = "Setting Sheets protection, please wait..."

' Protect some sheets
Worksheets("Forecast").Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
Worksheets("Supplier").Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
Worksheets("Planning").Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True, AllowUsingPivotTables:=True
Worksheets("MasterData").Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True, AllowFormattingColumns:=True, AllowDeletingRows:=True ' allow hiding columns and deleting rows
Worksheets("MD_Drop").Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True, AllowDeletingRows:=True 'allow deleting rows
Worksheets("SETUP").Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
Worksheets("Guidelines").Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
Worksheets("Send Email").Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True

DoEvents
'Call Button15_Click

Application.StatusBar = "Done!"
Workbook.Save
Application.StatusBar = False

Worksheets("Forecast").Activate

Application.DisplayAlerts = True
Application.EnableEvents = True
Application.ScreenUpdating = True
Application.Calculation = xlCalculationAutomatic

End If

End Sub
Attribute VB_Name = "Module10"
Sub HideMD()
Attribute HideMD.VB_ProcData.VB_Invoke_Func = " \n14"
'
' HideMD Macro
'
ActiveSheet.Unprotect

Columns("G:T").EntireColumn.Hidden = True
Columns("AA:AI").EntireColumn.Hidden = True
Columns("AR").EntireColumn.Hidden = True

ActiveSheet.Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True

End Sub

Sub UnhideMD()
'
' HideMD Macro
'
ActiveSheet.Unprotect

Columns("A:BB").EntireColumn.Hidden = False

ActiveSheet.Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True

End Sub

Attribute VB_Name = "Module11"
Sub CreateNewQR()

Dim QRTemp As String
Dim WK As String
Dim VendorName As String
Dim Plant As String
Dim Category As String
Dim FilePath2 As String


'Assing varables
WK = Sheets("SETUP").Cells(2, 6).Value
VendorName = Sheets("setup").Cells(4, 2).Value
Plant = Sheets("SETUP").Cells(5, 6).Value
Category = Sheets("SETUP").Cells(14, 6).Value
QRTemp = Category & "_" & Plant & "_" & VendorName & "_" & "QR_" & WK & ".xlsm"
FilePath2 = Application.ActiveWorkbook.Path & "\" & QRTemp

If VendorName = "" Then
    MsgBox "Vendor Name is missing"
    Sheets("SETUP").Activate
    Sheets("SETUP").Cells(4, 2).Select
    Exit Sub
    Else
    If Plant = "" Then
        MsgBox "Plant Code is missing"
        Sheets("SETUP").Activate
        Sheets("SETUP").Cells(5, 2).Select
        Exit Sub
            Else
            If Category = "" Then
                MsgBox "Category is missing"
                Sheets("SETUP").Activate
                Sheets("SETUP").Cells(14, 2).Select
                Exit Sub
            End If
    End If
End If

'Save this Workbook as new one
ActiveWorkbook.SaveAs Filename:=FilePath2, FileFormat:=52


MsgBox "Saved as: " & QRTemp

End Sub
Attribute VB_Name = "Module12"
Sub MinimiseView()

Worksheets("Planning").Unprotect
Columns("E:J").EntireColumn.Hidden = True

Worksheets("Planning").Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True

End Sub
Sub MaxView()

Worksheets("Planning").Unprotect
Columns("E:J").EntireColumn.Hidden = False

Worksheets("Planning").Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
End Sub
Attribute VB_Name = "Module15"
Sub downloadMDList()
UserForm1.Show

End Sub
Sub Button11_Click()
Sheets("MD_Drop").Activate
Range("A10").Value = TextBox1.Text

End Sub
Attribute VB_Name = "Module17"
Sub TransferMDfromQR()

Application.DisplayAlerts = False
Application.EnableEvents = False
Application.ScreenUpdating = False
Application.Calculation = xlCalculationManual

Dim intChoice As Integer
Dim strPath As String
Dim App As Application
Dim WB As Workbook
Dim thisWB As Workbook
Dim MaterialNumber As Integer

Set thisWB = ThisWorkbook

thisWB.Sheets("MasterData").Unprotect
thisWB.Sheets("Setup").Unprotect
thisWB.Sheets("Send Email").Unprotect

'Remove all other filters
Call Application.FileDialog(msoFileDialogOpen).Filters.Clear
'Add a custom filter
Call Application.FileDialog(msoFileDialogOpen).Filters.Add("Excel only", "*.xls*")
'only allow the user to select one file
Application.FileDialog(msoFileDialogOpen).AllowMultiSelect = False

Application.FileDialog(msoFileDialogOpen).Title = "Pick QR from which copy Master Data."

'make the file dialog visible to the user
intChoice = Application.FileDialog(msoFileDialogOpen).Show
'determine what choice the user made
If intChoice <> 0 Then
'get the file path selected by the user
strPath = Application.FileDialog(msoFileDialogOpen).SelectedItems(1)

'clear old data if any
thisWB.Sheets("MasterData").Range("D2:G1000").ClearContents
thisWB.Sheets("MasterData").Range("P2:AO1000").ClearContents
thisWB.Sheets("MasterData").Range("AQ2:AQ1000").ClearContents
thisWB.Sheets("MasterData").Range("AS2:AZ1000").ClearContents
thisWB.Sheets("Send Email").Range("B2:B3").ClearContents
thisWB.Sheets("Send Email").Range("B5").ClearContents

'open workbook and copy/paste data
Set WB = Workbooks.Open(strPath)

WB.Sheets("Setup").Range("B3:B16").Copy
thisWB.Sheets("SETUP").Range("B3").PasteSpecial Paste:=xlPasteValues
MaterialNumber = WB.Sheets("MasterData").Range("E10000").End(xlUp).Row
WB.Sheets("MasterData").Range("D2:H" & MaterialNumber).Copy
thisWB.Sheets("MasterData").Range("D2").PasteSpecial Paste:=xlPasteValues
WB.Sheets("MasterData").Range("P2:AO" & MaterialNumber).Copy
thisWB.Sheets("MasterData").Range("P2").PasteSpecial Paste:=xlPasteValues
WB.Sheets("MasterData").Range("AS1:AZ" & MaterialNumber).Copy
thisWB.Sheets("MasterData").Range("AS1").PasteSpecial Paste:=xlPasteValues
WB.Sheets("Send Email").Range("B2:B3").Copy
thisWB.Sheets("Send Email").Range("B2").PasteSpecial Paste:=xlPasteValues
WB.Sheets("Send Email").Range("B5").Copy
thisWB.Sheets("Send Email").Range("B5").PasteSpecial Paste:=xlPasteValues

WB.Close

Application.DisplayAlerts = True
Application.EnableEvents = True
Application.ScreenUpdating = True
Application.Calculation = xlCalculationAutomatic

Worksheets("MasterData").Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
thisWB.Sheets("Setup").Protect
thisWB.Sheets("Send Email").Protect

thisWB.Sheets("Setup").Activate

MsgBox "Verify Annual volumes and Boundaries"


End If



End Sub
Attribute VB_Name = "Module2"


Attribute VB_Name = "Module3"
Sub SendQR()

'Created by Robert Chilimonczyk
'Working in Excel 2000-2016

'This example send the last saved version of the Activeworkbook

'Save QR File
ActiveWorkbook.Save
Application.StatusBar = "Saved File"


'Create Email

    Dim OutApp As Object
    Dim OutMail As Object

    Set OutApp = CreateObject("Outlook.Application")
    Set OutMail = OutApp.CreateItem(0)

    On Error Resume Next
    With OutMail
        .To = Sheets("Send Email").Range("b2")
        .CC = Sheets("Send Email").Range("b3")
        .BCC = ""
        .Subject = Sheets("Send Email").Range("b4")
        .Body = Sheets("Send Email").Range("b5")
        .Attachments.Add ActiveWorkbook.FullName
        'You can add other files also like this
        '.Attachments.Add ("C:\test.txt")
        .display   'or use .Send
    End With
    On Error GoTo 0

    Set OutMail = Nothing
    Set OutApp = Nothing
    


End Sub

Attribute VB_Name = "Module4"
Private Function DIFC(dblStock As Double, _
            oRange As Range, _
            Optional blnInt As Boolean = True, _
            Optional blnRound As Boolean) As Double
Dim objRange As Range
Dim oCell As Range

Dim dblAvailStock As Double
Dim dblTotDmd As Double

Dim dblCovDur As Double

Set objRange = Selection

'If objRange Is Nothing Then
'    MsgBox "Nothing is selected!"
'    Exit Function
'End If

dblAvailStock = dblStock
For Each oCell In oRange
    dblTotDmd = oCell.Value
    If dblAvailStock <= 0 Then
        If oCell.Offset(0, -1).Value <> 0 Then
        dblTotDmd = oCell.Offset(0, -1).Value
        dblCovDur = dblAvailStock / Abs(dblTotDmd) * 7
        GoTo exit_sub
        Else
        dblCovDur = -999
        GoTo exit_sub
        End If
    End If
    If dblAvailStock > Abs(dblTotDmd) Then
        dblCovDur = dblCovDur + 7
        dblAvailStock = dblAvailStock - Abs(dblTotDmd)
    Else
        dblCovDur = dblCovDur + dblAvailStock / Abs(dblTotDmd) * 7
        dblAvailStock = 0
        Exit For
    End If
Next oCell

If dblAvailStock > 0 Then dblCovDur = 999

exit_sub:
DIFC = dblCovDur
If blnInt Then
    DIFC = Int(DIFC)
ElseIf blnRound Then
    DIFC = Round(DIFC)
End If

End Function


Attribute VB_Name = "Module5"
Sub Button4_Click()

Worksheets("Planning").Range("$A$2:$A$12").AutoFilter Field:=1, Criteria1:="<>"

End Sub
Attribute VB_Name = "Module6"
Sub ResetFilters()
    On Error Resume Next
    ActiveSheet.ShowAllData
End Sub
Sub ClearPlanningFilters()
Attribute ClearPlanningFilters.VB_ProcData.VB_Invoke_Func = " \n14"
'
' ClearPlanningFilters Macro
'
ActiveSheet.ListObjects(1).AutoFilter.ShowAllData


End Sub
Attribute VB_Name = "Module7"
Sub MD_Download()

Dim i As Integer
Dim SKUcount As Integer
Dim KPA_Session As Integer
Dim KPAExists As Boolean
Dim QRFile As String
Dim MDTemp As String
Dim FileExists As Boolean
FileExists = True
Dim MDFilePath As String
Dim TestStr As String
Dim n As Integer
Dim WK As String

Dim Vendor As String
Dim Plant As String
Dim Plant2 As String
Dim Plant3 As String
Dim Plant4 As String
Dim PlantMD As String
Dim PlantMD2 As String
Dim PlantMD3 As String
Dim PlantMD4 As String
Dim ScopeOfList As String
Dim ContractValidFrom As String
Dim ContractValidTo As String
Dim Material As String
Dim EEplant As String

Application.DisplayAlerts = False
Application.EnableEvents = False
Application.ScreenUpdating = False

'Set up variables
EEplant = Sheets("SETUP").Cells(13, 2).Value
Vendor = Sheets("setup").Cells(3, 2).Value
Plant = Sheets("SETUP").Cells(5, 2).Value
Plant2 = Sheets("SETUP").Cells(5, 3).Value
Plant3 = Sheets("SETUP").Cells(5, 4).Value
Plant4 = Sheets("SETUP").Cells(5, 5).Value
ScopeOfList = "ZRAHM"
ContractValidFrom = Sheets("MD_Drop").Cells(1, 3).Value
ContractValidTo = Sheets("MD_Drop").Cells(1, 5).Value
Material = Sheets("MD_Drop").Cells(2, 3).Value
WK = Sheets("SETUP").Cells(2, 2).Value

Worksheets("Forecast").Unprotect
Worksheets("MasterData").Unprotect
Worksheets("MD_Drop").Unprotect
SKUcount = Worksheets("Forecast").Range("B:B").Cells.SpecialCells(xlCellTypeConstants).Count

QRFile = ActiveWorkbook.Name

'making sure that there is enough rows with formulas in columns AE:DS
Range("W10:DS10").Copy Range("W10:w500")

' IF EE Plant then no need to change ending to P1, just leave plant code as it is.
If EEplant = "YES" Then
    PlantMD = Sheets("SETUP").Cells(5, 2).Value
    Else
    PlantMD = Left(Sheets("SETUP").Cells(5, 2).Value, 2) & "P1"
    If Plant2 = "" Then
        PlantMD2 = ""
    Else
        PlantMD2 = Left(Sheets("SETUP").Cells(5, 3).Value, 2) & "P1"
        End If
        If Plant3 = "" Then
            PlantMD3 = ""
            Else
            PlantMD3 = Left(Sheets("SETUP").Cells(5, 4).Value, 2) & "P1"
        End If
        If Plant4 = "" Then
            PlantMD4 = ""
            Else
            PlantMD4 = Left(Sheets("SETUP").Cells(5, 5).Value, 2) & "P1"
        End If
End If

Range("a4:v1000").ClearContents

' Check Master Data
If Vendor = "" Then
    Worksheets("SETUP").Activate
    MsgBox "Vendor Code is missing!"
    Exit Sub
End If

If Plant = "" Then
    Worksheets("SETUP").Activate
    MsgBox "Plant Code is missing!"
    Exit Sub
End If

If Range("C2") = "" And SKUcount <= 1 Then
    MsgBox "Forecast is missing... Download forecast first then Master Data!"
    Exit Sub
End If
    
On Error Resume Next

If Material <> "" Then
    Worksheets("MD_Drop").Range("C2").Copy
    Else
    Worksheets("Forecast").Range("b3:b1000").Copy ' needed to paste that into materials in ME3M transaction
End If


Application.StatusBar = "Running SAP Transaction, please wait..."


If Not IsObject(sapplication) Then
    Set SapGuiAuto = GetObject("SAPGUI")
    Set sapplication = SapGuiAuto.GetScriptingEngine
End If
    KPAExists = False
    
    For i = 0 To sapplication.Children.Count - 1
        If sapplication.Children(i + 0).Children(0).Info.SystemName = "KPA" Then
            KPA_Session = i
            KPAExists = True
        End If
       
    Next i

    If KPAExists = False Then
        MsgBox "Please log in to KPA!"
        Exit Sub
    End If
    
    If Not IsObject(Connection) Then
       Set Connection = sapplication.Children(KPA_Session + 0)
    End If
    If Not IsObject(session) Then
       Set session = Connection.Children(0)
    End If
    If IsObject(WScript) Then
       WScript.ConnectObject session, "on"
       WScript.ConnectObject sapplication, "on"
    End If
    
         On Error Resume Next
         
'Open the transaction in KPA
session.findById("wnd[0]").maximize
session.findById("wnd[0]/tbar[0]/okcd").Text = "/nME3M"
session.findById("wnd[0]").sendVKey 0
'session.findById("wnd[0]").sendVKey 0

session.findById("wnd[0]/usr/btn%_EM_MATNR_%_APP_%-VALU_PUSH").press
session.findById("wnd[1]/tbar[0]/btn[16]").press
session.findById("wnd[1]/tbar[0]/btn[24]").press
session.findById("wnd[1]/tbar[0]/btn[8]").press

session.findById("wnd[0]/usr/ctxtEM_EKORG-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtLISTU").Text = ""
session.findById("wnd[0]/usr/ctxtSELPA-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_BSART-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_EKGRP-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_PSTYP-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_PSTYP-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_KNTTP-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_KNTTP-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_EINDT-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_EINDT-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtP_GULDT").Text = ""
session.findById("wnd[0]/usr/ctxtP_RWEIT").Text = ""
'session.findById("wnd[0]/usr/ctxtS_EBELN-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_LIFNR-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_LIFNR-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_RESWK-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_RESWK-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_MATKL-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_MATKL-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_BEDAT-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_BEDAT-HIGH").Text = ""
session.findById("wnd[0]/usr/txtS_EAN11-LOW").Text = ""
session.findById("wnd[0]/usr/txtS_EAN11-HIGH").Text = ""
session.findById("wnd[0]/usr/txtS_IDNLF-LOW").Text = ""
session.findById("wnd[0]/usr/txtS_IDNLF-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_LTSNR-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_LTSNR-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_AKTNR-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_AKTNR-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_SAISO-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_SAISO-HIGH").Text = ""
session.findById("wnd[0]/usr/txtS_SAISJ-LOW").Text = ""
session.findById("wnd[0]/usr/txtS_SAISJ-HIGH").Text = ""
session.findById("wnd[0]/usr/txtP_TXZ01").Text = ""
session.findById("wnd[0]/usr/txtP_NAME1").Text = ""
session.findById("wnd[0]/usr/ctxtS_STAPO-LOW").Text = ""

    On Error Resume Next

session.findById("wnd[0]/usr/ctxtLISTU").Text = "ZRAHM"
session.findById("wnd[0]/usr/ctxtS_EINDT-LOW").Text = ContractValidFrom
session.findById("wnd[0]/usr/ctxtS_EINDT-HIGH").Text = ContractValidTo
session.findById("wnd[0]/usr/ctxtS_LIFNR-LOW").Text = Vendor
session.findById("wnd[0]/usr/ctxtP_GULDT").SetFocus
session.findById("wnd[0]/usr/ctxtP_GULDT").caretPosition = 10

'session.findById("wnd[0]/usr/ctxtEM_WERKS-LOW").Text = PlantMD
session.findById("wnd[0]/usr/btn%_EM_WERKS_%_APP_%-VALU_PUSH").press
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,0]").Text = PlantMD
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,1]").Text = PlantMD2
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,2]").Text = PlantMD3
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,3]").Text = PlantMD4
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,3]").SetFocus
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,3]").caretPosition = 4
session.findById("wnd[1]/tbar[0]/btn[8]").press
session.findById("wnd[0]/tbar[1]/btn[8]").press

' set up /QRfile Layout
session.findById("wnd[0]/tbar[1]/btn[33]").press
session.findById("wnd[1]/usr/ssubD0500_SUBSCREEN:SAPLSLVC_DIALOG:0501/cntlG51_CONTAINER/shellcont/shell").currentCellRow = 49
'session.findById("wnd[1]/usr/ssubD0500_SUBSCREEN:SAPLSLVC_DIALOG:0501/cntlG51_CONTAINER/shellcont/shell").firstVisibleRow = 43
session.findById("wnd[1]/usr/ssubD0500_SUBSCREEN:SAPLSLVC_DIALOG:0501/cntlG51_CONTAINER/shellcont/shell").selectedRows = "49"
session.findById("wnd[1]/usr/ssubD0500_SUBSCREEN:SAPLSLVC_DIALOG:0501/cntlG51_CONTAINER/shellcont/shell").clickCurrentCell
session.findById("wnd[0]/tbar[1]/btn[8]").press

' filter contracts with quantity >1
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").setCurrentCell -1, "KTMNG"
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectColumn "KTMNG"
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").contextMenu
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectContextMenuItem "&FILTER"
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN001-LOW").Text = ""
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN002-LOW").Text = ""
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN003-LOW").Text = "2"
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN003-HIGH").Text = "9999999999"
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN003-HIGH").SetFocus
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN003-HIGH").caretPosition = 10
session.findById("wnd[1]/tbar[0]/btn[0]").press

'Filter out contract flaged to be deleted.
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").setCurrentCell -1, "LOEKZ"
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectColumn "LOEKZ"
session.findById("wnd[0]/tbar[1]/btn[29]").press
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/btn%_%%DYN003_%_APP_%-VALU_PUSH").press
session.findById("wnd[2]/usr/tabsTAB_STRIP/tabpNOSV").Select
session.findById("wnd[2]/usr/tabsTAB_STRIP/tabpNOSV/ssubSCREEN_HEADER:SAPLALDB:3030/tblSAPLALDBSINGLE_E/ctxtRSCSEL_255-SLOW_E[1,0]").Text = "s"
session.findById("wnd[2]/usr/tabsTAB_STRIP/tabpNOSV/ssubSCREEN_HEADER:SAPLALDB:3030/tblSAPLALDBSINGLE_E/ctxtRSCSEL_255-SLOW_E[1,0]").caretPosition = 1
session.findById("wnd[2]/tbar[0]/btn[8]").press

'Filter within valid dates and sort
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").setCurrentCell -1, "KDATE"
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectColumn "KDATE"
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectedRows = ""
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").contextMenu
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectContextMenuItem "&FILTER"
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN001-LOW").Text = ContractValidFrom
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN001-HIGH").Text = ContractValidTo
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN001-HIGH").SetFocus
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN001-HIGH").caretPosition = 10
session.findById("wnd[1]/tbar[0]/btn[0]").press
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").setCurrentCell -1, "EMATN"
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectColumn "EMATN"
session.findById("wnd[0]/tbar[1]/btn[28]").press

' download to excel
session.findById("wnd[0]/tbar[1]/btn[45]").press
session.findById("wnd[1]/usr/subSUBSCREEN_STEPLOOP:SAPLSPO5:0150/sub:SAPLSPO5:0150/radSPOPLI-SELFLAG[1,0]").Select
session.findById("wnd[1]/usr/subSUBSCREEN_STEPLOOP:SAPLSPO5:0150/sub:SAPLSPO5:0150/radSPOPLI-SELFLAG[1,0]").SetFocus
session.findById("wnd[1]/tbar[0]/btn[0]").press

Application.StatusBar = "Downloading Master Data, please wait..."

MDTemp = Vendor & "_MD_" & WK & ".xls"
MDFilePath = Application.ActiveWorkbook.Path & "\MasterData\" & MDTemp

session.findById("wnd[1]/usr/ctxtDY_PATH").Text = Application.ActiveWorkbook.Path & "\MasterData\"
session.findById("wnd[1]/usr/ctxtDY_FILENAME").Text = MDTemp
session.findById("wnd[1]/usr/ctxtDY_FILENAME").caretPosition = 10
session.findById("wnd[1]/tbar[0]/btn[11]").press

Application.StatusBar = "Copying Data, please wait..."

'Copying data into the file
Dim xlApp As Application
Dim xlBook As Workbook
Dim Sh As Object

 Set xlApp = CreateObject("Excel.Application")
 Set xlBook = xlApp.Workbooks.Open(MDFilePath)
 xlBook.Sheets(1).Range("a1:Bf1000").Copy
 xlApp.DisplayAlerts = False
 xlBook.Close
 xlApp.Quit
 Set xlBook = Nothing
 Set xlApp = Nothing
 Set xlBook = ActiveWorkbook
 Set Sh = xlBook.Sheets("MD_Drop")
 Sh.Activate
 Range("a4").Select
 Sh.Paste
 Range("A1").Select

Dim Comm As String

Application.StatusBar = "All done! You have " & Worksheets("MD_Drop").Range("H3").Value & " duplicated contracts!"

'display end comment
If Worksheets("MD_Drop").Range("H3").Value > 0 Then
    MsgBox " You have " & Worksheets("MD_Drop").Range("H3").Value & " duplicated contracts!"
    Else
    MsgBox "Done. Please verify Annual Volumes before copying data into MasterData tab!"
End If

'Hide not-needed columns
Worksheets("MD_Drop").Columns("N:N").EntireColumn.Hidden = True
Worksheets("MD_Drop").Columns("AU:AU").EntireColumn.Hidden = True
Worksheets("MasterData").Columns("AC:AI").EntireColumn.Hidden = True
Worksheets("MasterData").Columns("Q:R").EntireColumn.Hidden = True

'Put protection back
Worksheets("Forecast").Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
Worksheets("MasterData").Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
Worksheets("MD_Drop").Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True


Application.DisplayAlerts = True
Application.EnableEvents = True
Application.ScreenUpdating = True

End Sub
Attribute VB_Name = "Module8"
Sub SupplierInfoClick()
UserFormSupplierInfo.Show
End Sub
Sub Button5_Click()
UserFormQRSetup.Show
End Sub
Sub Sort_Forecast()


' Sorting forecast, putting follow up materials next to.
Application.DisplayAlerts = False
Application.ScreenUpdating = False

Worksheets("Forecast").Unprotect

' Change format of material code in Forecast Sheet into General
ActiveSheet.Range("B3:B1000").Select
    With Selection
        .NumberFormat = "General"
        .Value = .Value
    End With

   ' Range("A2:BG47").Select
   ' Range(Selection, Selection.End(xlDown)).Select
    ActiveWorkbook.Worksheets("Forecast").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("Forecast").Sort.SortFields.Add Key:=Range( _
        "BG3:BG1000"), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
        xlSortNormal
    With ActiveWorkbook.Worksheets("Forecast").Sort
        .SetRange Range("A2:BG1000")
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    Range("A2").Select
    
Worksheets("Forecast").Select
    
Worksheets("Forecast").Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
  
Call Button15_Click


Application.DisplayAlerts = True
Application.ScreenUpdating = True

End Sub
Sub Add_MD_Drop()
Attribute Add_MD_Drop.VB_ProcData.VB_Invoke_Func = " \n14"
'
' adding in downloaded Master data into MASTER DATA tab
'
Dim MDLastRow As Long
Dim RowDimention As Integer
Dim x As Long
Dim y As Long
Dim Answer As String
Dim MyNote As String
Dim CountRange As Long

 
Worksheets("MasterData").Unprotect
Worksheets("MD_Drop").Unprotect
  
'Application.DisplayAlerts = "Coping data to MasterData tab, please wait..."
Application.ScreenUpdating = False

y = Range("AE9").End(xlDown).Row
RowDimention = Application.WorksheetFunction.CountIfs(Range("AE8:AE" & y), "<>0", Range("AE8:AE" & y), "<>")

If RowDimention < 1 Then 'meaning no data to paste
    MsgBox "No data to copy!"
    Exit Sub
    Else
    
    MyNote = "Have you deleted all unnecessary contracts and checked annual volumes?"
 
    'Display MessageBox
    Answer = MsgBox(MyNote, vbQuestion + vbYesNo, "???")
 
    If Answer = vbNo Then
        'Code for No button Press
         Worksheets("MD_Drop").Activate
    Else


x = Worksheets("MasterData").Cells(Worksheets("MasterData").Rows.Count, "E").End(xlUp).Row


If Sheets("MasterData").Cells(2, 5).Value = "" Then
    MDLastRow = 2
    Else
    MDLastRow = Sheets("MasterData").Cells(1, 5).End(xlDown).Row + 1
End If

    Sheets("MD_Drop").Select
    Range("AH9:AL" & RowDimention).Select
    Selection.Copy
    Sheets("MasterData").Range("D" & MDLastRow).PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
    
    Sheets("MD_Drop").Select
    Range("AM9:AS" & RowDimention).Select
    Selection.Copy
    Sheets("MasterData").Range("I" & MDLastRow).PasteSpecial xlFormulas
    
    Sheets("MD_Drop").Select
    Range("BT9:BV" & RowDimention).Select
    Selection.Copy
    Sheets("MasterData").Range("AP" & MDLastRow).PasteSpecial xlFormulas
    
    Sheets("MD_Drop").Select
    Range("AT9:BS" & RowDimention).Select
    Selection.Copy
    Sheets("MasterData").Range("P" & MDLastRow).PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
    Sheets("MD_Drop").Select
    
    
    Range("A1").Select
    Worksheets("MasterData").Activate

'Sort data by Doc number to make the follow up material work propertly
    ActiveWorkbook.Worksheets("MasterData").ListObjects("TableMD").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("MasterData").ListObjects("TableMD").Sort.SortFields. _
        Add Key:=Range("TableMD[[#All],[Doc Date]]"), SortOn:=xlSortOnValues, _
        Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets("MasterData").ListObjects("TableMD").Sort
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
    Range("TableMD[[#Headers],[Plant]]").Select

Application.DisplayAlerts = False
Application.ScreenUpdating = True
    

    MsgBox "Copied"
    End If
    End If
    
Worksheets("MasterData").Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
        
Worksheets("MD_Drop").Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True

End Sub

Attribute VB_Name = "Module9"
Sub Button15_Click()

Dim i As Long
Dim Horizon As Long


Application.DisplayAlerts = False
Application.EnableEvents = False
Application.ScreenUpdating = False

Worksheets("Planning").Unprotect
Worksheets("PLANNING").Select

Worksheets("PLANNING").Range("K9", Worksheets("PLANNING").Range("K10").End(xlDown)).Select
Selection.AutoFilter


'Worksheets("Planning").Protect DrawingObjects:=False, contents:=False, Scenarios:=False _
'        , AllowFiltering:=False
Worksheets("planning").ListObjects(1).AutoFilter.ShowAllData

Application.StatusBar = "Please wait..."

i = ActiveWorkbook.Worksheets("Forecast").Range("b3", Worksheets("Forecast").Range("b2").End(xlDown)).Rows.Count
Horizon = ActiveWorkbook.Worksheets("SETUP").Cells(11, 2)



If i > 10000 Then
    MsgBox "Forecast missing!"
    Worksheets("Forecast").Activate
Else
    lastrow = i * 5 + 14
    'Delete if too many materials
    Worksheets("PLANNING").Rows(10 & ":" & Worksheets("PLANNING").Rows.Count).Clear
    
    'add if not enouogh materials in Planning sheet
    Worksheets("RowCopy").Range(Worksheets("RowCopy").Cells(3, 1), Worksheets("RowCopy").Cells(7, 11 + Horizon)).Copy
    
    Range("A10:A" & lastrow).Select
    ActiveSheet.Paste
    Range("A10").Select
        
    Worksheets("PLANNING").Range("K9", Worksheets("PLANNING").Range("K10").End(xlDown)).Select
    Selection.AutoFilter
    Range("A9").Select
    
End If
    
Worksheets("Planning").Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
  
      
Application.StatusBar = False

Application.DisplayAlerts = True
Application.EnableEvents = True
Application.ScreenUpdating = True



End Sub
Attribute VB_Name = "Sheet1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet3"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet31"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet4"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub CommandButton1_Click()
  

End Sub
Attribute VB_Name = "Sheet6"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet7"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub CommandButton1_Click()

End Sub
Attribute VB_Name = "Sheet8"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet9"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "ThisWorkbook"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True

Attribute VB_Name = "UserForm1"
Attribute VB_Base = "0{F47D5F3F-91C2-49DE-8213-72EC64EC2612}{597E3D63-5F25-4704-902C-138BE79665D5}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub Cancel_Click()
UserForm1.Hide
End Sub

Private Sub CommandButton1_Click()


Dim i As Integer
Dim SKUcount As Integer
Dim KPA_Session As Integer
Dim KPAExists As Boolean
Dim QRFile As String
Dim MDTemp As String
Dim FileExists As Boolean
FileExists = True
Dim MDFilePath As String
Dim TestStr As String
Dim n As Integer
Dim WK As String

Dim Vendor As String
Dim Plant As String
Dim Plant2 As String
Dim Plant3 As String
Dim Plant4 As String
Dim PlantMD As String
Dim PlantMD2 As String
Dim PlantMD3 As String
Dim PlantMD4 As String
Dim ScopeOfList As String
Dim ContractValidFrom As String
Dim ContractValidTo As String
Dim Material As String
Dim EEplant As String

Application.DisplayAlerts = False
Application.EnableEvents = False
Application.ScreenUpdating = False

'Set up variables
EEplant = Sheets("SETUP").Cells(13, 2).Value
Vendor = Sheets("setup").Cells(3, 2).Value
Plant = Sheets("SETUP").Cells(5, 2).Value
Plant2 = Sheets("SETUP").Cells(5, 3).Value
Plant3 = Sheets("SETUP").Cells(5, 4).Value
Plant4 = Sheets("SETUP").Cells(5, 5).Value
ScopeOfList = "ZRAHM"
ContractValidFrom = Sheets("MD_Drop").Cells(1, 3).Value
ContractValidTo = Sheets("MD_Drop").Cells(1, 5).Value
WK = Sheets("SETUP").Cells(2, 2).Value

Worksheets("Forecast").Unprotect
Worksheets("MasterData").Unprotect
Worksheets("MD_Drop").Unprotect
SKUcount = Worksheets("Forecast").Range("B:B").Cells.SpecialCells(xlCellTypeConstants).Count

QRFile = ActiveWorkbook.Name

UserForm1.Hide

'making sure that there is enough rows with formulas in columns AE:DS
Sheets("MD_Drop").Range("W10:DS10").Copy Sheets("MD_Drop").Range("W10:w500")

' IF EE Plant then no need to change ending to P1, just leave plant code as it is.
If EEplant = "YES" Then
    PlantMD = Sheets("SETUP").Cells(5, 2).Value
    Else
    PlantMD = Left(Sheets("SETUP").Cells(5, 2).Value, 2) & "P1"
    If Plant2 = "" Then
        PlantMD2 = ""
    Else
        PlantMD2 = Left(Sheets("SETUP").Cells(5, 3).Value, 2) & "P1"
        End If
        If Plant3 = "" Then
            PlantMD3 = ""
            Else
            PlantMD3 = Left(Sheets("SETUP").Cells(5, 4).Value, 2) & "P1"
        End If
        If Plant4 = "" Then
            PlantMD4 = ""
            Else
            PlantMD4 = Left(Sheets("SETUP").Cells(5, 5).Value, 2) & "P1"
        End If
End If

Sheets("MD_Drop").Range("a4:v1000").ClearContents

Dim strText() As String
Dim ii As Long
    Sheets("MD_Drop").Activate
    strText = Split(Material_List.Text, Chr(10))
    For ii = 0 To UBound(strText)
        Sheets("MD_Drop").Range("A" & (8 + ii)).Value = WorksheetFunction.Clean(strText(ii))
      
    Next ii
       

Sheets("MD_Drop").Activate
Range("a8:a508").Copy

' Check Master Data
If Vendor = "" Then
    Worksheets("SETUP").Activate
    MsgBox "Vendor Code is missing!"
    Exit Sub
End If

If Plant = "" Then
    Worksheets("SETUP").Activate
    MsgBox "Plant Code is missing!"
    Exit Sub
End If

If Range("C2") = "" And SKUcount <= 1 Then
    MsgBox "Forecast is missing... Download forecast first then Master Data!"
    Exit Sub
End If
    
On Error Resume Next

Application.StatusBar = "Running SAP Transaction, please wait..."


If Not IsObject(sapplication) Then
    Set SapGuiAuto = GetObject("SAPGUI")
    Set sapplication = SapGuiAuto.GetScriptingEngine
End If
    KPAExists = False
    
    For i = 0 To sapplication.Children.Count - 1
        If sapplication.Children(i + 0).Children(0).Info.SystemName = "KPA" Then
            KPA_Session = i
            KPAExists = True
        End If
       
    Next i

    If KPAExists = False Then
        MsgBox "Please log in to KPA!"
        Exit Sub
    End If
    
    If Not IsObject(Connection) Then
       Set Connection = sapplication.Children(KPA_Session + 0)
    End If
    If Not IsObject(session) Then
       Set session = Connection.Children(0)
    End If
    If IsObject(WScript) Then
       WScript.ConnectObject session, "on"
       WScript.ConnectObject sapplication, "on"
    End If
    
         On Error Resume Next
         
'Open the transaction in KPA
session.findById("wnd[0]").maximize
session.findById("wnd[0]/tbar[0]/okcd").Text = "/nME3M"
session.findById("wnd[0]").sendVKey 0
'session.findById("wnd[0]").sendVKey 0

session.findById("wnd[0]/usr/btn%_EM_MATNR_%_APP_%-VALU_PUSH").press
session.findById("wnd[1]/tbar[0]/btn[16]").press
session.findById("wnd[1]/tbar[0]/btn[24]").press
session.findById("wnd[1]/tbar[0]/btn[8]").press


session.findById("wnd[0]/usr/ctxtEM_EKORG-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtLISTU").Text = ""
session.findById("wnd[0]/usr/ctxtSELPA-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_BSART-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_EKGRP-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_PSTYP-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_PSTYP-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_KNTTP-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_KNTTP-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_EINDT-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_EINDT-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtP_GULDT").Text = ""
session.findById("wnd[0]/usr/ctxtP_RWEIT").Text = ""
'session.findById("wnd[0]/usr/ctxtS_EBELN-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_LIFNR-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_LIFNR-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_RESWK-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_RESWK-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_MATKL-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_MATKL-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_BEDAT-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_BEDAT-HIGH").Text = ""
session.findById("wnd[0]/usr/txtS_EAN11-LOW").Text = ""
session.findById("wnd[0]/usr/txtS_EAN11-HIGH").Text = ""
session.findById("wnd[0]/usr/txtS_IDNLF-LOW").Text = ""
session.findById("wnd[0]/usr/txtS_IDNLF-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_LTSNR-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_LTSNR-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_AKTNR-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_AKTNR-HIGH").Text = ""
session.findById("wnd[0]/usr/ctxtS_SAISO-LOW").Text = ""
session.findById("wnd[0]/usr/ctxtS_SAISO-HIGH").Text = ""
session.findById("wnd[0]/usr/txtS_SAISJ-LOW").Text = ""
session.findById("wnd[0]/usr/txtS_SAISJ-HIGH").Text = ""
session.findById("wnd[0]/usr/txtP_TXZ01").Text = ""
session.findById("wnd[0]/usr/txtP_NAME1").Text = ""
session.findById("wnd[0]/usr/ctxtS_STAPO-LOW").Text = ""

    On Error Resume Next

session.findById("wnd[0]/usr/ctxtLISTU").Text = "ZRAHM"
session.findById("wnd[0]/usr/ctxtS_EINDT-LOW").Text = ContractValidFrom
session.findById("wnd[0]/usr/ctxtS_EINDT-HIGH").Text = ContractValidTo
session.findById("wnd[0]/usr/ctxtS_LIFNR-LOW").Text = Vendor
session.findById("wnd[0]/usr/ctxtP_GULDT").SetFocus
session.findById("wnd[0]/usr/ctxtP_GULDT").caretPosition = 10

'session.findById("wnd[0]/usr/ctxtEM_WERKS-LOW").Text = PlantMD
session.findById("wnd[0]/usr/btn%_EM_WERKS_%_APP_%-VALU_PUSH").press
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,0]").Text = PlantMD
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,1]").Text = PlantMD2
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,2]").Text = PlantMD3
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,3]").Text = PlantMD4
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,3]").SetFocus
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,3]").caretPosition = 4
session.findById("wnd[1]/tbar[0]/btn[8]").press
session.findById("wnd[0]/tbar[1]/btn[8]").press

' set up /QRfile Layout
session.findById("wnd[0]/tbar[1]/btn[33]").press
session.findById("wnd[1]/usr/ssubD0500_SUBSCREEN:SAPLSLVC_DIALOG:0501/cntlG51_CONTAINER/shellcont/shell").currentCellRow = 49
'session.findById("wnd[1]/usr/ssubD0500_SUBSCREEN:SAPLSLVC_DIALOG:0501/cntlG51_CONTAINER/shellcont/shell").firstVisibleRow = 43
session.findById("wnd[1]/usr/ssubD0500_SUBSCREEN:SAPLSLVC_DIALOG:0501/cntlG51_CONTAINER/shellcont/shell").selectedRows = "49"
session.findById("wnd[1]/usr/ssubD0500_SUBSCREEN:SAPLSLVC_DIALOG:0501/cntlG51_CONTAINER/shellcont/shell").clickCurrentCell
session.findById("wnd[0]/tbar[1]/btn[8]").press

' filter contracts with quantity >1
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").setCurrentCell -1, "KTMNG"
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectColumn "KTMNG"
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").contextMenu
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectContextMenuItem "&FILTER"
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN001-LOW").Text = ""
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN002-LOW").Text = ""
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN003-LOW").Text = "2"
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN003-HIGH").Text = "9999999999"
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN003-HIGH").SetFocus
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN003-HIGH").caretPosition = 10
session.findById("wnd[1]/tbar[0]/btn[0]").press

'Filter out contract flaged to be deleted.
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").setCurrentCell -1, "LOEKZ"
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectColumn "LOEKZ"
session.findById("wnd[0]/tbar[1]/btn[29]").press
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/btn%_%%DYN003_%_APP_%-VALU_PUSH").press
session.findById("wnd[2]/usr/tabsTAB_STRIP/tabpNOSV").Select
session.findById("wnd[2]/usr/tabsTAB_STRIP/tabpNOSV/ssubSCREEN_HEADER:SAPLALDB:3030/tblSAPLALDBSINGLE_E/ctxtRSCSEL_255-SLOW_E[1,0]").Text = "s"
session.findById("wnd[2]/usr/tabsTAB_STRIP/tabpNOSV/ssubSCREEN_HEADER:SAPLALDB:3030/tblSAPLALDBSINGLE_E/ctxtRSCSEL_255-SLOW_E[1,0]").caretPosition = 1
session.findById("wnd[2]/tbar[0]/btn[8]").press

'Filter within valid dates and sort
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").setCurrentCell -1, "KDATE"
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectColumn "KDATE"
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectedRows = ""
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").contextMenu
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectContextMenuItem "&FILTER"
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN001-LOW").Text = ContractValidFrom
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN001-HIGH").Text = ContractValidTo
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN001-HIGH").SetFocus
session.findById("wnd[1]/usr/ssub%_SUBSCREEN_FREESEL:SAPLSSEL:1105/ctxt%%DYN001-HIGH").caretPosition = 10
session.findById("wnd[1]/tbar[0]/btn[0]").press
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").setCurrentCell -1, "EMATN"
session.findById("wnd[0]/usr/cntlGRID1/shellcont/shell").selectColumn "EMATN"
session.findById("wnd[0]/tbar[1]/btn[28]").press

' download to excel
session.findById("wnd[0]/tbar[1]/btn[45]").press
session.findById("wnd[1]/usr/subSUBSCREEN_STEPLOOP:SAPLSPO5:0150/sub:SAPLSPO5:0150/radSPOPLI-SELFLAG[1,0]").Select
session.findById("wnd[1]/usr/subSUBSCREEN_STEPLOOP:SAPLSPO5:0150/sub:SAPLSPO5:0150/radSPOPLI-SELFLAG[1,0]").SetFocus
session.findById("wnd[1]/tbar[0]/btn[0]").press

Application.StatusBar = "Downloading Master Data, please wait..."

MDTemp = Vendor & "_MD_" & WK & ".xls"
MDFilePath = Application.ActiveWorkbook.Path & "\MasterData\" & MDTemp

session.findById("wnd[1]/usr/ctxtDY_PATH").Text = Application.ActiveWorkbook.Path & "\MasterData\"
session.findById("wnd[1]/usr/ctxtDY_FILENAME").Text = MDTemp
session.findById("wnd[1]/usr/ctxtDY_FILENAME").caretPosition = 10
session.findById("wnd[1]/tbar[0]/btn[11]").press

Application.StatusBar = "Copying Data, please wait..."


'Copying data into the file
Dim xlApp As Application
Dim xlBook As Workbook
Dim Sh As Object

 Set xlApp = CreateObject("Excel.Application")
 Set xlBook = xlApp.Workbooks.Open(MDFilePath)
 xlBook.Sheets(1).Range("a1:Bf1000").Copy
 xlApp.DisplayAlerts = False
 xlBook.Close
 xlApp.Quit
 Set xlBook = Nothing
 Set xlApp = Nothing
 Set xlBook = ActiveWorkbook
 Set Sh = xlBook.Sheets("MD_Drop")
 Sh.Activate
 Range("a4").Select
 Sh.Paste
 Range("A1").Select

Dim Comm As String

Application.StatusBar = "All done! You have " & Worksheets("MD_Drop").Range("H3").Value & " duplicated contracts!"

'display end comment
If Worksheets("MD_Drop").Range("H3").Value > 0 Then
    MsgBox " You have " & Worksheets("MD_Drop").Range("H3").Value & " duplicated contracts!"
    Else
    MsgBox "Done. Please verify Annual Volumes before copying data into MasterData tab!"
End If

'Hide not-needed columns
Worksheets("MD_Drop").Columns("N:N").EntireColumn.Hidden = True
Worksheets("MD_Drop").Columns("AU:AU").EntireColumn.Hidden = True
Worksheets("MasterData").Columns("AC:AI").EntireColumn.Hidden = True
Worksheets("MasterData").Columns("Q:R").EntireColumn.Hidden = True

'Put protection back
Worksheets("Forecast").Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
Worksheets("MasterData").Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True
Worksheets("MD_Drop").Protect DrawingObjects:=False, Contents:=True, Scenarios:=True _
        , AllowFiltering:=True

Application.DisplayAlerts = True
Application.EnableEvents = True
Application.ScreenUpdating = True

End Sub

Private Sub CommandButton2_Click()
Material_List.Text = ""


End Sub

Private Sub Material_List_Change()

End Sub
Attribute VB_Name = "UserFormQRSetup"
Attribute VB_Base = "0{D56DD04E-1A2E-47C5-B6F9-481806001314}{4E9630F7-BB66-4CE1-B956-EDE549C2EB15}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub UserForm_Click()

End Sub
Attribute VB_Name = "UserFormSupplierInfo"
Attribute VB_Base = "0{6A3A7891-695C-4502-A4FD-C13900D37D50}{0CC259D4-6AE7-4147-BE22-63DBA60459A7}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub CommandButton1_Click()
UserFormSupplierInfo.Hide
End Sub

Private Sub Image1_BeforeDragOver(ByVal Cancel As MSForms.ReturnBoolean, ByVal Data As MSForms.DataObject, ByVal x As Single, ByVal y As Single, ByVal DragState As MSForms.fmDragState, ByVal Effect As MSForms.ReturnEffect, ByVal Shift As Integer)

End Sub


INQUEST-PP=macro
