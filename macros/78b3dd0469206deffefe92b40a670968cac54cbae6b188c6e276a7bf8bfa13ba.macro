Attribute VB_Name = "Activat"
Attribute VB_Base = "0{CC2C34D3-714C-4E8F-BD97-6744D371D2DE}{1A4B6596-2396-4243-B67A-6FC219448D53}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False


Private Sub CommandButton1_Click()
Call unp("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(1, 2).Value = Sheets("|fffd||fffd||fffd||fffd||fffd|").Cells(ComboBox1.ListIndex + 2, 2).Value
Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(2, 2).Value = ComboBox1.Value
Activat.Hide
ThisWorkbook.Save

oshi = Now() & ", |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & " ,  mun = " & Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(2, 2).Value
            Open ThisWorkbook.path & "\log.txt" For Append As #1
            Print #1, oshi
            Close #1
          
      


StartF.Show

End Sub
Attribute VB_Name = "Based"
Sub unp(Optional ByVal wsName As String = "")
pass = "680011"
If wsName = "" Then wsName = ActiveSheet.Name
Sheets(wsName).Unprotect pass
End Sub
Sub pr()
pass = "680011"
ActiveSheet.Protect pass
End Sub
Sub nazad()
'Call unp
Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
StartF.Label1.Caption = Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(2, 2).Value
StartF.ComboBox2.RowSource = "= |fffd||fffd||fffd||fffd||fffd|! D2:D" & Sheets("|fffd||fffd||fffd||fffd||fffd|").Cells(1, 4).Value + 2
StartF.Show
End Sub

Sub xButton()
Call unp
Call closeALL
Application.ScreenUpdating = False
If Range("I11").Value <> "" Then
    Call proverka(9)
    If Range("I11").Value <> "" Then
     MsgBox "|fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
     Exit Sub
    End If
End If
    Call clearlist
    Call generatSpisok
    Call proverka
    If Range("I11").Value = "" Then
     MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
    End If
Call pr

oshi = Now() & ", |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & " ,  TOTALFILES : " & Cells(1, 3).Value & "  ERRORFILES : " & Cells(9, 8).Value
            Open ThisWorkbook.path & "\log.txt" For Append As #1
            Print #1, oshi
            Close #1
            
         


End Sub



Sub generatSpisok()
Dim numb As Long
Dim i As Integer
Dim putk, putsoz As String
Dim dirplace As String
 numb = ActiveSheet.Index
 dirplace = Sheets(1).Cells(1, 1).Value
 If dirplace = "" Then
 MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
 Exit Sub
 End If
Call |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(dirplace, ".xls*", 7)
'Intersect(Rows("A:E"), ActiveSheet.UsedRange).ClearContents
End Sub


Sub |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|$, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|$, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|%)
      ' |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|,
    ' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.

    Dim coll As Collection

    If |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|% = 0 Then |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|% = 999    ' |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|

    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| coll |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Set coll = FilenamesCollection(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|$, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|$, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|%)

    Application.ScreenUpdating = False    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|

    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|) |fffd||fffd| |fffd||fffd||fffd||fffd|
    For i = 1 To coll.Count    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|

        |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| = i
        |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| = coll(i)
        |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| = Dir(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
        |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| = FileDateTime(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
        |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| = FileLen(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)

        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
        If uniq("C", |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|) And notTEMP(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|) Then
        Range("a" & Rows.Count).End(xlUp).Offset(1).Resize(, 5).Value = _
        Array(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
        End If
        ' |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
       ' ActiveSheet.Hyperlinks.Add Range("b" & Rows.Count).End(xlUp), |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, "", _
       '                            "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|" & vbNewLine & |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|

        DoEvents    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|
    Next
End Sub

Function FilenamesCollection(ByVal FolderPath As String, Optional ByVal Mask As String = "", _
                             Optional ByVal SearchDeep As Long = 999) As Collection
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| FolderPath,
    ' |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| Mask (|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)
    ' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| SearchDeep |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd| SearchDeep=1, |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|).
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    ' (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| GetAllFileNamesUsingFSO)

    Set FilenamesCollection = New Collection    ' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set FSO = CreateObject("Scripting.FileSystemObject")    ' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| FileSystemObject
    GetAllFileNamesUsingFSO FolderPath, Mask, FSO, FilenamesCollection, SearchDeep    ' |fffd||fffd||fffd||fffd||fffd|
    Set FSO = Nothing: Application.StatusBar = False    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Excel
End Function

Function GetAllFileNamesUsingFSO(ByVal FolderPath As String, ByVal Mask As String, ByRef FSO, _
                                 ByRef FileNamesColl As Collection, ByVal SearchDeep As Long)
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| FolderPath, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| FSO
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| SearchDeep > 1
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| FileNamesColl
    On Error Resume Next: Set curfold = FSO.GetFolder(FolderPath)
    If Not curfold Is Nothing Then    ' |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|

        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        ' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Excel
        Application.StatusBar = "|fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|: " & FolderPath

        For Each fil In curfold.Files    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| FolderPath
            If fil.Name Like "*" & Mask Then FileNamesColl.Add fil.path
        Next
        SearchDeep = SearchDeep - 1    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        If SearchDeep Then    ' |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
            For Each sfol In curfold.SubFolders    ' ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| FolderPath
                GetAllFileNamesUsingFSO sfol.path, Mask, FSO, FileNamesColl, SearchDeep
            Next
        End If
        Set fil = Nothing: Set curfold = Nothing    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    End If
End Function

Function uniq(st As String, chto) As Boolean
i = 11
Do While Range(st & i).Value <> ""
    If Range(st & i).Value = chto Then
    uniq = False
    Exit Function
    End If

i = i + 1
Loop
uniq = True
End Function
Function notTEMP(ByVal putk As String) As Boolean
If InStrRev(putk, "~") > 0 Then
notTEMP = False
Else
notTEMP = True
End If
End Function


Sub clearlist()
ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range("A11:L2000").ClearContents
End Sub

Sub proverka(Optional st As Integer = 3)
Dim Wb As Workbook
Dim Sh As Worksheet
Dim i, s As Integer
Dim oshTr, oshN, oshSum, oshIsl, oshLev As Boolean
Dim osh, kd, KodP, KodSc, Cl, KodCl, nameB, nameD, kIsl As String
Set Sh = ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Sh.Activate
s = 0
kIsl = CStr(Cells(3, 2).Value)
On Error GoTo er
For i = 11 To Cells(1, st).Value + 10 Step 1
    Workbooks.Open(Cells(i, st).Value, UpdateLinks:=0).Sheets(1).Activate
    nameB = ActiveWorkbook.Name
    If SheetExists("|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|") = False Then
        ActiveWorkbook.Close
        oshLev = True
        GoTo levak
    Else
        oshLev = False
    End If
    Worksheets("|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|").Activate
    kd = CStr(Cells(1, 1).Value)
    Cl = Mid(kd, 5, 2)  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    KodP = Right(kd, 2) '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    KodSc = CStr(Cells(1, 7).Value)
    KodCl = CStr(Cells(1, 9).Value)
    If Len(KodCl) = 3 Then KodCl = "0" & KodCl
    
    nameD = KodP & "_" & KodSc & "_" & KodCl & rash(nameB)
    If nameB <> nameD Then
        oshN = True
    Else
        oshN = False
    End If
    
    If kIsl <> kd Then
        oshIsl = True
    Else
        oshIsl = False
    End If
    
    If Cells(5, 1).Value > 0 Then
        osh = CStr(Cells(5, 1).Value)
        ActiveWorkbook.Close savechanges:=False
        oshTr = True
    Else
        ActiveWorkbook.Close savechanges:=False
        oshTr = False
    End If
levak:
    If oshLev = False Then
    oshSum = oshTr Or oshN Or oshIsl Or oshLev
    Else
    oshSum = True
    End If
    Sh.Activate
   
    If oshSum Then
        s = s + 1
        ns = s + 10
        Range("I" & ns).Value = Cells(i, st).Value
        Range("H" & ns).Value = Cells(i, st - 1).Value
        ActiveSheet.Hyperlinks.Add Anchor:=Range("H" & ns), _
                                   Address:=Range("I" & ns).Value, _
                                   TextToDisplay:=Range("H" & ns).Value
        If oshIsl Then
            Range("J" & ns).Value = "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & kd & " . |fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & kIsl
        End If
        
        If oshTr Then
            Range("K" & ns).Value = osh
            Range("J" & ns).Value = Range("J" & ns).Value & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|. "
        End If
        
        If oshN Then
            Range("J" & ns).Value = Range("J" & ns).Value & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|. "
            Range("L" & ns).Value = nameD
        End If
        If oshLev Then
        Range("J" & ns).Value = Range("J" & ns).Value & "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|."
        End If
        
    End If
    
    
Next i

Range("H" & s + 11 & ": L2000").ClearContents ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
If Range("H9").Value <> 0 Then Call bord("H11:K" & s + 10)
GoTo ends


er:
            oshi = Now() & ", |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| " & " ,  " & Error & "  " & Err.Number
            Open ThisWorkbook.path & "\log.txt" For Append As #1
            Print #1, oshi
            Close #1
            Call closeALL
            MsgBox "|fffd||fffd||fffd|-|fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"

ends:
End Sub


Sub Rename_File()
    Dim sFileName As String, sNewFileName, rekName, WrName As String
    On Error GoTo 1:
    Call unp
    poz = Selection.Row
    sFileName = Range("I" & poz).Value
    stName = Range("H" & poz).Value
    rekName = Range("L" & poz).Value
    WrName = InputBox("|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|: ", "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", rekName)
    
    sNewFileName = predok(sFileName) & WrName   '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    If Dir(sFileName, 16) = "" Then MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", vbCritical, "|fffd||fffd||fffd||fffd||fffd||fffd|": Exit Sub
 
    Name sFileName As sNewFileName '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
    
    Range("I" & poz).Value = sNewFileName
    Range("H" & poz).Value = WrName
    ActiveSheet.Hyperlinks.Add Anchor:=Range("H" & poz), _
                                   Address:=Range("I" & poz).Value, _
                                   TextToDisplay:=Range("H" & poz).Value
                                   
    MsgBox "|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", vbInformation, "|fffd||fffd||fffd||fffd||fffd|"
    GoTo ends:
1:
            oshi = Now() & ", |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| " & " ,  " & Error & "  " & Err.Number
            Open ThisWorkbook.path & "\log.txt" For Append As #1
            Print #1, oshi
            Close #1
            
            If Err.Number = 75 Then
                Call MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|.  |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|.", vbCritical, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.")
            Else
                Call MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|.", vbCritical, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.")
            End If

ends:
Call pr
End Sub

Function predok(ByVal str As String)
    If Right(str, 1) = "\" Then
        str = Left(str, Len(str) - 1)
    End If
    pz = InStrRev(str, "\")
    predok = Left(str, pz)
End Function

Sub listb()
lrlb = Cells(1, 9).Value + 1
UserForm1.ListBox1.RowSource = "=J2:J" & lrlb
UserForm1.Show
End Sub

Function IsBookOpen(ByVal wbName As String) As Boolean
    Dim wbBook As Workbook: On Error Resume Next
    Set wbBook = Workbooks(wbName)
    IsBookOpen = Not wbBook Is Nothing
End Function

 Function pravaya(str As String) As String
 a = InStrRev(str, "\")
 pravaya = Right(str, Len(str) - a)
 End Function
 
 Sub papka()
 Dim stpath, puti As String
 On Error GoTo 1
 Call unp
 Application.ScreenUpdating = True
 stpath = Range("J3").Value
 If Range("J3").Value = "" Then
    puti = ThisWorkbook.path
 Else
    puti = predok(Range("J3").Value)
 End If
 
 Range("J3").Value = GetFolderPath("|fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|", puti)
 ActiveSheet.Hyperlinks.Add Anchor:=Range("J3"), _
                                   Address:=Range("J3").Value, _
                                   TextToDisplay:=Range("J3").Value
 Cells(1, 1).Value = Range("J3").Value
 
 GoTo ends
1:
   Range("J3").Value = stpath
 
ends:
Call pr
 End Sub
 Function rash(ByVal str As String) As String
 rash = Mid(str, InStrRev(str, "."))
 End Function
 
 Function GetFolderPath(Optional ByVal Title As String = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", _
                       Optional ByVal InitialPath As String = "c:\") As String
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Title,
   ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| InitialPath
   ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
   Dim PS As String: PS = Application.PathSeparator
    With Application.FileDialog(msoFileDialogFolderPicker)
        If Not Right$(InitialPath, 1) = PS Then InitialPath = InitialPath & PS
        .ButtonName = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|": .Title = Title: .InitialFileName = InitialPath
        If .Show <> -1 Then Exit Function
        GetFolderPath = .SelectedItems(1)
        If Not Right$(GetFolderPath, 1) = PS Then GetFolderPath = GetFolderPath & PS
    End With
End Function

Sub ExportF()
    Dim sFileName As String, sNewFileName As String
    Dim i As Integer
    
    If Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Range("H9").Value > 0 Then
        MsgBox ("|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|")
        Exit Sub
    End If
    
    If CInt(Range("k8").Value) <> Range("c1").Value Then
        If MsgBox("|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & Cells(3, 2).Value & " |fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & (Range("k8").Value) & " |fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & Range("c1").Value & " .|fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|?", vbYesNo, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|") = vbNo Then
        Exit Sub
        End If
        
        
    End If
    i = 11
    putk = ThisWorkbook.path & "\export\" & Range("b3").Value & "\"
    If FolderExists(putk) = False Then
        MkDir (putk)
    End If
    Do While Range("C" & i).Value <> ""
         sFileName = Range("C" & i).Value
         sNewFileName = putk & pravaya(Range("C" & i).Value)
         FileCopy sFileName, sNewFileName
         i = i + 1
    Loop
    sFileName = ThisWorkbook.path & "\log.txt"
    sNewFileName = putk & "\log.txt"
    FileCopy sFileName, sNewFileName
    
    arch_n = CStr(Cells(1, 2).Value) & "_" & CStr(Cells(3, 2).Value)
    DeleteFile (predok(putk) & arch_n & ".zip")
    
    If zip7(putk, arch_n & ".zip") = False Then
        MsgBox "|fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 7-zip |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|."
        Exit Sub
    End If
    
    'Call Zip_All(putk, arch_n)
    Call DelDir(putk)
    Call openDir(predok(putk))
    
    
    oshi = Now() & ", |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| " & " ,  TOTALFILES : " & Cells(1, 3).Value & "  ERRORFILES : " & Cells(9, 8).Value
            Open ThisWorkbook.path & "\log.txt" For Append As #1
            Print #1, oshi
            Close #1
    
End Sub


Sub CreateNewZip(sPath As String)
    If Dir(sPath) <> "" Then Kill sPath
    Open sPath For Output As #1
    Print #1, Chr$(80) & Chr$(75) & Chr$(5) & Chr$(6) & String(18, 0)
    Close #1
End Sub

Function zip7(ByVal FolderName As String, ByVal arch_n As String) As Boolean
Dim dir7z As String
Dim wsh As Object
Set wsh = VBA.CreateObject("WScript.Shell")
Dim waitOnReturn As Boolean: waitOnReturn = True
Dim windowStyle As Integer: windowStyle = 1
zip7 = True
If FolderExists("C:\Program Files\7-Zip\") Then
    dir7z = b & "C:\Program Files\7-Zip\" & "7z.exe" & b
Else
        If FolderExists("C:\Program Files (x86)\7-Zip\") Then
            dir7z = b & "C:\Program Files (x86)\7-Zip\" & "7z.exe" & b
        Else
            zip7 = False
            Exit Function
        End If
End If

wsh.Run "cmd.exe /C " & b & dir7z & " a " & b & predok(FolderName) & arch_n & b & " " & b & FolderName & "*" & b & b, windowStyle, waitOnReturn


End Function


Sub Zip_All(ByVal FolderName As String, ByVal arch_n As String)
    Dim oFolder As Object
    Dim sDate As String, sZIPPath As String, sZIPFileName As String
    Dim objShell As Object
 
    sZIPPath = predok(FolderName)
    If Right(sZIPPath, 1) <> "\" Then
        sZIPPath = sZIPPath & "\"
    End If
    
    sZIPFileName = sZIPPath & arch_n & ".zip"
 
    Set objShell = CreateObject("Shell.Application")
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    
        sFolderName = FolderName
    
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| ZIP-|fffd||fffd||fffd||fffd||fffd|
    CreateNewZip (sZIPFileName)
    If Right(sFolderName, 1) <> "\" Then
        sFolderName = sFolderName & "\"
    End If
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|
    objShell.Namespace((sZIPFileName)).CopyHere objShell.Namespace((sFolderName)).Items
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    On Error Resume Next
    Do Until objShell.Namespace((sZIPFileName)).Items.Count = objShell.Namespace((sFolderName)).Items.Count
        DoEvents
    Loop
    MsgBox "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|: " & sZIPFileName, vbInformation, "|fffd||fffd||fffd||fffd||fffd|"
End Sub
Function FolderExists(ByVal path As String) As Boolean
On Error Resume Next
FolderExists = GetAttr(path)
End Function

Function FileExists(ByVal FileToTest As String) As Boolean
   FileExists = (Dir(FileToTest) <> "")
End Function

Sub DeleteFile(ByVal FileToDelete As String)
   If FileExists(FileToDelete) Then 'See above
      SetAttr FileToDelete, vbNormal
      Kill FileToDelete
   End If
End Sub
Sub openDir(ByVal ifolder As String)
On Error Resume Next
Set oShell = CreateObject("Wscript.Shell")
   oShell.Run "explorer /e, " & (ifolder)
End Sub

Sub bord(ByVal aran As String)
Range(aran).Select
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    With Selection.Borders(xlEdgeLeft)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeTop)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeBottom)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlEdgeRight)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideVertical)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
    With Selection.Borders(xlInsideHorizontal)
        .LineStyle = xlContinuous
        .ColorIndex = 0
        .TintAndShade = 0
        .Weight = xlThin
    End With
End Sub

Sub DelDir(ByVal sPathToRemove As String)
Shell "cmd /c rd /S/Q """ & sPathToRemove & """"
End Sub

Sub closeALL()
Dim wrb As Workbook
For Each wrb In Workbooks
     If Not wrb Is ThisWorkbook Then If wrb.Windows(1).Visible Then wrb.Close
Next
End Sub

Function SheetExists(SheetName As String) As Boolean
        Dim obj As Object
        On Error GoTo errorHandler:
        Set obj = Sheets(SheetName)
        SheetExists = True
        Exit Function
errorHandler:
        SheetExists = False
End Function

Sub sbros()
Call unp("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Range("A1:b4").Value = ""
Range("A11:E500").Value = ""
Range("J3").Value = ""
Call pr
Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
Sheets("|fffd||fffd||fffd||fffd|").Visible = False
Sheets("|fffd||fffd||fffd||fffd||fffd|").Visible = False

End Sub
Function b()
    b = Chr(34)
End Function
Attribute VB_Name = "FTPcommander"
Attribute VB_Base = "0{FCFB3D2A-A0FA-1068-A738-08002B3371B5}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
'---------------------------------------------------------------------------------------
' Class Module      : FTPcommander
' |fffd||fffd||fffd||fffd||fffd|     : EducatedFool  (|fffd||fffd||fffd||fffd||fffd|)                    |fffd||fffd||fffd||fffd|: 03.12.2011
' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| Excel, Word, CorelDRAW. |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.
' http://ExcelVBA.ru/          ICQ: 5836318           Skype: ExcelVBA.ru
' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|: http://ExcelVBA.ru/payments
'---------------------------------------------------------------------------------------
' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| FTP.exe |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|:
' http://computers.deria.ru/article/~pr/sprav/166/282/
'---------------------------------------------------------------------------------------
Option Compare Text

Public Login As String
Public Password As String
Public Host As String
Public BaseFolder As String
Public BaseURL As String

Dim ErrorStr As String, ErrorStatusCode As String

Function GetLastError(Optional ByVal StatusTextOnly As Boolean = False) As String
    GetLastError = ErrorStr: If StatusTextOnly Then GetLastError = ErrorStatusCode
End Function
Sub ClearErrors(): ErrorStr = "": ErrorStatusCode = "": End Sub

Private Sub Class_Initialize()
    ' |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Me.Host = GetSetting(Application.Name, "FTP", "Host", "")
    Me.Login = GetSetting(Application.Name, "FTP", "Login", "")
    Me.Password = GetSetting(Application.Name, "FTP", "Password", "")
    Me.BaseFolder = GetSetting(Application.Name, "FTP", "BaseFolder", "")
    Me.BaseURL = GetSetting(Application.Name, "FTP", "BaseURL", "")
End Sub


Function DownloadFile(ByVal FtpFolder$, ByVal FtpFilename$, ByVal LocalPath$) As Boolean
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| FTP-|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| FtpFilename$ |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| FtpFolder$
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|) LocalPath$
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| TRUE, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Folder$ = Replace(BaseFolder & FtpFolder$, "//", "/")
    If Right(Folder$, 1) <> "/" Then Folder$ = Folder$ & "/"

    ShortFilename$ = Mid(LocalPath$, InStrRev(LocalPath$, "\") + 1)
    If ShortFilename$ <> Replace_symbols(ShortFilename$) Then
        ErrorStr = "Wrong symbols in filename: " & ShortFilename$
        Exit Function
    End If

    On Error Resume Next: Kill LocalPath$

    TXT_GET$ = "user " & Login & " " & Password & vbNewLine
    TXT_GET$ = TXT_GET$ & "bin" & vbNewLine
    TXT_GET$ = TXT_GET$ & "get """ & Folder$ & FtpFilename$ & """ """ & LocalPath$ & """" & vbNewLine
    TXT_GET$ = TXT_GET$ & "close" & vbNewLine & "bye" & vbNewLine

    res$ = Execute(TXT_GET$)

    If res$ Like "*Can't open *: No such file or directory*" Then
        ErrorStr = "Can't open |fffd|" & FtpFilename$ & "|fffd|: No such file or directory":
        Kill LocalPath$    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        Exit Function
    End If
    'If res$ Like "*Prohibited file name:*" Then ErrorStr = "Prohibited file name: " & Folder$: Exit Function

    If res$ Like "*File successfully transferred*" Then
        DownloadFile = Dir(LocalPath$, vbNormal) <> ""
    End If

End Function

Function UploadFile(ByVal LocalPath$, Optional ByVal FtpFolder$, Optional ByVal FtpFilename$ = "") As String
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| LocalPath$ |fffd||fffd| FTP |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| FtpFolder$
    ' |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| FtpFilename$, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| FtpFilename$
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Folder$ = Replace(BaseFolder & FtpFolder$, "//", "/")
    If Right(Folder$, 1) <> "/" Then Folder$ = Folder$ & "/"
    LocalFilename$ = Dir(LocalPath$, vbNormal)
    If LocalFilename$ = "" Then ErrorStr = "|fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|: " & LocalPath$: Exit Function
    If FtpFilename$ = "" Then FtpFilename$ = Dir(LocalPath$)

    TXT_PUT$ = "user " & Login & " " & Password & vbNewLine
    'TXT_PUT$ = TXT_PUT$ & "cd " & Folder$ & vbNewLine
    TXT_PUT$ = TXT_PUT$ & "bin" & vbNewLine
    TXT_PUT$ = TXT_PUT$ & "put """ & LocalPath$ & """ """ & Folder$ & FtpFilename$ & """" & vbNewLine
    TXT_PUT$ = TXT_PUT$ & "close" & vbNewLine & "bye" & vbNewLine

    res$ = Execute(TXT_PUT$)
    If res$ Like "*No such file or directory*" Then ErrorStr = "No such file or directory: " & Folder$: Exit Function
    If res$ Like "*Prohibited file name:*" Then ErrorStr = "Prohibited file name: " & Folder$: Exit Function

    If res$ Like "*File successfully transferred*" Then
        UploadFile = Replace(Folder$, BaseFolder, BaseURL) & IIf(Len(FtpFilename$), FtpFilename$, LocalFilename$)
    End If
End Function

Function CreateNewFolder(ByVal FtpFolder$) As Boolean
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| FtpFolder$ |fffd||fffd| FTP |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| TRUE, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    Folder$ = Replace(BaseFolder & FtpFolder$, "//", "/")
    If Right(Folder$, 1) <> "/" Then Folder$ = Folder$ & "/"

    TXT_MKDIR$ = "user " & Login & " " & Password & vbNewLine
    TXT_MKDIR$ = TXT_MKDIR$ & "mkdir """ & Folder$ & """" & vbNewLine
    TXT_MKDIR$ = TXT_MKDIR$ & "close" & vbNewLine & "bye" & vbNewLine

    res$ = Execute(TXT_MKDIR$)
    If res$ Like "*No such file or directory*" Then ErrorStr = "No such file or directory: " & Folder$: Exit Function
    If res$ Like "*Prohibited directory name:*" Then ErrorStr = "Prohibited directory name: " & Folder$: Exit Function

    If res$ Like "*Can't create directory: File exists*" Then ErrorStr = "Can't create directory: File exists" & Folder$
    CreateNewFolder = True
End Function

Function DeleteFile(ByVal FtpFolder$, ByVal FtpFilename$) As Boolean
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| FtpFolder$ |fffd||fffd| FTP |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| TRUE, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|

    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| :)
End Function


Function DownloadFileFromURL(ByVal URL$, ByVal LocalPath$) As Boolean
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| URL$, |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| LocalPath$
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| TRUE, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    On Error Resume Next: Kill LocalPath$

    ShortFilename$ = Mid(LocalPath$, InStrRev(LocalPath$, "\") + 1)
    If ShortFilename$ <> Replace_symbols(ShortFilename$) Then
        ErrorStr = "Wrong symbols in filename: " & ShortFilename$
        Exit Function
    End If

    URL$ = Replace(URL$, "\", "/")
    Set XMLHTTP = CreateObject("Microsoft.XMLHTTP")
    XMLHTTP.Open "GET", URL, "False"
    ' |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    XMLHTTP.setRequestHeader "If-Modified-Since", "Sat, 1 Jan 2000 00:00:00 GMT"
    XMLHTTP.send
    If XMLHTTP.statustext = "OK" Then
        Set ADOStream = CreateObject("ADODB.Stream")
        ADOStream.Type = 1: ADOStream.Open
        ADOStream.Write XMLHTTP.responseBody

        ADOStream.SaveToFile LocalPath$, 2
        ADOStream.Close: Set ADOStream = Nothing
        DownloadFileFromURL = Dir(LocalPath$, vbNormal) <> ""
        ErrorStr = "File downloaded successfully, file size: " & FileLen(LocalPath$) & " bytes"
    Else
        ErrorStr = "Can't download file: " & XMLHTTP.statustext & vbNewLine & _
                   "URL: " & URL$ & vbNewLine & "Local Path: " & LocalPath$
    End If
    ErrorStatusCode = XMLHTTP.Status
    Set XMLHTTP = Nothing
End Function



Private Function Execute(ByVal command$) As String
    On Error Resume Next: Kill LOG_FILE_PATH$
    SaveTXTfile COMMANDS_PATH$, command$
    command$ = "cmd /c ftp -n -i -g -s:""" & COMMANDS_PATH$ & """ " & Host & " >> """ & LOG_FILE_PATH$ & """"
    res = CreateObject("wscript.Shell").Run(command$, 0, True)
    ChangeFileCharset LOG_FILE_PATH$, "Windows-1251", "CP866"
    Execute = ReadTXTfile(LOG_FILE_PATH$)
    Kill COMMANDS_PATH$
End Function


' =============================================================================================
Private Function COMMANDS_PATH$(): COMMANDS_PATH$ = Environ("temp") & "\FTP_commands.txt": End Function
Private Function LOG_FILE_PATH$(): LOG_FILE_PATH$ = Environ("temp") & "\FTP_log.txt": End Function
Private Function FILESLIST_PATH$(): FILESLIST_PATH$ = Environ("temp") & "\FTP_files.txt": End Function

Function ReadTXTfile(ByVal FileName As String) As String
    Set FSO = CreateObject("scripting.filesystemobject")
    Set ts = FSO.OpenTextFile(FileName, 1, True): ReadTXTfile = ts.ReadAll: ts.Close
    Set ts = Nothing: Set FSO = Nothing
End Function

Function SaveTXTfile(ByVal FileName As String, ByVal txt As String) As Boolean
    On Error Resume Next: Err.Clear
    Set FSO = CreateObject("scripting.filesystemobject")
    Set ts = FSO.CreateTextFile(FileName, True)
    ts.Write txt: ts.Close
    SaveTXTfile = Err = 0
    Set ts = Nothing: Set FSO = Nothing
End Function

Function ChangeFileCharset(ByVal FileName$, ByVal DestCharset$, _
                           Optional ByVal SourceCharset$) As Boolean
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
    ' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| filename$ |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|,
    ' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| DestCharset$ (|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|)
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| TRUE, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    On Error Resume Next: Err.Clear
    With CreateObject("ADODB.Stream")
        .Type = 2
        If Len(SourceCharset$) Then .Charset = SourceCharset$    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        .Open
        .LoadFromFile FileName$    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
        FileContent$ = .ReadText   ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| FileContent$
        .Close
        .Charset = DestCharset$    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        .Open
        .WriteText FileContent$
        .SaveToFile FileName$, 2   ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        .Close
    End With
    ChangeFileCharset = Err = 0
End Function

Function ChangeTextCharset(ByVal txt$, ByVal DestCharset$, _
                           Optional ByVal SourceCharset$) As String
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    ' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| txt$,
    ' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| DestCharset$ (|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|)
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    On Error Resume Next: Err.Clear
    With CreateObject("ADODB.Stream")
        .Type = 2: .Mode = 3
        If Len(SourceCharset$) Then .Charset = SourceCharset$    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        .Open
        .WriteText txt$
        .Position = 0
        .Charset = DestCharset$    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        ChangeTextCharset = .ReadText
        .Close
    End With
End Function

Function Replace_symbols(ByVal txt As String) As String
    st$ = "~!@/\#$%^&*=|`"""
    For i% = 1 To Len(st$)
        txt = Replace(txt, Mid(st$, i, 1), "_")
    Next
    Replace_symbols = txt
End Function

Function TMPfolder$(): TMPfolder$ = Environ("TEMP") & "\": End Function

Attribute VB_Name = "StartF"
Attribute VB_Base = "0{DEED578F-79A4-467A-88B2-776A6A0F12B1}{8C9744D6-7E78-48CA-81F3-F5650A8F51FC}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub ComboBox1_Change()
Call unp
 Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(1, 2).Value = Sheets("|fffd||fffd||fffd||fffd||fffd|").Cells(ComboBox1.ListIndex + 1, 2).Value
Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(2, 2).Value = ComboBox1.Value
ComboBox2.RowSource = "= |fffd||fffd||fffd||fffd||fffd|! E2:E" & Sheets("|fffd||fffd||fffd||fffd||fffd|").Cells(1, 4).Value + 2
If ComboBox1.Value = "" Then
ComboBox2.Enabled = False
Else
ComboBox2.Enabled = True
End If
End Sub

Private Sub ComboBox2_Change()
Call unp("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(3, 2).Value = Sheets("|fffd||fffd||fffd||fffd||fffd|").Cells(ComboBox2.ListIndex + 2, 5)
Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(4, 2).Value = ComboBox2.Value
End Sub



Private Sub StartButton_Click()
StartF.Hide
Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True
'Call clearlist
Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Activate
Call pr
End Sub

Attribute VB_Name = "mod_TestFTP"
'---------------------------------------------------------------------------------------
' Module        : mod_TestFTP
' |fffd||fffd||fffd||fffd||fffd|     : EducatedFool  (|fffd||fffd||fffd||fffd||fffd|)                    |fffd||fffd||fffd||fffd|: 03.01.2012
' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| Excel, Word, CorelDRAW. |fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.
' http://ExcelVBA.ru/          ICQ: 5836318           Skype: ExcelVBA.ru
' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|: http://ExcelVBA.ru/payments
'---------------------------------------------------------------------------------------

Option Compare Text

Sub testik()
 rc& = InternetOpen("", 0, vbNullString, vbNullString, 0)
    rs& = InternetConnect(rc&, "127.0.0.1", "21", "mouo20", "", 1, 0, 0)
    'If FtpGetFile(rs&, "vnc.exe", "C:\vn\vnc.exe", False, 0, 2, 0) = False Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|!", vbExclamation
    If FtpPutFile(rs&, "C:\1.txt", "SendFile.txt", 2, 0) = False Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|!", vbExclamation
    '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| dwFlags |fffd||fffd||fffd||fffd||fffd||fffd||fffd| FtpGetFile/FtpPutFile |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.
    '|fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: 1 - |fffd||fffd||fffd| ASCII; 2 - |fffd||fffd||fffd| Binary
    Call InternetCloseHandle(rs&)
    Call InternetCloseHandle(rc&)
End Sub

Sub Save_FTP_Account_Information()    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd|!
    ' C|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| Windows |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| FTP-|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    SaveSetting Application.Name, "FTP", "Host", "|fffd||fffd||fffd| |fffd||fffd||fffd| IP |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| FTP"
    SaveSetting Application.Name, "FTP", "Login", "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd|)"
    SaveSetting Application.Name, "FTP", "Password", "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd| FTP |fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
    SaveSetting Application.Name, "FTP", "BaseFolder", "|fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, /www/"
    SaveSetting Application.Name, "FTP", "BaseURL", "http://|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|/"
End Sub

Function MyFTPaccount() As FTPcommander
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| FTPcommander, |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set MyFTPaccount = New FTPcommander
    With MyFTPaccount
        .Host = "127.0.0.1"
        .Login = "root"
        .Password = "ds[e[jkm"
        .BaseFolder = "/"
        .BaseURL = ""
    End With
End Function

Sub test2342342()
    Dim FTP As FTPcommander    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Set FTP = MyFTPaccount    ' |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    FTP.UploadFile ("C:\1.txt")    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
    Debug.Print FTP.GetLastError
End Sub

Private Sub |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|FTP|fffd||fffd||fffd||fffd||fffd||fffd||fffd|()
    Dim FTP As New FTPcommander
    'Set FTP = MyFTPaccount ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    StartFolder$ = "updates/"
    NewSubfolder$ = "test"
    If FTP.CreateNewFolder(StartFolder$ & NewSubfolder$) Then
        Debug.Print "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|: ", StartFolder$ & NewSubfolder$
    Else
        Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd|: ", FTP.GetLastError
    End If
End Sub

Private Sub |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|FTP|fffd||fffd||fffd||fffd||fffd||fffd|()
    ' |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| "C:\|fffd||fffd||fffd||fffd|.jpg" |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| FTP |fffd||fffd||fffd||fffd||fffd||fffd||fffd|,
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| "ER"
    Dim FTP As New FTPcommander
    Link$ = FTP.UploadFile("C:\|fffd||fffd||fffd||fffd|.jpg", , "ER")

    ' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| Link$ |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| "http://u3661.seiko.vps-private.net/ER",
    ' |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| FTP |fffd||fffd||fffd||fffd|
End Sub

Private Sub |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|()
    Dim FTP As New FTPcommander
    fn$ = "C:\Documents and Settings\Admin\|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|\stamp.png"

    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| FTP |fffd||fffd||fffd||fffd||fffd||fffd|
    ' (|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| "1 2 3.png")
    Link$ = FTP.UploadFile(fn$, , "1 2 3.png")
    If Len(Link$) Then
        Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|: ", Link$
    Else
        Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd|: ", FTP.GetLastError
    End If

    ' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| "1 2 3.png"
    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|),
    ' |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| "stamp.png222"
    res = FTP.DownloadFile("", "1 2 3.png", fn$ & "222")
    If res Then
        Debug.Print "|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| FTP"
    Else
        Debug.Print "|fffd||fffd||fffd||fffd||fffd||fffd|: ", FTP.GetLastError
    End If
End Sub

Private Sub |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|DownloadFileFromURL()
    |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|$ = "http://excelvba.ru/sites/default/files/3.jpg"
    |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|$ = "C:\|fffd||fffd||fffd||fffd|.jpg"

    ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    Dim FTP As New FTPcommander
    If FTP.DownloadFileFromURL(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|$, |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|$) Then
        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
        CreateObject("wscript.shell").Run """" & |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|$ & """"
    Else
        MsgBox FTP.GetLastError, vbExclamation
    End If
End Sub


Attribute VB_Name = "|fffd||fffd||fffd||fffd|1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "|fffd||fffd||fffd||fffd|2"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "|fffd||fffd||fffd||fffd|3"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "|fffd||fffd||fffd||fffd|4"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "|fffd||fffd||fffd||fffd|5"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "|fffd||fffd||fffd||fffd|6"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
'Private WithEvents App As Application


Private Sub Workbook_Open()
Sheets("|fffd||fffd||fffd||fffd|").Visible = True
Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
Load StartF
StartF.Label1.Caption = Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(2, 2).Value
StartF.ComboBox2.RowSource = "= |fffd||fffd||fffd||fffd||fffd|! D2:D" & Sheets("|fffd||fffd||fffd||fffd||fffd|").Cells(1, 4).Value + 2
If Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(1, 2).Value = "" Then
Activat.Show
Else
StartF.Show
End If
End Sub


INQUEST-PP=macro
