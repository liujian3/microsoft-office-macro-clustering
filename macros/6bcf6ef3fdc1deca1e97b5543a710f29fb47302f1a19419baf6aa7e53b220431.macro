Attribute VB_Name = "Form2_for_copy"
Attribute VB_Base = "0{1C2E2502-6F3C-4486-9218-5E21F4AF88BA}{645040B5-79FB-4CCE-8F2A-72D58924593E}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False

'Option Explicit
Private Sub ComboBox1_Change()
ComboBox1.BackColor = &H80000005
End Sub

Private Sub CommandButton1_Click()
Dim rr&, rw&
If Len(Textyyyy.Text) <> 4 Then
Textyyyy.BackColor = &HC0C0FF
rr = 1
End If

If TextBox3.Text = "" Then
TextBox3.BackColor = &HC0C0FF
rr = 1
End If

If Len(TextBox4.Text) = 10 Or Len(TextBox4.Text) = 12 Then
Else
TextBox4.BackColor = &HC0C0FF
rr = 1
End If

If Len(ComboBox1.Text) <> 3 Then
ComboBox1.BackColor = &HC0C0FF
rr = 1
End If

If TextBox6.Text = 0 And TextBox7.Text = 0 Then
TextBox6.BackColor = &HC0C0FF
TextBox7.BackColor = &HC0C0FF
rr = 1
End If

If rr = 1 Then Exit Sub

rw = [m1]
If Textdd.Text = "" Then Textdd.Text = "00"
If Textmm.Text = "" Then Textmm.Text = "00"
Cells(rw, 1) = Textdd.Text & "." & Textmm.Text & "." & Textyyyy.Text
Cells(rw, 2) = TextBox2.Text
Cells(rw, 3) = TextBox3.Text
Cells(rw, 4) = TextBox4.Text
Cells(rw, 5) = TextBox5.Text
Cells(rw, 6) = ComboBox1.Text
Cells(rw, 7) = TextBox6.Text
Cells(rw, 8) = TextBox7.Text
Cells(rw, 9) = TextBox8.Text
Range("A" & rw & ":L" & rw).Interior.Color = 49407
Cells(rw, 13).FormulaR1C1 = "=CONCATENATE(RIGHT(RC[-12],4),""-"",RC[-9],""-"",RC[-7])"
Cells(rw, 14).FormulaR1C1 = "=CONCATENATE(RIGHT(RC[-13],4),""-"",RC[-8])"
Cells(rw, 15).FormulaR1C1 = "=RIGHT(RC[-14],7)"
'Cells(rw, 13) = Right(Cells(rw, 1), 4) & "-" & Cells(rw, 4) & "-" & Cells(rw, 6)
'Cells(rw, 14) = Right(Cells(rw, 1), 4) & "-" & Cells(rw, 6)
'Cells(rw, 15) = Right(Cells(rw, 1), 7)

rw = [m1]
Cells(rw, 1).Activate

If CheckBox1.Value = False Then End
End Sub

Private Sub CommandButton10_Click()
End
End Sub

Private Sub CommandButton7_Click()
Dim rw&

rw = [m1] - 1
If CheckBox2.Value = True Then
Textdd.Text = Left(Cells(rw, 1), 2)
Textmm.Text = Mid(Cells(rw, 1), 4, 2)
Textyyyy.Text = Right(Cells(rw, 1), 4)
End If
If CheckBox3.Value = True Then TextBox2.Text = Cells(rw, 2)
If CheckBox4.Value = True Then TextBox3.Text = Cells(rw, 3)
If CheckBox5.Value = True Then TextBox4.Text = Cells(rw, 4)
If CheckBox6.Value = True Then TextBox5.Text = Cells(rw, 5)
If CheckBox7.Value = True Then ComboBox1.Text = Cells(rw, 6)
If CheckBox8.Value = True Then TextBox8.Text = Cells(rw, 9)
End Sub

Private Sub CommandButton8_Click()
CheckBox2.Value = True
CheckBox3.Value = True
CheckBox4.Value = True
CheckBox5.Value = True
CheckBox6.Value = True
CheckBox7.Value = True
CheckBox8.Value = True
End Sub

Private Sub CommandButton9_Click()
CheckBox2.Value = False
CheckBox3.Value = False
CheckBox4.Value = False
CheckBox5.Value = False
CheckBox6.Value = False
CheckBox7.Value = False
CheckBox8.Value = False
End Sub
Private Sub TextBox4_Change()
TextBox4.BackColor = &H80000005
End Sub

Private Sub TextBox3_Change()
TextBox3.BackColor = &H80000005
End Sub

Private Sub TextBox6_Change()
TextBox6.BackColor = &H80000005
TextBox7.BackColor = &H80000005
End Sub

Private Sub TextBox7_Change()
TextBox6.BackColor = &H80000005
TextBox7.BackColor = &H80000005
End Sub

Private Sub Textyyyy_Change()
Textyyyy.BackColor = &H80000005
End Sub

Private Sub UserForm_Activate()
Dim X&, rw&
Dim namelist

For X = 1 To Sheets.Count
namelist = Sheets(X).Name
If Len(namelist) = 3 Then ComboBox1.AddItem namelist
Next X
rw = [m1]
Cells(rw, 1).Activate
End Sub


Attribute VB_Name = "Form_for_copy"
Attribute VB_Base = "0{D9A6B7C9-0A8C-46E6-BCA7-F9B1F0F8F531}{7D7BDBAE-A92B-4703-9247-C94612F7513F}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False

'Option Explicit
Private Sub CommandButton1_Click()
Dim db, tmp, firstAddress, c
Dim TekList As String
Dim rw As Long

Workbooks(Label5.Caption).Close 0
[a1].Select

Application.ScreenUpdating = False
TekList = Label4.Caption
Set db = Workbooks(Label3.Caption).Sheets(Label4.Caption)
db.Unprotect "XYZ"
Set tmp = Workbooks(Label3.Caption).Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
With tmp.Cells
    Set c = .Find(ListINN.Text, After:=ActiveCell, LookIn:=xlFormulas, _
        LookAt:=xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, _
        MatchCase:=False, SearchFormat:=False)
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        tmp.Cells(c.Row, 4).Interior.Color = 16316664
            Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
End With
'end |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Sheets(Label4.Caption).Activate
db.Cells(db.[a3] - 3, 1).Select
Selection.EntireRow.Insert
rw = ActiveCell.Row
db.Cells(rw, 1) = db.Cells(rw - 1, 1) + 1
db.Cells(rw, 2) = Label1.Caption
db.Cells(rw, 3) = "'" & ListINN.Text
db.Cells(rw, 3).NumberFormat = "@"
db.Cells(rw, 4) = Label2.Caption

If db.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
db.Cells(rw, 5).FormulaR1C1 = "=RC[4]+RC[8]+RC[12]+RC[16]"
db.Cells(rw, 7).FormulaR1C1 = "=RC[4]+RC[8]+RC[12]+RC[16]"
  db.Cells(rw, 9).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[e4] & "kv1-" & ListINN.Text & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!G:G)/1000"
db.Cells(rw, 11).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[e4] & "kv1-" & ListINN.Text & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!H:H)/1000"
db.Cells(rw, 13).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[e4] & "kv2-" & ListINN.Text & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!G:G)/1000"
db.Cells(rw, 15).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[e4] & "kv2-" & ListINN.Text & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!H:H)/1000"
db.Cells(rw, 17).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[e4] & "kv3-" & ListINN.Text & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!G:G)/1000"
db.Cells(rw, 19).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[e4] & "kv3-" & ListINN.Text & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!H:H)/1000"
db.Cells(rw, 21).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[e4] & "kv4-" & ListINN.Text & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!G:G)/1000"
db.Cells(rw, 23).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[e4] & "kv4-" & ListINN.Text & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!H:H)/1000"

db.Range("R" & rw - 1).Copy
db.Range("R" & rw).Select
ActiveSheet.Paste
db.Range("T" & rw - 1).Copy
db.Range("T" & rw).Select
ActiveSheet.Paste
db.Range("V" & rw - 1).Copy
db.Range("V" & rw).Select
ActiveSheet.Paste
db.Range("X" & rw - 1).Copy
db.Range("X" & rw).Select
ActiveSheet.Paste

Else
db.Cells(rw, 5).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[e4] & "-" & db.Cells(rw, 3) & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!G:G)/1000"
db.Cells(rw, 7).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[e4] & "-" & db.Cells(rw, 3) & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!H:H)/1000"
db.Cells(rw, 9).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[I4] & "-" & db.Cells(rw, 3) & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!G:G)/1000"
db.Cells(rw, 11).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[I4] & "-" & db.Cells(rw, 3) & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!H:H)/1000"
db.Cells(rw, 13).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[M4] & "-" & db.Cells(rw, 3) & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!G:G)/1000"
db.Cells(rw, 15).Formula = "=SUMIF(|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M," & """" & db.[M4] & "-" & db.Cells(rw, 3) & "-" & TekList & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!H:H)/1000"
End If

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd|
db.Range("F" & rw - 1).Copy
db.Range("F" & rw).Select
ActiveSheet.Paste

db.Range("H" & rw - 1).Copy
db.Range("H" & rw).Select
ActiveSheet.Paste

db.Range("J" & rw - 1).Copy
db.Range("J" & rw).Select
ActiveSheet.Paste

db.Range("L" & rw - 1).Copy
db.Range("L" & rw).Select
ActiveSheet.Paste

db.Range("N" & rw - 1).Copy
db.Range("N" & rw).Select
ActiveSheet.Paste

db.Range("P" & rw - 1).Copy
db.Range("P" & rw).Select
ActiveSheet.Paste
Application.CutCopyMode = False
'end |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd|
'
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
rw = db.[a3] - 4
    db.Range("A7:AG" & rw + 1).Select
    db.Sort.SortFields.Clear
    db.Sort.SortFields.Add key:=Range("E8:E" & rw + 1), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    db.Sort.SortFields.Add key:=Range("G8:G" & rw + 1), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    db.Sort.SortFields.Add key:=Range("I8:I" & rw + 1), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    db.Sort.SortFields.Add key:=Range("K8:K" & rw + 1), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    db.Sort.SortFields.Add key:=Range("M8:M" & rw + 1), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    db.Sort.SortFields.Add key:=Range("O8:O" & rw + 1), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    db.Sort.SortFields.Add key:=Range("Q8:Q" & rw + 1), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    db.Sort.SortFields.Add key:=Range("S8:S" & rw + 1), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    db.Sort.SortFields.Add key:=Range("U8:U" & rw + 1), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    db.Sort.SortFields.Add key:=Range("W8:W" & rw + 1), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    With db.Sort
        .SetRange Range("A7:AG" & rw + 1)
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd|
For X = 8 To db.[a3] - 1
db.Cells(X, 1) = X - 7
Next X

If db.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
db.Range("Y7:Z" & rw + 1).ClearContents
Else
db.Range("Q7:R" & rw + 1).ClearContents
End If

Run "record_vp"
db.Select
db.[a8].Select
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
End
End Sub

Private Sub CommandButton2_Click()
Workbooks(Label5.Caption).Close 0
Workbooks(Label3.Caption).Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").[a1].Select
Workbooks(Label3.Caption).Sheets(Label4.Caption).Activate
End
End Sub

Private Sub ListINN_Click()
Dim tmp, firstAddress, c

Set tmp = Workbooks(Label3.Caption).Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
'-------------------------------------
With tmp.Cells
    Set c = .Find(ListINN.Text, After:=ActiveCell, LookIn:=xlFormulas, _
        LookAt:=xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, _
        MatchCase:=False, SearchFormat:=False)
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
    Label1.Caption = tmp.Cells(c.Row, 3)
    Label2.Caption = tmp.Cells(c.Row, 5)
            Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
End With
'-------------------------------------
CommandButton1.Enabled = True
End Sub

Private Sub TextBox1_Change()
Dim X As Long
Dim c, firstAddress

Label1.Caption = ""
Label2.Caption = ""
CommandButton1.Enabled = False

If TextBox1.Text = "" Then
ListINN.Clear
DoEvents
For X = 2 To [C1]
If Cells(X, 3) <> 1 Then ListINN.AddItem Cells(X, 1)
Next X
Exit Sub
End If

Columns("D:D").ClearContents
With Cells
    Set c = .Find(TextBox1.Text, After:=ActiveCell, LookIn:=xlFormulas, _
        LookAt:=xlPart, SearchOrder:=xlByRows, SearchDirection:=xlNext, _
        MatchCase:=False, SearchFormat:=False)
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
    Cells(c.Row, 4) = 1
                Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
End With

ListINN.Clear
For X = 2 To [C1]
If Cells(X, 3) <> 1 And Cells(X, 4) = 1 Then ListINN.AddItem Cells(X, 1)
Next X
End Sub

Private Sub UserForm_Activate()
Dim db, tmp, tmp_book
Dim TekList As String
Dim stroka&, X&, Y&

Application.ScreenUpdating = False
TekList = ActiveSheet.Name
Set db = Sheets(TekList)
Workbooks(ActiveWorkbook.Name).Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Activate
Set tmp = Workbooks(ActiveWorkbook.Name).Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Label3.Caption = ActiveWorkbook.Name
Label4.Caption = TekList

If tmp.FilterMode = True Then tmp.ShowAllData

stroka = [m1] - 1
    Range("D:D,F:F").Select
    Range("F1").Activate
    Selection.Copy
    Workbooks.Add
    tmp_book = ActiveWorkbook.Name
    Label5.Caption = tmp_book
    ActiveSheet.Paste
    Application.CutCopyMode = False
    ActiveSheet.Range("$A$1:$B$" & stroka).RemoveDuplicates Columns:=Array(1, 2), Header:=xlYes
    Range("C1").FormulaR1C1 = "=COUNTA(C[-1])"

For X = 2 To [C1]
If Cells(X, 1) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or Cells(X, 1).Font.Color = 255 Or Left(Cells(X, 1), 2) = "00" Then Cells(X, 3) = 1
If Not Cells(X, 2) = TekList + 0 Then Cells(X, 3) = 1
If Cells(X, 3) = 1 Then GoTo 1
    For Y = 8 To db.[a3] - 3
    If Format(db.Cells(Y, 3), "@") = Format(Cells(X, 1), "@") Then Cells(X, 3) = 1
    Next Y
1
Next X
For X = 2 To [C1]
If Cells(X, 3) <> 1 Then ListINN.AddItem Cells(X, 1)
Next X

End Sub
Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
If Label5.Caption = Empty Then Exit Sub
Workbooks(Label5.Caption).Close 0
Workbooks(Label3.Caption).Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").[a1].Select
Workbooks(Label3.Caption).Sheets(Label4.Caption).Activate
End Sub


Attribute VB_Name = "Module_for_copy"
Public Const |fffd||fffd||fffd||fffd||fffd||fffd| As String = "7.7"
'Option Explicit
Sub auto_open()
On Error Resume Next
Application.EnableCancelKey = xlDisabled
Dim shablon%
Dim prog_name$, namelist$, lLineNum% ' As Integer
Dim objVBProjX, objVBCompX, objCodeModX As Object
Dim xx&, X&, save1, s810, db

shablon = 0
prog_name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_3_5_4_v." & |fffd||fffd||fffd||fffd||fffd||fffd| & ".xlsb"

    For xx = 1 To ThisWorkbook.Sheets.Count
    namelist = ThisWorkbook.Sheets(xx).Name
    If namelist = "3.5.4 (|fffd||fffd||fffd||fffd||fffd||fffd|)" Then shablon = 1
    Next xx
If Not ThisWorkbook.Name = prog_name And shablon = 1 Then
MsgBox "|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| ''|fffd||fffd||fffd| |fffd||fffd||fffd|'' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|! |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| [" & prog_name & "] |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|.", vbCritical
ThisWorkbook.Close 0
End If

Application.AskToUpdateLinks = False
If Left(ThisWorkbook.Name, 16) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_3_5_4" Then
If ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = True Then ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Visible = False
If Not ThisWorkbook.Worksheets(3).Name = "|fffd||fffd||fffd||fffd|" Then ThisWorkbook.Worksheets(3).Name = "|fffd||fffd||fffd||fffd|"
Windows(ThisWorkbook.Name).Visible = False

Load Form354
Form354.Show
Else
Application.ScreenUpdating = False
        If ActiveSheet.Name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" And Cells(1, 1) = "|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|X" Then
            'Application.Calculation = xlCalculationManual
            Set objVBProjX = ActiveWorkbook.VBProject
            Set objVBCompX = objVBProjX.VBComponents("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
            Set objCodeModX = objVBCompX.CodeModule

            With objCodeModX
                lLineNum = .CreateEventProc("BeforeSave", "Workbook")
                lLineNum = lLineNum + 1
                .InsertLines lLineNum, "run ""save_wk"""
            End With

        ActiveWorkbook.VBProject.VBComponents.VBE.MainWindow.Visible = False
        With Application
         .VBE.CommandBars.FindControl(ID:=2578).Execute
         .SendKeys "^{PGDN} "
         .SendKeys "{Tab}"
         .SendKeys "XYZ"
         .SendKeys "{Tab}"
         .SendKeys "XYZ"
         .SendKeys "{Enter}"
         .SendKeys "{NUMLOCK}"
        End With
        
        Application.Wait Time:=Now + TimeValue("00:00:04")
        
    For X = 1 To ThisWorkbook.Sheets.Count
    namelist = ThisWorkbook.Sheets(X).Name
    ThisWorkbook.Sheets(namelist).Select
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        If Len(namelist) = 3 Then
        Set s810 = ThisWorkbook.Sheets(namelist)
        s810.Unprotect "XYZ"
        s810.Shapes("Button 1").Delete
        s810.Shapes("Button 2").OnAction = "start_new_str"
        s810.Shapes("Button 3").OnAction = "riski"
        s810.Shapes("Button 4").OnAction = "|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_2"
        s810.Shapes("Button 5").OnAction = "ogranicheniya"
        s810.Shapes("Button 6").OnAction = "egrn_snyatie"
        s810.Shapes("Option Button 7").OnAction = "fir"
        s810.Shapes("Option Button 8").OnAction = "ais"
        s810.Shapes("Button 9").OnAction = "file_SSCH"
        s810.Shapes("Button 10").OnAction = "file_property"
        s810.Shapes("Button 11").OnAction = "file_Shema"
        s810.Shapes("Button 12").OnAction = "show_hide"
        s810.Shapes("Button 13").OnAction = "|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_3"
        s810.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
        End If
    
    '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        If namelist = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" And [a1] = "|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|X" Then
        Set db = ThisWorkbook.Sheets(namelist)
        db.Shapes("Button 1").OnAction = "start_new_oper"
        db.Shapes("Button 2").OnAction = "|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
        db.Shapes("Button 3").OnAction = "|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd|_|fffd||fffd||fffd|"
        db.Shapes("Button 4").OnAction = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd|"
        db.Shapes("Button 5").OnAction = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
        End If
    Next X
    
'Application.SendKeys "{NUMLOCK}"
Application.OnTime Now + TimeValue("00:00:02"), "wakeup"
ThisWorkbook.Close 1
        End If
End If

Application.ScreenUpdating = True
End Sub
Sub wakeup()
End Sub
Sub |fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd|_|fffd||fffd||fffd|()
If Not CreateObject("WScript.Network").UserName = "7400-14-036" Then On Error Resume Next
Dim db, tmp, tmp_w
Dim stroka&, X&
Dim txt  As String
Dim MyData As DataObject
Set MyData = New DataObject

Set db = ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
stroka = [m1] - 1
If stroka = -1 Then Exit Sub
txt = ""
Application.ScreenUpdating = False
    Workbooks.Add
    Set tmp = Sheets(ActiveSheet.Name)
    tmp_w = ActiveWorkbook.Name
    tmp.Range("B1").FormulaR1C1 = "=COUNTA(C[-1])+1"
For X = 2 To stroka
If db.Cells(X, 4) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" And db.Cells(X, 6) = 810 And Not Left(db.Cells(X, 11), 1) = 3 Then
    If Not Left(db.Cells(X, 11), 3) = 408 Then tmp.Cells(tmp.Cells(1, 2), 1) = db.Cells(X, 11)
End If
Next X
    
ActiveSheet.Range("$A$1:$A$" & tmp.Cells(1, 2)).RemoveDuplicates Columns:=1, Header:=xlYes

For X = 1 To tmp.[b1]
txt = txt & "|" & tmp.Cells(X, 1)
Next X

Workbooks(tmp_w).Close 0

MyData.SetText txt
MyData.PutInClipboard
MsgBox txt, vbInformation, "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|)"
End Sub
Sub |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd|()
If Not CreateObject("WScript.Network").UserName = "7400-14-036" Then On Error Resume Next
Dim db, rr, r_book, scet, c, firstAddress, zz
Dim X&, xx&, rw&, lngCount&
Set db = ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
   
Application.ScreenUpdating = False
If ActiveSheet.FilterMode = True Then ActiveSheet.ShowAllData

With Application.FileDialog(msoFileDialogOpen)
    .Title = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd|"
    .AllowMultiSelect = False
    .FilterIndex = 2
    .Show
    For lngCount = 1 To .SelectedItems.Count
    Workbooks.Open Filename:=.SelectedItems(lngCount)
    GoTo 1
    Next lngCount
End With
Exit Sub
1

Set rr = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
r_book = ActiveWorkbook.Name
rw = Cells.SpecialCells(xlLastCell).Row

rr.Columns("U:U").Replace What:="|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", Replacement:="|fffd||fffd||fffd|", LookAt:=xlPart, SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, ReplaceFormat:=False
rr.Columns("U:U").Replace What:="|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", Replacement:="|fffd||fffd||fffd|", LookAt:=xlPart, SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, ReplaceFormat:=False
rr.Columns("U:U").Replace What:="|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", Replacement:="|fffd||fffd||fffd|", LookAt:=xlPart, SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, ReplaceFormat:=False
rr.Columns("U:U").Replace What:="|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", Replacement:="|fffd||fffd||fffd|", LookAt:=xlPart, SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, ReplaceFormat:=False
rr.Columns("U:U").Replace What:="|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", Replacement:="|fffd||fffd||fffd|", LookAt:=xlPart, SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, ReplaceFormat:=False
rr.Columns("U:U").Replace What:="|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", Replacement:="|fffd||fffd|", LookAt:=xlPart, SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, ReplaceFormat:=False
rr.Columns("U:U").Replace What:="|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", Replacement:="|fffd||fffd|", LookAt:=xlPart, SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, ReplaceFormat:=False
rr.Columns("U:U").Replace What:="|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|", Replacement:="|fffd||fffd|", LookAt:=xlPart, SearchOrder:=xlByRows, MatchCase:=False, SearchFormat:=False, ReplaceFormat:=False

For X = 11 To Cells.SpecialCells(xlLastCell).Row
    scet = rr.Cells(X, 3)
    If scet = Empty Then GoTo 2
    With db.Columns("K:K")
    Set c = .Find(scet, LookIn:=xlFormulas, LookAt:=2, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
        
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        If db.Cells(c.Row, 12) = rr.Cells(X, 14) And Len(rr.Cells(X, 18)) = 10 Then
        db.Cells(c.Row, 3) = rr.Cells(X, 21)
        db.Cells(c.Row, 4) = rr.Cells(X, 18)
        End If
        If db.Cells(c.Row, 12) = rr.Cells(X, 14) And Len(rr.Cells(X, 18)) = 12 Then
        db.Cells(c.Row, 3) = rr.Cells(X, 22) & " " & rr.Cells(X, 23) & " " & rr.Cells(X, 24)
        db.Cells(c.Row, 4) = rr.Cells(X, 18)
        End If
        xx = xx + 1
        Application.StatusBar = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & X & " |fffd||fffd| " & rw & ":  " & Format(X / rw, "0%") & "   |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & xx
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
    End With
2
Next X
Application.StatusBar = False
Workbooks(r_book).Close 0
Application.ScreenUpdating = True
Run "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
End Sub
Sub start_new_str()
Load Form_for_copy
Form_for_copy.Show
End Sub
Sub start_new_oper()
Load Form2_for_copy
Form2_for_copy.Show
End Sub
Sub |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|()
If Not CreateObject("WScript.Network").UserName = "7400-14-036" Then On Error Resume Next
Dim stroka, txt, tmp, db
Dim X As Long

stroka = [m1] - 1
If stroka = -1 Then Exit Sub
txt = ""
Application.ScreenUpdating = False
    Range("A1").Select
    Selection.AutoFilter
    Columns("D:D").Copy
    Workbooks.Add
    ActiveSheet.Paste
    Application.CutCopyMode = False
    ActiveSheet.Range("$A$1:$A$" & stroka).RemoveDuplicates Columns:=1, Header:=xlYes
    Set db = Sheets(ActiveSheet.Name)
    tmp = ActiveWorkbook.Name
    db.Range("B1").FormulaR1C1 = "=COUNTA(C[-1])"

Load Form_for_copy
For X = 2 To db.[b1]
If db.Cells(X, 1) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or db.Cells(X, 1).Font.Color = 255 Or Left(db.Cells(X, 1), 2) = "00" Then GoTo 2
If Len(db.Cells(X, 1)) = 10 Or Len(db.Cells(X, 1)) = 12 Then txt = txt & "|" & db.Cells(X, 1)
2
Next X

Workbooks(tmp).Close 0
Form_for_copy.Clip.Text = txt
Form_for_copy.Clip.SelStart = 0
Form_for_copy.Clip.SelLength = Form_for_copy.Clip.TextLength
Form_for_copy.Clip.Copy
Unload Form_for_copy
MsgBox txt, vbInformation, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| (|fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|)"
End Sub

Sub riski()
If Not CreateObject("WScript.Network").UserName = "7400-14-036" Then On Error Resume Next
Dim db, data_start, rr, r_book, c, firstAddress, pp, cc, firstAddress2
Dim X&, data_end&, yy&, str1&, kk&, z&, kolvo&, Y&, grafa&

Application.ScreenUpdating = False
Set db = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
data_start = db.[e4] + 0
grafa = 23
If Left(db.Cells(3, 27), 14) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|" Then grafa = 27

Dim lngCount As Long
    
With Application.FileDialog(msoFileDialogOpen)
    .Title = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
    .AllowMultiSelect = False
    .FilterIndex = 2
    .Show
    For lngCount = 1 To .SelectedItems.Count
    Workbooks.Open Filename:=.SelectedItems(lngCount)
    GoTo 1
    Next lngCount
End With
GoTo 22
1
db.Unprotect "XYZ"
Set rr = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
r_book = ActiveWorkbook.Name
For X = 3 To Cells.SpecialCells(xlLastCell).Row
    
If rr.Cells(X, 9) = "" Then
    data_end = 9999
Else
    data_end = Right(rr.Cells(X, 9), 4) + 0
End If

If data_end >= data_start Then
If rr.Cells(X, 1) = Empty Then GoTo 11
    With db.Columns("C:C")
    Set c = .Find(rr.Cells(X, 1), LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
        
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        If Not db.Cells(c.Row, grafa) = "" Then pp = Chr(10)
        rr.Cells(X, 5).Font.Bold = True
        If rr.Cells(X, 9) = "" Then rr.Cells(X, 9) = "          "
        db.Cells(c.Row, grafa) = db.Cells(c.Row, grafa) & pp & Left(rr.Cells(X, 5), 5) & " (" & rr.Cells(X, 8) & "-" & rr.Cells(X, 9) & ") "
        pp = ""
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
    End With
End If
11
Next X
' |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    rr.Columns("E:E").Copy 'Select
    Workbooks.Add
    ActiveSheet.Paste
    Application.CutCopyMode = False
    [b2].FormulaR1C1 = "=COUNTA(C[-1])"
'======================================
For yy = 3 To [b2] + 1
If Cells(yy, 1).Font.Bold = True Then
    With Columns("A:A")
    Set cc = .Find(Cells(yy, 1), LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not cc Is Nothing Then
        firstAddress2 = cc.Address
        Do
        Cells(cc.Row, 1).Font.Bold = True
        Set cc = .FindNext(cc)
        Loop While Not cc Is Nothing And cc.Address <> firstAddress2
    End If
    End With
End If
Next yy
'======================================
    ActiveSheet.Range("$A$1:$A$" & [b2] + 1).RemoveDuplicates Columns:=1, Header:=xlNo
    Rows("1:1").Delete Shift:=xlUp
    ActiveWorkbook.Worksheets(ActiveSheet.Name).Sort.SortFields.Clear
    ActiveWorkbook.Worksheets(ActiveSheet.Name).Sort.SortFields.Add key:=Range("A1"), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets(ActiveSheet.Name).Sort
        .SetRange Range("A2:A" & [b1] + 1)
        .Header = xlNo
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With

db.Cells(db.[a3] + 5, 2) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd| " & grafa - 1 & " (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)"
db.Cells(db.[a3] + 5, 2).Font.Bold = True
str1 = db.[a3] + 4
For kk = 2 To [b1]
If Cells(kk, 1).Font.Bold = True Then
db.Cells(kk + str1, 2) = Cells(kk, 1)
Else
str1 = str1 - 1
End If
Next kk
ActiveWorkbook.Close 0
' end |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Workbooks(r_book).Close 0
For z = 8 To db.[a3] - 2
If db.Cells(z, grafa) = "" Then GoTo 2
    kolvo = Len(db.Cells(z, grafa)) + 1
    For Y = 1 To kolvo Step 31
        db.Cells(z, grafa).Characters(Start:=Y, Length:=5).Font.FontStyle = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
    Next Y
2
Next z
22
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
Run "nominal1" '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd|_|fffd||fffd||fffd| |fffd||fffd|
Run "nominal3" '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Run "nominal2" '|fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Run "nominal"  '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| 74
Run "ugolov_delo" '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
Run "check_ip"
End Sub
Sub ugolov_delo() '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
On Error Resume Next
Dim db, NewFolder, rr, r_book, c, firstAddress
Dim X As Long, grafa As Long
Application.ScreenUpdating = False
Set db = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
grafa = 23
If db.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then grafa = 27

    NewFolder = db.Cells(6, grafa)
    If Dir(NewFolder & "|fffd||fffd|.xlsb") = "" Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & NewFolder & "|fffd||fffd|.xlsb", vbCritical, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|": Exit Sub
    Workbooks.Open Filename:=NewFolder & "|fffd||fffd|.xlsb"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd|
db.Unprotect "XYZ"
db.Cells(2, 21) = "|fffd||fffd|"

Set rr = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
r_book = ActiveWorkbook.Name
For X = 8 To db.[a3] - 4
    
    With rr.Columns("A:A")
    Set c = .Find(db.Cells(X, 3), LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        db.Cells(X, grafa + 1).Interior.Color = 10213316
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
    End With
Next X
Workbooks(r_book).Close 0
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
End Sub

Sub nominal3() '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
On Error Resume Next
Dim db, NewFolder, rr, r_book, c, firstAddress
Dim X As Long, grafa As Long
Application.ScreenUpdating = False
Set db = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
grafa = 23
If db.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then grafa = 27

    NewFolder = db.Cells(6, grafa)
    If Dir(NewFolder & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.xlsx") = "" Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & NewFolder & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.xlsx", vbCritical, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Sub
    Workbooks.Open Filename:=NewFolder & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.xlsx"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
db.Unprotect "XYZ"
db.Cells(2, 21) = "|fffd||fffd|"

Set rr = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
r_book = ActiveWorkbook.Name
For X = 8 To db.[a3] - 4
    
    With rr.Columns("A:A")
    Set c = .Find(db.Cells(X, 3), LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        db.Cells(X, grafa).Interior.Color = 411543
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
    End With
Next X
Workbooks(r_book).Close 0
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
End Sub

Sub nominal2() '|fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
On Error Resume Next
Dim db, NewFolder, rr, r_book, c, firstAddress
Dim X As Long, grafa As Long

Application.ScreenUpdating = False
Set db = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
grafa = 23
If db.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then grafa = 27

    NewFolder = db.Cells(6, grafa)
    If Dir(NewFolder & "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.xlsx") = "" Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & NewFolder & "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.xlsx", vbCritical, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Sub
    Workbooks.Open Filename:=NewFolder & "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.xlsx"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
db.Unprotect "XYZ"
db.Cells(2, 21) = "|fffd||fffd|"

Set rr = Workbooks(ActiveWorkbook.Name).Sheets("|fffd||fffd||fffd||fffd|1")
r_book = ActiveWorkbook.Name
For X = 8 To db.[a3] - 4
    
    With rr.Columns("A:A")
    Set c = .Find(db.Cells(X, 3), LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        db.Cells(X, grafa).Interior.Color = 682978
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
    End With
Next X
Workbooks(r_book).Close 0
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
End Sub
Sub nominal1()
On Error Resume Next
Dim db, NewFolder, rr, r_book, c, firstAddress
Dim X As Long, grafa As Long
Dim t_file As String
t_file = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd|.xlsb"
Application.ScreenUpdating = False
Set db = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
grafa = 23
If db.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then grafa = 27

    NewFolder = db.Cells(6, grafa)
    If Dir(NewFolder & t_file) = "" Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & NewFolder & t_file, vbCritical, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| (|fffd||fffd||fffd| |fffd||fffd|)": Exit Sub
    Workbooks.Open Filename:=NewFolder & t_file
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
db.Unprotect "XYZ"
db.Cells(2, 21) = "|fffd||fffd|"

Set rr = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
r_book = ActiveWorkbook.Name
For X = 8 To db.[a3] - 4
    
    With rr.Columns("A:A")
    Set c = .Find(db.Cells(X, 3), LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        db.Cells(X, grafa).Interior.Color = 10800122
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
    End With
Next X
Workbooks(r_book).Close 0
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
End Sub

Sub nominal()
On Error Resume Next
Dim db, NewFolder, rr, r_book, c, firstAddress
Dim X As Long, grafa As Long

Application.ScreenUpdating = False
Set db = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
grafa = 23
If db.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then grafa = 27

    NewFolder = db.Cells(6, grafa)
    If Dir(NewFolder & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.xlsx") = "" Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & NewFolder & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.xlsx", vbCritical, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Sub
    Workbooks.Open Filename:=NewFolder & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|.xlsx"
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
db.Unprotect "XYZ"
db.Cells(2, 21) = "|fffd||fffd|"

Set rr = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
r_book = ActiveWorkbook.Name
For X = 8 To db.[a3] - 4
    
    With rr.Columns("A:A")
    Set c = .Find(db.Cells(X, 3), LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        db.Cells(X, grafa).Interior.Color = 65535
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
    End With
Next X
Workbooks(r_book).Close 0
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
End Sub

Sub |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_2() '|fffd||fffd|
If Not CreateObject("WScript.Network").UserName = "7400-14-036" Then On Error Resume Next

Dim db As Variant
Dim X As Long
Dim InnText As Variant
Set db = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
db.Unprotect "XYZ"

For X = 8 To [a3] - 2

If Cells(X, 3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or Len(Cells(X, 3)) <> 10 Or Cells(X, 3) = " ---" Then GoTo 1
If Cells(X, 1).Interior.Color = 15921906 Then GoTo 1

If Not inn_check(Cells(X, 3)) = 1 Then
    Cells(X, 3).Font.Color = -16776961
    GoTo 1
End If

txt = txt & [c6] & Cells(X, 3)
1
Next X
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Form_for_copy.Clip.Text = txt
Form_for_copy.Clip.SelStart = 0
Form_for_copy.Clip.SelLength = Form_for_copy.Clip.TextLength
Form_for_copy.Clip.Copy
Unload Form_for_copy
MsgBox txt, vbInformation, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
End Sub
Sub |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_3() '|fffd||fffd|
If Not CreateObject("WScript.Network").UserName = "7400-14-036" Then On Error Resume Next

Dim db As Variant
Dim X As Long
Dim InnText As Variant
Set db = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
db.Unprotect "XYZ"

For X = 8 To [a3] - 2

If Cells(X, 3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or Len(Cells(X, 3)) <> 12 Or Cells(X, 3) = " ---" Then GoTo 1

If Not inn_check(Cells(X, 3)) = 1 Then
    Cells(X, 3).Font.Color = -16776961
    GoTo 1
End If

txt = txt & [c6] & Cells(X, 3)
1
Next X
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Form_for_copy.Clip.Text = txt
Form_for_copy.Clip.SelStart = 0
Form_for_copy.Clip.SelLength = Form_for_copy.Clip.TextLength
Form_for_copy.Clip.Copy
Unload Form_for_copy
MsgBox txt, vbInformation, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|"
End Sub

Sub ogranicheniya()
If Not CreateObject("WScript.Network").UserName = "7400-14-036" Then On Error Resume Next
Dim db, NewFolder, rr, r_book, c, firstAddress, data_start, pp
Dim X As Long, grafa As Long

Application.ScreenUpdating = False
Set db = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
grafa = 24
If Left(db.Cells(3, 28), 22) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|" Then grafa = 28

data_start = db.[e4] + 0
Dim lngCount As Long
    
With Application.FileDialog(msoFileDialogOpen)
    .Title = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|-3 [|fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|] |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
    .AllowMultiSelect = False
    .FilterIndex = 2
    .Show
    For lngCount = 1 To .SelectedItems.Count
    Workbooks.Open Filename:=.SelectedItems(lngCount)
    GoTo 1
    Next lngCount
End With
Exit Sub
1
Set rr = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
r_book = ActiveWorkbook.Name
For X = 2 To Cells.SpecialCells(xlLastCell).Row
    If rr.Cells(X, 7) = 14 Then
    With db.Columns("C:C")
    Set c = .Find(rr.Cells(X, 13), LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)

    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        If Not db.Cells(c.Row, grafa) = "" Then pp = Chr(10)
        If rr.Cells(X, 9) = "" Then rr.Cells(X, 9) = "          "
        db.Unprotect "XYZ"
        db.Cells(c.Row, grafa) = db.Cells(c.Row, grafa) & pp & rr.Cells(X, 10) & " (" & rr.Cells(X, 8) & "-" & rr.Cells(X, 9) & ") "
        db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
        pp = ""
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
    End With
    End If
Next X
Workbooks(r_book).Close 0
Application.ScreenUpdating = True
End Sub
Sub egrn_snyatie()
On Error Resume Next
Application.ScreenUpdating = False
Dim db, rr, r_book, c, firstAddress, sms0, end_txt, kod, kod2, sms1, sms2, sms3, pp, cc, firstAddress2
Dim X&, rw&, kod_data&, kod_data2&, |fffd||fffd||fffd||fffd||fffd|&, yy&, str1&, kk&, z&, kolvo&, Y&, grafa&

Set db = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
grafa = 28
If Left(db.Cells(3, 32), 17) = "C|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd|" Then grafa = 32

db.Unprotect "XYZ"
Dim lngCount As Long
    
With Application.FileDialog(msoFileDialogOpen)
    .Title = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| (|fffd||fffd||fffd||fffd|. |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|) |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
    .AllowMultiSelect = False
    .FilterIndex = 2
    .Show
    For lngCount = 1 To .SelectedItems.Count
    Workbooks.Open Filename:=.SelectedItems(lngCount)
    GoTo 1
    Next lngCount
End With
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
Exit Sub
1

Set rr = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
r_book = ActiveWorkbook.Name
rr.Columns("AE:AE").Font.Bold = False
rw = Cells.SpecialCells(xlLastCell).Row
    ActiveWorkbook.Worksheets(ActiveSheet.Name).Sort.SortFields.Clear
    ActiveWorkbook.Worksheets(ActiveSheet.Name).Sort.SortFields.Add key:= _
        Range("AE1"), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
        xlSortNormal
    With ActiveWorkbook.Worksheets(ActiveSheet.Name).Sort
        .SetRange Range("A2:AQ" & rw)
        .Header = xlNo
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With


For X = 2 To rw
    With db.Columns("C:C")
    Set c = .Find(rr.Cells(X, 1), LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
        
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        If rr.Cells(X, 30) = "" Or rr.Cells(X, 31) = "" Then GoTo 3
        sms0 = db.Cells(c.Row, grafa)
        
        If Not db.Cells(c.Row, grafa) = "" Then
        end_txt = Right(db.Cells(c.Row, grafa), 16)
        kod = Left(end_txt, 2)
        kod2 = Left(rr.Cells(X, 31), 2)
        kod_data = Format(Mid(end_txt, 5, 10), 0) + 0
        kod_data2 = Format(rr.Cells(X, 30), 0) + 0
        
        If kod = Left(rr.Cells(X, 31), 2) And kod_data < Format(rr.Cells(X, 30), 0) + 0 Then
        |fffd||fffd||fffd||fffd||fffd| = Len(db.Cells(c.Row, grafa))
        sms1 = db.Cells(c.Row, grafa)
        db.Cells(c.Row, 24) = Left(db.Cells(c.Row, grafa), |fffd||fffd||fffd||fffd||fffd| - 16)
        sms2 = db.Cells(c.Row, grafa)
        Else
        If kod = Left(rr.Cells(X, 31), 2) And kod_data > Format(rr.Cells(X, 30), 0) + 0 Then GoTo 3
        If kod = Left(rr.Cells(X, 31), 2) And kod_data = Format(rr.Cells(X, 30), 0) + 0 Then GoTo 3
        End If
        End If
        
        If db.Cells(c.Row, grafa) = "" Then
        pp = ""
        Else
        pp = Chr(10)
        End If

        If Right(db.Cells(c.Row, grafa), 1) = Chr(10) Then pp = ""
        
        rr.Cells(X, 31).Font.Bold = True
        db.Cells(c.Row, grafa) = db.Cells(c.Row, grafa) & pp & Left(rr.Cells(X, 31), 2) & " (" & rr.Cells(X, 30) & ") "
        sms3 = db.Cells(c.Row, grafa)
        
3
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
    End With

Next X
' |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
    rr.Columns("AE:AE").Copy 'Select
    Workbooks.Add
    ActiveSheet.Paste
    Application.CutCopyMode = False
    [b2].FormulaR1C1 = "=COUNTA(C[-1])"
'======================================
For yy = 2 To [b2] + 1
If Cells(yy, 1).Font.Bold = True Then
    With Columns("A:A")
    Set cc = .Find(Cells(yy, 1), LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not cc Is Nothing Then
        firstAddress2 = cc.Address
        Do
        Cells(cc.Row, 1).Font.Bold = True
        Set cc = .FindNext(cc)
        Loop While Not cc Is Nothing And cc.Address <> firstAddress2
    End If
    End With
End If
Next yy
'======================================
    ActiveSheet.Range("$A$1:$A$" & [b2] + 1).RemoveDuplicates Columns:=1, Header:=xlNo
    Rows("1:1").Delete Shift:=xlUp
    ActiveWorkbook.Worksheets(ActiveSheet.Name).Sort.SortFields.Clear
    ActiveWorkbook.Worksheets(ActiveSheet.Name).Sort.SortFields.Add key:=Range("A1"), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets(ActiveSheet.Name).Sort
        .SetRange Range("A2:A" & [b1] + 1)
        .Header = xlNo
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With

db.Cells(db.[a3] + 5, 9) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd||fffd| 23 (|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)"
db.Cells(db.[a3] + 5, 9).Font.Bold = True
str1 = db.[a3] + 5
For kk = 1 To [b1]
If Cells(kk, 1).Font.Bold = True Then
db.Cells(kk + str1, 9) = Cells(kk, 1)
If Len(Cells(kk, 1)) > 150 Then db.Cells(kk + str1, 9) = Left(db.Cells(kk + str1, 9), 150) & " ..."
Else
str1 = str1 - 1
End If
Next kk
ActiveWorkbook.Close 0
' end |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Workbooks(r_book).Close 0
For z = 8 To db.[a3] - 2
If db.Cells(z, grafa) = "" Then GoTo 2
    kolvo = Len(db.Cells(z, grafa)) + 1
    For Y = 1 To kolvo Step 17
        db.Cells(z, grafa).Characters(Start:=Y, Length:=2).Font.FontStyle = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
    Next Y
2
Next z
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
End Sub
Sub fir()
ActiveSheet.Unprotect "XYZ"
[c6] = "|"
ActiveSheet.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
End Sub
Sub ais()
ActiveSheet.Unprotect "XYZ"
[c6] = "/"
ActiveSheet.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
End Sub

Sub print_wk()
If Not CreateObject("WScript.Network").UserName = "7400-14-036" Then On Error Resume Next
Dim tekSQL#, tekSQL1 As Byte
Dim key$, rb$

If CreateObject("WScript.Network").UserName = "7400-14-036" Then Exit Sub
If Left(CreateObject("WScript.Network").UserName, 2) <> "74" Then Exit Sub
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
key = "HKEY_LOCAL_MACHINE\SOFTWARE\ODBC\ODBC.INI\TAXES\Server"
tekSQL = UCase(CreateObject("WScript.Shell").RegRead(key))
If Not tekSQL = UCase("u7400-app031") Then
CreateObject("WScript.Shell").RegWrite key, UCase("u7400-app031"), "REG_SZ"
tekSQL1 = 1
End If
Application.ScreenUpdating = False
Workbooks.Add
    With ActiveSheet.ListObjects.Add(SourceType:=0, Source:= _
        "ODBC;DSN=TAXES;Trusted_Connection=Yes;DATABASE=Taxes00", Destination:=Range("$A$1")).QueryTable
        .CommandText = Array("exec Taxes00.dbo.p_check_Risk_Analisys 2, '" & ThisWorkbook.Sheets("810").Cells(3, 2) & "', '" & ThisWorkbook.Sheets("810").Cells(1, 21) & "', '3'")
        .RowNumbers = False
        .FillAdjacentFormulas = False
        .PreserveFormatting = True
        .RefreshOnFileOpen = False
        .BackgroundQuery = True
        .RefreshStyle = xlInsertDeleteCells
        .SavePassword = False
        .SaveData = True
        .AdjustColumnWidth = True
        .RefreshPeriod = 0
        .PreserveColumnInfo = True
        .ListObject.DisplayName = "|fffd||fffd||fffd||fffd||fffd||fffd|"
        .Refresh BackgroundQuery:=False
    End With
    rb = ActiveWorkbook.Name
Workbooks(rb).Close 0
Application.ScreenUpdating = True
If tekSQL1 = 1 Then CreateObject("WScript.Shell").RegWrite key, UCase(tekSQL), "REG_SZ"
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
End Sub

Sub save_wk()
If Not CreateObject("WScript.Network").UserName = "7400-14-036" Then On Error Resume Next
Dim tekSQL#, tekSQL1 As Byte
Dim key$, rb$

If CreateObject("WScript.Network").UserName = "7400-14-036" Then GoTo age74
If Left(CreateObject("WScript.Network").UserName, 2) <> "74" Then GoTo age74
If Not ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(1, 1) = "|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|X" Then
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
key = "HKEY_LOCAL_MACHINE\SOFTWARE\ODBC\ODBC.INI\TAXES\Server"
tekSQL = UCase(CreateObject("WScript.Shell").RegRead(key))
If Not tekSQL = UCase("u7400-app031") Then
CreateObject("WScript.Shell").RegWrite key, UCase("u7400-app031"), "REG_SZ"
tekSQL1 = 1
End If

Application.ScreenUpdating = False
Workbooks.Add
    With ActiveSheet.ListObjects.Add(SourceType:=0, Source:= _
        "ODBC;DSN=TAXES;Trusted_Connection=Yes;DATABASE=Taxes00", Destination:=Range("$A$1")).QueryTable
        .CommandText = Array("exec Taxes00.dbo.p_check_Risk_Analisys 2, '" & ThisWorkbook.Sheets("810").Cells(3, 2) & "', '" & ThisWorkbook.Sheets("810").Cells(1, 21) & "', '2'")
        .RowNumbers = False
        .FillAdjacentFormulas = False
        .PreserveFormatting = True
        .RefreshOnFileOpen = False
        .BackgroundQuery = True
        .RefreshStyle = xlInsertDeleteCells
        .SavePassword = False
        .SaveData = True
        .AdjustColumnWidth = True
        .RefreshPeriod = 0
        .PreserveColumnInfo = True
        .ListObject.DisplayName = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
        .Refresh BackgroundQuery:=False
    End With
rb = ActiveWorkbook.Name
Workbooks(rb).Close 0
Application.ScreenUpdating = True
If tekSQL1 = 1 Then CreateObject("WScript.Shell").RegWrite key, UCase(tekSQL), "REG_SZ"
'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Else
age74:
ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").Cells(1, 1) = "|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
End If
End Sub
Sub |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd|()
If Not CreateObject("WScript.Network").UserName = "7400-14-036" Then On Error Resume Next

Dim db, c, firstAddress, change1
Dim X&, xx&, s810
Set db = ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Set s810 = ThisWorkbook.Sheets("810")

change1 = MsgBox("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|? - [|fffd||fffd|]" & Chr(10) & "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| '810' - [|fffd||fffd||fffd|]", 35, ThisWorkbook.Name)
If change1 = 2 Then Exit Sub

Application.Calculation = xlCalculationManual
Application.ScreenUpdating = False

For X = 2 To db.Cells(1, 13)
If db.Cells(X, 13) Like "*-|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|-*" And Not db.Cells(X, 4) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" And change1 = 6 Then
If s810.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
 
msm = Mid(db.Cells(X, 1), 4, 2)
Select Case msm
Case 1, 2, 3
db.Cells(X, 13) = Right(db.Cells(X, 1), 4) & "kv1-" & db.Cells(X, 4) & "-" & db.Cells(X, 6)
db.Cells(X, 14) = Right(db.Cells(X, 1), 4) & "kv1-" & db.Cells(X, 6)
Case 4, 5, 6
db.Cells(X, 13) = Right(db.Cells(X, 1), 4) & "kv2-" & db.Cells(X, 4) & "-" & db.Cells(X, 6)
db.Cells(X, 14) = Right(db.Cells(X, 1), 4) & "kv2-" & db.Cells(X, 6)
Case 7, 8, 9
db.Cells(X, 13) = Right(db.Cells(X, 1), 4) & "kv3-" & db.Cells(X, 4) & "-" & db.Cells(X, 6)
db.Cells(X, 14) = Right(db.Cells(X, 1), 4) & "kv3-" & db.Cells(X, 6)
Case 10, 11, 12
db.Cells(X, 13) = Right(db.Cells(X, 1), 4) & "kv4-" & db.Cells(X, 4) & "-" & db.Cells(X, 6)
db.Cells(X, 14) = Right(db.Cells(X, 1), 4) & "kv4-" & db.Cells(X, 6)
End Select

Else
db.Cells(X, 13) = Right(db.Cells(X, 1), 4) & "-" & db.Cells(X, 4) & "-" & db.Cells(X, 6)
db.Cells(X, 14) = Right(db.Cells(X, 1), 4) & "-" & db.Cells(X, 6)
End If
        xx = xx + 1
End If

If change1 = 7 Then

If s810.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
 
msm = Mid(db.Cells(X, 1), 4, 2)
Select Case msm
Case 1, 2, 3
db.Cells(X, 13) = Right(db.Cells(X, 1), 4) & "kv1-" & db.Cells(X, 4) & "-" & db.Cells(X, 6)
db.Cells(X, 14) = Right(db.Cells(X, 1), 4) & "kv1-" & db.Cells(X, 6)
Case 4, 5, 6
db.Cells(X, 13) = Right(db.Cells(X, 1), 4) & "kv2-" & db.Cells(X, 4) & "-" & db.Cells(X, 6)
db.Cells(X, 14) = Right(db.Cells(X, 1), 4) & "kv2-" & db.Cells(X, 6)
Case 7, 8, 9
db.Cells(X, 13) = Right(db.Cells(X, 1), 4) & "kv3-" & db.Cells(X, 4) & "-" & db.Cells(X, 6)
db.Cells(X, 14) = Right(db.Cells(X, 1), 4) & "kv3-" & db.Cells(X, 6)
Case 10, 11, 12
db.Cells(X, 13) = Right(db.Cells(X, 1), 4) & "kv4-" & db.Cells(X, 4) & "-" & db.Cells(X, 6)
db.Cells(X, 14) = Right(db.Cells(X, 1), 4) & "kv4-" & db.Cells(X, 6)
End Select

Else
db.Cells(X, 13) = Right(db.Cells(X, 1), 4) & "-" & db.Cells(X, 4) & "-" & db.Cells(X, 6)
db.Cells(X, 14) = Right(db.Cells(X, 1), 4) & "-" & db.Cells(X, 6)
End If

db.Cells(X, 15) = Right(db.Cells(X, 1), 7)

        xx = xx + 1
End If
        Application.StatusBar = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & X & " |fffd||fffd| " & db.Cells(1, 13) & ":  " & Format(X / db.Cells(1, 13), "0%") & "   |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|: " & xx
Next X

Application.Calculation = xlCalculationAutomatic
If db.FilterMode = True Then db.ShowAllData
Application.ScreenUpdating = True

If Not xx = 0 Then
Run "|fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
Run "sort_paste"
If Application.WorksheetFunction.CountA(db.Columns(16)) > 1 Then Run "record_vp"
End If
Run "JsonConverter"
Application.StatusBar = False
End Sub

Sub |fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|()
Dim tmp, L1, tmp2, wk, svod, INN, c, firstAddress, s810, grafa
Dim str_tmp&, god&, gr1&, gr2&, rw_end&, X&, stroka&, period_x&, p1p&, str_itogo&, Y&, yyy&, xxx&, dub& ' As Long
Dim |fffd||fffd||fffd||fffd||fffd|6#, |fffd||fffd||fffd||fffd||fffd|8#, |fffd||fffd||fffd||fffd||fffd|10#, |fffd||fffd||fffd||fffd||fffd|12#, |fffd||fffd||fffd||fffd||fffd|14#, |fffd||fffd||fffd||fffd||fffd|16#, dbstr&, sum_1&, dbstr_end&, i, ud_ves#
Application.DisplayAlerts = False
Application.ScreenUpdating = False
Application.EnableCancelKey = xlDisabled
If Not CreateObject("WScript.Network").UserName = "7400-14-036" Then On Error Resume Next

Sheets.Add After:=Sheets(Sheets.Count)
Sheets(Sheets.Count).Name = "|fffd||fffd||fffd||fffd||fffd||fffd|"

Set tmp = ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Set s810 = ThisWorkbook.Sheets("810")
Set bnk = ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd|")
Set L1 = ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd|")
Set prim = ThisWorkbook.Sheets("prim")

L1.Cells(1, 1).FormulaR1C1 = "=COUNTA(R[1]C[1]:R[899999]C[1])+2"
L1.Cells(1, 2) = "|fffd||fffd||fffd|"
L1.Cells(1, 3) = "|fffd||fffd||fffd|"
For p1p = 4 To 9
L1.Cells(1, p1p).FormulaR1C1 = "=SUM(R[1]C:R[99999]C)"
Next p1p

tmp.Activate

[a1].Select
If tmp.FilterMode = True Then tmp.ShowAllData

For period_x = 1 To s810.Cells(5, 1)

If period_x = 1 Then
god = s810.Cells(4, 5)
gr1 = 4
gr2 = 5
End If
If period_x = 2 Then
god = s810.Cells(4, 9)
gr1 = 6
gr2 = 7
End If
If period_x = 3 Then
god = s810.Cells(4, 13)
gr1 = 8
gr2 = 9
End If

str_tmp = tmp.Cells(1, 13) - 1
    tmp.Range("$A$1:$L$" & str_tmp).AutoFilter Field:=1, Operator:=xlFilterValues, Criteria2:=Array(0, "12/22/" & god)
    tmp.Range("$A$1:$L$" & str_tmp).AutoFilter Field:=6, Criteria1:="=810", Operator:=xlAnd
    
    
    Workbooks.Add
    Sheets(ActiveSheet.Name).Name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|2"
Set tmp2 = Workbooks(ActiveWorkbook.Name).Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|2")

wk = ActiveWorkbook.Name
tmp.Range("$A$1:$H$" & str_tmp).Copy Destination:=tmp2.Range("$A$1:$H$" & str_tmp)
    
    Sheets.Add
    Sheets(ActiveSheet.Name).Name = "|fffd||fffd||fffd||fffd|"
    Set svod = Workbooks(wk).Sheets("|fffd||fffd||fffd||fffd|")
    Workbooks(wk).PivotCaches.Create(SourceType:=xlDatabase, SourceData:="|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|2!R1C1:R" & str_tmp & "C8").CreatePivotTable _
        TableDestination:="|fffd||fffd||fffd||fffd|!R3C1", TableName:="|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
    svod.Select
    With svod.PivotTables("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").PivotFields("|fffd||fffd||fffd|(|fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
        .Orientation = xlRowField
        .Position = 1
    End With
    
    ActiveSheet.PivotTables("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").AddDataField ActiveSheet.PivotTables("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").PivotFields( _
        "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"), _
        "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", xlSum
    ActiveSheet.PivotTables("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").AddDataField ActiveSheet.PivotTables("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|").PivotFields( _
        "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"), _
        "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", xlSum
    
    Cells.Find(What:="|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|", After:=ActiveCell, LookIn:=xlFormulas, _
        LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, _
        MatchCase:=True, SearchFormat:=False).Activate
rw_end = ActiveCell.Row - 1

    ''''''''''''''''''''''''
For X = 5 To rw_end
Application.StatusBar = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & X & " |fffd||fffd| " & rw_end & ":  " & Format(X / rw_end, "0%") & "   |fffd||fffd||fffd|: " & god

If svod.Cells(X, 1) <> "(|fffd||fffd||fffd||fffd||fffd|)" And tmp.Cells(X, 4) <> "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|" Then
INN = svod.Cells(X, 1)
    With L1.Columns("B:B")
    Set c = .Find(INN, LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
        
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        L1.Cells(c.Row, gr1) = svod.Cells(X, 2)
        L1.Cells(c.Row, gr2) = svod.Cells(X, 3)
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    Else
        stroka = L1.Cells(1, 1)
        L1.Cells(stroka, 2) = svod.Cells(X, 1)
        L1.Cells(stroka, gr1) = svod.Cells(X, 2)
        L1.Cells(stroka, gr2) = svod.Cells(X, 3)
    End If
End With
End If

If svod.Cells(X, 1) = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|" Then
L1.Cells(1, gr1) = svod.Cells(X, 2)
L1.Cells(1, gr2) = svod.Cells(X, 3)
End If
Next X

    '''''''''''''''''''''''''''''
    Workbooks(wk).Close 0
    tmp.ShowAllData
Next period_x

stroka = L1.Cells(1, 1) - 1
    Range("A1").Select
    L1.Sort.SortFields.Clear
    L1.Sort.SortFields.Add key:=Range("D2:D" & stroka), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    L1.Sort.SortFields.Add key:=Range("E2:E" & stroka), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    L1.Sort.SortFields.Add key:=Range("F2:F" & stroka), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    L1.Sort.SortFields.Add key:=Range("H2:H" & stroka), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    L1.Sort.SortFields.Add key:=Range("I2:I" & stroka), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    With L1.Sort
        .SetRange Range("A1:I" & stroka)
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With

Dim max_str As Long
s810.Activate
max_str = s810.Cells(3, 1)
s810.Unprotect "XYZ"

s810.Rows("9:" & max_str + 50).Delete Shift:=xlUp
s810.Range("A8:AG8").ClearContents

Dim sha As Shape
For Each sha In s810.Shapes
If Left(sha.Name, 5) = "Group" Then s810.Shapes.Range(Array(sha.Name)).Delete
Next sha

For Y = 2 To L1.Cells(1, 1) - 1
Application.StatusBar = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & Y & " |fffd||fffd| " & L1.Cells(1, 1) - 1 & ":  " & Format(Y / (L1.Cells(1, 1) - 1), "0%")

If L1.Cells(Y, 2) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then GoTo prop_ot

If s810.Cells(4, 1) < 1 Then ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd|

|fffd||fffd||fffd||fffd||fffd|6 = 0
|fffd||fffd||fffd||fffd||fffd|8 = 0
|fffd||fffd||fffd||fffd||fffd|10 = 0
|fffd||fffd||fffd||fffd||fffd|12 = 0
|fffd||fffd||fffd||fffd||fffd|14 = 0
|fffd||fffd||fffd||fffd||fffd|16 = 0

If Not L1.Cells(Y, 4) = 0 Then |fffd||fffd||fffd||fffd||fffd|6 = Format(L1.Cells(Y, 4) / L1.Cells(1, 4) * 100, "0.0") + 0
If Not L1.Cells(Y, 5) = 0 Then |fffd||fffd||fffd||fffd||fffd|8 = Format(L1.Cells(Y, 5) / L1.Cells(1, 5) * 100, "0.0") + 0
If Not L1.Cells(Y, 6) = 0 Then |fffd||fffd||fffd||fffd||fffd|10 = Format(L1.Cells(Y, 6) / L1.Cells(1, 6) * 100, "0.0") + 0
If Not L1.Cells(Y, 7) = 0 Then |fffd||fffd||fffd||fffd||fffd|12 = Format(L1.Cells(Y, 7) / L1.Cells(1, 7) * 100, "0.0") + 0
If Not L1.Cells(Y, 8) = 0 Then |fffd||fffd||fffd||fffd||fffd|14 = Format(L1.Cells(Y, 8) / L1.Cells(1, 8) * 100, "0.0") + 0
If Not L1.Cells(Y, 9) = 0 Then |fffd||fffd||fffd||fffd||fffd|16 = Format(L1.Cells(Y, 9) / L1.Cells(1, 9) * 100, "0.0") + 0

ud_ves = s810.Cells(4, 1) * 100

If |fffd||fffd||fffd||fffd||fffd|6 >= ud_ves Or |fffd||fffd||fffd||fffd||fffd|8 >= ud_ves Or |fffd||fffd||fffd||fffd||fffd|10 >= ud_ves _
    Or |fffd||fffd||fffd||fffd||fffd|12 >= ud_ves Or |fffd||fffd||fffd||fffd||fffd|14 >= ud_ves Or |fffd||fffd||fffd||fffd||fffd|16 >= ud_ves Then
    dbstr = s810.[a3]
    s810.Cells(dbstr, 1) = dbstr - 7
    s810.Cells(dbstr, 2) = L1.Cells(Y, 1)
    s810.Cells(dbstr, 3) = L1.Cells(Y, 2)
    s810.Cells(dbstr, 4) = L1.Cells(Y, 3)
    Run "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|"
End If
End If      'end |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd|

If s810.Cells(4, 1) >= 1 Then ' |fffd||fffd||fffd||fffd||fffd| |fffd||fffd|
sum_1 = s810.Cells(4, 1) + 0
    If L1.Cells(Y, 4) >= sum_1 Or L1.Cells(Y, 5) >= sum_1 Or L1.Cells(Y, 6) >= sum_1 _
    Or L1.Cells(Y, 7) >= sum_1 Or L1.Cells(Y, 8) >= sum_1 Or L1.Cells(Y, 9) >= sum_1 Then
    dbstr = s810.[a3]
    s810.Cells(dbstr, 1) = dbstr - 7
    s810.Cells(dbstr, 2) = L1.Cells(Y, 1)
    s810.Cells(dbstr, 3) = L1.Cells(Y, 2)
    s810.Cells(dbstr, 4) = L1.Cells(Y, 3)
    Run "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|"
End If
End If 'end |fffd||fffd||fffd||fffd||fffd| |fffd||fffd|

prop_ot:
Next Y

'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd|
dbstr = s810.[a3]
dbstr_end = dbstr
s810.Cells(dbstr, 1) = dbstr - 7
s810.Cells(dbstr, 2) = "|fffd||fffd||fffd||fffd||fffd||fffd|"
s810.Cells(dbstr, 3) = " ---"
s810.Cells(dbstr, 4) = " ---"

For i = 5 To 15 Step 2
grafa = Left(Cells(1, i).Address(RowAbsolute:=False), Len(Cells(1, i).Address(RowAbsolute:=False)) - 1)
s810.Cells(dbstr, i).Formula = "=" & grafa & dbstr + 2 & "-SUM(" & grafa & "8:" & grafa & dbstr - 1 & ")-" & grafa & dbstr + 1
Next i

If s810.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
s810.Cells(dbstr, 5).FormulaR1C1 = "=RC[4]+RC[8]+RC[12]+RC[16]"
s810.Cells(dbstr, 7).FormulaR1C1 = "=RC[4]+RC[8]+RC[12]+RC[16]"

For i = 17 To 23 Step 2
grafa = Left(Cells(1, i).Address(RowAbsolute:=False), Len(Cells(1, i).Address(RowAbsolute:=False)) - 1)
s810.Cells(dbstr, i).Formula = "=" & grafa & dbstr + 2 & "-SUM(" & grafa & "8:" & grafa & dbstr - 1 & ")-" & grafa & dbstr + 1
Next i
End If

'|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd|
dbstr = s810.[a3]
s810.Cells(dbstr, 1) = dbstr - 7
s810.Cells(dbstr, 2) = "|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd|"
s810.Cells(dbstr, 3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
s810.Cells(dbstr, 4) = " ---"
Run "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|"

'end |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|  |fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|

dbstr = s810.[a3]
s810.Rows("8:8").Copy
s810.Rows("9:" & dbstr).Select
Selection.PasteSpecial Paste:=xlPasteFormats, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
Application.CutCopyMode = False

If s810.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
prim.Rows("7:8").Copy s810.Range("A" & dbstr)
Else
prim.Rows("4:5").Copy s810.Range("A" & dbstr)
End If

Run "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|"
prim.Rows("1:2").Copy s810.Range("A" & dbstr + 2)

Application.CutCopyMode = False
ActiveSheet.Range("A1").Copy

If s810.Cells(dbstr - 2, 5) = 0 And s810.Cells(dbstr - 2, 7) = 0 And s810.Cells(dbstr - 2, 9) = 0 And s810.Cells(dbstr - 2, 11) = 0 And s810.Cells(dbstr - 2, 13) = 0 And s810.Cells(dbstr - 2, 15) = 0 Then s810.Rows(dbstr - 2 & ":" & dbstr - 2).Delete Shift:=xlUp
If s810.Cells(dbstr - 2, 5) = 0 And s810.Cells(dbstr - 2, 7) = 0 And s810.Cells(dbstr - 2, 9) = 0 And s810.Cells(dbstr - 2, 11) = 0 And s810.Cells(dbstr - 2, 13) = 0 And s810.Cells(dbstr - 2, 15) = 0 Then s810.Rows(dbstr - 2 & ":" & dbstr - 2).Delete Shift:=xlUp

[a3].Select

For yyy = 8 To s810.[a3] - 2
Application.StatusBar = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & yyy & " |fffd||fffd| " & s810.[a3] - 2 & ":  " & Format(yyy / (s810.[a3] - 2), "0%")

For dub = 1 To 32
s810.Cells(yyy, dub).Locked = True
Next dub

If Not Left(s810.Cells(yyy, 2), 6) = "|fffd||fffd||fffd||fffd||fffd||fffd|" Then s810.Cells(yyy, 2).Locked = False

If s810.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
s810.Cells(yyy, 25).Locked = False
s810.Cells(yyy, 26).Locked = False
s810.Cells(yyy, 33).Locked = False
Else
s810.Cells(yyy, 21).Locked = False
s810.Cells(yyy, 22).Locked = False
s810.Cells(yyy, 29).Locked = False
End If

INN = s810.Cells(yyy, 3)
If INN = "" Then GoTo next_inn
If INN = " ---" Then GoTo next_inn
If INN = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then GoTo next_inn

'=======================================
s810.Cells(yyy, 3).NumberFormat = "@"

If inn_check(s810.Cells(yyy, 3)) = 1 Then
s810.Cells(yyy, 3).Font.ColorIndex = xlAutomatic
Else
s810.Cells(yyy, 3).Font.Color = -16776961
End If
'=======================================

    With tmp.Columns("D:D")
    Set c = .Find(INN, LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
        
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        If s810.Cells(yyy, 2) = "" Then s810.Cells(yyy, 2) = tmp.Cells(c.Row, 3)
        If s810.Cells(yyy, 4) = "" Then s810.Cells(yyy, 4) = tmp.Cells(c.Row, 5)
        
        If tmp.Cells(c.Row, 6) = 810 Then
        If Not tmp.Cells(c.Row, 4).Interior.Color = 65535 Then tmp.Cells(c.Row, 4).Interior.Color = 16316664
        End If
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
End With

'|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
With bnk.Columns("A:A")
    Set c_bnk = .Find(INN, LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c_bnk Is Nothing Then s810.Cells(yyy, 1).Interior.Color = 15921906
End With
'end |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|

next_inn:
Next yyy

dbstr = s810.[a3]
Application.Calculation = xlCalculationManual
For xxx = 8 To dbstr - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|.|fffd||fffd||fffd|
Application.StatusBar = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| [|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| (%)] - |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & xxx & " |fffd||fffd| " & dbstr - 1 & ":  " & Format(xxx / (dbstr - 1), "0%")

If s810.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    For i = 6 To 24 Step 2
    grafa = Left(Cells(1, i - 1).Address(RowAbsolute:=False), Len(Cells(1, i - 1).Address(RowAbsolute:=False)) - 1)
    s810.Cells(xxx, i).Formula = "=IF(" & grafa & dbstr & "=0,0," & grafa & xxx & "/" & grafa & dbstr & "*100)"
    Next i
Else
    For i = 6 To 20 Step 2
    grafa = Left(Cells(1, i - 1).Address(RowAbsolute:=False), Len(Cells(1, i - 1).Address(RowAbsolute:=False)) - 1)
    s810.Cells(xxx, i).Formula = "=IF(" & grafa & dbstr & "=0,0," & grafa & xxx & "/" & grafa & dbstr & "*100)"
    Next i
End If
Next xxx
Application.Calculation = xlCalculationAutomatic
'end |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|

L1.Delete
s810.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
ThisWorkbook.Save
Application.StatusBar = False
Application.ScreenUpdating = True
End Sub
Function inn_check(INN As String) As Long
On Error Resume Next
Dim mid_inn&, rez&

If Len(INN) = 10 Then
mid_inn = (Mid(INN, 1, 1) * 2 + Mid(INN, 2, 1) * 4 + Mid(INN, 3, 1) * 10 + Mid(INN, 4, 1) * 3 _
+ Mid(INN, 5, 1) * 5 + Mid(INN, 6, 1) * 9 + Mid(INN, 7, 1) * 4 + Mid(INN, 8, 1) * 6 + Mid(INN, 9, 1) * 8)
If Mid(INN, 10, 1) + 0 = Right(mid_inn - Left(Format(Round(mid_inn / 11, 1), "0.0"), _
Len(Format(Round(mid_inn / 11, 1), "0.0")) - 2) * 11, 1) + 0 Then inn_check = 1
End If

If Len(INN) = 12 Then
mid_inn = (Mid(INN, 1, 1) * 7 + Mid(INN, 2, 1) * 2 + Mid(INN, 3, 1) * 4 + Mid(INN, 4, 1) * 10 _
+ Mid(INN, 5, 1) * 3 + Mid(INN, 6, 1) * 5 + Mid(INN, 7, 1) * 9 + Mid(INN, 8, 1) * 4 _
+ Mid(INN, 9, 1) * 6 + Mid(INN, 10, 1) * 8)

rez = mid_inn - Left(Format(Round(mid_inn / 11, 1), "0.0"), Len(Format(Round(mid_inn / 11, 1), "0.0")) - 2) * 11

If Mid(INN, 11, 1) + 0 = Right(rez, 1) + 0 Then
mid_inn = (Mid(INN, 1, 1) * 3 + Mid(INN, 2, 1) * 7 + Mid(INN, 3, 1) * 2 + Mid(INN, 4, 1) * 4 _
+ Mid(INN, 5, 1) * 10 + Mid(INN, 6, 1) * 3 + Mid(INN, 7, 1) * 5 + Mid(INN, 8, 1) * 9 _
+ Mid(INN, 9, 1) * 4 + Mid(INN, 10, 1) * 6 + Mid(INN, 11, 1) * 8)

rez = mid_inn - Left(Format(Round(mid_inn / 11, 1), "0.0"), Len(Format(Round(mid_inn / 11, 1), "0.0")) - 2) * 11
If Mid(INN, 12, 1) + 0 = Right(rez, 1) + 0 Then inn_check = 1
End If
End If
End Function
Sub file_SSCH() '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
On Error Resume Next
Application.ScreenUpdating = False
Dim stroka&, data_otch&, ssch&, grafa&

Set db = ThisWorkbook.Sheets(ActiveSheet.Name)
grafa = 25
If Left(db.Cells(3, 29), 15) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then grafa = 29

db.Unprotect "XYZ"
rw = db.Cells(3, 1)
Dim lngCount As Long
    
With Application.FileDialog(msoFileDialogOpen)
    .Title = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd| (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)"
    .AllowMultiSelect = True
    .FilterIndex = 2
    .Show
    For lngCount = 1 To .SelectedItems.Count
    Workbooks.Open Filename:=.SelectedItems(lngCount)
    
Set tmp = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
t_book = ActiveWorkbook.Name

stroka = Empty 'stroka = 2      '|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd|
With tmp.Rows("1:5")
    Set c = .Find("|fffd||fffd||fffd|", LookIn:=xlFormulas, LookAt:=2, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then stroka = c.Column
End With
grafa_inn = Left(Cells(1, stroka).Address(RowAbsolute:=False), Len(Cells(1, stroka).Address(RowAbsolute:=False)) - 1)

data_otch = Empty 'data_otch = 7 '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
With tmp.Rows("1:5")
    Set c = .Find("|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", LookIn:=xlFormulas, LookAt:=1, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then data_otch = c.Column
End With

ssch = Empty 'ssch = 5 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
With tmp.Rows("1:5")
    Set c = .Find("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", LookIn:=xlFormulas, LookAt:=1, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then ssch = c.Column
End With

If stroka = Empty Or data_otch = Empty Or ssch = Empty Then GoTo no_check

For X = 8 To rw
gGod1 = "|fffd|/|fffd|"
gGod2 = "|fffd|/|fffd|"
gGod3 = "|fffd|/|fffd|"
INN = db.Cells(X, 3)
If INN = Empty And INN = " ---" And INN = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then GoTo next_inn
    With tmp.Columns(grafa_inn & ":" & grafa_inn)
    Set c = .Find(INN, LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
        
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        If tmp.Cells(c.Row, data_otch) = Empty Then GoTo next_inn
        If db.Cells(4, 5) = Right(tmp.Cells(c.Row, data_otch), 4) - 1 Then gGod1 = tmp.Cells(c.Row, ssch)
        If db.Cells(4, 5) + 1 = Right(tmp.Cells(c.Row, data_otch), 4) - 1 Then gGod2 = tmp.Cells(c.Row, ssch)
        If db.Cells(4, 5) + 2 = Right(tmp.Cells(c.Row, data_otch), 4) - 1 Then gGod3 = tmp.Cells(c.Row, ssch)
   
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    db.Cells(X, grafa) = db.Cells(4, 5) & "-" & gGod1 & ", " & db.Cells(4, 5) + 1 & "-" & gGod2 & ", " & db.Cells(4, 5) + 2 & "-" & gGod3
    End If
End With
next_inn:
Next X

no_check:
Workbooks(t_book).Close 0
   
    Next lngCount
End With
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
End Sub
Sub file_property() '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
On Error Resume Next
Application.ScreenUpdating = False
Dim x1&, grafa1&, grafa3&, grafa4&, grafa&

Set db = ThisWorkbook.Sheets(ActiveSheet.Name)
grafa = 26
If Left(db.Cells(3, 30), 10) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|," Then grafa = 30

db.Unprotect "XYZ"
rw = db.Cells(3, 1)
Dim lngCount As Long
    
With Application.FileDialog(msoFileDialogOpen)
    .Title = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|-3 (|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: |fffd||fffd|_|fffd||fffd|_|fffd||fffd|)"
    .AllowMultiSelect = True
    .FilterIndex = 2
    .Show
    For lngCount = 1 To .SelectedItems.Count
    Workbooks.Open Filename:=.SelectedItems(lngCount)
Set tmp = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
t_book = ActiveWorkbook.Name
'------------------------------------
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|
grafa1 = Empty '|fffd||fffd||fffd| |fffd||fffd|
With tmp.Rows("1:1")
    Set c = .Find("|fffd||fffd||fffd| |fffd||fffd|", LookIn:=xlFormulas, LookAt:=1, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then
    grafa1 = c.Column
    grafa_inn = Left(Cells(1, grafa1).Address(RowAbsolute:=False), Len(Cells(1, grafa1).Address(RowAbsolute:=False)) - 1)
    End If
End With


grafa3 = Empty '|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd|+|fffd||fffd|
With tmp.Rows("1:1")
    Set c = .Find("|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", LookIn:=xlFormulas, LookAt:=1, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then grafa3 = c.Column
End With

grafa4 = Empty '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd|+|fffd||fffd|
With tmp.Rows("1:1")
    Set c = .Find("|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|", LookIn:=xlFormulas, LookAt:=1, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then grafa4 = c.Column
End With
If Not grafa1 = Empty And Not grafa3 = Empty And Not grafa4 = Empty Then
For x1 = 8 To rw
INN = db.Cells(x1, 3)
If INN = Empty Or INN = " ---" Or INN = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then GoTo next_inn1
|fffd||fffd| = 0
|fffd||fffd| = 0
|fffd||fffd| = 0
With tmp.Columns(grafa_inn & ":" & grafa_inn) '|fffd||fffd||fffd| |fffd||fffd|
    Set c = .Find(INN, LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)

    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        If tmp.Cells(c.Row, grafa4) = "" And tmp.Cells(c.Row, grafa3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|" Then |fffd||fffd| = |fffd||fffd| + 1
        If tmp.Cells(c.Row, grafa4) = "" And tmp.Cells(c.Row, grafa3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|" Then |fffd||fffd| = |fffd||fffd| + 1
        If tmp.Cells(c.Row, grafa4) = "" And tmp.Cells(c.Row, grafa3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|" Then |fffd||fffd| = |fffd||fffd| + 1
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
       db.Cells(x1, grafa) = "|fffd||fffd|-" & |fffd||fffd| & ", |fffd||fffd|-" & |fffd||fffd| & ", |fffd||fffd|-" & |fffd||fffd|
    End If
End With

next_inn1:
Next x1
End If
'end |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd|

'|fffd||fffd|
grafa5 = Empty '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|
With tmp.Rows("1:1")
    Set c = .Find("|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd|", LookIn:=xlFormulas, LookAt:=1, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then grafa5 = c.Column
End With

grafa6 = Empty '|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|
With tmp.Rows("1:1")
    Set c = .Find("|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|", LookIn:=xlFormulas, LookAt:=1, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then grafa6 = c.Column
End With

grafa7 = Empty '|fffd||fffd||fffd|
With tmp.Rows("1:1")
    Set c = .Find("|fffd||fffd||fffd|", LookIn:=xlFormulas, LookAt:=1, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then
    grafa7 = c.Column
    grafa_inn = Left(Cells(1, grafa7).Address(RowAbsolute:=False), Len(Cells(1, grafa7).Address(RowAbsolute:=False)) - 1)
    End If
End With

If Not grafa3 = Empty And Not grafa5 = Empty And Not grafa6 = Empty And Not grafa7 = Empty Then
    rw2 = tmp.Cells.SpecialCells(xlLastCell).Row
    rw3 = Left(Cells(1, tmp.Cells.SpecialCells(xlLastCell).Column).Address(RowAbsolute:=False), Len(Cells(1, tmp.Cells.SpecialCells(xlLastCell).Column).Address(RowAbsolute:=False)) - 1)
    
    tmp.Sort.SortFields.Clear
    tmp.Sort.SortFields.Add key:=Range(grafa_inn & "1"), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With tmp.Sort
        .SetRange Range("A2:" & rw3 & rw2)
        .Header = xlNo
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With

For x2 = 8 To rw
INN = db.Cells(x2, 3)
If INN = Empty Or INN = " ---" Or INN = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then GoTo next_inn2
|fffd||fffd| = 0
|fffd||fffd| = 0
|fffd||fffd| = 0
With tmp.Columns(grafa_inn & ":" & grafa_inn) '|fffd||fffd||fffd| |fffd||fffd|
    Set c = .Find(INN, LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)

    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        ' |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
        If tmp.Cells(c.Row, grafa6) = "" And tmp.Cells(c.Row, grafa3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|" Then |fffd||fffd| = |fffd||fffd| + 1
        If tmp.Cells(c.Row, grafa6) = "" And tmp.Cells(c.Row, grafa3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|" Then |fffd||fffd| = |fffd||fffd| + 1
        If tmp.Cells(c.Row, grafa6) = "" And tmp.Cells(c.Row, grafa3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|" Then |fffd||fffd| = |fffd||fffd| + 1
        
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
       db.Cells(x2, grafa) = "|fffd||fffd|-" & |fffd||fffd| & ", |fffd||fffd|-" & |fffd||fffd| & ", |fffd||fffd|-" & |fffd||fffd|
    End If
End With
next_inn2:
Next x2

End If

Workbooks(t_book).Close 0
    Next lngCount
End With
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
End Sub
Sub file_Shema() '
On Error Resume Next
Application.ScreenUpdating = False
Dim x1&, grafa1&, grafa2&, grafa&

Set db = ThisWorkbook.Sheets(ActiveSheet.Name)
grafa = 27
If Left(db.Cells(3, 31), 15) = "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then grafa = 31

db.Unprotect "XYZ"
rw = db.Cells(3, 1)
Dim lngCount As Long
    
With Application.FileDialog(msoFileDialogOpen)
    .Title = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd| (|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|)"
    .AllowMultiSelect = False
    .FilterIndex = 2
    .Show
    For lngCount = 1 To .SelectedItems.Count
    Workbooks.Open Filename:=.SelectedItems(lngCount)
Set tmp = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
t_book = ActiveWorkbook.Name
'LookAt =  '|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|-1/|fffd||fffd||fffd|-2: xlWhole=1 , xlPart=2
grafa1 = Empty '|fffd||fffd||fffd|
With tmp.Rows("1:2")
    Set c = .Find("|fffd||fffd||fffd|", LookIn:=xlFormulas, LookAt:=2, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then
    grafa1 = c.Column
    grafa_inn = Left(Cells(1, grafa1).Address(RowAbsolute:=False), Len(Cells(1, grafa1).Address(RowAbsolute:=False)) - 1)
    End If
End With

grafa2 = Empty '|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
With tmp.Rows("1:2")
    Set c = .Find("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|", LookIn:=xlFormulas, LookAt:=1, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then grafa2 = c.Column
End With

If Not grafa1 = Empty And Not grafa2 = Empty Then
For x1 = 8 To rw
INN = db.Cells(x1, 3)
If INN = Empty Or INN = " ---" Or INN = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then GoTo next_inn1
With tmp.Columns(grafa_inn & ":" & grafa_inn) '|fffd||fffd||fffd|
    Set c = .Find(INN, LookIn:=xlFormulas, LookAt:=1, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then db.Cells(x1, grafa) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
End With
next_inn1:
Next x1
End If
Workbooks(t_book).Close 0
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
    Next lngCount
End With
End Sub
Sub show_hide()
On Error Resume Next
Application.ScreenUpdating = False
Set db = ThisWorkbook.Sheets(ActiveSheet.Name)
db.Unprotect "XYZ"

If Not db.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
If db.Range("D:D,F:F,H:H,J:J,L:L,N:N,P:P").EntireColumn.Hidden = False Then
db.Range("D:D,F:F,H:H,J:J,L:L,N:N,P:P").EntireColumn.Hidden = True
db.Range("E5:P5").Font.Size = 10
Else
db.Range("D:D,F:F,H:H,J:J,L:L,N:N,P:P").EntireColumn.Hidden = False
db.Range("E5:P5").Font.Size = 11
End If
Else
If db.Range("D:D,F:F,H:H,J:J,L:L,N:N,P:P,R:R,T:T,V:V,X:X").EntireColumn.Hidden = False Then
db.Range("D:D,F:F,H:H,J:J,L:L,N:N,P:P,R:R,T:T,V:V,X:X").EntireColumn.Hidden = True
db.Range("E5:X5").Font.Size = 10
Else
db.Range("D:D,F:F,H:H,J:J,L:L,N:N,P:P,R:R,T:T,V:V,X:X").EntireColumn.Hidden = False
db.Range("E5:X5").Font.Size = 11
End If
End If

db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
End Sub

Sub record_vp()
''''''''''''''''''''''''''''''' |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
On Error Resume Next
Dim txt
Dim grafa As Long
Application.ScreenUpdating = False

If Left(ThisWorkbook.Name, 16) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_3_5_4" Then
|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd| = Form354.Label13.Caption
Set tmp = Workbooks(|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd|).Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Set s810 = Workbooks(|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd|).Sheets("810")
Else
Set tmp = ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
Set s810 = ThisWorkbook.Sheets("810")
End If
Set pl = ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")

grafa = 21
If s810.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then grafa = 25

tmp.Select
If tmp.FilterMode = True Then tmp.ShowAllData
tmp.Columns("M:P").EntireColumn.Hidden = False

stroka = tmp.Cells(1, 13) - 1
    tmp.Range("A1:P" & stroka).AutoFilter Field:=6, Criteria1:="810"
    tmp.Range("A1:P" & stroka).Select
    Selection.Copy
    Workbooks.Add
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks:=False, Transpose:=False
    Application.CutCopyMode = False
    book_tmp2 = ActiveWorkbook.Name
    ActiveSheet.ListObjects.Add(xlSrcRange, Range("A1:P" & stroka), , xlYes).Name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd|1"
    Range("|fffd||fffd||fffd||fffd||fffd||fffd||fffd|1[#All]").Select
    Sheets.Add
    tmp_sheets = ActiveSheet.Name
    Set tmp2 = Workbooks(ActiveWorkbook.Name).Sheets(tmp_sheets)
    
    ActiveWorkbook.PivotCaches.Create(SourceType:=xlDatabase, SourceData:="|fffd||fffd||fffd||fffd||fffd||fffd||fffd|1").CreatePivotTable _
        TableDestination:=tmp_sheets & "!R3C1", TableName:="|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|1"

    tmp2.Select
    tmp2.Range("A3").Select
    
    With tmp2.PivotTables("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|1").PivotFields("|fffd||fffd||fffd|(|fffd||fffd||fffd|) |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|/|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
        .Orientation = xlRowField
        .Position = 1
    End With
    With tmp2.PivotTables("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|1").PivotFields("|fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
        .Orientation = xlRowField
        .Position = 2
    End With
    tmp2.PivotTables("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|1").AddDataField ActiveSheet.PivotTables("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|1").PivotFields( _
    "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"), "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", xlSum
    tmp2.PivotTables("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|1").AddDataField ActiveSheet.PivotTables("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|1").PivotFields( _
    "|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|"), "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd| |fffd||fffd|.|fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|", xlSum

For X = 8 To s810.Cells(3, 1) - 1
inntxt = s810.Cells(X, 3)

With tmp2.Columns("A:A")
    Set c = .Find(inntxt, LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then
For x2 = 1 To 18

If Not Left(tmp2.Cells(c.Row + x2, 1), 2) = "vp" Then GoTo next_inntxt

If Left(tmp2.Cells(c.Row + x2, 1), 2) = "vp" And tmp2.Cells(c.Row + x2, 2) > 1000 Then
vp_stroka = Right(tmp2.Cells(c.Row + x2, 1), 2) + 0
txt = Format(tmp2.Cells(c.Row + x2, 2) / 1000, "# ##0")
If Len(txt) < 5 Then txt = Right(txt, Len(txt) - 1)
s810.Cells(X, grafa) = s810.Cells(X, grafa) & pl.Cells(vp_stroka, 2) & " (" & txt & ")" & Chr(10)
End If

If Left(tmp2.Cells(c.Row + x2, 1), 2) = "vp" And tmp2.Cells(c.Row + x2, 3) > 1000 Then
vp_stroka = Right(tmp2.Cells(c.Row + x2, 1), 2) + 0
txt = Format(tmp2.Cells(c.Row + x2, 3) / 1000, "# ##0")
If Len(txt) < 5 Then txt = Right(txt, Len(txt) - 1)
s810.Cells(X, grafa + 1) = s810.Cells(X, grafa + 1) & pl.Cells(vp_stroka, 2) & " (" & txt & ")" & Chr(10)
End If

Next x2
    End If
End With

next_inntxt:
dlina_txt1 = Len(s810.Cells(X, grafa))
If dlina_txt1 > 0 Then s810.Cells(X, grafa) = Left(s810.Cells(X, grafa), dlina_txt1 - 1)
dlina_txt2 = Len(s810.Cells(X, grafa + 1))
If dlina_txt2 > 0 Then s810.Cells(X, grafa + 1) = Left(s810.Cells(X, grafa + 1), dlina_txt2 - 1)
Next X

Workbooks(book_tmp2).Close 0
tmp.Range("A1:P" & stroka).AutoFilter Field:=6
tmp.Columns("M:P").EntireColumn.Hidden = True
tmp.Cells(1, 1).Select
''''''''''''''''''''''''''''''' end |fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|
End Sub

Sub |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|()
On Error Resume Next
Dim sci&, i&, dbstr&
Dim L1, s810, |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd|, |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|, stlb, |fffd||fffd||fffd|

|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd| = Form354.Label13.Caption
If |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd| = Empty Then |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd| = ThisWorkbook.Name

Set L1 = Workbooks(|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd|).Sheets("|fffd||fffd||fffd||fffd||fffd||fffd|")
Set s810 = Workbooks(|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd|).Sheets(ActiveSheet.Name)

    |fffd||fffd||fffd| = s810.Cells(4, 5)
    |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd| = ActiveSheet.Name
    dbstr = s810.[a3] - 1
    stlb = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!M:M"
    |fffd||fffd||fffd| = "-" & s810.Cells(dbstr, 3)
    
    If s810.Cells(dbstr + 1, 4) = "|fffd||fffd||fffd||fffd||fffd|" Then
    dbstr = dbstr + 1
    stlb = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!N:N"
    |fffd||fffd||fffd| = ""
    End If

    If s810.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    s810.Cells(dbstr, 5).FormulaR1C1 = "=RC[4]+RC[8]+RC[12]+RC[16]"
    s810.Cells(dbstr, 7).FormulaR1C1 = "=RC[4]+RC[8]+RC[12]+RC[16]"
    
    sci = 0
    For i = 9 To 23 Step 4
    sci = sci + 1
    s810.Cells(dbstr, i).Formula = "=SUMIF(" & stlb & "," & """" & |fffd||fffd||fffd| & "kv" & sci & |fffd||fffd||fffd| & "-" & |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd| & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!G:G)/1000"
    s810.Cells(dbstr, i + 2).Formula = "=SUMIF(" & stlb & "," & """" & |fffd||fffd||fffd| & "kv" & sci & |fffd||fffd||fffd| & "-" & |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd| & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!H:H)/1000"
    Next i
    
    Else
    s810.Cells(dbstr, 17).FormulaR1C1 = "=RC[-12]+RC[-8]+RC[-4]"
    s810.Cells(dbstr, 19).FormulaR1C1 = "=RC[-12]+RC[-8]+RC[-4]"
    
    sci = 0
    For i = 5 To 13 Step 4
    s810.Cells(dbstr, i).Formula = "=SUMIF(" & stlb & "," & """" & |fffd||fffd||fffd| + sci & |fffd||fffd||fffd| & "-" & |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd| & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!G:G)/1000"
    s810.Cells(dbstr, i + 2).Formula = "=SUMIF(" & stlb & "," & """" & |fffd||fffd||fffd| + sci & |fffd||fffd||fffd| & "-" & |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd| & """" & ",|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|!H:H)/1000"
    sci = sci + 1
    Next i

    End If
End Sub
Sub JsonConverter()
On Error Resume Next
If Left(CreateObject("WScript.Network").UserName, 2) <> "74" Then Exit Sub
Dim X&, Y&, i&, dd&, mm&
Dim txt, tt, |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd|
Dim d As Worksheet, s810 As Worksheet

|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd| = Form354.Label13.Caption
If |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd| = Empty Then |fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd| = ThisWorkbook.Name
Set s810 = Workbooks(|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd|).Sheets("810")

    For xx = 1 To ThisWorkbook.Sheets.Count
    namelist = ThisWorkbook.Sheets(xx).Name
    If namelist = "j810" Then ThisWorkbook.Sheets("j810").Delete
    Next xx

'If d Is Nothing Then
Windows(|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd|).Activate
Sheets.Add After:=Sheets(Sheets.Count)
Sheets(Sheets.Count).Name = "j810"
'End If

Set d = Workbooks(|fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd||fffd|_|fffd||fffd||fffd||fffd||fffd|).Sheets("j810")
d.Cells(1, 2).FormulaR1C1 = "=COUNTA(C[-1])"
d.Range("A1:A" & d.Cells(1, 2)).ClearContents
d.Visible = xlSheetHidden

tt = Chr(13) & Chr(10)

If s810.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
txt = "{" & tt & " ""dds_type""" & ": " & """quarter""" & "," & tt & " """ & s810.Cells(4, 5) & """: {"
For X = 8 To s810.Cells(3, 1) - 3
For Y = 3 To 23 Step 2

Select Case Y
Case 3
txt = txt & tt & "  """ & s810.Cells(X, Y) & """: {"
Case 5, 9, 13, 17, 21
mm = ((Y - 1) / 4) - 1
txt = txt & tt & "   """ & mm & """" & ": {" & tt & "    ""income""" & ": " & s810.Cells(X, Y) & ","
Case 7, 11, 15, 19
txt = txt & tt & "    ""comsuption""" & ": " & s810.Cells(X, Y) & tt & "   },"
Case 23
txt = txt & tt & "    ""comsuption""" & ": " & s810.Cells(X, Y) & tt & "   }" & tt & "  },"
End Select

Next Y
Next X
txt = Left(txt, Len(txt) - 4) & "  }" & tt & " }" & tt & "}" & ""
'end |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|
Else
'|fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
txt = "{" & tt & " ""dds_type""" & ": " & """year""" & ","
For X = 8 To s810.Cells(3, 1) - 3
For Y = 3 To 15 Step 2

Select Case Y
Case 3
txt = txt & tt & " """ & s810.Cells(X, Y) & """: {"
Case 5, 9, 13
mm = s810.Cells(4, 5) + (((Y - 1) / 4) - 1)
txt = txt & tt & "  """ & mm & """" & ": {" & tt & "   ""income""" & ": " & s810.Cells(X, Y) & ","
Case 7, 11
txt = txt & tt & "   ""comsuption""" & ": " & s810.Cells(X, Y) & tt & "  },"
Case 15
txt = txt & tt & "   ""comsuption""" & ": " & s810.Cells(X, Y) & tt & "  }" & tt & " },"
End Select

Next Y
Next X
txt = Left(txt, Len(txt) - 3) & " }" & tt & "}" & ""
'end |fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
End If

If Len(txt) > 32767 Then
dd = Application.RoundUp(Len(txt) / 32767, 0)
For i = 1 To dd
d.Cells(i, 1) = Mid(txt, ((i - 1) * 32767) + 1, i * 32767)
Next i
Else
d.Cells(1, 1) = txt
End If
End Sub
Sub sort_paste()
On Error Resume Next
Set s810 = ActiveWorkbook.Sheets("810")
s810.Activate
s810.Unprotect "XYZ"
    dbstr = s810.[a3]
If s810.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    s810.Range("A7:AG" & dbstr - 3).Select
    s810.Sort.SortFields.Clear
    s810.Sort.SortFields.Add key:=Range("E8:E" & dbstr - 3), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    s810.Sort.SortFields.Add key:=Range("G8:G" & dbstr - 3), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    With s810.Sort
        .SetRange Range("A7:AG" & dbstr - 3)
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
Else
    s810.Range("A7:AC" & dbstr - 3).Select
    s810.Sort.SortFields.Clear
    s810.Sort.SortFields.Add key:=Range("Q8:Q" & dbstr - 3), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    s810.Sort.SortFields.Add key:=Range("S8:S" & dbstr - 3), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption:=xlSortNormal
    With s810.Sort
        .SetRange Range("A7:AC" & dbstr - 3)
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
End If
    
Application.Calculation = xlCalculationManual
For xxx = 8 To dbstr - 1 '|fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd|.|fffd||fffd||fffd|
s810.Cells(xxx, 1) = xxx - 7
If s810.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then
    For i = 6 To 24 Step 2
    grafa = Left(Cells(1, i - 1).Address(RowAbsolute:=False), Len(Cells(1, i - 1).Address(RowAbsolute:=False)) - 1)
    s810.Cells(xxx, i).Formula = "=IF(" & grafa & dbstr & "=0,0," & grafa & xxx & "/" & grafa & dbstr & "*100)"
    Next i
Else
    For i = 6 To 20 Step 2
    grafa = Left(Cells(1, i - 1).Address(RowAbsolute:=False), Len(Cells(1, i - 1).Address(RowAbsolute:=False)) - 1)
    s810.Cells(xxx, i).Formula = "=IF(" & grafa & dbstr & "=0,0," & grafa & xxx & "/" & grafa & dbstr & "*100)"
    Next i
End If
Next xxx
Application.Calculation = xlCalculationAutomatic
s810.Cells(1, 1).Select
s810.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
End Sub
Sub check_ip()
On Error Resume Next
Dim db, NewFolder, rr, r_book, c, firstAddress, cp, cc
Dim X As Long, grafa As Long, grafa2$, txt$, len_txt&, nx&, Y&, pst$, txt_ip$, len_ip&, len_ip2&

Application.ScreenUpdating = False
Set db = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
grafa = 29
If db.Cells(4, 9) = "1 |fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then grafa = 33

grafa2 = Left(Cells(1, grafa + 1).Address(RowAbsolute:=False), Len(Cells(1, grafa + 1).Address(RowAbsolute:=False)) - 1)

    NewFolder = db.Cells(6, grafa - 6) ' "h:\!!!13 |fffd||fffd||fffd| _ |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd|\1\"
    If Dir(NewFolder & "IP_svod.xlsb") = "" Then MsgBox "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd| |fffd| |fffd||fffd||fffd||fffd||fffd|, |fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|: " & NewFolder & "IP_svod.xlsb", vbCritical, "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|": Exit Sub
    
    db.Unprotect "XYZ"
    With db.Columns("C:C")
    Set cp = .Find(db.Cells(3, 2), LookIn:=xlFormulas, LookAt:=2, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If cp Is Nothing Then db.Cells(db.[a3] + 1, 3) = db.Cells(3, 2)
    End With
 
    
    Workbooks.Open Filename:=NewFolder & "IP_svod.xlsb"
Set rr = Workbooks(ActiveWorkbook.Name).Sheets(ActiveSheet.Name)
r_book = ActiveWorkbook.Name
For X = 8 To db.[a3] + 1
    If db.Cells(X, 3) = " ---" Then GoTo prop
    If db.Cells(X, 3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Then GoTo prop
    If db.Cells(X, 3) = Empty Then GoTo prop
    
    With rr.Columns("A:A")
    Set c = .Find(db.Cells(X, 3), LookIn:=xlFormulas, LookAt:=xlWhole, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not c Is Nothing Then
        firstAddress = c.Address
        Do
        db.Cells(X, 1).Interior.Color = 65535
        
        If db.Cells(X, grafa + 1) = Empty Then
        db.Cells(X, grafa + 1) = rr.Cells(c.Row, 2)
        Else
        db.Cells(X, grafa + 1) = db.Cells(X, grafa + 1) & ", " & rr.Cells(c.Row, 2)
        End If
        
        Set c = .FindNext(c)
        Loop While Not c Is Nothing And c.Address <> firstAddress
    End If
    End With
prop:
Next X
Workbooks(r_book).Close 0

'|fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd| ip
For X = 8 To db.[a3] + 1
If Not db.Cells(X, grafa + 1) = Empty Then
txt = db.Cells(X, grafa + 1)
len_txt = Len(txt)
nx = 0

For Y = 1 To len_txt
    pst = Mid(txt, Y, 2)
        If Y = len_txt Then pst = ", "
        If pst = ", " Then
        txt_ip = Mid(txt, nx + 1, Y - nx - 1)
        
        len_ip = 0
        len_ip2 = 0
        
        If Len(txt_ip) > 15 Then GoTo next_ip
        If Len(txt_ip) < 7 Then GoTo next_ip


    With db.Columns(grafa2 & ":" & grafa2)
    Set cc = .Find(txt_ip, LookIn:=xlFormulas, LookAt:=2, SearchOrder:=xlByRows, SearchDirection:=xlNext, MatchCase:=True, SearchFormat:=False)
    If Not cc Is Nothing And cc.Row <> X Then
        firstAddress = cc.Address
        Do
        db.Cells(X, 1).Interior.Color = 255
        db.Cells(cc.Row, 1).Interior.Color = 255
        
        If Not db.Cells(X, grafa) Like "*" & txt_ip & "*" Then db.Cells(X, grafa) = db.Cells(X, grafa) & db.Cells(cc.Row, 3) & "=ip:" & txt_ip & " "
        If Not db.Cells(cc.Row, grafa) Like "*" & txt_ip & "*" Then db.Cells(cc.Row, grafa) = db.Cells(cc.Row, grafa) & db.Cells(X, 3) & "=ip:" & txt_ip & " "
                
        Set cc = .FindNext(cc)
        Loop While Not cc Is Nothing And cc.Address <> firstAddress
    End If
    End With
        
        nx = Y + 1
        End If
next_ip:
Next Y

End If
Next X
db.Columns(grafa2 & ":" & grafa2).Delete Shift:=xlToLeft
db.Cells(db.[a3] + 1, 3) = ""
db.Protect "XYZ", DrawingObjects:=True, Contents:=True, Scenarios:=True, AllowFiltering:=True
Application.ScreenUpdating = True
End Sub

Attribute VB_Name = "|fffd||fffd||fffd||fffd|1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "|fffd||fffd||fffd||fffd|11"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "|fffd||fffd||fffd||fffd|2"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
'Option Explicit
Private Sub Worksheet_BeforeDoubleClick(ByVal Target As Range, ByRef Cancel As Boolean)
On Error Resume Next
Dim s810, tmp, TekList, Tekcell, INN, Work0_0, Work1_1, Work1_2, Work2_1, Work2_2, Work3_1, Work3_2, Work4_1, Work4_2, dat
Dim stroka&, str_det&, X&

Set s810 = ThisWorkbook.Sheets(ActiveSheet.Name)
Set tmp = ThisWorkbook.Sheets("|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|")
TekList = ActiveSheet.Name
Tekcell = ActiveCell.Address
INN = Cells(ActiveCell.Row, 3)
stroka = Cells(3, 1) - 1

Application.Calculation = xlCalculationManual
Application.ScreenUpdating = False
Set Work0_0 = Intersect(Range(ActiveCell.Address), Range("B8:B" & stroka))
Set Work1_1 = Intersect(Range(ActiveCell.Address), Range("E8:E" & stroka))
Set Work1_2 = Intersect(Range(ActiveCell.Address), Range("G8:G" & stroka))
Set Work2_1 = Intersect(Range(ActiveCell.Address), Range("I8:I" & stroka))
Set Work2_2 = Intersect(Range(ActiveCell.Address), Range("K8:K" & stroka))
Set Work3_1 = Intersect(Range(ActiveCell.Address), Range("M8:M" & stroka))
Set Work3_2 = Intersect(Range(ActiveCell.Address), Range("O8:O" & stroka))
Set Work4_1 = Intersect(Range(ActiveCell.Address), Range("Q8:Q" & stroka))
Set Work4_2 = Intersect(Range(ActiveCell.Address), Range("S8:S" & stroka))

str_det = tmp.Cells(1, 13)

If Not Work1_1 Is Nothing Or Not Work1_2 Is Nothing _
Or Not Work2_1 Is Nothing Or Not Work2_2 Is Nothing _
Or Not Work3_1 Is Nothing Or Not Work3_2 Is Nothing _
Or Not Work4_1 Is Nothing Or Not Work4_2 Is Nothing Then

tmp.Activate
tmp.Range("$A$1:$O$" & str_det).AutoFilter Field:=1
tmp.Range("$A$1:$Q$" & str_det).AutoFilter Field:=6
tmp.Range("$A$1:$Q$" & str_det).AutoFilter Field:=7
tmp.Range("$A$1:$Q$" & str_det).AutoFilter Field:=8

With tmp
For X = 1 To 12
.Cells(1, X).Hyperlinks.Delete
.Cells(1, X).HorizontalAlignment = xlCenter
.Cells(1, X).VerticalAlignment = xlCenter
.Cells(1, X).WrapText = True
.Cells(1, X).Interior.Color = 12379352
.Cells(1, X).Hyperlinks.Add Anchor:=.Cells(1, X), Address:="", SubAddress:="'" & TekList & "'!" & Tekcell
Next X
End With

If Not Work1_1 Is Nothing Or Not Work1_2 Is Nothing Then dat = s810.[e4]
If Not Work2_1 Is Nothing Or Not Work2_2 Is Nothing Then dat = s810.[I4]
If Not Work3_1 Is Nothing Or Not Work3_2 Is Nothing Then dat = s810.[M4]

If Work4_1 Is Nothing Or Work4_2 Is Nothing Then tmp.Range("$A$1:$O$" & str_det).AutoFilter Field:=1, Operator:=xlFilterValues, Criteria2:=Array(0, "12/22/" & dat)
tmp.Range("$A$1:$O$" & str_det).AutoFilter Field:=4, Criteria1:="=" & INN, Operator:=xlAnd
tmp.Range("$A$1:$O$" & str_det).AutoFilter Field:=6, Criteria1:="=" & TekList, Operator:=xlAnd
If INN = " ---" Then tmp.Range("$A$1:$O$" & str_det).AutoFilter Field:=4, Operator:=xlFilterNoFill

If Not Work1_2 Is Nothing Or Not Work2_2 Is Nothing Or Not Work3_2 Is Nothing Or Not Work4_2 Is Nothing Then tmp.Range("$A$1:$I$" & str_det).AutoFilter Field:=8, Criteria1:=">0", Operator:=xlAnd
If Not Work1_1 Is Nothing Or Not Work2_1 Is Nothing Or Not Work3_1 Is Nothing Or Not Work4_1 Is Nothing Then tmp.Range("$A$1:$I$" & str_det).AutoFilter Field:=7, Criteria1:=">0", Operator:=xlAnd
tmp.Columns("G:H").Style = "Comma"
End If

If Not Work0_0 Is Nothing Then
tmp.Activate

With tmp
For X = 1 To 12
.Cells(1, X).Hyperlinks.Delete
.Cells(1, X).HorizontalAlignment = xlCenter
.Cells(1, X).VerticalAlignment = xlCenter
.Cells(1, X).WrapText = True
.Cells(1, X).Interior.Color = 12379352
.Cells(1, X).Hyperlinks.Add Anchor:=.Cells(1, X), Address:="", SubAddress:="'" & TekList & "'!" & Tekcell
Next X
End With

tmp.Range("$A$1:$Q$" & str_det).AutoFilter Field:=1
tmp.Range("$A$1:$Q$" & str_det).AutoFilter Field:=4, Criteria1:="=" & INN, Operator:=xlAnd
If INN = " ---" Then tmp.Range("$A$1:$Q$" & str_det).AutoFilter Field:=4, Operator:=xlFilterNoFill
tmp.Range("$A$1:$Q$" & str_det).AutoFilter Field:=6, Criteria1:="=" & TekList, Operator:=xlAnd
tmp.Range("$A$1:$Q$" & str_det).AutoFilter Field:=7
tmp.Range("$A$1:$Q$" & str_det).AutoFilter Field:=8
tmp.Columns("G:H").Style = "Comma"
End If

Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
End Sub

Attribute VB_Name = "|fffd||fffd||fffd||fffd|3"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "|fffd||fffd||fffd||fffd|5"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Public row_sel, col_sel
Private Sub Worksheet_BeforeDoubleClick(ByVal Target As Range, ByRef Cancel As Boolean)
Application.ScreenUpdating = False
Set db = ThisWorkbook.Sheets(ActiveSheet.Name)
stroka = ActiveCell.Row
Set Work = Intersect(Range(ActiveCell.Address), Range("A" & stroka & ":I" & stroka))

If Not Work Is Nothing And Not db.Cells(stroka, 7) = Empty Or Not db.Cells(stroka, 8) = Empty Then
' |fffd||fffd||fffd||fffd||fffd||fffd| / |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
If db.Range("A" & stroka & ":I" & stroka).Font.Italic = False Then
db.Range("A" & stroka & ":I" & stroka).Font.Italic = True
db.Cells(stroka, 7) = "'" & db.Cells(stroka, 7)
db.Cells(stroka, 8) = "'" & db.Cells(stroka, 8)
Else
db.Range("A" & stroka & ":I" & stroka).Font.Italic = False
db.Cells(stroka, 7) = Right(db.Cells(stroka, 7), Len(db.Cells(stroka, 7)))
db.Cells(stroka, 8) = Right(db.Cells(stroka, 8), Len(db.Cells(stroka, 8)))
End If
'end |fffd||fffd||fffd||fffd||fffd||fffd| / |fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd||fffd||fffd|
End If
End Sub

Private Sub Worksheet_Change(ByVal Target As Range)
Dim InnText, rez, ss
If Not col_sel = 4 Then Exit Sub
If Cells(row_sel, 3) = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|" Or Cells(row_sel, 3) = " ---" Then Cells(row_sel, 4).Font.ColorIndex = xlAutomatic

If Len(Cells(row_sel, 4)) = 9 Or Len(Cells(row_sel, 4)) = 11 Then Cells(row_sel, 4) = "0" & Cells(row_sel, 4)
Cells(row_sel, 4).NumberFormat = "@"
Cells(row_sel, 4).Font.Color = -16776961

InnText = Cells(row_sel, 4)
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| 12 |fffd||fffd||fffd||fffd||fffd||fffd|
If Len(InnText) = 12 Then
ss = (Mid(InnText, 1, 1) * 7 + Mid(InnText, 2, 1) * 2 + Mid(InnText, 3, 1) * 4 _
+ Mid(InnText, 4, 1) * 10 + Mid(InnText, 5, 1) * 3 + Mid(InnText, 6, 1) * 5 + Mid(InnText, 7, 1) * 9 _
+ Mid(InnText, 8, 1) * 4 + Mid(InnText, 9, 1) * 6 + Mid(InnText, 10, 1) * 8)
rez = ss - Left(Format(Round(ss / 11, 1), "0.0"), Len(Format(Round(ss / 11, 1), "0.0")) - 2) * 11

If Mid(InnText, 11, 1) + 0 = Right(rez, 1) + 0 Then
ss = (Mid(InnText, 1, 1) * 3 + Mid(InnText, 2, 1) * 7 + Mid(InnText, 3, 1) * 2 + Mid(InnText, 4, 1) * 4 _
+ Mid(InnText, 5, 1) * 10 + Mid(InnText, 6, 1) * 3 + Mid(InnText, 7, 1) * 5 + Mid(InnText, 8, 1) * 9 _
+ Mid(InnText, 9, 1) * 4 + Mid(InnText, 10, 1) * 6 + Mid(InnText, 11, 1) * 8)
rez = ss - Left(Format(Round(ss / 11, 1), "0.0"), Len(Format(Round(ss / 11, 1), "0.0")) - 2) * 11

If Mid(InnText, 12, 1) + 0 = Right(rez, 1) + 0 Then Cells(row_sel, 4).Font.ColorIndex = xlAutomatic
End If
End If
'''''''''''''''
'|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd| |fffd||fffd||fffd| 10 |fffd||fffd||fffd||fffd||fffd||fffd|

If Len(InnText) = 10 Then
ss = (Mid(InnText, 1, 1) * 2 + Mid(InnText, 2, 1) * 4 + Mid(InnText, 3, 1) * 10 + Mid(InnText, 4, 1) * 3 _
+ Mid(InnText, 5, 1) * 5 + Mid(InnText, 6, 1) * 9 + Mid(InnText, 7, 1) * 4 + Mid(InnText, 8, 1) * 6 + Mid(InnText, 9, 1) * 8)

rez = ss - Left(Format(Round(ss / 11, 1), "0.0"), Len(Format(Round(ss / 11, 1), "0.0")) - 2) * 11
    If Mid(InnText, 10, 1) + 0 = Right(rez, 1) + 0 Then Cells(row_sel, 4).Font.ColorIndex = xlAutomatic
End If
End Sub

Private Sub Worksheet_SelectionChange(ByVal Target As Range)
row_sel = ActiveCell.Row
col_sel = ActiveCell.Column
End Sub


Attribute VB_Name = "|fffd||fffd||fffd||fffd||fffd||fffd||fffd||fffd|"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Workbook_BeforePrint(Cancel As Boolean)
    ActiveSheet.PageSetup.RightFooter = ThisWorkbook.Name & " " & CreateObject("WScript.Network").UserName & " " & CreateObject("wscript.network").computername & " " & Format(Now, "YYYY-MM-DD HH:NN:SS")
Run "print_wk"

End Sub


INQUEST-PP=macro
