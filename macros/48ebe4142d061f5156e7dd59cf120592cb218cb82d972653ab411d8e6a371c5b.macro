Attribute VB_Name = "Arkusz1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "Image6, 60, 6, MSForms, Image"
Attribute VB_Control = "Image5, 59, 7, MSForms, Image"
Attribute VB_Control = "Image4, 58, 8, MSForms, Image"
Attribute VB_Control = "Image3, 57, 9, MSForms, Image"
Attribute VB_Control = "Image2, 56, 10, MSForms, Image"
Attribute VB_Control = "Image1, 55, 11, MSForms, Image"
Attribute VB_Control = "CommandButton1, 50, 12, MSForms, CommandButton"
Attribute VB_Control = "ikk16, 49, 13, MSForms, Image"
Attribute VB_Control = "ikk15, 48, 14, MSForms, Image"
Attribute VB_Control = "ikk8, 41, 15, MSForms, Image"
Attribute VB_Control = "ikk7, 40, 16, MSForms, Image"
Attribute VB_Control = "ikk6, 39, 17, MSForms, Image"
Attribute VB_Control = "ikk5, 38, 18, MSForms, Image"
Attribute VB_Control = "ikk4, 37, 19, MSForms, Image"
Attribute VB_Control = "ikk3, 36, 20, MSForms, Image"
Attribute VB_Control = "ikk2, 35, 21, MSForms, Image"
Attribute VB_Control = "ikk1, 34, 22, MSForms, Image"
Attribute VB_Control = "ixx6, 33, 23, MSForms, Image"
Attribute VB_Control = "ixx4, 32, 24, MSForms, Image"
Attribute VB_Control = "CommandButton6, 31, 25, MSForms, CommandButton"
Attribute VB_Control = "CommandButton4, 30, 26, MSForms, CommandButton"
Attribute VB_Control = "CommandButton2, 29, 27, MSForms, CommandButton"
Attribute VB_Control = "ixx16, 24, 28, MSForms, Image"
Attribute VB_Control = "ixx15, 23, 29, MSForms, Image"
Attribute VB_Control = "ixx8, 16, 30, MSForms, Image"
Attribute VB_Control = "ixx7, 15, 31, MSForms, Image"
Attribute VB_Control = "ixx5, 13, 32, MSForms, Image"
Attribute VB_Control = "ixx3, 11, 33, MSForms, Image"
Attribute VB_Control = "ixx2, 10, 34, MSForms, Image"
Attribute VB_Control = "ixx1, 9, 35, MSForms, Image"

Private Sub CommandButton6_Click()
Walid xlOn
eDeklaracja.Show
End Sub

Private Sub Worksheet_Activate()
Imfreshvat xlOn
End Sub

Private Sub Worksheet_SelectionChange(ByVal Target As Range)
If [E18] = "" And Target.Row = 18 Then Fraza.Show
If ActiveWorkbook.Colors(19) = RGB(255, 255, 255) Then
ActiveWorkbook.Colors(19) = RGB(255, 255, 150)
End If
If Target.Row = 25 And [A23] = "" Then Firma xlOn
Imfreshvat xlOn
End Sub

Private Sub CommandButton4_Click()
If ActiveWorkbook.Colors(15) = RGB(234, 234, 234) Then
    ActiveWorkbook.Colors(15) = RGB(255, 255, 255)
    ActiveWorkbook.Colors(16) = RGB(255, 255, 255)
    CommandButton4.Caption = "W|fffd||fffd|cz t|fffd|o"
Else
    ActiveWorkbook.Colors(15) = RGB(234, 234, 234)
    ActiveWorkbook.Colors(16) = RGB(191, 191, 191)
    CommandButton4.Caption = "Wy|fffd||fffd|cz t|fffd|o"
End If
End Sub

Private Sub CommandButton2_Click()
Wydruk.Show
End Sub

Private Sub ikk1_Click()
ikk1.Visible = False
ixx1.Visible = True
ixx2.Visible = False
ikk2.Visible = True
[AT1] = 1
End Sub
Private Sub ixx2_Click()
ixx2.Visible = False
ikk2.Visible = True
ikk1.Visible = False
ixx1.Visible = True
[AT1] = 1
End Sub
Private Sub ikk2_Click()
ikk2.Visible = False
ixx2.Visible = True
ixx1.Visible = False
ikk1.Visible = True
[AT1] = 2
End Sub

Private Sub ixx3_Click()
ixx3.Visible = False
ikk3.Visible = True
[AT2] = 0
End Sub

Private Sub ikk3_Click()
ikk3.Visible = False
ixx3.Visible = True
ixx4.Visible = False
ikk4.Visible = True
[AT2] = 1
[A23:A25].ClearContents
Firma xlOn
End Sub

Private Sub ixx4_Click()
ixx4.Visible = False
ikk4.Visible = True
[AT2] = 0
End Sub

Private Sub ikk4_Click()
ikk4.Visible = False
ixx4.Visible = True
ixx3.Visible = False
ikk3.Visible = True
[AT2] = 2
[A23:A25].ClearContents
Firma xlOn
End Sub

Private Sub ixx5_Click()
ixx5.Visible = False
ikk5.Visible = True
[AT3] = 0
End Sub
Private Sub ikk5_Click()
ikk5.Visible = False
ixx5.Visible = True
[AT3] = 1
End Sub

Private Sub ixx6_Click()
ixx6.Visible = False
ikk6.Visible = True
[AT4] = 0
End Sub
Private Sub ikk6_Click()
ikk6.Visible = False
ixx6.Visible = True
[AT4] = 1
End Sub

Private Sub ixx7_Click()
ixx7.Visible = False
ikk7.Visible = True
[AT5] = 0
End Sub
Private Sub ikk7_Click()
ikk7.Visible = False
ixx7.Visible = True
[AT5] = 1
End Sub

Private Sub ixx8_Click()
ixx8.Visible = False
ikk8.Visible = True
[AT6] = 0
End Sub
Private Sub ikk8_Click()
ikk8.Visible = False
ixx8.Visible = True
[AT6] = 1
End Sub

Private Sub ixx9_Click()
ixx9.Visible = False
ikk9.Visible = True
[AT7] = 0
End Sub
Private Sub ikk9_Click()
ikk9.Visible = False
ixx9.Visible = True
[AT7] = 1
End Sub

Private Sub ixx10_Click()
ixx10.Visible = False
ikk10.Visible = True
[AT8] = 0
End Sub
Private Sub ikk10_Click()
ikk10.Visible = False
ixx10.Visible = True
[AT8] = 1
End Sub

Private Sub ixx11_Click()
ixx11.Visible = False
ikk11.Visible = True
[AT9] = 0
Sheets("VAT-ZZ").Visible = xlVeryHidden
End Sub
Private Sub ikk11_Click()
ikk11.Visible = False
ixx11.Visible = True
ixx12.Visible = False
ikk12.Visible = True
[AT9] = 1
Sheets("VAT-ZZ").Visible = True
Sheets("VAT-ZZ").Activate
Sheets("VAT-ZZ").[D25:L63].ClearContents
Calculate
End Sub
Private Sub ixx12_Click()
ixx12.Visible = False
ikk12.Visible = True
[AT9] = 0
End Sub
Private Sub ikk12_Click()
ikk12.Visible = False
ixx12.Visible = True
ixx11.Visible = False
ikk11.Visible = True
[AT9] = 2
Sheets("VAT-ZZ").Visible = xlVeryHidden
End Sub

Private Sub ixx13_Click()
ixx13.Visible = False
ikk13.Visible = True
[AT10] = 0
Sheets("VAT-ZT").Visible = xlVeryHidden
End Sub
Private Sub ikk13_Click()
ikk13.Visible = False
ixx13.Visible = True
ixx14.Visible = False
ikk14.Visible = True
[AT10] = 1
Sheets("VAT-ZT").Visible = True
Sheets("VAT-ZT").Activate
Sheets("VAT-ZT").[D23:M63].ClearContents
Calculate
End Sub
Private Sub ixx14_Click()
ixx14.Visible = False
ikk14.Visible = True
[AT10] = 0
End Sub
Private Sub ikk14_Click()
ikk14.Visible = False
ixx14.Visible = True
ixx13.Visible = False
ikk13.Visible = True
[AT10] = 2
Sheets("VAT-ZT").Visible = xlVeryHidden
End Sub

Private Sub ixx15_Click()
ixx15.Visible = False
ikk15.Visible = True
[AT11] = 0
Sheets("VAT-ZD").Visible = xlVeryHidden
End Sub

Private Sub ikk15_Click()
ikk15.Visible = False
ixx15.Visible = True
ixx16.Visible = False
ikk16.Visible = True
[AT11] = 1
opc = [AT2]
Sheets("VAT-ZD").Visible = True
Sheets("VAT-ZD").Activate
If opc = 1 Then
ActiveSheet.Shapes("ixx1").Visible = True
ActiveSheet.Shapes("ikk1").Visible = False
ActiveSheet.Shapes("ixx2").Visible = False
ActiveSheet.Shapes("ikk2").Visible = True
Else
ActiveSheet.Shapes("ixx2").Visible = True
ActiveSheet.Shapes("ikk2").Visible = False
ActiveSheet.Shapes("ixx1").Visible = False
ActiveSheet.Shapes("ikk1").Visible = True
End If
Sheets("VAT-ZD").[B88:AZ187].ClearContents
Calculate
End Sub

Private Sub ixx16_Click()
ixx16.Visible = False
ikk16.Visible = True
[AT11] = 0
End Sub
Private Sub ikk16_Click()
ikk16.Visible = False
ixx16.Visible = True
ixx15.Visible = False
ikk15.Visible = True
[AT11] = 2
Sheets("VAT-ZD").Visible = xlVeryHidden
End Sub

Private Sub ixx17_Click()
ixx17.Visible = False
ikk17.Visible = True
[AT12] = 0
End Sub
Private Sub ikk17_Click()
ikk17.Visible = False
ixx17.Visible = True
[AT12] = 1
End Sub

Private Sub CommandButton1_Click()
Dim Przen As Integer, Dzis, Mc
Application.ScreenUpdating = False
On Error Resume Next
'-----------------------------------------------------------
If Range("Test") = "" And Range("Status") = 200 Then
b = MsgBox("Bie|fffd||fffd|cy Numer dokumentu z systemu e-Deklaracje" & Chr(13) & _
"                  " & Range("Nrdok") & Chr(13) & _
"zostanie bezpowrotnie skasowany." & Chr(13) & Chr(13) & _
             "Czy zosta|fffd| on zachowany w wydrukowanym lub zapisanym w pdf UPO?", vbYesNo + vbQuestion, "e-Deklaracje")
End If
If b = 7 Then End
ActiveSheet.Unprotect
Range("Nrdok").Select
Selection.ClearContents
Range("Test").Select
Selection.ClearContents
Range("Status").Select
Selection.ClearContents
ActiveSheet.Protect
'-----------------------------------------------------------
Przen = Range("Z129")
[AT1] = 1
Sheets("VAT-ZD").Visible = xlVeryHidden
Sheets("VAT-ZZ").Visible = xlVeryHidden
Sheets("VAT-ZT").Visible = xlVeryHidden
ActiveSheet.Shapes("ixx1").Visible = True
ActiveSheet.Shapes("ikk1").Visible = False
ActiveSheet.Shapes("ixx2").Visible = False
ActiveSheet.Shapes("ikk2").Visible = True
For a = 5 To 16
ix = "ixx" & a
ik = "ikk" & a
ActiveSheet.Shapes(ix).Visible = False
ActiveSheet.Shapes(ik).Visible = True
Next
For a = 3 To 11
Cells(a, 46) = 0
Next
If Month(Now) < 4 Then
    Range("P11") = 4
    Range("U11") = Year(Now) - 1
Else
    If Month(Now) = 4 Then Range("P11") = 1
    If Month(Now) = 5 Then Range("P11") = 1
    If Month(Now) = 6 Then Range("P11") = 1
    If Month(Now) = 7 Then Range("P11") = 2
    If Month(Now) = 8 Then Range("P11") = 2
    If Month(Now) = 9 Then Range("P11") = 2
    If Month(Now) = 10 Then Range("P11") = 3
    If Month(Now) = 11 Then Range("P11") = 3
    If Month(Now) = 12 Then Range("P11") = 3
    Range("U11") = Year(Now)
End If

If Month(Now) < 10 Then
    Mc = "0" & Month(Now)
Else
    Mc = Month(Now)
End If

Dzis = Day(Now) & Mc & Year(Now)

Range("N157") = Dzis
If Przen > 0 Then
Range("Z88") = Przen
MsgBox "Wstawiono kwot|fffd| do przeniesienia na nast|fffd|pny miesi|fffd|c w pole nr 42." & Chr(13) & _
"Do deklaracji wstawiono dzisiejsz|fffd| dat|fffd|." & Chr(13) & _
"oraz aktualny kwarta|fffd| rozliczeniowy.", 64, "VAT-7K"
Else
MsgBox "Do deklaracji wstawiono dzisiejsz|fffd| dat|fffd|." & Chr(13) & _
"oraz aktualny kwarta|fffd| rozliczeniowy.", 64, "VAT-7K"
End If
End Sub

Sub Firma(st)
If [AT2] = 0 Then
MsgBox "Zaznacz rodzaj podatnika", vbCritical, ""
[E22].Select: End
End If
If [AT2] = 1 Then
[A23] = UCase(InputBox("Wpisz nazw|fffd| pe|fffd|n|fffd| firmy", "Nazwa firmy"))
Else
[A23] = UCase(InputBox("Wpisz nazwisko osoby fizycznej", "Nazwa firmy"))
[A24] = UCase(InputBox("Wpisz imi|fffd| osoby fizycznej", "Nazwa firmy"))
[A25] = InputBox("Wpisz dat|fffd| urodzenia osoby fizycznej jako 8 cyfr np. 01021989", "Data urodzenia")
If [AT25] = False Then MsgBox "Wpisano b|fffd||fffd|dnie dat|fffd|!" & Chr(13) & Chr(13) & "Winno by|fffd| 8 cyfr np. 01021989", 16, "B|fffd||fffd|D": [A23:A25].ClearContents
End If
End Sub

Sub Imfreshvat(st)
If ikk1.Visible = True And ixx1.Visible = True Then
Application.ScreenUpdating = False
If [AT1] = 1 Then
ikk1.Visible = False
ixx1.Visible = True
ixx2.Visible = False
ikk2.Visible = True
End If
If [AT1] = 2 Then
ikk2.Visible = False
ixx2.Visible = True
ixx1.Visible = False
ikk1.Visible = True
End If
If [AT2] = 1 Then
ikk3.Visible = False
ixx3.Visible = True
ixx4.Visible = False
ikk4.Visible = True
End If
If [AT2] = 2 Then
ikk4.Visible = False
ixx4.Visible = True
ixx3.Visible = False
ikk3.Visible = True
End If
If [AT3] = 1 Then
ikk5.Visible = False
ixx5.Visible = True
End If
If [AT4] = 1 Then
ikk6.Visible = False
ixx6.Visible = True
End If
If [AT5] = 1 Then
ikk7.Visible = False
ixx7.Visible = True
End If
If [AT6] = 1 Then
ikk8.Visible = False
ixx8.Visible = True
End If
If [AT7] = 1 Then
ikk9.Visible = False
ixx9.Visible = True
End If
If [AT8] = 1 Then
ikk10.Visible = False
ixx10.Visible = True
End If
If [AT9] = 1 Then
ikk11.Visible = False
ixx11.Visible = True
ixx12.Visible = False
ikk12.Visible = True
End If
If [AT9] = 2 Then
ikk12.Visible = False
ixx12.Visible = True
ixx11.Visible = False
ikk11.Visible = True
End If
If [AT10] = 1 Then
ikk13.Visible = False
ixx13.Visible = True
ixx14.Visible = False
ikk14.Visible = True
End If
If [AT10] = 2 Then
ikk14.Visible = False
ixx14.Visible = True
ixx13.Visible = False
ikk13.Visible = True
End If
If [AT11] = 1 Then
ikk15.Visible = False
ixx15.Visible = True
ixx16.Visible = False
ikk16.Visible = True
End If
If [AT11] = 2 Then
ikk16.Visible = False
ixx16.Visible = True
ixx15.Visible = False
ikk15.Visible = True
End If
If [AT12] = 1 Then
ikk17.Visible = False
ixx17.Visible = True
End If

End If
End Sub



Attribute VB_Name = "Arkusz2"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "CommandButton1, 51, 0, MSForms, CommandButton"
Attribute VB_Control = "CommandButton4, 50, 1, MSForms, CommandButton"
Attribute VB_Control = "CommandButton5, 49, 2, MSForms, CommandButton"
Attribute VB_Control = "CommandButton3, 47, 3, MSForms, CommandButton"
Attribute VB_Control = "CommandButton2, 46, 4, MSForms, CommandButton"
Attribute VB_Control = "ikk2, 43, 5, MSForms, Image"
Attribute VB_Control = "ikk1, 42, 6, MSForms, Image"
Attribute VB_Control = "ixx2, 36, 7, MSForms, Image"
Attribute VB_Control = "ixx1, 35, 8, MSForms, Image"
Private Sub CommandButton3_Click()
Application.ScreenUpdating = False
On Error Resume Next
Range("AJ15:AT15,I60:AZ75,B88:AZ187").ClearContents
MsgBox "Dane liczbowe zosta|fffd|y usuni|fffd|te.", 64, "VAT-ZD"
End Sub

Private Sub CommandButton4_Click()
WydrukZD xlOn
End Sub

Private Sub CommandButton5_Click()
WydrukZD xlOn
End Sub

Private Sub Worksheet_SelectionChange(ByVal Target As Range)
If ActiveWorkbook.Colors(19) = RGB(255, 255, 255) Then
ActiveWorkbook.Colors(19) = RGB(255, 255, 150)
End If
End Sub

Private Sub CommandButton2_Click()
If ActiveWorkbook.Colors(15) = RGB(234, 234, 234) Then
    ActiveWorkbook.Colors(15) = RGB(255, 255, 255)
    ActiveWorkbook.Colors(16) = RGB(255, 255, 255)
    CommandButton2.Caption = "W|fffd||fffd|cz t|fffd|o"
Else
    ActiveWorkbook.Colors(15) = RGB(234, 234, 234)
    ActiveWorkbook.Colors(16) = RGB(191, 191, 191)
    CommandButton2.Caption = "Wy|fffd||fffd|cz t|fffd|o"
End If
End Sub

Private Sub CommandButton1_Click()
Application.ScreenUpdating = False
On Error Resume Next
Range("AJ15:AT15,I60:AZ75,B88:AZ187").ClearContents
MsgBox "Dane liczbowe zosta|fffd|y usuni|fffd|te.", 64, "VAT-ZD"
End Sub

Private Sub ixx1_Click()
ixx1.Visible = False
ikk1.Visible = True
End Sub
Private Sub ikk1_Click()
ikk1.Visible = False
ixx1.Visible = True
ixx2.Visible = False
ikk2.Visible = True
End Sub
Private Sub ixx2_Click()
ixx2.Visible = False
ikk2.Visible = True
End Sub
Private Sub ikk2_Click()
ikk2.Visible = False
ixx2.Visible = True
ixx1.Visible = False
ikk1.Visible = True
End Sub


Sub WydrukZD(st)
Dim Fak(100, 7), a, b, c, d
d = 0
For a = 1 To 100
Fak(a, 1) = Cells(a + 87, 2)
Fak(a, 2) = Cells(a + 87, 19)
Fak(a, 3) = Cells(a + 87, 25)
Fak(a, 4) = Cells(a + 87, 35)
Fak(a, 5) = Cells(a + 87, 43)
Fak(a, 6) = Cells(a + 87, 49)
Fak(a, 7) = Cells(a + 87, 51)
For b = 1 To 7
If Fak(a, b) = "" Then c = c + 1
Next
If c > 0 And c < 7 Then
MsgBox "Nie wype|fffd|niono pola w wierszu " & a, 16, "Niepe|fffd|ny wpis"
End
End If
c = 0
If Fak(a, 1) <> "" Then d = d + 1
Next

[AJ15:AT15,I60:AZ75].ClearContents
LStr = 2

Wydruk3.Show
b = 1
For a = 1 To d
 Cells(b * 2 + 58, 9) = Fak(a, 1)
 Cells(b * 2 + 58, 22) = Fak(a, 2)
 Cells(b * 2 + 58, 30) = Fak(a, 3)
 Cells(b * 2 + 59, 30) = Fak(a, 4)
 Cells(b * 2 + 58, 40) = Fak(a, 5)
 Cells(b * 2 + 58, 49) = Fak(a, 6)
 Cells(b * 2 + 58, 51) = Fak(a, 7)
b = b + 1
If b = 9 Then
b = 1
    If Opty1 = True Then
    [AJ15] = [AJ15].Value + 1
    ActiveWindow.SelectedSheets.PrintOut From:=1, To:=1
    MsgBox "W|fffd||fffd| odpowiednio kartk|fffd| do podajnika i drukuj drug|fffd| stron|fffd|", 64, "Drukuj formularz dwustronnie"
    ActiveWindow.SelectedSheets.PrintOut From:=2, To:=2
    Else
    [AJ15] = [AJ15].Value + 1
    ActiveWindow.SelectedSheets.PrintOut
    End If
[I60:AZ75].ClearContents
End If

If a = d Then
If Opty1 = True Then
[AJ15] = [AJ15].Value + 1
ActiveWindow.SelectedSheets.PrintOut From:=1, To:=1
MsgBox "W|fffd||fffd| odpowiednio kartk|fffd| do podajnika i drukuj drug|fffd| stron|fffd|", 64, "Drukuj formularz dwustronnie"
ActiveWindow.SelectedSheets.PrintOut From:=2, To:=2
Else
[AJ15] = [AJ15].Value + 1
ActiveWindow.SelectedSheets.PrintOut
End If
[AJ15:AT15,I60:AZ75].ClearContents
End If
Next

Sheets("VAT-7").Range("AM157") = Application.RoundUp(d / 8, 0)
End Sub

Attribute VB_Name = "Arkusz3"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "CommandButton6, 6, 0, MSForms, CommandButton"
Attribute VB_Control = "CommandButton5, 5, 1, MSForms, CommandButton"
Attribute VB_Control = "CommandButton4, 4, 2, MSForms, CommandButton"
Attribute VB_Control = "CommandButton3, 3, 3, MSForms, CommandButton"
Attribute VB_Control = "CommandButton2, 2, 4, MSForms, CommandButton"
Attribute VB_Control = "CommandButton1, 1, 5, MSForms, CommandButton"
Private Sub CommandButton1_Click()
sh = 37
Zar = False
Zas = False
VATnext = False
FormatS
Walidacja
MsgBox "Sprawdzono dane z arkusza 'Sprzeda|fffd|' ", 64
Application.EnableEvents = True
End Sub

Private Sub CommandButton2_Click()
sh = 37
Zar = True
Zas = True
VATnext = True
ImportSCsv
Application.EnableEvents = True
End Sub

Private Sub CommandButton3_Click()
Application.ScreenUpdating = False
ActiveSheet.Unprotect
Range(Cells(4, 1), Cells(ActiveSheet.Cells.SpecialCells(xlCellTypeLastCell).Row, 100)).Select
Selection.ClearContents
    With Selection.Font
        .Name = "Arial"
        .FontStyle = "Normalny"
        .Size = 10
        .Strikethrough = False
        .Superscript = False
        .Subscript = False
        .OutlineFont = False
        .Shadow = False
        .Underline = xlUnderlineStyleNone
        .ColorIndex = xlAutomatic
    End With
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    Selection.Borders(xlEdgeLeft).LineStyle = xlNone
    Selection.Borders(xlEdgeTop).LineStyle = xlNone
    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
    Selection.Borders(xlEdgeRight).LineStyle = xlNone
    Selection.Borders(xlInsideVertical).LineStyle = xlNone
    Selection.Borders(xlInsideHorizontal).LineStyle = xlNone
    With Selection.Interior
        .Pattern = xlNone
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False

Tabela (ActiveSheet.Name)
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
Cells(4, 1).Select
End Sub

Private Sub CommandButton4_Click()
Dim Frt As Boolean
Application.ScreenUpdating = False
Frt = False
On Error GoTo BRAK
If ActiveCell.Row < 4 Then MsgBox "Nie mo|fffd|na dodawa|fffd| wierszy w nag|fffd||fffd|wku tabeli.", 16, "": End
If ActiveCell.Row = 4 Then Range("A5").Select: Frt = True
ActiveSheet.Unprotect
Selection.EntireRow.Insert
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
If Frt = True Then
    Range("4:4").Copy
    Range("A5").PasteSpecial xlPasteAll
    Application.CutCopyMode = False
    Range("4:4").ClearContents
    Range("A4").Select
End If
Exit Sub
BRAK:
MsgBox "Nie mo|fffd|na doda|fffd| wiersza gdy|fffd| ostatni wiersz jest wype|fffd|niony.", 16, ""
End Sub

Private Sub CommandButton5_Click()
Application.ScreenUpdating = False
If ActiveCell.Row < 4 Then MsgBox "Nie mo|fffd|na usun|fffd||fffd| nag|fffd||fffd|wka tabeli.", 16, "": End
ActiveSheet.Unprotect
If Selection.Rows.Count < Rows.Count - 3 Then
    Selection.EntireRow.Delete
Else
    Range(Cells(5, 1), Cells(Rows.Count, 1)).EntireRow.Delete
    Cells(4, 1).EntireRow.Delete
End If

ActiveCell.Select
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
End Sub

Private Sub CommandButton6_Click()
VATnext = False
VATsign = -2
c = ActiveCell.Row
WerNIP (c)
End Sub


Attribute VB_Name = "Arkusz6"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Arkusz7"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "CommandButton1, 3, 0, MSForms, CommandButton"
Attribute VB_Control = "CommandButton2, 2, 1, MSForms, CommandButton"
Private Sub CommandButton1_Click()
ActiveWindow.SelectedSheets.PrintOut
End Sub

Private Sub CommandButton2_Click()
Dim Nplik As String
If Range("D6") <> "Ministerstwo Finans|fffd|w" Then
MsgBox "Testowe UPO jest bezu|fffd|yteczne i nie jest zapisywane do pliku pdf.", vbInformation, "e-Deklaracje"
End
End If
If Val(Application.Version) < 12 Then
MsgBox "Zapisywanie UPO do pliku pdf mo|fffd|liwe jest tylko od wersji 2007 Excela.", vbCritical, "Uwaga - potrzebny Excel 2007 lub nowszy"
End
End If
Nplik = "UPO_" & [E20] & "_" & [F26] & ".pdf"
Nplik = Replace(Nplik, ":", ".")
Nplik = ThisWorkbook.Path & "\" & Nplik
ActiveSheet.ExportAsFixedFormat Type:=xlTypePDF, Filename:=Nplik _
        , Quality:=xlQualityStandard, IncludeDocProperties:=True, IgnorePrintAreas:=False, OpenAfterPublish:=False
MsgBox "UPO zapisano do pliku " & Chr(13) & Chr(13) & Nplik, vbInformation, "UPO w pdf"
End Sub


Attribute VB_Name = "Arkusz8"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "CommandButton5, 5, 0, MSForms, CommandButton"
Attribute VB_Control = "CommandButton2, 4, 1, MSForms, CommandButton"
Attribute VB_Control = "CommandButton1, 3, 2, MSForms, CommandButton"
Attribute VB_Control = "CommandButton4, 2, 3, MSForms, CommandButton"
Attribute VB_Control = "CommandButton3, 1, 4, MSForms, CommandButton"
Private Sub CommandButton1_Click()
Zar = True
Zas = True
VATnext = True
ImportXMLa
Application.EnableEvents = True
Sheets("JPK").Select
End Sub

Private Sub CommandButton2_Click()
Usundane
End Sub

Private Sub CommandButton5_Click()
Application.EnableEvents = False
If Date < 43131 Then MsgBox "Wpisz daty r|fffd|cznie.", vbInformation, "": End
datod = Replace(DateSerial(Year(Date), Month(Date) - 1, 1), "-", "")
datdo = Replace(DateSerial(Year(Date), Month(Date), 0), "-", "")
datod = Replace(datod, ".", "")
datdo = Replace(datdo, ".", "")
[E13] = datod
[K13] = datdo
Application.EnableEvents = True
End Sub

Private Sub CommandButton3_Click()
Wal "c8": Wal "e13": Wal "k13": Wal "d19": Wal "d24": Wal "d30"
If CzyNIP([C8]) = False Then
MsgBox "B|fffd||fffd|dny numer NIP", 16, "B|fffd||fffd|d"
[C8].Select
GoTo POZYC
End If
If Not CzyData([E13]) Then
MsgBox "B|fffd||fffd|dna data. Wpisz dat|fffd| jako 8 cyfr np. 01102017", 16, "B|fffd||fffd|d"
[E13].Select
GoTo POZYC
End If
If Not CzyData([K13]) Then
MsgBox "B|fffd||fffd|dna data. Wpisz dat|fffd| jako 8 cyfr np. 01102017", 16, "B|fffd||fffd|d"
[K13].Select
GoTo POZYC
End If

NRPL:
Nplik = ThisWorkbook.Path & "\JPK_VAT_" & DATAA(Range("E13")) & ".xml"
Wer = Application.GetSaveAsFilename(InitialFileName:=Nplik, FileFilter:="Pliki xml (*.xml), *.xml", Title:="Zapisz jako")
If Wer = False Then End
Nplik = Wer
Dim Npli As String
Npli = Mid(Nplik, Len(ThisWorkbook.Path) + 2)
If Mid(Nplik, Len(ThisWorkbook.Path) + 2) <> ZamZnaki(Npli) Then
MsgBox "Wprowadzona nazwa pliku: " & Mid(Nplik, Len(ThisWorkbook.Path) + 2) & vbCrLf & _
"zawiera|fffd|a niedozwolone znaki dla nazwy pliku JPK." & vbCrLf & _
"Nazwa pliku po korekcie: " & ZamZnaki(Npli), vbCritical, ""
End If
Nplik = ThisWorkbook.Path & "\" & ZamZnaki(Npli)
If Dir(Nplik) <> "" Then
Zap = MsgBox("Plik " & Dir(Nplik) & " ju|fffd| istnieje." & vbCrLf & _
"Czy chcesz go zmieni|fffd|?", 36, "Potwierdzenie zapisywania jako")
If Zap = 7 Then Kill Nplik: GoTo NRPL
End If

Zar = False
Zas = False
VATnext = False
Sheets("JPK").Select
Walida3
Doxmlu
Application.EnableEvents = True
Sheets("JPK").Select
Exit Sub

POZYC:
w = Selection.Row
c = Selection.Column
Application.GoTo Cells(w - 5, 1)
Cells(w, c).Select
End Sub

Private Sub Worksheet_SelectionChange(ByVal Target As Range)
If ActiveWorkbook.Colors(19) = RGB(255, 255, 255) Then
ActiveWorkbook.Colors(19) = RGB(255, 255, 150)
End If
Application.EnableEvents = False
If [D17] = "" And Target.Row = 17 Then Fraza.Show
Application.EnableEvents = True
End Sub

Private Sub Worksheet_Change(ByVal Target As Range)
On Error Resume Next
Application.EnableEvents = False
If Target.Row <> 26 Then
If Not Target.HasFormula And Not IsNumeric(Target.Value) Then Target.Value = UCase(Target.Value)
End If
Application.EnableEvents = True
End Sub

Private Sub CommandButton4_Click()
ActiveWorkbook.Colors(19) = RGB(255, 255, 255)
ActiveWindow.SelectedSheets.PrintOut
End Sub






Attribute VB_Name = "Arkusz9"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Control = "CommandButton6, 6, 0, MSForms, CommandButton"
Attribute VB_Control = "CommandButton5, 5, 1, MSForms, CommandButton"
Attribute VB_Control = "CommandButton4, 4, 2, MSForms, CommandButton"
Attribute VB_Control = "CommandButton3, 3, 3, MSForms, CommandButton"
Attribute VB_Control = "CommandButton2, 2, 4, MSForms, CommandButton"
Attribute VB_Control = "CommandButton1, 1, 5, MSForms, CommandButton"
Private Sub CommandButton1_Click()
sh = 15
Zar = False
Zas = False
VATnext = False
FormatZ
Walidacja
MsgBox "Sprawdzono dane z arkusza 'Zakupy'", 64
Application.EnableEvents = True
End Sub

Private Sub CommandButton2_Click()
sh = 15
Zar = True
Zas = True
VATnext = True
ImportZCsv
Application.EnableEvents = True
End Sub

Private Sub CommandButton3_Click()
Application.ScreenUpdating = False
ActiveSheet.Unprotect
Range(Cells(4, 1), Cells(ActiveSheet.Cells.SpecialCells(xlCellTypeLastCell).Row, 100)).Select
Selection.ClearContents
    With Selection.Font
        .Name = "Arial"
        .FontStyle = "Normalny"
        .Size = 10
        .Strikethrough = False
        .Superscript = False
        .Subscript = False
        .OutlineFont = False
        .Shadow = False
        .Underline = xlUnderlineStyleNone
        .ColorIndex = xlAutomatic
    End With
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    Selection.Borders(xlEdgeLeft).LineStyle = xlNone
    Selection.Borders(xlEdgeTop).LineStyle = xlNone
    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
    Selection.Borders(xlEdgeRight).LineStyle = xlNone
    Selection.Borders(xlInsideVertical).LineStyle = xlNone
    Selection.Borders(xlInsideHorizontal).LineStyle = xlNone
    With Selection.Interior
        .Pattern = xlNone
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False

Tabela (ActiveSheet.Name)
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
Cells(4, 1).Select
End Sub

Private Sub CommandButton4_Click()
Dim Frt As Boolean
Application.ScreenUpdating = False
Frt = False
On Error GoTo BRAK
If ActiveCell.Row < 4 Then MsgBox "Nie mo|fffd|na dodawa|fffd| wierszy w nag|fffd||fffd|wku tabeli.", 16, "": End
If ActiveCell.Row = 4 Then Range("A5").Select: Frt = True
ActiveSheet.Unprotect
Selection.EntireRow.Insert
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
If Frt = True Then
    Range("4:4").Copy
    Range("A5").PasteSpecial xlPasteAll
    Application.CutCopyMode = False
    Range("4:4").ClearContents
    Range("A4").Select
End If
Exit Sub
BRAK:
MsgBox "Nie mo|fffd|na doda|fffd| wiersza gdy|fffd| ostatni wiersz jest wype|fffd|niony.", 16, ""
End Sub

Private Sub CommandButton5_Click()
Application.ScreenUpdating = False
If ActiveCell.Row < 4 Then MsgBox "Nie mo|fffd|na usun|fffd||fffd| nag|fffd||fffd|wka tabeli.", 16, "": End
ActiveSheet.Unprotect
If Selection.Rows.Count < Rows.Count - 3 Then
    Selection.EntireRow.Delete
Else
    Range(Cells(5, 1), Cells(Rows.Count, 1)).EntireRow.Delete
    Cells(4, 1).EntireRow.Delete
End If

ActiveCell.Select
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
End Sub

Private Sub CommandButton6_Click()
VATnext = False
VATsign = -2
c = ActiveCell.Row
WerNIP (c)
End Sub



Attribute VB_Name = "Fraza"
Attribute VB_Base = "0{34057C7A-064C-4CA1-ABB5-DCCD6F8FACC2}{085F0910-73C1-453A-82AC-F01C6A42DE41}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False


Option Explicit
Dim Fraz() As Variant

Private Sub Anuluj_Click()
Unload Me
End Sub

Private Sub ComboBox1_Change()
With Me
.ComboBox1.DropDown
.ComboBox1.List = Filter(Fraz, .ComboBox1.Value, True, vbTextCompare)
End With
End Sub

Private Sub ComboBox1_Click()
ActiveCell = Me.ComboBox1.List
Unload Me
End Sub

Private Sub UserForm_Initialize()
With ActiveSheet
Fraz = Application.Transpose(.Range("AH1:AH" & .Cells(.Rows.Count, "AH").End(xlUp).Row).Value)
Me.ComboBox1.List = Fraz
End With
End Sub


Attribute VB_Name = "Funkcje"
Option Private Module
#If Win64 Then
Declare PtrSafe Function apiShowWindow Lib "user32" Alias "ShowWindow" _
            (ByVal hwnd As Long, ByVal nCmdSHow As Long) As Long
#Else
Declare Function apiShowWindow Lib "user32" Alias "ShowWindow" ( _
            ByVal hwnd As Long, ByVal nCmdSHow As Long) As Long
#End If
Const SW_SHOWMAXIMIZED = 3

Sub ShowWindow()
Dim IE As Object
    Set IE = CreateObject("InternetExplorer.Application")
    IE.Navigate Nplik
    apiShowWindow IE.hwnd, 3
End Sub

Public Function DATTO(ByVal Dat As String)
Dim Rok, Mc, Dz
  Rok = Right(Dat, 4)
  If Len(Dat) < 8 Then
  Mc = Mid(Dat, 2, 2)
  Dz = "0" & Left(Dat, 1)
  Else
  Mc = Mid(Dat, 3, 2)
  Dz = Left(Dat, 2)
  End If
DATTO = DateSerial(Rok, Mc, Dz)
End Function

Function UT(ByVal sStr As String)
If IsNumeric(sStr) Then sStr = Replace(Format(sStr, "0.00"), ",", ".")
If sStr = "" Then sStr = "0.00"
UT = sStr
End Function

Function UL(ByVal Nmr As Double)
If Nmr = 0 Then
UL = "0"
Else
UL = Round(Nmr, 0)
End If
End Function

Public Function ZN(str)
Dim Za As String, Zb As String
Za = Replace(str, "&", "&amp;")
Zb = Replace(Za, "<", "&lt;")
ZN = Replace(Zb, ">", "&gt;")
End Function

Function DATAA(ByVal Dat As String)
Dim Rok, Mc, Dz
  Rok = Right(Dat, 4)
  If Len(Dat) < 8 Then
  Mc = Mid(Dat, 2, 2)
  Dz = "0" & Left(Dat, 1)
  Else
  Mc = Mid(Dat, 3, 2)
  Dz = Left(Dat, 2)
  End If
DATAA = Rok & "-" & Mc & "-" & Dz
End Function

Sub Usuwadane(st)
Application.ScreenUpdating = False
Range("P11:X11").ClearContents
For a = 30 To 127
For b = 5 To 30
Cells(a, b).Select
If Selection.Locked = False Then Selection.ClearContents
Next
Next
End Sub

Public Function Base64_Encode(text As String) As String
    Dim arrData() As Byte
    arrData = StrConv(text, vbFromUnicode)
     
    Dim objXML As MSXML2.DOMDocument
    Dim objNode As MSXML2.IXMLDOMElement
     
    Set objXML = New MSXML2.DOMDocument
    Set objNode = objXML.createElement("b64")
     
    objNode.DataType = "bin.base64"
    objNode.nodeTypedValue = arrData
    Base64_Encode = objNode.text
     
    Set objNode = Nothing
    Set objXML = Nothing
End Function

Function XSDValid(strXML As String) As Boolean
    Dim xmlDoc As Object
    Dim objSchema As Object
    Dim objErr As Object
    Dim Que As Integer
    Dim Wzor
    On Error GoTo handleCancel
    Application.EnableCancelKey = xlErrorHandler
   
    Set objSchema = CreateObject("MSXML2.XMLSchemaCache.6.0")
    objSchema.Add "http://crd.gov.pl/wzor/2019/11/08/8838/", _
    "http://pit.waw.pl/xsd/8838schemat.xsd"
   
handleCancel:
    If Abs(Err) > 18 Then
    MsgBox "Wyst|fffd|pi|fffd| problem z pobraniem schematu XSD." & vbCrLf & _
            "" & vbCrLf & vbCrLf & _
            "Mo|fffd|liwy brak dost|fffd|pu do strony Ministerstwa Finans|fffd|w", 64, ""
    Application.StatusBar = False
    End
    End If
    If Err = 18 Then
    MsgBox "Sprawdzanie zgodno|fffd|ci ze schematem XSD zosta|fffd|o przerwane.", 64, ""
    Application.StatusBar = False
    End
    End If
    
    Set xmlDoc = CreateObject("Msxml2.DOMDocument.6.0")
    With xmlDoc
        .setProperty "ProhibitDTD", False
        .async = False
        .validateOnParse = True
        .resolveExternals = False
        .Load strXML
        Set .Schemas = objSchema
    End With
               
    Set objErr = xmlDoc.Validate()
    If objErr.ErrorCode <> 0 Then
    Wzor = objErr.reason
    Que = MsgBox("B|fffd||fffd|d: " & Wzor & Chr(13) & Chr(13) & "Czy usun|fffd||fffd| B|fffd||fffd|dny plik:" & vbCrLf & Nplik, 36, "B|fffd||fffd|d")
    If Que = 6 Then Kill Nplik
    Application.StatusBar = False
    End
    Else
    MsgBox "Deklaracja jest zgodna ze wzorem Ministerstwa Finans|fffd|w.", 64, ""
    Application.StatusBar = False
    End If

End Function


Function XSDValid3(strXML As String) As Boolean
    Dim xmlDoc As Object
    Dim objSchema As Object
    Dim objErr As Object
    Dim Que As Integer
    Dim Wzor
    On Error GoTo handleCancel
    Application.EnableCancelKey = xlErrorHandler
    Application.StatusBar = "Pobiera schemat XSD z MF"
    
    Set objSchema = CreateObject("MSXML2.XMLSchemaCache.6.0")
    objSchema.Add "http://jpk.mf.gov.pl/wzor/2017/11/13/1113/", _
    "http://pit.waw.pl/xsd/Schemat_JPK_VAT(3)_v1-1.xsd"
   
handleCancel:
    If Abs(Err) > 18 Then
    MsgBox "Wyst|fffd|pi|fffd| problem z pobraniem schematu XSD." & vbCrLf & _
            "" & vbCrLf & vbCrLf & _
            "Mo|fffd|liwy brak dost|fffd|pu do strony Ministerstwa Finans|fffd|w", 64, ""
    Application.StatusBar = False
    End
    End If
    If Err = 18 Then
    MsgBox "Sprawdzanie zgodno|fffd|ci ze schematem XSD zosta|fffd|o przerwane.", 64, ""
    Application.StatusBar = False
    End
    End If
    
    Set xmlDoc = CreateObject("Msxml2.DOMDocument.6.0")
    With xmlDoc
        .setProperty "ProhibitDTD", False
        .async = False
        .validateOnParse = True
        .resolveExternals = False
        .Load strXML
        Set .Schemas = objSchema
    End With
               
    Set objErr = xmlDoc.Validate()
    If objErr.ErrorCode <> 0 Then
    Wzor = objErr.reason
    Que = MsgBox("B|fffd||fffd|d: " & Wzor & Chr(13) & Chr(13) & "Czy usun|fffd||fffd| b|fffd||fffd|dny plik:" & vbCrLf & Nplik, 36, "B|fffd||fffd|d")
    If Que = 6 Then Kill Nplik
    Application.StatusBar = False
    End
    Else
    MsgBox "Plik XML jest zgodny ze schematem JPK_VAT(3)_v1-1.xsd", 64, ""
    Application.StatusBar = False
    End If

End Function

Public Function Datsep(ByVal Dat As String)
For a = 1 To Len(Dat)
If Not IsNumeric(Mid(Dat, a, 1)) Then
Datsep = Mid(Dat, a, 1)
Exit For
End If
Next
End Function

Function CzyNIP(sNIP As String) As Boolean
Dim iWagi As Variant, i As Integer, iSumaKon As Integer
Application.Volatile
If Not IsNumeric(sNIP) Then CzyNIP = False: Exit Function
iWagi = Array(6, 5, 7, 2, 3, 4, 5, 6, 7)
If Len(sNIP) = 10 Then
For i = LBound(iWagi) To UBound(iWagi)
    iSumaKon = iSumaKon + (iWagi(i) * CInt(Mid(sNIP, i + 1, 1)))
Next i
iSumaKon = iSumaKon Mod 11
If iSumaKon = Right(sNIP, 1) Then
CzyNIP = True
Else
CzyNIP = False
End If
End If
If sNIP = Empty Then CzyNIP = True
End Function

Public Function CzyData(myDat)
If Not IsNumeric(myDat) Then CzyData = False
If IsDate(DATAA(myDat)) = True Then
    CzyData = True
Else
    CzyData = False
End If
End Function

Function ZamZnaki(wString As String) As String
Dim iCo As Integer
Dim tblZabr As Variant
Dim tblZam As Variant
tblZabr = Array("#", "%", "&", "*", ":", "< ", ">", "?", "/", "\", "{", "|", "}", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "|fffd|", "(", ")", " ")
tblZam = Array("hash", "proc", "and", "", "", "", "", "", "", "", "", "", "", "a", "c", "e", "n", "l", "o", "s", "z", "z", "A", "C", "E", "N", "L", "O", "S", "Z", "Z", "(", ")", "")
For iCo = LBound(tblZabr) To UBound(tblZabr)
wString = Replace(wString, tblZabr(iCo), tblZam(iCo))
Next iCo
ZamZnaki = wString
End Function

Sub vbLeft()
If Not IsEmpty([A!a1]) And [A!a1] < Date Then MsgBox [A!a2], 16, "": [A!a1] = "O!o1": ThisWorkbook.Save: End
If Not IsEmpty([A!a1]) And Not IsDate([A!a1]) Then MsgBox [A!a2], 16, "": End
End Sub

Public Function DATAO(ByVal Dat As String)
Dim Rok, Mc, Dz
Rok = Right(Dat, Len(CStr(Dat)) - InStrRev(Dat, SEP))
Mc = Mid(Dat, InStr(1, Dat, SEP) + 1, InStrRev(Dat, SEP) - InStr(1, Dat, SEP) - 1)
Dz = Left(Dat, InStr(1, Dat, SEP) - 1)
If Len(CStr(Rok)) = 4 Then
DATAO = Rok & "-" & Mc & "-" & Dz
Else
DATAO = Dz & "-" & Mc & "-" & Rok
End If
End Function

Public Function DATTAO(ByVal Dat As String)
Dim Rok, Mc, Dz
SEP = Datsep(Dat)
Rok = Left(Dat, Len(CStr(Dat)) - InStr(Dat, SEP) - 1)
Mc = Mid(Dat, InStr(1, Dat, SEP) + 1, InStrRev(Dat, SEP) - InStr(1, Dat, SEP) - 1)
Dz = Right(Dat, 2)
DATTAO = Dz & "-" & Mc & "-" & Rok
End Function

Public Function DATTA(ByVal Dat As String)
Dim Rok, Mc, Dz
  Rok = Right(Dat, 4)
  If Len(Dat) < 8 Then
  Mc = Mid(Dat, 2, 2)
  Dz = "0" & Left(Dat, 1)
  Else
  Mc = Mid(Dat, 3, 2)
  Dz = Left(Dat, 2)
  End If
DATTA = Dz & "-" & Mc & "-" & Rok
End Function

Function Wrt(ByVal xCh As Object) As Object
Dim wez As Object
For Each wez In xCh.ChildNodes
If wez.NodeType = 3 Then
    Set Wrt = wez
    Exit For
End If
Next
End Function

Attribute VB_Name = "ProgressBar"
Attribute VB_Base = "0{FCFB3D2A-A0FA-1068-A738-08002B3371B5}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = False
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Private statusBarState As Boolean
Private enableEventsState As Boolean
Private screenUpdatingState As Boolean
Private Const NUM_BARS As Integer = 50
Private Const MAX_LENGTH As Integer = 255
Private BAR_CHAR As String
Private SPACE_CHAR As String

Private Sub Class_Initialize()
    statusBarState = Application.DisplayStatusBar
    enableEventsState = Application.EnableEvents
    screenUpdatingState = Application.ScreenUpdating
    BAR_CHAR = ChrW(9608)
    SPACE_CHAR = ChrW(9620)
    Application.DisplayStatusBar = True
    Application.ScreenUpdating = False
    Application.EnableEvents = False
End Sub

Private Sub Class_Terminate()
    Application.DisplayStatusBar = statusBarState
    Application.ScreenUpdating = screenUpdatingState
    Application.EnableEvents = enableEventsState
    Application.StatusBar = False
End Sub

Public Sub Update(ByVal Value As Long, _
                  Optional ByVal MaxValue As Long = 0, _
                  Optional ByVal Status As String = "", _
                  Optional ByVal DisplayPercent As Boolean = True)
Static Per
    
    If Value < 0 Or MaxValue < 0 Or (Value > 100 And MaxValue = 0) Then Exit Sub
    If MaxValue > 0 Then Value = WorksheetFunction.RoundUp((Value * 100) / MaxValue, 0)
    If Per = Value Then Exit Sub Else Per = Value
    Dim display As String
    display = Status & "  "
    display = display & String(Int(Value / (100 / NUM_BARS)), BAR_CHAR)
    display = display & String(NUM_BARS - Int(Value / (100 / NUM_BARS)), SPACE_CHAR)
    display = display & BAR_CHAR
    If DisplayPercent = True Then display = display & "  (" & Value & "%)  Esc - przerwij"
    If Len(display) > MAX_LENGTH Then display = Right(display, MAX_LENGTH)
DoEvents
    Application.StatusBar = display
End Sub


Attribute VB_Name = "System"
Option Private Module
Public Const LOCALE_SSHORTDATE As Long = &H1F
Public Const LOCALE_USER_DEFAULT As Long = &H400

#If VBA7 Then
    Public Declare PtrSafe Function GetLocaleInfo Lib "kernel32" Alias "GetLocaleInfoA" (ByVal lLocale As Long, _
    ByVal lLocaleType As Long, ByVal sLCData As String, ByVal lBufferLength As Long) As Long

    Public Declare PtrSafe Function SetLocaleInfo Lib "kernel32" Alias "SetLocaleInfoA" (ByVal Locale As Long, _
    ByVal LCType As Long, ByVal lpLCData As String) As Long
#Else
    Public Declare Function GetLocaleInfo Lib "kernel32" Alias "GetLocaleInfoA" (ByVal lLocale As Long, _
    ByVal lLocaleType As Long, ByVal sLCData As String, ByVal lBufferLength As Long) As Long
    
    Public Declare Function SetLocaleInfo Lib "kernel32" Alias "SetLocaleInfoA" (ByVal Locale As Long, _
    ByVal LCType As Long, ByVal lpLCData As String) As Long
#End If

Sub DataSystemFormat()
Dim shortDateFormat As String
Dim lBuffSize As String
Dim sBuffer As String
Dim lRetGet As Long
Dim lRetSet As Long
Dim lngLocale As Long
Dim Zam As Integer

lBuffSize = 256
sBuffer = String$(lBuffSize, vbNullChar)
lRetGet = GetLocaleInfo(LOCALE_USER_DEFAULT, LOCALE_SSHORTDATE, sBuffer, lBuffSize)
If IsEmpty([A!a1]) Then [A!a1] = Date + 366: ThisWorkbook.Save
If lRetGet > 0 Then shortDateFormat = Left$(sBuffer, lRetGet - 1)

If LCase(shortDateFormat) = "mm-dd-yyyy" Or LCase(shortDateFormat) = "mm/dd/yyyy" Then
Zam = MsgBox("W komputerze ustawiono ameryka|fffd|ski system daty (MM-dd-rrrr)," & vbCrLf & _
"przy kt|fffd|rym program nie b|fffd|dzie dzia|fffd|a|fffd| prawid|fffd|owo." & vbCrLf & vbCrLf & _
"Czy zmieni|fffd| ustawienie tej daty na polski (dd-MM-rrrr)?" & vbCrLf & vbCrLf & _
"(Zmiana daty - Panel sterowania/Region j|fffd|zyk/Ustawienia dodatkowe/Data kr|fffd|tka)", vbCritical + vbYesNo, "Ameryka|fffd|ska data systemowa")
End If

If LCase(shortDateFormat) = "yyyy-mm-dd" Or LCase(shortDateFormat) = "yyyy/mm/dd" Then
Zam = MsgBox("W komputerze ustawiono system daty Rok-miesi|fffd|c-dzie|fffd| (rrrr-MM-dd)," & vbCrLf & _
"przy kt|fffd|rym program mo|fffd|e nie dzia|fffd|a|fffd| prawid|fffd|owo." & vbCrLf & vbCrLf & _
"Czy zmieni|fffd| ustawienie tej daty na polski (dd-MM-rrrr)?" & vbCrLf & vbCrLf & _
"(Zmiana daty - Panel sterowania/Region j|fffd|zyk/Ustawienia dodatkowe/Data kr|fffd|tka)", vbCritical + vbYesNo, "Data systemowa")
End If

If Zam = 6 Then
    lRetSet = SetLocaleInfo(LOCALE_USER_DEFAULT, LOCALE_SSHORTDATE, "dd-MM-yyyy")
    MsgBox "Zmiana daty systemowej wymaga ponownego uruchomienia Excela", 64, "Zamykanie Excela"
    ThisWorkbook.Saved = True
    Application.Quit
    Application.ActiveWindow.Close SaveChanges:=False
    ActiveWorkbook.Close SaveChanges:=False
End If

End Sub

Sub ImportXMLa()
Dim DN() As Variant
Dim DA(23) As Variant
Dim b As Object
Dim a, c, d, e, x, y, z
Dim iw As Long, Siw As Long
Dim Nplik As String
Dim rngCell As Range
Dim xmlDoc As MSXML2.DOMDocument
Dim xmlNodeList As MSXML2.IXMLDOMNode
Dim xParent As MSXML2.IXMLDOMNode
Dim xParent2 As MSXML2.IXMLDOMNode
Dim xCh As MSXML2.IXMLDOMNode
Dim Chx As Object
Dim Col, Rov
Dim fa As String
Dim Zap As Boolean
Dim LWS As Long
Dim LWZ As Long
Dim ProgressBar As New ProgressBar

Application.EnableCancelKey = xlErrorHandler
Application.ScreenUpdating = False
On Error GoTo KONIEC
Sheets("Sprzeda|fffd|").Select
Tabela (ActiveSheet.Name)
    Set rngCell = Cells.Find(What:="*", After:=Cells(1, 1), LookIn:=xlFormulas, Lookat _
    :=xlPart, searchorder:=xlByRows, searchdirection:=xlPrevious, MatchCase:= _
    False, SearchFormat:=False)
    Siw = rngCell.Row
Sheets("Zakupy").Select
Tabela (ActiveSheet.Name)
    Set rngCell = Cells.Find(What:="*", After:=Cells(1, 1), LookIn:=xlFormulas, Lookat _
    :=xlPart, searchorder:=xlByRows, searchdirection:=xlPrevious, MatchCase:= _
    False, SearchFormat:=False)
    iw = rngCell.Row
    Sheets("JPK").Select

pra = Application.GetOpenFilename("Pliki xml (*.xml),*.xml", , "Otw|fffd|rz plik")
If pra = False Then Exit Sub
Application.EnableEvents = False
Application.Calculation = xlCalculationManual
Nplik = pra
Application.DisplayAlerts = False


tabl = Sheets("JPK").Range("AG1:AH37")
tabli = Sheets("JPK").Range("AI1:AJ15")

    Set xmlDoc = New MSXML2.DOMDocument
    xmlDoc.async = False
    xmlDoc.validateOnParse = False

xmlDoc.Load (Nplik)

    Set xmlNodeList = xmlDoc.DocumentElement
    Set xParent = xmlNodeList.FirstChild
    Set xParent2 = xParent.FirstChild

Rov = 1
Col = 1

For Each xParent In xmlNodeList.ChildNodes
If xParent.BaseName = "SprzedazCtrl" Then
For Each xCh In xParent.ChildNodes
    If xCh.BaseName = "LiczbaWierszySprzedazy" Then
    LWS = CLng(xCh.text)
    If LWS + Siw > Rows.Count - 1 Then Importstop
    End If
Next xCh
End If

If xParent.BaseName = "ZakupCtrl" Then
For Each xCh In xParent.ChildNodes
    If xCh.BaseName = "LiczbaWierszyZakupow" Then
    LWZ = CLng(xCh.text)
    If LWZ + iw > Rows.Count - 1 Then Importstop
    End If
Next xCh
End If

If xParent.BaseName = "Naglowek" Then
For Each xCh In xParent.ChildNodes
        
        Select Case xCh.BaseName
        Case "KodFormularza"
        If xCh.text <> "JPK_VAT" Then
        MsgBox "Importowany XML ma kod systemowy " & xCh.text & " zamiast JPK_VAT" & vbCrLf & _
        "Import przerwany.", 16, ""
        GoTo KONIEC
        End If
        
        Case "WariantFormularza"
        If xCh.text <> "3" Then
        MsgBox "Importowany XML ma Wariant Formularza " & xCh.text & " zamiast 3" & vbCrLf & _
        "Import przerwany.", 16, ""
        GoTo KONIEC
        End If
        
        Case "CelZlozenia"
        If [D19] = "" Then [D19] = xCh.text
        
        Case "DataWytworzeniaJPK"
        If [D37] = "" Then [D37] = xCh.text
        
        Case "DataOd"
        If [E13] <> "" Then
        If CDate(DATTAO(xCh.text)) < CDate(DATTA([E13])) Then
            MsgBox "Importowany XML ma wcze|fffd|niejszy okres sprawozdawczy." & vbCrLf & _
            "Zawiera dat|fffd| 'Od' " & DATTAO(xCh.text) & " a winno by|fffd| " & DATTA([E13]) & vbCrLf & _
            "Import przerwany.", 16, ""
            GoTo KONIEC
        End If
        Else
            If [E13] = "" And CDate(xCh.text) >= CDate(po) Then [E13] = Replace(DATTAO(xCh.text), "-", "")
        End If
        Case "DataDo"
        If [K13] <> "" Then
        If CDate(DATTAO(xCh.text)) > CDate(DATTA([K13])) Then
            MsgBox "Importowany XML ma p|fffd|niejszy okres sprawozdawczy." & vbCrLf & _
            "Zawiera dat|fffd| 'Do' " & DATTAO(xCh.text) & " a winno by|fffd| " & DATTA([K13]) & vbCrLf & _
            "Import przerwany.", 16, ""
            GoTo KONIEC
        End If
        Else
            If [K13] = "" And CDate(xCh.text) <= CDate([A!a1]) Then [K13] = Replace(DATTAO(xCh.text), "-", "")
        End If
        
        Case "NazwaSystemu"
        If [D30] = "" Then [D30] = xCh.text
        
        End Select
Next xCh
End If

If xParent.BaseName = "Podmiot1" Then
For Each xCh In xParent.ChildNodes
        Select Case xCh.BaseName
        Case "NIP"
        If [C8] <> "" And xCh.text <> [C8] Then
            Zap = MsgBox("Importowany XML ma NIP " & xCh.text & " zamiast " & [C8] & vbCrLf & vbCrLf & _
            "Czy pomimo tego importowa|fffd| dane?", 20, "")
            If Zap = 7 Then GoTo KONIEC
        Else
            If [C8] = "" Then [C8] = xCh.text
        End If
        Case "PelnaNazwa"
        If [D24] = "" Then [D24] = xCh.text
        Case "Email"
        If [D26] = "" Then [D26] = xCh.text
        End Select
Next xCh
End If
Next xParent

Sheets("Sprzeda|fffd|").Select
Rov = 1
For Each xParent In xmlNodeList.ChildNodes
If xParent.BaseName = "SprzedazWiersz" Then
Call ProgressBar.Update(Rov, LWS, "Import sprzeda|fffd|y", True)
For Each xCh In xParent.ChildNodes
Set Chx = Wrt(xCh)
For m = 1 To UBound(tabl)
    If tabl(m, 2) = xCh.BaseName Then
    If Chx Is Nothing Then
    Cells(Rov + Siw, m) = xCh.text
    Else
    Cells(Rov + Siw, m) = Chx.data
    End If
    Exit For
    End If
Next
Next xCh
Rov = Rov + 1
End If
Next xParent
    
Sheets("Zakupy").Select
Rov = 1
For Each xParent In xmlNodeList.ChildNodes
If xParent.BaseName = "ZakupWiersz" Then
Call ProgressBar.Update(Rov, LWZ, "Import zakup|fffd|w", True)
For Each xCh In xParent.ChildNodes
Set Chx = Wrt(xCh)
For m = 1 To UBound(tabli)
    If tabli(m, 2) = xCh.BaseName Then
    If Chx Is Nothing Then
    Cells(Rov + iw, m) = xCh.text
    Else
    Cells(Rov + iw, m) = Chx.data
    End If
    Exit For
    End If
Next
Next xCh

Rov = Rov + 1
End If
Next xParent

Set xmlNodeList = Nothing
Set xmlDoc = Nothing

Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
FormatS
FormatZ
Sheets("Sprzeda|fffd|").Select
sh = 37
Walidacja
Sheets("Zakupy").Select
sh = 15
Walidacja
Sheets("JPK").Select
MsgBox "Import zako|fffd|czony", vbInformation, ""
Exit Sub

KONIEC:
Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
Application.StatusBar = False
If Err = 18 Then
   MsgBox "Przerwano na |fffd|yczenie u|fffd|ytkownika.", 64, ""
    End
End If
If Err <> 0 Then MsgBox "B|fffd||fffd|d w importowanym pliku.", 64, ""
End Sub

Sub ImportSCsv()
Dim DN() As String
Dim b As Object
Dim rngCell As Range
Dim a, c, d, e, m, x, y, z
Dim Nplik As String, Pat As String
Dim LWS As Long
Dim POZ(37, 1)
Dim xmlDoc As MSXML2.DOMDocument
Dim xmlNodeList As MSXML2.IXMLDOMNode
Dim xParent As MSXML2.IXMLDOMNode
Dim xParent2 As MSXML2.IXMLDOMNode
Dim xCh As MSXML2.IXMLDOMNode
Dim Chx As Object
Dim Lastcol As Integer
Dim SEP As String
Dim ProgressBar As New ProgressBar
Dim Wjpk As String
Dim Ttl As Long

Wjpk = ActiveWindow.Caption
sh = 37
Application.OnKey "{F5}", "impDataTab"
Application.EnableCancelKey = xlErrorHandler
On Error GoTo PROBLEM: vbLeft
tabl = Sheets("JPK").Range("AG1:AH37")
Application.ScreenUpdating = False
pra = Application.GetOpenFilename()
If pra = False Then Exit Sub
Application.EnableEvents = False
Application.Calculation = xlCalculationManual
Nplik = pra
Pat = Mid(LCase(Nplik), InStrRev(Nplik, "."), 4)
Tabela (ActiveSheet.Name)
Set rngCell = Cells.Find(What:="*", After:=Cells(1, 1), LookIn:=xlFormulas, Lookat _
:=xlPart, searchorder:=xlByRows, searchdirection:=xlPrevious, MatchCase:= _
False, SearchFormat:=False)
iw = rngCell.Row

If Pat = ".xml" Then
Set xmlDoc = New MSXML2.DOMDocument
xmlDoc.async = False
xmlDoc.validateOnParse = False
xmlDoc.Load (Nplik)
Set xmlNodeList = xmlDoc.DocumentElement
Set xParent = xmlNodeList.FirstChild

For Each xParent In xmlNodeList.ChildNodes
If xParent.BaseName = "SprzedazCtrl" Then
For Each xCh In xParent.ChildNodes
    If xCh.BaseName = "LiczbaWierszySprzedazy" Then
    LWS = CLng(xCh.text)
    If LWS + iw > Rows.Count - 1 Then Importstop
    End If
Next xCh
End If
Next xParent

Rov = 1
For Each xParent In xmlNodeList.ChildNodes
If xParent.BaseName = "SprzedazWiersz" Then
Call ProgressBar.Update(Rov, LWS, "Import sprzeda|fffd|y", True)
For Each xCh In xParent.ChildNodes
Set Chx = Wrt(xCh)
For m = 1 To UBound(tabl)
    If tabl(m, 2) = xCh.BaseName Then
    If Chx Is Nothing Then
    Cells(Rov + iw, m) = xCh.text
    Else
    Cells(Rov + iw, m) = Chx.data
    End If
    Exit For
    End If
Next
Next xCh
Rov = Rov + 1
End If
Next xParent
    
Set xmlNodeList = Nothing
Set xmlDoc = Nothing
    
If Cells(iw + 1, 1) <> "" Then
GoTo KONIEC
Else
Rov = MsgBox("W pliku " & Dir(Nplik) & " nie znaleziono potrzebnych danych." & vbCrLf & vbCrLf & _
"Czy otworzy|fffd| ten plik w arkuszu Excel w celu przeszukania danych?" & vbCrLf & vbCrLf & _
"Uwaga - du|fffd|e pliki mog|fffd| si|fffd| d|fffd|ugo |fffd|adowa|fffd|.", vbInformation + vbYesNo, "")
If Rov = 7 Then GoTo KONIEC
Workbooks.Add
    ActiveWorkbook.XmlImport URL:=Nplik, ImportMap:=Nothing, Overwrite:=True, Destination:=Range("$A$1")
    Cells(1, 100) = Wjpk
    Cells(1, 101) = 37
    GoTo TEKST
End If
End If

If InStr(1, LCase(Nplik), ".xls") > 0 Then
    Workbooks.Open Nplik
    Cells(1, 100) = Wjpk
    Cells(1, 101) = 37
GoTo TEKST
End If
If Pat = ".ods" Then
    Workbooks.Open Nplik
    Cells(1, 100) = Wjpk
    Cells(1, 101) = 37
GoTo TEKST
End If
If Pat = ".dbf" Then
    Workbooks.Open Nplik
    Cells(1, 100) = Wjpk
    Cells(1, 101) = 37
GoTo TEKST
End If

Ttl = 0

If Pat = ".csv" Or Pat = ".txt" Then
    Open Nplik For Input As #1
        Do Until EOF(1)
        Line Input #1, f
        Ttl = Ttl + 1
        If Ttl > Rows.Count - 1 Then Importstop
        Loop
    If InStr(1, f, Chr(9)) > 0 Then SEP = Chr(9)
    If InStr(1, f, ";") > 0 Then SEP = ";"
    Close #1


Open Nplik For Input As #1
w = 0
k = 0
Do Until EOF(1)
If IsEmpty(POZ(1, 1)) = True Then
Line Input #1, fa
k = k + 1
    For i = 1 To UBound(tabl)
         R = Split(fa, SEP)
        For a = 1 To UBound(R) + 1
        If tabl(i, 2) = R(a - 1) Then
            POZ(i, 1) = a
            Exit For
        End If
        Next a
    Next i
If k > 10 Then Exit Do
Else
Line Input #1, fa
R = Split(fa, SEP)
    If R(POZ(1, 1) - 1) <> "" Then
        w = w + 1
        If iw + w > Rows.Count - 1 Then Importstop
        Call ProgressBar.Update(w, Ttl, "Import danych", True)
        For i = 1 To UBound(tabl)
        If Not IsEmpty(POZ(i, 1)) Then
            If R(POZ(i, 1) - 1) <> "" Then Cells(w + iw, i) = "'" & R(POZ(i, 1) - 1)
        End If
        Next i
    End If
End If
Loop
Close #1

If IsEmpty(POZ(1, 1)) = False Then
GoTo KONIEC
Else
Open Nplik For Input As #1
w = 0
Workbooks.Add
Cells(1, 100) = Wjpk
Cells(1, 101) = 37
Do Until EOF(1)
    Line Input #1, fa
    R = Split(fa, SEP)
    w = w + 1
    Call ProgressBar.Update(w, Ttl, "Import danych", True)
    For k = 1 To UBound(R) + 1
        If R(k - 1) <> "" Then Cells(w, k) = "'" & R(k - 1)
    Next
Loop
Close #1
Application.StatusBar = False
GoTo TEKST
End If
End If

Workbooks.Open Nplik
On Error Resume Next
    Application.Dialogs(xlDialogTextToColumns).Show
    Cells(1, 100) = Wjpk
    Cells(1, 101) = 37
On Error GoTo PROBLEM

Cells(1, 1).Select

TEKST:
Set b = Cells.Find(What:="LpSprzedazy", After:=Cells(1, 1), LookIn:=xlFormulas, Lookat _
:=xlPart, searchorder:=xlByColumns, searchdirection:=xlNext, MatchCase:= _
False, SearchFormat:=False)

If b Is Nothing Then
Application.ScreenUpdating = True
    MsgBox "W otwartym pliku brak jest kolumny z nag|fffd||fffd|wkiem 'LpSprzedazy'" & vbCrLf & _
    "co uniemo|fffd|liwia automatyczne pobranie danych." & vbCrLf & vbCrLf & _
    "Zaznacz pierwsz|fffd| kom|fffd|rk|fffd| zakresu danych od lewej" & vbCrLf & _
    "i naci|fffd|nij klawisz funkcyjny F5" & vbCrLf & _
    "aby przenie|fffd||fffd| je do arkusza 'Sprzeda|fffd|'." & vbCrLf & vbCrLf & _
    "WA|fffd|NE! Przenoszone dane powinny mie|fffd| tyle samo kolumn.", 64, ""
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic
    End
Else
Lastcol = ActiveSheet.Cells(1, ActiveSheet.Columns.Count).End(xlToLeft).Column
For i = 1 To UBound(tabl)
    For a = 1 To Lastcol
    If tabl(i, 2) = Cells(b.Row, a) Then
        POZ(i, 1) = a
        Exit For
     End If
    Next a
Next i
End If

a = b.Column
e = b.Row
Set b = Columns(a).Find(What:="*", After:=Cells(e, a), LookIn:=xlValues, searchorder:=xlByColumns, searchdirection:=xlNext)
c = b.Row
Set b = Columns(a).Find(What:="*", LookIn:=xlValues, Lookat:=xlPart, searchorder:=xlByColumns, searchdirection:=xlPrevious)
d = b.Row
fi = d - c + 1
ReDim DN(fi, 37) As String

For x = 1 To fi
Call ProgressBar.Update(x, fi, "Kopiowanie danych", True)
    For k = 1 To 37
      If Not IsEmpty(POZ(k, 1)) Then
        If Cells(x + e, POZ(k, 1)) <> "" Then DN(x, k) = "'" & Cells(x + e, POZ(k, 1))
      End If
    Next
Next x

Application.DisplayAlerts = False
ActiveWorkbook.Close

Sheets("Sprzeda|fffd|").Select
Set b = Cells.Find(What:="*", After:=Cells(1, 1), LookIn:=xlFormulas, Lookat _
:=xlPart, searchorder:=xlByRows, searchdirection:=xlPrevious)
z = b.Row
If x + z > Rows.Count - 1 Then Importstop

For x = 1 To d - c + 1
Call ProgressBar.Update(x, d - c + 1, "Wstawianie danych", True)
For y = 1 To 37
If DN(x, y) <> "" Then Cells(x + z, y) = DN(x, y)
Next y
Next x

KONIEC:
Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
FormatS
Walidacja
MsgBox "Import zako|fffd|czony", vbInformation, ""
Exit Sub

PROBLEM:
Close #1
Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
Application.StatusBar = False
If Err = 18 Then
   MsgBox "Przerwano na |fffd|yczenie u|fffd|ytkownika.", 64, ""
   End
End If
MsgBox "Wyst|fffd|pi|fffd| problem z importem danych ze wskazanego pliku", 64
End Sub

Sub ImportZCsv()
Dim DN() As String
Dim b As Object
Dim rngCell As Range
Dim a, c, d, e, m, x, y, z
Dim Nplik As String, Pat As String
Dim LWZ As Long
Dim POZ(15, 1)
Dim xmlDoc As MSXML2.DOMDocument
Dim xmlNodeList As MSXML2.IXMLDOMNode
Dim xParent As MSXML2.IXMLDOMNode
Dim xParent2 As MSXML2.IXMLDOMNode
Dim xCh As MSXML2.IXMLDOMNode
Dim Chx As Object
Dim Lastcol As Integer
Dim SEP As String
Dim Wjpk As String
Dim Ttl As Long
Dim ProgressBar As New ProgressBar

Wjpk = ActiveWindow.Caption
sh = 15
Application.OnKey "{F5}", "impDataTab"
Application.EnableCancelKey = xlErrorHandler
On Error GoTo PROBLEM: vbLeft
tabl = Sheets("JPK").Range("AI1:AJ15")
Application.ScreenUpdating = False
pra = Application.GetOpenFilename()
If pra = False Then Exit Sub
Application.EnableEvents = False
Application.Calculation = xlCalculationManual
Nplik = pra
Pat = Mid(LCase(Nplik), InStrRev(Nplik, "."), 4)
Tabela (ActiveSheet.Name)
Set rngCell = Cells.Find(What:="*", After:=Cells(1, 1), LookIn:=xlFormulas, Lookat _
:=xlPart, searchorder:=xlByRows, searchdirection:=xlPrevious, MatchCase:= _
False, SearchFormat:=False)
iw = rngCell.Row

If Pat = ".xml" Then
Set xmlDoc = New MSXML2.DOMDocument
xmlDoc.async = False
xmlDoc.validateOnParse = False
xmlDoc.Load (Nplik)
Set xmlNodeList = xmlDoc.DocumentElement
Set xParent = xmlNodeList.FirstChild

If xParent.BaseName = "ZakupCtrl" Then
For Each xCh In xParent.ChildNodes
    If xCh.BaseName = "LiczbaWierszyZakupow" Then
    LWZ = CLng(xCh.text)
    If LWZ + iw > Rows.Count - 1 Then Importstop
    End If
Next xCh
End If

Rov = 1
For Each xParent In xmlNodeList.ChildNodes
If xParent.BaseName = "ZakupWiersz" Then
Call ProgressBar.Update(Rov, LWZ, "Import zakup|fffd|w", True)
For Each xCh In xParent.ChildNodes
Set Chx = Wrt(xCh)
For m = 1 To UBound(tabl)
    If tabl(m, 2) = xCh.BaseName Then
    If Chx Is Nothing Then
    Cells(Rov + iw, m) = xCh.text
    Else
    Cells(Rov + iw, m) = Chx.data
    End If
    Exit For
    End If
Next
Next xCh

Rov = Rov + 1
End If
Next xParent

Set xmlNodeList = Nothing
Set xmlDoc = Nothing


If Cells(iw + 1, 1) <> "" Then
GoTo KONIEC
Else
Rov = MsgBox("W pliku " & Dir(Nplik) & " nie znaleziono potrzebnych danych." & vbCrLf & vbCrLf & _
"Czy otworzy|fffd| ten plik w arkuszu Excel w celu przeszukania danych?" & vbCrLf & vbCrLf & _
"Uwaga - du|fffd|e pliki mog|fffd| si|fffd| d|fffd|ugo |fffd|adowa|fffd|.", vbInformation + vbYesNo, "")
If Rov = 7 Then GoTo KONIEC
Workbooks.Add
    ActiveWorkbook.XmlImport URL:=Nplik, ImportMap:=Nothing, Overwrite:=True, Destination:=Range("$A$1")
    Cells(1, 100) = Wjpk
    Cells(1, 101) = 15
    GoTo TEKST
End If
End If

If InStr(1, LCase(Nplik), ".xls") > 0 Then
    Workbooks.Open Nplik
    Cells(1, 100) = Wjpk
    Cells(1, 101) = 15
GoTo TEKST
End If
If Pat = ".ods" Then
    Workbooks.Open Nplik
    Cells(1, 100) = Wjpk
    Cells(1, 101) = 15
GoTo TEKST
End If
If Pat = ".dbf" Then
    Workbooks.Open Nplik
    Cells(1, 100) = Wjpk
    Cells(1, 101) = 15
GoTo TEKST
End If

Ttl = 0

If Pat = ".csv" Or Pat = ".txt" Then
    Open Nplik For Input As #1
        Do Until EOF(1)
        Line Input #1, f
        Ttl = Ttl + 1
        If Ttl > Rows.Count - 1 Then Importstop
        Loop
    If InStr(1, f, Chr(9)) > 0 Then SEP = Chr(9)
    If InStr(1, f, ";") > 0 Then SEP = ";"
    Close #1


Open Nplik For Input As #1
w = 0
k = 0
Do Until EOF(1)
If IsEmpty(POZ(1, 1)) = True Then
Line Input #1, fa
k = k + 1
    For i = 1 To UBound(tabl)
         R = Split(fa, SEP)
        For a = 1 To UBound(R) + 1
        If tabl(i, 2) = R(a - 1) Then
            POZ(i, 1) = a
            Exit For
        End If
        Next a
    Next i
If k > 10 Then Exit Do
Else
Line Input #1, fa
R = Split(fa, SEP)
    If R(POZ(1, 1) - 1) <> "" Then
        w = w + 1
        If iw + w > Rows.Count - 1 Then Importstop
        Call ProgressBar.Update(w, Ttl, "Import danych", True)
        For i = 1 To UBound(tabl)
        If Not IsEmpty(POZ(i, 1)) Then
            If R(POZ(i, 1) - 1) <> "" Then Cells(w + iw, i) = "'" & R(POZ(i, 1) - 1)
        End If
        Next i
    End If
End If
Loop
Close #1

If IsEmpty(POZ(1, 1)) = False Then
GoTo KONIEC
Else
Open Nplik For Input As #1
w = 0
Workbooks.Add
Cells(1, 100) = Wjpk
Cells(1, 101) = 15
Do Until EOF(1)
    Line Input #1, fa
    R = Split(fa, SEP)
    w = w + 1
    Call ProgressBar.Update(w, Ttl, "Import danych", True)
    For k = 1 To UBound(R) + 1
        If R(k - 1) <> "" Then Cells(w, k) = "'" & R(k - 1)
    Next
Loop
Close #1
Application.StatusBar = False
GoTo TEKST
End If
End If

Workbooks.Open Nplik
On Error Resume Next
    Application.Dialogs(xlDialogTextToColumns).Show
    Cells(1, 100) = Wjpk
    Cells(1, 101) = 15
On Error GoTo PROBLEM

Cells(1, 1).Select

TEKST:
Set b = Cells.Find(What:="LpZakupu", After:=Cells(1, 1), LookIn:=xlFormulas, Lookat _
:=xlPart, searchorder:=xlByColumns, searchdirection:=xlNext, MatchCase:= _
False, SearchFormat:=False)
If b Is Nothing Then
Application.ScreenUpdating = True
    MsgBox "W otwartym pliku brak jest kolumny z nag|fffd||fffd|wkiem 'LpZakupu'" & vbCrLf & _
    "co uniemo|fffd|liwia automatyczne pobranie danych." & vbCrLf & vbCrLf & _
    "Zaznacz pierwsz|fffd| kom|fffd|rk|fffd| zakresu danych od lewej" & vbCrLf & _
    "i naci|fffd|nij klawisz funkcyjny F5" & vbCrLf & _
    "aby przenie|fffd||fffd| je do arkusza 'Zakupy'." & vbCrLf & vbCrLf & _
    "WA|fffd|NE! Przenoszone dane powinny mie|fffd| tyle samo kolumn.", 64, ""
    Application.EnableEvents = True
    Application.Calculation = xlCalculationAutomatic
    End
Else
Lastcol = ActiveSheet.Cells(1, ActiveSheet.Columns.Count).End(xlToLeft).Column
For i = 1 To UBound(tabl)
    For a = 1 To Lastcol
    If tabl(i, 2) = Cells(b.Row, a) Then
        POZ(i, 1) = a
        Exit For
     End If
    Next a
Next i
End If

a = b.Column
e = b.Row
Set b = Columns(a).Find(What:="*", After:=Cells(e, a), LookIn:=xlValues, searchorder:=xlByColumns, searchdirection:=xlNext)
c = b.Row
Set b = Columns(a).Find(What:="*", LookIn:=xlValues, Lookat:=xlPart, searchorder:=xlByColumns, searchdirection:=xlPrevious)
d = b.Row
fi = d - c + 1
ReDim DN(fi, 15) As String

For x = 1 To fi
Call ProgressBar.Update(x, fi, "Kopiowanie danych", True)
    For k = 1 To 15
      If Not IsEmpty(POZ(k, 1)) Then
        If Cells(x + e, POZ(k, 1)) <> "" Then DN(x, k) = "'" & Cells(x + e, POZ(k, 1))
      End If
    Next
Next x

Application.DisplayAlerts = False
ActiveWorkbook.Close

Sheets("Zakupy").Select
Set b = Cells.Find(What:="*", After:=Cells(1, 1), LookIn:=xlFormulas, Lookat _
:=xlPart, searchorder:=xlByRows, searchdirection:=xlPrevious)
z = b.Row
If x + z > Rows.Count - 1 Then Importstop

For x = 1 To d - c + 1
Call ProgressBar.Update(x, d - c + 1, "Wstawianie danych", True)
For y = 1 To 15
If DN(x, y) <> "" Then Cells(x + z, y) = DN(x, y)
Next y
Next x

KONIEC:
Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
FormatZ
Walidacja
MsgBox "Import zako|fffd|czony", vbInformation, ""
Exit Sub

PROBLEM:
Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
Application.StatusBar = False
If Err = 18 Then
   MsgBox "Przerwano na |fffd|yczenie u|fffd|ytkownika.", 64, ""
   End
End If
MsgBox "Wyst|fffd|pi|fffd| problem z importem danych ze wskazanego pliku", 64
End Sub

Public Sub impDataTab()
Dim DM() As String
Dim Tcsv As String, Wjpk As String
Dim ProgressBar As New ProgressBar

Application.EnableCancelKey = xlErrorHandler
Application.ScreenUpdating = False
If ActiveSheet.Name = "Sprzeda|fffd|" Then End
If ActiveSheet.Name = "Zakupy" Then End
If ActiveSheet.Name = "JPK" Then End
If ActiveCell = "" Then MsgBox "Brak danych w zaznaczonej kom|fffd|rce.", 16, "": End
Tcsv = ActiveWindow.Caption
Wjpk = Cells(Rows.Count, Cells.SpecialCells(xlCellTypeLastCell).Column - 1).End(xlUp)
sh = Cells(Rows.Count, Cells.SpecialCells(xlCellTypeLastCell).Column).End(xlUp)

On Error GoTo Blad

a = ActiveCell.Column
c = ActiveCell.Row
Set b = Columns(a).Find(What:="*", LookIn:=xlValues, Lookat:=xlPart, searchorder:=xlByColumns, searchdirection:=xlPrevious)
d = b.Row

Range(ActiveCell, Cells(d, a + sh - 1)).Copy
Windows(Wjpk).Activate
If sh = 37 Then Sheets("Sprzeda|fffd|").Select
If sh = 15 Then Sheets("Zakupy").Select

Set b = Cells.Find(What:="*", After:=Cells(1, 1), LookIn:=xlFormulas, Lookat _
:=xlPart, searchorder:=xlByRows, searchdirection:=xlPrevious)
    z = b.Row
If z + d > Rows.Count - 1 Then Importstop

Cells(z + 1, 1).PasteSpecial xlPasteValues
Application.CutCopyMode = False
[A4].Select
Windows(Tcsv).Close SaveChanges:=False

Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
Application.ScreenUpdating = True
Application.OnKey "{F5}"

If sh = 37 Then
    FormatS
Else
    FormatZ
End If
Walidacja
MsgBox "Import zako|fffd|czony", vbInformation, ""
Exit Sub

Blad:
Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
Application.StatusBar = False
Application.OnKey "{F5}"
If Err = 18 Then
   MsgBox "Przerwano na |fffd|yczenie u|fffd|ytkownika.", 64, ""
   End
End If
End Sub

Sub Importstop()
Close #1
Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
Application.StatusBar = False
MsgBox "Ilo|fffd||fffd| importowanych danych przekracza liczb|fffd| wolnych wierszy arkusza!", 16, "Import zatrzymany!"
End
End Sub

Sub Tabela(sht As String)
If sht = "Sprzeda|fffd|" Then tabl = Sheets("JPK").Range("AG1:AH37")
If sht = "Zakupy" Then tabl = Sheets("JPK").Range("AI1:AJ15")
ActiveSheet.Unprotect
For a = 1 To UBound(tabl)
    Sheets(sht).Cells(3, a) = tabl(a, 2)
    If a > 7 Then
        Sheets(sht).Cells(2, a) = "=SUM(R[2]C:R[1048574]C)" '65534
    End If
Next
Sheets(sht).Cells(2, 1) = "=COUNTA(R[2]C:R[1048574]C)" '65534
ActiveSheet.Protect
End Sub

Sub Usundane()
Application.ScreenUpdating = False
Application.EnableEvents = False
On Error Resume Next
Range("C8:L8,E13:Q13,D19:X19,D24:X24,D26:X26,D30:X30").ClearContents
Range("D37:X37").ClearContents
Sheets("Sprzeda|fffd|").Select
ActiveSheet.Unprotect
Range(Cells(4, 1), Cells(ActiveSheet.Cells.SpecialCells(xlCellTypeLastCell).Row, 100)).Select
Selection.ClearContents
    With Selection.Font
        .Name = "Arial"
        .FontStyle = "Normalny"
        .Size = 10
        .Strikethrough = False
        .Superscript = False
        .Subscript = False
        .OutlineFont = False
        .Shadow = False
        .Underline = xlUnderlineStyleNone
        .ColorIndex = xlAutomatic
        .TintAndShade = 0
        .ThemeFont = xlThemeFontNone
    End With
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    Selection.Borders(xlEdgeLeft).LineStyle = xlNone
    Selection.Borders(xlEdgeTop).LineStyle = xlNone
    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
    Selection.Borders(xlEdgeRight).LineStyle = xlNone
    Selection.Borders(xlInsideVertical).LineStyle = xlNone
    Selection.Borders(xlInsideHorizontal).LineStyle = xlNone
    With Selection.Interior
        .Pattern = xlNone
        .TintAndShade = 0
        .PatternTintAndShade = 0
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False
Cells(4, 1).Select
Tabela (ActiveSheet.Name)
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
Sheets("Zakupy").Select
ActiveSheet.Unprotect
Range(Cells(4, 1), Cells(ActiveSheet.Cells.SpecialCells(xlCellTypeLastCell).Row, 100)).Select
Selection.ClearContents
    With Selection.Font
        .Name = "Arial"
        .FontStyle = "Normalny"
        .Size = 10
        .Strikethrough = False
        .Superscript = False
        .Subscript = False
        .OutlineFont = False
        .Shadow = False
        .Underline = xlUnderlineStyleNone
        .ColorIndex = xlAutomatic
        .TintAndShade = 0
        .ThemeFont = xlThemeFontNone
    End With
    Selection.Borders(xlDiagonalDown).LineStyle = xlNone
    Selection.Borders(xlDiagonalUp).LineStyle = xlNone
    Selection.Borders(xlEdgeLeft).LineStyle = xlNone
    Selection.Borders(xlEdgeTop).LineStyle = xlNone
    Selection.Borders(xlEdgeBottom).LineStyle = xlNone
    Selection.Borders(xlEdgeRight).LineStyle = xlNone
    Selection.Borders(xlInsideVertical).LineStyle = xlNone
    Selection.Borders(xlInsideHorizontal).LineStyle = xlNone
    With Selection.Interior
        .Pattern = xlNone
        .TintAndShade = 0
        .PatternTintAndShade = 0
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False
Cells(4, 1).Select
Tabela (ActiveSheet.Name)
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
Sheets("JPK").Select
Range("C8").Select
Application.EnableEvents = True
End Sub




Attribute VB_Name = "ThisWorkbook"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Workbook_BeforePrint(Cancel As Boolean)
ActiveWorkbook.Colors(19) = RGB(255, 255, 255)
End Sub

Private Sub Workbook_Activate()
Application.OnKey "^{k}", "Calc"
End Sub

Private Sub Workbook_Deactivate()
Application.OnKey "^{k}"
End Sub

Private Sub Workbook_Open()
DataSystemFormat
End Sub

Attribute VB_Name = "VIES"
Option Private Module
#If VBA7 Then
Declare PtrSafe Sub Sleep Lib "kernel32" (ByVal milliseconds As Long)
#Else
Declare Sub Sleep Lib "kernel32" (ByVal milliseconds As Long)
#End If

Sub WerNIP(c)
Dim NIP, VIES, vat, PR, a, b, d, e
If c < 4 Then Exit Sub
If VATnext = True Then Exit Sub
If Cells(c, 2) = "" Then Exit Sub
If UCase(Cells(c, 2)) = "BRAK" Then Exit Sub
If VATsign = 0 Then b = "ESC/Anuluj - pomi|fffd| sprawdzanie poprawno|fffd|ci numer|fffd|w VAT"
If Not IsNumeric(Left(Cells(c, 2), 2)) Then
vat = Mid(Cells(c, 2), 3)
PR = Left(Cells(c, 2), 2)
d = "Wpisany numer '" & PR & vat & "' r|fffd|ni si|fffd| od wzorca typu"

VIES = False

Select Case PR
Case "AT"
    If Len(vat) <= 9 And IsNumeric(vat) Then VIES = True
    NIP = "AT123456789"
Case "BE"
    If Len(vat) <= 10 And IsNumeric(vat) Then VIES = True
    NIP = "BE1234567890"
Case "BG"
    If Len(vat) >= 9 And Len(vat) < 14 And IsNumeric(vat) Then VIES = True
    NIP = "BG1234567890"
Case "CY"
    If Len(vat) <= 9 And IsNumeric(Mid(vat, 1, 8)) And Not IsNumeric(Right(vat, 1)) Then VIES = True
    NIP = "CY12345678X"
Case "CZ"
    If Len(vat) > 7 And Len(vat) < 11 And IsNumeric(vat) Then VIES = True
    NIP = "CZ12345678 lub CZ123456789 lub CZ1234567890"
Case "DK"
    If Len(vat) >= 8 And Len(vat) < 11 And IsNumeric(vat) Then VIES = True
    NIP = "DK12345678 lub DK1234567890"
Case "EE"
    If Len(vat) >= 8 And Len(vat) < 12 And IsNumeric(vat) Then VIES = True
    NIP = "EE12345678 lub EE12345678901"
Case "FI"
    If Len(vat) >= 8 And Len(vat) < 12 And IsNumeric(Left(vat, 6)) Then VIES = True
    NIP = "FI1234567-8 lub FI123456A789B"
Case "FR"
    If Len(vat) >= 9 And Len(vat) < 14 And IsNumeric(vat) Then VIES = True
    NIP = "FR123456789 lub FR1234567890123"
Case "EL"
    If Len(vat) <= 9 And IsNumeric(vat) Then VIES = True
    NIP = "EL123456789"
Case "ES"
    If Len(vat) <= 9 Then VIES = True
    NIP = "ESL1234567X lub ES12345678X"
Case "HR"
    If Len(vat) <= 11 And IsNumeric(vat) Then VIES = True
    NIP = "HR12345678901"
Case "NL"
    If Len(vat) <= 12 Then VIES = True
    NIP = "NL123456789"
Case "IE"
    If Len(vat) >= 8 Then VIES = True
    NIP = "IE1234567X lub IE1234567XX"
Case "LT"
    If Len(vat) >= 9 And Len(vat) <= 12 Then VIES = True
    NIP = "LT123456789 lub LT12345678901"
Case "LU"
    If Len(vat) >= 8 And Len(vat) < 14 And IsNumeric(vat) Then VIES = True
    NIP = "LU12345678901 lub LU1234567890123"
Case "LV"
    If Len(vat) <= 11 And IsNumeric(vat) Then VIES = True
    NIP = "LV12345678901"
Case "MT"
    If Len(vat) > 7 And Len(vat) < 10 And IsNumeric(Left(vat, 7)) Then VIES = True
    NIP = "MT1234567M lub MT123456789"
Case "DE"
    If Len(vat) <= 11 And IsNumeric(vat) Then VIES = True
    NIP = "DE123456789 lub DE12345678901"
Case "PL"
    If Len(vat) = 10 And IsNumeric(vat) Then VIES = True
    NIP = "PL1234567890"
Case "PT"
    If Len(vat) <= 9 And IsNumeric(vat) Then VIES = True
    NIP = "PT123456789"
Case "RO"
    If Len(vat) >= 2 And Len(vat) < 14 And IsNumeric(vat) Then VIES = True
    NIP = "RO12 do RO123456789 lub RO1234567890123"
Case "SK"
    If Len(vat) >= 9 And Len(vat) < 11 And IsNumeric(vat) Then VIES = True
    NIP = "SK123456789 lub SK1234567890"
Case "SI"
    If Len(vat) <= 8 And IsNumeric(vat) Then VIES = True
    NIP = "SI12345678"
Case "SE"
    If Len(vat) <= 12 And IsNumeric(vat) Then VIES = True
    NIP = "SE1234567890"
Case "HU"
    If Len(vat) >= 8 And Len(vat) < 12 And IsNumeric(vat) Then VIES = True
    NIP = "HU1234567890 lub HU12345678901"
Case "GB"
    If Len(vat) <= 12 And IsNumeric(vat) Then VIES = True
    NIP = "GB1234567890"
Case "IT"
    If Len(vat) <= 16 Then VIES = True
    NIP = "IT12345678901 lub ITABCDEF12G34J567H"
End Select

If VIES = False Then
    If NIP = Empty Then d = "Numer VAT '" & PR & vat & "' nie odpowiada |fffd|adnemu wzorcowi UE oraz NIP."
    Application.GoTo Cells(c, 2)
    Application.ScreenUpdating = True
    VATnext = MsgBox(d & vbCrLf & NIP & vbCrLf & _
    "Czy sprawdzi|fffd| aktywno|fffd||fffd| VIES numeru " & PR & vat & " na stronie" & vbCrLf & _
    "ec.europa.eu/taxation_customs/vies/?" & vbCrLf & vbCrLf & _
    b, 19 + VATsign, "Niepoprawny numer VAT")
    If VATnext = 6 Or VATnext = 1 Then
        Application.EnableEvents = True
        Application.StatusBar = False
        Application.Calculation = xlCalculationAutomatic
        ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
        ActiveSheet.EnableSelection = xlNoRestrictions
        Cells(c, 2).Select: WeryfikacjaVIES (c)
        End
    End If
    If VATnext = 2 Then VATnext = True
    Else
        If VATsign = -2 Then Cells(c, 2).Select: WeryfikacjaVIES (c)
End If

Else
If Not CzyNIP(Cells(c, 2)) Then
    If VATsign = 0 Then e = "Czy chcesz go poprawi|fffd|?"
    Application.GoTo Cells(c, 2)
    Application.ScreenUpdating = True
    VATnext = MsgBox("Wpisany numer NIP '" & Cells(c, 2) & "' jest b|fffd||fffd|dny." & vbCrLf & _
    e & vbCrLf & vbCrLf & _
    b, 19 + VATsign, "B|fffd||fffd|dny NIP")
    If VATnext = 6 Then
        Application.EnableEvents = True
        Application.StatusBar = False
        Application.Calculation = xlCalculationAutomatic
        ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
        ActiveSheet.EnableSelection = xlNoRestrictions
        Cells(c, 2).Select
        End
    End If
    If VATnext = 2 Then VATnext = True
    Else
    If VATsign = -2 Then Cells(c, 2).Select: WeryfikacjaNIP (c)
End If
End If

End Sub


Sub WeryfikacjaVIES(c)
Dim VATPL, vat, PR
Dim Zaw As HTMLInputElement
Dim Kom As String

If Sheets("JPK").Range("C8") = "" Then
    MsgBox "Wpisz NIP podatnika", 16, ""
    Sheets("JPK").Select
    Range("C8").Select
    End
End If
VATPL = Sheets("JPK").Range("C8")

NOWY:
Application.EnableCancelKey = xlErrorHandler
On Error GoTo Wype|fffd|nijFormularz_Error

Cells(c, 2).Select
    vat = Mid(Cells(c, 2), 3)
    PR = Left(Cells(c, 2), 2)
    
    Dim IE As Object
    Dim objHTMLDoc As Object
    Dim colForms As Object
    Const URL As String = "http://ec.europa.eu/taxation_customs/vies/"

    Set IE = CreateObject("InternetExplorer.Application")
    IE.Navigate URL
    IE.Visible = True
    apiShowWindow IE.hwnd, 3
    Do
         DoEvents
    Loop Until IE.readyState = 4
    Set objHTMLDoc = IE.document


    Set colForms = objHTMLDoc.forms(0)
    With colForms
        .memberStateCode.Value = PR
        .Number.Value = vat
        .requesterMemberStateCode.Value = "PL"
        .requesterNumber.Value = VATPL
        .check.Click
    End With

Wype|fffd|nijFormularz_Exit:
    On Error Resume Next
    Set IE = Nothing
    Set objHTMLDoc = Nothing
    Set colForms = Nothing
    Set Zaw = Nothing
        Application.EnableEvents = True
        Application.Calculation = xlCalculationAutomatic
        ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
        ActiveSheet.EnableSelection = xlNoRestrictions
    End
    Exit Sub
Wype|fffd|nijFormularz_Error:
If Err = 18 Then MsgBox "Przerwano na |fffd|yczenie u|fffd|ytkownika.", 64, ""
Resume Wype|fffd|nijFormularz_Exit
End Sub

Sub WeryfikacjaNIP(c)
Dim NIP
Dim IE As Object
Dim inputEL As HTMLInputElement
Dim IEField As HTMLInputElement
Dim Zaw As HTMLInputElement
Dim Kom As String

Const URL As String = "https://ppuslugi.mf.gov.pl/?link=VAT&"


NOWY:
Application.EnableCancelKey = xlErrorHandler
On Error GoTo Wype|fffd|nijFormularz_Error

Cells(c, 2).Select
NIP = Cells(c, 2)

    Set IE = CreateObject("InternetExplorer.Application")
    IE.Navigate URL
    IE.Visible = True
    apiShowWindow IE.hwnd, 3
    Do
       DoEvents
    Loop Until IE.readyState = 4

Do While IE.Busy
Sleep (100)
Loop

Sleep (700)
Do While inputEL Is Nothing
    Set inputEL = IE.document.getElementById("b-7")
Loop
inputEL.Value = NIP
IE.document.getElementById("b-8").Click

Wype|fffd|nijFormularz_Exit:
    On Error Resume Next
    Set IE = Nothing
    Set inputEL = Nothing
    Set Zaw = Nothing
        Application.EnableEvents = True
        Application.Calculation = xlCalculationAutomatic
        ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
        ActiveSheet.EnableSelection = xlNoRestrictions
    End
    Exit Sub
Wype|fffd|nijFormularz_Error:
If Err = 18 Then MsgBox "Przerwano na |fffd|yczenie u|fffd|ytkownika.", 64, ""
Resume Wype|fffd|nijFormularz_Exit
End Sub










Attribute VB_Name = "Walidacj"
Option Private Module
Public sh As Integer
Public Zar As Boolean
Public Zas As Boolean
Public Const po = 42736
Public Const ko = 43434
Public SEP As String
Public VATsign, VATnext
Dim b As Long

Sub Walida3()
Application.ScreenUpdating = False

sh = 37
Sheets("Sprzeda|fffd|").Select
Walidacja
sh = 15
Sheets("Zakupy").Select
Walidacja
Sheets("JPK").Select
End Sub

Function Wal(Adr) 'Wal ""
If Range(Adr) = "" Then
Application.EnableEvents = False
Range(Adr).Select
w = Selection.Row
c = Selection.Column
Application.GoTo Cells(w - 5, 1)
Cells(w, c).Select
Application.EnableEvents = True
MsgBox "Uzupe|fffd|nij rubryk|fffd| " & Cells(w - 1, c), 16, "Uwaga"
End
End If
End Function

Sub Walidacja()
Dim a As Long
Dim myDat As String
Dim rngCell As Range
Dim Ro As Integer
Dim Za As Integer
Dim DA As Integer
Dim Dar As Integer
Dim Mo As Integer
Dim rol As Integer
Dim Jo, Jd
Dim ror As Integer
Dim Ldec As Boolean
Dim Zap As Integer
Dim ProgressBar As New ProgressBar

VATsign = 0
Application.EnableCancelKey = xlErrorHandler
'On Error GoTo POZYC
Application.ScreenUpdating = False
ActiveSheet.Unprotect
Range(Cells(4, 1), Cells(ActiveSheet.Cells.SpecialCells(xlCellTypeLastCell).Row, 1)).ClearContents
Tabela (ActiveSheet.Name)
Set rngCell = Cells.Find(What:="*", After:=Cells(1, 1), LookIn:=xlFormulas, Lookat _
:=xlPart, searchorder:=xlByRows, searchdirection:=xlPrevious, MatchCase:= _
False, SearchFormat:=False)
b = rngCell.Row
If b < 4 Then
[A4].Select
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
Application.Calculation = xlCalculationAutomatic
Exit Sub
End If
Application.EnableEvents = False
Application.Calculation = xlCalculationManual
If b = 4 Then [A4] = 1
If b = 5 Then [A4] = 1: [A5] = 2
If b > 5 Then
[A4] = 1: [A5] = 2: [A6] = 3
If b > 6 Then
Set SourceRange = Range("A5:A6")
Set fillRange = Range(Cells(5, 1), Cells(b, 1))
SourceRange.AutoFill Destination:=fillRange
End If
End If
Jo = 0
Jd = 0

If [JPK!E13] <> "" And IsNumeric([JPK!E13]) Then Jo = DATTO([JPK!E13])
If [JPK!K13] <> "" And IsNumeric([JPK!K13]) Then Jd = DATTO([JPK!K13])


For c = 8 To sh
If Not IsNumeric(Cells(2, c)) Then
     MsgBox "Kwota sumy kolumny nie jest liczb|fffd|!", 16, "B|fffd||fffd|d"
     a = 2
     GoTo POZYC
End If
Next c

For a = 4 To b

Call ProgressBar.Update(a, b, "Sprawdzanie", True)
If IsNumeric(Left(Cells(a, 2), 1)) And InStr(1, Cells(a, 2), "-") Then Cells(a, 2) = Replace(Cells(a, 2), "-", "")
WerNIP (a)
On Error GoTo 0
For c = 2 To 6
On Error GoTo Stos
If Len(Trim(Cells(a, c))) = 0 Then
Application.GoTo Cells(a, c)
Application.ScreenUpdating = True
If c = 2 Then
    Zap = MsgBox("Brak obowi|fffd|zkowych danych '" & Replace(Cells(1, c), Chr(10), " ") & "' w wierszu " & a & vbCrLf & vbCrLf & _
        "Je|fffd|eli numer nie istnieje nale|fffd|y wpisa|fffd| 'BRAK'." & vbCrLf & vbCrLf & _
        "Czy wstawi|fffd| 'BRAK'?", 20, "Sprawdzanie poprawno|fffd|ci danych")
    If Zap = 6 Then Cells(a, c) = "BRAK": Application.ScreenUpdating = False
    If Zap = 7 Then GoTo POZYC
Else
    MsgBox "Brak obowi|fffd|zkowych danych '" & Cells(1, c) & "' w wierszu " & a, 16, "Sprawdzanie poprawno|fffd|ci danych"
    GoTo POZYC
End If
End If
Stos:
If Err = 18 Then GoTo POZYC
If Err <> 0 Then
    If c = 6 Or c = 7 Then
    MsgBox "B|fffd||fffd|dna data w wierszu " & a & ". Data powinna zawiera|fffd| kreski '-'", vbInformation, "Sprawdzanie poprawno|fffd|ci danych"
    Else
    MsgBox "B|fffd||fffd|dna warto|fffd||fffd| w wierszu " & a & " - " & Cells(1, c), vbInformation, "Sprawdzanie poprawno|fffd|ci danych"
    End If
    Cells(a, c).Select
    GoTo POZYC
End If
Next c
On Error GoTo POZYC
Ldec = False
For c = 8 To sh
If Cells(a, c) <> 0 Then
If Not IsNumeric(Cells(a, c)) Then
     MsgBox "Wpisana warto|fffd||fffd| nie jest liczb|fffd|", 16, "B|fffd||fffd|dny wpis"
     GoTo POZYC
Else
     Ldec = True
End If
End If
Next c

If Ldec = False Then
If Zas = False Then
    c = 8
    Zap = MsgBox("Brak wpisanej kwoty w wierszu " & a & vbCrLf & _
    "Czy chcesz uzupe|fffd|ni|fffd|?" & vbCrLf & vbCrLf & "Anuluj/Esc - pomi|fffd| sprawdzanie", vbInformation + vbYesNoCancel, "Sprawdzanie poprawno|fffd|ci danych")
    If Zap = 2 Then Zas = True
    If Zap = 6 Then GoTo POZYC
End If
End If

For c = 6 To 7
If Cells(a, c) <> "" Then
myDat = Cells(a, c)
SEP = Datsep(myDat)
Mo = Mid(myDat, InStr(1, myDat, SEP) + 1, InStrRev(myDat, SEP) - InStr(1, myDat, SEP) - 1)
Dar = Right(myDat, Len(CStr(myDat)) - InStrRev(myDat, SEP))
DA = Left(myDat, InStr(1, myDat, SEP) - 1)
If Len(CStr(DA)) > Len(CStr(Dar)) Then Za = Dar: Dar = DA: DA = Za
myDat = DateSerial(Dar, Mo, DA)
    If IsDate(myDat) = False Then
    Cells(a, c).Select
    Application.ScreenUpdating = True
    MsgBox "Wpisana data jest b|fffd||fffd|dna", 16, "B|fffd||fffd|dna data"
    GoTo POZYC
    End If

If Mo > 12 Then
    Za = Mo: Mo = DA: DA = Za
    MsgBox "Stwierdzono dat|fffd| w formacie ameryka|fffd|skim MM-dd-rrrr" & vbCrLf & vbCrLf & _
    "Popraw dat|fffd|.", 33, "Problem z dat|fffd|"
    Cells(a, c).Select
    GoTo POZYC
End If

rol = 2000 + CDbl(DA)
ror = 2000 + CDbl(Dar)

If Len(CStr(DA)) < 3 And Len(CStr(Dar)) < 3 Then
    Zam = MsgBox("Wpisano dat|fffd|   " & myDat & "   bez 4-cyfrowego roku. Jak uzupe|fffd|ni|fffd| rok?" & vbCrLf & vbCrLf & _
    "Kliknij TAK dla pierwszej wersji    lub    NIE dla drugiej wersji" & vbCrLf & vbCrLf & _
    "TAK - " & rol & "    (" & DateSerial(rol, Mo, Dar) & ")" & vbCrLf & vbCrLf & _
    "NIE - " & ror & "    (" & DateSerial(ror, Mo, DA) & ")", 35, "Jaki rok")

    If Zam = 6 Then
    Cells(a, c) = DateSerial(rol, Mo, Dar)
    Zam = MsgBox("Czy uzupe|fffd|ni|fffd| wszystkie daty w ten sam spos|fffd|b?" & vbCrLf & vbCrLf & _
    "np.  " & myDat & "    (" & DateSerial(rol, Mo, DA) & ")", 36, "Jaki rok")
        If Zam = 6 Then DaiDar xlOn
    GoTo NAST
    End If
    
    If Zam = 7 Then
    Cells(a, c) = DateSerial(ror, Mo, DA)
    Zam = MsgBox("Czy uzupe|fffd|ni|fffd| wszystkie daty w ten sam spos|fffd|b?" & vbCrLf & vbCrLf & _
    "np.  " & myDat & "    (" & DateSerial(ror, Mo, DA) & ")", 36, "Jaki rok")
        If Zam = 6 Then DariDa xlOn
    GoTo NAST
    End If
    
    If Zam = 2 Then Cells(a, c).Select: GoTo POZYC
    GoTo NAST
End If
NAST:
If Cells(a, c) <> DateSerial(DatePart("yyyy", myDat), DatePart("m", myDat), DatePart("d", myDat)) Then Cells(a, c) = DateSerial(DatePart("yyyy", myDat), DatePart("m", myDat), DatePart("d", myDat))
If Zar = False Then
    If Jd <> 0 Then
    If Cells(a, c) > Jd Then
    Application.ScreenUpdating = True
    Application.GoTo Cells(a, c)
    Zap = MsgBox("Wpisana data wykracza poza okres sprawozdawczy" & vbCrLf & _
    "z arkusza JPK poz. 5 tj.  " & Jd & vbCrLf & vbCrLf & _
    "Czy ta data jest poprawna?" & vbCrLf & vbCrLf & _
    "ESC/Anuluj - pomi|fffd| sprawdzanie poprawno|fffd|ci dat", 19, "B|fffd||fffd|dna data")
    If Zap = 2 Then Zar = True
    If Zap = 7 Then GoTo POZYC
    End If
    End If
    
    If Jo <> 0 Then
    If Cells(a, c) < Jo Then
    Application.ScreenUpdating = True
    Application.GoTo Cells(a, c)
    Zap = MsgBox("Wpisana data jest poni|fffd|ej okresu sprawozdawczego" & vbCrLf & _
    "z arkusza JPK poz. 4 tj.  " & Jo & vbCrLf & _
    "Czy ta data jest poprawna?" & vbCrLf & vbCrLf & _
    "ESC/Anuluj - pomi|fffd| sprawdzanie poprawno|fffd|ci dat", 19, "B|fffd||fffd|dna data")
    If Zap = 2 Then Zar = True
    If Zap = 7 Then GoTo POZYC
    End If
    End If
End If
End If

Next c
Next a

[A4].Select
Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
Exit Sub

POZYC:
On Error Resume Next
Application.GoTo Cells(a, c)
Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
Application.StatusBar = False
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
If Err = 18 Then
    MsgBox "Przerwano na |fffd|yczenie u|fffd|ytkownika.", 64, ""
Else
    MsgBox "Sprawdzanie przerwane." & vbCrLf & "Sprawd|fffd| poprawno|fffd||fffd| danych w zaznaczonej kom|fffd|rce", 64, ""
End If
End
End Sub


Sub DaiDar(s)
Dim a As Integer
Dim c As Integer
Dim DA As Integer
Dim Dar As Integer
Dim Mo As Integer
For a = 4 To b
For c = 6 To 7
myDat = Cells(a, c)
If Len(myDat) > 4 And Len(myDat) < 9 Then
Mo = Mid(myDat, InStr(1, myDat, SEP) + 1, InStrRev(myDat, SEP) - InStr(1, myDat, SEP) - 1)
Dar = Right(myDat, Len(CStr(myDat)) - InStrRev(myDat, SEP))
DA = Left(myDat, InStr(1, myDat, SEP) - 1)
Cells(a, c) = DateSerial(2000 + DA, Mo, Dar)
End If
Next c
Next a
End Sub

Sub DariDa(s)
Dim a As Integer
Dim c As Integer
Dim DA As Integer
Dim Dar As Integer
Dim Mo As Integer
For a = 4 To b
For c = 6 To 7
myDat = Cells(a, c)
If Len(myDat) > 4 And Len(myDat) < 9 Then
Mo = Mid(myDat, InStr(1, myDat, SEP) + 1, InStrRev(myDat, SEP) - InStr(1, myDat, SEP) - 1)
Dar = Right(myDat, Len(CStr(myDat)) - InStrRev(myDat, SEP))
DA = Left(myDat, InStr(1, myDat, SEP) - 1)
Cells(a, c) = DateSerial(2000 + Dar, Mo, DA)
End If
Next c
Next a
End Sub


Sub FormatS()
Dim Cent
Cent = xlCenter
Application.StatusBar = "Sprawdza format danych. Czekaj"
Application.ScreenUpdating = False
Application.EnableEvents = False
Application.Calculation = xlCalculationManual
Sheets("Sprzeda|fffd|").Select
ActiveSheet.Unprotect

Columns("H:AK").Select
    Selection.Replace What:=".", Replacement:=",", Lookat:=xlPart, _
        searchorder:=xlByRows, MatchCase:=False, SearchFormat:=False, _
        ReplaceFormat:=False
DoEvents
For a = 8 To 37
Columns(a).Select
    Selection.TextToColumns Destination:=Cells(1, a), DataType:=xlDelimited, _
        TextQualifier:=xlNone, ConsecutiveDelimiter:=False, Tab:=False, _
        Semicolon:=False, Comma:=False, Space:=False, Other:=False, FieldInfo _
        :=Array(1, 1), TrailingMinusNumbers:=True
Next
DoEvents
    Columns("A:A").Select
    Selection.NumberFormat = "General"
    With Selection
        .HorizontalAlignment = Cent
        .ShrinkToFit = True
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False

    Columns("B:B").Select
    Selection.NumberFormat = "@"
    With Selection
        .HorizontalAlignment = Cent
        .ShrinkToFit = True
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False

    Columns("C:E").Select
    Selection.NumberFormat = "@"
    With Selection
        .HorizontalAlignment = xlLeft
        .ShrinkToFit = True
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False

    Columns("F:G").Select
    Selection.NumberFormat = "dd-mm-yyyy"
    With Selection
        .HorizontalAlignment = Cent
        .ShrinkToFit = True
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False

    Columns("H:AK").Select
    Selection.NumberFormat = "#,##0.00"
    With Selection
        .HorizontalAlignment = xlRight
        .ShrinkToFit = True
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False

    Rows("1:1").Select
    With Selection
        .HorizontalAlignment = Cent
    End With
    Selection.Locked = True
    Selection.FormulaHidden = False
    Rows("2:2").Select
    Selection.HorizontalAlignment = xlRight
    Selection.Locked = True
    Selection.FormulaHidden = False

    Rows("3:3").Select
    With Selection
        .HorizontalAlignment = Cent
        .VerticalAlignment = Cent
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False

Range("A4").Select
Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
DoEvents
Application.StatusBar = False
End Sub

Sub FormatZ()
Dim Cent
Cent = xlCenter
Application.StatusBar = "Sprawdza format danych. Czekaj"
Application.ScreenUpdating = False
Application.EnableEvents = False
Application.Calculation = xlCalculationManual
Sheets("Zakupy").Select
ActiveSheet.Unprotect

For a = 8 To 15
    Columns(a).Select
    Selection.Replace What:=".", Replacement:=",", Lookat:=xlPart, _
        searchorder:=xlByRows, MatchCase:=False, SearchFormat:=False, _
        ReplaceFormat:=False
    Selection.TextToColumns Destination:=Cells(1, a), DataType:=xlDelimited, _
        TextQualifier:=xlNone, ConsecutiveDelimiter:=False, Tab:=False, _
        Semicolon:=False, Comma:=False, Space:=False, Other:=False, FieldInfo _
        :=Array(1, 1), TrailingMinusNumbers:=True
Next
DoEvents
    Columns("A:A").Select
    Selection.NumberFormat = "General"
    With Selection
        .HorizontalAlignment = Cent
        .ShrinkToFit = True
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False
    Columns("B:B").Select
    Selection.NumberFormat = "@"
    With Selection
        .HorizontalAlignment = Cent
        .ShrinkToFit = True
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False
    Columns("C:E").Select
    Selection.NumberFormat = "@"
    With Selection
        .HorizontalAlignment = xlLeft
        .ShrinkToFit = True
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False
    Columns("F:G").Select
    Selection.NumberFormat = "dd-mm-yyyy"
    With Selection
        .HorizontalAlignment = Cent
        .ShrinkToFit = True
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False
    Columns("H:O").Select
    Selection.NumberFormat = "#,##0.00"
    With Selection
        .HorizontalAlignment = xlRight
        .ShrinkToFit = True
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False
    Rows("1:1").Select
    With Selection
        .HorizontalAlignment = Cent
    End With
    Selection.Locked = True
    Selection.FormulaHidden = False
    Rows("2:2").Select
    Selection.HorizontalAlignment = xlRight
    Selection.Locked = True
    Selection.FormulaHidden = False
    
    Rows("3:3").Select
    With Selection
        .HorizontalAlignment = Cent
        .VerticalAlignment = Cent
    End With
    Selection.Locked = False
    Selection.FormulaHidden = False
Range("A4").Select
Application.EnableEvents = True
Application.Calculation = xlCalculationAutomatic
    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
        , AllowInsertingRows:=True, AllowInsertingHyperlinks:=True, _
        AllowDeletingRows:=True, AllowSorting:=True, AllowFiltering:=True
    ActiveSheet.EnableSelection = xlNoRestrictions
DoEvents
Application.StatusBar = False
End Sub





Attribute VB_Name = "Wydruk"
Attribute VB_Base = "0{B67DE466-ADB2-400E-A9B3-8B45C393CB2B}{628EDDD1-1D29-4B7C-88BF-D8A8878FA1D8}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False


Private Sub CommandButton1_Click()
Opt2.Value = True
Application.SendKeys "{tab}{tab}{tab}~"
Application.Dialogs(xlDialogPrinterSetup).Show
End Sub

Private Sub OK_Click()
Dim a As Integer
Unload Me
If Opt1.Value = True Then
    For a = 1 To LStr Step 2
    ActiveWindow.SelectedSheets.PrintOut From:=a, To:=a
    Next
If LStr = 2 Then
MsgBox "W|fffd||fffd| odpowiednio kartk|fffd| do podajnika i drukuj drug|fffd| stron|fffd|", 64, "Drukuj formularz dwustronnie"
ActiveWindow.SelectedSheets.PrintOut From:=2, To:=2
Else
Wydruk2.Show
End If
End If
If Opt2.Value = True Then ActiveWindow.SelectedSheets.PrintOut
End Sub

Private Sub Anuluj_Click()
Unload Me
End Sub

Private Sub UserForm_Initialize()
ActiveWorkbook.Colors(19) = RGB(255, 255, 255)
If Val(Application.Version) > 11 Then
LStr = ActiveSheet.PageSetup.Pages.Count
Else
LStr = ExecuteExcel4Macro("get.document(50)")
End If
If LStr = 1 Then
Unload Me
ActiveWindow.SelectedSheets.PrintOut
End
End If
End Sub

Attribute VB_Name = "Wydruk2"
Attribute VB_Base = "0{799F4D3E-47A3-48BF-A759-DE6E6F2AACC0}{B2BD3B10-6836-494C-AEE5-F2A15DDDF2AE}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False

    
Private Sub OK_Click()
Dim a As Integer, b As Integer
Unload Me
b = 0
If LStr Mod 2 Then
    b = 1
    Range("B4").PrintOut
End If

If Opt1.Value = True Then
    For a = LStr - b To 2 Step -2
    ActiveWindow.SelectedSheets.PrintOut From:=a, To:=a
    Next
End If
If Opt2.Value = True Then
    For a = 2 To LStr - b Step 2
    ActiveWindow.SelectedSheets.PrintOut From:=a, To:=a
    Next
End If
End Sub

Private Sub Anuluj_Click()
Unload Me
End Sub

Private Sub UserForm_Click()

End Sub

Attribute VB_Name = "XML"
Option Private Module
Public LStr As Integer
Public eDek As Integer, ePod As Integer
Public Nplik As String

Sub Doxml()
Dim P(78)
Dim a, b, Dpl, Wer, Wer2, US, Kor
Dim Filename, Dz, Mc, Rok
Dim PR As Object
Application.ScreenUpdating = False
Sheets("VAT-7K").Select

Wer2 = Empty
NRPL:
Nplik = ThisWorkbook.Path & "\VAT-7K_" & [P11] & "-" & [U11] & " " & [A23] & Wer2 & ".xml"
Nplik = Replace(Nplik, """", "")
If Dir(Nplik) <> "" Then
    Wer = Wer + 1
    Wer2 = "(" & Wer & ")"
    GoTo NRPL
End If

P(1) = [C7]
P(2) = [U7]
P(3) = [AC7]
P(4) = [P11]
P(5) = [U11]
P(6) = [AG18]
P(7) = [AT1]
P(8) = [AT2]
P(9) = [A23]
P(10) = [T30]
P(11) = [T32]
P(12) = [T34]
P(13) = [T36]
P(14) = [T38]
P(15) = [T40]
P(16) = [Z40]
P(17) = [T42]
P(18) = [Z42]
P(19) = [T44]
P(20) = [Z44]
P(21) = [T46]
P(22) = [T48]
P(23) = [T50]
P(24) = [Z50]
P(25) = [T52]
P(26) = [Z52]
P(27) = [T54]
P(28) = [Z54]
P(29) = [T57]
P(30) = [Z57]
P(31) = [T59]
P(32) = [T62]
P(33) = [Z62]
P(34) = [T64]
P(35) = [Z64]
P(36) = [Z74]
P(37) = [Z76]
P(38) = [Z78]
P(39) = [Z80]
P(40) = [T82]
P(41) = [Z82]
P(42) = [Z88]
P(43) = [S92]
P(44) = [Z92]
P(45) = [S94]
P(46) = [Z94]
P(47) = [Z97]
P(48) = [Z99]
P(49) = [Z101]
P(50) = [Z103]
P(51) = [Z105]
P(52) = [Z109]
P(53) = [Z112]
P(54) = [Z115]
P(55) = [Z118]
P(56) = [Z120]
P(57) = [Z123]
P(58) = [R125]
P(59) = [Z125]
P(60) = [R127]
P(61) = [Z127]
P(62) = [Z129]
P(63) = [AT3]
P(64) = [AT4]
P(65) = [AT5]
P(66) = [AT6]
P(67) = [AT7]
P(68) = [AT8]
P(69) = [AT12]
P(70) = [AT11]
P(71) = [D155]
P(72) = [N155]
P(73) = [W155]
P(74) = [D157]
P(75) = [N157]
P(77) = [A24] 'imi|fffd|
P(78) = [A25] 'dataur


Set PR = CreateObject("ADODB.Stream")
PR.Type = 2
PR.Charset = "utf-8"
PR.Open

PR.WriteText "<?xml version=""1.0"" encoding=""UTF-8""?>" & vbNewLine
PR.WriteText "<Deklaracja xmlns=""http://crd.gov.pl/wzor/2019/11/08/8838/"" xmlns:etd=""http://crd.gov.pl/xml/schematy/dziedzinowe/mf/2018/08/24/eD/DefinicjeTypy/"">" & vbNewLine
PR.WriteText "<Naglowek>" & vbNewLine
PR.WriteText "<KodFormularza kodPodatku=""VAT"" kodSystemowy=""VAT-7K (14)"" rodzajZobowiazania=""Z"" wersjaSchemy=""1-0E"">VAT-7K</KodFormularza>" & vbNewLine
PR.WriteText "<WariantFormularza>14</WariantFormularza>" & vbNewLine
PR.WriteText "<CelZlozenia poz=""P_7"">" & P(7) & "</CelZlozenia>" & vbNewLine
PR.WriteText "<Rok>" & P(5) & "</Rok>" & vbNewLine
PR.WriteText "<Kwartal>" & P(4) & "</Kwartal>" & vbNewLine
PR.WriteText "<KodUrzedu>" & P(6) & "</KodUrzedu>" & vbNewLine
PR.WriteText "</Naglowek>" & vbNewLine
PR.WriteText "<Podmiot1 rola=""Podatnik"">" & vbNewLine
If P(8) = 1 Then
PR.WriteText "<OsobaNiefizyczna>" & vbNewLine
PR.WriteText "<NIP>" & P(1) & "</NIP>" & vbNewLine
PR.WriteText "<PelnaNazwa>" & ZN(UCase(P(9))) & "</PelnaNazwa>" & vbNewLine
PR.WriteText "</OsobaNiefizyczna>" & vbNewLine
Else
PR.WriteText "<OsobaFizyczna>" & vbNewLine
PR.WriteText "<etd:NIP>" & P(1) & "</etd:NIP>" & vbNewLine
PR.WriteText "<etd:ImiePierwsze>" & ZN(UCase(P(77))) & "</etd:ImiePierwsze>" & vbNewLine
PR.WriteText "<etd:Nazwisko>" & ZN(UCase(P(9))) & "</etd:Nazwisko>" & vbNewLine
PR.WriteText "<etd:DataUrodzenia>" & DATAA(P(78)) & "</etd:DataUrodzenia>" & vbNewLine
PR.WriteText "</OsobaFizyczna>" & vbNewLine
End If
PR.WriteText "</Podmiot1>" & vbNewLine
PR.WriteText "<PozycjeSzczegolowe>" & vbNewLine

For a = 10 To 75
Select Case a

Case 41, 54
PR.WriteText "<P_" & a & ">" & UL(P(a)) & "</P_" & a & ">" & vbNewLine
'warunk
Case 10, 11, 12, 13, 14, 21, 22, 31, 36, 37, 38, 39, 40, 42, 47 To 53, 55, 56
If P(a) <> 0 Then PR.WriteText "<P_" & a & ">" & UL(P(a)) & "</P_" & a & ">"
'podw
Case 15, 17, 19, 23, 25, 27, 29, 32, 34, 43, 45
If P(a) + P(a + 1) <> 0 Then
PR.WriteText "<P_" & a & ">" & UL(P(a)) & "</P_" & a & ">" & vbNewLine
PR.WriteText "<P_" & a + 1 & ">" & UL(P(a + 1)) & "</P_" & a + 1 & ">" & vbNewLine
End If

Case 57
If P(a) > 0 Then
    PR.WriteText "<P_" & a & ">" & P(a) & "</P_" & a & ">" & vbNewLine
    If P(58) > 0 Then
        PR.WriteText "<P_58>" & P(58) & "</P_58>" & vbNewLine
        PR.WriteText "<P_68>1</P_68>" & vbNewLine
    End If
    If P(59) > 0 Then
        PR.WriteText "<P_59>" & P(59) & "</P_59>" & vbNewLine
        
    End If
    If P(60) > 0 Then PR.WriteText "<P_60>" & P(60) & "</P_60>" & vbNewLine
    If P(61) > 0 Then PR.WriteText "<P_61>" & P(61) & "</P_61>" & vbNewLine
    
End If

Case 62 To 67
If P(a) <> 0 Then PR.WriteText "<P_" & a & ">" & UL(P(a)) & "</P_" & a & ">"

Case 69, 70
If P(a) = 1 Then PR.WriteText "<P_" & a & ">" & P(a) & "</P_" & a & ">" & vbNewLine

Case 73, 74
If P(a) <> "" Then PR.WriteText "<P_" & a & ">" & P(a) & "</P_" & a & ">" & vbNewLine
End Select

Next

PR.WriteText "<P_75>" & DATAA(P(75)) & "</P_75>" & vbNewLine

PR.WriteText "</PozycjeSzczegolowe>" & vbNewLine
PR.WriteText "<Pouczenia>1</Pouczenia>" & vbNewLine

'za|fffd||fffd|czniki
If P(70) = 1 Then
PR.WriteText "<Zalaczniki>" & vbNewLine

'za|fffd||fffd|cznik VAT-ZD
If [AT11] = 1 Then
Dim ZD(100, 7), ko, KN
Sheets("VAT-ZD").Activate
For a = 1 To 100
If Cells(a + 87, 2) = "" Then Exit For
ZD(a, 1) = Cells(a + 87, 2)
ZD(a, 2) = Cells(a + 87, 19)
If ZD(a, 2) = "" Then MsgBox "Nie wpisano NIP w wierszu " & a, 16, "B|fffd||fffd|d w VAT-ZD": End
ZD(a, 3) = ZN(Cells(a + 87, 25))
If ZD(a, 3) = "" Then MsgBox "Nie wpisano numeru faktury w wierszu " & a, 16, "B|fffd||fffd|d w VAT-ZD": End
ZD(a, 4) = DATAA(Cells(a + 87, 35))
If ZD(a, 4) = "" Then MsgBox "Nie wpisano daty w kol. e wiersz " & a, 16, "B|fffd||fffd|d w VAT-ZD": End
ZD(a, 5) = DATAA(Cells(a + 87, 43))
If ZD(a, 5) = "" Then MsgBox "Nie wpisano daty w kol. f wiersz " & a, 16, "B|fffd||fffd|d w VAT-ZD": End
ZD(a, 6) = UT(Cells(a + 87, 49))
If ZD(a, 6) = "" Then MsgBox "Nie wpisano kwoty w kol. g wiersz " & a, 16, "B|fffd||fffd|d w VAT-ZD": End
ZD(a, 7) = UT(Cells(a + 87, 51))
If ZD(a, 7) = "" Then MsgBox "Nie wpisano kwoty w kol. h wiersz " & a, 16, "B|fffd||fffd|d w VAT-ZD": End
Next

PR.WriteText "<vzd:Wniosek_VAT-ZD xmlns:vzd=""http://crd.gov.pl/xml/schematy/dziedzinowe/mf/2019/02/07/eD/VATZD/"">" & vbNewLine
PR.WriteText "<vzd:Naglowek>" & vbNewLine
PR.WriteText "<vzd:KodFormularza kodSystemowy=""VAT-ZD (1)"" wersjaSchemy=""3-0E"">VAT-ZD</vzd:KodFormularza>" & vbNewLine
PR.WriteText "<vzd:WariantFormularza>1</vzd:WariantFormularza>" & vbNewLine
PR.WriteText "</vzd:Naglowek>" & vbNewLine
PR.WriteText "<vzd:PozycjeSzczegolowe>" & vbNewLine

For a = 1 To 100
If ZD(a, 1) = Empty Then Exit For
PR.WriteText "<vzd:P_B typ=""G"">" & vbNewLine
PR.WriteText "<vzd:P_BB>" & ZD(a, 1) & "</vzd:P_BB>" & vbNewLine
PR.WriteText "<vzd:P_BC>" & ZD(a, 2) & "</vzd:P_BC>" & vbNewLine
PR.WriteText "<vzd:P_BD1>" & ZD(a, 3) & "</vzd:P_BD1>" & vbNewLine
PR.WriteText "<vzd:P_BD2>" & ZD(a, 4) & "</vzd:P_BD2>" & vbNewLine
PR.WriteText "<vzd:P_BE>" & ZD(a, 5) & "</vzd:P_BE>" & vbNewLine
PR.WriteText "<vzd:P_BF>" & ZD(a, 6) & "</vzd:P_BF>" & vbNewLine
PR.WriteText "<vzd:P_BG>" & ZD(a, 7) & "</vzd:P_BG>" & vbNewLine
PR.WriteText "</vzd:P_B>" & vbNewLine
ko = ko + Val(ZD(a, 6))
KN = KN + Val(ZD(a, 7))
Next

PR.WriteText "<vzd:P_10>" & UL(ko) & "</vzd:P_10>" & vbNewLine
PR.WriteText "<vzd:P_11>" & UL(KN) & "</vzd:P_11>" & vbNewLine
PR.WriteText "</vzd:PozycjeSzczegolowe>" & vbNewLine
PR.WriteText "</vzd:Wniosek_VAT-ZD>" & vbNewLine
End If
Sheets("VAT-7K").Activate
PR.WriteText "</Zalaczniki>" & vbNewLine
End If
'--------------podpis---------------
Sheets("VAT-7K").Select
If eDek < 3 And ePod = 2 Then
PR.WriteText "<podp:DaneAutoryzujace xmlns:podp=""http://e-deklaracje.mf.gov.pl/Repozytorium/Definicje/Podpis/"">" & vbNewLine
PR.WriteText "<podp:NIP>" & P(1) & "</podp:NIP>" & vbNewLine
PR.WriteText "<podp:ImiePierwsze>" & P(77) & "</podp:ImiePierwsze>" & vbNewLine
PR.WriteText "<podp:Nazwisko>" & P(9) & "</podp:Nazwisko>" & vbNewLine
PR.WriteText "<podp:DataUrodzenia>" & DATAA(P(78)) & "</podp:DataUrodzenia>" & vbNewLine
PR.WriteText "<podp:Kwota>" & UT([Przychod]) & "</podp:Kwota>" & vbNewLine
PR.WriteText "</podp:DaneAutoryzujace>" & vbNewLine
End If
'--------------podpis---------------

PR.WriteText "</Deklaracja>"

PR.SaveToFile Nplik, 2
Set PR = Nothing

Application.EnableEvents = True

If eDek = 3 Then XSDValid (Nplik)

End Sub

Sub Doplikuxml()
Doxml
MsgBox "Plik XML zapisany pod nazw|fffd|" & Chr(13) & Chr(13) & Nplik, vbInformation, "OK"
End Sub


Sub Walid(st)
If [C7] = "" Then MsgBox "Brak NIP", 16, "B|fffd||fffd|d": [C7].Select: GoTo POZYC
If [AT1] = 0 Then MsgBox "Uzupe|fffd|nij cel z|fffd|o|fffd|enia", 16, "B|fffd||fffd|d": [Y20].Select: GoTo POZYC
If [P11] = "" Then MsgBox "Brak miesi|fffd|ca", 16, "B|fffd||fffd|d": [P11].Select: GoTo POZYC
If [U11] = "" Then MsgBox "Brak roku", 16, "B|fffd||fffd|d": [U11].Select: GoTo POZYC
If [E18] = "" Then MsgBox "Brak urz|fffd|du skarbowego", 16, "B|fffd||fffd|d": [E18].Select: GoTo POZYC
If [AT2] = 0 Then MsgBox "Zaznacz rodzaj podatnika", 16, "B|fffd||fffd|d": [E22].Select: GoTo POZYC
If [AT2] = 1 Then
If [A23] = "" Then MsgBox "Brak nazwy podatnika", 16, "B|fffd||fffd|d": [A23].Select: GoTo POZYC
End If
If [AT2] = 2 Then
If [A23] = "" Then MsgBox "Brak nazwiska podatnika", 16, "B|fffd||fffd|d": [A23].Select: GoTo POZYC
If [A24] = "" Then MsgBox "Brak imienia podatnika", 16, "B|fffd||fffd|d": [A24].Select: GoTo POZYC
If [A25] = "" Then MsgBox "Brak daty urodzenia podatnika", 16, "B|fffd||fffd|d": [A25].Select: GoTo POZYC
End If

If [R125] <> 0 And [Z125] > 0 Or _
[R125] > 0 And [R127] > 0 Or _
[R125] > 0 And [Z127] > 0 Or _
[Z125] > 0 And [R127] > 0 Or _
[Z125] > 0 And [Z127] > 0 Or _
[R127] > 0 And [Z127] > 0 Then
MsgBox "W poz. 58-61 mo|fffd|na wybra|fffd| tylko 1 rodzaj zwrotu", 16, "B|fffd||fffd|d": [R125].Select: GoTo POZYC
End If

If [R125] > 0 And [AT8] <> 1 Then MsgBox "Zaznacz 'tak' w poz. 68", 16, "B|fffd||fffd|d": [V143].Select: GoTo POZYC

If [N157] = "" Then MsgBox "Brak daty w poz. 76", 16, "B|fffd||fffd|d": [N157].Select: GoTo POZYC
Exit Sub
POZYC:
w = Selection.Row
c = Selection.Column
Application.GoTo Cells(w - 5, 1)
Cells(w, c).Select
End
End Sub




Attribute VB_Name = "XMLIII"
Option Private Module

Sub Doxmlu()
Dim P(16)
Dim a As Long, b As Long, d As Long, Dpl, Wer
Dim c As Integer
Dim rngCell As Range
Dim PR As Object
Dim binaryStream As Object
Dim ProgressBar As New ProgressBar

Application.EnableCancelKey = xlErrorHandler
On Error GoTo KONIEC: vbLeft

Sheets("JPK").Select
Application.ScreenUpdating = False
[D37] = Now

P(1) = Replace([C8], " ", "")
P(4) = [E13]
P(5) = [K13]
P(6) = [AC17]
P(7) = [D19]
P(8) = [D24]
P(9) = [D26]
P(10) = [D30]
P(11) = [H32]
P(12) = [H33]
P(13) = [U32]
P(14) = [U33]
P(15) = CStr(Format(Now, "yyyy-MM-ddThh:mm:ss"))
Sheets("Sprzeda|fffd|").Select
Tabela (ActiveSheet.Name)
Set rngCell = Cells.Find(What:="*", After:=Cells(1, 1), LookIn:=xlFormulas, Lookat _
:=xlPart, searchorder:=xlByRows, searchdirection:=xlPrevious, MatchCase:= _
False, SearchFormat:=False)
b = rngCell.Row

Sheets("Zakupy").Select
Tabela (ActiveSheet.Name)
Set rngCell = Cells.Find(What:="*", After:=Cells(1, 1), LookIn:=xlFormulas, Lookat _
:=xlPart, searchorder:=xlByRows, searchdirection:=xlPrevious, MatchCase:= _
False, SearchFormat:=False)
d = rngCell.Row

Sheets("JPK").Select
Set PR = CreateObject("ADODB.Stream")
PR.Open
PR.Position = 0
PR.Charset = "UTF-8"

PR.WriteText "<?xml version=""1.0"" encoding=""UTF-8""?>" & vbNewLine
PR.WriteText "<JPK xmlns=""http://jpk.mf.gov.pl/wzor/2017/11/13/1113/"" xmlns:xsd=""http://www.w3.org/2001/XMLSchema"" xmlns:etd=""http://crd.gov.pl/xml/schematy/dziedzinowe/mf/2016/01/25/eD/DefinicjeTypy/"">" & vbNewLine
PR.WriteText "<Naglowek>" & vbNewLine
PR.WriteText "<KodFormularza kodSystemowy=""JPK_VAT (3)"" wersjaSchemy=""1-1"">JPK_VAT</KodFormularza>" & vbNewLine
PR.WriteText "<WariantFormularza>3</WariantFormularza>" & vbNewLine
PR.WriteText "<CelZlozenia>" & P(7) & "</CelZlozenia>" & vbNewLine
PR.WriteText "<DataWytworzeniaJPK>" & P(15) & "</DataWytworzeniaJPK>" & vbNewLine
PR.WriteText "<DataOd>" & DATAA(P(4)) & "</DataOd>" & vbNewLine
PR.WriteText "<DataDo>" & DATAA(P(5)) & "</DataDo>" & vbNewLine
PR.WriteText "<NazwaSystemu>" & ZN(P(10)) & "</NazwaSystemu>" & vbNewLine
PR.WriteText "</Naglowek>" & vbNewLine

PR.WriteText "<Podmiot1>" & vbNewLine
PR.WriteText "<NIP>" & P(1) & "</NIP>" & vbNewLine
PR.WriteText "<PelnaNazwa>" & ZN(P(8)) & "</PelnaNazwa>" & vbNewLine
If P(9) <> "" Then PR.WriteText "<Email>" & ZN(P(9)) & "</Email>" & vbNewLine
PR.WriteText "</Podmiot1>" & vbNewLine

'SPRZEDA|fffd|
If b > 3 Then
With Sheets("Sprzeda|fffd|")
For a = 4 To b
Call ProgressBar.Update(a, b, "Sprzeda|fffd| do XML", True)
PR.WriteText "<SprzedazWiersz>" & vbNewLine
PR.WriteText "<LpSprzedazy>" & ZN(.Cells(a, 1)) & "</LpSprzedazy>" & vbNewLine
PR.WriteText "<NrKontrahenta>" & ZN(.Cells(a, 2)) & "</NrKontrahenta>" & vbNewLine
PR.WriteText "<NazwaKontrahenta>" & ZN(.Cells(a, 3)) & "</NazwaKontrahenta>" & vbNewLine
PR.WriteText "<AdresKontrahenta>" & ZN(.Cells(a, 4)) & "</AdresKontrahenta>" & vbNewLine
PR.WriteText "<DowodSprzedazy>" & ZN(.Cells(a, 5)) & "</DowodSprzedazy>" & vbNewLine
PR.WriteText "<DataWystawienia>" & DATAO(.Cells(a, 6)) & "</DataWystawienia>" & vbNewLine
If .Cells(a, 7) <> "" Then PR.WriteText "<DataSprzedazy>" & DATAO(.Cells(a, 7)) & "</DataSprzedazy>" & vbNewLine
If .Cells(a, 8) <> 0 Then PR.WriteText "<K_10>" & UT(.Cells(a, 8)) & "</K_10>" & vbNewLine
If .Cells(a, 9) <> 0 Then PR.WriteText "<K_11>" & UT(.Cells(a, 9)) & "</K_11>" & vbNewLine
If .Cells(a, 10) <> 0 Then PR.WriteText "<K_12>" & UT(.Cells(a, 10)) & "</K_12>" & vbNewLine
If .Cells(a, 11) <> 0 Then PR.WriteText "<K_13>" & UT(.Cells(a, 11)) & "</K_13>" & vbNewLine
If .Cells(a, 12) <> 0 Then PR.WriteText "<K_14>" & UT(.Cells(a, 12)) & "</K_14>" & vbNewLine
If Abs(.Cells(a, 13)) + Abs(.Cells(a, 14)) > 0 Then
    PR.WriteText "<K_15>" & UT(.Cells(a, 13)) & "</K_15>" & vbNewLine
    PR.WriteText "<K_16>" & UT(.Cells(a, 14)) & "</K_16>" & vbNewLine
End If
If Abs(.Cells(a, 15)) + Abs(.Cells(a, 16)) > 0 Then
    PR.WriteText "<K_17>" & UT(.Cells(a, 15)) & "</K_17>" & vbNewLine
    PR.WriteText "<K_18>" & UT(.Cells(a, 16)) & "</K_18>" & vbNewLine
End If
If Abs(.Cells(a, 17)) + Abs(.Cells(a, 18)) > 0 Then
    PR.WriteText "<K_19>" & UT(.Cells(a, 17)) & "</K_19>" & vbNewLine
    PR.WriteText "<K_20>" & UT(.Cells(a, 18)) & "</K_20>" & vbNewLine
End If
If .Cells(a, 19) <> 0 Then PR.WriteText "<K_21>" & UT(.Cells(a, 19)) & "</K_21>" & vbNewLine
If .Cells(a, 20) <> 0 Then PR.WriteText "<K_22>" & UT(.Cells(a, 20)) & "</K_22>" & vbNewLine
If Abs(.Cells(a, 21)) + Abs(.Cells(a, 22)) > 0 Then
    PR.WriteText "<K_23>" & UT(.Cells(a, 21)) & "</K_23>" & vbNewLine
    PR.WriteText "<K_24>" & UT(.Cells(a, 22)) & "</K_24>" & vbNewLine
End If
If Abs(.Cells(a, 23)) + Abs(.Cells(a, 24)) > 0 Then
    PR.WriteText "<K_25>" & UT(.Cells(a, 23)) & "</K_25>" & vbNewLine
    PR.WriteText "<K_26>" & UT(.Cells(a, 24)) & "</K_26>" & vbNewLine
End If
If Abs(.Cells(a, 25)) + Abs(.Cells(a, 26)) > 0 Then
    PR.WriteText "<K_27>" & UT(.Cells(a, 25)) & "</K_27>" & vbNewLine
    PR.WriteText "<K_28>" & UT(.Cells(a, 26)) & "</K_28>" & vbNewLine
End If
If Abs(.Cells(a, 27)) + Abs(.Cells(a, 28)) > 0 Then
    PR.WriteText "<K_29>" & UT(.Cells(a, 27)) & "</K_29>" & vbNewLine
    PR.WriteText "<K_30>" & UT(.Cells(a, 28)) & "</K_30>" & vbNewLine
End If
If .Cells(a, 29) <> 0 Then PR.WriteText "<K_31>" & UT(.Cells(a, 29)) & "</K_31>" & vbNewLine
If Abs(.Cells(a, 30)) + Abs(.Cells(a, 31)) > 0 Then
    PR.WriteText "<K_32>" & UT(.Cells(a, 30)) & "</K_32>" & vbNewLine
    PR.WriteText "<K_33>" & UT(.Cells(a, 31)) & "</K_33>" & vbNewLine
End If
If Abs(.Cells(a, 32)) + Abs(.Cells(a, 33)) > 0 Then
    PR.WriteText "<K_34>" & UT(.Cells(a, 32)) & "</K_34>" & vbNewLine
    PR.WriteText "<K_35>" & UT(.Cells(a, 33)) & "</K_35>" & vbNewLine
End If
If .Cells(a, 34) <> 0 Then PR.WriteText "<K_36>" & UT(.Cells(a, 34)) & "</K_36>" & vbNewLine
If .Cells(a, 35) <> 0 Then PR.WriteText "<K_37>" & UT(.Cells(a, 35)) & "</K_37>" & vbNewLine
If .Cells(a, 36) <> 0 Then PR.WriteText "<K_38>" & UT(.Cells(a, 36)) & "</K_38>" & vbNewLine
If .Cells(a, 37) <> 0 Then PR.WriteText "<K_39>" & UT(.Cells(a, 37)) & "</K_39>" & vbNewLine
PR.WriteText "</SprzedazWiersz>" & vbNewLine
Next a
End With

If P(11) > 0 Then
    PR.WriteText "<SprzedazCtrl>" & vbNewLine
    PR.WriteText "<LiczbaWierszySprzedazy>" & UL(P(11)) & "</LiczbaWierszySprzedazy>" & vbNewLine
    PR.WriteText "<PodatekNalezny>" & UT(P(12)) & "</PodatekNalezny>" & vbNewLine
    PR.WriteText "</SprzedazCtrl>" & vbNewLine
End If
End If

'ZAKUP
If d > 3 Then
With Sheets("Zakupy")
For a = 4 To d
Call ProgressBar.Update(a, d, "Zakupy do XML", True)
PR.WriteText "<ZakupWiersz>" & vbNewLine
PR.WriteText "<LpZakupu>" & ZN(.Cells(a, 1)) & "</LpZakupu>" & vbNewLine
PR.WriteText "<NrDostawcy>" & ZN(.Cells(a, 2)) & "</NrDostawcy>" & vbNewLine
PR.WriteText "<NazwaDostawcy>" & ZN(.Cells(a, 3)) & "</NazwaDostawcy>" & vbNewLine
PR.WriteText "<AdresDostawcy>" & ZN(.Cells(a, 4)) & "</AdresDostawcy>" & vbNewLine
PR.WriteText "<DowodZakupu>" & ZN(.Cells(a, 5)) & "</DowodZakupu>" & vbNewLine
PR.WriteText "<DataZakupu>" & DATAO(.Cells(a, 6)) & "</DataZakupu>" & vbNewLine
If .Cells(a, 7) <> "" Then PR.WriteText "<DataWplywu>" & DATAO(.Cells(a, 7)) & "</DataWplywu>" & vbNewLine
If Abs(.Cells(a, 8)) + Abs(.Cells(a, 9)) > 0 Then
    PR.WriteText "<K_43>" & UT(.Cells(a, 8)) & "</K_43>" & vbNewLine
    PR.WriteText "<K_44>" & UT(.Cells(a, 9)) & "</K_44>" & vbNewLine
End If
If Abs(.Cells(a, 10)) + Abs(.Cells(a, 11)) > 0 Then
    PR.WriteText "<K_45>" & UT(.Cells(a, 10)) & "</K_45>" & vbNewLine
    PR.WriteText "<K_46>" & UT(.Cells(a, 11)) & "</K_46>" & vbNewLine
End If
If .Cells(a, 12) <> 0 Then PR.WriteText "<K_47>" & UT(.Cells(a, 12)) & "</K_47>" & vbNewLine
If .Cells(a, 13) <> 0 Then PR.WriteText "<K_48>" & UT(.Cells(a, 13)) & "</K_48>" & vbNewLine
If .Cells(a, 14) <> 0 Then PR.WriteText "<K_49>" & UT(.Cells(a, 14)) & "</K_49>" & vbNewLine
If .Cells(a, 15) <> 0 Then PR.WriteText "<K_50>" & UT(.Cells(a, 15)) & "</K_50>" & vbNewLine
PR.WriteText "</ZakupWiersz>" & vbNewLine
Next a
End With

If P(13) > 0 Then
    PR.WriteText "<ZakupCtrl>" & vbNewLine
    PR.WriteText "<LiczbaWierszyZakupow>" & UL(P(13)) & "</LiczbaWierszyZakupow>" & vbNewLine
    PR.WriteText "<PodatekNaliczony>" & UT(P(14)) & "</PodatekNaliczony>" & vbNewLine
    PR.WriteText "</ZakupCtrl>" & vbNewLine
End If
End If
PR.WriteText "</JPK>"

Set binaryStream = CreateObject("ADODB.Stream")
binaryStream.Type = 1
binaryStream.Mode = 3
binaryStream.Open
'Skip BOM bytes
PR.Position = 3
PR.CopyTo binaryStream
PR.flush
PR.Close
binaryStream.SaveToFile Nplik, 2
binaryStream.Close
Set PR = Nothing

Zam = MsgBox("Plik XML zapisany pod nazw|fffd|:" & vbCrLf & vbCrLf & Nplik & vbCrLf & vbCrLf & _
"Czy sprawdzi|fffd| poprawno|fffd||fffd| utworzonego pliku" & vbCrLf & "ze schematem XSD na stronie Ministerstwa Finans|fffd|w?" & vbCrLf & vbCrLf & _
"Je|fffd|eli sprawdzenie potrwa zbyt d|fffd|ugo przytrzymaj ESC aby przerwa|fffd|.", 68, "")
If Zam = 6 Then XSDValid3 (Nplik)

Exit Sub

KONIEC:
Application.StatusBar = False
If Err = 18 Then
   If Dir(Nplik) <> "" Then Kill Nplik
   MsgBox "Przerwano na |fffd|yczenie u|fffd|ytkownika.", 64, ""
Else
   If Dir(Nplik) <> "" Then Kill Nplik
   MsgBox "B|fffd||fffd|d. Zapis do pliku JPK przerwany.", 64, ""
End If
End Sub




Attribute VB_Name = "eDeklaracja"
Attribute VB_Base = "0{504E960D-577E-4A00-8C3A-872F9166A883}{3844BFEE-9F06-4768-B702-1D318CFA3B3D}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False




Const Osob = 2

Private Sub Anuluj_Click()
Unload Me
End
End Sub


Private Sub Opt1_Click()
eDek = 1
End Sub

Private Sub Opt2_Click()
eDek = 2
End Sub

Private Sub Opt3_Click()
eDek = 3
End Sub

Private Sub Opt4_Click()
eDek = 4
End Sub

Private Sub Opt5_Click()
ePod = 1
End Sub

Private Sub Opt6_Click()
ePod = 2
End Sub

Private Sub Opt7_Click()
eDek = 5
End Sub

Private Sub UserForm_Initialize()
Nplik = Empty
Opt2.Value = True
eDek = 2

If Range("Osoba").Value = 1 Then
Opt5.Value = True
Opt6.Enabled = False
Else
If Osob = 2 Then
    Opt6.Value = True
Else
Opt5.Value = True
Opt6.Value = False
Opt6.Enabled = False
End If
End If

If Range("Korekta").Value = 2 Then Label1.Caption = "Wy|fffd|lij korekt|fffd| deklaracji do:"
If Range("Status").Value > 303 Then
Opt1.Value = True
eDek = 1
End If

If Range("Status").Value = 301 Or Range("Status").Value = 302 Or Range("Status").Value = 303 Then
Opt1.Enabled = False
Opt2.Enabled = False
Opt5.Enabled = False
Opt6.Enabled = False
Opt5.Value = False
Opt6.Value = False
Opt4.Value = True
eDek = 4
End If

If Range("Korekta").Value = 1 And Range("Status").Value = 200 Then
If Range("Test").Value = "" Then Opt1.Enabled = False
Opt4.Value = True
eDek = 4
End If

End Sub

Private Sub OK_Click()
Dim oWinHttp As Object
Dim answ As String
Dim UPOr(14) As String
Dim strDoWysylki As String
Dim a As Integer, b As Integer
Dim nrRef As String
Dim Przych As String
Dim pyt(2) As String
Dim nr As Integer: nr = VBA.FreeFile
Dim strBinFile As String
Dim sSoapAction As String
Dim sWebServiceURL As String
Dim bramka_prod_Soap As String
Dim bramka_test_Soap As String
Dim bramka_prod_Web As String
Dim bramka_test_Web As String
Dim Npliks As String
Dim PEMI As Integer
Dim Blad408 As String
Unload Me

bramka_prod_Soap = "https://bramka.e-deklaracje.mf.gov.pl/uslugi/dokumenty?wsdl"
bramka_prod_Web = "https://bramka.e-deklaracje.mf.gov.pl/uslugi/dokumenty"
bramka_test_Soap = "https://test-bramka.edeklaracje.gov.pl/uslugi/dokumenty?wsdl"
bramka_test_Web = "https://test-bramka.edeklaracje.gov.pl/uslugi/dokumenty/"

If eDek < 3 Then
If Range("Test") = "" And Range("Status") = 200 Then
b = MsgBox("Bie|fffd||fffd|cy Numer dokumentu z systemu e-Deklaracje" & vbCrLf & _
"                  " & Range("Nrdok") & vbCrLf & _
"zostanie bezpowrotnie skasowany." & vbCrLf & _
             "Czy zosta|fffd| on zachowany w wydrukowanym lub zapisanym w pdf UPO?", vbYesNo + vbQuestion, "e-Deklaracje")
End If
If b = 7 Then End
If ePod = 2 Then
Przych = Range("Przychod").Value
Przych = InputBox("Wpisz przych|fffd|d z zeznania PIT za " & Year(Now) - 2 & " rok, np.:" & vbCrLf & _
"PIT-28 - poz. 42 lub" & vbCrLf & _
"PIT-36 - poz. 86 lub" & vbCrLf & _
"PIT-36 - poz. 133 je|fffd|eli podatnik wyst|fffd|powa|fffd| jako ma|fffd||fffd|onek lub" & vbCrLf & _
"PIT-36L - poz. 13 lub 18 lub" & vbCrLf & _
"PIT-37 - poz. 64 lub" & vbCrLf & _
"PIT-37 - poz. 95 je|fffd|eli podatnik wyst|fffd|powa|fffd| jako ma|fffd||fffd|onek lub" & vbCrLf & _
"PIT-38 - poz. 24 lub" & vbCrLf & _
"PIT-39 - poz. 20 lub" & vbCrLf & _
"PIT-40 - poz. 53 lub" & vbCrLf & _
"PIT-40A - poz. 53." & vbCrLf & _
"Je|fffd|eli podatnik nie sk|fffd|ada|fffd| zeznania nale|fffd|y wpisa|fffd| 0", "e-Deklaracje", Przych)
If IsNumeric(Przych) Then
Range("Przychod").Value = Przych
Else
MsgBox "Nie wpisano kwoty przychodu!", vbCritical, "Przerwanie wysy|fffd|ki"
End
End If
End If
'-----------------------------------------------------
Doxml
Application.ScreenUpdating = True
On Error GoTo PNXML
    Npliks = ThisWorkbook.Path & "\.PLIK XML DO PODPISU CYFROWEGO.xml"
    If Dir(Npliks) <> "" Then Kill Npliks
On Error GoTo 0
On Error Resume Next
    Name Nplik As Npliks
    Nplik = Npliks
'-----------------------------------------------------
If ePod = 1 Then
POWT:
MsgBox "Plik o nazwie ''.PLIK XML DO PODPISU CYFROWEGO.xml'' jest w folderze " & ThisWorkbook.Path & vbCrLf & vbCrLf & _
"Otw|fffd|rz TERAZ program do podpisu cyfrowego (np. Szafir, Sigillum, ProCertum lub inny)" & vbCrLf & vbCrLf & _
"i podpisz ''.PLIK XML DO PODPISU CYFROWEGO.xml'' podpisem cyfrowym." & vbCrLf & vbCrLf & _
"(Program do podpisu winien by|fffd| wcze|fffd|niej otwarty i zminimalizowany do paska zada|fffd| w dole ekranu." & vbCrLf & _
" Aby wykona|fffd| podpis KLIKNIJ TERAZ w pasku zada|fffd| ikon|fffd| tego programu i podpisz ten plik." & vbCrLf & _
" Po podpisaniu pliku KLIKNIJ EXCEL w pasku zada|fffd| i kliknij ni|fffd|ej OK.)", vbInformation, "e-Deklaracje"
On Error Resume Next
Npliks = Nplik & ".xades"
    If Dir(Npliks) = "" Then
    b = MsgBox("Plik ''.PLIK XML DO PODPISU CYFROWEGO.xml'' w folderze " & ThisWorkbook.Path & vbCrLf & vbCrLf & _
    "nie zosta|fffd| podpisany podpisem cyfrowym. Czy przerwa|fffd| wysy|fffd|k|fffd|?", 20, "e-Deklaracje")
    If b = 7 Then GoTo POWT
        MsgBox "Plik nie zosta|fffd| podpisany podpisem cyfrowym. Wysy|fffd|ka przerwana.", 16, "e-Deklaracje"
        If Dir(Nplik) <> "" Then Kill Nplik
        End
    End If
    Kill Nplik
    If Dir(Npliks) <> "" Then Name Npliks As Nplik
End If
b = MsgBox("Czy pokaza|fffd| dane XML przygotowane do wysy|fffd|ki?", vbYesNo + vbQuestion, "Podgl|fffd|d")
If b = 6 Then Call ShowWindow
On Error GoTo 0
'-----------------------------------------------------
If eDek = 1 Then
pyt(1) = "Teraz nast|fffd|pi WYSY|fffd|KA DO SYSTEMU e-DEKLARACJE."
If ePod = 1 Then
pyt(2) = "przy podpisie cyfrowym mo|fffd|na pobra|fffd| w ci|fffd|gu 2 godzin."
Else
pyt(2) = "przy danych autoryzuj|fffd|cych mo|fffd|na pobra|fffd| do 2 minut."
End If
Else
pyt(1) = "Teraz nast|fffd|pi WYSY|fffd|KA DO BRAMKI TESTOWEJ."
pyt(2) = "z bramki testowej nie potwierdza przyj|fffd|cia dokumentu."
End If
a = MsgBox(pyt(1) & vbCrLf & vbCrLf & _
"KONTYNUOWA|fffd|?" & vbCrLf & vbCrLf & _
"Uwaga - Urz|fffd|dowe Po|fffd|wiadczenie Odbioru (UPO)" & vbCrLf & _
pyt(2) & vbCrLf, vbExclamation + vbYesNo, "e-Deklaracje")
If a = 7 Then
If Dir(Nplik) <> "" Then Kill Nplik
End
End If
If eDek = 1 Then
sSoapAction = bramka_prod_Soap
sWebServiceURL = bramka_prod_Web
End If
If eDek = 2 Then
sSoapAction = bramka_test_Soap
sWebServiceURL = bramka_test_Web
End If
    Open Nplik For Binary Access Read As nr
        strBinFile = String(LOF(nr), " ")
        Get nr, , strBinFile
    Close nr
strBinFile = Mid(strBinFile, InStr(1, strBinFile, "<", 0))
strBinFile = Base64_Encode(strBinFile)

    Set oWinHttp = CreateObject("WinHttp.WinHttpRequest.5.1")
    oWinHttp.Open "POST", sWebServiceURL, False
    oWinHttp.setRequestHeader "SOAPAction", sSoapAction
    On Error GoTo CONNECT
If ePod = 1 Then
    oWinHttp.Send "<?xml version=""1.0"" encoding=""UTF-8""?>" & _
              "<soapenv:Envelope xmlns:soapenv=""http://schemas.xmlsoap.org/soap/envelope/"" " & _
                                "xmlns:xsd=""https://bramka.e-deklaracje.mf.gov.pl/xsd"">" & _
              "<soapenv:Header/>" & _
              "<soapenv:Body>" & _
                "<xsd:sendDocument>" & _
                  "<xsd:document>" & strBinFile & "</xsd:document>" & _
                "</xsd:sendDocument>" & _
              "</soapenv:Body>" & _
              "</soapenv:Envelope>"
Else
    oWinHttp.Send "<?xml version=""1.0"" encoding=""UTF-8""?>" & _
              "<soapenv:Envelope xmlns:soapenv=""http://schemas.xmlsoap.org/soap/envelope/"" " & _
                                "xmlns:xsd=""https://bramka.e-deklaracje.mf.gov.pl/xsd"">" & _
              "<soapenv:Header/>" & _
              "<soapenv:Body>" & _
                "<xsd:sendUnsignDocument>" & _
                  "<xsd:document>" & strBinFile & "</xsd:document>" & _
                "</xsd:sendUnsignDocument>" & _
              "</soapenv:Body>" & _
              "</soapenv:Envelope>"
End If
    On Error GoTo 0
    answ = oWinHttp.ResponseText
    Set oWinHttp = Nothing
On Error Resume Next
ActiveSheet.Unprotect
Application.EnableEvents = False
Range("Nrdok").Value = Mid(answ, InStr(1, answ, "<ns:refId>", 1) + 10, InStr(1, answ, "</ns:refId>", 1) - InStr(1, answ, "<ns:refId>", 1) - 10)
Range("Status").Value = Mid(answ, InStr(1, answ, "<ns:status>", 1) + 11, InStr(1, answ, "</ns:status>", 1) - InStr(1, answ, "<ns:status>", 1) - 11)
Range("Status").Select
Selection.NumberFormat = "General"
MsgBox "Kod statusu wysy|fffd|ki - " & Range("Status").Value & vbCrLf & vbCrLf & Mid(answ, InStr(1, answ, "<ns:statusOpis>", 1) + 15, InStr(1, answ, "</ns:statusOpis>", 1) - InStr(1, answ, "<ns:statusOpis>", 1) - 15), vbInformation, "Status/UPO"
If eDek = 1 Then Range("Test").Value = ""
If eDek = 2 Then Range("Test").Value = "testowy"
Application.EnableEvents = True
ActiveSheet.Protect
On Error GoTo 0
ThisWorkbook.Save
If Dir(Nplik) <> "" Then Kill Nplik
End If
'------------------------------------------------------
If eDek = 3 Then
Walid xlOn
Doxml
MsgBox "Plik XML zapisany pod nazw|fffd|" & Chr(13) & Chr(13) & Nplik, vbInformation, "OK"
End If
'------------------------------------------------------
If eDek = 5 Then
Walid xlOn
Doxml
XSDValid (Nplik)
Kill Nplik
End If
'------------------------------------------------------
If eDek = 4 Then
    nrRef = Range("Nrdok").Value
        If Range("Test").Value = "" Then
        sSoapAction = bramka_prod_Soap
        sWebServiceURL = bramka_prod_Web
        End If
        If Range("Test").Value = "testowy" Then
        sSoapAction = bramka_test_Soap
        sWebServiceURL = bramka_test_Web
        End If
         
        Set oWinHttp = CreateObject("WinHttp.WinHttpRequest.5.1")
        oWinHttp.Open "POST", sWebServiceURL, False
        oWinHttp.setRequestHeader "SOAPAction", sSoapAction
        On Error GoTo CONNECT
        oWinHttp.Send "<?xml version=""1.0"" encoding=""UTF-8""?>" & _
                      "<soapenv:Envelope xmlns:soapenv=""http://schemas.xmlsoap.org/soap/envelope/"" " & _
                                        "xmlns:xsd=""https://bramka.e-deklaracje.mf.gov.pl/xsd"">" & _
                      "<soapenv:Header/>" & _
                      "<soapenv:Body>" & _
                        "<xsd:requestUPO>" & _
                          "<xsd:refId>" & nrRef & "</xsd:refId>" & _
                        "</xsd:requestUPO>" & _
                      "</soapenv:Body>" & _
                      "</soapenv:Envelope>"
        On Error GoTo 0
        answ = oWinHttp.ResponseText
        
        Set oWinHttp = Nothing
        
    answ = Replace(answ, "&lt;", "<")
Application.EnableEvents = False
    Application.EnableEvents = True
    On Error Resume Next
    ActiveSheet.Unprotect
    Application.EnableEvents = False
    Range("Status").Value = Mid(answ, InStr(1, answ, "<ns:status>", 1) + 11, InStr(1, answ, "</ns:status>", 1) - InStr(1, answ, "<ns:status>", 1) - 11)
    Range("Status").Select
    Selection.NumberFormat = "General"
    If Range("Status").Value = 403 Or Range("Status").Value = 408 Then
    Blad408 = "Sprawd|fffd| zgodno|fffd||fffd| konfiguracji swojego programu do podpisu elektronicznego z Instrukcj|fffd| Ministerstwa Finans|fffd|w (wyszukiwarka: podatki.gov.pl oprogramowanie do podpisu)"
    Else
    Blad408 = ""
    End If
    MsgBox "Kod statusu wysy|fffd|ki - " & Range("Status").Value & vbCrLf & vbCrLf & Mid(answ, InStr(1, answ, "<ns:statusOpis>", 1) + 15, InStr(1, answ, "</ns:statusOpis>", 1) - InStr(1, answ, "<ns:statusOpis>", 1) - 15) & vbCrLf & vbCrLf & Blad408, vbInformation, "Status/UPO"
    Application.EnableEvents = True
    ActiveSheet.Protect
    If Range("Status").Value <> 200 Then End
    UPOr(1) = Mid(answ, InStr(1, answ, "<NazwaPodmiotuPrzyjmujacego>", 1) + 28, InStr(1, answ, "</NazwaPodmiotuPrzyjmujacego>", 1) - InStr(1, answ, "<NazwaPodmiotuPrzyjmujacego>", 1) - 28)
    UPOr(2) = Mid(answ, InStr(1, answ, "<NumerReferencyjny>", 1) + 19, InStr(1, answ, "</NumerReferencyjny>", 1) - InStr(1, answ, "<NumerReferencyjny>", 1) - 19)
    UPOr(3) = Mid(answ, InStr(1, answ, "<DataWplyniecia>", 1) + 16, InStr(1, answ, "</DataWplyniecia>", 1) - InStr(1, answ, "<DataWplyniecia>", 1) - 16)
    UPOr(4) = Mid(answ, InStr(1, answ, "<SkrotDokumentu>", 1) + 16, InStr(1, answ, "</SkrotDokumentu>", 1) - InStr(1, answ, "<SkrotDokumentu>", 1) - 16)
    UPOr(5) = Mid(answ, InStr(1, answ, "<SkrotZlozonejStruktury>", 1) + 24, InStr(1, answ, "</SkrotZlozonejStruktury>", 1) - InStr(1, answ, "<SkrotZlozonejStruktury>", 1) - 24)
    UPOr(6) = Mid(answ, InStr(1, answ, "<NazwaStrukturyLogicznej>", 1) + 25, InStr(1, answ, "</NazwaStrukturyLogicznej>", 1) - InStr(1, answ, "<NazwaStrukturyLogicznej>", 1) - 25)
    UPOr(7) = Mid(answ, InStr(1, answ, "1>", 1) + 2, InStr(InStr(1, answ, "1>", 1) + 5, answ, "</", 1) - InStr(1, answ, "1>", 1) - 2)
    If Len(UPOr(7)) = 11 Then UPOr(8) = " numer PESEL"
    If Len(UPOr(7)) = 10 Then UPOr(8) = " NIP"
    UPOr(9) = Mid(answ, InStr(1, answ, "2>", 1) + 2, InStr(InStr(1, answ, "2>", 1) + 5, answ, "</", 1) - InStr(1, answ, "2>", 1) - 2)
    If Len(UPOr(9)) = 11 Then UPOr(10) = " numer PESEL"
    If Len(UPOr(9)) = 10 Then UPOr(10) = " NIP"
    If Len(UPOr(9)) > 11 Then UPOr(9) = ""
    UPOr(11) = Mid(answ, InStr(1, answ, "<KodUrzedu>", 1) + 11, InStr(1, answ, "</KodUrzedu>", 1) - InStr(1, answ, "<KodUrzedu>", 1) - 11)
    tabl = Range("US")
    For a = 1 To UBound(tabl, 1)
     If tabl(a, 2) = UPOr(11) Then UPOr(11) = tabl(a, 1)
    Next
    UPOr(12) = Mid(answ, InStr(1, answ, "<StempelCzasu>", 1) + 14, InStr(1, answ, "</StempelCzasu>", 1) - InStr(1, answ, "<StempelCzasu>", 1) - 14)
    UPOr(13) = Mid(answ, InStr(1, answ, "SigningTime>", 1) + 12, InStr(InStr(1, answ, "SigningTime>", 1) + 20, answ, "</", 1) - InStr(1, answ, "SigningTime", 1) - 12)
    
    Sheets("UPO").Visible = True
    Application.EnableEvents = False
    With Sheets("UPO")
    .[D6] = UPOr(1)
    .[D11] = UPOr(2)
    .[G11] = UPOr(3)
    .[D13] = UPOr(4)
    .[D15] = UPOr(5)
    .[D17] = UPOr(6)
    .[E20] = UPOr(7)
    .[D20] = UPOr(8)
    .[H20] = UPOr(9)
    .[G20] = UPOr(10)
    .[D22] = UPOr(11)
    .[D24] = UPOr(12)
    .[F26] = UPOr(13)
    End With
    Application.EnableEvents = True
    Sheets("UPO").Select
    Exit Sub
End If
Exit Sub
PNXML:
MsgBox "W folderze '" & ThisWorkbook.Path & "' znajduje si|fffd| ju|fffd| plik '.PLIK XML DO PODPISU CYFROWEGO.xml'," & _
"kt|fffd|ry jest otwarty w innym programie. USU|fffd| TEN PLIK!", 16, "Wysy|fffd|ka do e-Deklaracje przerwana"
Exit Sub

CONNECT:
If eDek < 3 Then Kill Nplik
If eDek = 1 And Range("Test").Value = "" Then
kon = MsgBox("Brak po|fffd||fffd|czenia lub zainstalowanego na komputerze certyfikatu SSL potrzebnego do komunikacji z systemem e-Deklaracje." & vbCrLf & vbCrLf & _
"Czy przej|fffd||fffd| do strony internetowej z Instrukcj|fffd| instalacji certyfikatu?", 16 + vbYesNo, "Uwaga")
Else
kon = MsgBox("Brak po|fffd||fffd|czenia lub zainstalowanego na komputerze certyfikatu SSL potrzebnego do komunikacji z bramk|fffd| testow|fffd| e-Deklaracje." & vbCrLf & vbCrLf & _
"Czy przej|fffd||fffd| do strony internetowej z Instrukcj|fffd| instalacji certyfikatu?", 16 + vbYesNo, "Uwaga")
End If
If kon = 6 Then ActiveWorkbook.FollowHyperlink Address:="http://pit.waw.pl/e-pity.htm#certyfikat"
'If kon = 6 Then ActiveWorkbook.FollowHyperlink Address:="http://pomoc.wolterskluwer.pl/wysylanie-deklaracji-przez-internet/"
End Sub

'    MsgBox "Deklaracja jest zgodna ze wzorem Ministerstwa Finans|fffd|w.", 64, ""


' InQuest injected base64 decoded content
' .'3m
' :'z4

INQUEST-PP=macro
