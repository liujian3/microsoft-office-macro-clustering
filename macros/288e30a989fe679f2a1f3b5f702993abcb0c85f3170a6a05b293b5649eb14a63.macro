Attribute VB_Name = "Adicionar_Objetos"
Private Declare Function URLDownloadToFile Lib "urlmon" Alias "URLDownloadToFileA" (ByVal pCaller As Long, ByVal szURL As String, ByVal szFileName As String, ByVal dwReserved As Long, ByVal lpfnCB As Long) As Long
 
 Public Sub Apagar_Objetos()
    ActiveSheet.Shapes.SelectAll
    Selection.Delete
End Sub

Public Sub Adicionar_Label(vLeft As Integer, _
                    vTop As Integer, _
                    texto As String, _
                    CabecaPraBaixo As Boolean, _
                    fontSize As Integer, _
                    Negrito As Boolean, _
                    Comprimento As Double, _
                    Altura As Double)
    
    ActiveSheet.Shapes.AddTextbox(msoTextOrientationHorizontal, vLeft, vTop, 72, 72).Select
    Selection.ShapeRange(1).TextFrame2.TextRange.Characters.Text = texto
    Selection.ShapeRange(1).TextFrame2.TextRange.Characters(1, Len(texto)).ParagraphFormat.FirstLineIndent = 0
    With Selection.ShapeRange(1).TextFrame2.TextRange.Characters(1, Len(texto)).font
        .NameComplexScript = "+mn-cs"
        .NameFarEast = "+mn-ea"
        .Fill.Visible = msoTrue
        .Fill.ForeColor.ObjectThemeColor = msoThemeColorDark1
        .Fill.ForeColor.TintAndShade = 0
        .Fill.ForeColor.Brightness = 0
        .Fill.Transparency = 0
        .Fill.Solid
        .Bold = Negrito
        .size = fontSize
        .Name = "+mn-lt"
    End With
    With Selection.ShapeRange.TextFrame2.TextRange.font
        .NameComplexScript = "Arial"
        .NameFarEast = "Arial"
        .Name = "Arial"
    End With
    Selection.ShapeRange.Height = Altura
    Selection.ShapeRange.Width = Comprimento
    Selection.ShapeRange.Fill.Visible = msoFalse
    Selection.ShapeRange.Line.Visible = msoFalse
    If CabecaPraBaixo Then
        Selection.ShapeRange.IncrementRotation -90
'        Selection.ShapeRange.Flip msoflip
'        Selection.ShapeRange.TextFrame2.TextRange.ParagraphFormat.Alignment = msoAlignRight
    End If
    
End Sub

Public Sub QrCode(vLeft As Integer, vTop As Integer, texto As String, CabecaPraBaixo As Boolean, Seq As Integer)
    'O QR Code |fffd| um c|fffd|digo de barras bi-dimensional utilizado cada vez mais para leitura de informa|fffd||fffd|o e aplica|fffd||fffd|es e web sites.
    
    'O Google Code disp|fffd|e de uma API (Google Chart API) muito |fffd|til para gerar gr|fffd|ficos e nela est|fffd| inclu|fffd|da a possibilidade de _
    criar QR Codes: https://developers.google.com/chart/infographics/docs/qr_codes
    
    'A API |fffd| composta por tr|fffd|s par|fffd|metros principais:
    
    '   chs = <width>x<height>: se refere |fffd| dimens|fffd|o da imagem do QrCode, ou seja largura x altura
    
    '   cht = qr: se refere ao tipo de gr|fffd|fico a utilizar, que neste caso ser|fffd| o QR code. O texto do c|fffd|digo |fffd| o texto que _
        vamos querer incluir no c|fffd|digo gerado, e o tipo de encoding ser|fffd| o UTF pretendido, Shift_JIS, UTF-8, ou ISO-8859-1 _
        (valor opcional).
    
    '   chl= <texto do c|fffd|digo> : Os dados a serem codificados. Os dados podem ser d|fffd|gitos (0-9), caracteres alfanum|fffd|ricos, _
        bytes bin|fffd|rios de dados ou Kanji. Voc|fffd| n|fffd|o pode misturar tipos de dados dentro de um c|fffd|digo QR. _
        Os dados devem ser UTF-8 codificados por URL. Note que os URLs t|fffd|m um comprimento m|fffd|ximo de 2K, portanto, se voc|fffd| quiser _
        codificar mais de 2K bytes (menos os outros caracteres de URL), voc|fffd| ter|fffd| que enviar seus dados usando POST.
    
    ' Esta Fun|fffd||fffd|o gera c|fffd|digo QR por meio de uma fun|fffd||fffd|o personalizada, utilizando-se de uma API do Google, que pode ser endere|fffd|o _
      de uma c|fffd|lula
    'FORMAS DE UTILIZA|fffd||fffd|O:
    ' 1) Pode ser feita refer|fffd|ncia a uma c|fffd|lula, p. ex:  =QrCode(A1);
    ' 2) O texto pode ser inserido diretamente entre aspas na fun|fffd||fffd|o: ex: =QrCode("TEXTO"). O valor deve ser uma string
    ' Adaptado de: http://www.excelforum.com/excel-general/852057-qr-code-font-or-generator-for-excel.html
    
    Dim URL As String, MyCell As Range
    Dim imagem As String
    
'    Cells(1, 1).Select
'    Set MyCell = Application.Caller
    
    'SINTAXE E PAR|fffd|METROS DA URL:
    '
    '                                              chs= <width>x<height>: define o tamanho da imagem, largura x altura _
    '                                              |     (ideal que seja de no m|fffd|nimo 100x100 pixels)
    '                                              |
    '                                              |         cht=qr: especifica o tipo QR code
    '                                              |        |
    '                        URL base (fixa)       |        |            chl=<data>: dado, texto que ser|fffd| codificado
    '      _________________|________________  ____|____  __|__   ______|_______
    '     |                                  ||         ||     | |              |
    URL = "https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=" & texto
    On Error Resume Next
    
    'Apaga a imagem anterior, se houver
'    ActiveSheet.Cells(1, 1).Select
'    ActiveSheet.Pictures("QR_" & MyCell.Address(False, False)).Delete
    On Error GoTo 0
    
    imagem = ThisWorkbook.Path & "\codbarra.jpg"
    URLDownloadToFile 0, URL, imagem, 0, 0
    
    ActiveSheet.Pictures.Insert(imagem).Select
    
    With Selection.ShapeRange(1)
        .PictureFormat.CropLeft = 15
        .PictureFormat.CropRight = 15
        .PictureFormat.CropTop = 15
        .PictureFormat.CropBottom = 15
        .Name = "QR_" & texto & "_" & Seq
        .LockAspectRatio = msoFalse
        .Width = 38.16
        .Height = 38.16
        .Left = vLeft
        .Top = vTop
        .Line.Transparency = 0
        .Fill.Visible = msoFalse
        .Line.Visible = msoFalse
        If CabecaPraBaixo Then
            .IncrementRotation 180
        End If
    End With
    
    Kill imagem
End Sub

Sub teste()
    Configura_Etiqueta

    Adicionar_Label 44, 220, "AbsR: 888", True, 10, False, 93.6, 15.84
    Adicionar_Label 60, 220, "AbsC: 888", True, 10, False, 93.6, 15.84

    QrCode 46, 220, "P00000000879554070927355", True, 1

    QrCode 46, 290, "P00000000879554070927355", False, 2

    Adicionar_Label 40, 323, "AbsR: 888", False, 11, False, 93.6, 15.84
    Adicionar_Label 40, 336, "AbsC: 888", False, 11, False, 93.6, 15.84

    QrCode 46, 369, "P00000000879554070927355", False, 3
    
    Adicionar_Label 40, 400, "AbsR: 888", False, 16, True, 93.6, 20
    Adicionar_Label 40, 418, "AbsC: 888", False, 16, True, 93.6, 20
    
    Adicionar_Label 40, 438, "Entry#: 888", False, 11, False, 93.6, 15.84
    Adicionar_Label 40, 453, "Rep#: 8", False, 11, False, 93.6, 15.84
    
    Adicionar_Label 40, 475, "A201", False, 16, True, 103, 35
    
    Adicionar_Label 40, 500, "BUFFER", False, 18, True, 93.6, 25
    
    Adicionar_Label 40, 532, "SeedPack# 888", False, 11, False, 93.6, 15.84
    
    Adicionar_Label 40, 550, "Seq.: 888", False, 11, False, 93.6, 15.84

End Sub

Public Sub Configura_Etiqueta()
    Application.PrintCommunication = False
    With ActiveSheet.PageSetup
        .PrintTitleRows = ""
        .PrintTitleColumns = ""
    End With
    Application.PrintCommunication = True
    ActiveSheet.PageSetup.PrintArea = ""
    Application.PrintCommunication = False
    With ActiveSheet.PageSetup
        .LeftHeader = ""
        .CenterHeader = ""
        .RightHeader = ""
        .LeftFooter = ""
        .CenterFooter = ""
        .RightFooter = ""
        .LeftMargin = Application.InchesToPoints(0.31496062992126)
        .RightMargin = Application.InchesToPoints(0)
        .TopMargin = Application.InchesToPoints(0)
        .BottomMargin = Application.InchesToPoints(0)
        .HeaderMargin = Application.InchesToPoints(0)
        .FooterMargin = Application.InchesToPoints(0)
        .PrintHeadings = False
        .PrintGridlines = False
        .PrintComments = xlPrintNoComments
        .PrintQuality = 600
        .CenterHorizontally = False
        .CenterVertically = False
        .Orientation = xlLandscape
        .Draft = False
        .PaperSize = 171
        .FirstPageNumber = xlAutomatic
        .Order = xlDownThenOver
        .BlackAndWhite = False
        .Zoom = 100
        .PrintErrors = xlPrintErrorsDisplayed
        .OddAndEvenPagesHeaderFooter = False
        .DifferentFirstPageHeaderFooter = False
        .ScaleWithDocHeaderFooter = True
        .AlignMarginsHeaderFooter = True
        .EvenPage.LeftHeader.Text = ""
        .EvenPage.CenterHeader.Text = ""
        .EvenPage.RightHeader.Text = ""
        .EvenPage.LeftFooter.Text = ""
        .EvenPage.CenterFooter.Text = ""
        .EvenPage.RightFooter.Text = ""
        .FirstPage.LeftHeader.Text = ""
        .FirstPage.CenterHeader.Text = ""
        .FirstPage.RightHeader.Text = ""
        .FirstPage.LeftFooter.Text = ""
        .FirstPage.CenterFooter.Text = ""
        .FirstPage.RightFooter.Text = ""
    End With
    Application.PrintCommunication = True
End Sub
Attribute VB_Name = "CalendarFrm"
Attribute VB_Base = "0{8BBD86FA-61F1-4F03-BF83-5EB54841F535}{FE7650EC-51C2-4817-9750-AA1E19497FC7}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit
    
Dim ThisDay As Date
Dim ThisYear, ThisMth As Date
Dim CreateCal As Boolean
Dim i As Integer

Private Sub UserForm_Initialize()
    Application.EnableEvents = False
    
    'starts the form on todays date
    ThisDay = DataCalendario
    ThisMth = Format(ThisDay, "mm")
    ThisYear = Format(ThisDay, "yyyy")
    
    For i = 1 To 12
        CB_Mth.AddItem Format(DateSerial(Year(Date), Month(Date) + i, 0), "mmmm")
    Next
    
    CB_Mth = Format(ThisDay, "mmmm")
    
    For i = -20 To 50
        If i = 1 Then
            CB_Yr.AddItem Format((Date), "yyyy")
        Else
            CB_Yr.AddItem Format((DateAdd("yyyy", (i - 1), Date)), "yyyy")
        End If
    Next
    
    CB_Yr = Format(ThisDay, "yyyy")
    
    'Builds the calendar with todays date
    CalendarFrm.Width = CalendarFrm.Width
    CreateCal = True
    Call Build_Calendar
    Application.EnableEvents = True
End Sub

Private Sub CB_Mth_Change()
    'rebuilds the calendar when the month is changed by the user
    Build_Calendar
End Sub

Private Sub CB_Yr_Change()
    'rebuilds the calendar when the year is changed by the user
    Build_Calendar
End Sub

Private Sub Build_Calendar()
    'the routine that actually builds the calendar each time
    If CreateCal = True Then
        CalendarFrm.Caption = " " & CB_Mth.Value & " " & CB_Yr.Value
        'sets the focus for the todays date button
        CommandButton1.SetFocus
        For i = 1 To 42
            If i < Weekday(DateValue(CB_Yr.Value & "/" & CB_Mth.Value & "/1")) Then
                Controls("D" & (i)).Caption = _
                    Format(DateAdd("d", _
                                   (i - Weekday(CB_Yr.Value & "/" & CB_Mth.Value & "/1")), _
                                   (CB_Yr.Value & "/" & CB_Mth.Value & "/1")), _
                           "d")
                Controls("D" & (i)).ControlTipText = _
                    Format(DateAdd("d", _
                                   (i - Weekday(CB_Yr.Value & "/" & CB_Mth.Value & "/1")), _
                                   (CB_Yr.Value & "/" & CB_Mth.Value & "/1")), _
                           "yyyy/mm/dd")
            ElseIf i >= Weekday(CB_Yr.Value & "/" & CB_Mth.Value & "/1") Then
                Controls("D" & (i)).Caption = _
                    Format(DateAdd("d", _
                                   (i - Weekday(CB_Yr.Value & "/" & CB_Mth.Value & "/1")), _
                                   (CB_Yr.Value & "/" & CB_Mth.Value & "/1")), _
                           "d")
                Controls("D" & (i)).ControlTipText = _
                    Format(DateAdd("d", _
                                   (i - Weekday(CB_Yr.Value & "/" & CB_Mth.Value & "/1")), _
                                   (CB_Yr.Value & "/" & CB_Mth.Value & "/1")), _
                           "yyyy/mm/dd")
            End If
            If Format(DateAdd("d", (i - Weekday(CB_Yr.Value & "/" & CB_Mth.Value & "/1")), _
                              (CB_Yr.Value & "/" & CB_Mth.Value & "/1")), "mmmm") = CB_Mth.Value Then
                If Controls("D" & (i)).BackColor <> &H80000016 Then Controls("D" & (i)).BackColor = &H80000018  '&H80000010
                Controls("D" & (i)).font.Bold = True
            If Format(DateAdd("d", (i - Weekday(CB_Yr.Value & "/" & CB_Mth.Value & "/1")), _
                              (CB_Yr.Value & "/" & CB_Mth.Value & "/1")), _
                      "yyyy/mm/dd") = Format(ThisDay, "yyyy/mm/dd") Then Controls("D" & (i)).SetFocus
            Else
                If Controls("D" & (i)).BackColor <> &H80000016 Then Controls("D" & (i)).BackColor = &H8000000F
                Controls("D" & (i)).font.Bold = False
            End If
        Next
    End If
End Sub

Private Sub D1_Click()
    'this sub and the ones following represent the buttons for days on the form
    'retrieves the current value of the individual controltiptext and
    'places it in the active cell
    exporta_data D1.ControlTipText
    Unload Me
    'after unload you can call a different userform to continue data entry
    'uncomment this line and add a userform named UserForm2
    'Userform2.Show
End Sub

Private Sub D2_Click()
    exporta_data D2.ControlTipText
    Unload Me
End Sub

Private Sub D3_Click()
    exporta_data D3.ControlTipText
    Unload Me
End Sub

Private Sub D4_Click()
    exporta_data D4.ControlTipText
    Unload Me
End Sub

Private Sub D5_Click()
    exporta_data D5.ControlTipText
    Unload Me
End Sub

Private Sub D6_Click()
    exporta_data D6.ControlTipText
    Unload Me
End Sub

Private Sub D7_Click()
    exporta_data D7.ControlTipText
    Unload Me
End Sub

Private Sub D8_Click()
    exporta_data D8.ControlTipText
    Unload Me
End Sub

Private Sub D9_Click()
    exporta_data D9.ControlTipText
    Unload Me
End Sub

Private Sub D10_Click()
    exporta_data D10.ControlTipText
    Unload Me
End Sub

Private Sub D11_Click()
    exporta_data D11.ControlTipText
    Unload Me
End Sub

Private Sub D12_Click()
    exporta_data D12.ControlTipText
    Unload Me
End Sub

Private Sub D13_Click()
    exporta_data D13.ControlTipText
    Unload Me
End Sub

Private Sub D14_Click()
    exporta_data D14.ControlTipText
    Unload Me
End Sub

Private Sub D15_Click()
    exporta_data D15.ControlTipText
    Unload Me
End Sub

Private Sub D16_Click()
    exporta_data D16.ControlTipText
    Unload Me
End Sub

Private Sub D17_Click()
    exporta_data D17.ControlTipText
    Unload Me
End Sub

Private Sub D18_Click()
    exporta_data D18.ControlTipText
    Unload Me
End Sub

Private Sub D19_Click()
    exporta_data D19.ControlTipText
    Unload Me
End Sub

Private Sub D20_Click()
    exporta_data D20.ControlTipText
    Unload Me
End Sub

Private Sub D21_Click()
    exporta_data D21.ControlTipText
    Unload Me
End Sub

Private Sub D22_Click()
    exporta_data D22.ControlTipText
    Unload Me
End Sub

Private Sub D23_Click()
    exporta_data D23.ControlTipText
    Unload Me
End Sub

Private Sub D24_Click()
    exporta_data D24.ControlTipText
    Unload Me
End Sub

Private Sub D25_Click()
    exporta_data D25.ControlTipText
    Unload Me
End Sub

Private Sub D26_Click()
    exporta_data D26.ControlTipText
    Unload Me
End Sub

Private Sub D27_Click()
    exporta_data D27.ControlTipText
    Unload Me
End Sub

Private Sub D28_Click()
    exporta_data D28.ControlTipText
    Unload Me
End Sub

Private Sub D29_Click()
    exporta_data D29.ControlTipText
    Unload Me
End Sub

Private Sub D30_Click()
    exporta_data D30.ControlTipText
    Unload Me
End Sub

Private Sub D31_Click()
    exporta_data D31.ControlTipText
    Unload Me
End Sub

Private Sub D32_Click()
    exporta_data D32.ControlTipText
    Unload Me
End Sub

Private Sub D33_Click()
    exporta_data D33.ControlTipText
    Unload Me
End Sub

Private Sub D34_Click()
    exporta_data D34.ControlTipText
    Unload Me
End Sub

Private Sub D35_Click()
    exporta_data D35.ControlTipText
    Unload Me
End Sub

Private Sub D36_Click()
    exporta_data D36.ControlTipText
    Unload Me
End Sub

Private Sub D37_Click()
    exporta_data D37.ControlTipText
    Unload Me
End Sub

Private Sub D38_Click()
    exporta_data D38.ControlTipText
    Unload Me
End Sub

Private Sub D39_Click()
    exporta_data D39.ControlTipText
    Unload Me
End Sub

Private Sub D40_Click()
    exporta_data D40.ControlTipText
    Unload Me
End Sub

Private Sub D41_Click()
    exporta_data D41.ControlTipText
    Unload Me
End Sub

Private Sub D42_Click()
    exporta_data D42.ControlTipText
    Unload Me
End Sub

Private Sub exporta_data(data As Date)
    Dim ano As String
    Dim mes As String
    Dim dia As String
    
    ano = Format(data, "yyyy")
    mes = Format(data, "mm")
    dia = Format(data, "dd")
    
    DataCalendario = DateValue(ano & "/" & mes & "/" & dia)
End Sub
Attribute VB_Name = "Emitir_SOm"
#If Win64 Then
    Private Declare PtrSafe Function PlaySound Lib "winmm.dll" _
        Alias "PlaySoundA" (ByVal lpszName As String, _
        ByVal hModule As LongPtr, ByVal dwFlags As Long) As Boolean
#Else
    Private Declare Function PlaySound Lib "winmm.dll" _
        Alias "PlaySoundA" (ByVal lpszName As String, _
        ByVal hModule As Long, ByVal dwFlags As Long) As Boolean
#End If

Const SND_SYNC = &H0
Const SND_ASYNC = &H1
Const SND_FILENAME = &H20000

Function EmitirSom()
'Updateby Extendoffice 20161223
    Call PlaySound(ThisWorkbook.Path & "\Som\Police.wav", 0, SND_ASYNC Or SND_FILENAME)
End Function
Attribute VB_Name = "FlexGrid_AutoSize"
'**************************************
' Name: Auto resize flexgrid column widths
' Description:Automatically resize the columns in any flex grid to give a nice, professional appearance.
' Public sub automatically resizes MS Flex Grid columns to match the width of the text, no matter the size of the grid or the number of columns.
' Reads first n number of rows of data, and adjusts column size to match the widest cell of text. Will even expand columns proportionately if they aren't wide enough to fill out the entire width of the grid. Configurable constraints allow you to designate
' 1) Any flex grid to resize
' 2) Maximum column width
' 3) the maximum number of rows in depth to look for the widest cell of text.
' By: Jonathan W. Lartigue (from psc cd)
'
' Inputs:msFG (MSFlexGrid) = The name of the flex grid to resize .... MaxRowsToParse (integer) = The maximum number of rows (depth) of the table to scan for cell width (e.g. 50) .... MaxColWidth (Integer) = The maximum width of any given cell in twips (e.g. 5000)
'
' Assumes:Simply drop this public sub into your form or module and access it from anywhere in your program to automatically resize any flex grid.
'**************************************

Public Sub AutosizeGridColumns(ByRef msFG As MSFlexGrid, _
                               ByVal startCol As Integer, _
                               ByVal maxCol As Integer)
    Dim i, j As Integer
    Dim txtString As String
    Dim intTempWidth, BiggestWidth As Integer
    Dim intRows As Integer
    
    Const intPixelCaracter = 115
    Const intPadding = 20
    
    With msFG
        ' Loops through every column
        For i = startCol To maxCol
            
            ' If there are more rows of data, reset
            ' intRows to the MaxRowsToParse constant
'            If intRows > MaxRowsToParse Then intRows = MaxRowsToParse
         
            ' Reset some values to 0
            intBiggestWidth = 0
            
            ' check up to MaxRowsToParse # of rows and obtain
            ' the greatest width of the cell contents
            For j = 0 To .Rows - 1
            
                ' The intPadding constant compensates for text insets
                ' You can adjust this value above as desired.
                txtString = .TextMatrix(j, i)
                intTempWidth = (Len(txtString) * intPixelCaracter) + intPadding
                If intTempWidth < 500 Then intTempWidth = 500
                
                ' Reset intBiggestWidth to the intMaxColWidth value if necessary
                If intTempWidth > intBiggestWidth Then intBiggestWidth = intTempWidth
         
            Next j
        
            .ColWidth(i) = intBiggestWidth
         Next i
         
         ' Now check to see if the columns aren't as wide as the grid itself.
         ' If not, determine the difference and expand each column proportionately
         ' to fill the grid
'         intTempWidth = 0
         
'         For I = 0 To .Cols - 1
'            intTempWidth = intTempWidth + .ColWidth(I)
        
            ' Add up the width of all the columns
'         Next I
         
'         If intTempWidth < msFG.Width Then
            ' Compate the width of the columns to the width of the grid control
            ' and if necessary expand the columns.
'            intTempWidth = Fix((msFG.Width - intTempWidth) / .Cols)
            ' Determine the amount od width expansion needed by each column
'            For I = 0 To .Cols - 1
'                .ColWidth(I) = .ColWidth(I) + intTempWidth
                ' add the necessary width to each column
'            Next I
'         End If
    End With
End Sub
Attribute VB_Name = "Fun|fffd||fffd|es"
Option Explicit

Public Sub Conecta_Banco()
    On Error GoTo trataErro
    
    Dim Banco As String
    Dim senha As String
    
    Banco = [cBanco]
    senha = [nSenha]
    
    Set con = New ADODB.Connection
    With con
        .Provider = "Microsoft.ACE.OLEDB.12.0"
        .ConnectionString = "Data Source=" & Banco & "; Jet OLEDB:DataBase Password=" & senha
'        .ConnectionString = "Data Source=" & Banco
        .mode = adModeReadWrite
        .Open
    End With
    
    Exit Sub
    
trataErro:
    MsgBox ("Error : " & err.Description)
    Set con = Nothing
    
End Sub

Function Somente_Numeros(ByVal KeyAscii As Integer, ByVal temdecimal As Boolean, ByVal TemZero As Boolean) As Boolean
    Dim strValidos As String
    
    If temdecimal Then
        If TemZero Then
            strValidos = "0123456789.-"
        Else
            strValidos = "123456789.-"
        End If
    End If
    If Not temdecimal Then
        If TemZero Then
            strValidos = "0123456789-"
        Else
            strValidos = "123456789-"
        End If
    End If
    
    If KeyAscii = 44 Then KeyAscii = 46
    
    If InStr(strValidos, Chr(KeyAscii)) = 0 Then
        Somente_Numeros = False
    Else
        Somente_Numeros = True
    End If
End Function

Function Pega_Valor(texto As String) As Variant
    If Application.International(xlDecimalSeparator) = "." Then
        texto = Replace(texto, ",", "")
    Else
        texto = Replace(texto, ".", "")
        texto = Replace(texto, ",", ".")
    End If
    
    Pega_Valor = Val(texto)
End Function

Public Sub Exportar(lv As MSFlexGrid)
    Dim Book                As Workbook
    Dim sht                 As Worksheet
    Dim lin                 As Integer
    Dim col                 As Integer
    Dim Intervalo           As String
    Dim retorno             As Integer
    Dim arquivo             As String
    Dim proxLin             As Integer
    
    If lv.Rows <= 1 Then Exit Sub
    
    Application.FileDialog(msoFileDialogSaveAs).InitialFileName = lv.Name & "_" & Format(Now(), "dd_mmm_yy") & ".xls"
    retorno = Application.FileDialog(msoFileDialogSaveAs).Show
    If retorno = 0 Then Exit Sub
    arquivo = Application.FileDialog(msoFileDialogSaveAs).SelectedItems(1)
    
    Set Book = Workbooks.Add
    Set sht = Book.Sheets(1)
    
    sht.Name = lv.Name
       
    With lv
        Application.DisplayAlerts = False
        
        ' Cabe|fffd|alho
        For col = 1 To .Cols
            sht.Cells(1, col) = .TextMatrix(0, col - 1)
            
            sht.Cells(1, col).HorizontalAlignment = xlCenter
            sht.Cells(1, col).VerticalAlignment = xlCenter
            sht.Cells(1, col).font.Bold = True
            sht.Cells(1, col).Interior.color = RGB(221, 235, 247)
        Next col
        
        sht.Range("A2").Select
        ActiveWindow.FreezePanes = True
        
        proxLin = 1
        
        For lin = 1 To .Rows - 1
            If .RowHeight(lin) > 0 Then
                proxLin = proxLin + 1
                For col = 1 To .Cols
                    If .ColAlignment(col - 1) = 7 Then
                        If .TextMatrix(lin, col - 1) = "" Then
                            sht.Cells(proxLin, col) = ""
                        ElseIf IsNumeric(.TextMatrix(lin, col - 1)) Then
                            sht.Cells(proxLin, col) = Pega_Valor(.TextMatrix(lin, col - 1))
                        Else
                            sht.Cells(proxLin, col) = IIf(.TextMatrix(lin, col - 1) = "q", "false", IIf(.TextMatrix(lin, col - 1) = "|fffd|", "true", .TextMatrix(lin, col - 1)))
                        End If
                    ElseIf .ColAlignment(col - 1) = 4 And InStr(.TextMatrix(lin, col - 1), "/") > 0 Then
                        sht.Cells(proxLin, col) = CDate(.TextMatrix(lin, col - 1))
                        sht.Cells(proxLin, col).NumberFormat = "dd/mmm/yyyy"
                    Else
                        sht.Cells(proxLin, col) = .TextMatrix(lin, col - 1)
                        sht.Cells(proxLin, col).NumberFormat = "@"
                    End If
                    .Row = lin
                    .col = col - 1
                    If .CellBackColor > 0 Then
                        sht.Cells(proxLin, col).Interior.color = .CellBackColor
                        sht.Cells(proxLin, col).font.color = .CellForeColor
                    End If
                Next col
            End If
        Next lin
        
        Intervalo = "A:" & Mid(Cells(1, .Cols).Address, 2, InStr(2, Cells(1, .Cols).Address, "$") - 2)
        Columns(Intervalo).EntireColumn.AutoFit
        
        sht.Range("A1").Select
        
        If lv.Name = "Lista_Mapa" Then
            With sht.Sort
                .SortFields.Clear
                .SortFields.Add Key:=Range("Z2:Z" & CStr(proxLin)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
                .SortFields.Add Key:=Range("Y2:Y" & CStr(proxLin)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
                .SetRange Range("A1:AE" & CStr(proxLin))
                .Header = xlYes
                .MatchCase = False
                .Orientation = xlTopToBottom
                .SortMethod = xlPinYin
                .Apply
            End With
        End If
        
    End With
        
'    sht.Select
    
    Book.Close SaveChanges:=True, Filename:=arquivo
    
    Application.DisplayAlerts = True
   
    Set Book = Nothing
    Set sht = Nothing
End Sub

Function Localizar_Arquivo() As String
    Dim importFileName As Variant
    
    importFileName = Application.GetOpenFilename(FileFilter:="Arquivo do Excel (*.xls; *.xlsx), *.xls;*.xlsx", Title:="Escolha um arquivo do Excel")
    
    If importFileName = False Then importFileName = ""
    
    Localizar_Arquivo = importFileName
    
End Function

Function Pega_Safra() As String
    Dim rs As ADODB.Recordset
    
    Set rs = New ADODB.Recordset
    
    rs.Open "SELECT * FROM tab_parametro", con
    Pega_Safra = rs("SafraAtual")
    
    rs.Close
    Set rs = Nothing
End Function

Function Pega_BufferPadrao() As String
    Dim rs As ADODB.Recordset
    
    Set rs = New ADODB.Recordset
    
    rs.Open "SELECT M.Pedigree " & _
            "FROM tab_parametro AS P " & _
            "INNER JOIN tab_material as M ON M.ID_Material = P.BufferPadrao", con
    Pega_BufferPadrao = rs("Pedigree")
    
    rs.Close
    Set rs = Nothing
End Function

Function Pega_Margem() As String
    Dim rs As ADODB.Recordset
    
    Set rs = New ADODB.Recordset
    
    rs.Open "SELECT * FROM tab_parametro", con
    Pega_Margem = rs("MargemSeguranca")
    
    rs.Close
    Set rs = Nothing
End Function

Public Sub frame_transparent(cadre As Frame, f As UserForm, imaj As Image)
  cadre.BorderStyle = 0
  cadre.ZOrder 'peut |fffd|tre supprim|fffd| si inconnu sous VBA
  cadre.BackColor = f.BackColor
  imaj.ZOrder 1 'peut |fffd|tre supprim|fffd| si inconnu sous VBA
  imaj.Picture = f.Picture
  imaj.Move -cadre.Left, -cadre.Top
End Sub

Public Sub Atualiza_Shape(nomeShap As String, texto As String, Conteudo As String)
    Dim SH As Shape
    
    For Each SH In ActiveSheet.Shapes
        If SH.Name = nomeShap Then
'            If SH.Type = 7 Then
'                Set ss = SH.OLEFormat.Object.Object
'                ss.text = Conteudo
'                Set ss = Nothing
'            Else
                SH.TextFrame2.TextRange.Text = texto & Conteudo
'            End If
            Exit For
        End If
    Next
End Sub

Function So_TemNumero(texto As String) As Boolean
    Dim cont As Integer
    
    So_TemNumero = True
    
    For cont = 1 To Len(texto)
        Select Case Mid(texto, cont, 1)
            Case 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, ".", ","
            Case Else
                So_TemNumero = False
        End Select
    Next cont
    
End Function
Attribute VB_Name = "Maximizar_Minimizar_Form"
Option Explicit

Declare Function SetWindowLong Lib "user32.dll" Alias "SetWindowLongA" ( _
    ByVal hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
    
Declare Function FindWindow Lib "user32" Alias "FindWindowA" ( _
    ByVal lpClassName As String, ByVal lpWindowName As String) As Long
    
Declare Function ShowWindow Lib "user32" (ByVal hwnd As Long, ByVal nCmdShow As Long) As Long
    
Const SW_SHDWNORMAL = 1
Const SW_SHOWMINIMIZED = 2
Const SW_SHOWMAXIMIZED = 3

Sub AtivarBotoesMinMax(objForm As Object)
    Dim hwnd As Long
    
    Const WS_SYSMENU As Long = &H84C80080
    Const WS_MINIMIZEBOX As Long = &H20000
    Const WS_MAXIMIZEBOX As Long = &H10000
        
    hwnd = FindWindow(vbNullString, objForm.Caption)
    SetWindowLong hwnd, -16, WS_SYSMENU Or WS_MINIMIZEBOX Or WS_MAXIMIZEBOX
    
End Sub

Sub Maximizar(objForm As Object)
    ShowWindow FindWindow(vbNullString, objForm.Caption), SW_SHOWMAXIMIZED
End Sub

Sub Centralizar(objForm As Object)
    objForm.Top = (Application.Height - objForm.Height) / 2
    objForm.Left = (Application.Width - objForm.Width) / 2
End Sub
Attribute VB_Name = "MenusSuspensos"
Option Explicit

Public The_Menu As CommandBar

Function CreatePopUp_MenuCadastro() As CommandBar
    Const pop_up_menu_name = "Pop-up Menu"
    
    Dim the_command_bar As CommandBar
    Dim the_command_bar_control As CommandBarControl
    Dim menu_item As CommandBar
    
    Dim cont As Integer
    
    For Each menu_item In CommandBars
        If menu_item.Name = pop_up_menu_name Then
            CommandBars(pop_up_menu_name).Delete
        End If
    Next
    
    Set the_command_bar = CommandBars.Add(Name:=pop_up_menu_name, Position:=msoBarPopup, MenuBar:=False, Temporary:=False)
    
    Set the_command_bar_control = the_command_bar.Controls.Add(msoControlButton)
    With the_command_bar_control
        .Caption = "Par|fffd|metros"
        .Picture = form_menu.ImageList1.ListImages(2).Picture
        .OnAction = "MenuCadastro_Opcoes"
        .Parameter = "form_parametro"
        .Enabled = rsUserLogado(.Parameter)
    End With
    
    Set the_command_bar_control = the_command_bar.Controls.Add(msoControlButton)
    With the_command_bar_control
        .Caption = "Programas"
        .Picture = form_menu.ImageList1.ListImages(3).Picture
        .OnAction = "MenuCadastro_Opcoes"
        .Parameter = "form_programa"
        .Enabled = rsUserLogado(.Parameter)
    End With
    
    Set the_command_bar_control = the_command_bar.Controls.Add(msoControlButton)
    With the_command_bar_control
        .Caption = "Protocolos"
        .Picture = form_menu.ImageList1.ListImages(4).Picture
        .OnAction = "MenuCadastro_Opcoes"
        .Parameter = "form_protocolo"
        .Enabled = rsUserLogado(.Parameter)
    End With
    
    Set CreatePopUp_MenuCadastro = the_command_bar
End Function

Sub MenuCadastro_Opcoes()
    Dim frm As Object
    
    Set frm = UserForms.Add(CommandBars.ActionControl.Parameter)
    frm.Show
    
End Sub

Function CreatePopUp_Programas(lin As Integer) As CommandBar
    Const pop_up_menu_name = "Pop-up Menu"
    
    Dim the_command_bar As CommandBar
    Dim the_command_bar_control As CommandBarControl
    Dim menu_item As CommandBar
    
    Dim cont As Integer
    Dim rs As ADODB.Recordset
    
    For Each menu_item In CommandBars
        If menu_item.Name = pop_up_menu_name Then
            CommandBars(pop_up_menu_name).Delete
        End If
    Next
    
    Set the_command_bar = CommandBars.Add(Name:=pop_up_menu_name, Position:=msoBarPopup, MenuBar:=False, Temporary:=False)
    
    Set rs = New ADODB.Recordset
    rs.Open "SELECT ID_Programa & '/' & CodigoPrograma as Programa FROM tab_Programa ORDER BY CodigoPrograma", con
    
    While Not rs.EOF
        Set the_command_bar_control = the_command_bar.Controls.Add(msoControlButton)
        With the_command_bar_control
            .Caption = rs("Programa")
            .OnAction = "MenuPrograma_Opcoes"
            .Parameter = CStr(lin) & "/" & rs("Programa")
        End With
        
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
    
    Set CreatePopUp_Programas = the_command_bar
End Function

Sub MenuPrograma_Opcoes()
    Dim param() As String
    Dim lin As Integer
    
    param() = Split(CommandBars.ActionControl.Parameter, "/")
    
    lin = param(0)
    
    form_material.Programas.TextMatrix(lin, 0) = param(1)
    form_material.Programas.TextMatrix(lin, 1) = param(2)
    
End Sub
Attribute VB_Name = "Sheet1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet2"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet3"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet4"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet5"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "ThisWorkbook"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Private Sub Workbook_Open()
    form_login.Show
End Sub
Attribute VB_Name = "VariaveisGlobais"
Global con              As ADODB.Connection
Global usuario          As String
Global formAtual        As Object
Global rsUserLogado     As ADODB.Recordset
Global CorFundoTela     As OLE_COLOR
Global DataCalendario   As Date

Global filtrarS         As String
Global filtrarG         As String
Global filtrarL         As String
Global filtrarR         As String
Attribute VB_Name = "form_balancomassa"
Attribute VB_Base = "0{C837D095-7BC1-4613-ACE4-E19919222099}{38F2038B-C680-494F-A7D0-2C3DCCAAD08C}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim MaterialRow As Long
Dim MaterialCol As Integer
Dim BalancoRow As Long
Dim BalancoCol As Integer
Dim SafraAtual As String
Dim inicio As Boolean
Dim Processa As Boolean

Private Sub btnExportar_Click()
    If Lista_Balanco.Rows > 1 Then
        Exportar Lista_Balanco
    End If
End Sub

Private Sub chkFiltrarReg_Click()
    If Not Processa Then Exit Sub
    
    If chkFiltrarReg Then
        Processa = False
        chkFiltrarTodos = False
        Processa = True
    End If
    
    Monta_Lista_Materiais
End Sub

Private Sub chkFiltrarSts_Click()
    If Not Processa Then Exit Sub
    
    If chkFiltrarSts Then
        Processa = False
        chkFiltrarTodos = False
        Processa = True
    End If
    Monta_Lista_Materiais
End Sub

Private Sub chkFiltrarTodos_Click()
    If Not Processa Then Exit Sub
    
    If chkFiltrarTodos Then
        Processa = False
        chkFiltrarReg = False
        chkFiltrarSts = False
        Processa = True
        Monta_Lista_Materiais
    End If
End Sub

Private Sub edtAte_DblClick(ByVal Cancel As MSForms.ReturnBoolean)
    edtAte_Enter
End Sub

Private Sub edtAte_Enter()
    DataCalendario = DateValue(edtAte.Text)
        
    CalendarFrm.Show
        
    edtAte.Text = Format(DataCalendario, "dd/mmm/yyyy")
    
    Application.Cursor = xlDefault
End Sub

Private Sub edtDe_DblClick(ByVal Cancel As MSForms.ReturnBoolean)
    edtDe_Enter
End Sub

Private Sub edtDe_Enter()
    If Not inicio Then
        DataCalendario = DateValue(edtDe.Text)
            
        CalendarFrm.Show
            
        edtDe.Text = Format(DataCalendario, "dd/mmm/yyyy")
        
        Application.Cursor = xlDefault
    End If
    inicio = False
End Sub

Private Sub edtFindMaterial_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    If KeyCode = vbKeyReturn Then
        Monta_Lista_Materiais
    End If
End Sub

Private Sub Lista_Balanco_Click()
    Dim lin As Long
    
    If BalancoRow > 0 Then
        If BalancoCol = 0 Then
            With Lista_Balanco
                If .TextMatrix(BalancoRow, BalancoCol) = "+" Or .TextMatrix(BalancoRow, BalancoCol) = "-" Then
                    For lin = BalancoRow + 1 To .Rows - 1
                        If .TextMatrix(lin, 0) = "" Then
                            If .TextMatrix(BalancoRow, BalancoCol) = "+" Then
                                .RowHeight(lin) = 240
                            Else
                                .RowHeight(lin) = 0
                            End If
                        Else
                            Exit For
                        End If
                    Next lin
                    If .TextMatrix(BalancoRow, BalancoCol) = "+" Then
                        .TextMatrix(BalancoRow, BalancoCol) = "-"
                    Else
                        .TextMatrix(BalancoRow, BalancoCol) = "+"
                    End If
                End If
            End With
        End If
    End If
End Sub

Private Sub Lista_Balanco_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    BalancoRow = Lista_Balanco.MouseRow
    BalancoCol = Lista_Balanco.MouseCol
End Sub

Private Sub Lista_Material_Click()
    Dim lin As Long
    
    If MaterialRow > 0 Then
        If MaterialCol = 0 Then
            With Lista_Material
                If .TextMatrix(MaterialRow, MaterialCol) = "q" Then
                    .TextMatrix(MaterialRow, MaterialCol) = "|fffd|"
                    Monta_Balanco
                Else
                    .TextMatrix(MaterialRow, MaterialCol) = "q"
                    Exclui_Balanco
                End If
            End With
        End If
    End If
End Sub

Private Sub Lista_Material_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    MaterialRow = Lista_Material.MouseRow
    MaterialCol = Lista_Material.MouseCol
End Sub

Private Sub UserForm_Initialize()
    Dim col As Integer
    
    If con Is Nothing Then Conecta_Banco
'     usuario = "ROBSO"
'    CorFundoTela = RGB(229, 239, 218)
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    Frame1.BackColor = CorFundoTela
    Frame2.BackColor = CorFundoTela
    
    SafraAtual = Pega_Safra
    
    If Right(SafraAtual, 2) = "03" Then
        edtDe.Value = Format(DateValue("01/11/" & Left(SafraAtual, 4)), "dd/mmm/yyyy")
    Else
        edtDe.Value = Format(DateValue("01/05/" & Left(SafraAtual, 4)), "dd/mmm/yyyy")
    End If
    edtAte.Value = Format(DateAdd("m", 5, edtDe.Value) - 1, "dd/mmm/yyyy")
    
    Call Centralizar(Me)
    
    With Lista_Material
        .Clear
        .Rows = 1
        .Cols = 4
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = ""
        .TextMatrix(0, 2) = "Material"
        .TextMatrix(0, 3) = "Lote"
        
        For col = 0 To .Cols - 1
            .FixedAlignment(col) = 4
            .ColWidth(col) = 0
            .ColAlignment(col) = 1
        Next col
        .ColWidth(0) = 300
        .ColAlignment(0) = 4
        
        .FixedCols = 0
    End With
    
    With Lista_Balanco
        .Clear
        .Rows = 1
        .Cols = 7
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .MergeCells = flexMergeRestrictRows
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Material"
        .TextMatrix(0, 2) = "Data"
        .TextMatrix(0, 3) = "Tipo"
        .TextMatrix(0, 4) = "Movimenta|fffd||fffd|o"
        .TextMatrix(0, 5) = "Saldo"
        .TextMatrix(0, 6) = "ID_Material"
        For col = 0 To .Cols - 1
            .FixedAlignment(col) = 4
            .ColWidth(col) = 0
        Next col
        .ColWidth(0) = 300
        .ColAlignment(0) = 4
        .ColAlignment(1) = 1
        .ColAlignment(2) = 4
        .ColAlignment(3) = 1
        .ColAlignment(4) = 7
        .ColAlignment(5) = 7
        .ColAlignment(6) = 7
        
        .FixedCols = 0
    End With
    
    Monta_Lista_Materiais
    
    AutosizeGridColumns Lista_Balanco, 1, 5
    
    inicio = True
    Processa = True
    
End Sub

Private Sub Monta_Lista_Materiais()
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim filtro As String
    
    filtro = ""
    If Not chkFiltrarTodos And Not chkFiltrarReg And Not chkFiltrarSts Then
        filtro = "M.Regulatorio = false and M.StewardShip = false"
    Else
        If chkFiltrarReg And chkFiltrarSts Then
            filtro = "(M.Regulatorio = true or M.StewardShip = true)"
        Else
            If chkFiltrarReg And Not chkFiltrarSts Then
                filtro = "M.Regulatorio = true"
            Else
                If Not chkFiltrarReg And chkFiltrarSts Then
                    filtro = "M.StewardShip = true"
                End If
            End If
        End If
    End If
    
    sql = "SELECT * FROM tab_material AS M "
    
    If edtFindMaterial <> "" Then sql = sql & "WHERE M.Pedigree LIKE '" & edtFindMaterial & "%' "
    If filtro <> "" Then
        If edtFindMaterial <> "" Then
            sql = sql & "and "
        Else
            sql = sql & "WHERE "
        End If
        sql = sql & filtro
    End If
    
    sql = sql & " ORDER BY Pedigree"
    
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    With Lista_Material
        .Rows = 1
        .Visible = False
        
        While Not rs.EOF
            .Rows = .Rows + 1
            
            .Row = .Rows - 1
            .col = 0
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            .Text = "q"
            
            .TextMatrix(.Rows - 1, 1) = rs("ID_Material")
            .TextMatrix(.Rows - 1, 2) = rs("Pedigree")
            .TextMatrix(.Rows - 1, 3) = rs("Lote")
            
            rs.MoveNext
        Wend
        
        .Visible = True
    End With
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Lista_Material, 2, 3
End Sub

Private Sub Monta_Balanco()
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim saldo As Double
    Dim col As Integer
    Dim Cor As Boolean
    Dim filtro As String
    
'    Lista_Balanco.Rows = 1
    
    filtro = ""
    If Not chkFiltrarTodos And Not chkFiltrarReg And Not chkFiltrarSts Then
        filtro = " and M.Regulatorio = false and M.StewardShip = false"
    Else
        If chkFiltrarReg And chkFiltrarSts Then
            filtro = " and (M.Regulatorio = true or M.StewardShip = true)"
        Else
            If chkFiltrarReg And Not chkFiltrarSts Then
                filtro = " and M.Regulatorio = true"
            Else
                If Not chkFiltrarReg And chkFiltrarSts Then
                    filtro = "M.StewardShip = true"
                End If
            End If
        End If
    End If
    
    'PEGA SALDO INICIAL
    sql = "SELECT SUM(MM.QtdeMovimentacao) as Saldo " & _
          "FROM tab_materialmovimentacao as MM " & _
          "INNER JOIN tab_material as M on M.ID_Material = MM.ID_Material " & _
          "WHERE MM.ID_Material = " & Lista_Material.TextMatrix(MaterialRow, 1) & " and " & _
                "MM.DataMovimentacao < #" & Format(edtDe.Value, "yyyy/mm/dd") & "#" & _
                filtro
    
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    saldo = IIf(IsNull(rs("Saldo")), 0, rs("Saldo"))
    rs.Close
    Set rs = Nothing
    
    With Lista_Balanco
        
        .Rows = .Rows + 1
        
        .TextMatrix(.Rows - 1, 0) = ""
        .TextMatrix(.Rows - 1, 1) = Lista_Material.TextMatrix(MaterialRow, 2) & " (" & Lista_Material.TextMatrix(MaterialRow, 3) & ")"
        .TextMatrix(.Rows - 1, 2) = ""
        .TextMatrix(.Rows - 1, 3) = ""
        .TextMatrix(.Rows - 1, 4) = ""
        .TextMatrix(.Rows - 1, 5) = Format(saldo, "#,##0")
        .TextMatrix(.Rows - 1, 6) = Lista_Material.TextMatrix(MaterialRow, 1)
        
        .Row = .Rows - 1
        For col = 0 To .Cols - 1
            .col = col
            .CellFontBold = True
            .CellBackColor = RGB(242, 242, 242)
        Next col
        
        .col = 5
        If saldo < 0 Then
            .CellForeColor = RGB(255, 0, 0)
        Else
            .CellForeColor = RGB(0, 0, 0)
        End If
        
    End With
    
    'PEGA MOVIMENTA|fffd||fffd|O
    sql = "SELECT * " & _
          "FROM tab_materialmovimentacao " & _
          "WHERE ID_Material = " & Lista_Material.TextMatrix(MaterialRow, 1) & " and " & _
                "(DataMovimentacao >= #" & Format(edtDe.Value, "yyyy/mm/dd") & "# and " & _
                "DataMovimentacao <= #" & Format(edtAte.Value, "yyyy/mm/dd") & "#)" & _
                filtro
    
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    If Not rs.EOF Then
        'Acrescenta o icone de explos|fffd|o no |fffd|ltimo item
        Lista_Balanco.TextMatrix(Lista_Balanco.Rows - 1, 0) = "+"
    End If
    
    With Lista_Balanco
        Cor = False
        While Not rs.EOF
            saldo = saldo + rs("QtdeMovimentacao")
            .Rows = .Rows + 1
            
            .RowHeight(.Rows - 1) = 0
            
            .TextMatrix(.Rows - 1, 0) = ""
            .TextMatrix(.Rows - 1, 1) = ""
            .TextMatrix(.Rows - 1, 2) = Format(rs("DataMovimentacao"), "dd/mm/yyyy")
            .TextMatrix(.Rows - 1, 3) = rs("TipoMovimentacao")
            .TextMatrix(.Rows - 1, 4) = Format(rs("QtdeMovimentacao"), "#,##0")
            .TextMatrix(.Rows - 1, 5) = Format(saldo, "#,##0")
            .TextMatrix(.Rows - 1, 6) = Lista_Material.TextMatrix(MaterialRow, 1)
            
            .Row = .Rows - 1
            
            If Cor Then
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = RGB(221, 235, 247)
                Next col
            End If
            
            Cor = Not Cor
            
            .col = 4
            If rs("QtdeMovimentacao") < 0 Then
                .CellForeColor = RGB(255, 0, 0)
            Else
                .CellForeColor = RGB(0, 0, 0)
            End If
            
            .col = 5
            If saldo < 0 Then
                .CellForeColor = RGB(255, 0, 0)
            Else
                .CellForeColor = RGB(0, 0, 0)
            End If
            
            rs.MoveNext
        Wend
        
        Pega_Movimentacao_Localidade Lista_Material.TextMatrix(MaterialRow, 1), filtro
    End With
    
    rs.Close
    Set rs = Nothing
    
    'MOSTRA SALDO FINAL
    With Lista_Balanco
        .Rows = .Rows + 1
        
        .MergeRow(.Rows - 1) = True
        
        .TextMatrix(.Rows - 1, 0) = "Saldo do Per|fffd|odo"
        .TextMatrix(.Rows - 1, 1) = "Saldo do Per|fffd|odo"
        .TextMatrix(.Rows - 1, 2) = "Saldo do Per|fffd|odo"
        .TextMatrix(.Rows - 1, 3) = "Saldo do Per|fffd|odo"
        .TextMatrix(.Rows - 1, 4) = "Saldo do Per|fffd|odo"
        .TextMatrix(.Rows - 1, 5) = Format(saldo, "#,##0")
        .TextMatrix(.Rows - 1, 6) = Lista_Material.TextMatrix(MaterialRow, 1)
        
        .Row = .Rows - 1
        For col = 0 To .Cols - 1
            .col = col
            .CellBackColor = RGB(242, 242, 242)
        Next col
        
        .col = 5
        If saldo < 0 Then
            .CellForeColor = RGB(255, 0, 0)
        Else
            .CellForeColor = RGB(0, 0, 0)
        End If
        
        .Row = .Rows - 1
        For col = 0 To .Cols - 1
            .col = col
            .CellFontBold = True
        Next col
    End With

'    Pega_Movimentacao_Localidade 0, filtro
    
    AutosizeGridColumns Lista_Balanco, 1, 5
End Sub

Private Sub Pega_Movimentacao_Localidade(idMaterial As Long, filtro As String)
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim col As Integer
    Dim Cor As Boolean
    
    sql = "SELECT F.[Loc], Sum(F.[Seeds/Packet] * P.[QtdeSaqParcela]) as Qtde " & _
          "FROM ((tab_fieldbook as F " & _
          "INNER JOIN tab_protocolo as P ON P.[Set] = F.[Set]) " & _
          "INNER JOIN tab_material as M ON M.[ID_Material] = F.[ID_Material]) " & _
          "WHERE F.[Season] ='" & SafraAtual & "' AND " & _
                "F.[CheckSorteio] = true AND " & _
                "(F.[DataCheckSorteio] >= #" & Format(edtDe.Value, "yyyy/mm/dd") & "# AND " & _
                "F.[DataCheckSorteio] <= #" & Format(edtAte.Value, "yyyy/mm/dd") & "#)" & _
                filtro
    If idMaterial <> 0 Then
        sql = sql & " AND F.[ID_Material] = " & idMaterial
    End If
    sql = sql & " GROUP BY F.[Loc]"
    
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    With Lista_Balanco
        If Not rs.EOF Then
            .Rows = .Rows + 1
            
        
            .MergeRow(.Rows - 1) = True
            .RowHeight(.Rows - 1) = 0
            .TextMatrix(.Rows - 1, 0) = ""
            .TextMatrix(.Rows - 1, 1) = "Balan|fffd|o por Localidade"
            .TextMatrix(.Rows - 1, 2) = "Balan|fffd|o por Localidade"
            .TextMatrix(.Rows - 1, 3) = "Balan|fffd|o por Localidade"
            .TextMatrix(.Rows - 1, 4) = "Balan|fffd|o por Localidade"
            .TextMatrix(.Rows - 1, 5) = "Balan|fffd|o por Localidade"
            .TextMatrix(.Rows - 1, 5) = idMaterial
            
            .Row = .Rows - 1
            
            For col = 0 To .Cols - 1
                .col = col
                .CellBackColor = RGB(192, 192, 192)
                .CellFontBold = True
                .CellAlignment = 4
            Next col
        End If
        
        Cor = False
        
        While Not rs.EOF
            .Rows = .Rows + 1
            
            .RowHeight(.Rows - 1) = 0
            
            .TextMatrix(.Rows - 1, 0) = ""
            .TextMatrix(.Rows - 1, 1) = rs("Loc")
            .TextMatrix(.Rows - 1, 2) = ""
            .TextMatrix(.Rows - 1, 3) = ""
            .TextMatrix(.Rows - 1, 4) = Format(rs("Qtde"), "#,##0")
            .TextMatrix(.Rows - 1, 5) = ""
            .TextMatrix(.Rows - 1, 6) = idMaterial
            
            .Row = .Rows - 1
            
            If Cor Then
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = RGB(221, 235, 247)
                Next col
            End If
            
            Cor = Not Cor
        
            rs.MoveNext
        Wend
    End With
    
    rs.Close
    Set rs = Nothing
End Sub

Private Sub Exclui_Balanco()
    Dim lin As Long
    Dim lin1 As Long
    
    With Lista_Balanco
        For lin = .Rows - 1 To 1 Step -1
            If .TextMatrix(lin, 6) = Lista_Material.TextMatrix(MaterialRow, 1) Then
                If .Rows = 2 Then
                    .Rows = 1
                Else
                    .RemoveItem (lin)
                End If
            End If
        Next lin
    End With

End Sub
Attribute VB_Name = "form_balancomateriais"
Attribute VB_Base = "0{C75D794D-45BF-4523-A7EF-FDB464C097D0}{F3DFCB8F-890B-4273-83C3-EF1F876728F5}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Private Sub btnFindArquivo_Click()
    Dim arquivo
    
    arquivo = Localizar_Arquivo
    If arquivo = "" Then Exit Sub
    
    edtArquivo = arquivo
End Sub

Private Sub btnImportar_Click()
    If edtArquivo = "" Then Exit Sub
    
    Importar
End Sub

Private Sub UserForm_Initialize()
    If con Is Nothing Then Conecta_Banco
'    CorFundoTela = RGB(229, 239, 218)
    
    Me.BackColor = CorFundoTela
    
    ProgressBar1.Max = 100
    ProgressBar1.min = 0
    ProgressBar1.Value = 0
    
    LPerc.Caption = "0%"
    
    Call Centralizar(Me)
    
End Sub

Private Sub Importar()
    Dim arquivo             As String
    Dim wb                  As Workbook
    Dim SH                  As Worksheet
    Dim lin                 As Long
    Dim col                 As Integer
    Dim totLin              As Long
    Dim totCol              As Integer
    Dim rs                  As ADODB.Recordset
    Dim sql                 As String
    Dim qtdeSem             As Long
    
    Dim colInvBID           As Integer
    Dim colQtdeSem          As Integer
    
    Dim idMaterial          As Long
    
    Dim LinErro             As String
    
    arquivo = edtArquivo
    
    Set wb = Workbooks.Open(arquivo, False, False)
    Set SH = wb.Worksheets(1)
    
    With SH
        .Activate
        .Range("a1").Select
        ActiveCell.SpecialCells(xlLastCell).Select
        totLin = Selection.Row
        totCol = Selection.Column
        .Range("A1").Select
    End With
    
    If totLin = 1 Then GoTo fim
    
    ThisWorkbook.Activate
    
    colInvBID = 0
    colQtdeSem = 0
    
    For col = 1 To totCol
        With SH
            If .Cells(1, col) = "Inv BID" Then colInvBID = col
            If .Cells(1, col) = "Qtde Sementes" Then colQtdeSem = col
        End With
    Next col
    
    If colInvBID = 0 Or colQtdeSem = 0 Then
       MsgBox "Uma ou mais das colunas abaixo listadas n|fffd|o foram encontradas." & vbNewLine & _
              "Verifique a existencia de todas as colunas e se elas n|fffd|o contem espa|fffd|os a mais em seus nomes." & vbNewLine & _
              vbTab & "Inv BID" & vbNewLine & _
              vbTab & "Qtde Sementes", vbInformation, "Importa|fffd||fffd|o"
        GoTo fim
    End If
    
    ProgressBar1.Max = totLin
    ProgressBar1.min = 0
    ProgressBar1.Value = 0
    LPerc.Caption = "0%"
    
    ProgressBar1.Visible = True
    LPerc.Visible = True
    
    DoEvents
    
    LinErro = ""
    
    For lin = 2 To totLin
        
        ProgressBar1.Value = lin
        LPerc.Caption = Format(lin / totLin, "0%")
        
        DoEvents
        
        With SH
            If .Cells(lin, colInvBID) <> "" Then
                Set rs = New ADODB.Recordset
                    
                sql = "SELECT * FROM tab_materialprograma WHERE InvBID= '" & .Cells(lin, colInvBID) & "'"
                        
                rs.Open sql, con
                If rs.EOF Then
                    If LinErro <> "" Then LinErro = LinErro & vbNewLine
                    LinErro = LinErro & vbTab & "Linha: " & CStr(lin) & " / Inv BID: " & .Cells(lin, colInvBID)
                Else
                    idMaterial = rs("ID_Material")
                End If
                rs.Close
                
                If idMaterial > 0 Then
                    sql = "SELECT SUM(QtdeMovimentacao) as Saldo " & _
                          "FROM tab_materialmovimentacao " & _
                          "WHERE ID_Material=" & idMaterial
                        
                    rs.Open sql, con
                    If rs.EOF Then
                        qtdeSem = 0
                    Else
                        qtdeSem = IIf(IsNull(rs("Saldo")), 0, rs("Saldo"))
                    End If
                    rs.Close
                    
                    qtdeSem = .Cells(lin, colQtdeSem) - qtdeSem
                    
                    If qtdeSem <> 0 Then
                        sql = "INSERT INTO tab_materialmovimentacao VALUES (" & idMaterial & ",#" & Format(Date, "yyyy/mm/dd") & "#,#" & Format(Now, "hh:mm:ss") & "#,'Balanco'," & qtdeSem & ")"
                        con.Execute sql
                    End If
                End If
            End If
        End With
    Next lin

fim:
    Set SH = Nothing
    wb.Close SaveChanges:=False
    Set wb = Nothing
    
    ProgressBar1.Visible = False
    LPerc.Visible = False
    
End Sub
Attribute VB_Name = "form_camarafria"
Attribute VB_Base = "0{C94D8B66-EF5E-4F19-926B-42AF9AC46DEE}{AC1B0E5C-6A50-4D54-A24A-D8384081E752}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim LinSelect As Integer
Dim ColSelect As Integer

Dim PrimeiraLetra As Boolean

Private Sub Cadastrados_Click()
    LinSelect = Cadastrados.RowSel
    
    If LinSelect > 0 Then
        edtCodigo.Text = Cadastrados.TextMatrix(LinSelect, 0)
        edtNome.Text = Cadastrados.TextMatrix(LinSelect, 1)
        
        Mostra_Enderecos
    End If
End Sub

Private Sub edtNome_Change()
    edtNome.Text = UCase(edtNome.Text)
End Sub

Private Sub Menu_ButtonClick(ByVal Button As MSComctlLib.Button)
    Select Case Button.Key
        Case Is = "Novo"
            Limpa_Campos
            Habilita_Campos True
            edtNome.SetFocus
        Case Is = "Alterar"
            If edtCodigo.Text <> "" Then
                Habilita_Campos True
            End If
        Case Is = "Excluir"
            Excluir_Dados
        Case Is = "Cancelar"
            Limpa_Campos
            Habilita_Campos False
        Case Is = "Salvar"
            Salvar_Dados
    End Select
End Sub

Private Sub menuEnderecos_ButtonClick(ByVal Button As MSComctlLib.Button)
    Dim cont As Integer
    
    Select Case Button.Key
        Case Is = "Novo"
            Enderecos.Rows = Enderecos.Rows + 1
            Enderecos.TextMatrix(Enderecos.Rows - 1, 0) = Enderecos.Rows - 1
        Case Is = "Excluir"
            If LinSelect > 1 Then
                Enderecos.RemoveItem (LinSelect)
                For cont = 1 To Enderecos.Rows - 1
                    Enderecos.TextMatrix(cont, 0) = cont
                Next cont
            End If
    End Select
End Sub

Private Sub Enderecos_KeyPress(KeyAscii As Integer)
    If Enderecos.RowSel <= 0 Then Exit Sub
    
    If ColSelect = 1 Or ColSelect = 2 Or ColSelect = 5 Then
        With Enderecos
            .col = ColSelect
            Select Case KeyAscii
                Case vbKeyReturn, vbKeyTab
                    If .Row + 1 <= .Rows - 1 Then
                        .Row = .Row + 1
                    Else
                        .Row = 1
                    End If
                    PrimeiraLetra = True
                    
                Case vbKeyBack
                    'remove o ultimo caractere
                    If Len(.Text) Then
                        .Text = Left(.Text, Len(.Text) - 1)
                    End If
        
                Case Is < 32
        
                Case Else
                    If PrimeiraLetra Then
                        PrimeiraLetra = False
                        .Text = ""
                    End If
                    .Text = .Text & UCase(Chr(KeyAscii))
            End Select
        End With
    End If
    If ColSelect = 3 Or ColSelect = 4 Then
        With Enderecos
            .col = ColSelect
            Select Case KeyAscii
                Case vbKeyReturn, vbKeyTab
                    If .Row + 1 <= .Rows - 1 Then
                        .Row = .Row + 1
                    Else
                        .Row = 1
                    End If
                    PrimeiraLetra = True
                    
                Case vbKeyBack
                    'remove o ultimo caractere
                    If Len(.Text) Then
                        .Text = Left(.Text, Len(.Text) - 1)
                    End If
        
                Case Is < 32
        
                Case Else
                    If PrimeiraLetra Then
                        PrimeiraLetra = False
                        .Text = ""
                    End If
                    If Somente_Numeros(KeyAscii, False, True) = True Then
                        .Text = .Text & Chr(KeyAscii)
                    End If
            End Select
        End With
    End If

End Sub

Private Sub Enderecos_MouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    LinSelect = Enderecos.MouseRow
    ColSelect = Enderecos.MouseCol
End Sub

Private Sub UserForm_Initialize()

    If con Is Nothing Then Conecta_Banco

    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    Frame1.BackColor = CorFundoTela
    
    With Menu
        .ImageList = ImageList1
        .Buttons(1).Image = ImageList1.ListImages(1).Index
        .Buttons(3).Image = ImageList1.ListImages(2).Index
        .Buttons(5).Image = ImageList1.ListImages(3).Index
        .Buttons(7).Image = ImageList1.ListImages(4).Index
        .Buttons(9).Image = ImageList1.ListImages(5).Index
        .Left = (Me.Width - .Width) / 2
    End With

    With menuEnderecos
        .ImageList = ImageList1
        .Buttons(1).Image = ImageList1.ListImages(1).Index
        .Buttons(3).Image = ImageList1.ListImages(3).Index
        .Left = (Frame1.Width - .Width) / 2
    End With
    
    With Cadastrados
        .Clear
        .Rows = 1
        .Cols = 2
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarVertical
        .AllowBigSelection = False
        .TextMatrix(0, 0) = "ID C|fffd|mara Fria"
        .TextMatrix(0, 1) = "Nome"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .ColWidth(0) = 1200
        .ColWidth(1) = 8600
        .ColAlignment(0) = 4
        .ColAlignment(1) = 1
    End With
    
    With Enderecos
        .Clear
        .Rows = 1
        .Cols = 6
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarVertical
        .AllowBigSelection = False
        .TextMatrix(0, 0) = "ID Endereco"
        .TextMatrix(0, 1) = "Corredor"
        .TextMatrix(0, 2) = "Prateleira"
        .TextMatrix(0, 3) = "Andar"
        .TextMatrix(0, 4) = "N|fffd|mero"
        .TextMatrix(0, 5) = "Coment|fffd|rio"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .FixedAlignment(2) = 4
        .FixedAlignment(3) = 4
        .FixedAlignment(4) = 4
        .FixedAlignment(5) = 4
        .ColWidth(0) = 1200
        .ColWidth(1) = 1200
        .ColWidth(2) = 1200
        .ColWidth(3) = 1200
        .ColWidth(4) = 1200
        .ColWidth(5) = 3500
        .ColAlignment(0) = 4
        .ColAlignment(1) = 4
        .ColAlignment(2) = 4
        .ColAlignment(3) = 4
        .ColAlignment(4) = 4
        .ColAlignment(5) = 1
    End With
    
    Call Centralizar(Me)
    
    Limpa_Campos
    Habilita_Campos False
    Mostra_Cadastrados
End Sub

Private Sub Limpa_Campos()
    edtCodigo.Text = ""
    edtNome.Text = ""
    
    Enderecos.Rows = 1
End Sub

Private Sub Habilita_Campos(status As Boolean)
    edtCodigo.Enabled = False
    edtNome.Enabled = status
    
    With Menu
        .Buttons(1).Enabled = Not status
        .Buttons(3).Enabled = Not status
        .Buttons(5).Enabled = Not status
        .Buttons(7).Enabled = status
        .Buttons(9).Enabled = status
    End With
    
    Cadastrados.Enabled = Not status
    
    Enderecos.Enabled = status
    With menuEnderecos
        .Buttons(1).Enabled = status
        .Buttons(3).Enabled = status
    End With
    
End Sub

Private Sub Mostra_Cadastrados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    Set rs = New ADODB.Recordset
    sql = "SELECT * FROM tab_camarafria ORDER BY NomeCamaraFria"
    rs.Open sql, con
    
    Cadastrados.Rows = 1
    
    While Not rs.EOF
        With Cadastrados
            .Rows = .Rows + 1
        
            .TextMatrix(.Rows - 1, 0) = rs("ID_CamaraFria")
            .TextMatrix(.Rows - 1, 1) = rs("NomeCamaraFria")
         End With
         
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing

End Sub

Private Sub Mostra_Enderecos()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    Set rs = New ADODB.Recordset
    sql = "SELECT * FROM tab_camarafriaendereco WHERE ID_CamaraFria = " & edtCodigo.Text & " ORDER BY Corredor, Prateleira, Andar, Numero"
    rs.Open sql, con
    
    Enderecos.Rows = 1
    
    While Not rs.EOF
        With Enderecos
            .Rows = .Rows + 1
        
            .TextMatrix(.Rows - 1, 0) = rs("ID_Endereco")
            .TextMatrix(.Rows - 1, 1) = rs("Corredor")
            .TextMatrix(.Rows - 1, 2) = rs("Prateleira")
            .TextMatrix(.Rows - 1, 3) = rs("Andar")
            .TextMatrix(.Rows - 1, 4) = rs("Numero")
            .TextMatrix(.Rows - 1, 5) = rs("Comentario")
         End With
         
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing

End Sub

Private Sub Salvar_Dados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim cont As Integer
    
    If edtNome.Text = "" Or _
       Enderecos.Rows = 1 Then
       MsgBox "Todos os campos s|fffd|o obrigat|fffd|rios." & vbNewLine & "|fffd| necess|fffd|rio ao menos um endere|fffd|o.", vbInformation, "Salvar"
       Exit Sub
    End If
    
    If edtCodigo.Text = "" Then
        sql = "INSERT INTO tab_camarafria (NomeCamaraFria)" & _
                    "VALUES ('" & edtNome.Text & "')"
    Else
        sql = "UPDATE tab_camarafria SET NomeCamaraFria = '" & edtNome.Text & "' " & _
              "WHERE ID_CamaraFria = " & edtCodigo.Text
    End If
    
    con.Execute sql
    
    If edtCodigo = "" Then
        sql = "SELECT * FROM tab_camarafria WHERE NomeCamaraFria = '" & edtNome.Text & "'"
        Set rs = New ADODB.Recordset
        rs.Open sql, con
        edtCodigo.Text = rs("ID_CamaraFria")
        rs.Close
        Set rs = Nothing
    End If
    
    sql = "DELETE * FROM tab_camarafriaendereco WHERE ID_CamaraFria = " & edtCodigo.Text
    con.Execute sql
    
    With Enderecos
        For cont = 1 To .Rows - 1
            sql = "INSERT INTO tab_camarafriaendereco (ID_CamaraFria, ID_Endereco, Corredor, Prateleira, Andar, Numero, Comentario) " & _
                        "VALUES (" & edtCodigo.Text & "," & .TextMatrix(cont, 0) & ", '" & .TextMatrix(cont, 1) & "','" & .TextMatrix(cont, 2) & "'," & .TextMatrix(cont, 3) & "," & .TextMatrix(cont, 4) & "," & IIf(IsNull(.TextMatrix(cont, 5)), "null", "'" & .TextMatrix(cont, 5) & "'") & ")"
            con.Execute sql
        Next cont
    End With
            
    Mostra_Cadastrados
    Mostra_Enderecos
    
    Habilita_Campos False
End Sub

Private Sub Excluir_Dados()
    Dim sql As String
    
    If edtCodigo.Text <> "" Then
        If MsgBox("Deseja realmente excluir esta c|fffd|mara fria ?", vbYesNo + vbInformation + vbDefaultButton2, "Exclus|fffd|o") = vbYes Then
            sql = "DELETE * FROM tab_camarafriaendereco WHERE ID_camarafria = " & edtCodigo.Text
            con.Execute sql
            sql = "DELETE * FROM tab_camarafria WHERE ID_camarafria = " & edtCodigo.Text
            con.Execute sql
        End If
            
        Limpa_Campos
        Habilita_Campos False
        Mostra_Cadastrados
    End If
End Sub
Attribute VB_Name = "form_checkcontagem"
Attribute VB_Base = "0{4E878A8B-C5E9-4674-A4A0-39C899CF3C34}{F87D8B98-78CE-4BDA-B4E0-1A95B895E9BF}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim safra As String
Dim MaterialRow As Integer

Public Admin As String

Private Sub btnValidar_Click()
    Dim lin As Integer
    Dim passou As Boolean
    Dim leu As Boolean
    Dim sql As String
    
    With Lista_Conferencia
        passou = True
        leu = False
        For lin = 1 To .Rows - 1
            If .RowHeight(lin) > 0 Then
                leu = True
                If .TextMatrix(lin, 0) = "q" Then
                    Call EmitirSom
                    MsgBox "H|fffd| parcela que n|fffd|o foi validada no processo de check.", vbInformation, "Check"
                    .TopRow = lin
                    passou = False
                    Exit For
                End If
            End If
        Next lin
        
        If passou Then
            For lin = 1 To .Rows - 1
                If .RowHeight(lin) > 0 Then
                    sql = "UPDATE tab_fieldbook SET " & _
                                  "checkcontagem = true, " & _
                                  "datacheckcontagem = #" & Format(Date, "yyyy/mm/dd") & "#, " & _
                                  "usuariocheckcontagem = '" & usuario & "' " & _
                          "WHERE [plot BID] = '" & .TextMatrix(lin, 5) & "'"
                    con.Execute sql
                End If
            Next lin
            
            If leu Then
                sql = "UPDATE tab_contador SET status='Liberado' " & _
                      "WHERE ID_Contador in " & _
                          "(SELECT ID_Contador " & _
                          "FROM tab_contadormaterial " & _
                          "WHERE ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and Termino is null)"
                con.Execute sql
                
                sql = "UPDATE tab_contadormaterial SET Termino=#" & Format(Date, "yyyy/mm/dd") & "# " & _
                      "WHERE ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and Termino is null"
                con.Execute sql
                
                Monta_Lista_Materiais
                Monta_Lista_Conferencia
            End If
        End If
    End With
    
End Sub

Private Sub edtFindMaterial_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim lin As Integer
    Dim col As Integer
    Dim achou As Boolean
    
    If KeyCode = vbKeyReturn Then
    
        If edtFindMaterial.Text = "" Then Exit Sub
        
        With Lista_Materiais
            achou = False
            MaterialRow = 0
            
            For lin = 1 To .Rows - 1
                If UCase(.TextMatrix(lin, 2)) = UCase(edtFindMaterial) Then
                    achou = True
                    MaterialRow = lin
                    Exit For
                End If
            Next lin
            
            If Not achou Then MsgBox "Material n|fffd|o encontrado.", vbInformation, "Pesquisa"
            If achou Then Lista_Materiais_Click
        End With
        
        edtFindMaterial.Text = ""
        edtFindMaterial.SetFocus
    End If
End Sub

Private Sub edtPlotBID_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim lin As Integer
    Dim col As Integer
    Dim achou As Boolean
    
    If KeyCode = vbKeyReturn Then
    
        If edtPlotBID.Text = "" Then Exit Sub
        
        edtPlotBID.Text = Left(edtPlotBID.Text, 24)
        
        With Lista_Conferencia
            achou = False
            
            For lin = 1 To .Rows - 1
                If .RowHeight(lin) <> 0 Then
                    If .TextMatrix(lin, 0) = "q" And UCase(.TextMatrix(lin, 5)) = UCase(edtPlotBID.Text) Then
                        achou = True
                        .TextMatrix(lin, 0) = "|fffd|"
                        For col = 0 To .Cols - 1
                            .Row = lin
                            .col = col
                            .CellBackColor = &HC0FFC0
                        Next col
                        
                        Exit For
                    End If
                End If
            Next lin
            
            If Not achou Then
                Call EmitirSom
                MsgBox "Parcela n|fffd|o localizada ou j|fffd| foi conferida.", vbInformation, "Confer|fffd|ncia"
            End If
        End With
        
        edtPlotBID.Text = ""
        edtFindMaterial.SetFocus
        edtPlotBID.SetFocus
    End If

End Sub

Private Sub Label1_DblClick(ByVal Cancel As MSForms.ReturnBoolean)
    Dim rs As ADODB.Recordset
    Dim lin As Integer
    
    Admin = ""
    
    Set rs = New ADODB.Recordset
    rs.Open "SELECT * FROM tab_usuario WHERE Usuario = '" & usuario & "' and Admin = true", con
    If rs.EOF Then
        rs.Close
        
        form_ususenha.Show
    Else
        If rs("Admin") Then
            Admin = "Sim"
        Else
            Admin = "Nao"
        End If
    End If
        
    If Admin = "Sim" Then
        With Lista_Conferencia
            For lin = 1 To .Rows - 1
                If .RowHeight(lin) > 0 Then
                    .TextMatrix(lin, 0) = "|fffd|"
                End If
            Next lin

            btnValidar_Click
        
        End With
    End If
    
End Sub

Private Sub Lista_Materiais_Click()
    Dim lin As Integer
    
    If MaterialRow > 0 Then
        With Lista_Conferencia
            For lin = 1 To .Rows - 1
                If .TextMatrix(lin, 11) = Lista_Materiais.TextMatrix(MaterialRow, 0) And _
                   .TextMatrix(lin, 12) = Lista_Materiais.TextMatrix(MaterialRow, 2) Then
                   .RowHeight(lin) = 240
                Else
                    .RowHeight(lin) = 0
                End If
            Next lin
        End With
        
        edtPlotBID.SetFocus
    End If
End Sub

Private Sub Lista_Materiais_MouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    MaterialRow = Lista_Materiais.MouseRow
End Sub

Private Sub UserForm_Initialize()
    Dim col As Integer
    
    If con Is Nothing Then Conecta_Banco
'    usuario = "Robso"
'    CorFundoTela = RGB(229, 239, 218)
    
    safra = Pega_Safra
    
    Call AtivarBotoesMinMax(Me)
    Call Maximizar(Me)
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    Frame1.Height = Me.Height - Frame1.Top - 30
    Frame1.BackColor = CorFundoTela
    
    Frame2.Height = Me.Height - Frame2.Top - 30
    Frame2.Width = Me.Width - Frame2.Left - 14
    Frame2.BackColor = CorFundoTela
    
    With Lista_Materiais
        .Clear
        .Rows = 1
        .Cols = 3
        .Height = Frame1.Height - .Top - 10
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "ID_Material"
        .TextMatrix(0, 1) = "Material"
        .TextMatrix(0, 2) = "Inv BID"
        .FixedAlignment(1) = 7
        For col = 1 To .Cols - 1
            .FixedAlignment(col) = 4
        Next col
        .ColWidth(0) = 0
        .ColWidth(1) = 3100
        .ColWidth(2) = 2255
        .ColAlignment(0) = 7
        .ColAlignment(1) = 1
        .ColAlignment(2) = 1
    End With
    
    With Lista_Conferencia
        .Clear
        .Rows = 1
        .Cols = 13
        .FixedCols = 0
        .Height = Frame2.Height - .Top - 10
        .Width = Frame2.Width - .Left - 14
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Orig Proj"
        .TextMatrix(0, 2) = "Grower Proj"
        .TextMatrix(0, 3) = "Set"
        .TextMatrix(0, 4) = "Field"
        .TextMatrix(0, 5) = "Plot BID"
        .TextMatrix(0, 6) = "Material"
        .TextMatrix(0, 7) = "Entry#"
        .TextMatrix(0, 8) = "Rep#"
        .TextMatrix(0, 9) = "AbsR"
        .TextMatrix(0, 10) = "AbsC"
        .TextMatrix(0, 11) = "ID_Material"
        .TextMatrix(0, 12) = "Inv BID"
        For col = 0 To .Cols - 1
            .FixedAlignment(col) = 4
            .ColWidth(col) = 500
            If col < 5 Then
                .ColAlignment(col) = 1
            Else
                .ColAlignment(col) = 7
            End If
            If col >= .Cols - 2 Then .ColWidth(col) = 0
        Next col
    End With
    
    Monta_Lista_Materiais
    Monta_Lista_Conferencia
    
    MaterialRow = 0
    
End Sub

Private Sub Monta_Lista_Materiais()
    Dim sql As String
    Dim rs1 As ADODB.Recordset
    Dim rs2 As ADODB.Recordset
    Dim cont As Integer
    
    sql = "SELECT DISTINCT M.ID_Material, M.Pedigree, FB.[Inv BID] " & _
          "FROM tab_fieldbook as FB " & _
          "INNER JOIN tab_material as M on M.ID_Material = FB.ID_Material " & _
          "WHERE FB.Season = '" & safra & "' AND " & _
                "FB.EtiquetaImpressa = True AND " & _
                "FB.CheckContagem = False AND " & _
                "M.Status = 'Em Uso' " & _
          "ORDER BY M.Pedigree"
          
    Set rs1 = New ADODB.Recordset
    rs1.Open sql, con
    
    Set rs2 = New ADODB.Recordset
    
    With Lista_Materiais
        .Rows = 1
        
        While Not rs1.EOF
            .Rows = .Rows + 1
            
            .TextMatrix(.Rows - 1, 0) = rs1("ID_Material")
            .TextMatrix(.Rows - 1, 1) = rs1("Pedigree")
            .TextMatrix(.Rows - 1, 2) = rs1("Inv BID")
            
            rs2.Open "SELECT Count(ID_Material) as cont " & _
                     "FROM tab_contadormaterial " & _
                     "WHERE ID_Material = " & rs1("ID_Material") & " and Termino is null", con
            
            .Row = .Rows - 1
            For cont = 0 To .Cols - 1
                .col = cont
                If rs2("cont") = 0 Then
                    .CellBackColor = &HFFFFFF
                Else
                    .CellBackColor = &HC0FFC0
                End If
            Next cont
            
            rs2.Close
            
            rs1.MoveNext
        Wend
    End With
    
    rs1.Close
    Set rs1 = Nothing
    Set rs2 = Nothing
    
    AutosizeGridColumns Lista_Materiais, 1, 2
End Sub

Private Sub Monta_Lista_Conferencia()
    Dim LinMaterial As Integer
    Dim lin As Integer
    Dim col As Integer
    Dim cont As Integer
    
    Dim rs As ADODB.Recordset
    Dim sql As String

    Lista_Conferencia.Rows = 1
    
    With Lista_Materiais
        For LinMaterial = 1 To .Rows - 1
            sql = "SELECT OP.CodigoPrograma as Originator, GP.CodigoPrograma as Grower, FB.[Set], FB.Field, " & _
                         "FB.[Plot BID], FB.ID_Material, M.Pedigree, FB.[Inv BID], FB.[Entry#], FB.[Rep#], FB.AbsR, FB.AbsC, P.QtdeSaqParcela, " & _
                         "T.NroTratamento, T.DescricaoTratamento, T.QtdeSementes " & _
                  "FROM (((((tab_fieldbook as FB " & _
                  "INNER JOIN tab_Material as M ON M.ID_Material = FB.ID_Material) " & _
                  "INNER JOIN tab_Programa as OP ON OP.ID_Programa = FB.[Orig Proj]) " & _
                  "INNER JOIN tab_Programa as GP ON GP.ID_Programa = FB.[Grower Proj]) " & _
                  "INNER JOIN tab_protocolo as P ON P.[Set] = FB.[Set] and P.ID_Program = FB.[Orig Proj]) " & _
                  "INNER JOIN tab_protocolotratamento as T on T.ID_Protocolo = P.ID_Protocolo) " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(LinMaterial, 0) & " and " & _
                        "FB.[Inv BID] = '" & Lista_Materiais.TextMatrix(LinMaterial, 2) & "' and " & _
                        "FB.[Plot Deactivated] = False and FB.EtiquetaImpressa = True and " & _
                        "FB.CheckContagem = False and FB.Season='" & safra & "' " & _
                  "ORDER BY M.Pedigree, FB.Field, FB.[Set], FB.[Entry#], FB.[Rep#]"
                
            Set rs = New ADODB.Recordset
            rs.Open sql, con
                
            While Not rs.EOF
                For cont = 1 To rs("QtdeSaqParcela")
                    Lista_Conferencia.Rows = Lista_Conferencia.Rows + 1
                        
                    Lista_Conferencia.RowHeight(Lista_Conferencia.Rows - 1) = 0
            
                    Lista_Conferencia.col = 0
                    Lista_Conferencia.Row = Lista_Conferencia.Rows - 1
                    Lista_Conferencia.FillStyle = flexFillRepeat
                    Lista_Conferencia.CellFontName = "Wingdings"
                    Lista_Conferencia.CellFontSize = 12
                    Lista_Conferencia.CellAlignment = flexAlignCenterCenter
                    Lista_Conferencia.FillStyle = flexFillSingle
                    
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 0) = "q"
                    
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 1) = rs("Originator")
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 2) = rs("Grower")
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 3) = rs("Set")
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 4) = rs("Field")
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 5) = rs("Plot BID")
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 6) = rs("Pedigree")
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 7) = rs("Entry#")
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 8) = rs("Rep#")
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 9) = rs("AbsR")
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 10) = rs("AbsC") + (cont - 1)
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 11) = rs("ID_Material")
                    Lista_Conferencia.TextMatrix(Lista_Conferencia.Rows - 1, 12) = rs("Inv BID")
                Next cont
                
                rs.MoveNext
            Wend
                
            rs.Close
            Set rs = Nothing
        Next LinMaterial
    End With
    
    AutosizeGridColumns Lista_Conferencia, 1, 10
    
End Sub
Attribute VB_Name = "form_checksorteio"
Attribute VB_Base = "0{585C00B4-012C-4CEA-AE7E-02D22E645261}{7E846A84-5123-4020-8C4F-BE38FDC355E0}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit
Dim safra As String
Dim FieldRow As Integer
Dim FieldCol As Integer
Dim Contador As Integer

Private Sub btnValidar_Click()
    Dim lin As Integer
    Dim passou As Boolean
    Dim sql As String
    Dim frm As Object
    
    With Lista_Check
        passou = True
        
        For lin = 1 To .Rows - 1
            If .RowHeight(lin) > 0 Then
                .Row = lin
                .col = 0
                If .CellBackColor <> RGB(0, 255, 0) Then
                    Call EmitirSom
                    MsgBox "H|fffd| parcela que n|fffd|o foi validada no processo de check.", vbInformation, "Check"
                    .TopRow = lin
                    passou = False
                    Exit For
                End If
            End If
        Next lin
        
        If passou Then
            DataCalendario = Date
            
            Set frm = New CalendarFrm
            frm.Caption = "Previs|fffd|o de Envio"
            frm.Show
            
            For lin = 1 To .Rows - 1
                If .RowHeight(lin) > 0 Then
                    sql = "UPDATE tab_fieldbook SET " & _
                                  "checksorteio = true, " & _
                                  "datachecksorteio = #" & Format(Date, "yyyy/mm/dd") & "#, " & _
                                  "usuariochecksorteio= '" & usuario & "', " & _
                                  "PrevisaoEnvio=#" & Format(DataCalendario, "yyyy/mm/dd") & "# " & _
                          "WHERE [plot BID] = '" & .TextMatrix(lin, 0) & "'"
                    con.Execute sql
                End If
            Next lin
            
            Monta_Fields
            .Rows = 1
        End If
    End With
    
End Sub

Private Sub edtFindField_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim lin As Integer
    Dim col As Integer
    Dim achou As Boolean
    
    If KeyCode = vbKeyReturn Then
    
        If edtFindField.Text = "" Then Exit Sub
        
        With Lista_Fields
            achou = False
            FieldRow = 0
            
            For lin = 1 To .Rows - 1
                If UCase(.TextMatrix(lin, 1)) = UCase(edtFindField) Then
                    .TopRow = lin
                    .Row = lin
                    If .TextMatrix(lin, 0) = "q" Then
                        .TextMatrix(lin, 0) = "|fffd|"
                    Else
                        .TextMatrix(lin, 0) = "q"
                    End If
                    achou = True
                    FieldRow = lin
                    Exit For
                End If
            Next lin
        End With
        
        If achou Then Monta_Lista_Check
    End If
End Sub

Private Sub edtFindPlotBID_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim lin As Integer
    Dim col As Integer
    Dim Achei As Boolean
    
    If KeyCode <> vbKeyReturn Then Exit Sub
    
    If edtFindPlotBID = "" Then Exit Sub
    
    Achei = False
    
    With Lista_Check
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = edtFindPlotBID Then
                Achei = True
                .Row = lin
                .col = 0
                If .CellBackColor = RGB(0, 255, 0) Then
                    Call EmitirSom
'                    MsgBox "Esta Parcela j|fffd| foi conferica.", vbOKOnly + vbInformation, "Check"
                Else
                    If lin > 1 Then
                        .Row = lin - 1
                        .col = 0
                        If .CellBackColor = RGB(0, 255, 0) Then
                            Contador = Contador + 1
                            .Row = lin
                            For col = 0 To .Cols - 1
                                .col = col
                                .CellBackColor = RGB(0, 255, 0)
                            Next col
                        Else
                            Call EmitirSom
'                            MsgBox "Esta parcela est|fffd| fora da sequencia de plantio.", vbOKOnly + vbInformation, "Check"
                        End If
                    Else
                        .Row = lin
                        Contador = Contador + 1
                        For col = 0 To .Cols - 1
                            .col = col
                            .CellBackColor = RGB(0, 255, 0)
                        Next col
                    End If
                End If
                
                If Contador = 40 Then
                    .TopRow = .Row
                    Contador = 0
                End If
                
                Exit For
            End If
        Next lin
    End With
    
    If Not Achei Then
        Call EmitirSom
'        MsgBox "Parcela n|fffd|o localizada." & vbNewLine & "Verifique se esta parcela pertence a este plantio.", vbOKOnly + vbInformation, "Check"
    End If
    
    edtFindPlotBID.Text = ""
    edtFindField.SetFocus
    edtFindPlotBID.SetFocus
    
End Sub

Private Sub Lista_Fields_Click()

    If FieldRow > 0 Then
        With Lista_Fields
            If FieldCol = 0 Then
                If .TextMatrix(FieldRow, 0) = "q" Then
                    .TextMatrix(FieldRow, 0) = "|fffd|"
                Else
                    .TextMatrix(FieldRow, 0) = "q"
                End If
                
                Monta_Lista_Check
            End If
        End With
    End If
End Sub

Private Sub Lista_Fields_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    FieldRow = Lista_Fields.MouseRow
    FieldCol = Lista_Fields.MouseCol
End Sub

Private Sub UserForm_Initialize()
    Dim col As Integer
    
    Call AtivarBotoesMinMax(Me)
    Call Maximizar(Me)
    
    If con Is Nothing Then Conecta_Banco
'    usuario = "Robso"
'    CorFundoTela = RGB(229, 239, 218)
    
    safra = Pega_Safra
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    Frame1.Height = Me.Height - Frame1.Top - 30
    Frame1.BackColor = CorFundoTela
    
    Frame2.Height = Me.Height - Frame1.Top - 30
    Frame2.Width = Me.Width - Frame2.Left - 14
    Frame2.BackColor = CorFundoTela
    
    btnValidar.Left = Frame2.Width - btnValidar.Width - 14
    
    With Lista_Fields
        .Clear
        .Rows = 1
        .Cols = 2
        .Height = Frame1.Height - .Top - 10
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Field"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 2250
        .ColAlignment(0) = 4
        .ColAlignment(1) = 1
    End With
    
    With Lista_Check
        .Clear
        .Rows = 1
        .Cols = 8
        .Height = Frame2.Height - .Top - 10
        .Width = Frame2.Width - .Left - 10
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "Plot BID"
        .TextMatrix(0, 1) = "Field"
        .TextMatrix(0, 2) = "Set"
        .TextMatrix(0, 3) = "Pedigree"
        .TextMatrix(0, 4) = "Entry#"
        .TextMatrix(0, 5) = "Rep#"
        .TextMatrix(0, 6) = "AbsR"
        .TextMatrix(0, 7) = "AbsC"
        For col = 0 To .Cols - 1
            .FixedAlignment(col) = 4
            .ColWidth(col) = 800
            Select Case col
                Case 0, 1, 2, 3, 7
                    .ColAlignment(col) = 1
                Case 4, 5, 6
                    .ColAlignment(col) = 4
            End Select
        Next col
    End With
    
    Monta_Fields

End Sub

Private Sub Monta_Fields()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    sql = "SELECT DISTINCT Field " & _
          "FROM tab_fieldbook " & _
          "WHERE Season = '" & safra & "' and CheckContagem = true and CheckSorteio = False"
    
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    Lista_Fields.Rows = 1
    
    While Not rs.EOF
        With Lista_Fields
            .Rows = .Rows + 1
            
            .col = 0
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            
            .TextMatrix(.Rows - 1, 0) = "q"
            .TextMatrix(.Rows - 1, 1) = rs("Field")
        End With
    
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
End Sub

Private Sub Monta_Lista_Check()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim lin As Integer
    Dim fields As String
    
    Lista_Check.Rows = 1
    
    fields = ""
    
    With Lista_Fields
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If fields <> "" Then fields = fields & ", "
                fields = fields & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    
    If fields <> "" Then
        sql = "SELECT F.[Plot BID], F.Field, F.Set, M.Pedigree, F.[Entry#], F.[Rep#], F.AbsR, F.AbsC " & _
              "FROM tab_fieldbook as F " & _
              "INNER JOIN tab_material as M ON M.ID_Material = F.ID_Material " & _
              "WHERE F.Season = '" & safra & "' and F.Field in (" & fields & ") " & _
              "ORDER BY F.AbsC, F.AbsR"
        
        Set rs = New ADODB.Recordset
        rs.Open sql, con
        
        While Not rs.EOF
            With Lista_Check
                .Rows = .Rows + 1
                
                .TextMatrix(.Rows - 1, 0) = rs("Plot BID")
                .TextMatrix(.Rows - 1, 1) = rs("Field")
                .TextMatrix(.Rows - 1, 2) = IIf(IsNull(rs("Set")), "", rs("Set"))
                .TextMatrix(.Rows - 1, 3) = rs("Pedigree")
                .TextMatrix(.Rows - 1, 4) = IIf(IsNull(rs("Entry#")), "", rs("Entry#"))
                .TextMatrix(.Rows - 1, 5) = IIf(IsNull(rs("Rep#")), "", rs("Rep#"))
                .TextMatrix(.Rows - 1, 6) = rs("AbsR")
                .TextMatrix(.Rows - 1, 7) = rs("AbsC")
            End With
            
            rs.MoveNext
        Wend
        
        rs.Close
        Set rs = Nothing
    End If
    
    AutosizeGridColumns Lista_Check, 0, 7

    Contador = 0

End Sub
Attribute VB_Name = "form_confirmaretirada"
Attribute VB_Base = "0{290982A4-4197-455C-BC0B-A91568AA9877}{F489902E-5615-4F92-A13B-EBF3E12128EE}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim listaRow As Integer
Dim listaCol As Integer
Dim PrimeiraLetra As Boolean
Dim safra As String

Private Sub btnConfirma_Click()
    Dim lin As Integer
    Dim NaoPegouNada As Boolean
    Dim FaltaObservacao As Boolean
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    If Lista_Retirar.Rows = 1 Then Exit Sub
    
    With Lista_Retirar
        NaoPegouNada = True
        FaltaObservacao = False
        
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 9) = "|fffd|" Then
                NaoPegouNada = False
            End If
            If .TextMatrix(lin, 9) = "q" And .TextMatrix(lin, 10) = "" Then
                FaltaObservacao = True
            End If
        Next lin
    End With
    
    If NaoPegouNada Then
        MsgBox "Nenhum dos materiais abaixo foi confirmado a retirada." & vbNewLine & _
               "Favor rever o processo.", vbInformation, "Confirmar Retirada"
        Exit Sub
    End If
    
    If FaltaObservacao Then
        MsgBox "H|fffd| material que n|fffd|o foi retirado da camara." & vbNewLine & _
               "Favor justificar a n|fffd|o retirada no campo de observa|fffd||fffd|es.", vbInformation, "Confirmar Retirada"
        Exit Sub
    End If
    
    With Lista_Retirar
        For lin = 1 To .Rows - 1
            sql = "UPDATE tab_retirada SET Retirou = "
            If .TextMatrix(lin, 9) = "q" Then
                sql = sql & "false, "
            Else
                sql = sql & "true, "
            End If
            If .TextMatrix(lin, 10) = "" Then
                sql = sql & "Observacao='', "
            Else
                sql = sql & "Observacao='" & .TextMatrix(lin, 10) & "', "
            End If
            sql = sql & "Data_Retirada=#" & Format(Date, "yyyy/mm/dd") & "# " & _
                        "WHERE ID_Retirada=" & .TextMatrix(lin, 0)
            
            con.Execute sql
            
            If .TextMatrix(lin, 9) = "|fffd|" Then
                sql = "UPDATE tab_material SET Status='Em Uso' WHERE ID_Material = " & .TextMatrix(lin, 1)
                
                con.Execute sql
            End If
        Next lin
    End With
    
    Unload Me
    
End Sub

Private Sub edtInvBID_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim lin As Integer
    Dim col As Integer
    Dim achou As Boolean
    
    If KeyCode = vbKeyReturn And edtInvBID.Text <> "" Then
        With Lista_Retirar
            achou = False
            For lin = 1 To .Rows - 1
                If UCase(.TextMatrix(lin, 3)) = UCase(edtInvBID.Text) Then
                    .Row = lin
                    If .Visible = False Then .TopRow = lin
                    .TextMatrix(lin, 9) = "|fffd|"
                    For col = 0 To .Cols - 1
                        .col = col
                        .CellBackColor = &HC0FFC0
                    Next col
                    achou = True
                    Exit For
                End If
            Next lin
            If Not achou Then
                MsgBox "Material n|fffd|o est|fffd| na lista de retirada.", vbInformation, "Aten|fffd||fffd|o"
            End If
            edtInvBID.Text = ""
            edtInvBID.SetFocus
        End With
    End If
End Sub

Private Sub Lista_Retirar_Click()
    Dim col As Integer
    
    If listaRow > 0 And listaCol = 9 Then
        With Lista_Retirar
            .Row = listaRow
            .col = listaCol
            If .Text = "q" Then
                .Text = "|fffd|"
            Else
                .Text = "q"
            End If
            
            For col = 0 To .Cols - 1
                .col = col
                If .TextMatrix(.Row, 9) = "q" Then
                    .CellBackColor = &H80000005
                Else
                    .CellBackColor = &HC0FFC0
                End If
            Next col
        End With
    End If
End Sub

Private Sub Lista_Retirar_KeyPress(KeyAscii As Integer)
    If listaRow > 0 And listaCol = 10 Then
        With Lista_Retirar
            .col = listaCol
            
            Select Case KeyAscii
                Case vbKeyReturn, vbKeyTab
                    If .Row + 1 <= .Rows - 1 Then
                        .Row = .Row + 1
                    Else
                        .Row = 1
                    End If
                    PrimeiraLetra = True
                    
                Case vbKeyBack
                    'remove o ultimo caractere
                    If Len(.Text) Then
                        .Text = Left(.Text, Len(.Text) - 1)
                    End If
        
                Case Is < 32
        
                Case Else
                    If PrimeiraLetra Then
                        PrimeiraLetra = False
                        .Text = ""
                    End If
                    .Text = .Text & Chr(KeyAscii)
            End Select
        End With
        AutosizeGridColumns Lista_Retirar, 2, 10
    End If
End Sub

Private Sub Lista_Retirar_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    listaRow = Lista_Retirar.MouseRow
    listaCol = Lista_Retirar.MouseCol
End Sub

Private Sub UserForm_Initialize()
    Dim col As Integer
    
    Call AtivarBotoesMinMax(Me)
    Call Maximizar(Me)
    
    If con Is Nothing Then Conecta_Banco
'    usuario = "ROBSO"
'    CorFundoTela = RGB(229, 239, 218)
    
    safra = Pega_Safra
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    btnConfirma.Left = Me.Width - btnConfirma.Width - 14
    
    With Lista_Retirar
        .Clear
        .Rows = 1
        .Cols = 12
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .Width = Me.Width - 14
        .Height = Me.Height - .Top - 50
        .TextMatrix(0, 0) = "ID_Retirada"
        .TextMatrix(0, 1) = "ID_Material"
        .TextMatrix(0, 2) = "Material"
        .TextMatrix(0, 3) = "Inv BID"
        .TextMatrix(0, 4) = "Lote"
        .TextMatrix(0, 5) = "Localiza|fffd||fffd|o"
        .TextMatrix(0, 6) = "CamaraFria"
        .TextMatrix(0, 7) = "Endere|fffd|o"
        .TextMatrix(0, 8) = "Coment|fffd|rio"
        .TextMatrix(0, 9) = "Retirada" & vbNewLine & "Confirmada"
        .TextMatrix(0, 10) = "Observa|fffd||fffd|o"
        .TextMatrix(0, 11) = "Buffer"
        .FixedAlignment(0) = 7
        .FixedAlignment(1) = 7
        For col = 2 To .Cols - 1
            .FixedAlignment(col) = 4
        Next col
        .ColWidth(0) = 0
        .ColWidth(1) = 0
        For col = 2 To .Cols - 1
            .ColWidth(col) = 2000
        Next col
        .ColAlignment(0) = 7
        .ColAlignment(1) = 7
        For col = 2 To .Cols - 1
            .ColAlignment(col) = 1
        Next col
    End With

    Mostra_RelacaoMateriais
    
    AutosizeGridColumns Lista_Retirar, 2, 11
End Sub

Private Sub Mostra_RelacaoMateriais()
    Dim rs As ADODB.Recordset
    Dim rs1 As ADODB.Recordset
    
    Dim lin As Long
    Dim col As Integer
    Dim para As Boolean
    
    Set rs = New ADODB.Recordset
    rs.Open "SELECT R.*, M.Pedigree, M.Lote, M.Localizacao, C.NomeCamaraFria, (E.Corredor & '-' & E.Prateleira & '-' & E.Andar & '-' & E.Numero) as Endereco, E.Comentario " & _
            "FROM (((tab_retirada as R " & _
            "INNER JOIN tab_material as M on M.ID_Material = R.ID_Material) " & _
            "LEFT JOIN tab_camarafria as C on C.ID_CamaraFria = M.ID_CamaraFria) " & _
            "LEFT JOIN tab_camarafriaEndereco as E on E.ID_CamaraFria = M.ID_CamaraFria and E.ID_Endereco = M.ID_Endereco) " & _
            "WHERE data_retirada is null", con
    
    While Not rs.EOF
        With Lista_Retirar
            .Rows = .Rows + 1
            
            .TextMatrix(.Rows - 1, 0) = rs("ID_Retirada")
            .TextMatrix(.Rows - 1, 1) = rs("ID_Material")
            .TextMatrix(.Rows - 1, 2) = rs("Pedigree")
            .TextMatrix(.Rows - 1, 3) = rs("InvBID")
            .TextMatrix(.Rows - 1, 4) = rs("Lote")
            .TextMatrix(.Rows - 1, 5) = rs("Localizacao")
            .TextMatrix(.Rows - 1, 6) = IIf(IsNull(rs("NomeCamaraFria")), "", rs("NomeCamaraFria"))
            .TextMatrix(.Rows - 1, 7) = IIf(IsNull(rs("Endereco")), "", rs("Endereco"))
            .TextMatrix(.Rows - 1, 8) = IIf(IsNull(rs("Comentario")), "", rs("Comentario"))
            .TextMatrix(.Rows - 1, 9) = "q"
            .TextMatrix(.Rows - 1, 10) = ""
        
            .col = 9
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
        
            .col = 11
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            If rs("Buffer") Then
                .Text = "|fffd|"
            Else
                .Text = "q"
            End If
        End With
        
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
End Sub
Attribute VB_Name = "form_contador"
Attribute VB_Base = "0{53331ABE-9E6A-4AAD-BD58-CBCE441C6DBD}{D1828A0D-B8A2-40C2-89CB-C2959E19AF60}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim LinSelect As Integer
Dim ColSelect As Integer

Dim PrimeiraLetra As Boolean

Private Sub Cadastrados_Click()
    LinSelect = Cadastrados.RowSel
    
    If LinSelect > 0 Then
        edtCodigo.Text = Cadastrados.TextMatrix(LinSelect, 0)
        edtResponsavel.Text = Cadastrados.TextMatrix(LinSelect, 1)
        cmbStatus.Text = Cadastrados.TextMatrix(LinSelect, 2)
    End If
End Sub

Private Sub edtResponsavel_Change()
    edtResponsavel.Text = UCase(edtResponsavel.Text)
End Sub

Private Sub Menu_ButtonClick(ByVal Button As MSComctlLib.Button)
    Select Case Button.Key
        Case Is = "Novo"
            Limpa_Campos
            Habilita_Campos True
            edtResponsavel.SetFocus
        Case Is = "Alterar"
            If edtCodigo.Text <> "" Then
                Habilita_Campos True
            End If
        Case Is = "Excluir"
            Excluir_Dados
        Case Is = "Cancelar"
            Limpa_Campos
            Habilita_Campos False
        Case Is = "Salvar"
            Salvar_Dados
    End Select
End Sub

Private Sub UserForm_Initialize()

    If con Is Nothing Then Conecta_Banco

    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    With Menu
        .ImageList = ImageList1
        .Buttons(1).Image = ImageList1.ListImages(1).Index
        .Buttons(3).Image = ImageList1.ListImages(2).Index
        .Buttons(5).Image = ImageList1.ListImages(3).Index
        .Buttons(7).Image = ImageList1.ListImages(4).Index
        .Buttons(9).Image = ImageList1.ListImages(5).Index
        .Left = (Me.Width - .Width) / 2
    End With

    With Cadastrados
        .Clear
        .Rows = 1
        .Cols = 3
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarVertical
        .AllowBigSelection = False
        .TextMatrix(0, 0) = "Contador"
        .TextMatrix(0, 1) = "Respons|fffd|vel"
        .TextMatrix(0, 2) = "Status"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .FixedAlignment(2) = 4
        .ColWidth(0) = 1000
        .ColWidth(1) = 4000
        .ColWidth(2) = 1600
        .ColAlignment(0) = 4
        .ColAlignment(1) = 1
        .ColAlignment(2) = 1
    End With
    
    With cmbStatus
        .AddItem "Liberado"
        .AddItem "Em Manuten|fffd||fffd|o"
    End With
    
    Call Centralizar(Me)
    
    Limpa_Campos
    Habilita_Campos False
    Mostra_Cadastrados
End Sub

Private Sub Limpa_Campos()
    edtCodigo.Text = ""
    edtResponsavel.Text = ""
    cmbStatus.Text = ""
End Sub

Private Sub Habilita_Campos(status As Boolean)
    edtCodigo.Enabled = False
    edtResponsavel.Enabled = status
    If cmbStatus.Text <> "Em Uso" Then cmbStatus.Enabled = status
    
    With Menu
        .Buttons(1).Enabled = Not status
        .Buttons(3).Enabled = Not status
        .Buttons(5).Enabled = Not status
        .Buttons(7).Enabled = status
        .Buttons(9).Enabled = status
    End With
    
    Cadastrados.Enabled = Not status
    
End Sub

Private Sub Mostra_Cadastrados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    Set rs = New ADODB.Recordset
    sql = "SELECT * FROM tab_contador ORDER BY ID_Contador"
    rs.Open sql, con
    
    Cadastrados.Rows = 1
    
    While Not rs.EOF
        With Cadastrados
            .Rows = .Rows + 1
        
            .TextMatrix(.Rows - 1, 0) = rs("ID_Contador")
            .TextMatrix(.Rows - 1, 1) = rs("Responsavel")
            .TextMatrix(.Rows - 1, 2) = rs("Status")
         End With
         
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing

End Sub

Private Sub Salvar_Dados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim cont As Integer
    
    If edtResponsavel.Text = "" Or _
       cmbStatus.Text = "" Then
       MsgBox "Todos os campos s|fffd|o obrigat|fffd|rios.", vbInformation, "Salvar"
       Exit Sub
    End If
    
    If edtCodigo.Text = "" Then
        sql = "INSERT INTO tab_contador (Responsavel, Status) " & _
                    "VALUES ('" & edtResponsavel.Text & "','" & cmbStatus.Text & "')"
    Else
        sql = "UPDATE tab_contador SET Responsavel = '" & edtResponsavel.Text & "', " & _
                                       "Status = '" & cmbStatus.Text & "' " & _
              "WHERE ID_Contador = " & edtCodigo.Text
    End If
    
    con.Execute sql
    
    If edtCodigo = "" Then
        sql = "SELECT TOP 1 ID_Contador FROM tab_contador ORDER BY ID_Contador DESC"
        Set rs = New ADODB.Recordset
        rs.Open sql, con
        edtCodigo.Text = rs("ID_Contador")
        rs.Close
        Set rs = Nothing
    End If
    
    Mostra_Cadastrados
    
    Habilita_Campos False
End Sub

Private Sub Excluir_Dados()
    Dim sql As String
    
    If edtCodigo.Text <> "" Then
        If MsgBox("Deseja realmente excluir este contador ?", vbYesNo + vbInformation + vbDefaultButton2, "Exclus|fffd|o") = vbYes Then
            sql = "DELETE * FROM tab_contador WHERE ID_Contador = " & edtCodigo.Text
            con.Execute sql
        End If
            
        Limpa_Campos
        Habilita_Campos False
        Mostra_Cadastrados
    End If
End Sub
Attribute VB_Name = "form_fieldbook"
Attribute VB_Base = "0{B3B96184-05EE-46FA-B5A9-D35D1F8619C7}{402EB258-460D-43C1-A963-11CBC5E87F1E}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim SafraAtual      As String
Dim Margem          As Double

Dim ColSelecionada  As Integer
Dim LinSelecionada  As Long
Dim frm             As Object

Private Sub Cadastrados_DblClick()
    If LinSelecionada = 0 Then
    
        Set frm = New form_filtro
        frm.Tabela = "tab_fieldbook"
        frm.Campo = Cadastrados.TextMatrix(0, ColSelecionada)
            
        frm.Show
        
        Monta_Cadastrados
    End If
End Sub

Private Sub Cadastrados_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    LinSelecionada = Cadastrados.MouseRow
    ColSelecionada = Cadastrados.MouseCol
End Sub

Private Sub chkBuffers_Click()
    Monta_Cadastrados
End Sub

Private Sub chkCheckContagem_Click()
    Monta_Cadastrados
End Sub

Private Sub chkCheckSorteio_Click()
    Monta_Cadastrados
End Sub

Private Sub chkEtiquetaImpressa_Click()
    Monta_Cadastrados
End Sub

Private Sub chkOutras_Click()
    Monta_Cadastrados
End Sub

Private Sub chkPlotDeactivated_Click()
    Monta_Cadastrados
End Sub

Private Sub Menu_ButtonClick(ByVal Button As MSComctlLib.Button)
    Select Case Button.Key
        Case Is = "Importar"
            Importar_FieldBook
            Monta_Cadastrados
    End Select
End Sub

Private Sub UserForm_Initialize()
    Dim col As Integer
    
    If con Is Nothing Then Conecta_Banco
'    usuario = "ROBSO"
'    CorFundoTela = RGB(229, 239, 218)
    
    SafraAtual = Pega_Safra
    Margem = Pega_Margem

    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    Call Maximizar(Me)
    
    Label6.Top = Me.Height - Label6.Height - 30
    Label6.Caption = "Total de registros visualizados: 0"
    
    ProgressBar1.Visible = False
    LProgressBar.Visible = False
    LProcesso.Visible = False
    
    ProgressBar1.Left = Me.Width - LProgressBar.Width - ProgressBar1.Width - 20
    LProgressBar.Left = Me.Width - LProgressBar.Width - 10
    LProcesso.Left = Me.Width - LProcesso.Width - 20
    
    With Menu
        .ImageList = ImageList1
        .Buttons(1).Image = ImageList1.ListImages(1).Index
        .Left = (Me.Width - .Width) / 2
    End With
    
    With Cadastrados
        .Clear
        .Left = 6
        .Width = Me.Width - 14
        .Height = Me.Height - .Top - Label6.Height - 50
        .Rows = 2
        .Cols = 46
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .WordWrap = True
        .RowHeight(0) = 720
        .RowHeight(1) = 0
        .AllowUserResizing = flexResizeColumns
        
        .TextMatrix(0, 0) = "Season"
        .TextMatrix(0, 1) = "Plot" & vbNewLine & "Deactivated"
        .TextMatrix(0, 2) = "Deactivation" & vbNewLine & "Reason"
        .TextMatrix(0, 3) = "Orig" & vbNewLine & "Proj"
        .TextMatrix(0, 4) = "Grower" & vbNewLine & "Proj"
        .TextMatrix(0, 5) = "Loc"
        .TextMatrix(0, 6) = "Set"
        .TextMatrix(0, 7) = "Field"
        .TextMatrix(0, 8) = "Crop"
        .TextMatrix(0, 9) = "Plot BID"
        .TextMatrix(0, 10) = "Entry#"
        .TextMatrix(0, 11) = "TrackID"
        .TextMatrix(0, 12) = "Rep#"
        .TextMatrix(0, 13) = "AbsR"
        .TextMatrix(0, 14) = "AbsC"
        .TextMatrix(0, 15) = "Plot#"
        .TextMatrix(0, 16) = "Pedigree"
        .TextMatrix(0, 17) = "Inv BID"
        .TextMatrix(0, 18) = "Group 1"
        .TextMatrix(0, 19) = "Group 2"
        .TextMatrix(0, 20) = "Group 3"
        .TextMatrix(0, 21) = "Track Parameters" & vbNewLine & "Harv Rows/Plot"
        .TextMatrix(0, 22) = "Track Parameters" & vbNewLine & "Harv Type"
        .TextMatrix(0, 23) = "Track Parameters" & vbNewLine & "Packets/Plot"
        .TextMatrix(0, 24) = "Track Parameters" & vbNewLine & "Ranges/Plot"
        .TextMatrix(0, 25) = "Track Parameters" & vbNewLine & "Rows/Plot"
        .TextMatrix(0, 26) = "Track Parameters" & vbNewLine & "Seeds/Packet"
        .TextMatrix(0, 27) = "Track Parameters" & vbNewLine & "Track Intent"
        .TextMatrix(0, 28) = "Track Parameters" & vbNewLine & "Track Intent Comment"
        .TextMatrix(0, 29) = "Grower Program"
        .TextMatrix(0, 30) = "Planted Plot" & vbNewLine & "Length"
        .TextMatrix(0, 31) = "Planted Plot" & vbNewLine & "Width"
        .TextMatrix(0, 32) = "Seeds/Packet"
        .TextMatrix(0, 33) = "Treatment Name"
        .TextMatrix(0, 34) = "Etiqueta" & vbNewLine & "Impressa"
        .TextMatrix(0, 35) = "Data Impress|fffd|o"
        .TextMatrix(0, 36) = "Usu|fffd|rio" & vbNewLine & "Impress|fffd|o"
        .TextMatrix(0, 37) = "Check" & vbNewLine & "Contagem"
        .TextMatrix(0, 38) = "Data Check" & vbNewLine & "Contagem"
        .TextMatrix(0, 39) = "Usu|fffd|rio Check" & vbNewLine & "Contagem"
        .TextMatrix(0, 40) = "Check" & vbNewLine & "Sorteio"
        .TextMatrix(0, 41) = "Data Check" & vbNewLine & "Sorteio"
        .TextMatrix(0, 42) = "Usu|fffd|rio Check" & vbNewLine & "Sorteio"
        .TextMatrix(0, 43) = "Mapa" & vbNewLine & "Gerado"
        .TextMatrix(0, 44) = "Data Mapa" & vbNewLine & "Gerado"
        .TextMatrix(0, 45) = "Usu|fffd|rio Mapa" & vbNewLine & "Gerado"
        
        For col = 0 To .Cols - 1
            .FixedAlignment(col) = 4
            .ColWidth(col) = 800
            Select Case col
                Case 1, 3, 4, 5, 10, 11, 12, 13, 14, 15, 21, 22, 23, 24, 25, 26, 30, 31, 32, 34, 35, 37, 38, 40, 41, 43, 44
                    .ColAlignment(col) = 4
                Case Else
                    .ColAlignment(col) = 1
            End Select
        Next col
        
        .FixedCols = 0
        .FixedRows = 1
    End With
    
    Monta_Cadastrados

End Sub

Private Sub Monta_Cadastrados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim cont As Integer
    
    Dim filtro As String
    Dim filtro2 As String
    
    Set rs = New ADODB.Recordset
    
    filtro2 = ""
    rs.Open "SELECT * FROM tab_filtro WHERE Usuario='" & usuario & "' and Tabela='tab_fieldbook' ORDER BY Campo", con
    While Not rs.EOF
        If filtro2 <> "" Then
            If InStr(1, filtro2, rs("Campo")) = 0 Then
                filtro2 = filtro2 & ") and ("
            Else
                filtro2 = filtro2 & " or "
            End If
        Else
            filtro2 = filtro2 & "("
        End If
        If IsNull(rs("ID")) Then
            filtro2 = filtro2 & "f.[" & rs("CAMPO") & "]"
            If IsNumeric(rs("Conteudo")) Then
                filtro2 = filtro2 & "=" & rs("Conteudo")
            Else
                filtro2 = filtro2 & IIf(IsNull(rs("Conteudo")), " is null", IIf(rs("Conteudo") = "", " is null", "='" & rs("Conteudo") & "'"))
            End If
        Else
            If rs("Campo") = "Pedigree" Then
                filtro2 = filtro2 & "f.[ID_Material]=" & rs("ID")
            Else
                filtro2 = filtro2 & "f.[" & rs("Campo") & "]=" & rs("ID")
            End If
        End If
    
        rs.MoveNext
    Wend
    rs.Close
    If filtro2 <> "" Then filtro2 = filtro2 & ")"
    
    sql = "SELECT f.*, op.CodigoPrograma as CPOrigProj, GP.CodigoPrograma as GPGrowerProj, " & _
                  "(SELECT M.Pedigree FROM tab_materialPrograma as MP " & _
                  "INNER JOIN tab_material as M on M.ID_Material = MP.ID_Material " & _
                  "WHERE MP.ID_Programa = IIF(IsNull(f.[Orig Proj]),OM.ID_Programa, f.[Orig Proj]) and MP.InvBid = f.[Inv Bid]) as [Pedigree] " & _
          "FROM (((tab_fieldbook as f " & _
          "LEFT JOIN tab_programa as op on op.ID_Programa = f.[Orig Proj]) " & _
          "LEFT JOIN tab_programa as gp on gp.ID_Programa = f.[Grower Proj]) " & _
          "LEFT JOIN tab_programa as om on om.CodigoPrograma = Mid(f.[Inv BID],2,3)) " & _
          "WHERE F.Season = '" & SafraAtual & "' "
          
    If filtro2 <> "" Then sql = sql & " and " & filtro2
    
    filtro = ""
    If chkEtiquetaImpressa Then
        filtro = filtro & "(f.etiquetaimpressa = true and f.checkcontagem = false)"
    End If
    If chkCheckContagem Then
        If filtro <> "" Then filtro = filtro & " or "
        filtro = filtro & "(f.etiquetaimpressa = true and f.checkcontagem = true and f.checksorteio = false)"
    End If
    If chkCheckSorteio Then
        If filtro <> "" Then filtro = filtro & " or "
        filtro = filtro & "(f.etiquetaimpressa = true and f.checkcontagem = true and f.checksorteio = true)"
    End If
    If chkPlotDeactivated Then
        If filtro <> "" Then filtro = filtro & " or "
        filtro = filtro & "(f.[plot deactivated] = true)"
    End If
    If chkBuffers Then
        If filtro <> "" Then filtro = filtro & " or "
        filtro = filtro & "(f.[Set] is null)"
    End If
    If chkOutras Then
        If filtro <> "" Then filtro = filtro & " or "
        filtro = filtro & "(f.etiquetaimpressa = false and f.checkcontagem = false and " & _
                           "f.checksorteio = false and f.[plot deactivated] = false and f.[set] <> '')"
    End If
    
    If filtro = "" Then filtro = "f.[Inv BID] is null"
    
    sql = sql & " and (" & filtro & ") ORDER BY Field, AbsR, AbsC"
    
    rs.Open sql, con
    
    Application.Cursor = xlWait
    
    With Cadastrados
        .Visible = False
        .Rows = 2
    End With
    
    While Not rs.EOF
        With Cadastrados
            
            .Rows = .Rows + 1
        
            .TextMatrix(.Rows - 1, 0) = rs("Season")

            .col = 1
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            
            .Text = IIf(rs("Plot Deactivated"), "|fffd|", "q")
            
            .TextMatrix(.Rows - 1, 2) = IIf(IsNull(rs("Deactivation Description")), "", rs("Deactivation Description"))
            .TextMatrix(.Rows - 1, 3) = IIf(IsNull(rs("CPOrigProj")), "", rs("CPOrigProj"))
            .TextMatrix(.Rows - 1, 4) = IIf(IsNull(rs("GPGrowerProj")), "", rs("GPGrowerProj"))
            .TextMatrix(.Rows - 1, 5) = IIf(IsNull(rs("Loc")), "", rs("Loc"))
            .TextMatrix(.Rows - 1, 6) = IIf(IsNull(rs("Set")), "", rs("Set"))
            .TextMatrix(.Rows - 1, 7) = rs("Field")
            .TextMatrix(.Rows - 1, 8) = IIf(IsNull(rs("Crop")), "", rs("Crop"))
            .TextMatrix(.Rows - 1, 9) = rs("Plot BID")
            .TextMatrix(.Rows - 1, 10) = IIf(IsNull(rs("Entry#")), "", rs("Entry#"))
            .TextMatrix(.Rows - 1, 11) = IIf(IsNull(rs("TrackID")), "", rs("TrackID"))
            .TextMatrix(.Rows - 1, 12) = rs("Rep#")
            .TextMatrix(.Rows - 1, 13) = rs("AbsR")
            .TextMatrix(.Rows - 1, 14) = rs("AbsC")
            .TextMatrix(.Rows - 1, 15) = IIf(IsNull(rs("Plot#")), "", rs("Plot#"))
            .TextMatrix(.Rows - 1, 16) = rs("Pedigree")
            .TextMatrix(.Rows - 1, 17) = rs("Inv BID")
            .TextMatrix(.Rows - 1, 18) = IIf(IsNull(rs("Group 1")), "", rs("Group 1"))
            .TextMatrix(.Rows - 1, 19) = IIf(IsNull(rs("Group 2")), "", rs("Group 2"))
            .TextMatrix(.Rows - 1, 20) = IIf(IsNull(rs("Group 3")), "", rs("Group 3"))
            .TextMatrix(.Rows - 1, 21) = IIf(IsNull(rs("Track Parameters Harv Rows/Plot")), "", rs("Track Parameters Harv Rows/Plot"))
            .TextMatrix(.Rows - 1, 22) = IIf(IsNull(rs("Track Parameters Harv Type")), "", rs("Track Parameters Harv Type"))
            .TextMatrix(.Rows - 1, 23) = IIf(IsNull(rs("Track Parameters Packets/Plot")), "", rs("Track Parameters Packets/Plot"))
            .TextMatrix(.Rows - 1, 24) = IIf(IsNull(rs("Track Parameters Ranges/Plot")), "", rs("Track Parameters Ranges/Plot"))
            .TextMatrix(.Rows - 1, 25) = IIf(IsNull(rs("Track Parameters Rows/Plot")), "", rs("Track Parameters Rows/Plot"))
            .TextMatrix(.Rows - 1, 26) = IIf(IsNull(rs("Track Parameters Seeds/Packet")), "", rs("Track Parameters Seeds/Packet"))
            .TextMatrix(.Rows - 1, 27) = IIf(IsNull(rs("Track Parameters Track Intent")), "", rs("Track Parameters Track Intent"))
            .TextMatrix(.Rows - 1, 28) = IIf(IsNull(rs("Track Parameters Track Intent Comment")), "", rs("Track Parameters Track Intent Comment"))
            .TextMatrix(.Rows - 1, 29) = IIf(IsNull(rs("Grower Program")), "", rs("Grower Program"))
            .TextMatrix(.Rows - 1, 30) = IIf(IsNull(rs("Planted Plot Length")), "", rs("Planted Plot Length"))
            .TextMatrix(.Rows - 1, 31) = IIf(IsNull(rs("Planted Plot Width")), "", rs("Planted Plot Width"))
            .TextMatrix(.Rows - 1, 32) = IIf(IsNull(rs("Seeds/Packet")), "", rs("Seeds/Packet"))
            .TextMatrix(.Rows - 1, 33) = IIf(IsNull(rs("Treatment Name")), "", rs("Treatment Name"))
        
            .col = 34
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            .Text = IIf(rs("EtiquetaImpressa"), "|fffd|", "q")
            
            If IsNull(rs("DataImpressaoEtiqueta")) Then
                .TextMatrix(.Rows - 1, 35) = ""
            Else
                .TextMatrix(.Rows - 1, 35) = Format(rs("DataImpressaoEtiqueta"), "dd/mmm/yyyy")
            End If
            .TextMatrix(.Rows - 1, 36) = IIf(IsNull(rs("UsuarioImpressaoEtiqueta")), "", rs("UsuarioImpressaoEtiqueta"))
            
            .col = 37
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            .Text = IIf(rs("CheckContagem"), "|fffd|", "q")
            
            If IsNull(rs("DataCheckContagem")) Then
                .TextMatrix(.Rows - 1, 38) = ""
            Else
                .TextMatrix(.Rows - 1, 38) = Format(rs("DataCheckContagem"), "dd/mmm/yyyy")
            End If
            .TextMatrix(.Rows - 1, 39) = IIf(IsNull(rs("UsuarioCheckContagem")), "", rs("UsuarioCheckContagem"))
        
            .col = 40
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            .Text = IIf(rs("CheckSorteio"), "|fffd|", "q")
            
            If IsNull(rs("DataCheckSorteio")) Then
                .TextMatrix(.Rows - 1, 41) = ""
            Else
                .TextMatrix(.Rows - 1, 41) = Format(rs("DataCheckSorteio"), "dd/mmm/yyyy")
            End If
            .TextMatrix(.Rows - 1, 42) = IIf(IsNull(rs("UsuarioCheckSorteio")), "", rs("UsuarioCheckSorteio"))
        
            .col = 43
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            .Text = IIf(rs("MapaGerado"), "|fffd|", "q")
            
            If IsNull(rs("DataMapa")) Then
                .TextMatrix(.Rows - 1, 44) = ""
            Else
                .TextMatrix(.Rows - 1, 44) = Format(rs("DataMapa"), "dd/mmm/yyyy")
            End If
            .TextMatrix(.Rows - 1, 45) = IIf(IsNull(rs("UsuarioMapa")), "", rs("UsuarioMapa"))
            
            If IsNull(rs("Set")) Then
                For cont = 0 To .Cols - 1
                    .col = cont
                    .CellBackColor = &HC0C0FF
                Next cont
            End If
            
            If rs("Plot Deactivated") Then
                For cont = 0 To .Cols - 1
                    .col = cont
                    .CellBackColor = &HFF&
                    .CellForeColor = &HFFFFFF
                Next cont
            End If
            
            If rs("EtiquetaImpressa") Or rs("CheckContagem") Or rs("CheckSorteio") Then
                For cont = 0 To .Cols - 1
                    .col = cont
                    If rs("EtiquetaImpressa") Then .CellBackColor = &HC0FFFF
                    If rs("CheckContagem") Then .CellBackColor = &HFFFFC0
                    If rs("CheckSorteio") Then .CellBackColor = &HC0FFC0
                Next cont
            End If
            
         End With
         
        rs.MoveNext
    Wend
    
    Pinta_Coluna_Filtro
    
    Application.Cursor = xlDefault
    
    Cadastrados.Visible = True
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Cadastrados, 0, 45
    
    Label6.Caption = "Total de registros visualizados: " & Format(Cadastrados.Rows - 1, "#,##0")
    
End Sub

Private Sub Importar_FieldBook()
    Dim arquivo             As String
    Dim wb                  As Workbook
    Dim SH                  As Worksheet
    Dim lin                 As Long
    Dim col                 As Integer
    Dim cont                As Integer
    Dim totLin              As Long
    Dim totCol              As Integer
    Dim rs                  As ADODB.Recordset
    Dim rs1                 As ADODB.Recordset
    Dim sql                 As String
    Dim seasonAtual         As String
    Dim linhasProblema      As String
    Dim Encerrar            As Boolean
    
    Dim colunas             As Variant
    Dim faltaColunas        As Boolean
    Dim pula                As Boolean
    
    Dim fieldsExistentes()  As String
    
    Dim idOrigProj          As Long
    Dim idGrowerProj        As Long
    Dim idOrigMat           As Long
    Dim idMaterial          As Long
    
    Dim matReg              As Boolean
    Dim matSts              As Boolean
    Dim seedPackts          As Integer
    
    arquivo = Localizar_Arquivo
    If arquivo = "" Then Exit Sub
    
    Set rs = New ADODB.Recordset
    
    rs.Open "SELECT * FROM tab_parametro", con
    seasonAtual = rs("SafraAtual")
    rs.Close
    
    Set wb = Workbooks.Open(arquivo, False, False)
    Set SH = wb.Worksheets(1)
    
    With SH
        .Activate
        .Range("a1").Select
        ActiveCell.SpecialCells(xlLastCell).Select
        totLin = Selection.Row
        totCol = Selection.Column
        .Range("A1").Select
    End With
    
    If totLin = 1 Then GoTo fim
    
    ThisWorkbook.Activate
    
    rs.Open "SELECT * FROM tab_fieldbook", con
    
    ReDim colunas(rs.fields.Count - 18)
    
    For cont = LBound(colunas) To UBound(colunas)
        colunas(cont) = 0
    Next cont
    
    For col = 1 To totCol
        With SH
            For cont = LBound(colunas) To UBound(colunas)
                If .Cells(1, col) = rs.fields(cont).Name Or _
                   (.Cells(1, col) = "Prod" And rs.fields(cont).Name = "ID_Material") Then
                    colunas(cont) = col
                    Exit For
                End If
            Next cont
        End With
    Next col
    
    sql = ""
    
    faltaColunas = False
    For cont = LBound(colunas) To UBound(colunas)
        If colunas(cont) = 0 Then
            sql = sql & vbNewLine & vbTab & IIf(rs.fields(cont).Name = "ID_Material", "Prod", rs.fields(cont).Name)
            
            faltaColunas = True
            Exit For
        End If
    Next cont
    
    If faltaColunas Then
        sql = "As colunas abaixo listadas n|fffd|o foram encontradas." & vbNewLine & _
              "Verifique a existencia de todas as colunas e se elas n|fffd|o contem espa|fffd|os a mais em seus nomes." & _
              vbNewLine & sql
        
        MsgBox sql, vbInformation, "Importa|fffd||fffd|o"
        
        GoTo fim
    End If
    
    rs.Close
    Set rs = Nothing
    
    ProgressBar1.Max = totLin
    ProgressBar1.min = 0
    ProgressBar1.Value = 0
    LProgressBar.Caption = "0%"
    LProcesso.Caption = "Verificando existencia de dados"
    
    ProgressBar1.Visible = True
    LProgressBar.Visible = True
    LProcesso.Visible = True
    
    sql = ""
    For lin = 2 To totLin
        ProgressBar1.Value = lin
        LProgressBar.Caption = Format(lin / totLin, "0%")
        
        DoEvents
        
        With SH
            If .Cells(lin, colunas(7)) <> "" Then
                If InStr(1, sql, .Cells(lin, colunas(7))) = 0 Then
                    If sql <> "" Then sql = sql & "#"
                    sql = sql & .Cells(lin, colunas(7))
                End If
            End If
        End With
    Next lin
    
    fieldsExistentes = Split(sql, "#")
    Encerrar = False
    For lin = LBound(fieldsExistentes) To UBound(fieldsExistentes)
        sql = "SELECT * FROM tab_fieldbook WHERE Field ='" & fieldsExistentes(lin) & "'"
        Set rs = New ADODB.Recordset
        rs.Open sql, con
        If Not rs.EOF Then
            If MsgBox("Neste arquivo existe fields que j|fffd| foram importados." & vbNewLine & _
                      "Deseja substitu|fffd|los ?" & vbNewLine & _
                      "Caso substitua todos os processos j|fffd| executados ser|fffd|o perdidos.", vbYesNo + vbInformation + vbDefaultButton2, "Importa|fffd||fffd|o") = vbNo Then
                GoTo fim
            End If
            Encerrar = True
        End If
        rs.Close
        If Encerrar Then Exit For
    Next lin
    
    For lin = LBound(fieldsExistentes) To UBound(fieldsExistentes)
        con.Execute "DELETE * FROM tab_fieldbook WHERE Field ='" & fieldsExistentes(lin) & "'"
    Next lin
    
    linhasProblema = ""
    
    ProgressBar1.Max = totLin
    ProgressBar1.min = 0
    ProgressBar1.Value = 0
    LProgressBar.Caption = "0%"
    LProcesso.Caption = "Importando dados"
    
    For lin = 2 To totLin
        
        ProgressBar1.Value = lin
        LProgressBar.Caption = Format(lin / totLin, "0%")
        
        DoEvents
        
        With SH
            If .Cells(lin, colunas(0)) <> seasonAtual Then
                If linhasProblema <> "" Then linhasProblema = linhasProblema & vbNewLine
                linhasProblema = linhasProblema & "Linha " & CStr(lin) & " / Safra " & .Cells(lin, colunas(0))
            Else
                idOrigProj = 0
                pula = False
                If .Cells(lin, colunas(3)) <> "" Then
                    rs.Open "SELECT * FROM tab_programa WHERE CodigoPrograma='" & .Cells(lin, colunas(3)) & "'", con
                    If rs.EOF Then
                        If linhasProblema <> "" Then linhasProblema = linhasProblema & vbNewLine
                        linhasProblema = linhasProblema & "Linha " & CStr(lin) & " / Orig Proj " & .Cells(lin, colunas(3))
                        pula = True
                    Else
                        idOrigProj = rs("id_programa")
                    End If
                    rs.Close
                End If
                If Not pula And idOrigProj = 0 Then
                    idOrigMat = 0
                    rs.Open "SELECT * FROM tab_programa WHERE CodigoPrograma='" & Mid(.Cells(lin, colunas(17)), 2, 3) & "'", con
                    If rs.EOF Then
                        If linhasProblema <> "" Then linhasProblema = linhasProblema & vbNewLine
                        linhasProblema = linhasProblema & "Linha " & CStr(lin) & " / Programa do InvBID " & Mid(.Cells(lin, colunas(17)), 2, 3)
                        pula = True
                    Else
                        idOrigMat = rs("id_programa")
                    End If
                    rs.Close
                End If
                
                If Not pula Then
                    idGrowerProj = 0
                    If .Cells(lin, colunas(4)) <> "" Then
                        rs.Open "SELECT * FROM tab_programa WHERE CodigoPrograma='" & .Cells(lin, colunas(4)) & "'", con
                        If rs.EOF Then
                            If linhasProblema <> "" Then linhasProblema = linhasProblema & vbNewLine
                            linhasProblema = linhasProblema & "Linha " & CStr(lin) & " / Grower Proj " & .Cells(lin, colunas(4))
                            pula = True
                        Else
                            idGrowerProj = rs("id_programa")
                        End If
                        rs.Close
                    End If
                End If
                
                If Not pula Then
                    idMaterial = 0
                    matReg = False
                    matSts = False
                    rs.Open "SELECT M.id_material, M.regulatorio, M.stewardship FROM tab_materialPrograma as MP " & _
                            "INNER JOIN tab_material as M on M.ID_Material = MP.ID_Material " & _
                            "WHERE MP.ID_Programa = " & IIf(idOrigProj = 0, idOrigMat, idOrigProj) & " and MP.InvBid = '" & .Cells(lin, colunas(17)) & "'", con
                    If rs.EOF Then
                        If linhasProblema <> "" Then linhasProblema = linhasProblema & vbNewLine
                        linhasProblema = linhasProblema & "Linha " & CStr(lin) & " / Pedigree " & .Cells(lin, colunas(17))
                        pula = True
                    Else
                        idMaterial = rs("id_Material")
                        matReg = rs("Regulatorio")
                        matSts = rs("StewardShip")
                    End If
                    rs.Close
                End If
                
                If Not pula Then
                    seedPackts = 0
                    
                    If .Cells(lin, colunas(6)) <> "" Then
                        sql = "SELECT T.QtdeSementes " & _
                              "FROM tab_protocolotratamento as T " & _
                              "WHERE T.ID_Protocolo in (SELECT ID_PROTOCOLO FROM tab_protocolo WHERE [SET]='" & .Cells(lin, colunas(6)) & "')"
                        If .Cells(lin, colunas(33)) <> "" Then
                            sql = sql & " AND T.Descricaotratamento = '" & .Cells(lin, colunas(33)) & "'"
                        End If
                        rs.Open sql, con
                        If rs.EOF Then
                            rs.Close
                            sql = "SELECT T.QtdeSementes " & _
                                  "FROM tab_protocolotratamento as T " & _
                                  "WHERE T.ID_Protocolo in (SELECT ID_PROTOCOLO FROM tab_protocolo WHERE [SET]='" & .Cells(lin, colunas(6)) & "')"
                            rs.Open sql, con
                            If rs.EOF Then
                                If linhasProblema <> "" Then linhasProblema = linhasProblema & vbNewLine
                                linhasProblema = linhasProblema & "Linha " & CStr(lin) & " / QtdeSementes N|fffd|o Localizadas"
                                pula = True
                            Else
                                seedPackts = rs("QtdeSementes")
                            End If
                        Else
                            seedPackts = rs("QtdeSementes")
                        End If
                        rs.Close
                    End If
                End If
                
                If Not pula Then
                    sql = "INSERT INTO tab_fieldbook VALUES ("
                    For cont = LBound(colunas) To UBound(colunas)
'                        If cont >= LBound(colunas) And cont <= UBound(colunas) Then
                            If cont > LBound(colunas) Then sql = sql & ","
                            Select Case cont
                                Case 1, 10, 11, 12, 13, 14, 15
                                    sql = sql & IIf(.Cells(lin, colunas(cont)) = "", "null", Replace(.Cells(lin, colunas(cont)), ",", "."))
                                Case 3
                                    sql = sql & IIf(idOrigProj = 0, "null", idOrigProj)
                                Case 4
                                    sql = sql & IIf(idGrowerProj = 0, "null", idGrowerProj)
                                Case 16
                                    sql = sql & idMaterial
                                Case 21, 23, 24, 25, 26, 30, 31
                                    sql = sql & IIf(.Cells(lin, colunas(cont)) = "", "null", IIf(So_TemNumero(.Cells(lin, colunas(cont))), Replace(.Cells(lin, colunas(cont)), ",", "."), "null"))
                                Case 32
                                    sql = sql & seedPackts
                                Case Else
                                    sql = sql & IIf(.Cells(lin, colunas(cont)) = "", "null", "'" & Replace(.Cells(lin, colunas(cont)), ",", ".") & "'")
                            End Select
'                        End If
                    Next cont
                    sql = sql & "," & matReg & "," & matSts & ", false, null, null, false, null, null, false, null, null, false, null, false, null, null, false)"

                    con.Execute sql
                End If
            End If
        End With
    Next lin
    
    If linhasProblema <> "" Then
        MsgBox "As linhas abaixo relacionadas n|fffd|o foram" & vbNewLine & _
               "importadas devido a divergencias no banco de dados." & vbNewLine & _
               linhasProblema, vbInformation, "Importa|fffd||fffd|o"
    End If
    
fim:
    Set SH = Nothing
    wb.Close SaveChanges:=False
    Set wb = Nothing
    
    ProgressBar1.Visible = False
    LProgressBar.Visible = False
    LProcesso.Visible = False
    
End Sub

Private Sub Pinta_Coluna_Filtro()
    Dim rs As ADODB.Recordset
    Dim col As Integer
    Dim campo1 As String
    
    
    Set rs = New ADODB.Recordset
    
    With Cadastrados
        .Row = 0
        For col = 0 To .Cols - 1
            .col = col
            rs.Open "SELECT DISTINCT Campo FROM tab_filtro WHERE Usuario='" & usuario & "' and Tabela='tab_fieldbook' and Campo='" & Replace(.TextMatrix(0, col), vbNewLine, " ") & "'", con
            If rs.EOF Then
                .CellBackColor = &H8000000F
            Else
                .CellBackColor = &HFFC0C0
            End If
            rs.Close
        Next col
    End With
    
    Set rs = Nothing
End Sub
Attribute VB_Name = "form_filtro"
Attribute VB_Base = "0{8FFBFCDE-65EF-41CA-A4C1-8ECD1411B3A5}{E6679453-219E-4164-9D7A-A0468DE50702}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Public Tabela As String
Public Campo As String

Dim Processa As Boolean
Dim sql As String

Private Sub btnConfirma_Click()
    Dim lin As Long
    
    sql = "DELETE * FROM tab_filtro WHERE Usuario = '" & usuario & "' and Tabela = '" & Tabela & "' and campo = '" & Campo & "'"
    con.Execute sql
    
    With MSFG_Filtro
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                sql = "INSERT INTO tab_filtro (Usuario, tabela, Campo, ID, Conteudo) VALUES ('" & usuario & "', '" & Tabela & "', '" & Campo & "', " & IIf(.TextMatrix(lin, 2) = "", "null", "'" & .TextMatrix(lin, 2) & "'") & ", '" & .TextMatrix(lin, 1)
                sql = sql & "')"
                con.Execute sql
            End If
        Next lin
    End With
    
    Unload Me
End Sub

Private Sub chkSelecionar_Click()
    Dim lin As Long
    
    If Not Processa Then Exit Sub
    
    With MSFG_Filtro
        For lin = 1 To .Rows - 1
            .Row = lin
            .col = 0
            If chkSelecionar Then
                .Text = "|fffd|"
                .CellBackColor = &HE0E0E0
                .col = 1
                .CellBackColor = &HE0E0E0
            Else
                .Text = "q"
                .CellBackColor = &H80000005
                .col = 1
                .CellBackColor = &H80000005
            End If
        Next lin
    End With
End Sub

Private Sub edtFind_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim lin As Integer
    Dim achou As Boolean
    
    If KeyCode = vbKeyReturn Then
        If edtFind.Text = "" Then Exit Sub
        
        achou = False
        With MSFG_Filtro
            For lin = 1 To .Rows - 1
                If UCase(.TextMatrix(lin, 1)) = UCase(edtFind.Text) Then
                    .Row = lin
                    .col = 0
                    If .TextMatrix(lin, 0) = "|fffd|" Then
                        .TextMatrix(lin, 0) = "q"
                        .CellBackColor = &H80000005
                    Else
                        .TextMatrix(lin, 0) = "|fffd|"
                        .CellBackColor = &HE0E0E0
                    End If
                    .col = 1
                    If .TextMatrix(lin, 0) = "|fffd|" Then
                        .CellBackColor = &HE0E0E0
                    Else
                        .CellBackColor = &H80000005
                    End If
                    .TopRow = lin
                    
                    achou = True
                    Exit For
                End If
            Next lin
        End With
        
        If Not achou Then MsgBox "Item n|fffd|o encontrado.", vbInformation, "Filtro"
        
        edtFind.Text = ""
        edtFind.SetFocus
    End If
End Sub

Private Sub MSFG_Filtro_Click()
    Dim lin As Long
    Dim tudoSelecionado As Boolean
    
    If Not Processa Then Exit Sub
    
    With MSFG_Filtro
        If .MouseCol = 0 Then
            .col = 0
            If .TextMatrix(.Row, 0) = "q" Then
                .TextMatrix(.Row, 0) = "|fffd|"
                .CellBackColor = &HE0E0E0
            Else
                .TextMatrix(.Row, 0) = "q"
                .CellBackColor = &H80000005
            End If
            .col = 1
            If .TextMatrix(.Row, 0) = "|fffd|" Then
                .CellBackColor = &HE0E0E0
            Else
                .CellBackColor = &H80000005
            End If

        End If
        
        tudoSelecionado = True
        
        For lin = 1 To .Rows - 1
            .Row = lin
            .col = 0
            If .Text = "q" Then
                tudoSelecionado = False
                Exit For
            End If
        Next lin
        
        Processa = False
        chkSelecionar = tudoSelecionado
        Processa = True
    End With
End Sub

Private Sub UserForm_Activate()
    Dim sql As String
    
    Call Centralizar(Me)
    
    Campo = Replace(Campo, vbNewLine, " ")
    
    If Campo = "Pedigree" Then
        sql = "SELECT DISTINCT M.Pedigree, F.ID_Material FROM tab_material as M INNER JOIN tab_fieldbook as F on F.ID_Material = M.ID_Material ORDER BY M.Pedigree"
    ElseIf Campo = "Orig Proj" Or Campo = "Grower Proj" Then
        sql = "SELECT DISTINCT P.CodigoPrograma, P.ID_Programa FROM tab_programa as P INNER JOIN tab_fieldbook as F on F.[" & Campo & "] = P.CodigoPrograma ORDER BY P.CodigoPrograma"
    Else
        sql = "SELECT DISTINCT [" & Campo & "], '' FROM " & Tabela & " ORDER BY [" & Campo & "]"
    End If
    
    edtFind.Text = ""
    edtFind.SetFocus
    
    Mostra_Dados sql
    
End Sub

Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    Unload Me
End Sub

Private Sub Mostra_Dados(sql As String)
    Dim rs As ADODB.Recordset
    Dim lin As Long
    Dim achou As Boolean
    
    With MSFG_Filtro
        .Clear
        .Rows = 1
        .Cols = 3
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarVertical
        .AllowBigSelection = False
        .TextMatrix(0, 0) = "" ' Selecionado
        .TextMatrix(0, 1) = Campo
        .TextMatrix(0, 2) = "ID"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .FixedAlignment(2) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 3900
        .ColWidth(2) = 0
        .ColAlignment(0) = 1
        .ColAlignment(1) = 1
        .ColAlignment(2) = 1
        .FixedCols = 0
        
        Processa = False

        Set rs = New ADODB.Recordset
        rs.Open sql, con
            
        While Not rs.EOF
            .Rows = .Rows + 1
                
            .col = 0
            .Row = .Rows - 1
                
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
                
            .TextMatrix(.Rows - 1, 0) = "q"
            .TextMatrix(.Rows - 1, 1) = IIf(IsNull(rs(0)), "", rs(0))
            .TextMatrix(.Rows - 1, 2) = IIf(IsNull(rs(1)), "", rs(1))
            
            .CellBackColor = &H80000005
            .col = 1
            .CellBackColor = &H80000005
                
            rs.MoveNext
        Wend
        
        rs.Close
        Set rs = Nothing
        
        Processa = True
        
        Set rs = New ADODB.Recordset
        rs.Open "SELECT * FROM tab_filtro WHERE Usuario='" & usuario & "' and Tabela='" & Tabela & "' and Campo='" & Campo & "'", con
        
        While Not rs.EOF
            achou = False
            For lin = 1 To .Rows - 1
                .Row = lin
                If .TextMatrix(lin, 1) = rs("Conteudo") Then
                    .col = 0
                    .Text = "|fffd|"
                    .CellBackColor = &HE0E0E0
                    .col = 1
                    .CellBackColor = &HE0E0E0
                    achou = True
                    Exit For
                End If
            Next lin
            If Not achou Then
                rs.Delete
                rs.MoveFirst
            Else
                rs.MoveNext
            End If
        Wend
        
        rs.Close
        Set rs = Nothing
    End With
End Sub
Attribute VB_Name = "form_filtrosementes"
Attribute VB_Base = "0{4AA3B378-7975-4C99-92E4-1CE85952C7EE}{C230494F-1ADD-49D2-ABDF-F36245CAD7D0}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Public filtroSet    As Variant
Public filtroGrower As Variant
Public filtroLoc    As Variant
Public filtroRep    As Variant

Dim LinhaSel As Integer

Private Sub btnConfirmar_Click()
    Dim lin As Integer
    
    filtroSet = ""
    With Lista_Sets
        For lin = 1 To .Rows - 1
            If filtroSet <> "" Then filtroSet = filtroSet & ", "
            filtroSet = filtroSet & .TextMatrix(lin, 1) & "#" & .TextMatrix(lin, 0)
        Next lin
    End With
    
    filtroGrower = ""
    With Lista_Grower
        For lin = 1 To .Rows - 1
            If filtroGrower <> "" Then filtroGrower = filtroGrower & ", "
            filtroGrower = filtroGrower & .TextMatrix(lin, 1) & "#" & .TextMatrix(lin, 0)
        Next lin
    End With
    
    filtroLoc = ""
    With Lista_Location
        For lin = 1 To .Rows - 1
            If filtroLoc <> "" Then filtroLoc = filtroLoc & ", "
            filtroLoc = filtroLoc & .TextMatrix(lin, 1) & "#" & .TextMatrix(lin, 0)
        Next lin
    End With
    
    filtroRep = ""
    With Lista_Reps
        For lin = 1 To .Rows - 1
            If filtroRep <> "" Then filtroRep = filtroRep & ", "
            filtroRep = filtroRep & .TextMatrix(lin, 1) & "#" & .TextMatrix(lin, 0)
        Next lin
    End With
    
    filtrarS = filtroSet
    filtrarG = filtroGrower
    filtrarL = filtroLoc
    filtrarR = filtroRep
    
    Unload Me
End Sub

Private Sub Lista_Sets_Click()
    With Lista_Sets
        If LinhaSel > 0 Then
            If .TextMatrix(LinhaSel, 0) = "q" Then
                .TextMatrix(LinhaSel, 0) = "|fffd|"
            Else
                .TextMatrix(LinhaSel, 0) = "q"
            End If
        End If
    End With
End Sub

Private Sub Lista_Sets_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    LinhaSel = Lista_Sets.MouseRow
End Sub

Private Sub Lista_Grower_Click()
    With Lista_Grower
        If LinhaSel > 0 Then
            If .TextMatrix(LinhaSel, 0) = "q" Then
                .TextMatrix(LinhaSel, 0) = "|fffd|"
            Else
                .TextMatrix(LinhaSel, 0) = "q"
            End If
        End If
    End With
End Sub

Private Sub Lista_Grower_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    LinhaSel = Lista_Grower.MouseRow
End Sub

Private Sub Lista_Location_Click()
    With Lista_Location
        If LinhaSel > 0 Then
            If .TextMatrix(LinhaSel, 0) = "q" Then
                .TextMatrix(LinhaSel, 0) = "|fffd|"
            Else
                .TextMatrix(LinhaSel, 0) = "q"
            End If
        End If
    End With
End Sub

Private Sub Lista_Location_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    LinhaSel = Lista_Location.MouseRow
End Sub

Private Sub Lista_Reps_Click()
    With Lista_Reps
        If LinhaSel > 0 Then
            If .TextMatrix(LinhaSel, 0) = "q" Then
                .TextMatrix(LinhaSel, 0) = "|fffd|"
            Else
                .TextMatrix(LinhaSel, 0) = "q"
            End If
        End If
    End With
End Sub

Private Sub Lista_Reps_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    LinhaSel = Lista_Reps.MouseRow
End Sub

Private Sub UserForm_Activate()
    Dim cont As Integer
    Dim linhas As Variant
    Dim colunas As Variant
    Dim extra As Variant
    
    With Lista_Sets
        .Rows = 1
        
        linhas = Split(filtroSet, ", ")
        For cont = LBound(linhas) To UBound(linhas)
            colunas = Split(linhas(cont), "#")
            
            .Rows = .Rows + 1
            .Row = .Rows - 1
            
            .col = 0
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            
            .TextMatrix(.Row, 0) = colunas(1)
            .TextMatrix(.Row, 1) = colunas(0)
            
        Next cont
        
    End With
    
    With Lista_Grower
        .Rows = 1
        
        linhas = Split(filtroGrower, ", ")
        For cont = LBound(linhas) To UBound(linhas)
            colunas = Split(linhas(cont), "#")
            extra = Split(colunas(1), "/")
            
            .Rows = .Rows + 1
            .Row = .Rows - 1
            
            .col = 0
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            
            .TextMatrix(.Row, 0) = extra(0)
            .TextMatrix(.Row, 1) = extra(1)
            .TextMatrix(.Row, 2) = colunas(0)
            
        Next cont
        
    End With
    
    With Lista_Location
        .Rows = 1
        
        linhas = Split(filtroLoc, ", ")
        For cont = LBound(linhas) To UBound(linhas)
            colunas = Split(linhas(cont), "#")
            
            .Rows = .Rows + 1
            .Row = .Rows - 1
            
            .col = 0
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            
            .TextMatrix(.Row, 0) = colunas(1)
            .TextMatrix(.Row, 1) = colunas(0)
            
        Next cont
        
    End With
    
    With Lista_Reps
        .Rows = 1
        
        linhas = Split(filtroRep, ", ")
        For cont = LBound(linhas) To UBound(linhas)
            colunas = Split(linhas(cont), "#")
            
            .Rows = .Rows + 1
            .Row = .Rows - 1
            
            .col = 0
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            
            .TextMatrix(.Row, 0) = colunas(1)
            .TextMatrix(.Row, 1) = colunas(0)
            
        Next cont
        
    End With
End Sub

Private Sub UserForm_Initialize()
    Call Centralizar(Me)
    
    With Lista_Sets
        .Clear
        .Rows = 1
        .Cols = 2
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Set"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 2200
        .ColAlignment(0) = 4
        .ColAlignment(1) = 1
    End With
    
    With Lista_Grower
        .Clear
        .Rows = 1
        .Cols = 3
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "ID_Grower"
        .TextMatrix(0, 2) = "Grower"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 7
        .FixedAlignment(2) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 0
        .ColWidth(2) = 800
        .ColAlignment(0) = 4
        .ColAlignment(1) = 7
        .ColAlignment(2) = 4
    End With
    
    With Lista_Location
        .Clear
        .Rows = 1
        .Cols = 2
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Location"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 800
        .ColAlignment(0) = 4
        .ColAlignment(1) = 4
    End With
    
    With Lista_Reps
        .Clear
        .Rows = 1
        .Cols = 2
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Rep"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 500
        .ColAlignment(0) = 4
        .ColAlignment(1) = 4
    End With
End Sub
Attribute VB_Name = "form_imprimirbuffers"
Attribute VB_Base = "0{667800E7-3531-46FD-A545-A34CFADCBDB2}{2E9C9564-D335-40CF-ADCC-190FAFA06620}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim safra As String
Dim BufferPadrao As String
Dim Margem As Double

Dim MaterialRow As Integer
Dim MaterialCol As Integer
Dim FieldRow As Integer
Dim FieldCol As Integer

Dim PrimeiraLetra As Boolean

Dim itemSelected As Boolean

Private Sub btnExportar_Click()
    Dim lin As Integer
    Dim sql As String
    Dim btn As Variant
    
    btn = MsgBox("Marcar como impresso os materiais da listagem?", vbYesNoCancel + vbInformation, "Exportar")
    If btn = vbCancel Then
        Exit Sub
    ElseIf btn = vbYes Then
        With Lista_Imprimir
            For lin = 1 To .Rows - 1
                If .TextMatrix(lin, 13) <> "" Then
                    sql = "UPDATE tab_fieldbook SET " & _
                                "EtiquetaImpressa = true, " & _
                                "DataImpressaoEtiqueta = #" & Format(Date, "yyyy/mm/dd") & "#, " & _
                                "UsuarioImpressaoEtiqueta = '" & usuario & "', " & _
                                "[Seeds/Packet] = " & Pega_Valor(.TextMatrix(lin, 11)) & ", " & _
                                "Buffer = '" & .TextMatrix(lin, 13) & "' " & _
                           "WHERE [Plot BID]='" & .TextMatrix(lin, 5) & "'"
                    con.Execute sql
                End If
            Next lin
        End With
    End If
    
    Exportar Lista_Imprimir
End Sub

Private Sub btnImprimir_Click()
    Dim lin As Integer
    Dim sht As Worksheet
    Dim linhas As String
    
    Dim ContLin As Integer
    Dim ContCol As Integer
    
    Dim iRowStart As Integer
    Dim iRowEnd As Integer
    Dim Resp As Boolean
    Dim btn As Variant
    
    Dim sql As String
    
    Dim vLeft As Integer
    Dim vTop As Integer
    
    If Lista_Imprimir.Rows = 1 Then Exit Sub
    
    Set sht = ThisWorkbook.Sheets("Layout_Etiqueta")
    
    sht.Visible = xlSheetVisible
    sht.Activate
    
    iRowStart = Lista_Imprimir.Row
    iRowEnd = Lista_Imprimir.RowSel
    
    If itemSelected Then
        btn = MsgBox("Imprimir somente os itens selecionados ?", vbYesNoCancel + vbInformation, "Imprimir")
        If btn = vbCancel Then
            Exit Sub
        ElseIf btn = vbYes Then
            Resp = True
        Else
            Resp = False
        End If
    End If
    
    With Application
        btn = .Dialogs(xlDialogPrinterSetup).Show
        If btn = False Then Exit Sub
        .Cursor = xlWait
    End With
    
    Configura_Etiqueta
    
    With Lista_Imprimir
        ProgressBar1.Max = .Rows - 1
        ProgressBar1.min = 0
        ProgressBar1.Value = 0
        
        ProgressBar1.Visible = True
        Label6.Visible = True
        Label7.Visible = True
        
        ContLin = 0
        ContCol = 1
        
        Apagar_Objetos
        
        For lin = 1 To .Rows - 1
            ProgressBar1.Value = lin
            DoEvents
            
            If .TextMatrix(lin, 13) <> "" Then
                If (Not Resp) Or (Resp And lin >= iRowStart And lin <= iRowEnd) Then
                    
                    If ContLin = 10 And ContCol = 1 Then
                        sht.PrintOut
                        
                        Apagar_Objetos
                        ContLin = 0
                        ContCol = 1
                    End If
                    
                    If ContLin = 10 Then
                        ContLin = 0
                        ContCol = ContCol + 1
                    End If
                    ContLin = ContLin + 1
                    
                    vLeft = 44 + ((ContCol - 1) * 144)
                    vTop = 220 + ((ContLin - 1) * 585)
                    
                    Adicionar_Label vLeft, vTop, "AbsR: " & .TextMatrix(lin, 9), True, 10, False, 93.6, 15.84
                    Adicionar_Label (vLeft + 16), vTop, "AbsC: " & .TextMatrix(lin, 10), True, 10, False, 93.6, 15.84
                    
                    QrCode (vLeft + 2), vTop, .TextMatrix(lin, 5), True, 1
                
                    QrCode (vLeft + 6), (vTop + 70), .TextMatrix(lin, 5), False, 2
                
                    Adicionar_Label (vLeft - 4), (vTop + 103), "AbsR: " & .TextMatrix(lin, 9), False, 11, False, 93.6, 15.84
                    Adicionar_Label (vLeft - 4), (vTop + 116), "AbsC: " & .TextMatrix(lin, 10), False, 11, False, 93.6, 15.84
                
                    QrCode (vLeft + 6), (vTop + 149), .TextMatrix(lin, 5), False, 3
                    
                    Adicionar_Label (vLeft - 4), (vTop + 180), "AbsR: " & .TextMatrix(lin, 9), False, 16, True, 93.6, 20
                    Adicionar_Label (vLeft - 4), (vTop + 198), "AbsC: " & .TextMatrix(lin, 10), False, 16, True, 93.6, 20
                    
                    Adicionar_Label (vLeft - 4), (vTop + 218), "Entry#: " & .TextMatrix(lin, 7), False, 11, False, 93.6, 15.84
                    Adicionar_Label (vLeft - 4), (vTop + 233), "Rep#: " & .TextMatrix(lin, 8), False, 11, False, 93.6, 15.84
                    
                    Adicionar_Label (vLeft - 4), (vTop + 255), .TextMatrix(lin, 4), False, 11, False, 103, 35
                    
'                    If .TextMatrix(Lin, 13) = "|fffd|" Then
                        Adicionar_Label (vLeft - 4), (vTop + 280), "BUFFER", False, 18, True, 93.6, 25
'                    End If
                    
                    Adicionar_Label (vLeft - 4), (vTop + 312), "SeedPack# " & .TextMatrix(lin, 11), False, 11, False, 93.6, 15.84
                    
                    Adicionar_Label (vLeft - 4), (vTop + 330), "Seq.: " & .TextMatrix(lin, 0), False, 11, False, 93.6, 15.84
                    
                    sql = "UPDATE tab_fieldbook SET " & _
                                  "EtiquetaImpressa = true, " & _
                                  "DataImpressaoEtiqueta = #" & Format(Date, "yyyy/mm/dd") & "#, " & _
                                  "UsuarioImpressaoEtiqueta = '" & usuario & "', " & _
                                  "[Seeds/Packet] = " & Pega_Valor(.TextMatrix(lin, 11)) & ", " & _
                                  "Buffer = '" & .TextMatrix(lin, 13) & "' " & _
                          "WHERE [Plot BID]='" & .TextMatrix(lin, 5) & "'"
                    con.Execute sql
                    
                End If
            End If
        Next lin
        
        sht.PrintOut

        Apagar_Objetos
        
        ProgressBar1.Visible = False
        Label6.Visible = False
        Label7.Visible = False
    End With
    
    Application.Cursor = xlDefault
    
    sht.Visible = xlSheetHidden
    
End Sub

Private Sub btnLimpeza_Click()
    Dim sht As Worksheet
    
    Dim Resp As Boolean
    Dim btn As Variant
    
    Set sht = ThisWorkbook.Sheets("Etiqueta_Limpeza")
    
    sht.Visible = xlSheetVisible
    sht.Activate
    
    With Application
        btn = .Dialogs(xlDialogPrinterSetup).Show
        If btn = False Then Exit Sub
        .Cursor = xlWait
    End With
    
    sht.PrintOut
                    
    Application.Cursor = xlDefault
    
    sht.Visible = xlSheetHidden

End Sub

Private Sub edtFindMaterial_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim lin As Integer
    Dim col As Integer
    Dim achou As Boolean
    
    If KeyCode = vbKeyReturn Then
    
        If edtFindMaterial.Text = "" Then Exit Sub
        
        With Lista_Materiais
            achou = False
            MaterialRow = 0
            
            For lin = 1 To .Rows - 1
                If UCase(.TextMatrix(lin, 2)) = UCase(edtFindMaterial) Then
                    achou = True
                    MaterialRow = lin
                    Exit For
                End If
            Next lin
            
            If achou Then Lista_Materiais_Click
            
            If Not achou Then MsgBox "Material n|fffd|o encontrado.", vbInformation, "Pesquisa"
        
        End With
        
        edtFindMaterial.Text = ""
        edtFindMaterial.SetFocus
    End If
End Sub

Private Sub Lista_Fields_KeyPress(KeyAscii As Integer)
    If FieldRow > 0 And FieldCol = 2 Then
        With Lista_Fields
            .Row = FieldRow
            .col = FieldCol
            Select Case KeyAscii
                Case vbKeyReturn, vbKeyTab
                
                    Atualiza_QtdeSementes .Row
                    
                    Calcula_Sementes
                    
                    If .Row + 1 <= .Rows - 1 Then
                        .Row = .Row + 1
                    Else
                        .Row = 1
                    End If
                    FieldRow = .Row
                    PrimeiraLetra = True
                    
                Case vbKeyBack
                    'remove o ultimo caractere
                    If Len(.Text) Then
                        .Text = Left(.Text, Len(.Text) - 1)
                    End If
        
                Case Is < 32
        
                Case Else
                    If PrimeiraLetra Then
                        PrimeiraLetra = False
                        .Text = ""
                    End If
                    If Somente_Numeros(KeyAscii, False, True) = True Then
                        .Text = .Text & Chr(KeyAscii)
                    End If
            End Select
        End With
    End If
End Sub

Private Sub Lista_Imprimir_Click()
    itemSelected = True
End Sub

Private Sub Lista_Materiais_Click()
    Dim lin As Long
    Dim col As Integer
    
    Calcula_Sementes
    
    With Lista_Imprimir
        .Visible = False
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 6) = Lista_Materiais.TextMatrix(MaterialRow, 1) Then
                .RowHeight(lin) = 240
            Else
                .RowHeight(lin) = 0
            End If
        Next lin
        .Visible = True
    End With
    
End Sub

Private Sub Lista_Materiais_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    MaterialRow = Lista_Materiais.MouseRow
    MaterialCol = Lista_Materiais.MouseCol
End Sub

Private Sub Lista_Fields_Click()
    Dim lin As Long
    Dim col As Integer
    
    With Lista_Fields
        If FieldCol = 0 Then
            If .TextMatrix(FieldRow, 0) = "q" Then
                .TextMatrix(FieldRow, 0) = "|fffd|"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &HE0E0E0
                Next col
            Else
                .TextMatrix(FieldRow, 0) = "q"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &H80000005
                Next col
            End If
        End If
    End With
    
    Calcula_Sementes
End Sub

Private Sub Lista_Fields_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    FieldRow = Lista_Fields.MouseRow
    FieldCol = Lista_Fields.MouseCol
End Sub

Private Sub UserForm_Initialize()
    Dim col As Integer
    
    Const texto = "MONTANDO ETIQUETAS..."
    
    Call AtivarBotoesMinMax(Me)
    Call Maximizar(Me)
    
    If con Is Nothing Then Conecta_Banco
'    usuario = "Robson"
'    CorFundoTela = RGB(229, 239, 218)
    
    safra = Pega_Safra
    BufferPadrao = Pega_BufferPadrao
    Margem = Pega_Margem
    
    ProgressBar1.Visible = False
    Label6.Visible = False
    Label7.Visible = False
    
    Label6.Caption = ""
    For col = 1 To Len(texto)
        If Label6.Caption <> "" Then Label6.Caption = Label6.Caption & vbNewLine
        Label6.Caption = Label6.Caption & Mid(texto, col, 1)
    Next col
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    Frame1.Height = Me.Height - Frame1.Top - 30
    Frame1.BackColor = CorFundoTela
    Frame2.BackColor = CorFundoTela
    Label4.Width = Me.Width - Label4.Left - 14
    With Label5
        .Top = Label4.Top + ((Label4.Height - .Height) / 2)
        .Left = Label4.Left + ((Label4.Width - .Width) / 2)
    End With
    
    btnImprimir.Left = Me.Width - btnImprimir.Width - 24
    btnExportar.Left = btnImprimir.Left - btnExportar.Width - 10
    With btnLimpeza
        .Left = btnExportar.Left - .Width - 10
        .Caption = "Limpeza de" & Chr(10) & "Cabe|fffd|ote"
        .font.size = 7
    End With
    
    With Lista_Materiais
        .Clear
        .Rows = 1
        .Cols = 5
        .Height = Frame1.Height - .Top - 10
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "ID_Material"
        .TextMatrix(0, 1) = "Material"
        .TextMatrix(0, 2) = "Inv BID"
        .TextMatrix(0, 3) = "Estoque"
        .TextMatrix(0, 4) = "Necessidade"
        .FixedAlignment(1) = 7
        For col = 1 To .Cols - 1
            .FixedAlignment(col) = 4
        Next col
        .ColWidth(0) = 0
        .ColWidth(1) = 3100
        .ColWidth(2) = 2255
        .ColWidth(3) = 800
        .ColWidth(4) = 800
        .ColAlignment(0) = 7
        .ColAlignment(1) = 1
        .ColAlignment(2) = 1
        .ColAlignment(3) = 7
        .ColAlignment(4) = 7
    End With
    
    With Lista_Fields
        .Clear
        .Rows = 1
        .Cols = 3
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Field"
        .TextMatrix(0, 2) = "Sementes/Saq."
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .FixedAlignment(2) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 2200
        .ColWidth(2) = 1500
        .ColAlignment(0) = 4
        .ColAlignment(1) = 1
        .ColAlignment(2) = 7
    End With
    
    With Lista_Imprimir
        .Clear
        .Rows = 1
        .Cols = 14
        .FixedCols = 1
        .Height = Me.Height - .Top - 30
        .Width = Me.Width - .Left - 14
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "Seq."
        .TextMatrix(0, 1) = "Orig Proj"
        .TextMatrix(0, 2) = "Grower Proj"
        .TextMatrix(0, 3) = "Set"
        .TextMatrix(0, 4) = "Field"
        .TextMatrix(0, 5) = "Plot BID"
        .TextMatrix(0, 6) = "Material"
        .TextMatrix(0, 7) = "Entry#"
        .TextMatrix(0, 8) = "Rep#"
        .TextMatrix(0, 9) = "AbsR"
        .TextMatrix(0, 10) = "AbsC"
        .TextMatrix(0, 11) = "Qtde Sementes"
        .TextMatrix(0, 12) = "Tratamento"
        .TextMatrix(0, 13) = "Buffer"
        For col = 0 To .Cols - 1
            .FixedAlignment(col) = 4
            .ColWidth(col) = 800
            If col < 7 Or col = 12 Then
                .ColAlignment(col) = 1
            Else
                .ColAlignment(col) = 7
            End If
        Next col
    End With
    
    Monta_Fields
    
    Checa_RetiradaPendente
    
    MaterialRow = 0
    
    Monta_Lista_Impressao
    
    Atualiza_QtdeSementes 0
    
    Calcula_Sementes
    
    edtFindMaterial.Text = BufferPadrao
    
    itemSelected = False

End Sub

Public Sub Monta_Fields()
    Dim rs As ADODB.Recordset
    
    Set rs = New ADODB.Recordset
    
    rs.Open "SELECT DISTINCT FB.Field, " & _
                   "(SELECT Round(AVG(F.[Seeds/Packet]) * (1 + (" & Margem & "/100)),0) " & _
                   "FROM tab_fieldbook as F " & _
                   "WHERE F.Season='" & safra & "' and F.[Seeds/Packet] > 0) AS [QtdeSem] " & _
            "FROM tab_fieldbook as FB " & _
            "WHERE FB.Season='" & safra & "' and " & _
                  "FB.etiquetaimpressa=false and " & _
                  "(FB.[plot deactivated]=true or " & _
                  "FB.[set] is null)", con
    With Lista_Fields
        .Rows = 1
        
        While Not rs.EOF
            .Rows = .Rows + 1
            
            .col = 0
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            .Text = "|fffd|"
            .CellBackColor = &HE0E0E0
            
            .col = 1
            .Text = rs("Field")
            .CellBackColor = &HE0E0E0
            
            .col = 2
            .Text = rs("QtdeSem")
            .CellBackColor = &HE0E0E0
            
            rs.MoveNext
        Wend
    End With
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Lista_Fields, 1, 2
End Sub

Private Sub Calcula_Sementes()
    Dim linM As Integer
    Dim linI As Long
    Dim linF As Integer
    
    Dim col As Integer
    
    Dim TotParcelas As Long
    Dim TotSeedPacket As Long
    Dim TotPacketParc As Long
    
    Dim totEstoque As Long
    
    Dim rs As ADODB.Recordset
    
    For linM = 1 To Lista_Materiais.Rows - 1
        totEstoque = Pega_Valor(Lista_Materiais.TextMatrix(linM, 3))
        TotSeedPacket = 0
        
        For linI = 1 To Lista_Imprimir.Rows - 1
            If Lista_Imprimir.TextMatrix(linI, 6) = Lista_Materiais.TextMatrix(linM, 1) Then
                For linF = 1 To Lista_Fields.Rows - 1
                    If Lista_Fields.TextMatrix(linF, 1) = Lista_Imprimir.TextMatrix(linI, 4) Then
                        If Lista_Fields.TextMatrix(linF, 0) = "|fffd|" Then
                            TotSeedPacket = TotSeedPacket + Pega_Valor(Lista_Imprimir.TextMatrix(linI, 11))
                        End If
                    End If
                Next linF
            End If
        Next linI
        
        Lista_Materiais.TextMatrix(linM, 4) = Format(TotSeedPacket, "#,##0")
        
        Lista_Materiais.Row = linM
        
        For col = 0 To Lista_Materiais.Cols - 1
            Lista_Materiais.col = col
            If totEstoque > TotSeedPacket Then
                Lista_Materiais.CellBackColor = &H80FF80
            Else
                Lista_Materiais.CellBackColor = &H80C0FF
            End If
        Next col
        
    Next linM

End Sub

Private Sub Checa_RetiradaPendente()
    Dim rs As ADODB.Recordset
    Dim rs1 As ADODB.Recordset
    
    Dim lin As Long
    Dim col As Integer
    Dim para As Boolean
    
    Set rs = New ADODB.Recordset
    rs.Open "SELECT R.*, M.Pedigree, M.Lote, M.Localizacao, C.NomeCamaraFria, (E.Corredor & '-' & E.Prateleira & '-' & E.Andar & '-' & E.Numero) as Endereco, E.Comentario " & _
            "FROM (((tab_retirada as R " & _
            "INNER JOIN tab_material as M on M.ID_Material = R.ID_Material) " & _
            "LEFT JOIN tab_camarafria as C on C.ID_CamaraFria = M.ID_CamaraFria) " & _
            "LEFT JOIN tab_camarafriaEndereco as E on E.ID_CamaraFria = M.ID_CamaraFria and E.ID_Endereco = M.ID_Endereco) " & _
            "WHERE retirou = true and buffer = true and data_retirada is not null", con
    
    While Not rs.EOF
        With Lista_Materiais
            .Rows = .Rows + 1
            
            .TextMatrix(.Rows - 1, 0) = rs("ID_Material")
            .TextMatrix(.Rows - 1, 1) = rs("Pedigree")
            .TextMatrix(.Rows - 1, 2) = rs("InvBID")
            .TextMatrix(.Rows - 1, 3) = Format(rs("Estoque"), "#,##0")
            .TextMatrix(.Rows - 1, 4) = Format(rs("Necessidade"), "#,##0")
        
            .col = 0
            .Row = .Rows - 1
        
            If rs("Estoque") > rs("Necessidade") Then
                .BackColor = &H80FF80
            Else
                .BackColor = &H80C0FF
            End If
            
            AutosizeGridColumns Lista_Materiais, 1, 4
            
            Set rs1 = Nothing
        End With
        
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
End Sub

Private Sub Monta_Lista_Impressao()
    Dim LinMaterial As Integer
    Dim lin As Integer
    Dim col As Integer
    Dim cont As Integer
    
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    Dim filtroFields As String

    Lista_Imprimir.Rows = 1
    
    filtroFields = ""
    With Lista_Fields
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtroFields <> "" Then filtroFields = filtroFields & ", "
                filtroFields = filtroFields & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    If filtroFields = "" Then filtroFields = "'XXX'"
    
    sql = "SELECT '' as [Originator], '' as [Grower], FB.[Set], FB.Field, " & _
                 "FB.[Plot BID], M.Pedigree, FB.[Entry#], FB.[Rep#], FB.AbsR, FB.AbsC, 1 as [QtdeSaqParcela], " & _
                 "1 as [NroTratamento], 'BUFFER' as [DescricaoTratamento], FB.[Seeds/Packet] as [QtdeSementes] " & _
          "FROM tab_fieldbook as FB " & _
          "INNER JOIN tab_Material as M ON M.ID_Material = FB.ID_Material " & _
          "WHERE (FB.[Plot Deactivated] = true or FB.[Set] is null) and FB.EtiquetaImpressa = False and " & _
                "FB.Season='" & safra & "' and " & _
                "FB.Field in (" & filtroFields & ") "
    If MaterialRow > 0 Then
        sql = sql & "AND FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " " & _
                    "AND FB.[Inv BID] = '" & Lista_Materiais.TextMatrix(MaterialRow, 2) & "' "
    End If
    sql = sql & "ORDER BY M.Pedigree, FB.Field, FB.[Set], FB.AbsC, FB.AbsR"
    
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    While Not rs.EOF
        For cont = 1 To rs("QtdeSaqParcela")
            With Lista_Imprimir
                .Rows = .Rows + 1
                
                .TextMatrix(.Rows - 1, 0) = .Rows - 1
                .TextMatrix(.Rows - 1, 1) = IIf(IsNull(rs("Originator")), "", rs("Originator"))
                .TextMatrix(.Rows - 1, 2) = IIf(IsNull(rs("Grower")), "", rs("Grower"))
                .TextMatrix(.Rows - 1, 3) = IIf(IsNull(rs("Set")), "", rs("Set"))
                .TextMatrix(.Rows - 1, 4) = rs("Field")
                .TextMatrix(.Rows - 1, 5) = rs("Plot BID")
                .TextMatrix(.Rows - 1, 6) = rs("Pedigree")
                .TextMatrix(.Rows - 1, 7) = IIf(IsNull(rs("Entry#")), "", rs("Entry#"))
                .TextMatrix(.Rows - 1, 8) = rs("Rep#")
                .TextMatrix(.Rows - 1, 9) = rs("AbsR")
                .TextMatrix(.Rows - 1, 10) = rs("AbsC") + (cont - 1)
                .TextMatrix(.Rows - 1, 11) = IIf(IsNull(rs("QtdeSementes")), 2, rs("QtdeSementes"))
                .TextMatrix(.Rows - 1, 12) = IIf(IsNull(rs("DescricaoTratamento")), "", rs("DescricaoTratamento"))
                .TextMatrix(.Rows - 1, 13) = rs("Pedigree")
                
            End With
        Next cont
    
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Lista_Imprimir, 0, 13
    
End Sub

Private Sub Atualiza_QtdeSementes(linha As Integer)
    Dim linStart As Integer
    Dim linField As Integer
    Dim linEtq As Long
    Dim iRowStart As Long
    Dim iRowEnd As Long
    Dim Resp As Boolean
    Dim btn As Variant
    
    If linha = 0 Then
        linStart = 1
        linha = Lista_Fields.Rows - 1
    Else
        linStart = linha
    End If
    
    iRowStart = Lista_Imprimir.Row
    iRowEnd = Lista_Imprimir.RowSel
    
    If itemSelected Then
        btn = MsgBox("Imprimir somente os itens selecionados ?", vbYesNoCancel + vbInformation, "Imprimir")
        If btn = vbCancel Then
            Exit Sub
        ElseIf btn = vbYes Then
            Resp = True
        Else
            Resp = False
        End If
    End If
    
    Lista_Imprimir.Visible = False
    
    For linField = linStart To linha
        For linEtq = 1 To Lista_Imprimir.Rows - 1
            If (Not Resp) Or (Resp And linEtq >= iRowStart And linEtq <= iRowEnd) Then
                If Lista_Imprimir.TextMatrix(linEtq, 4) = Lista_Fields.TextMatrix(linField, 1) Then
                    Lista_Imprimir.TextMatrix(linEtq, 11) = Lista_Fields.TextMatrix(linField, 2)
                End If
            End If
        Next linEtq
    Next linField
    
    Lista_Imprimir.Visible = True
    
End Sub
Attribute VB_Name = "form_imprimirsaquinho"
Attribute VB_Base = "0{A3409DD7-7539-4B51-8BAD-78967B22BD6E}{7D2689A2-4AD5-4151-B567-1E48084DA60F}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim safra As String
Dim BufferPadrao As String
Dim Margem As Long

Dim MaterialRow As Integer
Dim MaterialCol As Integer
Dim SetRow As Integer
Dim SetCol As Integer
Dim GrowerRow As Integer
Dim GrowerCol As Integer
Dim LocationRow As Integer
Dim LocationCol As Integer
Dim RepRow As Integer
Dim RepCol As Integer
Dim linhaImprimir As Integer
Dim colunaImprimir As Integer

Dim itemSelected As Boolean

Private Sub btnFiltro_Click()
    Dim frm As Object
    Dim lin As Integer
    Dim filtros As String
    Dim filtrog As String
    Dim filtrol As String
    Dim filtror As String
    
    Dim sql As String
    
    filtros = ""
    With Lista_Sets
        For lin = 1 To .Rows - 1
            If filtros <> "" Then filtros = filtros & ", "
            filtros = filtros & .TextMatrix(lin, 1) & "#" & .TextMatrix(lin, 0)
        Next lin
    End With
    
    filtrog = ""
    With Lista_Grower
        For lin = 1 To .Rows - 1
            If filtrog <> "" Then filtrog = filtrog & ", "
            filtrog = filtrog & .TextMatrix(lin, 2) & "#" & .TextMatrix(lin, 0) & "/" & .TextMatrix(lin, 1)
        Next lin
    End With
    
    filtrol = ""
    With Lista_Location
        For lin = 1 To .Rows - 1
            If filtrol <> "" Then filtrol = filtrol & ", "
            filtrol = filtrol & .TextMatrix(lin, 1) & "#" & .TextMatrix(lin, 0)
        Next lin
    End With
    
    filtror = ""
    With Lista_Reps
        For lin = 1 To .Rows - 1
            If filtror <> "" Then filtror = filtror & ", "
            filtror = filtror & .TextMatrix(lin, 1) & "#" & .TextMatrix(lin, 0)
        Next lin
    End With
    
    filtrarS = ""
    filtrarG = ""
    filtrarL = ""
    filtrarR = ""
    
    Set frm = New form_filtrosementes
    frm.filtroSet = filtros
    frm.filtroGrower = filtrog
    frm.filtroLoc = filtrol
    frm.filtroRep = filtror
    frm.Show
    
    If filtrarS <> "" Then
        sql = "UPDATE tab_retirada SET " & _
                     "FiltroSet = '" & filtrarS & "', " & _
                     "FiltroGrower = '" & filtrarG & "', " & _
                     "FiltroLoc = '" & filtrarL & "', " & _
                     "FiltroRep = '" & filtrarR & "' " & _
              "WHERE id_retirada = " & Lista_Materiais.TextMatrix(MaterialRow, 5)
            
        con.Execute sql
    
        Lista_Materiais_Click
    End If
End Sub

Private Sub btnExportar_Click()
    Dim lin As Integer
    Dim sql As String
    Dim btn As Variant
    
    btn = MsgBox("Marcar como impresso os materiais da listagem?", vbYesNoCancel + vbInformation, "Exportar")
    If btn = vbCancel Then
        Exit Sub
    ElseIf btn = vbYes Then
        With Lista_Imprimir
            For lin = 1 To .Rows - 1
                If .RowHeight(lin) > 0 Then
                    sql = "UPDATE tab_fieldbook SET " & _
                                "EtiquetaImpressa = true, " & _
                                "DataImpressaoEtiqueta = #" & Format(Date, "yyyy/mm/dd") & "#, " & _
                                "UsuarioImpressaoEtiqueta = '" & usuario & "' " & _
                           "WHERE [Plot BID]='" & .TextMatrix(lin, 6) & "'"
                    con.Execute sql
                End If
            Next lin
        End With
    End If
    
    Exportar Lista_Imprimir
End Sub

Private Sub btnImprimir_Click()
    Dim lin As Integer
    Dim sht As Worksheet
    Dim linhas As String
    
    Dim ContLin As Integer
    Dim ContCol As Integer
    Dim ContSaq As Integer
    
    Dim iRowStart As Integer
    Dim iRowEnd As Integer
    Dim Resp As Boolean
    Dim btn As Variant
    
    Dim sql As String
    
    Dim vLeft As Integer
    Dim vTop As Integer
    
    If Lista_Imprimir.Rows = 1 Then Exit Sub
    
    Set sht = ThisWorkbook.Sheets("Layout_Etiqueta")
    
    sht.Visible = xlSheetVisible
    sht.Activate
    
    iRowStart = Lista_Imprimir.Row
    iRowEnd = Lista_Imprimir.RowSel
    
    If itemSelected Then
        btn = MsgBox("Imprimir somente os itens selecionados ?", vbYesNoCancel + vbInformation, "Imprimir")
        If btn = vbCancel Then
            Exit Sub
        ElseIf btn = vbYes Then
            Resp = True
        Else
            Resp = False
        End If
    End If
    
    With Application
        btn = .Dialogs(xlDialogPrinterSetup).Show
        If btn = False Then Exit Sub
        .Cursor = xlWait
    End With
    
'    btnLimpeza2
    
    Configura_Etiqueta
    
    With Lista_Imprimir
        ProgressBar1.Max = .Rows - 1
        ProgressBar1.min = 0
        ProgressBar1.Value = 0
        
        ProgressBar1.Visible = True
        Label6.Caption = "Montando Etiquetas ..."
        Label6.Visible = True
        Label7.Visible = True
        
        ContLin = 0
        ContCol = 1
        
        Apagar_Objetos
        
        For lin = 1 To .Rows - 1
            ProgressBar1.Value = lin
            DoEvents
            
            If .RowHeight(lin) > 0 Then
                If (Not Resp) Or (Resp And lin >= iRowStart And lin <= iRowEnd) Then
                    
                    For ContSaq = 1 To Val(edtNroCopias)
                        If ContLin = 10 And ContCol = 1 Then
                            sht.PrintOut
                            
                            Apagar_Objetos
                            ContLin = 0
                            ContCol = 1
                        End If
                        
                        If ContLin = 10 Then
                            ContLin = 0
                            ContCol = ContCol + 1
                        End If
                        ContLin = ContLin + 1
                        
                        vLeft = 44 + ((ContCol - 1) * 144)
                        vTop = 220 + ((ContLin - 1) * 585)
                        
                        Adicionar_Label vLeft, vTop, "AbsR: " & .TextMatrix(lin, 10), True, 10, False, 93.6, 15.84
                        Adicionar_Label (vLeft + 16), vTop, "AbsC: " & .TextMatrix(lin, 11), True, 10, False, 93.6, 15.84
                        
                        QrCode (vLeft + 2), vTop, .TextMatrix(lin, 6), True, 1
                    
                        QrCode (vLeft + 6), (vTop + 70), .TextMatrix(lin, 6), False, 2
                    
                        Adicionar_Label (vLeft - 4), (vTop + 103), "AbsR: " & .TextMatrix(lin, 10), False, 11, False, 93.6, 15.84
                        Adicionar_Label (vLeft - 4), (vTop + 116), "AbsC: " & .TextMatrix(lin, 11), False, 11, False, 93.6, 15.84
                    
                        QrCode (vLeft + 6), (vTop + 149), .TextMatrix(lin, 6), False, 3
                        
                        Adicionar_Label (vLeft - 4), (vTop + 180), "AbsR: " & .TextMatrix(lin, 10), False, 16, True, 93.6, 20
                        Adicionar_Label (vLeft - 4), (vTop + 198), "AbsC: " & .TextMatrix(lin, 11), False, 16, True, 93.6, 20
                        
                        Adicionar_Label (vLeft - 4), (vTop + 218), "Entry#: " & .TextMatrix(lin, 8), False, 11, False, 93.6, 15.84
                        Adicionar_Label (vLeft - 4), (vTop + 233), "Rep#: " & .TextMatrix(lin, 9), False, 11, False, 93.6, 15.84
                        
                        Adicionar_Label (vLeft - 4), (vTop + 255), .TextMatrix(lin, 5), False, 16, True, 103, 35
                        
                        If .TextMatrix(lin, 13) = "|fffd|" Then
                            Adicionar_Label (vLeft - 4), (vTop + 280), "BUFFER", False, 18, True, 93.6, 25
                        End If
                        
                        Adicionar_Label (vLeft - 4), (vTop + 312), "SeedPack# " & .TextMatrix(lin, 12), False, 11, False, 93.6, 15.84
                        
                        Adicionar_Label (vLeft - 4), (vTop + 330), "Seq.: " & .TextMatrix(lin, 0), False, 11, False, 93.6, 15.84
                    Next ContSaq
                    
                    sql = "UPDATE tab_fieldbook SET " & _
                                  "EtiquetaImpressa = true, " & _
                                  "DataImpressaoEtiqueta = #" & Format(Date, "yyyy/mm/dd") & "#, " & _
                                  "UsuarioImpressaoEtiqueta = '" & usuario & "' " & _
                          "WHERE [Plot BID]='" & .TextMatrix(lin, 6) & "'"
                    con.Execute sql
                    
                End If
            End If
        Next lin
        
        sht.PrintOut

        Apagar_Objetos
        
        ProgressBar1.Visible = False
        Label6.Visible = False
        Label7.Visible = False
    End With
    
    Application.Cursor = xlDefault
    
    sht.Visible = xlSheetHidden
    
End Sub

Private Sub btnLimpeza_Click()
    Dim sht As Worksheet
    
    Dim Resp As Boolean
    Dim btn As Variant
    
    Set sht = ThisWorkbook.Sheets("Etiqueta_Limpeza")
    
    sht.Visible = xlSheetVisible
    sht.Activate
    
    With Application
        btn = .Dialogs(xlDialogPrinterSetup).Show
        If btn = False Then Exit Sub
        .Cursor = xlWait
    End With
    
    sht.PrintOut
                    
    Application.Cursor = xlDefault
    
    sht.Visible = xlSheetHidden

End Sub

Private Sub btnLimpeza2()
    Dim sht As Worksheet
    
    Set sht = ThisWorkbook.Sheets("Etiqueta_Limpeza")
    
    sht.Visible = xlSheetVisible
    sht.Activate
    
    sht.PrintOut
                    
    Application.Cursor = xlDefault
    
    sht.Visible = xlSheetHidden
End Sub

Private Sub btnMostrarTudo_Click()
    Dim lin As Integer
    
    With Lista_Imprimir
        For lin = 1 To .Rows - 1
            .RowHeight(lin) = 240
        Next lin
    End With

End Sub

Private Sub chkGrower_Click()
    Monta_Lista_Impressao
End Sub

Private Sub chkLocation_Click()
    Monta_Lista_Impressao
End Sub

Private Sub chkSet_Click()
    Monta_Lista_Impressao
End Sub

Private Sub edtFindMaterial_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim lin As Integer
    Dim col As Integer
    Dim achou As Boolean
    Dim rs As ADODB.Recordset
    Dim rs1 As ADODB.Recordset
    Dim filtro As Variant
    Dim flt As Variant
    Dim cont As Integer
    Dim sql As String
    
    If KeyCode = vbKeyReturn Then
    
        If edtFindMaterial.Text = "" Then Exit Sub
        
        With Lista_Materiais
            
            achou = False
            MaterialRow = 0
            
            For lin = 1 To .Rows - 1
                If UCase(.TextMatrix(lin, 2)) = UCase(edtFindMaterial) Then
                    achou = True
                    MaterialRow = lin
                    Exit For
                End If
            Next lin
            
7            If achou Then
                sql = "SELECT * FROM tab_retirada WHERE ID_Retirada = " & .TextMatrix(MaterialRow, 5)
                
                Set rs = New ADODB.Recordset
                rs.Open sql, con
                
                Lista_Sets.Rows = 1
                Lista_Grower.Rows = 1
                Lista_Location.Rows = 1
                Lista_Reps.Rows = 1
                
                If Not rs.EOF Then
                    filtro = Split(rs("FiltroSet"), ", ")
                    For cont = LBound(filtro) To UBound(filtro)
                        flt = Split(filtro(cont), "#")
                        
                        Lista_Sets.Rows = Lista_Sets.Rows + 1
                        Lista_Sets.Row = Lista_Sets.Rows - 1
                        Lista_Sets.col = 0
                        Lista_Sets.FillStyle = flexFillRepeat
                        Lista_Sets.CellFontName = "Wingdings"
                        Lista_Sets.CellFontSize = 12
                        Lista_Sets.CellAlignment = flexAlignCenterCenter
                        Lista_Sets.FillStyle = flexFillSingle
                        Lista_Sets.TextMatrix(Lista_Sets.Rows - 1, 0) = flt(1)
                        Lista_Sets.TextMatrix(Lista_Sets.Rows - 1, 1) = flt(0)
                        For col = 0 To Lista_Sets.Cols - 1
                            Lista_Sets.col = col
                            If flt(1) = "|fffd|" Then
                                Lista_Sets.CellBackColor = &HE0E0E0
                            Else
                                Lista_Sets.CellBackColor = &H80000005
                            End If
                        Next col
                    Next cont
                    
                    filtro = Split(rs("filtroGrower"), ", ")
                    For cont = LBound(filtro) To UBound(filtro)
                        flt = Split(filtro(cont), "#")
                        
                        Set rs1 = New ADODB.Recordset
                        rs1.Open "SELECT * FROM tab_programa WHERE ID_Programa = " & flt(0), con
                        
                        Lista_Grower.Rows = Lista_Grower.Rows + 1
                        Lista_Grower.Row = Lista_Grower.Rows - 1
                        Lista_Grower.col = 0
                        Lista_Grower.FillStyle = flexFillRepeat
                        Lista_Grower.CellFontName = "Wingdings"
                        Lista_Grower.CellFontSize = 12
                        Lista_Grower.CellAlignment = flexAlignCenterCenter
                        Lista_Grower.FillStyle = flexFillSingle
                        Lista_Grower.TextMatrix(Lista_Grower.Rows - 1, 0) = flt(1)
                        Lista_Grower.TextMatrix(Lista_Grower.Rows - 1, 1) = flt(0)
                        Lista_Grower.TextMatrix(Lista_Grower.Rows - 1, 2) = rs1("CodigoPrograma")
                        For col = 0 To Lista_Grower.Cols - 1
                            Lista_Grower.col = col
                            If flt(1) = "|fffd|" Then
                                Lista_Grower.CellBackColor = &HE0E0E0
                            Else
                                Lista_Grower.CellBackColor = &H80000005
                            End If
                        Next col
                        
                        rs1.Close
                        Set rs1 = Nothing
                    Next cont
                        
                    filtro = Split(rs("FiltroLoc"), ", ")
                    For cont = LBound(filtro) To UBound(filtro)
                        flt = Split(filtro(cont), "#")
                        
                        Lista_Location.Rows = Lista_Location.Rows + 1
                        Lista_Location.Row = Lista_Location.Rows - 1
                        Lista_Location.col = 0
                        Lista_Location.FillStyle = flexFillRepeat
                        Lista_Location.CellFontName = "Wingdings"
                        Lista_Location.CellFontSize = 12
                        Lista_Location.CellAlignment = flexAlignCenterCenter
                        Lista_Location.FillStyle = flexFillSingle
                        Lista_Location.TextMatrix(Lista_Location.Rows - 1, 0) = flt(1)
                        Lista_Location.TextMatrix(Lista_Location.Rows - 1, 1) = flt(0)
                        For col = 0 To Lista_Location.Cols - 1
                            Lista_Location.col = col
                            If flt(1) = "|fffd|" Then
                                Lista_Location.CellBackColor = &HE0E0E0
                            Else
                                Lista_Location.CellBackColor = &H80000005
                            End If
                        Next col
                    Next cont
                        
                    filtro = Split(rs("FiltroRep"), ", ")
                    For cont = LBound(filtro) To UBound(filtro)
                        flt = Split(filtro(cont), "#")
                        
                        Lista_Reps.Rows = Lista_Reps.Rows + 1
                        Lista_Reps.Row = Lista_Reps.Rows - 1
                        Lista_Reps.col = 0
                        Lista_Reps.FillStyle = flexFillRepeat
                        Lista_Reps.CellFontName = "Wingdings"
                        Lista_Reps.CellFontSize = 12
                        Lista_Reps.CellAlignment = flexAlignCenterCenter
                        Lista_Reps.FillStyle = flexFillSingle
                        Lista_Reps.TextMatrix(Lista_Reps.Rows - 1, 0) = flt(1)
                        Lista_Reps.TextMatrix(Lista_Reps.Rows - 1, 1) = flt(0)
                        For col = 0 To Lista_Reps.Cols - 1
                            Lista_Reps.col = col
                            If flt(1) = "|fffd|" Then
                                Lista_Reps.CellBackColor = &HE0E0E0
                            Else
                                Lista_Reps.CellBackColor = &H80000005
                            End If
                        Next col
                    Next cont
                    
                End If
            
                rs.Close
                Set rs = Nothing
            End If
            
            Calcula_Sementes
            
            If Not achou Then
                MsgBox "Material n|fffd|o encontrado.", vbInformation, "Pesquisa"
            Else
                With Lista_Imprimir
                    .Visible = False
                    For lin = 1 To .Rows - 1
                        If .TextMatrix(lin, 7) = Lista_Materiais.TextMatrix(MaterialRow, 1) Then
                            .RowHeight(lin) = 240
                        Else
                            .RowHeight(lin) = 0
                        End If
                    Next lin
                    .Visible = True
                End With
            End If
        End With
        
        edtFindMaterial.Text = ""
        edtFindMaterial.SetFocus
    End If
End Sub

Private Sub edtNroCopias_Exit(ByVal Cancel As MSForms.ReturnBoolean)
    If Val(edtNroCopias) = 0 Then edtNroCopias = 1
End Sub

Private Sub edtNroCopias_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If Somente_Numeros(KeyAscii, False, True) = False Then
        KeyAscii = 0
    End If
End Sub

Private Sub Lista_Imprimir_Click()
'    If linhaImprimir = 0 Then
'        Lista_Imprimir.col = colunaImprimir
'        Lista_Imprimir.Sort = flexSortGenericAscending
'        itemSelected = False
'    Else
        itemSelected = True
'    End If
End Sub

Private Sub Lista_Imprimir_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    linhaImprimir = Lista_Imprimir.MouseRow
    colunaImprimir = Lista_Imprimir.MouseCol
End Sub

Private Sub Lista_Materiais_Click()
    Dim lin As Long
    Dim col As Integer
    Dim rs As ADODB.Recordset
    Dim rs1 As ADODB.Recordset
    Dim filtro As Variant
    Dim flt As Variant
    Dim cont As Integer
    
    If MaterialRow < 1 Then Exit Sub
    
    Set rs = New ADODB.Recordset
    rs.Open "SELECT * FROM tab_retirada WHERE ID_Retirada = " & Lista_Materiais.TextMatrix(MaterialRow, 5), con
    
    Lista_Sets.Rows = 1
    Lista_Grower.Rows = 1
    Lista_Location.Rows = 1
    Lista_Reps.Rows = 1
    
    If Not rs.EOF Then
        filtro = Split(rs("FiltroSet"), ", ")
        For cont = LBound(filtro) To UBound(filtro)
            flt = Split(filtro(cont), "#")
            
            Lista_Sets.Rows = Lista_Sets.Rows + 1
            Lista_Sets.Row = Lista_Sets.Rows - 1
            Lista_Sets.col = 0
            Lista_Sets.FillStyle = flexFillRepeat
            Lista_Sets.CellFontName = "Wingdings"
            Lista_Sets.CellFontSize = 12
            Lista_Sets.CellAlignment = flexAlignCenterCenter
            Lista_Sets.FillStyle = flexFillSingle
            Lista_Sets.TextMatrix(Lista_Sets.Rows - 1, 0) = flt(1)
            Lista_Sets.TextMatrix(Lista_Sets.Rows - 1, 1) = flt(0)
            For col = 0 To Lista_Sets.Cols - 1
                Lista_Sets.col = col
                If flt(1) = "|fffd|" Then
                    Lista_Sets.CellBackColor = &HE0E0E0
                Else
                    Lista_Sets.CellBackColor = &H80000005
                End If
            Next col
        Next cont
        
        filtro = Split(rs("filtroGrower"), ", ")
        For cont = LBound(filtro) To UBound(filtro)
            flt = Split(filtro(cont), "#")
            
            Set rs1 = New ADODB.Recordset
            rs1.Open "SELECT * FROM tab_programa WHERE ID_Programa = " & flt(0), con
            
            Lista_Grower.Rows = Lista_Grower.Rows + 1
            Lista_Grower.Row = Lista_Grower.Rows - 1
            Lista_Grower.col = 0
            Lista_Grower.FillStyle = flexFillRepeat
            Lista_Grower.CellFontName = "Wingdings"
            Lista_Grower.CellFontSize = 12
            Lista_Grower.CellAlignment = flexAlignCenterCenter
            Lista_Grower.FillStyle = flexFillSingle
            Lista_Grower.TextMatrix(Lista_Grower.Rows - 1, 0) = flt(1)
            Lista_Grower.TextMatrix(Lista_Grower.Rows - 1, 1) = flt(0)
            Lista_Grower.TextMatrix(Lista_Grower.Rows - 1, 2) = rs1("CodigoPrograma")
            For col = 0 To Lista_Grower.Cols - 1
                Lista_Grower.col = col
                If flt(1) = "|fffd|" Then
                    Lista_Grower.CellBackColor = &HE0E0E0
                Else
                    Lista_Grower.CellBackColor = &H80000005
                End If
            Next col
            
            rs1.Close
            Set rs1 = Nothing
        Next cont
            
        filtro = Split(rs("FiltroLoc"), ", ")
        For cont = LBound(filtro) To UBound(filtro)
            flt = Split(filtro(cont), "#")
            
            Lista_Location.Rows = Lista_Location.Rows + 1
            Lista_Location.Row = Lista_Location.Rows - 1
            Lista_Location.col = 0
            Lista_Location.FillStyle = flexFillRepeat
            Lista_Location.CellFontName = "Wingdings"
            Lista_Location.CellFontSize = 12
            Lista_Location.CellAlignment = flexAlignCenterCenter
            Lista_Location.FillStyle = flexFillSingle
            Lista_Location.TextMatrix(Lista_Location.Rows - 1, 0) = flt(1)
            Lista_Location.TextMatrix(Lista_Location.Rows - 1, 1) = flt(0)
            For col = 0 To Lista_Location.Cols - 1
                Lista_Location.col = col
                If flt(1) = "|fffd|" Then
                    Lista_Location.CellBackColor = &HE0E0E0
                Else
                    Lista_Location.CellBackColor = &H80000005
                End If
            Next col
        Next cont
            
        filtro = Split(rs("FiltroRep"), ", ")
        For cont = LBound(filtro) To UBound(filtro)
            flt = Split(filtro(cont), "#")
            
            Lista_Reps.Rows = Lista_Reps.Rows + 1
            Lista_Reps.Row = Lista_Reps.Rows - 1
            Lista_Reps.col = 0
            Lista_Reps.FillStyle = flexFillRepeat
            Lista_Reps.CellFontName = "Wingdings"
            Lista_Reps.CellFontSize = 12
            Lista_Reps.CellAlignment = flexAlignCenterCenter
            Lista_Reps.FillStyle = flexFillSingle
            Lista_Reps.TextMatrix(Lista_Reps.Rows - 1, 0) = flt(1)
            Lista_Reps.TextMatrix(Lista_Reps.Rows - 1, 1) = flt(0)
            For col = 0 To Lista_Reps.Cols - 1
                Lista_Reps.col = col
                If flt(1) = "|fffd|" Then
                    Lista_Reps.CellBackColor = &HE0E0E0
                Else
                    Lista_Reps.CellBackColor = &H80000005
                End If
            Next col
        Next cont
        
    End If

    rs.Close
    Set rs = Nothing
    
    Calcula_Sementes
    
    With Lista_Imprimir
        .Visible = False
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 7) = Lista_Materiais.TextMatrix(MaterialRow, 1) Then
                .RowHeight(lin) = 240
            Else
                .RowHeight(lin) = 0
            End If
        Next lin
        .Visible = True
    End With
    
End Sub

Private Sub Lista_Materiais_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    MaterialRow = Lista_Materiais.MouseRow
    MaterialCol = Lista_Materiais.MouseCol
End Sub

Private Sub Lista_Sets_Click()
    Dim lin As Long
    Dim col As Integer
    Dim filtro As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim cont As Integer
    
    With Lista_Sets
        If SetCol = 0 Then
            If .TextMatrix(SetRow, 0) = "q" Then
                .TextMatrix(SetRow, 0) = "|fffd|"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &HE0E0E0
                Next col
            Else
                .TextMatrix(SetRow, 0) = "q"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &H80000005
                Next col
            End If
        
            filtro = ""
            For lin = 1 To .Rows - 1
                If filtro <> "" Then filtro = filtro & ", "
                filtro = filtro & .TextMatrix(lin, 1) & "#" & .TextMatrix(lin, 0)
            Next lin
        
            sql = "UPDATE tab_retirada SET FiltroSet = '" & filtro & "' " & _
                  "WHERE id_retirada = " & Lista_Materiais.TextMatrix(MaterialRow, 5)
            
            con.Execute sql
            
            filtro = ""
            For cont = 1 To .Rows - 1
                If .TextMatrix(cont, 0) = "|fffd|" Then
                    If filtro <> "" Then filtro = filtro & ", "
                    filtro = filtro & "'" & .TextMatrix(cont, 1) & "'"
                End If
            Next cont
            If filtro = "" Then filtro = "'ZZZ'"
            
            Set rs = New ADODB.Recordset
            
            sql = "SELECT DISTINCT FB.[Grower Proj], P.CodigoPrograma " & _
                  "FROM tab_fieldbook as FB " & _
                  "INNER JOIN tab_programa as P on P.ID_Programa = FB.[Grower Proj] " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                        "FB.Season='" & safra & "' and " & _
                        "FB.etiquetaimpressa=false and " & _
                        "FB.[plot deactivated]=false and " & _
                        "FB.[set] in (" & filtro & ")"
            
            rs.Open sql, con
            
            For cont = 1 To Lista_Grower.Rows - 1
                Lista_Grower.TextMatrix(cont, 0) = "q"
                For col = 0 To Lista_Grower.Cols - 1
                    Lista_Grower.Row = cont
                    Lista_Grower.col = col
                    Lista_Grower.CellBackColor = &H80000005
                Next col
            Next cont
            
            While Not rs.EOF
                For cont = 1 To Lista_Grower.Rows - 1
                    If Lista_Grower.TextMatrix(cont, 2) = rs("CodigoPrograma") Then
                        Lista_Grower.TextMatrix(cont, 0) = "|fffd|"
                        For col = 0 To Lista_Grower.Cols - 1
                            Lista_Grower.Row = cont
                            Lista_Grower.col = col
                            Lista_Grower.CellBackColor = &HE0E0E0
                        Next col
                        Exit For
                    End If
                Next cont
                
                rs.MoveNext
            Wend
            
            rs.Close
            
            sql = "SELECT DISTINCT FB.[Loc] " & _
                  "FROM tab_fieldbook as FB " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                        "FB.Season='" & safra & "' and " & _
                        "FB.etiquetaimpressa=false and " & _
                        "FB.[plot deactivated]=false and " & _
                        "FB.[set] in (" & filtro & ")"
            
            rs.Open sql, con
            
            For cont = 1 To Lista_Location.Rows - 1
                Lista_Location.TextMatrix(cont, 0) = "q"
                For col = 0 To Lista_Location.Cols - 1
                    Lista_Location.Row = cont
                    Lista_Location.col = col
                    Lista_Location.CellBackColor = &H80000005
                Next col
            Next cont
            
            While Not rs.EOF
                For cont = 1 To Lista_Location.Rows - 1
                    If Lista_Location.TextMatrix(cont, 1) = rs("Loc") Then
                        Lista_Location.TextMatrix(cont, 0) = "|fffd|"
                        For col = 0 To Lista_Location.Cols - 1
                            Lista_Location.Row = cont
                            Lista_Location.col = col
                            Lista_Location.CellBackColor = &HE0E0E0
                        Next col
                        Exit For
                    End If
                Next cont
                
                rs.MoveNext
            Wend
            
            rs.Close
            
            sql = "SELECT DISTINCT FB.[Rep#] " & _
                  "FROM tab_fieldbook as FB " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                        "FB.Season='" & safra & "' and " & _
                        "FB.etiquetaimpressa=false and " & _
                        "FB.[plot deactivated]=false and " & _
                        "FB.[set] in (" & filtro & ")"
            
            rs.Open sql, con
            
            For cont = 1 To Lista_Reps.Rows - 1
                Lista_Reps.TextMatrix(cont, 0) = "q"
                For col = 0 To Lista_Reps.Cols - 1
                    Lista_Reps.Row = cont
                    Lista_Reps.col = col
                    Lista_Reps.CellBackColor = &H80000005
                Next col
            Next cont
            
            While Not rs.EOF
                For cont = 1 To Lista_Reps.Rows - 1
                    If Lista_Reps.TextMatrix(cont, 1) = rs("Rep#") Then
                        Lista_Reps.TextMatrix(cont, 0) = "|fffd|"
                        For col = 0 To Lista_Reps.Cols - 1
                            Lista_Reps.Row = cont
                            Lista_Reps.col = col
                            Lista_Reps.CellBackColor = &HE0E0E0
                        Next col
                        Exit For
                    End If
                Next cont
                
                rs.MoveNext
            Wend
            
            rs.Close
            Set rs = Nothing
            
            Lista_Materiais_Click
            
        End If
        
    End With
    
    Calcula_Sementes
End Sub

Private Sub Lista_Sets_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    SetRow = Lista_Sets.MouseRow
    SetCol = Lista_Sets.MouseCol
End Sub

Private Sub Lista_Grower_Click()
    Dim lin As Long
    Dim col As Integer
    Dim filtro As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim cont As Integer
    
    With Lista_Grower
        If GrowerCol = 0 Then
            If .TextMatrix(GrowerRow, 0) = "q" Then
                .TextMatrix(GrowerRow, 0) = "|fffd|"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &HE0E0E0
                Next col
            Else
                .TextMatrix(GrowerRow, 0) = "q"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &H80000005
                Next col
            End If
        
            filtro = ""
            For lin = 1 To .Rows - 1
                If filtro <> "" Then filtro = filtro & ", "
                filtro = filtro & .TextMatrix(lin, 1) & "#" & .TextMatrix(lin, 0)
            Next lin
        
            sql = "UPDATE tab_retirada SET FiltroGrower = '" & filtro & "' " & _
                  "WHERE id_retirada = " & Lista_Materiais.TextMatrix(MaterialRow, 5)
            
            con.Execute sql
        
            filtro = ""
            For cont = 1 To .Rows - 1
                If .TextMatrix(cont, 0) = "|fffd|" Then
                    If filtro <> "" Then filtro = filtro & ", "
                    filtro = filtro & .TextMatrix(cont, 1)
                End If
            Next cont
            If filtro = "" Then filtro = "999"
            
            Set rs = New ADODB.Recordset
            
            sql = "SELECT DISTINCT FB.[Set] " & _
                  "FROM tab_fieldbook as FB " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                        "FB.Season='" & safra & "' and " & _
                        "FB.etiquetaimpressa=false and " & _
                        "FB.[plot deactivated]=false and " & _
                        "FB.[Grower Proj] in (" & filtro & ")"
            
            rs.Open sql, con
            
            For cont = 1 To Lista_Sets.Rows - 1
                Lista_Sets.TextMatrix(cont, 0) = "q"
                For col = 0 To Lista_Sets.Cols - 1
                    Lista_Sets.Row = cont
                    Lista_Sets.col = col
                    Lista_Sets.CellBackColor = &H80000005
                Next col
            Next cont
            
            While Not rs.EOF
                For cont = 1 To Lista_Sets.Rows - 1
                    If Lista_Sets.TextMatrix(cont, 1) = rs("Set") Then
                        Lista_Sets.TextMatrix(cont, 0) = "|fffd|"
                        For col = 0 To Lista_Sets.Cols - 1
                            Lista_Sets.Row = cont
                            Lista_Sets.col = col
                            Lista_Sets.CellBackColor = &HE0E0E0
                        Next col
                        Exit For
                    End If
                Next cont
                
                rs.MoveNext
            Wend
            
            rs.Close
            
            sql = "SELECT DISTINCT FB.[Loc] " & _
                  "FROM tab_fieldbook as FB " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                        "FB.Season='" & safra & "' and " & _
                        "FB.etiquetaimpressa=false and " & _
                        "FB.[plot deactivated]=false and " & _
                        "FB.[Grower Proj] in (" & filtro & ")"
            
            rs.Open sql, con
            
            For cont = 1 To Lista_Location.Rows - 1
                Lista_Location.TextMatrix(cont, 0) = "q"
                For col = 0 To Lista_Location.Cols - 1
                    Lista_Location.Row = cont
                    Lista_Location.col = col
                    Lista_Location.CellBackColor = &H80000005
                Next col
            Next cont
            
            While Not rs.EOF
                For cont = 1 To Lista_Location.Rows - 1
                    If Lista_Location.TextMatrix(cont, 1) = rs("Loc") Then
                        Lista_Location.TextMatrix(cont, 0) = "|fffd|"
                        For col = 0 To Lista_Location.Cols - 1
                            Lista_Location.Row = cont
                            Lista_Location.col = col
                            Lista_Location.CellBackColor = &HE0E0E0
                        Next col
                        Exit For
                    End If
                Next cont
                
                rs.MoveNext
            Wend
            
            rs.Close
            
            sql = "SELECT DISTINCT FB.[Rep#] " & _
                  "FROM tab_fieldbook as FB " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                        "FB.Season='" & safra & "' and " & _
                        "FB.etiquetaimpressa=false and " & _
                        "FB.[plot deactivated]=false and " & _
                        "FB.[Grower Proj] in (" & filtro & ")"
            
            rs.Open sql, con
            
            For cont = 1 To Lista_Reps.Rows - 1
                Lista_Reps.TextMatrix(cont, 0) = "q"
                For col = 0 To Lista_Reps.Cols - 1
                    Lista_Reps.Row = cont
                    Lista_Reps.col = col
                    Lista_Reps.CellBackColor = &H80000005
                Next col
            Next cont
            
            While Not rs.EOF
                For cont = 1 To Lista_Reps.Rows - 1
                    If Lista_Reps.TextMatrix(cont, 1) = rs("Rep#") Then
                        Lista_Reps.TextMatrix(cont, 0) = "|fffd|"
                        For col = 0 To Lista_Reps.Cols - 1
                            Lista_Reps.Row = cont
                            Lista_Reps.col = col
                            Lista_Reps.CellBackColor = &HE0E0E0
                        Next col
                        Exit For
                    End If
                Next cont
                
                rs.MoveNext
            Wend
            
            rs.Close
            Set rs = Nothing
            
        End If
    End With
    
    Calcula_Sementes
End Sub

Private Sub Lista_Grower_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    GrowerRow = Lista_Grower.MouseRow
    GrowerCol = Lista_Grower.MouseCol
End Sub

Private Sub Lista_Location_Click()
    Dim lin As Long
    Dim col As Integer
    Dim filtro As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim cont As Integer
    
    With Lista_Location
        If LocationCol = 0 Then
            If .TextMatrix(LocationRow, 0) = "q" Then
                .TextMatrix(LocationRow, 0) = "|fffd|"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &HE0E0E0
                Next col
            Else
                .TextMatrix(LocationRow, 0) = "q"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &H80000005
                Next col
            End If
        
            filtro = ""
            For lin = 1 To .Rows - 1
                If filtro <> "" Then filtro = filtro & ", "
                filtro = filtro & .TextMatrix(lin, 1) & "#" & .TextMatrix(lin, 0)
            Next lin
        
            sql = "UPDATE tab_retirada SET FiltroLoc = '" & filtro & "' " & _
                  "WHERE id_retirada = " & Lista_Materiais.TextMatrix(MaterialRow, 5)
            
            con.Execute sql
        
            filtro = ""
            For cont = 1 To .Rows - 1
                If .TextMatrix(cont, 0) = "|fffd|" Then
                    If filtro <> "" Then filtro = filtro & ", "
                    filtro = filtro & "'" & .TextMatrix(cont, 1) & "'"
                End If
            Next cont
            If filtro = "" Then filtro = "'ZZZ'"
            
            Set rs = New ADODB.Recordset
            
            sql = "SELECT DISTINCT FB.[Set] " & _
                  "FROM tab_fieldbook as FB " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                        "FB.Season='" & safra & "' and " & _
                        "FB.etiquetaimpressa=false and " & _
                        "FB.[plot deactivated]=false and " & _
                        "FB.[Loc] in (" & filtro & ")"
            
            rs.Open sql, con
            
            For cont = 1 To Lista_Sets.Rows - 1
                Lista_Sets.TextMatrix(cont, 0) = "q"
                For col = 0 To Lista_Sets.Cols - 1
                    Lista_Sets.Row = cont
                    Lista_Sets.col = col
                    Lista_Sets.CellBackColor = &H80000005
                Next col
            Next cont
            
            While Not rs.EOF
                For cont = 1 To Lista_Sets.Rows - 1
                    If Lista_Sets.TextMatrix(cont, 1) = rs("Set") Then
                        Lista_Sets.TextMatrix(cont, 0) = "|fffd|"
                        For col = 0 To Lista_Sets.Cols - 1
                            Lista_Sets.Row = cont
                            Lista_Sets.col = col
                            Lista_Sets.CellBackColor = &HE0E0E0
                        Next col
                        Exit For
                    End If
                Next cont
                
                rs.MoveNext
            Wend
            
            rs.Close
            
            sql = "SELECT DISTINCT FB.[Grower Proj], P.CodigoPrograma " & _
                  "FROM tab_fieldbook as FB " & _
                  "INNER JOIN tab_programa as P on P.ID_Programa = FB.[Grower Proj] " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                        "FB.Season='" & safra & "' and " & _
                        "FB.etiquetaimpressa=false and " & _
                        "FB.[plot deactivated]=false and " & _
                        "FB.[Loc] in (" & filtro & ")"
            
            rs.Open sql, con
            
            For cont = 1 To Lista_Grower.Rows - 1
                Lista_Grower.TextMatrix(cont, 0) = "q"
                For col = 0 To Lista_Grower.Cols - 1
                    Lista_Grower.Row = cont
                    Lista_Grower.col = col
                    Lista_Grower.CellBackColor = &H80000005
                Next col
            Next cont
            
            While Not rs.EOF
                For cont = 1 To Lista_Grower.Rows - 1
                    If Lista_Grower.TextMatrix(cont, 2) = rs("CodigoPrograma") Then
                        Lista_Grower.TextMatrix(cont, 0) = "|fffd|"
                        For col = 0 To Lista_Grower.Cols - 1
                            Lista_Grower.Row = cont
                            Lista_Grower.col = col
                            Lista_Grower.CellBackColor = &HE0E0E0
                        Next col
                        Exit For
                    End If
                Next cont
                
                rs.MoveNext
            Wend
            
            rs.Close
            
            sql = "SELECT DISTINCT FB.[Rep#] " & _
                  "FROM tab_fieldbook as FB " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                        "FB.Season='" & safra & "' and " & _
                        "FB.etiquetaimpressa=false and " & _
                        "FB.[plot deactivated]=false and " & _
                        "FB.[Loc] in (" & filtro & ")"
            
            rs.Open sql, con
            
            For cont = 1 To Lista_Reps.Rows - 1
                Lista_Reps.TextMatrix(cont, 0) = "q"
                For col = 0 To Lista_Reps.Cols - 1
                    Lista_Reps.Row = cont
                    Lista_Reps.col = col
                    Lista_Reps.CellBackColor = &H80000005
                Next col
            Next cont
            
            While Not rs.EOF
                For cont = 1 To Lista_Reps.Rows - 1
                    If Lista_Reps.TextMatrix(cont, 1) = rs("Rep#") Then
                        Lista_Reps.TextMatrix(cont, 0) = "|fffd|"
                        For col = 0 To Lista_Reps.Cols - 1
                            Lista_Reps.Row = cont
                            Lista_Reps.col = col
                            Lista_Reps.CellBackColor = &HE0E0E0
                        Next col
                        Exit For
                    End If
                Next cont
                
                rs.MoveNext
            Wend
            
            rs.Close
            Set rs = Nothing
            
        End If
    End With
    
    Calcula_Sementes
End Sub

Private Sub Lista_Location_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    LocationRow = Lista_Location.MouseRow
    LocationCol = Lista_Location.MouseCol
End Sub

Private Sub Lista_Reps_Click()
    Dim lin As Long
    Dim col As Integer
    Dim filtro As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim cont As Integer
    
    With Lista_Reps
        If RepCol = 0 Then
            If .TextMatrix(RepRow, 0) = "q" Then
                .TextMatrix(RepRow, 0) = "|fffd|"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &HE0E0E0
                Next col
            Else
                .TextMatrix(RepRow, 0) = "q"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &H80000005
                Next col
            End If
        
            filtro = ""
            For lin = 1 To .Rows - 1
                If filtro <> "" Then filtro = filtro & ", "
                filtro = filtro & .TextMatrix(lin, 1) & "#" & .TextMatrix(lin, 0)
            Next lin
        
            sql = "UPDATE tab_retirada SET FiltroRep = '" & filtro & "' " & _
                  "WHERE id_retirada = " & Lista_Materiais.TextMatrix(MaterialRow, 5)
            
            con.Execute sql
        
            filtro = ""
            For cont = 1 To .Rows - 1
                If .TextMatrix(cont, 0) = "|fffd|" Then
                    If filtro <> "" Then filtro = filtro & ", "
                    filtro = filtro & .TextMatrix(cont, 1)
                End If
            Next cont
            If filtro = "" Then filtro = "999"
            
            Set rs = New ADODB.Recordset
            
            sql = "SELECT DISTINCT FB.[Set] " & _
                  "FROM tab_fieldbook as FB " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                        "FB.Season='" & safra & "' and " & _
                        "FB.etiquetaimpressa=false and " & _
                        "FB.[plot deactivated]=false and " & _
                        "FB.[Rep#] in (" & filtro & ")"
            
            rs.Open sql, con
            
            For cont = 1 To Lista_Sets.Rows - 1
                Lista_Sets.TextMatrix(cont, 0) = "q"
                For col = 0 To Lista_Sets.Cols - 1
                    Lista_Sets.Row = cont
                    Lista_Sets.col = col
                    Lista_Sets.CellBackColor = &H80000005
                Next col
            Next cont
            
            While Not rs.EOF
                For cont = 1 To Lista_Sets.Rows - 1
                    If Lista_Sets.TextMatrix(cont, 1) = rs("Set") Then
                        Lista_Sets.TextMatrix(cont, 0) = "|fffd|"
                        For col = 0 To Lista_Sets.Cols - 1
                            Lista_Sets.Row = cont
                            Lista_Sets.col = col
                            Lista_Sets.CellBackColor = &HE0E0E0
                        Next col
                        Exit For
                    End If
                Next cont
                
                rs.MoveNext
            Wend
            
            rs.Close
            
            sql = "SELECT DISTINCT FB.[Grower Proj], P.CodigoPrograma " & _
                  "FROM tab_fieldbook as FB " & _
                  "INNER JOIN tab_programa as P on P.ID_Programa = FB.[Grower Proj] " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                        "FB.Season='" & safra & "' and " & _
                        "FB.etiquetaimpressa=false and " & _
                        "FB.[plot deactivated]=false and " & _
                        "FB.[Rep#] in (" & filtro & ")"
            
            rs.Open sql, con
            
            For cont = 1 To Lista_Grower.Rows - 1
                Lista_Grower.TextMatrix(cont, 0) = "q"
                For col = 0 To Lista_Grower.Cols - 1
                    Lista_Grower.Row = cont
                    Lista_Grower.col = col
                    Lista_Grower.CellBackColor = &H80000005
                Next col
            Next cont
            
            While Not rs.EOF
                For cont = 1 To Lista_Grower.Rows - 1
                    If Lista_Grower.TextMatrix(cont, 2) = rs("CodigoPrograma") Then
                        Lista_Grower.TextMatrix(cont, 0) = "|fffd|"
                        For col = 0 To Lista_Grower.Cols - 1
                            Lista_Grower.Row = cont
                            Lista_Grower.col = col
                            Lista_Grower.CellBackColor = &HE0E0E0
                        Next col
                        Exit For
                    End If
                Next cont
                
                rs.MoveNext
            Wend
            
            rs.Close
            
            sql = "SELECT DISTINCT FB.[Loc] " & _
                  "FROM tab_fieldbook as FB " & _
                  "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                        "FB.Season='" & safra & "' and " & _
                        "FB.etiquetaimpressa=false and " & _
                        "FB.[plot deactivated]=false and " & _
                        "FB.[Rep#] in (" & filtro & ")"
            
            rs.Open sql, con
            
            For cont = 1 To Lista_Location.Rows - 1
                Lista_Location.TextMatrix(cont, 0) = "q"
                For col = 0 To Lista_Location.Cols - 1
                    Lista_Location.Row = cont
                    Lista_Location.col = col
                    Lista_Location.CellBackColor = &H80000005
                Next col
            Next cont
            
            While Not rs.EOF
                For cont = 1 To Lista_Location.Rows - 1
                    If Lista_Location.TextMatrix(cont, 1) = rs("Loc") Then
                        Lista_Location.TextMatrix(cont, 0) = "|fffd|"
                        For col = 0 To Lista_Location.Cols - 1
                            Lista_Location.Row = cont
                            Lista_Location.col = col
                            Lista_Location.CellBackColor = &HE0E0E0
                        Next col
                        Exit For
                    End If
                Next cont
                
                rs.MoveNext
            Wend
            
            rs.Close
            Set rs = Nothing
            
        End If
    End With
    
    Calcula_Sementes
End Sub

Private Sub Lista_Reps_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    RepRow = Lista_Reps.MouseRow
    RepCol = Lista_Reps.MouseCol
End Sub

Private Sub UserForm_Initialize()
    Dim col As Integer
    Const texto = "MONTANDO ETIQUETAS..."
    
    Call AtivarBotoesMinMax(Me)
    Call Maximizar(Me)
    
    If con Is Nothing Then Conecta_Banco
'    usuario = "Robson"
'    CorFundoTela = RGB(229, 239, 218)
    
    safra = Pega_Safra
    BufferPadrao = Pega_BufferPadrao
    Margem = Pega_Margem
    
    ProgressBar1.Visible = False
    Label6.Visible = False
    Label7.Visible = False
    
    Label6.Caption = ""
    For col = 1 To Len(texto)
        If Label6.Caption <> "" Then Label6.Caption = Label6.Caption & vbNewLine
        Label6.Caption = Label6.Caption & Mid(texto, col, 1)
    Next col
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    Frame1.Height = Me.Height - Frame1.Top - 30
    Frame1.BackColor = CorFundoTela
    Frame2.BackColor = CorFundoTela
    Frame3.BackColor = CorFundoTela
    Frame4.BackColor = CorFundoTela
    Frame5.BackColor = CorFundoTela
    Frame6.BackColor = CorFundoTela
    Label4.Width = Me.Width - Label4.Left - 14
    With Label5
        .Top = Label4.Top + ((Label4.Height - .Height) / 2)
        .Left = Label4.Left + ((Label4.Width - .Width) / 2)
    End With
    
    btnMostrarTudo.Left = Label4.Left + 14
    btnImprimir.Left = Me.Width - btnImprimir.Width - 24
    btnExportar.Left = btnImprimir.Left - btnExportar.Width - 10
    With btnLimpeza
        .Left = btnExportar.Left - .Width - 10
        .Caption = "Limpeza de" & Chr(10) & "Cabe|fffd|ote"
        .font.size = 7
    End With
    
    With Lista_Materiais
        .Clear
        .Rows = 1
        .Cols = 6
        .Height = Frame1.Height - .Top - 10
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "ID_Material"
        .TextMatrix(0, 1) = "Material"
        .TextMatrix(0, 2) = "Inv BID"
        .TextMatrix(0, 3) = "Estoque"
        .TextMatrix(0, 4) = "Necessidade"
        .TextMatrix(0, 5) = "ID_Retirada"
        .FixedAlignment(1) = 7
        For col = 1 To .Cols - 1
            .FixedAlignment(col) = 4
        Next col
        .FixedAlignment(5) = 7
        
        .ColWidth(0) = 0
        .ColWidth(1) = 3100
        .ColWidth(2) = 2255
        .ColWidth(3) = 800
        .ColWidth(4) = 800
        .ColWidth(5) = 0
        
        .ColAlignment(0) = 7
        .ColAlignment(1) = 1
        .ColAlignment(2) = 1
        .ColAlignment(3) = 7
        .ColAlignment(4) = 7
        .ColAlignment(5) = 7
    End With
    
    With Lista_Sets
        .Clear
        .Rows = 1
        .Cols = 2
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Set"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 2200
        .ColAlignment(0) = 4
        .ColAlignment(1) = 1
    End With
    
    With Lista_Grower
        .Clear
        .Rows = 1
        .Cols = 3
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "ID_Grower"
        .TextMatrix(0, 2) = "Grower"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 7
        .FixedAlignment(2) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 0
        .ColWidth(2) = 800
        .ColAlignment(0) = 4
        .ColAlignment(1) = 7
        .ColAlignment(2) = 4
    End With
    
    With Lista_Location
        .Clear
        .Rows = 1
        .Cols = 2
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Location"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 800
        .ColAlignment(0) = 4
        .ColAlignment(1) = 4
    End With
    
    With Lista_Reps
        .Clear
        .Rows = 1
        .Cols = 2
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Rep"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 500
        .ColAlignment(0) = 4
        .ColAlignment(1) = 4
    End With
    
    With Lista_Imprimir
        .Clear
        .Rows = 1
        .Cols = 15
        .FixedCols = 1
        .Height = Me.Height - .Top - 30
        .Width = Me.Width - .Left - 14
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "Seq."
        .TextMatrix(0, 1) = "Orig Proj"
        .TextMatrix(0, 2) = "Grower Proj"
        .TextMatrix(0, 3) = "Location"
        .TextMatrix(0, 4) = "Set"
        .TextMatrix(0, 5) = "Field"
        .TextMatrix(0, 6) = "Plot BID"
        .TextMatrix(0, 7) = "Material"
        .TextMatrix(0, 8) = "Entry#"
        .TextMatrix(0, 9) = "Rep#"
        .TextMatrix(0, 10) = "AbsR"
        .TextMatrix(0, 11) = "AbsC"
        .TextMatrix(0, 12) = "Qtde Sementes"
        .TextMatrix(0, 13) = "Tratamento"
        .TextMatrix(0, 14) = "Buffer"
        For col = 0 To .Cols - 1
            .FixedAlignment(col) = 4
            .ColWidth(col) = 800
            If col < 8 Or col = 13 Then
                .ColAlignment(col) = 1
            Else
                .ColAlignment(col) = 7
            End If
        Next col
    End With
    
    Checa_RetiradaPendente
    
    Monta_Lista_Impressao
    
    itemSelected = False

End Sub

Private Sub Calcula_Sementes()
    Dim lin As Integer
    Dim col As Integer
    
    Dim filtroSet As String
    Dim filtroGrower As String
    Dim filtroLocation As String
    Dim filtroRep As String
    
    Dim sql As String
    
    Dim TotParcelas As Long
    Dim TotSeedPacket As Long
    Dim TotPacketParc As Long
    Dim TotSementes As Long
    
    Dim totEstoque As Long
    
    Dim rs As ADODB.Recordset
    
    totEstoque = Pega_Valor(Lista_Materiais.TextMatrix(MaterialRow, 3))
    
    filtroSet = ""
    With Lista_Sets
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtroSet <> "" Then filtroSet = filtroSet & ", "
                filtroSet = filtroSet & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    If filtroSet = "" Then filtroSet = "FB.[Set]='XXX'"
    
    filtroGrower = ""
    With Lista_Grower
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtroGrower <> "" Then filtroGrower = filtroGrower & ", "
                filtroGrower = filtroGrower & .TextMatrix(lin, 1)
            End If
        Next lin
    End With
    If filtroGrower = "" Then filtroGrower = "999"
    
    filtroLocation = ""
    With Lista_Location
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtroLocation <> "" Then filtroLocation = filtroLocation & ", "
                filtroLocation = filtroLocation & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    If filtroLocation = "" Then filtroLocation = "'XXX'"
    
    filtroRep = ""
    With Lista_Reps
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtroRep <> "" Then filtroRep = filtroRep & ", "
                filtroRep = filtroRep & .TextMatrix(lin, 1)
            End If
        Next lin
    End With
    If filtroRep = "" Then filtroRep = "999"
    
    sql = "SELECT Count(FB.[Plot Bid]) as TotParcela, P.QtdeSaqParcela, " & _
                 "(SELECT SUM(PT.QtdeSementes) " & _
                 "FROM tab_protocolotratamento as PT " & _
                 "WHERE PT.ID_Protocolo =P.ID_Protocolo) as QtdeSemente " & _
          "FROM tab_fieldbook as FB " & _
          "INNER JOIN tab_protocolo as P ON P.ID_Program = FB.[Orig Proj] and P.[Set] = FB.[Set] " & _
          "WHERE FB.Season='" & safra & "' AND " & _
                "FB.EtiquetaImpressa=false and " & _
                "FB.[Plot Deactivated]=false and " & _
                "FB.ID_Material=" & Lista_Materiais.TextMatrix(MaterialRow, 0) & " and " & _
                "FB.[Set] in (" & filtroSet & ") AND " & _
                "FB.[Grower Proj] in (" & filtroGrower & ") AND " & _
                "FB.[Loc] in (" & filtroLocation & ") AND " & _
                "FB.[Rep#] in (" & filtroRep & ") " & _
          "GROUP BY P.QtdeSaqParcela, ID_Protocolo"
    
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    TotParcelas = 0
    TotPacketParc = 0
    TotSeedPacket = 0
    TotSementes = 0
    
    While Not rs.EOF
        TotParcelas = IIf(IsNull(rs("TotParcela")), 0, rs("TotParcela"))
        TotPacketParc = IIf(IsNull(rs("QtdeSaqParcela")), 0, rs("QtdeSaqParcela"))
        TotSeedPacket = IIf(IsNull(rs("QtdeSemente")), 0, rs("QtdeSemente"))
        TotSeedPacket = TotSeedPacket + WorksheetFunction.RoundUp(TotSeedPacket * (Margem / 100), 0)
        
        TotSementes = TotSementes + ((TotSeedPacket * TotPacketParc) * TotParcelas)
        
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
    
    With Lista_Materiais
        .TextMatrix(MaterialRow, 3) = Format(totEstoque, "#,##0")
        .TextMatrix(MaterialRow, 4) = Format(TotSementes, "#,##0")
        
        .col = 4
        .Row = MaterialRow
    
        For col = 1 To .Cols - 1
            .col = col
            If totEstoque > TotSementes Then
                .CellBackColor = &H80FF80
            Else
                .CellBackColor = &H80C0FF
            End If
        Next col
    End With
    
    Monta_Lista_Impressao
End Sub

Private Sub Checa_RetiradaPendente()
    Dim rs As ADODB.Recordset
    Dim rs1 As ADODB.Recordset
    
    Dim lin As Long
    Dim col As Integer
    Dim para As Boolean
    
    Set rs = New ADODB.Recordset
    rs.Open "SELECT DISTINCT R.*, M.Pedigree, M.Lote, M.Localizacao, C.NomeCamaraFria, (E.Corredor & '-' & E.Prateleira & '-' & E.Andar & '-' & E.Numero) as Endereco, E.Comentario " & _
            "FROM ((((tab_retirada as R " & _
            "INNER JOIN tab_fieldbook as FB ON FB.[Inv BID] = R.[InvBID]) " & _
            "INNER JOIN tab_material as M on M.ID_Material = R.ID_Material) " & _
            "LEFT JOIN tab_camarafria as C on C.ID_CamaraFria = M.ID_CamaraFria) " & _
            "LEFT JOIN tab_camarafriaEndereco as E on E.ID_CamaraFria = M.ID_CamaraFria and E.ID_Endereco = M.ID_Endereco) " & _
            "WHERE R.retirou = true and " & _
                  "R.buffer = false and " & _
                  "R.data_retirada is not null and " & _
                  "FB.[EtiquetaImpressa]=false and " & _
                  "FB.[Plot Deactivated]=false and " & _
                  "FB.[Season] = '" & safra & "' " & _
            "ORDER BY M.Pedigree", con
    
    While Not rs.EOF
        With Lista_Materiais
            .Rows = .Rows + 1
            
            .TextMatrix(.Rows - 1, 0) = rs("ID_Material")
            .TextMatrix(.Rows - 1, 1) = rs("Pedigree")
            .TextMatrix(.Rows - 1, 2) = rs("InvBID")
            .TextMatrix(.Rows - 1, 3) = Format(rs("Estoque"), "#,##0")
            .TextMatrix(.Rows - 1, 4) = Format(rs("Necessidade"), "#,##0")
            .TextMatrix(.Rows - 1, 5) = rs("ID_Retirada")
        
            .col = 0
            .Row = .Rows - 1
            
            For col = 0 To .Cols - 1
                .col = col
                If rs("Estoque") > rs("Necessidade") Then
                    .CellBackColor = &H80FF80
                Else
                    .CellBackColor = &H80C0FF
                End If
            Next col
            
        End With
        
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
            
    AutosizeGridColumns Lista_Materiais, 1, 4
End Sub

Private Sub Monta_Lista_Impressao()
    Dim LinMaterial As Integer
    Dim lin As Integer
    Dim col As Integer
    Dim cont As Integer
    Dim cont1 As Integer
    
    Dim rs As ADODB.Recordset
    Dim rs1 As ADODB.Recordset
    
    Dim sql As String
    
    Dim filtroSet As String
    Dim filtroGrower As String
    Dim filtroLocation As String
    Dim filtroRep As String
    
    Dim filtro As Variant
    Dim flt As Variant
    
    Dim eBuffer As Boolean

    Lista_Imprimir.Rows = 1
    Lista_Imprimir.Visible = False
    
    For LinMaterial = 1 To Lista_Materiais.Rows - 1
        Set rs1 = New ADODB.Recordset
        rs1.Open "SELECT * FROM tab_retirada WHERE ID_Retirada = " & Lista_Materiais.TextMatrix(LinMaterial, 5), con
        
        filtroSet = ""
        filtro = Split(rs1("FiltroSet"), ", ")
        For cont = LBound(filtro) To UBound(filtro)
            flt = Split(filtro(cont), "#")
            If flt(1) = "|fffd|" Or chkSet Then
                If filtroSet <> "" Then filtroSet = filtroSet & ", "
                filtroSet = filtroSet & "'" & flt(0) & "'"
            End If
        Next cont
        If filtroSet = "" Then filtroSet = "'XXX'"
        
        filtroGrower = ""
        filtro = Split(rs1("FiltroGrower"), ", ")
        For cont = LBound(filtro) To UBound(filtro)
            flt = Split(filtro(cont), "#")
            If flt(1) = "|fffd|" Or chkGrower Then
                If filtroGrower <> "" Then filtroGrower = filtroGrower & ", "
                filtroGrower = filtroGrower & flt(0)
            End If
        Next cont
        If filtroGrower = "" Then filtroGrower = "999"
        
        filtroLocation = ""
        filtro = Split(rs1("FiltroLoc"), ", ")
        For cont = LBound(filtro) To UBound(filtro)
            flt = Split(filtro(cont), "#")
            If flt(1) = "|fffd|" Or chkLocation Then
                If filtroLocation <> "" Then filtroLocation = filtroLocation & ", "
                filtroLocation = filtroLocation & "'" & flt(0) & "'"
            End If
        Next cont
        If filtroLocation = "" Then filtroLocation = "'XXX'"
        
        filtroRep = ""
        filtro = Split(rs1("FiltroRep"), ", ")
        For cont = LBound(filtro) To UBound(filtro)
            flt = Split(filtro(cont), "#")
            If filtroRep <> "" Then filtroRep = filtroRep & ", "
            filtroRep = filtroRep & flt(0)
        Next cont
        If filtroRep = "" Then filtroRep = "999"
        
        sql = "SELECT OP.CodigoPrograma as Originator, FB.[Grower Proj], GP.CodigoPrograma as Grower, FB.[Set], FB.Field, FB.Loc, " & _
                     "FB.[Plot BID], M.Pedigree, FB.[Entry#], FB.[Rep#], FB.AbsR, FB.AbsC, P.QtdeSaqParcela, " & _
                     "T.NroTratamento, T.DescricaoTratamento, T.QtdeSementes " & _
              "FROM (((((tab_fieldbook as FB " & _
              "INNER JOIN tab_Material as M ON M.ID_Material = FB.ID_Material) " & _
              "INNER JOIN tab_Programa as OP ON OP.ID_Programa = FB.[Orig Proj]) " & _
              "INNER JOIN tab_Programa as GP ON GP.ID_Programa = FB.[Grower Proj]) " & _
              "INNER JOIN tab_protocolo as P ON P.[Set] = FB.[Set] and P.ID_Program = FB.[Orig Proj]) " & _
              "INNER JOIN tab_protocolotratamento as T on T.ID_Protocolo = P.ID_Protocolo) " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(LinMaterial, 0) & " and " & _
                    "FB.[Inv BID] = '" & Lista_Materiais.TextMatrix(LinMaterial, 2) & "' and " & _
                    "FB.[Plot Deactivated] = False and " & _
                    "FB.EtiquetaImpressa = False and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.[Set] in (" & filtroSet & ") and " & _
                    "FB.[Grower Proj] in (" & filtroGrower & ") and " & _
                    "FB.[Loc] in (" & filtroLocation & ") and " & _
                    "FB.[Rep#] in (" & filtroRep & ") " & _
              "ORDER BY M.Pedigree, T.QtdeSementes, FB.[Set], FB.Field, FB.AbsC, FB.AbsR"
        
        Set rs = New ADODB.Recordset
        rs.Open sql, con
        
        While Not rs.EOF
            For cont = 1 To rs("QtdeSaqParcela")
                With Lista_Imprimir
                    
                    .Rows = .Rows + 1
                    
                    .TextMatrix(.Rows - 1, 0) = .Rows - 1
                    .TextMatrix(.Rows - 1, 1) = rs("Originator")
                    .TextMatrix(.Rows - 1, 2) = rs("Grower")
                    .TextMatrix(.Rows - 1, 3) = rs("Loc")
                    .TextMatrix(.Rows - 1, 4) = rs("Set")
                    .TextMatrix(.Rows - 1, 5) = rs("Field")
                    .TextMatrix(.Rows - 1, 6) = rs("Plot BID")
                    .TextMatrix(.Rows - 1, 7) = rs("Pedigree")
                    .TextMatrix(.Rows - 1, 8) = rs("Entry#")
                    .TextMatrix(.Rows - 1, 9) = rs("Rep#")
                    .TextMatrix(.Rows - 1, 10) = rs("AbsR")
                    .TextMatrix(.Rows - 1, 11) = rs("AbsC") + (cont - 1)
                    .TextMatrix(.Rows - 1, 12) = rs("QtdeSementes") + WorksheetFunction.RoundUp(rs("QtdeSementes") * (Margem / 100), 0)
                    .TextMatrix(.Rows - 1, 13) = rs("DescricaoTratamento")
                    
                    eBuffer = False
                    filtro = Split(rs1("FiltroSet"), ", ")
                    For cont1 = LBound(filtro) To UBound(filtro)
                        flt = Split(filtro(cont1), "#")
                        If flt(0) = rs("Set") Then
                            If flt(1) = "q" And chkSet Then
                                eBuffer = True
                            End If
                        End If
                    Next cont1
                    
                    If Not eBuffer Then
                        filtro = Split(rs1("FiltroGrower"), ", ")
                        For cont1 = LBound(filtro) To UBound(filtro)
                            flt = Split(filtro(cont1), "#")
                            If flt(0) = rs("Grower Proj") Then
                                If flt(1) = "q" And chkGrower Then
                                    eBuffer = True
                                End If
                            End If
                        Next cont1
                    End If
                    
                    If Not eBuffer Then
                        filtro = Split(rs1("FiltroLoc"), ", ")
                        For cont1 = LBound(filtro) To UBound(filtro)
                            flt = Split(filtro(cont1), "#")
                            If flt(0) = rs("Loc") Then
                                If flt(1) = "q" And chkLocation Then
                                    eBuffer = True
                                End If
                            End If
                        Next cont1
                    End If
                    
                    If Not eBuffer Then
                        filtro = Split(rs1("FiltroRep"), ", ")
                        For cont1 = LBound(filtro) To UBound(filtro)
                            flt = Split(filtro(cont1), "#")
                            If flt(0) = rs("Rep#") Then
                                If flt(1) = "q" Then
                                    eBuffer = True
                                End If
                            End If
                        Next cont1
                    End If
                    
                    .col = 14
                    .Row = .Rows - 1
                    .FillStyle = flexFillRepeat
                    .CellFontName = "Wingdings"
                    .CellFontSize = 12
                    .CellAlignment = flexAlignCenterCenter
                    .FillStyle = flexFillSingle
                    
                    If eBuffer Then
                        .Text = "|fffd|"
                        .TextMatrix(.Rows - 1, 13) = "Buffer"
                    Else
                        .Text = "q"
                    End If
                    
                    For col = 0 To .Cols - 1
                        .col = col
                        If eBuffer Then
                            .CellBackColor = &HFFC0C0
                        Else
                            .CellBackColor = &H80000005
                        End If
                    Next col
                End With
            Next cont
        
            rs.MoveNext
        Wend
        
        rs.Close
        Set rs = Nothing
        
        rs1.Close
        Set rs1 = Nothing
    
    Next LinMaterial

    Lista_Imprimir.Visible = True
    
    AutosizeGridColumns Lista_Imprimir, 0, 13
    
End Sub
Attribute VB_Name = "form_iniciarcontagem"
Attribute VB_Base = "0{DF95068B-856E-437B-8FB1-78335F6A73F7}{FE637728-7003-4095-9247-9FE811AB2F50}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit
Dim safra As String
Dim MaterialRow As Integer
Dim ContadorRow As Integer

Private Sub btnConfirma_Click()
    Dim lin As Integer
    Dim sql As String
    
    With Lista_Contadores
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                sql = "INSERT INTO tab_contadormaterial (ID_Contador, ID_Material, Inicio, Termino) " & _
                      "VALUES (" & .TextMatrix(lin, 1) & ", " & .TextMatrix(lin, 4) & ",#" & Format(Date, "yyyy/mm/dd") & "#, null)"
                con.Execute sql
                
                sql = "UPDATE tab_contador SET Status = 'Em Uso' WHERE ID_Contador = " & .TextMatrix(lin, 1)
                con.Execute sql
            End If
        Next lin
    End With
    
    Monta_Lista_Materiais
    Monta_Lista_Contadores
    
    MaterialRow = 0
    ContadorRow = 0
    
End Sub

Private Sub edtFindMaterial_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim lin As Integer
    Dim col As Integer
    Dim achou As Boolean
    
    If KeyCode = vbKeyReturn Then
    
        If edtFindMaterial.Text = "" Then Exit Sub
        
        With Lista_Materiais
            achou = False
            MaterialRow = 0
            
            For lin = 1 To .Rows - 1
                If UCase(.TextMatrix(lin, 2)) = UCase(edtFindMaterial) Then
                    achou = True
                    MaterialRow = lin
                    Exit For
                End If
            Next lin
            
            If Not achou Then MsgBox "Material n|fffd|o encontrado.", vbInformation, "Pesquisa"
            
            If achou Then Lista_Materiais_Click
        
        End With
        
        edtFindMaterial.Text = ""
        edtFindMaterial.SetFocus
    End If
End Sub

Private Sub Lista_Contadores_Click()
    If ContadorRow > 0 And MaterialRow > 0 Then
        With Lista_Contadores
            If .TextMatrix(ContadorRow, 0) <> "|fffd|" Then
                If .TextMatrix(ContadorRow, 0) = "q" Then
                    .TextMatrix(ContadorRow, 0) = "|fffd|"
                    .TextMatrix(ContadorRow, 3) = Lista_Materiais.TextMatrix(MaterialRow, 1)
                    .TextMatrix(ContadorRow, 4) = Lista_Materiais.TextMatrix(MaterialRow, 0)
                ElseIf .TextMatrix(ContadorRow, 4) = Lista_Materiais.TextMatrix(MaterialRow, 0) Then
                    .TextMatrix(ContadorRow, 0) = "q"
                    .TextMatrix(ContadorRow, 3) = ""
                    .TextMatrix(ContadorRow, 4) = ""
                Else
                    If MsgBox("Este contador j|fffd| est|fffd| alocado para outro material, deseja substitu|fffd|-lo ?", vbYesNo + vbInformation, "Aten|fffd||fffd|o") = vbYes Then
                        .TextMatrix(ContadorRow, 3) = Lista_Materiais.TextMatrix(MaterialRow, 1)
                        .TextMatrix(ContadorRow, 4) = Lista_Materiais.TextMatrix(MaterialRow, 0)
                    End If
                End If
            End If
        End With
    End If
End Sub

Private Sub Lista_Contadores_MouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    ContadorRow = Lista_Contadores.MouseRow
End Sub

Private Sub Lista_Materiais_Click()
    Dim col As Integer
    Dim lin As Integer
    
    If MaterialRow > 0 Then
        With Lista_Materiais
            .col = 0
            .Row = MaterialRow
            
            If .CellBackColor = &HC0FFC0 Then
                MaterialRow = 0
            Else
                For lin = 1 To .Rows - 1
                    .Row = lin
                    For col = 0 To .Cols - 1
                        .col = col
                        
                        If lin = MaterialRow Then
                            .CellBackColor = &H8000000D
                        Else
                            .CellBackColor = &H80000005
                        End If
                    Next col
                Next lin
            End If
        End With
    End If
End Sub

Private Sub Lista_Materiais_MouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    MaterialRow = Lista_Materiais.MouseRow
End Sub

Private Sub UserForm_Initialize()
    Dim col As Integer
    
    If con Is Nothing Then Conecta_Banco
    
    safra = Pega_Safra
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    Frame1.BackColor = CorFundoTela
    Frame2.BackColor = CorFundoTela
    
    With Lista_Materiais
        .Clear
        .Rows = 1
        .Cols = 3
        .Height = Frame1.Height - .Top - 10
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "ID_Material"
        .TextMatrix(0, 1) = "Material"
        .TextMatrix(0, 2) = "Inv BID"
        .FixedAlignment(1) = 7
        For col = 1 To .Cols - 1
            .FixedAlignment(col) = 4
        Next col
        .ColWidth(0) = 0
        .ColWidth(1) = 3100
        .ColWidth(2) = 2255
        .ColAlignment(0) = 7
        .ColAlignment(1) = 1
        .ColAlignment(2) = 1
    End With
    
    With Lista_Contadores
        .Clear
        .Rows = 1
        .Cols = 5
        .Height = Frame2.Height - .Top - 10
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Contador"
        .TextMatrix(0, 2) = "Respons|fffd|vel"
        .TextMatrix(0, 3) = "Material"
        .TextMatrix(0, 4) = "ID_Material"
        For col = 0 To .Cols - 1
            .FixedAlignment(col) = 4
            .ColWidth(col) = 500
            If col = 1 Then
                .ColAlignment(col) = 4
            Else
                .ColAlignment(col) = 1
            End If
        Next col
        .ColWidth(4) = 0
        .ColAlignment(4) = 7
    End With
    
    Call Centralizar(Me)
    
    Monta_Lista_Materiais
    Monta_Lista_Contadores
    
    MaterialRow = 0
    ContadorRow = 0
    
End Sub

Private Sub Monta_Lista_Materiais()
    Dim sql As String
    Dim rs1 As ADODB.Recordset
    Dim rs2 As ADODB.Recordset
    Dim cont As Integer
    
    sql = "SELECT DISTINCT M.ID_Material, M.Pedigree, FB.[Inv BID] " & _
          "FROM tab_fieldbook as FB " & _
          "INNER JOIN tab_material as M on M.ID_Material = FB.ID_Material " & _
          "WHERE FB.Season= '" & safra & "' AND " & _
                "FB.EtiquetaImpressa = True AND " & _
                "FB.CheckContagem = False AND " & _
                "M.Status = 'Em Uso' " & _
          "ORDER BY M.Pedigree"
          
    Set rs1 = New ADODB.Recordset
    rs1.Open sql, con
    
    Set rs2 = New ADODB.Recordset
    
    With Lista_Materiais
        .Rows = 1
        
        While Not rs1.EOF
            .Rows = .Rows + 1
            
            .TextMatrix(.Rows - 1, 0) = rs1("ID_Material")
            .TextMatrix(.Rows - 1, 1) = rs1("Pedigree")
            .TextMatrix(.Rows - 1, 2) = rs1("Inv BID")
            
            rs2.Open "SELECT Count(ID_Material) as cont " & _
                     "FROM tab_contadormaterial " & _
                     "WHERE ID_Material = " & rs1("ID_Material") & " and Termino is null", con
            
            .Row = .Rows - 1
            For cont = 0 To .Cols - 1
                .col = cont
                If rs2("cont") = 0 Then
                    .CellBackColor = &HFFFFFF
                Else
                    .CellBackColor = &HC0FFC0
                End If
            Next cont
            
            rs2.Close
            
            rs1.MoveNext
        Wend
    End With
    
    rs1.Close
    Set rs1 = Nothing
    Set rs2 = Nothing
    
    AutosizeGridColumns Lista_Materiais, 1, 2
End Sub

Private Sub Monta_Lista_Contadores()
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim cont As Integer
    
    sql = "SELECT C.ID_Contador, C.Responsavel, IIF(C.Status<>'Em Uso',''," & _
            "(SELECT M.ID_Material & '#' & M.Pedigree " & _
            "FROM tab_contadormaterial as CM " & _
            "INNER JOIN tab_material as M on M.ID_Material = CM.ID_Material " & _
            "WHERE CM.ID_Contador = C.ID_Contador and CM.Termino is null)) as Material, C.Status  " & _
          "FROM tab_contador as C"
          
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    With Lista_Contadores
        .Rows = 1
        
        While Not rs.EOF
            .Rows = .Rows + 1
            
            .col = 0
            .Row = .Rows - 1
                
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            .Text = "q"
            
            .TextMatrix(.Rows - 1, 1) = rs("ID_Contador")
            .TextMatrix(.Rows - 1, 2) = rs("Responsavel")
            If IsNull(rs("Material")) Or rs("Material") = "" Then
                .TextMatrix(.Rows - 1, 3) = ""
                .TextMatrix(.Rows - 1, 4) = ""
            Else
                .TextMatrix(.Rows - 1, 3) = Right(rs("Material"), Len(rs("Material")) - InStr(rs("Material"), "#"))
                .TextMatrix(.Rows - 1, 4) = Left(rs("Material"), InStr(rs("Material"), "#") - 1)
            End If
            
            .Row = .Rows - 1
            For cont = 0 To .Cols - 1
                .col = cont
                If rs("Status") = "Liberado" Then
                    .CellBackColor = &HFFFFFF
                ElseIf rs("Status") = "Em Uso" Then
                    .CellBackColor = &HFFFFC0
                    .TextMatrix(.Rows - 1, 0) = "|fffd|"
                Else
                    .CellBackColor = &HFF
                    .CellForeColor = &HFFFFFF
                    .TextMatrix(.Rows - 1, 0) = "|fffd|"
                End If
            Next cont
            
            rs.MoveNext
        Wend
    End With
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Lista_Contadores, 1, 3
End Sub
Attribute VB_Name = "form_login"
Attribute VB_Base = "0{7FCF7BB4-9AB1-4B6A-A714-7340FB6B6EF9}{9E71827E-8821-4104-8FFC-177CF7FE9CA8}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btnLogar_Click()
    Dim sql As String
    Dim valido As Boolean
    
    valido = False
    
    If edtUsuario.Text = "" Then
        MsgBox "Informe o usu|fffd|rio.", vbOKOnly + vbInformation, "Login"
    ElseIf edtSenha.Text = "" Then
        MsgBox "Informe a senha.", vbOKOnly + vbInformation, "Login"
    Else
        sql = "SELECT * FROM tab_usuario WHERE usuario='" & edtUsuario.Text & "' and Senha='" & edtSenha.Text & "'"
        Set rsUserLogado = New ADODB.Recordset
        rsUserLogado.Open sql, con
        
        If rsUserLogado.EOF Then
            MsgBox "Usu|fffd|rio e/ou Senha Inv|fffd|lido.", vbOKOnly + vbInformation, "Login"
        Else
            valido = True
        End If
    End If
    
    If valido Then
        Call Maximizar(form_menu)
    End If
End Sub

Private Sub edtUsuario_Change()
    edtUsuario.Text = UCase(edtUsuario.Text)
End Sub

Private Sub UserForm_Initialize()

    Set formAtual = Me
    
    valido = False
    
    CorFundoTela = RGB(229, 239, 218)
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    Conecta_Banco
    
    usuario = UCase(Environ("username"))
    
    edtUsuario.Text = usuario
    edtSenha.Text = ""
    
    Call Centralizar(Me)
    
End Sub

Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    If formAtual.Name = "form_login" Then ThisWorkbook.Close SaveChanges:=False
End Sub
Attribute VB_Name = "form_mapawinterstiger"
Attribute VB_Base = "0{CA137F35-F42C-4366-9AB1-09E41BC37794}{5CCC7393-814A-4044-81A5-F604E75A0E30}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim safra As String
Dim FieldRow As Integer
Dim FieldCol As Integer

Private Sub btnExportar_Click()
    Dim sql As String
    Dim filtro As String
    Dim lin As Integer
    
    filtro = ""
    
    With Lista_Fields
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtro <> "" Then filtro = filtro & ", "
                filtro = filtro & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    
    If filtro = "" Then Exit Sub
    
    If Lista_Mapa.Rows > 1 Then
        sql = "UPDATE tab_fieldbook " & _
              "SET " & _
                   "MapaGerado=TRUE, " & _
                   "DataMapa=#" & Format(Date, "yyyy/mm/dd") & "#, " & _
                   "UsuarioMapa='" & usuario & "' " & _
              "WHERE Field in (" & filtro & ") and Season='" & safra & "'"
        
        con.Execute sql
        
        Exportar Lista_Mapa
    End If
End Sub

Private Sub btnMontarMapa_Click()
    If edtEspacamento = "" Or edtCorredor = "" Or edtRanhuras = "" Then Exit Sub
    
    Monta_Lista_Mapa
End Sub

Private Sub edtCorredor_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If Somente_Numeros(KeyAscii, False, True) = False Then
        KeyAscii = 0
    End If
End Sub

Private Sub edtEspacamento_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If Somente_Numeros(KeyAscii, False, True) = False Then
        KeyAscii = 0
    End If
End Sub

Private Sub edtFiltroFields_Change()
    Dim lin As Integer
    
    edtFiltroFields = UCase(edtFiltroFields)
    
    With Lista_Fields
        For lin = 1 To .Rows - 1
            If edtFiltroFields = "" Or Left(.TextMatrix(lin, 1), Len(edtFiltroFields)) = edtFiltroFields Then
                .RowHeight(lin) = 240
            Else
                .RowHeight(lin) = 0
            End If
        Next lin
    End With
End Sub

Private Sub Lista_Fields_Click()
    If FieldRow = 0 Then Exit Sub
    
    If FieldCol = 0 Then
        With Lista_Fields
            .col = FieldCol
            .Row = FieldRow
            If .Text = "q" Then
                .Text = "|fffd|"
            Else
                .Text = "q"
            End If
        End With
    End If
End Sub

Private Sub Lista_Fields_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    FieldRow = Lista_Fields.MouseRow
    FieldCol = Lista_Fields.MouseCol
End Sub

Private Sub edtRanhuras_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If Somente_Numeros(KeyAscii, False, True) = False Then
        KeyAscii = 0
    End If
End Sub

Private Sub UserForm_Initialize()
    Dim cont As Integer
    
    If con Is Nothing Then Conecta_Banco
'    CorFundoTela = RGB(229, 239, 218)
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    Frame1.BackColor = CorFundoTela
    Frame2.BackColor = CorFundoTela
    
    safra = Pega_Safra
    
    With Lista_Fields
        .Clear
        .Rows = 1
        .Cols = 2
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarVertical
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Fields"
        For cont = 0 To .Cols - 1
            .FixedAlignment(cont) = 4
        Next cont
        .ColWidth(0) = 300
        .ColWidth(1) = 2400
        .ColAlignment(0) = 4
        .ColAlignment(1) = 1
    End With
    
    With Lista_Mapa
        .Clear
        .Rows = 1
        .Cols = 32
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "Track Parameters Harv Rows/Plot"
        .TextMatrix(0, 1) = "Track Parameters Packets/Plot"
        .TextMatrix(0, 2) = "Track Parameters Rows/Plot"
        .TextMatrix(0, 3) = "Track Parameters Harv Type"
        .TextMatrix(0, 4) = "Track Parameters Ranges/Plot"
        .TextMatrix(0, 5) = "Track Parameters Seeds/Packet"
        .TextMatrix(0, 6) = "Track Parameters Track Intent"
        .TextMatrix(0, 7) = "Track Parameters Track Intent Comment"
        .TextMatrix(0, 8) = "Planted Plot Length"
        .TextMatrix(0, 9) = "Planted Plot Width"
        .TextMatrix(0, 10) = "Seeds/Packet"
        .TextMatrix(0, 11) = "Set"
        .TextMatrix(0, 12) = "Orig Proj"
        .TextMatrix(0, 13) = "Orig Program"
        .TextMatrix(0, 14) = "Grower Program"
        .TextMatrix(0, 15) = "Crop"
        .TextMatrix(0, 16) = "Entry#"
        .TextMatrix(0, 17) = "TrackID"
        .TextMatrix(0, 18) = "Rep#"
        .TextMatrix(0, 19) = "Plot#"
        .TextMatrix(0, 20) = "Plot BID"
        .TextMatrix(0, 21) = "Prod"
        .TextMatrix(0, 22) = "AbsR"
        .TextMatrix(0, 23) = "AbsC"
        .TextMatrix(0, 24) = "BLOCO"
        .TextMatrix(0, 25) = "LINHA"
        .TextMatrix(0, 26) = "Espa|fffd|amento"
        .TextMatrix(0, 27) = "Ranhuras do Disco"
        .TextMatrix(0, 28) = "Corredor"
        .TextMatrix(0, 29) = "Seeds/plot"
        .TextMatrix(0, 30) = "BLOCO/LINHA"
        .TextMatrix(0, 31) = "Indice"
        For cont = 0 To .Cols - 1
            .FixedAlignment(cont) = 4
            .ColWidth(cont) = 300
            Select Case cont
                Case 0, 1, 2, 4, 5, 8, 9, 10, 16, 17, 18, 19, 22, 23, 24, 25, 26, 27, 28, 29, 31
                    .ColAlignment(cont) = 7
                Case Else
                    .ColAlignment(cont) = 1
            End Select
            
            .FixedCols = 0
            .ColWidth(31) = 0
        Next cont
    End With
    
    AutosizeGridColumns Lista_Mapa, 0, 30
    
    Monta_Lista_Fields
End Sub

Private Sub Monta_Lista_Fields()
    Dim sql As String
    Dim rs As ADODB.Recordset
    
    sql = "SELECT DISTINCT Field " & _
          "FROM tab_fieldbook " & _
          "WHERE CheckSorteio = true and Season ='" & safra & "' and MapaGerado = false " & _
          "ORDER BY Field"
          
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    Lista_Fields.Rows = 1
    
    While Not rs.EOF
        With Lista_Fields
            .Rows = .Rows + 1
            
            .Row = .Rows - 1
            .col = 0
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            .Text = "q"
            
            .col = 1
            .Text = rs("Field")
        End With
        
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
End Sub

Private Sub Monta_Lista_Mapa()
    Dim lin As Integer
    Dim filtro As String
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim Bloco As Integer
    Dim linha As Integer
    Dim AbsCAnt As Integer
    Dim NroLinParc As Integer
    Dim cont As Integer
    Dim seedpkt As Integer
    Dim AbsRAnt As Integer
    Dim x As Integer
    
    filtro = ""
    
    With Lista_Fields
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtro <> "" Then filtro = filtro & ", "
                filtro = filtro & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    
    If filtro = "" Then Exit Sub
    
    sql = "SELECT Min(F.[Track Parameters Rows/Plot]) as TPRP " & _
          "FROM tab_fieldbook as F " & _
          "WHERE F.Field in (" & filtro & ") and F.Season='" & safra & "' and F.[Track Parameters Rows/Plot] is not null"
    
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    seedpkt = rs("TPRP")
    rs.Close
    Set rs = Nothing
    If seedpkt > 2 Then seedpkt = 2
    
    sql = "SELECT F.*, M.Pedigree, P.CodigoPrograma as [OrigProj], P.[Localidade] as [Orig Program] " & _
          "FROM ((tab_fieldbook as F " & _
          "INNER JOIN tab_material as M ON M.ID_Material = F.ID_Material) " & _
          "LEFT JOIN tab_programa as P ON P.ID_Programa = F.[Orig Proj]) " & _
          "WHERE F.Field in (" & filtro & ") and F.Season='" & safra & "' " & _
          "ORDER BY F.AbsC, F.AbsR"
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    With Lista_Mapa
        .Rows = 1
        
        AbsCAnt = 0
        Bloco = 0
        linha = 0
        AbsRAnt = 0
        
        While Not rs.EOF
        
            If rs("AbsC") <> AbsCAnt Then
                linha = linha + 1
                Bloco = 0
                AbsCAnt = rs("AbsC")
                AbsRAnt = rs("AbsR")
            End If
            
            If IsNull(rs("Track Parameters Rows/Plot")) Or _
               rs("Track Parameters Rows/Plot") < 4 Then
                NroLinParc = 1
            Else
                NroLinParc = rs("Track Parameters Rows/Plot") / 2
            End If
            
            For cont = 1 To NroLinParc
                .Rows = .Rows + 1
                If rs("absc") = 372 And rs("absr") = 8 Then
                    x = 0
                End If
                If cont = 1 Then
                    Bloco = Bloco + 1
                    If rs("AbsR") - AbsRAnt > 1 Then
                        Bloco = Bloco + (rs("AbsR") - AbsRAnt - 1)
                    End If
                    AbsRAnt = rs("AbsR")
                End If
                .TextMatrix(.Rows - 1, 0) = IIf(IsNull(rs("Track Parameters Harv Rows/Plot")), "", rs("Track Parameters Harv Rows/Plot"))
                .TextMatrix(.Rows - 1, 1) = IIf(IsNull(rs("Track Parameters Packets/Plot")), "", rs("Track Parameters Packets/Plot"))
'                .TextMatrix(.Rows - 1, 2) = IIf(IsNull(rs("Track Parameters Rows/Plot")), "", rs("Track Parameters Rows/Plot"))
                .TextMatrix(.Rows - 1, 2) = seedpkt
                .TextMatrix(.Rows - 1, 3) = IIf(IsNull(rs("Track Parameters Harv Type")), "", rs("Track Parameters Harv Type"))
                .TextMatrix(.Rows - 1, 4) = IIf(IsNull(rs("Track Parameters Ranges/Plot")), "", rs("Track Parameters Ranges/Plot"))
                .TextMatrix(.Rows - 1, 5) = IIf(IsNull(rs("Track Parameters Seeds/Packet")), "", rs("Track Parameters Seeds/Packet"))
                .TextMatrix(.Rows - 1, 6) = IIf(IsNull(rs("Track Parameters Track Intent")), "", rs("Track Parameters Track Intent"))
                .TextMatrix(.Rows - 1, 7) = IIf(IsNull(rs("Track Parameters Track Intent Comment")), "", rs("Track Parameters Track Intent Comment"))
                .TextMatrix(.Rows - 1, 8) = IIf(IsNull(rs("Planted Plot Length")), "", (rs("Planted Plot Length") * 100) - Val(edtCorredor))
                .TextMatrix(.Rows - 1, 9) = IIf(IsNull(rs("Planted Plot Width")), "", rs("Planted Plot Width") / NroLinParc)
                .TextMatrix(.Rows - 1, 10) = IIf(IsNull(rs("Seeds/Packet")), "", rs("Seeds/Packet") - 8)
                .TextMatrix(.Rows - 1, 11) = IIf(IsNull(rs("Set")), "", rs("Set"))
                .TextMatrix(.Rows - 1, 12) = IIf(IsNull(rs("OrigProj")), "", rs("OrigProj"))
                .TextMatrix(.Rows - 1, 13) = IIf(IsNull(rs("Orig Program")), "", rs("Orig Program"))
                .TextMatrix(.Rows - 1, 14) = IIf(IsNull(rs("Grower Program")), "", rs("Grower Program"))
                .TextMatrix(.Rows - 1, 15) = IIf(IsNull(rs("Crop")), "", rs("Crop"))
                .TextMatrix(.Rows - 1, 16) = IIf(IsNull(rs("Entry#")), "", rs("Entry#"))
                .TextMatrix(.Rows - 1, 17) = IIf(IsNull(rs("TrackID")), "", rs("TrackID"))
                .TextMatrix(.Rows - 1, 18) = IIf(IsNull(rs("Rep#")), "", rs("Rep#"))
                .TextMatrix(.Rows - 1, 19) = IIf(IsNull(rs("Plot#")), "", rs("Plot#"))
                .TextMatrix(.Rows - 1, 20) = IIf(IsNull(rs("Plot BID")), "", rs("Plot BID"))
                .TextMatrix(.Rows - 1, 21) = IIf(IsNull(rs("Pedigree")), "", rs("Pedigree"))
                .TextMatrix(.Rows - 1, 22) = IIf(IsNull(rs("AbsR")), "", rs("AbsR"))
                .TextMatrix(.Rows - 1, 23) = IIf(IsNull(rs("AbsC")), "", rs("AbsC") + (cont - 1))
                .TextMatrix(.Rows - 1, 24) = Bloco
                .TextMatrix(.Rows - 1, 25) = linha + (cont - 1)
                .TextMatrix(.Rows - 1, 26) = edtEspacamento
                .TextMatrix(.Rows - 1, 27) = edtRanhuras
                .TextMatrix(.Rows - 1, 28) = edtCorredor
                .TextMatrix(.Rows - 1, 29) = rs("Seeds/Packet") - 8
                .TextMatrix(.Rows - 1, 30) = "R " & rs("AbsR") & " / C" & (rs("AbsC") + (cont - 1)) & " - " & rs("Pedigree")
                .TextMatrix(.Rows - 1, 31) = Format(linha + (cont - 1), "000") & Format(Bloco, "000")
            Next cont
        
            rs.MoveNext
        Wend
        
        .col = 31
        .ColSel = 31
        .Sort = flexSortNumericAscending
    End With
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Lista_Mapa, 0, 30
End Sub
Attribute VB_Name = "form_material"
Attribute VB_Base = "0{18355C81-41BE-4182-897B-B238F68DB323}{A0FAB81D-0062-40E7-ADF2-7ABD8C45A43A}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim LinSelect As Integer
Dim ColSelect As Integer

Dim PrimeiraLetra As Boolean
Dim Processar As Boolean

Private Sub Cadastrados_Click()
    LinSelect = Cadastrados.RowSel
    
    If LinSelect > 0 Then
        edtCodigo.Text = Cadastrados.TextMatrix(LinSelect, 0)
        edtPedigree.Text = Cadastrados.TextMatrix(LinSelect, 1)
        edtEvento.Text = Cadastrados.TextMatrix(LinSelect, 2)
        edtSource.Text = Cadastrados.TextMatrix(LinSelect, 3)
        edtLote.Text = Cadastrados.TextMatrix(LinSelect, 4)
        edtFornecedor.Text = Cadastrados.TextMatrix(LinSelect, 5)
        edtDataRecebimento.Value = Cadastrados.TextMatrix(LinSelect, 6)
        edtGerminacao.Text = Cadastrados.TextMatrix(LinSelect, 7)
        edtVigor.Text = Cadastrados.TextMatrix(LinSelect, 8)
        edtEnviadoPor.Text = Cadastrados.TextMatrix(LinSelect, 9)
        edtRecebidoPor.Text = Cadastrados.TextMatrix(LinSelect, 10)
        cmbLocalizacao.Text = Cadastrados.TextMatrix(LinSelect, 11)
        cmbCamaraFria = Cadastrados.TextMatrix(LinSelect, 12)
        Call Monta_ComboEndereco
        cmbEndereco = Cadastrados.TextMatrix(LinSelect, 13)
        cmbStatus = Cadastrados.TextMatrix(LinSelect, 14)
        edtObservacao.Text = Cadastrados.TextMatrix(LinSelect, 18)

        If Cadastrados.TextMatrix(LinSelect, 15) = "q" Then
            chkRegulatorio.Value = False
        Else
            chkRegulatorio.Value = True
        End If

        If Cadastrados.TextMatrix(LinSelect, 16) = "q" Then
            chkStewardShip.Value = False
        Else
            chkStewardShip.Value = True
        End If
        
        Mostra_Programas
    End If
End Sub

Private Sub chkFiltrarReg_Click()
    Mostra_Cadastrados
End Sub

Private Sub chkFiltrarSts_Click()
    Mostra_Cadastrados
End Sub

Private Sub chkRegulatorio_Click()
    If chkRegulatorio And chkStewardShip Then
        chkStewardShip = False
    End If
End Sub

Private Sub chkStewardShip_Click()
    If chkStewardShip And chkRegulatorio Then
        chkRegulatorio = False
    End If
End Sub

Private Sub cmbCamaraFria_Change()
    If cmbCamaraFria.Text = "" Then
        cmbEndereco.Clear
    Else
        Monta_ComboEndereco
    End If
End Sub

Private Sub cmbFiltroEvento_Change()
    If Processar Then Mostra_Cadastrados
End Sub

Private Sub edtDataRecebimento_DblClick(ByVal Cancel As MSForms.ReturnBoolean)
    edtDataRecebimento_Enter
End Sub

Private Sub edtDataRecebimento_Enter()
    DataCalendario = DateValue(edtDataRecebimento.Text)
        
    CalendarFrm.Show
        
    edtDataRecebimento.Text = Format(DataCalendario, "dd/mmm/yyyy")
    
    Application.Cursor = xlDefault
End Sub

Private Sub edtEvento_Change()
    edtEvento.Text = UCase(edtEvento.Text)
End Sub

Private Sub edtGerminacao_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If Somente_Numeros(KeyAscii, True, True) = False Then KeyAscii = 0
End Sub

Private Sub edtPedigree_Change()
    edtPedigree.Text = UCase(edtPedigree.Text)
End Sub

Private Sub edtSource_Change()
    edtSource.Text = UCase(edtSource.Text)
End Sub

Private Sub edtLote_Change()
    edtLote.Text = UCase(edtLote.Text)
End Sub

Private Sub edtFornecedor_Change()
    edtFornecedor.Text = UCase(edtFornecedor.Text)
End Sub

Private Sub edtEnviadoPor_Change()
    edtEnviadoPor.Text = UCase(edtEnviadoPor.Text)
End Sub

Private Sub edtRecebidoPor_Change()
    edtRecebidoPor.Text = UCase(edtRecebidoPor.Text)
End Sub

Private Sub edtVigor_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If Somente_Numeros(KeyAscii, True, True) = False Then KeyAscii = 0
End Sub

Private Sub Menu_ButtonClick(ByVal Button As MSComctlLib.Button)
    Select Case Button.Key
        Case Is = "Novo"
            Limpa_Campos
            Habilita_Campos True
            cmbStatus = "Ativo"
            edtPedigree.SetFocus
        Case Is = "Alterar"
            If edtCodigo.Text <> "" Then
                Habilita_Campos True
            End If
        Case Is = "Excluir"
            Excluir_Dados
        Case Is = "Cancelar"
            Limpa_Campos
            Habilita_Campos False
        Case Is = "Salvar"
            Salvar_Dados
        Case Is = "Importar"
            Importar_Materiais
            Limpa_Campos
            Habilita_Campos False
            Mostra_Cadastrados
    End Select
End Sub

Private Sub menuProgramas_ButtonClick(ByVal Button As MSComctlLib.Button)
    Dim cont As Integer
    
    Select Case Button.Key
        Case Is = "Novo"
            Programas.Rows = Programas.Rows + 1
            Programas.TextMatrix(Programas.Rows - 1, 0) = Programas.Rows - 1
        Case Is = "Excluir"
            If LinSelect > 0 Then
                Programas.RemoveItem (LinSelect)
                For cont = 1 To Programas.Rows - 1
                    Programas.TextMatrix(cont, 0) = cont
                Next cont
            End If
    End Select
End Sub

Private Sub Programas_Click()
    If LinSelect > 0 Then
        If ColSelect = 1 Then
            Set The_Menu = CreatePopUp_Programas(LinSelect)
            The_Menu.ShowPopup
        End If
    End If
End Sub

Private Sub Programas_KeyPress(KeyAscii As Integer)
    If Programas.RowSel <= 0 Then Exit Sub
    
    If ColSelect > 0 Then
        With Programas
            .col = ColSelect
            Select Case KeyAscii
                Case vbKeyReturn, vbKeyTab
                    If .Row + 1 <= .Rows - 1 Then
                        .Row = .Row + 1
                    Else
                        .Row = 1
                    End If
                    PrimeiraLetra = True
                    
                Case vbKeyBack
                    'remove o ultimo caractere
                    If Len(.Text) Then
                        .Text = Left(.Text, Len(.Text) - 1)
                    End If
        
                Case Is < 32
        
                Case Else
                    If PrimeiraLetra Then
                        PrimeiraLetra = False
                        .Text = ""
                    End If
                    .Text = .Text & Chr(KeyAscii)
            End Select
        End With
    End If

End Sub

Private Sub Programas_MouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    LinSelect = Programas.MouseRow
    ColSelect = Programas.MouseCol
End Sub

Private Sub UserForm_Initialize()
    Dim cont As Integer
    
    If con Is Nothing Then Conecta_Banco
'    usuario = "ROBSO"
'    CorFundoTela = RGB(229, 239, 218)
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    Frame1.BackColor = CorFundoTela
    Frame2.BackColor = CorFundoTela
    Frame3.BackColor = CorFundoTela
    Frame4.BackColor = CorFundoTela
    Frame5.BackColor = CorFundoTela

    ProgressBar1.Visible = False
    LProgressBar.Visible = False

    With Menu
        .ImageList = ImageList1
        .Buttons(1).Image = ImageList1.ListImages(1).Index
        .Buttons(3).Image = ImageList1.ListImages(2).Index
        .Buttons(5).Image = ImageList1.ListImages(3).Index
        .Buttons(7).Image = ImageList1.ListImages(4).Index
        .Buttons(9).Image = ImageList1.ListImages(5).Index
        .Buttons(11).Image = ImageList1.ListImages(6).Index
'        .Left = (Me.Width - .Width) / 2
    End With

    With menuProgramas
        .ImageList = ImageList1
        .Buttons(1).Image = ImageList1.ListImages(1).Index
        .Buttons(3).Image = ImageList1.ListImages(3).Index
        .Left = (Frame1.Width - .Width) / 2
    End With
    
    With Cadastrados
        .Clear
        .Rows = 1
        .Cols = 19
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "ID Material"
        .TextMatrix(0, 1) = "Pedigree"
        .TextMatrix(0, 2) = "Evento"
        .TextMatrix(0, 3) = "Source"
        .TextMatrix(0, 4) = "Lote"
        .TextMatrix(0, 5) = "Fornecedor"
        .TextMatrix(0, 6) = "Recebimento"
        .TextMatrix(0, 7) = "Germinacao"
        .TextMatrix(0, 8) = "Vigor"
        .TextMatrix(0, 9) = "Enviado Por"
        .TextMatrix(0, 10) = "Recebido Por"
        .TextMatrix(0, 11) = "Localizacao"
        .TextMatrix(0, 12) = "Camara Fria"
        .TextMatrix(0, 13) = "Endere|fffd|o"
        .TextMatrix(0, 14) = "Status"
        .TextMatrix(0, 15) = "Regulat|fffd|rio"
        .TextMatrix(0, 16) = "StewardShip"
        .TextMatrix(0, 17) = "Usu|fffd|rio"
        .TextMatrix(0, 18) = "Observa|fffd||fffd|o"
        For cont = 0 To 18
            .FixedAlignment(cont) = 4
        Next cont
        .ColWidth(0) = 0
        .ColWidth(1) = 2400
        .ColWidth(3) = 0
        .ColWidth(4) = 1900
        .ColAlignment(0) = 4
        .ColAlignment(1) = 1
        .ColAlignment(3) = 1
        .ColAlignment(4) = 1
        For cont = 5 To 18
            .ColWidth(cont) = 0
            .ColAlignment(cont) = 4
        Next cont
    End With
    
    With Programas
        .Clear
        .Rows = 1
        .Cols = 3
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "ID_Programa"
        .TextMatrix(0, 1) = "Programa"
        .TextMatrix(0, 2) = "Inv. BID"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .FixedAlignment(2) = 4
        .ColWidth(0) = 0
        .ColWidth(1) = 1000
        .ColWidth(2) = 1500
        .ColAlignment(0) = 4
        .ColAlignment(1) = 1
        .ColAlignment(2) = 1
    End With
    
    With cmbLocalizacao
        .AddItem "Camara Fria"
        .AddItem "Packing Center"
    End With
    
    With cmbStatus
        .AddItem "Ativo"
        .AddItem "Zerado"
        .AddItem "Descartado"
        .AddItem "Em Uso"
    End With
    
    Call Centralizar(Me)
    
    Monta_ComboCamaraFria
    
    Processar = False
    Monta_ComboEvento
    cmbFiltroEvento.ListIndex = 0
    Processar = True
    
    Limpa_Campos
    Habilita_Campos False
    Mostra_Cadastrados
End Sub

Private Sub Monta_ComboCamaraFria()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    sql = "SELECT * FROM tab_camarafria ORDER BY NomeCamaraFria"
    
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    With cmbCamaraFria
        .Clear
        .ColumnCount = 2
        .ColumnWidths = "0;"
        .Style = fmStyleDropDownList
        
        While Not rs.EOF
            .AddItem rs("ID_CamaraFria")
            .Column(1, .ListCount - 1) = rs("NomeCamaraFria")
        
            rs.MoveNext
        Wend
        
    End With
    
    rs.Close
    Set rs = Nothing
    
    cmbEndereco.Clear
End Sub

Private Sub Monta_ComboEvento()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    sql = "SELECT DISTINCT Evento FROM tab_material ORDER BY Evento"
    
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    With cmbFiltroEvento
        .Clear
        .ColumnCount = 1
        .ColumnWidths = "100"
        .Style = fmStyleDropDownList
        
        .AddItem "Todos"
        While Not rs.EOF
            If IsNull(rs("Evento")) Then
                .AddItem "Sem Evento"
            Else
                .AddItem rs("Evento")
            End If
        
            rs.MoveNext
        Wend
    End With
    
    rs.Close
    Set rs = Nothing
    
    cmbEndereco.Clear
End Sub

Private Sub Monta_ComboEndereco()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    sql = "SELECT * FROM tab_camarafriaendereco WHERE ID_CamaraFria = " & cmbCamaraFria & " ORDER BY Corredor, Prateleira, Andar, Numero"
    
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    With cmbEndereco
        .Clear
        .ColumnCount = 2
        .ColumnWidths = "0;"
        .Style = fmStyleDropDownList
        
        While Not rs.EOF
            .AddItem rs("ID_Endereco")
            .Column(1, .ListCount - 1) = rs("Corredor") & " - " & rs("Prateleira") & " - " & rs("Andar") & " - " & rs("Numero")
        
            rs.MoveNext
        Wend
        
    End With
    
    rs.Close
    Set rs = Nothing
End Sub

Private Sub Limpa_Campos()
    edtCodigo.Text = ""
    edtPedigree.Text = ""
    edtEvento.Text = ""
    edtSource.Text = ""
    edtLote.Text = ""
    edtFornecedor.Text = ""
    edtDataRecebimento.Value = Now()
    edtGerminacao.Text = ""
    edtVigor.Text = ""
    edtEnviadoPor.Text = ""
    edtRecebidoPor.Text = ""
    cmbLocalizacao = ""
    cmbCamaraFria = ""
    cmbEndereco = ""
    cmbStatus = ""
    chkRegulatorio = False
    chkStewardShip = False
    edtObservacao.Text = ""
    
    Programas.Rows = 1
End Sub

Private Sub Habilita_Campos(status As Boolean)
    edtCodigo.Enabled = False
    edtPedigree.Enabled = status
    edtEvento.Enabled = status
    edtSource.Enabled = status
    edtLote.Enabled = status
    edtFornecedor.Enabled = status
    edtDataRecebimento.Enabled = status
    edtGerminacao.Enabled = status
    edtVigor.Enabled = status
    edtEnviadoPor.Enabled = status
    edtRecebidoPor.Enabled = status
    cmbLocalizacao.Enabled = status
    cmbCamaraFria.Enabled = status
    cmbEndereco.Enabled = status
    cmbStatus.Enabled = status
    chkRegulatorio.Enabled = status
    chkStewardShip.Enabled = status
    edtObservacao.Enabled = status
    
    With Menu
        .Buttons(1).Enabled = Not status
        .Buttons(3).Enabled = Not status
        .Buttons(5).Enabled = Not status
        .Buttons(7).Enabled = status
        .Buttons(9).Enabled = status
        .Buttons(11).Enabled = Not status
    End With
    
    Cadastrados.Enabled = Not status
    
    Programas.Enabled = status
    With menuProgramas
        .Buttons(1).Enabled = status
        .Buttons(3).Enabled = status
    End With
    
End Sub

Private Sub Mostra_Cadastrados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim filtrar As String
    
    Set rs = New ADODB.Recordset
    sql = "SELECT * FROM tab_material "
    
    filtrar = ""
    If chkFiltrarReg Then filtrar = "[Regulatorio]=true "
    If chkFiltrarSts Then
        If filtrar <> "" Then filtrar = filtrar & "or "
        filtrar = filtrar & "[StewardShip]=true "
    End If
    
    If cmbFiltroEvento <> "Todos" Then
        If filtrar <> "" Then filtrar = filtrar & "and "
        If cmbFiltroEvento = "Sem Evento" Then
            filtrar = filtrar & "[Evento] is null "
        Else
            filtrar = filtrar & "[Evento] = '" & cmbFiltroEvento & "' "
        End If
    End If
    
    If filtrar <> "" Then sql = sql & "WHERE " & filtrar
    
    sql = sql & "ORDER BY Pedigree"
    
    rs.Open sql, con
    
    Cadastrados.Rows = 1
    
    While Not rs.EOF
        With Cadastrados
            .Rows = .Rows + 1
        
            .TextMatrix(.Rows - 1, 0) = rs("ID_Material")
            .TextMatrix(.Rows - 1, 1) = rs("Pedigree")
            .TextMatrix(.Rows - 1, 2) = IIf(IsNull(rs("Evento")), "", rs("Evento"))
            .TextMatrix(.Rows - 1, 3) = rs("Source")
            .TextMatrix(.Rows - 1, 4) = IIf(IsNull(rs("Lote")), "", rs("Lote"))
            .TextMatrix(.Rows - 1, 5) = rs("Fornecedor")
            .TextMatrix(.Rows - 1, 6) = rs("DataRecebimento")
            .TextMatrix(.Rows - 1, 7) = IIf(IsNull(rs("Germinacao")), "", rs("Germinacao"))
            .TextMatrix(.Rows - 1, 8) = IIf(IsNull(rs("Vigor")), "", rs("Vigor"))
            .TextMatrix(.Rows - 1, 9) = rs("EnviadoPor")
            .TextMatrix(.Rows - 1, 10) = rs("RecebidoPor")
            .TextMatrix(.Rows - 1, 11) = rs("Localizacao")
            .TextMatrix(.Rows - 1, 12) = IIf(IsNull(rs("ID_CamaraFria")), "", rs("ID_camarafria"))
            .TextMatrix(.Rows - 1, 13) = IIf(IsNull(rs("ID_Endereco")), "", rs("id_endereco"))
            .TextMatrix(.Rows - 1, 14) = rs("Status")
             
            .col = 15
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            
            .Text = IIf(rs("Regulatorio"), "|fffd|", "q")
             
            .col = 16
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            
            .Text = IIf(rs("StewardShip"), "|fffd|", "q")
            
            .TextMatrix(.Rows - 1, 17) = IIf(IsNull(rs("usuario")), "", rs("Usuario"))
            .TextMatrix(.Rows - 1, 18) = IIf(IsNull(rs("Observacao")), "", rs("Observacao"))
            
         End With
         
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing

End Sub

Private Sub Mostra_Programas()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    Set rs = New ADODB.Recordset
    sql = "SELECT m.*, p.codigoprograma FROM tab_materialprograma as m INNER JOIN tab_programa as p on p.ID_Programa = m.ID_Programa WHERE m.ID_Material = " & edtCodigo.Text & " ORDER BY m.ID_Programa"
    rs.Open sql, con
    
    Programas.Rows = 1
    
    While Not rs.EOF
        With Programas
            .Rows = .Rows + 1
        
            .TextMatrix(.Rows - 1, 0) = rs("ID_Programa")
            .TextMatrix(.Rows - 1, 1) = rs("CodigoPrograma")
            .TextMatrix(.Rows - 1, 2) = rs("InvBid")
         End With
         
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Programas, 1, 2

End Sub

Private Sub Salvar_Dados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim cont As Integer
    Dim texto As String
    
    If edtPedigree.Text = "" Or _
       edtEvento.Text = "" Or _
       edtSource.Text = "" Or _
       edtLote.Text = "" Or _
       edtFornecedor.Text = "" Or _
       edtEnviadoPor.Text = "" Or _
       edtRecebidoPor.Text = "" Or _
       cmbLocalizacao.Text = "" Or _
       Programas.Rows = 1 Then
       MsgBox "Os campos com '*' s|fffd|o obrigat|fffd|rios.", vbInformation, "Salvar"
       Exit Sub
    End If
    
    If edtCodigo.Text = "" Then
        sql = "INSERT INTO tab_material (Pedigree, Source, Lote, Fornecedor, DataRecebimento, " & _
                                        "Germinacao, Vigor, EnviadoPor, RecebidoPor, Localizacao, " & _
                                        "ID_CamaraFria, ID_Endereco, Status, Regulatorio, Usuario, " & _
                                        "Observacao, StewardShip, Evento) " & _
                    "VALUES ('" & edtPedigree.Text & "','" & edtSource.Text & "','" & edtLote.Text & "','" & _
                            edtFornecedor.Text & "',#" & Format(edtDataRecebimento.Value, "yyyy/mm/dd") & "#," & _
                            IIf(edtGerminacao.Text = "", "null", edtGerminacao.Text) & "," & _
                            IIf(edtVigor.Text = "", "null", edtVigor.Text) & ",'" & edtEnviadoPor.Text & "','" & _
                            edtRecebidoPor.Text & "','" & cmbLocalizacao & "'," & cmbCamaraFria & "," & _
                            IIf(IsNull(cmbEndereco), "null", cmbEndereco) & ",'" & cmbStatus & "'," & chkRegulatorio & ",'" & usuario & "'," & _
                            IIf(edtObservacao.Text = "", "null", "'" & edtObservacao.Text & "'") & "," & _
                            chkStewardShip & "," & IIf(edtEvento.Text = "", "null", "'" & edtEvento.Text & "'") & ")"
    Else
        sql = "UPDATE tab_material SET Pedigree = '" & edtPedigree.Text & "', " & _
                                      "Source = '" & edtSource.Text & "', " & _
                                      "Lote = '" & edtLote.Text & "', " & _
                                      "Fornecedor = '" & edtFornecedor.Text & "', " & _
                                      "DataRecebimento = " & Format(edtDataRecebimento.Value, "yyyy/mm/dd") & ", " & _
                                      "Germinacao = " & IIf(edtGerminacao.Text = "", "null", edtGerminacao.Text) & ", " & _
                                      "Vigor = " & IIf(edtVigor.Text = "", "null", edtVigor.Text) & ", " & _
                                      "EnviadoPor = '" & edtEnviadoPor.Text & "', " & _
                                      "RecebidoPor = '" & edtRecebidoPor.Text & "', " & _
                                      "Localizacao = '" & cmbLocalizacao & "', " & _
                                      "ID_CamaraFria = " & cmbCamaraFria & ", " & _
                                      "ID_Endereco = " & IIf(cmbEndereco.Text = "", "null", cmbEndereco) & ", " & _
                                      "Status = '" & cmbStatus & "', " & _
                                      "Regulatorio = " & chkRegulatorio & ", " & _
                                      "Usuario = '" & usuario & "', " & _
                                      "Observacao = " & IIf(edtObservacao.Text = "", "null", "'" & edtObservacao.Text & "'") & ", " & _
                                      "StewardShip = " & chkStewardShip & ", " & _
                                      "Evento = " & IIf(edtEvento.Text = "", "null", "'" & edtEvento.Text & "'") & " " & _
              "WHERE ID_Material = " & edtCodigo.Text
    End If
    
    con.Execute sql
    
    If edtCodigo = "" Then
        sql = "SELECT Top 1 ID_Material FROM tab_material ORDER BY ID_Material Desc"
        Set rs = New ADODB.Recordset
        rs.Open sql, con
        edtCodigo.Text = rs("ID_Material")
        rs.Close
        Set rs = Nothing
    End If
    
    sql = "DELETE * FROM tab_materialprograma WHERE ID_Material = " & edtCodigo.Text
    con.Execute sql
    
    With Programas
        For cont = 1 To .Rows - 1
            sql = "INSERT INTO tab_materialprograma (ID_Material, ID_Programa, InvBid) " & _
                        "VALUES (" & edtCodigo.Text & "," & .TextMatrix(cont, 0) & ", '" & .TextMatrix(cont, 2) & "')"
            con.Execute sql
        Next cont
    End With
    
    Processar = False
    Monta_ComboEvento
    cmbFiltroEvento.ListIndex = 0
    Processar = True

    Mostra_Cadastrados
    Mostra_Programas
    
    Habilita_Campos False
End Sub

Private Sub Excluir_Dados()
    Dim sql As String
    
    If edtCodigo.Text <> "" Then
        If MsgBox("Deseja realmente excluir este material ?", vbYesNo + vbInformation + vbDefaultButton2, "Exclus|fffd|o") = vbYes Then
            sql = "DELETE * FROM tab_material WHERE ID_Material = " & edtCodigo.Text
            con.Execute sql
        End If
            
        Limpa_Campos
        Habilita_Campos False
        Mostra_Cadastrados
    End If
End Sub

Private Sub Importar_Materiais()
    Dim arquivo             As String
    Dim wb                  As Workbook
    Dim SH                  As Worksheet
    Dim lin                 As Long
    Dim col                 As Integer
    Dim totLin              As Long
    Dim totCol              As Integer
    Dim rs                  As ADODB.Recordset
    Dim sql                 As String
    Dim sql1                As String
    Dim sql2                As String
    Dim qtdeSem             As Long
    
    Dim colProgram          As Integer
    Dim colPedigree         As Integer
    Dim colEvento           As Integer
    Dim colSource           As Integer
    Dim colInvBID           As Integer
    Dim colLote             As Integer
    Dim colFornecedor       As Integer
    Dim colEnviadoPor       As Integer
    Dim colDataRecebimento  As Integer
    Dim colRecebidoPor      As Integer
    Dim colWGT              As Integer
    Dim colRET              As Integer
    Dim colObservacao       As Integer
    Dim colCamaraFria       As Integer
    Dim colEndereco         As Integer
    Dim colRegulatorio      As Integer
    Dim colStewardShip      As Integer
    Dim colQtdeSem          As Integer
    
    Dim idPrograma          As Long
    Dim idMaterial          As Long
    
    Dim msg As String
    
    arquivo = Localizar_Arquivo
    If arquivo = "" Then Exit Sub
    
    Set wb = Workbooks.Open(arquivo, False, False)
    Set SH = wb.Worksheets(1)
    
    With SH
        .Activate
        .Range("a1").Select
        ActiveCell.SpecialCells(xlLastCell).Select
        totLin = Selection.Row
        totCol = Selection.Column
        .Range("A1").Select
    End With
    
    If totLin = 1 Then GoTo fim
    
    ThisWorkbook.Activate
    
    colProgram = 0
    colEvento = 0
    colPedigree = 0
    colSource = 0
    colInvBID = 0
    colLote = 0
    colFornecedor = 0
    colEnviadoPor = 0
    colDataRecebimento = 0
    colRecebidoPor = 0
    colWGT = 0
    colRET = 0
    colObservacao = 0
    colCamaraFria = 0
    colEndereco = 0
    colRegulatorio = 0
    colStewardShip = 0
    colQtdeSem = 0
    
    For col = 1 To totCol
        With SH
            If UCase(.Cells(1, col)) = "PROGRAM" Then colProgram = col
            If UCase(.Cells(1, col)) = "EVENTO" Then colEvento = col
            If UCase(.Cells(1, col)) = "PEDIGREE" Then colPedigree = col
            If UCase(.Cells(1, col)) = "SOURCE" Then colSource = col
            If UCase(.Cells(1, col)) = "INV BID" Then colInvBID = col
            If UCase(.Cells(1, col)) = "LOTE" Then colLote = col
            If UCase(.Cells(1, col)) = "FORNECEDOR" Then colFornecedor = col
            If UCase(.Cells(1, col)) = "ENVIADO POR" Then colEnviadoPor = col
            If UCase(.Cells(1, col)) = "DATA DE RECEBIMENTO" Then colDataRecebimento = col
            If UCase(.Cells(1, col)) = "RECEBIDO POR" Then colRecebidoPor = col
            If UCase(.Cells(1, col)) = "WGT" Then colWGT = col
            If UCase(.Cells(1, col)) = "RET" Then colRET = col
            If UCase(.Cells(1, col)) = "OBSERVA|fffd||fffd|O" Then colObservacao = col
            If UCase(.Cells(1, col)) = "CAMARA FRIA" Then colCamaraFria = col
            If UCase(.Cells(1, col)) = "ENDERE|fffd|O" Then colEndereco = col
            If UCase(.Cells(1, col)) = "REGULAT|fffd|RIO" Then colRegulatorio = col
            If UCase(.Cells(1, col)) = "STEWARDSHIP" Then colStewardShip = col
            If UCase(.Cells(1, col)) = "QTDE SEMENTES" Then colQtdeSem = col
        End With
    Next col
    
    msg = ""
    If colProgram = 0 Then msg = msg & vbTab & "Program" & vbNewLine
    If colEvento = 0 Then msg = msg & vbTab & "Evento" & vbNewLine
    If colPedigree = 0 Then msg = msg & vbTab & "Pedigree" & vbNewLine
    If colSource = 0 Then msg = msg & vbTab & "Source" & vbNewLine
    If colInvBID = 0 Then msg = msg & vbTab & "Inv BID" & vbNewLine
    If colLote = 0 Then msg = msg & vbTab & "Lote" & vbNewLine
    If colFornecedor = 0 Then msg = msg & vbTab & "Fornecedor" & vbNewLine
    If colEnviadoPor = 0 Then msg = msg & vbTab & "Enviado Por" & vbNewLine
    If colDataRecebimento = 0 Then msg = msg & vbTab & "Data de Recebimento" & vbNewLine
    If colRecebidoPor = 0 Then msg = msg & vbTab & "Recebido Por" & vbNewLine
    If colWGT = 0 Then msg = msg & vbTab & "WGT" & vbNewLine
    If colRET = 0 Then msg = msg & vbTab & "RET" & vbNewLine
    If colObservacao = 0 Then msg = msg & vbTab & "Observa|fffd||fffd|o" & vbNewLine
    If colCamaraFria = 0 Then msg = msg & vbTab & "Camara Fria" & vbNewLine
    If colEndereco = 0 Then msg = msg & vbTab & "Endere|fffd|o" & vbNewLine
    If colRegulatorio = 0 Then msg = msg & vbTab & "Regulat|fffd|rio" & vbNewLine
    If colStewardShip = 0 Then msg = msg & vbTab & "StewardShip" & vbNewLine
    If colQtdeSem = 0 Then msg = msg & vbTab & "Qtde Sementes" & vbNewLine
    
    If colProgram = 0 Or colPedigree = 0 Or colSource = 0 Or colInvBID = 0 Or colLote = 0 Or _
       colFornecedor = 0 Or colEnviadoPor = 0 Or colDataRecebimento = 0 Or colRecebidoPor = 0 Or colWGT = 0 Or _
       colRET = 0 Or colObservacao = 0 Or colCamaraFria = 0 Or colEndereco = 0 Or colRegulatorio = 0 Or _
       colEvento = 0 Or colStewardShip = 0 Then
       MsgBox "Uma ou mais das colunas abaixo listadas n|fffd|o foram encontradas." & vbNewLine & _
              "Verifique a existencia de todas as colunas e se elas n|fffd|o contem espa|fffd|os a mais em seus nomes." & vbNewLine & msg
        GoTo fim
    End If
    
    ProgressBar1.Max = totLin
    ProgressBar1.min = 0
    ProgressBar1.Value = 0
    LProgressBar.Caption = "0%"
    
    ProgressBar1.Visible = True
    LProgressBar.Visible = True
    
    DoEvents
    
    For lin = 2 To totLin
        
        ProgressBar1.Value = lin
        LProgressBar.Caption = Format(lin / totLin, "0%")
        
        DoEvents
        
        With SH
            If .Cells(lin, colInvBID) <> "" Then
                If .Cells(lin, colProgram) <> "" Then
                    Set rs = New ADODB.Recordset
                    
                    idPrograma = 0
                    While idPrograma = 0
                        sql = "SELECT * FROM tab_programa WHERE CodigoPrograma = '" & .Cells(lin, colProgram) & "'"
                        
                        rs.Open sql, con
                        If rs.EOF Then
                            sql = "INSERT INTO tab_programa (CodigoPrograma) VALUES ('" & UCase(.Cells(lin, colProgram)) & "')"
                            con.Execute sql
                        Else
                            idPrograma = rs("ID_Programa")
                        End If
                        
                        rs.Close
                    Wend
                    
                    idMaterial = 0
                    qtdeSem = 0
                    
                    While idMaterial = 0
                        sql = "SELECT * " & _
                              "FROM tab_material " & _
                              "WHERE Pedigree='" & .Cells(lin, colPedigree) & "' AND " & _
                                    "Lote='" & .Cells(lin, colLote) & "'"
                        rs.Open sql, con
                        If rs.EOF Then
                            sql = "INSERT INTO tab_material " & _
                                      "(Pedigree, Source, Lote, Fornecedor, DataRecebimento, Germinacao, Vigor, EnviadoPor, " & _
                                      "RecebidoPor, Localizacao, ID_CamaraFria, ID_Endereco, Status, Regulatorio, Usuario, " & _
                                      "Observacao, StewardShip, Evento) VALUES ("
                            sql1 = "'" & UCase(.Cells(lin, colPedigree)) & "', " & _
                                      "'" & UCase(.Cells(lin, colSource)) & "', " & _
                                      "'" & UCase(.Cells(lin, colLote)) & "', " & _
                                      "'" & UCase(.Cells(lin, colFornecedor)) & "', #" & _
                                      Format(.Cells(lin, colDataRecebimento), "yyyy/mm/dd") & "#, "
                            If IsEmpty(.Cells(lin, colWGT)) Then
                               sql1 = sql1 & "null, "
                            ElseIf .Cells(lin, colWGT) = "" Then
                               sql1 = sql1 & "null, "
                            Else
                                sql1 = sql1 & Int(Replace(.Cells(lin, colWGT), ",", ".")) & ", "
                            End If
                            If IsEmpty(.Cells(lin, colRET)) Then
                               sql1 = sql1 & "null, "
                            ElseIf .Cells(lin, colRET) = "" Then
                               sql1 = sql1 & "null, "
                            Else
                                sql1 = sql1 & Int(Replace(.Cells(lin, colRET), ",", ".")) & ", "
                            End If
                            sql1 = sql1 & "'" & UCase(.Cells(lin, colEnviadoPor)) & "', " & _
                                      "'" & UCase(.Cells(lin, colRecebidoPor)) & "', " & _
                                      "'Camara Fria', "
                                      
                            sql2 = IIf(.Cells(lin, colCamaraFria) = "", "null", "'" & .Cells(lin, colCamaraFria) & "'") & ", " & _
                                      IIf(.Cells(lin, colEndereco) = "", "null", "'" & .Cells(lin, colEndereco) & "'") & ", " & _
                                      "'Ativo', " & _
                                      .Cells(lin, colRegulatorio) & ", " & _
                                      "'" & usuario & "', " & _
                                      IIf(.Cells(lin, colObservacao) = "", "null", "'" & .Cells(lin, colObservacao) & "'") & ", " & _
                                      .Cells(lin, colStewardShip) & ", " & _
                                      IIf(.Cells(lin, colEvento) = "", "null", "'" & .Cells(lin, colEvento) & "'") & ")"
                            
                            qtdeSem = IIf(.Cells(lin, colQtdeSem) = "", 0, .Cells(lin, colQtdeSem))
                            
                            con.Execute sql & sql1 & sql2
                        Else
                            idMaterial = rs("ID_Material")
                        End If
                        rs.Close
                    Wend
                    
                    sql = "SELECT * FROM tab_materialprograma WHERE ID_Material=" & idMaterial & _
                                                              " and ID_Programa=" & idPrograma & _
                                                              " and InvBID='" & .Cells(lin, colInvBID) & "'"
                    rs.Open sql, con
                    If rs.EOF Then
                        sql = "INSERT INTO tab_materialprograma (ID_Material, ID_Programa, InvBID) VALUES (" & _
                                        idMaterial & ", " & idPrograma & ", '" & .Cells(lin, colInvBID) & "')"
                        con.Execute sql
                    End If
                    rs.Close
                    Set rs = Nothing
                    
                    If qtdeSem > 0 Then
                        sql = "INSERT INTO tab_materialmovimentacao VALUES (" & _
                                      idMaterial & "," & _
                                      "#" & Format(Date, "yyyy/mm/dd") & "#," & _
                                      "#" & Format(Now, "hh:mm:ss") & "#," & _
                                      "'Entrada'," & _
                                      qtdeSem & ")"
                        con.Execute sql
                    End If
                    
                End If
            End If
        End With
    Next lin

fim:
    Set SH = Nothing
    wb.Close SaveChanges:=False
    Set wb = Nothing
    
    ProgressBar1.Visible = False
    LProgressBar.Visible = False
    
End Sub
Attribute VB_Name = "form_menu"
Attribute VB_Base = "0{51FC1CB6-6344-4FF3-94D4-75F9F5CCB59D}{A02D4581-0926-44B2-9E5A-DCE7862C8ED7}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Private Sub btnBalancoMassa_Click()
    form_balancomassa.Show vbModal
End Sub

Private Sub btnBalancoMateriais_Click()
    form_balancomateriais.Show vbModal
End Sub

Private Sub btnCamaraFria_Click()
    form_camarafria.Show vbModal
End Sub

Private Sub btnCheckContagem_Click()
    Call Maximizar(form_checkcontagem)
End Sub

Private Sub btnCheckSorteio_Click()
    Call Maximizar(form_checksorteio)
End Sub

Private Sub btnConfirmaRetirada_Click()
    Call Maximizar(form_confirmaretirada)
End Sub

Private Sub btnContador_Click()
    form_contador.Show vbModal
End Sub

Private Sub btnfieldbook_Click()
    Call Maximizar(form_fieldbook)
End Sub

Private Sub btnImprimirBuffers_Click()
    Call Maximizar(form_imprimirbuffers)
End Sub

Private Sub btnImprimirSaquinho_Click()
    Call Maximizar(form_imprimirsaquinho)
End Sub

Private Sub btnIniciarContagem_Click()
    form_iniciarcontagem.Show vbModal
End Sub

Private Sub btnMapaWinterstiger_Click()
    form_mapawinterstiger.Show vbModal
End Sub

Private Sub btnMaterial_Click()
    form_material.Show
End Sub

Private Sub btnParametro_Click()
    form_parametro.Show vbModal
End Sub

Private Sub btnPrograma_Click()
    form_programa.Show vbModal
End Sub

Private Sub btnProtocolo_Click()
    form_protocolo.Show vbModal
End Sub

Private Sub btnRetiradaCamara_Click()
    Call Maximizar(form_retiradacamara)
End Sub

Private Sub btnRetornoCamara_Click()
    form_retornocamara.Show vbModal
End Sub

Private Sub btnStatusFields_Click()
    form_statusfields.Show vbModal
End Sub

Private Sub btnUsuario_Click()
    form_usuario.Show vbModal
End Sub

Private Sub UserForm_Initialize()
    Dim btn As Variant
    Dim img As ListImage
    
    Set formAtual = Me

    Unload form_login
    
    Call Centralizar(Me)
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    btnRetiradaCamara.Caption = "Reservar" & vbNewLine & "Material"
    btnConfirmaRetirada.Caption = "Confirmar" & vbNewLine & "Retirada"
    btnImprimirSaquinho.Caption = "Imprimir" & vbNewLine & "Saquinhos" & vbNewLine & "(Material)"
    btnImprimirBuffers.Caption = "Imprimir" & vbNewLine & "Saquinhos" & vbNewLine & "(Buffers)"
    btnIniciarContagem.Caption = "Iniciar" & vbNewLine & "Contagem"
    btnCheckContagem.Caption = "Check" & vbNewLine & "Contagem"
    btnRetornoCamara.Caption = "Guardar" & vbNewLine & "Material"
    btnCheckSorteio.Caption = "Check" & vbNewLine & "Sorteio"
    btnMapaWinterstiger.Caption = "Gerar Mapa" & vbNewLine & "para" & vbNewLine & "WinterStiger"
    btnBalancoMassa.Caption = "Balan|fffd|o" & vbNewLine & "de Massa"
    btnStatusFields.Caption = "Status dos" & vbNewLine & "FieldBooks"
    btnBalancoMateriais.Caption = "Balan|fffd|o de" & vbNewLine & "Materiais"
    
    For Each btn In Me.Controls
        For Each img In ImageList1.ListImages
            If btn.Name = img.Tag Then
                btn.Picture = img.Picture
                Exit For
            End If
        Next img
    Next btn
    
    Checa_Acessos
    
    Call AtivarBotoesMinMax(Me)
    
End Sub

Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    If MsgBox("Deseja realmente sair do sistema ?", vbYesNo + vbExclamation + vbDefaultButton2, "Sair") = vbYes Then
    
        If Not con Is Nothing Then con.Close
        Set con = Nothing
    
        ThisWorkbook.Close SaveChanges:=False
        
        Cancel = False
    Else
        Cancel = True
    End If
    
End Sub

Private Sub Checa_Acessos()
    Dim btnMenu As Variant
    
    For Each btnMenu In Me.Controls
        If Left(btnMenu.Name, 3) = "btn" Then
            btnMenu.Enabled = rsUserLogado(btnMenu.Tag)
        End If
    Next btnMenu
    
    Me.Repaint
End Sub
Attribute VB_Name = "form_parametro"
Attribute VB_Base = "0{C81E7B1F-B05E-439B-81C4-8E75825FCF59}{196B3863-E029-41FF-A89C-04133AC26173}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim rs As ADODB.Recordset

Private Sub btnSalvar_Click()

    rs!SafraAtual = edtSafraAtual.Text
    rs!BufferPadrao = cmbBuffer
    rs!MargemSeguranca = Pega_Valor(edtMargemSeguranca.Text)
    rs!ValidadeMaterial = edtValidade.Text
    rs!VariavelSementePlantada = edtSementesPlantadas.Text
    rs!VariavelSementeFalha = edtSementesFalha.Text
    rs!VariavelSementeDupla = edtSementesDupla.Text
    
    rs.Update
    
    Unload Me
End Sub

Private Sub edtMargemSeguranca_Enter()
    edtMargemSeguranca.Text = Pega_Valor(edtMargemSeguranca.Text)
End Sub

Private Sub edtMargemSeguranca_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If KeyAscii = 44 Then KeyAscii = 46
    If Somente_Numeros(KeyAscii, True, True) = False Then
        KeyAscii = 0
    End If
End Sub

Private Sub edtSafraAtual_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If Len(edtSafraAtual.Text) = 0 Then
        If Chr(KeyAscii) < 0 Or Chr(KeyAscii) > 9 Then
            KeyAscii = 0
        End If
    End If
End Sub

Private Sub edtSementesDupla_Change()
    edtSementesDupla = UCase(edtSementesDupla)
End Sub

Private Sub edtSementesFalha_Change()
    edtSementesFalha = UCase(edtSementesFalha)
End Sub

Private Sub edtSementesPlantadas_Change()
    edtSementesPlantadas = UCase(edtSementesPlantadas)
End Sub

Private Sub edtValidade_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If Somente_Numeros(KeyAscii, False, True) = False Then
        KeyAscii = 0
    End If
End Sub

Private Sub Frame1_Exit(ByVal Cancel As MSForms.ReturnBoolean)
    edtMargemSeguranca.Text = Replace(edtMargemSeguranca.Text, ".", Application.International(xlDecimalSeparator))
End Sub

Private Sub UserForm_Initialize()

    Me.BackColor = CorFundoTela
    Frame1.BackColor = CorFundoTela
    Frame2.BackColor = CorFundoTela
    
    Call Centralizar(Me)
    
    Set rs = New ADODB.Recordset
    
'    Conecta_Banco
    
    rs.Open "SELECT DISTINCT M.ID_Material, M.Pedigree, I.InvBID " & _
            "FROM tab_material as M " & _
            "INNER JOIN tab_materialprograma as I on I.ID_Material = M.ID_Material " & _
            "ORDER BY M.Pedigree", con
    With cmbBuffer
        .Clear
        .ColumnCount = 3
        .ColumnWidths = "0;150;150"
        .ListWidth = 300
        
        While Not rs.EOF
            .AddItem rs("ID_Material")
            .List(.ListCount - 1, 1) = rs("Pedigree")
            .List(.ListCount - 1, 2) = rs("InvBID")
            
            rs.MoveNext
        Wend
    End With
    rs.Close
    
    rs.Open "SELECT * FROM tab_parametro", con, adOpenKeyset, adLockOptimistic
    
    If IsNull(rs("BufferPadrao")) Then
        cmbBuffer = ""
    Else
        cmbBuffer = rs("BufferPadrao")
    End If
    edtSafraAtual.Text = rs("SafraAtual")
    edtMargemSeguranca.Text = rs("MargemSeguranca")
    edtSementesPlantadas.Text = IIf(IsNull(rs("VariavelSementePlantada")), "", rs("VariavelSementePlantada"))
    edtSementesFalha.Text = IIf(IsNull(rs("VariavelSementeFalha")), "", rs("VariavelSementeFalha"))
    edtSementesDupla.Text = IIf(IsNull(rs("VariavelSementeDupla")), "", rs("VariavelSementeDupla"))
    edtValidade.Text = IIf(IsNull(rs("ValidadeMaterial")), "", rs("ValidadeMaterial"))
End Sub

Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    rs.Close
    
    Set rs = Nothing
    
End Sub
Attribute VB_Name = "form_programa"
Attribute VB_Base = "0{FD2B6390-06BC-4DD8-8E74-70FDC99DEB50}{ED902B60-A7F9-4B0E-92C5-2F96B63DC900}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim LinSelect As Integer
Dim ColSelect As Integer

Dim PrimeiraLetra As Boolean

Private Sub Cadastrados_Click()
    LinSelect = Cadastrados.RowSel
    
    If LinSelect > 0 Then
        edtCodigo.Text = Cadastrados.TextMatrix(LinSelect, 0)
        edtCodigoPrograma.Text = Cadastrados.TextMatrix(LinSelect, 1)
        edtLocalidade.Text = Cadastrados.TextMatrix(LinSelect, 2)
    End If
End Sub

Private Sub edtCodigoPrograma_Change()
    edtCodigoPrograma.Text = UCase(edtCodigoPrograma.Text)
End Sub

Private Sub edtLocalidade_Change()
    edtLocalidade.Text = UCase(edtLocalidade.Text)
End Sub

Private Sub Menu_ButtonClick(ByVal Button As MSComctlLib.Button)
    Select Case Button.Key
        Case Is = "Novo"
            Limpa_Campos
            Habilita_Campos True
            edtCodigoPrograma.SetFocus
        Case Is = "Alterar"
            If edtCodigo.Text <> "" Then
                Habilita_Campos True
            End If
        Case Is = "Excluir"
            Excluir_Dados
        Case Is = "Cancelar"
            Limpa_Campos
            Habilita_Campos False
        Case Is = "Salvar"
            Salvar_Dados
    End Select
End Sub

Private Sub UserForm_Initialize()

    If con Is Nothing Then Conecta_Banco

    Me.BackColor = CorFundoTela
    
    With Menu
        .ImageList = ImageList1
        .Buttons(1).Image = ImageList1.ListImages(1).Index
        .Buttons(3).Image = ImageList1.ListImages(2).Index
        .Buttons(5).Image = ImageList1.ListImages(3).Index
        .Buttons(7).Image = ImageList1.ListImages(4).Index
        .Buttons(9).Image = ImageList1.ListImages(5).Index
        .Left = (Me.Width - .Width) / 2
    End With

    With Cadastrados
        .Clear
        .Rows = 1
        .Cols = 3
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarVertical
        .AllowBigSelection = False
        .TextMatrix(0, 0) = "ID Programa"
        .TextMatrix(0, 1) = "Programa"
        .TextMatrix(0, 2) = "Localidade"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .FixedAlignment(2) = 4
        .ColWidth(0) = 0
        .ColWidth(1) = 1000
        .ColWidth(2) = 5400
        .ColAlignment(0) = 4
        .ColAlignment(1) = 4
        .ColAlignment(2) = 1
    End With
    
    Call Centralizar(Me)
    
    Limpa_Campos
    Habilita_Campos False
    Mostra_Cadastrados
End Sub

Private Sub Limpa_Campos()
    edtCodigo.Text = ""
    edtCodigoPrograma.Text = ""
    edtLocalidade.Text = ""
End Sub

Private Sub Habilita_Campos(status As Boolean)
    edtCodigo.Enabled = False
    edtCodigoPrograma.Enabled = status
    edtLocalidade.Enabled = status
    
    With Menu
        .Buttons(1).Enabled = Not status
        .Buttons(3).Enabled = Not status
        .Buttons(5).Enabled = Not status
        .Buttons(7).Enabled = status
        .Buttons(9).Enabled = status
    End With
    
    Cadastrados.Enabled = Not status
    
End Sub

Private Sub Mostra_Cadastrados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    Set rs = New ADODB.Recordset
    sql = "SELECT * FROM tab_programa ORDER BY CodigoPrograma"
    rs.Open sql, con
    
    Cadastrados.Rows = 1
    
    While Not rs.EOF
        With Cadastrados
            .Rows = .Rows + 1
        
            .TextMatrix(.Rows - 1, 0) = rs("ID_Programa")
            .TextMatrix(.Rows - 1, 1) = rs("CodigoPrograma")
            .TextMatrix(.Rows - 1, 2) = IIf(IsNull(rs("Localidade")), "", rs("Localidade"))
         End With
         
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing

End Sub

Private Sub Salvar_Dados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim cont As Integer
    
    If edtCodigoPrograma.Text = "" Or _
       edtLocalidade.Text = "" Then
       MsgBox "Todos os campos s|fffd|o obrigat|fffd|rios.", vbInformation, "Salvar"
       Exit Sub
    End If
    
    If edtCodigo.Text = "" Then
        sql = "INSERT INTO tab_programa (CodigoPrograma, Localidade) " & _
                    "VALUES ('" & edtCodigoPrograma.Text & "','" & edtLocalidade.Text & "')"
    Else
        sql = "UPDATE tab_programa SET CodigoPrograma = '" & edtCodigoPrograma.Text & "', " & _
                                       "Localidade= '" & edtLocalidade.Text & "' " & _
              "WHERE ID_Programa = " & edtCodigo.Text
    End If
    
    con.Execute sql
    
    If edtCodigo = "" Then
        sql = "SELECT * FROM tab_programa WHERE CodigoPrograma = '" & edtCodigoPrograma.Text & "'"
        Set rs = New ADODB.Recordset
        rs.Open sql, con
        edtCodigo.Text = rs("ID_Programa")
        rs.Close
        Set rs = Nothing
    End If
    
    Mostra_Cadastrados
    
    Habilita_Campos False
End Sub

Private Sub Excluir_Dados()
    Dim sql As String
    
    If edtCodigo.Text <> "" Then
        If MsgBox("Deseja realmente excluir este programa ?", vbYesNo + vbInformation + vbDefaultButton2, "Exclus|fffd|o") = vbYes Then
            sql = "DELETE * FROM tab_programa WHERE ID_Programa = " & edtCodigo.Text
            con.Execute sql
        End If
            
        Limpa_Campos
        Habilita_Campos False
        Mostra_Cadastrados
    End If
End Sub
Attribute VB_Name = "form_protocolo"
Attribute VB_Base = "0{F5C883C9-87EA-4E48-8FE1-434230D000F2}{EB8A71E3-F7D2-4DBE-BD55-FE8395DB8DFB}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim LinSelect As Integer
Dim ColSelect As Integer

Dim PrimeiraLetra As Boolean

Private Sub Cadastrados_Click()
    LinSelect = Cadastrados.RowSel
    
    If LinSelect > 0 Then
        edtCodigo.Text = Cadastrados.TextMatrix(LinSelect, 0)
        cmbPrograma = Cadastrados.TextMatrix(LinSelect, 1)
        edtNroProtocolo.Text = Cadastrados.TextMatrix(LinSelect, 3)
        edtSet = Cadastrados.TextMatrix(LinSelect, 4)
        edtNomeProtocolo.Text = Cadastrados.TextMatrix(LinSelect, 5)
        edtReps.Text = Cadastrados.TextMatrix(LinSelect, 6)
        edtLinhasParcela.Text = Cadastrados.TextMatrix(LinSelect, 7)
        edtSaqParcela.Text = Cadastrados.TextMatrix(LinSelect, 8)
        If Cadastrados.TextMatrix(LinSelect, 9) = "q" Then
            chkTemColheita.Value = False
        Else
            chkTemColheita.Value = True
        End If
        If Cadastrados.TextMatrix(LinSelect, 10) = "q" Then
            chkPlantaPiloto.Value = False
        Else
            chkPlantaPiloto.Value = True
        End If
        
        Mostra_Tratamentos
    End If
End Sub

Private Sub edtLinhasParcela_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If Somente_Numeros(KeyAscii, False, True) = False Then KeyAscii = 0
End Sub

Private Sub edtNomeProtocolo_Change()
    edtNomeProtocolo.Text = UCase(edtNomeProtocolo.Text)
End Sub

Private Sub edtReps_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If Somente_Numeros(KeyAscii, False, True) = False Then KeyAscii = 0
End Sub

Private Sub edtNroProtocolo_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If Somente_Numeros(KeyAscii, False, True) = False Then KeyAscii = 0
End Sub

Private Sub edtSaqParcela_KeyPress(ByVal KeyAscii As MSForms.ReturnInteger)
    If Somente_Numeros(KeyAscii, False, True) = False Then KeyAscii = 0
End Sub

Private Sub Menu_ButtonClick(ByVal Button As MSComctlLib.Button)
    Select Case Button.Key
        Case Is = "Novo"
            Limpa_Campos
            Habilita_Campos True
            cmbPrograma.SetFocus
        Case Is = "Alterar"
            If edtCodigo.Text <> "" Then
                Habilita_Campos True
            End If
        Case Is = "Excluir"
            Excluir_Dados
        Case Is = "Cancelar"
            Limpa_Campos
            Habilita_Campos False
        Case Is = "Salvar"
            Salvar_Dados
        Case Is = "Importar"
            Importar_Protocolos
            Limpa_Campos
            Habilita_Campos False
            Mostra_Cadastrados
    End Select
End Sub

Private Sub menuTratamentos_ButtonClick(ByVal Button As MSComctlLib.Button)
    Dim cont As Integer
    
    Select Case Button.Key
        Case Is = "Novo"
            Tratamentos.Rows = Tratamentos.Rows + 1
            Tratamentos.TextMatrix(Tratamentos.Rows - 1, 0) = Tratamentos.Rows - 1
        Case Is = "Excluir"
            If LinSelect > 1 Then
                Tratamentos.RemoveItem (LinSelect)
                For cont = 1 To Tratamentos.Rows - 1
                    Tratamentos.TextMatrix(cont, 0) = cont
                Next cont
            End If
    End Select
End Sub

Private Sub Tratamentos_KeyPress(KeyAscii As Integer)
    If Tratamentos.RowSel <= 0 Then Exit Sub
    
    If ColSelect = 1 Then
        With Tratamentos
            .col = ColSelect
            Select Case KeyAscii
                Case vbKeyReturn, vbKeyTab
                    If .Row + 1 <= .Rows - 1 Then
                        .Row = .Row + 1
                    Else
                        .Row = 1
                    End If
                    PrimeiraLetra = True
                    
                Case vbKeyBack
                    'remove o ultimo caractere
                    If Len(.Text) Then
                        .Text = Left(.Text, Len(.Text) - 1)
                    End If
        
                Case Is < 32
        
                Case Else
                    If PrimeiraLetra Then
                        PrimeiraLetra = False
                        .Text = ""
                    End If
                    .Text = .Text & UCase(Chr(KeyAscii))
            End Select
        End With
    End If
    If ColSelect = 2 Then
        With Tratamentos
            .col = ColSelect
            Select Case KeyAscii
                Case vbKeyReturn, vbKeyTab
                    If .Row + 1 <= .Rows - 1 Then
                        .Row = .Row + 1
                    Else
                        .Row = 1
                    End If
                    PrimeiraLetra = True
                    
                Case vbKeyBack
                    'remove o ultimo caractere
                    If Len(.Text) Then
                        .Text = Left(.Text, Len(.Text) - 1)
                    End If
        
                Case Is < 32
        
                Case Else
                    If PrimeiraLetra Then
                        PrimeiraLetra = False
                        .Text = ""
                    End If
                    If Somente_Numeros(KeyAscii, False, True) = True Then
                        .Text = .Text & Chr(KeyAscii)
                    End If
            End Select
        End With
    End If

End Sub

Private Sub Tratamentos_MouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    LinSelect = Tratamentos.MouseRow
    ColSelect = Tratamentos.MouseCol
End Sub

Private Sub UserForm_Initialize()
    Dim col As Integer
    
    If con Is Nothing Then Conecta_Banco

    Me.BackColor = CorFundoTela
    Frame1.BackColor = CorFundoTela
    
    ProgressBar1.Visible = False
    LProgressBar.Visible = False
    
    With Menu
        .ImageList = ImageList1
        .Buttons(1).Image = ImageList1.ListImages(1).Index
        .Buttons(3).Image = ImageList1.ListImages(2).Index
        .Buttons(5).Image = ImageList1.ListImages(3).Index
        .Buttons(7).Image = ImageList1.ListImages(4).Index
        .Buttons(9).Image = ImageList1.ListImages(5).Index
        .Buttons(11).Image = ImageList1.ListImages(6).Index
        
        .Left = (Me.Width - .Width) / 2
    End With

    With menuTratamentos
        .ImageList = ImageList1
        .Buttons(1).Image = ImageList1.ListImages(1).Index
        .Buttons(3).Image = ImageList1.ListImages(3).Index
        .Left = (Frame1.Width - .Width) / 2
    End With
    
    With Cadastrados
        .Clear
        .Rows = 1
        .Cols = 11
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "ID Protocolo"
        .TextMatrix(0, 1) = "ID_Programa"
        .TextMatrix(0, 2) = "Programa"
        .TextMatrix(0, 3) = "N|fffd|mero"
        .TextMatrix(0, 4) = "Set"
        .TextMatrix(0, 5) = "Nome"
        .TextMatrix(0, 6) = "Reps"
        .TextMatrix(0, 7) = "Linhas/Parcela"
        .TextMatrix(0, 8) = "Saq/Parcela"
        .TextMatrix(0, 9) = "Tem Colheita"
        .TextMatrix(0, 10) = "Planta Piloto"
        For col = 0 To .Cols - 1
            .FixedAlignment(col) = 4
        Next col
        .ColWidth(0) = 0
        .ColWidth(1) = 0
        .ColWidth(2) = 800
        .ColWidth(3) = 800
        .ColWidth(4) = 1300
        .ColWidth(5) = 1300
        .ColWidth(6) = 800
        .ColWidth(7) = 1200
        .ColWidth(8) = 1200
        .ColWidth(9) = 1200
        .ColWidth(10) = 1200
        .ColAlignment(0) = 4
        .ColAlignment(1) = 4
        .ColAlignment(2) = 1
        .ColAlignment(3) = 4
        .ColAlignment(4) = 1
        .ColAlignment(5) = 1
        .ColAlignment(6) = 4
        .ColAlignment(7) = 4
        .ColAlignment(8) = 4
        .ColAlignment(9) = 4
        .ColAlignment(10) = 4
    End With
    
    With Tratamentos
        .Clear
        .Rows = 1
        .Cols = 3
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarVertical
        .AllowBigSelection = False
        .TextMatrix(0, 0) = "N|fffd| Tratamento"
        .TextMatrix(0, 1) = "Tratamento"
        .TextMatrix(0, 2) = "Qtde"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .FixedAlignment(2) = 4
        .ColWidth(0) = 1200
        .ColWidth(1) = 2200
        .ColWidth(2) = 1000
        .ColAlignment(0) = 4
        .ColAlignment(1) = 1
        .ColAlignment(2) = 4
    End With
    
    Monta_ComboPrograma
    
    Call Centralizar(Me)
    
    Limpa_Campos
    Habilita_Campos False
    Mostra_Cadastrados
End Sub

Private Sub Monta_ComboPrograma()
    Dim rs As ADODB.Recordset
    
    Set rs = New ADODB.Recordset
    rs.Open "SELECT * FROM tab_programa ORDER BY CodigoPrograma", con
    
    With cmbPrograma
        .Clear
        .ColumnCount = 2
        .ColumnWidths = "0;2"
        
        While Not rs.EOF
            .AddItem rs("ID_Programa")
            .List(.ListCount - 1, 1) = rs("CodigoPrograma")
            
            rs.MoveNext
        Wend
    End With
    
    rs.Close
    Set rs = Nothing
End Sub

Private Sub Limpa_Campos()
    edtCodigo.Text = ""
    cmbPrograma = ""
    edtNroProtocolo.Text = ""
    edtSet.Text = ""
    edtNomeProtocolo.Text = ""
    edtReps.Text = ""
    edtLinhasParcela.Text = ""
    edtSaqParcela.Text = ""
    chkTemColheita = False
    chkPlantaPiloto = False
    
    Tratamentos.Rows = 1
End Sub

Private Sub Habilita_Campos(status As Boolean)
    edtCodigo.Enabled = False
    cmbPrograma.Enabled = status
    edtNroProtocolo.Enabled = status
    edtSet.Enabled = status
    edtNomeProtocolo.Enabled = status
    edtReps.Enabled = status
    edtLinhasParcela.Enabled = status
    edtSaqParcela.Enabled = status
    chkTemColheita.Enabled = status
    chkPlantaPiloto.Enabled = status
    
    With Menu
        .Buttons(1).Enabled = Not status
        .Buttons(3).Enabled = Not status
        .Buttons(5).Enabled = Not status
        .Buttons(7).Enabled = status
        .Buttons(9).Enabled = status
        .Buttons(11).Enabled = Not status
    End With
    
    Cadastrados.Enabled = Not status
    
    Tratamentos.Enabled = status
    With menuTratamentos
        .Buttons(1).Enabled = status
        .Buttons(3).Enabled = status
    End With
    
End Sub

Private Sub Mostra_Cadastrados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    Set rs = New ADODB.Recordset
    sql = "SELECT p.*, pg.CodigoPrograma " & _
          "FROM tab_protocolo as p " & _
          "INNER JOIN tab_programa as pg ON pg.ID_Programa = p.ID_Program " & _
          "ORDER BY NroProtocolo"
    rs.Open sql, con
    
    Cadastrados.Rows = 1
    
    While Not rs.EOF
        With Cadastrados
            .Rows = .Rows + 1
        
            .TextMatrix(.Rows - 1, 0) = rs("ID_Protocolo")
            .TextMatrix(.Rows - 1, 1) = rs("ID_Program")
            .TextMatrix(.Rows - 1, 2) = rs("CodigoPrograma")
            .TextMatrix(.Rows - 1, 3) = rs("NroProtocolo")
            .TextMatrix(.Rows - 1, 4) = rs("Set")
            .TextMatrix(.Rows - 1, 5) = rs("NomeProtocolo")
            .TextMatrix(.Rows - 1, 6) = rs("Reps")
            .TextMatrix(.Rows - 1, 7) = rs("NroLinhasParcela")
            .TextMatrix(.Rows - 1, 8) = rs("QtdeSaqParcela")
             
            .col = 9
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            
            .Text = IIf(rs("TemColheita"), "|fffd|", "q")
             
            .col = 10
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            
            .Text = IIf(rs("PlantaPiloto"), "|fffd|", "q")
         End With
         
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing

End Sub

Private Sub Mostra_Tratamentos()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    Set rs = New ADODB.Recordset
    sql = "SELECT * FROM tab_protocolotratamento WHERE ID_Protocolo = " & edtCodigo.Text & " ORDER BY NroTratamento"
    rs.Open sql, con
    
    Tratamentos.Rows = 1
    
    While Not rs.EOF
        With Tratamentos
            .Rows = .Rows + 1
        
            .TextMatrix(.Rows - 1, 0) = rs("NroTratamento")
            .TextMatrix(.Rows - 1, 1) = rs("DescricaoTratamento")
            .TextMatrix(.Rows - 1, 2) = rs("QtdeSementes")
         End With
         
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing

End Sub

Private Sub Salvar_Dados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim cont As Integer
    
    If edtNroProtocolo.Text = "" Or _
       cmbPrograma.Text = "" Or _
       edtSet.Text = "" Or _
       edtNomeProtocolo.Text = "" Or _
       edtReps.Text = "" Or _
       edtLinhasParcela.Text = "" Or _
       edtSaqParcela.Text = "" Or _
       Tratamentos.Rows = 1 Then
       MsgBox "Todos os campos s|fffd|o obrigat|fffd|rios." & vbNewLine & "|fffd| necess|fffd|rio ao menos um tratamento.", vbInformation, "Salvar"
       Exit Sub
    End If
    
    If edtCodigo.Text = "" Then
        sql = "INSERT INTO tab_protocolo (ID_Program, NroProtocolo, [Set], NomeProtocolo, Reps, NroLinhasParcela, QtdeSaqParcela, TemColheita, PlantaPiloto)" & _
                    "VALUES (" & cmbPrograma & ",'" & edtNroProtocolo.Text & "','" & edtSet.Text & "','" & edtNomeProtocolo.Text & "'," & edtReps.Text & ", " & _
                        edtLinhasParcela.Text & "," & edtSaqParcela.Text & "," & chkTemColheita & "," & chkPlantaPiloto & ")"
    Else
        sql = "UPDATE tab_protocolo SET ID_Program = " & cmbPrograma & ", " & _
                                       "NroProtocolo = '" & edtNroProtocolo.Text & "', " & _
                                       "[Set] = '" & edtSet.Text & "', " & _
                                       "NomeProtocolo = '" & edtNomeProtocolo.Text & "', " & _
                                       "Reps = " & edtReps.Text & ", " & _
                                       "NroLinhasParcela = " & edtLinhasParcela.Text & ", " & _
                                       "QtdeSaqParcela = " & edtSaqParcela.Text & ", " & _
                                       "TemColheita = " & chkTemColheita & ", " & _
                                       "PlantaPiloto = " & chkPlantaPiloto & " " & _
              "WHERE ID_Protocolo = " & edtCodigo.Text
    End If
    
    con.Execute sql
    
    If edtCodigo = "" Then
        sql = "SELECT * FROM tab_protocolo WHERE NroProtocolo = '" & edtNroProtocolo.Text & "' and [Set] = '" & edtSet.Text & "'"
        Set rs = New ADODB.Recordset
        rs.Open sql, con
        edtCodigo.Text = rs("ID_Protocolo")
        rs.Close
        Set rs = Nothing
    End If
    
    sql = "DELETE * FROM tab_protocolotratamento WHERE ID_Protocolo = " & edtCodigo.Text
    con.Execute sql
    
    With Tratamentos
        For cont = 1 To .Rows - 1
            sql = "INSERT INTO tab_protocolotratamento " & _
                     "(ID_Protocolo, NroTratamento, DescricaoTratamento, QtdeSementes) " & _
                     "VALUES (" & edtCodigo.Text & "," & .TextMatrix(cont, 0) & ", '" & .TextMatrix(cont, 1) & _
                     "'," & .TextMatrix(cont, 2) & ")"
            con.Execute sql
        Next cont
    End With
            
    Mostra_Cadastrados
    Mostra_Tratamentos
    
    Habilita_Campos False
End Sub

Private Sub Excluir_Dados()
    Dim sql As String
    
    If edtCodigo.Text <> "" Then
        If MsgBox("Deseja realmente excluir este protocolo ?", vbYesNo + vbInformation + vbDefaultButton2, "Exclus|fffd|o") = vbYes Then
            sql = "DELETE * FROM tab_protocolotratamento WHERE ID_Protocolo = " & edtCodigo.Text
            con.Execute sql
            sql = "DELETE * FROM tab_protocolo WHERE ID_Protocolo = " & edtCodigo.Text
            con.Execute sql
        End If
            
        Limpa_Campos
        Habilita_Campos False
        Mostra_Cadastrados
    End If
End Sub

Private Sub Importar_Protocolos()
    Dim arquivo             As String
    Dim wb                  As Workbook
    Dim SH                  As Worksheet
    Dim lin                 As Long
    Dim col                 As Integer
    Dim totLin              As Long
    Dim totCol              As Integer
    Dim rs                  As ADODB.Recordset
    Dim sql                 As String
    Dim seasonAtual         As String
    Dim linhasProblema      As String
    
    Dim colSeason           As Integer
    Dim colProj             As Integer
    Dim colSet              As Integer
    Dim colProtocol         As Integer
    Dim colReps             As Integer
    Dim colRowsPlot         As Integer
    Dim colPacketsPlot      As Integer
    Dim colSeedsPacket      As Integer
    Dim colHarvType         As Integer
    Dim colPlantaPiloto     As Integer
    
    Dim idPrograma          As Long
    Dim idProtocolo         As Long
    
    Dim nroProt             As String
    
    arquivo = Localizar_Arquivo
    If arquivo = "" Then Exit Sub
    
    Set rs = New ADODB.Recordset
    rs.Open "SELECT * FROM tab_parametro", con
    seasonAtual = rs("SafraAtual")
    
    Set wb = Workbooks.Open(arquivo, False, False)
    Set SH = wb.Worksheets(1)
    
    With SH
        .Activate
        .Range("a1").Select
        ActiveCell.SpecialCells(xlLastCell).Select
        totLin = Selection.Row
        totCol = Selection.Column
        .Range("A1").Select
    End With
    
    If totLin = 1 Then GoTo fim
    
    ThisWorkbook.Activate
    
    colSeason = 0
    colProj = 0
    colSet = 0
    colProtocol = 0
    colReps = 0
    colRowsPlot = 0
    colPacketsPlot = 0
    colSeedsPacket = 0
    colHarvType = 0
    colPlantaPiloto = 0
    
    For col = 1 To totCol
        With SH
            If .Cells(1, col) = "Season" Then colSeason = col
            If .Cells(1, col) = "Proj" Then colProj = col
            If .Cells(1, col) = "Set" Then colSet = col
            If .Cells(1, col) = "Protocol Protocol Name" Then colProtocol = col
            If .Cells(1, col) = "# Reps" Then colReps = col
            If .Cells(1, col) = "Rows/Plot" Then colRowsPlot = col
            If .Cells(1, col) = "Packets/Plot" Then colPacketsPlot = col
            If .Cells(1, col) = "Seeds/Packet" Then colSeedsPacket = col
            If .Cells(1, col) = "Harv Type" Then colHarvType = col
            If .Cells(1, col) = "Planta Piloto" Then colPlantaPiloto = col
        End With
    Next col
    
    If colSeason = 0 Or colProj = 0 Or colSet = 0 Or colProtocol = 0 Or colReps = 0 Or _
       colRowsPlot = 0 Or colPacketsPlot = 0 Or colSeedsPacket = 0 Or colHarvType = 0 Or colPlantaPiloto = 0 Then
       MsgBox "Uma ou mais das colunas abaixo listadas n|fffd|o foram encontradas." & vbNewLine & _
              "Verifique a existencia de todas as colunas e se elas n|fffd|o contem espa|fffd|os a mais em seus nomes." & vbNewLine & _
              vbTab & "Season" & vbNewLine & _
              vbTab & "Proj" & vbNewLine & _
              vbTab & "Set" & vbNewLine & _
              vbTab & "Protocol Protocol Name" & vbNewLine & _
              vbTab & "# Reps" & vbNewLine & _
              vbTab & "Rows/Plot" & vbNewLine & _
              vbTab & "Packets/Plot" & vbNewLine & _
              vbTab & "Seeds/Packet" & vbNewLine & _
              vbTab & "Harv Type" & vbNewLine & _
              vbTab & "Planta Piloto", vbInformation, "Importa|fffd||fffd|o"
        GoTo fim
    End If
    
    ProgressBar1.Max = totLin
    ProgressBar1.min = 0
    ProgressBar1.Value = 0
    LProgressBar.Caption = "0%"
    
    ProgressBar1.Visible = True
    LProgressBar.Visible = True
    
    linhasProblema = ""
    
    For lin = 2 To totLin
        
        ProgressBar1.Value = lin
        LProgressBar.Caption = Format(lin / totLin, "0%")
        
        DoEvents
        
        With SH
            If .Cells(lin, colSeason) <> seasonAtual Then
                If linhasProblema <> "" Then linhasProblema = linhasProblema & vbNewLine
                linhasProblema = linhasProblema & "Linha " & CStr(lin) & " / Safra " & .Cells(lin, colSeason)
            Else
                Set rs = New ADODB.Recordset
                rs.Open "SELECT * FROM tab_programa WHERE CodigoPrograma='" & .Cells(lin, colProj) & "'", con
                If rs.EOF Then
                    If linhasProblema <> "" Then linhasProblema = linhasProblema & vbNewLine
                    linhasProblema = linhasProblema & "Linha " & CStr(lin) & " / Programa " & .Cells(lin, colProj)
                    idPrograma = 0
                Else
                    idPrograma = rs("id_programa")
                End If
                rs.Close
                
                If idPrograma > 0 Then
                    If InStr(1, .Cells(lin, colProtocol), "_") = 0 Then
                        If linhasProblema <> "" Then linhasProblema = linhasProblema & vbNewLine
                        linhasProblema = linhasProblema & "Linha " & CStr(lin) & " / Protocolo " & .Cells(lin, colProtocol)
                    Else
                        nroProt = Mid(.Cells(lin, colProtocol), InStr(1, .Cells(lin, colProtocol), "_") + 1, 3)
                        
                        idProtocolo = 0
                        
                        While idProtocolo = 0
                            sql = "SELECT * FROM tab_protocolo WHERE ID_Program = " & idPrograma & " and NroProtocolo = '" & nroProt & "' and [Set] = '" & .Cells(lin, colSet) & "'"
                        
                            rs.Open sql, con
                            If rs.EOF Then
                                sql = "INSERT INTO tab_protocolo (" & _
                                            "ID_Program, NroProtocolo, [Set], NomeProtocolo, Reps, NroLinhasParcela, QtdeSaqParcela, TemColheita, PlantaPiloto) " & _
                                            "VALUES (" & idPrograma & ",'" & nroProt & "','" & .Cells(lin, colSet) & "','" & .Cells(lin, colProtocol) & "'," & _
                                            .Cells(lin, colReps) & "," & .Cells(lin, colRowsPlot) & "," & .Cells(lin, colPacketsPlot) & "," & _
                                            IIf(.Cells(lin, colHarvType) = "Grain", "True", "False") & "," & .Cells(lin, colPlantaPiloto) & ")"
                                con.Execute sql
                            Else
                                idProtocolo = rs("ID_Protocolo")
                            End If
                            
                            rs.Close
                        Wend
                        
                        sql = "SELECT * FROM tab_protocolotratamento WHERE ID_Protocolo=" & idProtocolo & " and NroTratamento=1"
                        rs.Open sql, con
                        If rs.EOF Then
                            sql = "INSERT INTO tab_protocolotratamento (ID_Protocolo, NroTratamento, DescricaoTratamento, QtdeSementes) VALUES (" & _
                                            idProtocolo & ", 1, 'Basico'," & .Cells(lin, colSeedsPacket) & ")"
                            con.Execute sql
                        End If
                        rs.Close
                        Set rs = Nothing
                    End If
                End If
            End If
        End With
    Next lin
    
    If linhasProblema <> "" Then
        MsgBox "As linhas abaixo relacionadas n|fffd|o foram" & vbNewLine & _
               "importadas devido a divergencias no banco de dados." & vbNewLine & _
               linhasProblema, vbInformation, "Importa|fffd||fffd|o"
    End If
    
fim:
    Set SH = Nothing
    wb.Close SaveChanges:=False
    Set wb = Nothing
    
    ProgressBar1.Visible = False
    LProgressBar.Visible = False
    
End Sub
Attribute VB_Name = "form_retiradacamara"
Attribute VB_Base = "0{24882A78-AEE3-4B17-895A-8BF346C40191}{F806AD19-20E1-4AA8-B31D-2981F2D31F38}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim safra As String
Dim Margem As Integer
Dim MaterialRow As Integer
Dim MaterialCol As Integer
Dim SetRow As Integer
Dim SetCol As Integer
Dim GrowerRow As Integer
Dim GrowerCol As Integer
Dim LocationRow As Integer
Dim LocationCol As Integer
Dim RepRow As Integer
Dim RepCol As Integer
Dim retirarRow As Integer
Dim retirarCol As Integer
Dim dataOpen As Date
Dim Processa As Boolean

Private Sub btnClear_Click()
    Dim lin As Long
    Dim col As Integer
    
    With Lista_Materiais
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                .TextMatrix(lin, 0) = "q"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &H80000005
                Next col
            End If

            Lista_Sets.Rows = 1
            Lista_Grower.Rows = 1
            Lista_Location.Rows = 1
            Lista_Reps.Rows = 1
            
            Lista_Retirar.Rows = 1
            
        Next lin
    End With
End Sub

Private Sub btnFiltro_Click()
    Dim frm As Object
    Dim lin As Integer
    Dim filtrog As String
    
    filtrog = ""
    With Lista_Grower
        For lin = 1 To .Rows - 1
            If filtrog <> "" Then filtrog = filtrog & ", "
            filtrog = filtrog & .TextMatrix(lin, 2) & "#" & .TextMatrix(lin, 0) & "/" & .TextMatrix(lin, 1)
        Next lin
    End With
    
    filtrarS = ""
    filtrarG = ""
    filtrarL = ""
    filtrarR = ""
    
    Set frm = New form_filtrosementes
    frm.filtroSet = Lista_Retirar.TextMatrix(retirarRow, 12)
    frm.filtroGrower = filtrog
    frm.filtroLoc = Lista_Retirar.TextMatrix(retirarRow, 14)
    frm.filtroRep = Lista_Retirar.TextMatrix(retirarRow, 15)
    frm.Show
    
    If filtrarS <> "" Then
        With Lista_Retirar
            .TextMatrix(retirarRow, 12) = filtrarS
            .TextMatrix(retirarRow, 13) = filtrarG
            .TextMatrix(retirarRow, 14) = filtrarL
            .TextMatrix(retirarRow, 15) = filtrarR
        End With
        
        Lista_Retirar_Click
        
        Calcula_Sementes
    End If
End Sub

Private Sub btnFinalizar_Click()
    Dim LinRet As Integer
    Dim lin As Integer
    Dim idRetirada As Long
    Dim rs As ADODB.Recordset
    
    Dim sql As String
    
    If Lista_Retirar.Rows < 2 Then Exit Sub
    
    sql = "DELETE * FROM tab_retirada WHERE Data=#" & Format(dataOpen, "yyyy/mm/dd") & "# and Retirou=false"
    con.Execute sql
    
    With Lista_Retirar
        For LinRet = 1 To .Rows - 1
            sql = "INSERT INTO tab_retirada " & _
                  "(Data, Usuario, ID_Material, InvBID, Estoque, Necessidade, Retirou, Observacao, Data_Retirada, Buffer, FiltroSet, FiltroGrower, FiltroLoc, FiltroRep) " & _
                  "VALUES (#" & Format(Date, "yyyy/mm/dd") & "#,'" & usuario & "'," & .TextMatrix(LinRet, 0) & ", " & "'" & _
                  .TextMatrix(LinRet, 2) & "'," & Pega_Valor(.TextMatrix(LinRet, 8)) & "," & Pega_Valor( _
                  .TextMatrix(LinRet, 9)) & ", false, null, null, " & IIf(.TextMatrix(LinRet, 10) = "q", "false", "true") & ",'" & .TextMatrix(LinRet, 12) & "','" & .TextMatrix(LinRet, 13) & "','" & .TextMatrix(LinRet, 14) & "','" & .TextMatrix(LinRet, 15) & "')"
            con.Execute sql
            
            sql = "SELECT ID_Retirada FROM tab_retirada WHERE " & _
                  "Data=#" & Format(Date, "yyyy/mm/dd") & "# and usuario='" & usuario & "' and " & "ID_Material=" & _
                  .TextMatrix(LinRet, 0) & " and invbid='" & .TextMatrix(LinRet, 2) & "'"
            Set rs = New ADODB.Recordset
            rs.Open sql, con
            idRetirada = rs("ID_Retirada")
            rs.Close
            Set rs = Nothing
        Next LinRet
    End With
    
    Imprimir_relatorio
    
    Unload Me
    
End Sub

Private Sub chkAll_Click()
    Dim lin As Long
    Dim col As Integer
    
    With Lista_Materiais
        For lin = 1 To .Rows - 1
            MaterialRow = lin
            MaterialCol = 0
            
            If chkAll Then
                .TextMatrix(lin, 0) = "|fffd|"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &HE0E0E0
                Next col
            Else
                .TextMatrix(lin, 0) = "q"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &H80000005
                Next col
            End If

            Lista_Sets.Rows = 1
            Lista_Grower.Rows = 1
            Lista_Location.Rows = 1
            Lista_Reps.Rows = 1
            
            Monta_Lista_Sets
            Monta_Lista_Growers
            Monta_Lista_Loc
            Monta_Lista_Reps
            
            Monta_Relatorio
            
            Calcula_Sementes
        Next lin
    End With
    
End Sub

Private Sub cmbGrower_Change()
    If Processa Then Mostra_Materiais
End Sub

Private Sub cmbLoc_Change()
    If Processa Then Mostra_Materiais
End Sub

Private Sub cmbSet_Change()
    If Processa Then Mostra_Materiais
End Sub

Private Sub edtFindMaterial_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim lin As Integer
    Dim col As Integer
    Dim achou As Boolean
    
    If KeyCode = vbKeyReturn Then
    
        If edtFindMaterial.Text = "" Then Exit Sub
        
        With Lista_Materiais
            achou = False
            MaterialRow = 0
            
            For lin = 1 To .Rows - 1
                If UCase(.TextMatrix(lin, 3)) = UCase(edtFindMaterial) Then
                    .TopRow = lin
                    .Row = lin
                    If .TextMatrix(lin, 0) = "q" Then
                        .TextMatrix(lin, 0) = "|fffd|"
                        For col = 0 To .Cols - 1
                            .col = col
                            .CellBackColor = &HE0E0E0
                        Next col
                    Else
                        .TextMatrix(lin, 0) = "q"
                        For col = 0 To .Cols - 1
                            .col = col
                            .CellBackColor = &H80000005
                        Next col
                    End If
                    achou = True
                    MaterialRow = lin
                    Exit For
                End If
            Next lin

            Lista_Sets.Rows = 1
            Lista_Grower.Rows = 1
            Lista_Location.Rows = 1
            Lista_Reps.Rows = 1
            
            Monta_Lista_Sets
            Monta_Lista_Growers
            Monta_Lista_Loc
            Monta_Lista_Reps
            
            If achou Then Monta_Relatorio
            
            Calcula_Sementes
            
            If Not achou Then MsgBox "Material n|fffd|o encontrado.", vbInformation, "Pesquisa"
        End With
        
        edtFindMaterial.Text = ""
        edtFindMaterial.SetFocus
    End If
End Sub

Private Sub Lista_Materiais_Click()
    Dim lin As Long
    Dim col As Integer
    
    If MaterialRow = 0 Then Exit Sub
    
    With Lista_Materiais
        If MaterialCol = 0 Or MaterialCol = 5 Then
            If .TextMatrix(MaterialRow, MaterialCol) = "q" Then
                .TextMatrix(MaterialRow, MaterialCol) = "|fffd|"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &HE0E0E0
                Next col
            Else
                .TextMatrix(MaterialRow, MaterialCol) = "q"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &H80000005
                Next col
            End If
        End If
    End With
    
    Lista_Sets.Rows = 1
    Lista_Grower.Rows = 1
    Lista_Location.Rows = 1
    Lista_Reps.Rows = 1
    
    Monta_Lista_Sets
    Monta_Lista_Growers
    Monta_Lista_Loc
    Monta_Lista_Reps
    
    Monta_Relatorio
    
    Calcula_Sementes
End Sub

Private Sub Lista_Materiais_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    MaterialRow = Lista_Materiais.MouseRow
    MaterialCol = Lista_Materiais.MouseCol
End Sub

Private Sub Lista_Retirar_Click()
    Dim lin As Long
    Dim col As Integer
    Dim cont As Integer
    
    Dim rs1 As ADODB.Recordset
    
    Dim filtros As Variant
    Dim flt As Variant
    
    If retirarRow = 0 Then Exit Sub
    
    With Lista_Materiais
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 1) = Lista_Retirar.TextMatrix(retirarRow, 0) Then
                MaterialRow = lin
                MaterialCol = 1
                .TopRow = lin
                Exit For
            End If
        Next lin
            
        Lista_Sets.Rows = 1
        filtros = Split(Lista_Retirar.TextMatrix(retirarRow, 12), ", ")
        For cont = LBound(filtros) To UBound(filtros)
            flt = Split(filtros(cont), "#")
            
            Lista_Sets.Rows = Lista_Sets.Rows + 1
            Lista_Sets.Row = Lista_Sets.Rows - 1
            Lista_Sets.col = 0
            Lista_Sets.FillStyle = flexFillRepeat
            Lista_Sets.CellFontName = "Wingdings"
            Lista_Sets.CellFontSize = 12
            Lista_Sets.CellAlignment = flexAlignCenterCenter
            Lista_Sets.FillStyle = flexFillSingle
            Lista_Sets.TextMatrix(Lista_Sets.Rows - 1, 0) = flt(1)
            Lista_Sets.TextMatrix(Lista_Sets.Rows - 1, 1) = flt(0)
            For col = 0 To Lista_Sets.Cols - 1
                Lista_Sets.col = col
                If flt(1) = "|fffd|" Then
                    Lista_Sets.CellBackColor = &HE0E0E0
                Else
                    Lista_Sets.CellBackColor = &H80000005
                End If
            Next col
        Next cont
        
        Lista_Grower.Rows = 1
        filtros = Split(Lista_Retirar.TextMatrix(retirarRow, 13), ", ")
        For cont = LBound(filtros) To UBound(filtros)
            flt = Split(filtros(cont), "#")
            
            Set rs1 = New ADODB.Recordset
            rs1.Open "SELECT * FROM tab_programa WHERE ID_Programa = " & flt(0), con
            
            Lista_Grower.Rows = Lista_Grower.Rows + 1
            Lista_Grower.Row = Lista_Grower.Rows - 1
            Lista_Grower.col = 0
            Lista_Grower.FillStyle = flexFillRepeat
            Lista_Grower.CellFontName = "Wingdings"
            Lista_Grower.CellFontSize = 12
            Lista_Grower.CellAlignment = flexAlignCenterCenter
            Lista_Grower.FillStyle = flexFillSingle
            Lista_Grower.TextMatrix(Lista_Grower.Rows - 1, 0) = flt(1)
            Lista_Grower.TextMatrix(Lista_Grower.Rows - 1, 1) = flt(0)
            Lista_Grower.TextMatrix(Lista_Grower.Rows - 1, 2) = rs1("CodigoPrograma")
            For col = 0 To Lista_Grower.Cols - 1
                Lista_Grower.col = col
                If flt(1) = "|fffd|" Then
                    Lista_Grower.CellBackColor = &HE0E0E0
                Else
                    Lista_Grower.CellBackColor = &H80000005
                End If
            Next col
            
            rs1.Close
            Set rs1 = Nothing
        Next cont
        
        Lista_Location.Rows = 1
        filtros = Split(Lista_Retirar.TextMatrix(retirarRow, 14), ", ")
        For cont = LBound(filtros) To UBound(filtros)
            flt = Split(filtros(cont), "#")
            
            Lista_Location.Rows = Lista_Location.Rows + 1
            Lista_Location.Row = Lista_Location.Rows - 1
            Lista_Location.col = 0
            Lista_Location.FillStyle = flexFillRepeat
            Lista_Location.CellFontName = "Wingdings"
            Lista_Location.CellFontSize = 12
            Lista_Location.CellAlignment = flexAlignCenterCenter
            Lista_Location.FillStyle = flexFillSingle
            Lista_Location.TextMatrix(Lista_Location.Rows - 1, 0) = flt(1)
            Lista_Location.TextMatrix(Lista_Location.Rows - 1, 1) = flt(0)
            For col = 0 To Lista_Location.Cols - 1
                Lista_Location.col = col
                If flt(1) = "|fffd|" Then
                    Lista_Location.CellBackColor = &HE0E0E0
                Else
                    Lista_Location.CellBackColor = &H80000005
                End If
            Next col
        Next cont
        
        Lista_Reps.Rows = 1
        filtros = Split(Lista_Retirar.TextMatrix(retirarRow, 15), ", ")
        For cont = LBound(filtros) To UBound(filtros)
            flt = Split(filtros(cont), "#")
            
            Lista_Reps.Rows = Lista_Reps.Rows + 1
            Lista_Reps.Row = Lista_Reps.Rows - 1
            Lista_Reps.col = 0
            Lista_Reps.FillStyle = flexFillRepeat
            Lista_Reps.CellFontName = "Wingdings"
            Lista_Reps.CellFontSize = 12
            Lista_Reps.CellAlignment = flexAlignCenterCenter
            Lista_Reps.FillStyle = flexFillSingle
            Lista_Reps.TextMatrix(Lista_Reps.Rows - 1, 0) = flt(1)
            Lista_Reps.TextMatrix(Lista_Reps.Rows - 1, 1) = flt(0)
            For col = 0 To Lista_Reps.Cols - 1
                Lista_Reps.col = col
                If flt(1) = "|fffd|" Then
                    Lista_Reps.CellBackColor = &HE0E0E0
                Else
                    Lista_Reps.CellBackColor = &H80000005
                End If
            Next col
        Next cont
    End With
End Sub

Private Sub Lista_Retirar_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    retirarRow = Lista_Retirar.MouseRow
    retirarCol = Lista_Retirar.MouseCol
End Sub

Private Sub Lista_Sets_Click()
    Dim col As Integer
    Dim filtro As String
    Dim filtro2 As String
    Dim cont As Integer
    Dim rs As ADODB.Recordset
    Dim sql As String
   
    With Lista_Sets
        If SetCol = 0 Then
            If .TextMatrix(SetRow, 0) = "q" Then
                .TextMatrix(SetRow, 0) = "|fffd|"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &HE0E0E0
                Next col
            Else
                .TextMatrix(SetRow, 0) = "q"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &H80000005
                Next col
            End If
        End If
        
        filtro = ""
        For cont = 1 To .Rows - 1
            If filtro <> "" Then filtro = filtro & ", "
            filtro = filtro & .TextMatrix(cont, 1) & "#" & .TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 12) = filtro
        
        filtro = ""
        For cont = 1 To .Rows - 1
            If .TextMatrix(cont, 0) = "|fffd|" Then
                If filtro <> "" Then filtro = filtro & ", "
                filtro = filtro & "'" & .TextMatrix(cont, 1) & "'"
            End If
        Next cont
        
        Set rs = New ADODB.Recordset
        
        sql = "SELECT DISTINCT FB.[Grower Proj], P.CodigoPrograma " & _
              "FROM tab_fieldbook as FB " & _
              "INNER JOIN tab_programa as P on P.ID_Programa = FB.[Grower Proj] " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.etiquetaimpressa=false and " & _
                    "FB.[plot deactivated]=false and " & _
                    "FB.[set] in (" & filtro & ")"
        
        rs.Open sql, con
        
        For cont = 1 To Lista_Grower.Rows - 1
            Lista_Grower.TextMatrix(cont, 0) = "q"
            For col = 0 To Lista_Grower.Cols - 1
                Lista_Grower.Row = cont
                Lista_Grower.col = col
                Lista_Grower.CellBackColor = &H80000005
            Next col
        Next cont
        
        While Not rs.EOF
            For cont = 1 To Lista_Grower.Rows - 1
                If Lista_Grower.TextMatrix(cont, 2) = rs("CodigoPrograma") Then
                    Lista_Grower.TextMatrix(cont, 0) = "|fffd|"
                    For col = 0 To Lista_Grower.Cols - 1
                        Lista_Grower.Row = cont
                        Lista_Grower.col = col
                        Lista_Grower.CellBackColor = &HE0E0E0
                    Next col
                    Exit For
                End If
            Next cont
            
            rs.MoveNext
        Wend
        
        rs.Close
        
        filtro2 = ""
        For cont = 1 To Lista_Grower.Rows - 1
            If filtro2 <> "" Then filtro2 = filtro2 & ", "
            filtro2 = filtro2 & Lista_Grower.TextMatrix(cont, 1) & "#" & Lista_Grower.TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 13) = filtro2
        
        sql = "SELECT DISTINCT FB.[Loc] " & _
              "FROM tab_fieldbook as FB " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.etiquetaimpressa=false and " & _
                    "FB.[plot deactivated]=false and " & _
                    "FB.[set] in (" & filtro & ")"
        
        rs.Open sql, con
        
        For cont = 1 To Lista_Location.Rows - 1
            Lista_Location.TextMatrix(cont, 0) = "q"
            For col = 0 To Lista_Location.Cols - 1
                Lista_Location.Row = cont
                Lista_Location.col = col
                Lista_Location.CellBackColor = &H80000005
            Next col
        Next cont
        
        While Not rs.EOF
            For cont = 1 To Lista_Location.Rows - 1
                If Lista_Location.TextMatrix(cont, 1) = rs("Loc") Then
                    Lista_Location.TextMatrix(cont, 0) = "|fffd|"
                    For col = 0 To Lista_Location.Cols - 1
                        Lista_Location.Row = cont
                        Lista_Location.col = col
                        Lista_Location.CellBackColor = &HE0E0E0
                    Next col
                    Exit For
                End If
            Next cont
            
            rs.MoveNext
        Wend
        
        rs.Close
        
        filtro2 = ""
        For cont = 1 To Lista_Location.Rows - 1
            If filtro2 <> "" Then filtro2 = filtro2 & ", "
            filtro2 = filtro2 & Lista_Location.TextMatrix(cont, 1) & "#" & Lista_Location.TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 14) = filtro2
        
        sql = "SELECT DISTINCT FB.[Rep#] " & _
              "FROM tab_fieldbook as FB " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.etiquetaimpressa=false and " & _
                    "FB.[plot deactivated]=false and " & _
                    "FB.[set] in (" & filtro & ")"
        
        rs.Open sql, con
        
        For cont = 1 To Lista_Reps.Rows - 1
            Lista_Reps.TextMatrix(cont, 0) = "q"
            For col = 0 To Lista_Reps.Cols - 1
                Lista_Reps.Row = cont
                Lista_Reps.col = col
                Lista_Reps.CellBackColor = &H80000005
            Next col
        Next cont
        
        While Not rs.EOF
            For cont = 1 To Lista_Reps.Rows - 1
                If Lista_Reps.TextMatrix(cont, 1) = rs("Rep#") Then
                    Lista_Reps.TextMatrix(cont, 0) = "|fffd|"
                    For col = 0 To Lista_Reps.Cols - 1
                        Lista_Reps.Row = cont
                        Lista_Reps.col = col
                        Lista_Reps.CellBackColor = &HE0E0E0
                    Next col
                    Exit For
                End If
            Next cont
            
            rs.MoveNext
        Wend
        
        rs.Close
        Set rs = Nothing
        
        filtro2 = ""
        For cont = 1 To Lista_Reps.Rows - 1
            If filtro2 <> "" Then filtro2 = filtro2 & ", "
            filtro2 = filtro2 & Lista_Reps.TextMatrix(cont, 1) & "#" & Lista_Reps.TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 15) = filtro2
    
    End With
    
    Calcula_Sementes
End Sub

Private Sub Lista_Sets_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    SetRow = Lista_Sets.MouseRow
    SetCol = Lista_Sets.MouseCol
End Sub

Private Sub Lista_Grower_Click()
    Dim col As Integer
    Dim filtro As String
    Dim filtro2 As String
    Dim cont As Integer
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    With Lista_Grower
        If GrowerCol = 0 Then
            If .TextMatrix(GrowerRow, 0) = "q" Then
                .TextMatrix(GrowerRow, 0) = "|fffd|"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &HE0E0E0
                Next col
            Else
                .TextMatrix(GrowerRow, 0) = "q"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &H80000005
                Next col
            End If
        End If
        
        filtro = ""
        For cont = 1 To .Rows - 1
            If filtro <> "" Then filtro = filtro & ", "
            filtro = filtro & .TextMatrix(cont, 1) & "#" & .TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 13) = filtro
        
        filtro = ""
        For cont = 1 To .Rows - 1
            If .TextMatrix(cont, 0) = "|fffd|" Then
                If filtro <> "" Then filtro = filtro & ", "
                filtro = filtro & .TextMatrix(cont, 1)
            End If
        Next cont
        
        Set rs = New ADODB.Recordset
        
        sql = "SELECT DISTINCT FB.[Set] " & _
              "FROM tab_fieldbook as FB " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.etiquetaimpressa=false and " & _
                    "FB.[plot deactivated]=false and " & _
                    "FB.[Grower Proj] in (" & filtro & ")"
        
        rs.Open sql, con
        
        For cont = 1 To Lista_Sets.Rows - 1
            Lista_Sets.TextMatrix(cont, 0) = "q"
            For col = 0 To Lista_Sets.Cols - 1
                Lista_Sets.Row = cont
                Lista_Sets.col = col
                Lista_Sets.CellBackColor = &H80000005
            Next col
        Next cont
        
        While Not rs.EOF
            For cont = 1 To Lista_Sets.Rows - 1
                If Lista_Sets.TextMatrix(cont, 1) = rs("Set") Then
                    Lista_Sets.TextMatrix(cont, 0) = "|fffd|"
                    For col = 0 To Lista_Sets.Cols - 1
                        Lista_Sets.Row = cont
                        Lista_Sets.col = col
                        Lista_Sets.CellBackColor = &HE0E0E0
                    Next col
                    Exit For
                End If
            Next cont
            
            rs.MoveNext
        Wend
        
        rs.Close
        
        filtro2 = ""
        For cont = 1 To Lista_Sets.Rows - 1
            If filtro2 <> "" Then filtro2 = filtro2 & ", "
            filtro2 = filtro2 & Lista_Sets.TextMatrix(cont, 1) & "#" & Lista_Sets.TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 12) = filtro2
        
        sql = "SELECT DISTINCT FB.[Loc] " & _
              "FROM tab_fieldbook as FB " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.etiquetaimpressa=false and " & _
                    "FB.[plot deactivated]=false and " & _
                    "FB.[Grower Proj] in (" & filtro & ")"
        
        rs.Open sql, con
        
        For cont = 1 To Lista_Location.Rows - 1
            Lista_Location.TextMatrix(cont, 0) = "q"
            For col = 0 To Lista_Location.Cols - 1
                Lista_Location.Row = cont
                Lista_Location.col = col
                Lista_Location.CellBackColor = &H80000005
            Next col
        Next cont
        
        While Not rs.EOF
            For cont = 1 To Lista_Location.Rows - 1
                If Lista_Location.TextMatrix(cont, 1) = rs("Loc") Then
                    Lista_Location.TextMatrix(cont, 0) = "|fffd|"
                    For col = 0 To Lista_Location.Cols - 1
                        Lista_Location.Row = cont
                        Lista_Location.col = col
                        Lista_Location.CellBackColor = &HE0E0E0
                    Next col
                    Exit For
                End If
            Next cont
            
            rs.MoveNext
        Wend
        
        rs.Close
        
        filtro2 = ""
        For cont = 1 To Lista_Location.Rows - 1
            If filtro2 <> "" Then filtro2 = filtro2 & ", "
            filtro2 = filtro2 & Lista_Location.TextMatrix(cont, 1) & "#" & Lista_Location.TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 14) = filtro2
        
        sql = "SELECT DISTINCT FB.[Rep#] " & _
              "FROM tab_fieldbook as FB " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.etiquetaimpressa=false and " & _
                    "FB.[plot deactivated]=false and " & _
                    "FB.[Grower Proj] in (" & filtro & ")"
        
        rs.Open sql, con
        
        For cont = 1 To Lista_Reps.Rows - 1
            Lista_Reps.TextMatrix(cont, 0) = "q"
            For col = 0 To Lista_Reps.Cols - 1
                Lista_Reps.Row = cont
                Lista_Reps.col = col
                Lista_Reps.CellBackColor = &H80000005
            Next col
        Next cont
        
        While Not rs.EOF
            For cont = 1 To Lista_Reps.Rows - 1
                If Lista_Reps.TextMatrix(cont, 1) = rs("Rep#") Then
                    Lista_Reps.TextMatrix(cont, 0) = "|fffd|"
                    For col = 0 To Lista_Reps.Cols - 1
                        Lista_Reps.Row = cont
                        Lista_Reps.col = col
                        Lista_Reps.CellBackColor = &HE0E0E0
                    Next col
                    Exit For
                End If
            Next cont
            
            rs.MoveNext
        Wend
        
        rs.Close
        Set rs = Nothing
        
        filtro2 = ""
        For cont = 1 To Lista_Reps.Rows - 1
            If filtro2 <> "" Then filtro2 = filtro2 & ", "
            filtro2 = filtro2 & Lista_Reps.TextMatrix(cont, 1) & "#" & Lista_Reps.TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 15) = filtro2
        
    End With
    
    Calcula_Sementes
End Sub

Private Sub Lista_Grower_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    GrowerRow = Lista_Grower.MouseRow
    GrowerCol = Lista_Grower.MouseCol
End Sub

Private Sub Lista_Location_Click()
    Dim col As Integer
    Dim filtro As String
    Dim filtro2 As String
    Dim cont As Integer
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    With Lista_Location
        If LocationCol = 0 Then
            If .TextMatrix(LocationRow, 0) = "q" Then
                .TextMatrix(LocationRow, 0) = "|fffd|"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &HE0E0E0
                Next col
            Else
                .TextMatrix(LocationRow, 0) = "q"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &H80000005
                Next col
            End If
        End If
        
        filtro = ""
        For cont = 1 To .Rows - 1
            If filtro <> "" Then filtro = filtro & ", "
            filtro = filtro & .TextMatrix(cont, 1) & "#" & .TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 14) = filtro
        
        filtro = ""
        For cont = 1 To .Rows - 1
            If .TextMatrix(cont, 0) = "|fffd|" Then
                If filtro <> "" Then filtro = filtro & ", "
                filtro = filtro & "'" & .TextMatrix(cont, 1) & "'"
            End If
        Next cont
        
        Set rs = New ADODB.Recordset
        
        sql = "SELECT DISTINCT FB.[Set] " & _
              "FROM tab_fieldbook as FB " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.etiquetaimpressa=false and " & _
                    "FB.[plot deactivated]=false and " & _
                    "FB.[Loc] in (" & filtro & ")"
        
        rs.Open sql, con
        
        For cont = 1 To Lista_Sets.Rows - 1
            Lista_Sets.TextMatrix(cont, 0) = "q"
            For col = 0 To Lista_Sets.Cols - 1
                Lista_Sets.Row = cont
                Lista_Sets.col = col
                Lista_Sets.CellBackColor = &H80000005
            Next col
        Next cont
        
        While Not rs.EOF
            For cont = 1 To Lista_Sets.Rows - 1
                If Lista_Sets.TextMatrix(cont, 1) = rs("Set") Then
                    Lista_Sets.TextMatrix(cont, 0) = "|fffd|"
                    For col = 0 To Lista_Sets.Cols - 1
                        Lista_Sets.Row = cont
                        Lista_Sets.col = col
                        Lista_Sets.CellBackColor = &HE0E0E0
                    Next col
                    Exit For
                End If
            Next cont
            
            rs.MoveNext
        Wend
        
        rs.Close
        
        filtro2 = ""
        For cont = 1 To Lista_Sets.Rows - 1
            If filtro2 <> "" Then filtro2 = filtro2 & ", "
            filtro2 = filtro2 & Lista_Sets.TextMatrix(cont, 1) & "#" & Lista_Sets.TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 12) = filtro2
        
        sql = "SELECT DISTINCT FB.[Grower Proj], P.CodigoPrograma " & _
              "FROM tab_fieldbook as FB " & _
              "INNER JOIN tab_programa as P on P.ID_Programa = FB.[Grower Proj] " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.etiquetaimpressa=false and " & _
                    "FB.[plot deactivated]=false and " & _
                    "FB.[Loc] in (" & filtro & ")"
        
        rs.Open sql, con
        
        For cont = 1 To Lista_Grower.Rows - 1
            Lista_Grower.TextMatrix(cont, 0) = "q"
            For col = 0 To Lista_Grower.Cols - 1
                Lista_Grower.Row = cont
                Lista_Grower.col = col
                Lista_Grower.CellBackColor = &H80000005
            Next col
        Next cont
        
        While Not rs.EOF
            For cont = 1 To Lista_Grower.Rows - 1
                If Lista_Grower.TextMatrix(cont, 2) = rs("CodigoPrograma") Then
                    Lista_Grower.TextMatrix(cont, 0) = "|fffd|"
                    For col = 0 To Lista_Grower.Cols - 1
                        Lista_Grower.Row = cont
                        Lista_Grower.col = col
                        Lista_Grower.CellBackColor = &HE0E0E0
                    Next col
                    Exit For
                End If
            Next cont
            
            rs.MoveNext
        Wend
        
        rs.Close
        
        filtro2 = ""
        For cont = 1 To Lista_Grower.Rows - 1
            If filtro2 <> "" Then filtro2 = filtro2 & ", "
            filtro2 = filtro2 & Lista_Grower.TextMatrix(cont, 1) & "#" & Lista_Grower.TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 13) = filtro2
        
        sql = "SELECT DISTINCT FB.[Rep#] " & _
              "FROM tab_fieldbook as FB " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.etiquetaimpressa=false and " & _
                    "FB.[plot deactivated]=false and " & _
                    "FB.[Loc] in (" & filtro & ")"
        
        rs.Open sql, con
        
        For cont = 1 To Lista_Reps.Rows - 1
            Lista_Reps.TextMatrix(cont, 0) = "q"
            For col = 0 To Lista_Reps.Cols - 1
                Lista_Reps.Row = cont
                Lista_Reps.col = col
                Lista_Reps.CellBackColor = &H80000005
            Next col
        Next cont
        
        While Not rs.EOF
            For cont = 1 To Lista_Reps.Rows - 1
                If Lista_Reps.TextMatrix(cont, 1) = rs("Rep#") Then
                    Lista_Reps.TextMatrix(cont, 0) = "|fffd|"
                    For col = 0 To Lista_Reps.Cols - 1
                        Lista_Reps.Row = cont
                        Lista_Reps.col = col
                        Lista_Reps.CellBackColor = &HE0E0E0
                    Next col
                    Exit For
                End If
            Next cont
            
            rs.MoveNext
        Wend
        
        rs.Close
        Set rs = Nothing
        
        filtro2 = ""
        For cont = 1 To Lista_Reps.Rows - 1
            If filtro2 <> "" Then filtro2 = filtro2 & ", "
            filtro2 = filtro2 & Lista_Reps.TextMatrix(cont, 1) & "#" & Lista_Reps.TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 15) = filtro2
        
    End With
    
    Calcula_Sementes
End Sub

Private Sub Lista_Location_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    LocationRow = Lista_Location.MouseRow
    LocationCol = Lista_Location.MouseCol
End Sub

Private Sub Lista_Reps_Click()
    Dim col As Integer
    Dim filtro As String
    Dim filtro2 As String
    Dim cont As Integer
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    With Lista_Reps
        If RepCol = 0 Then
            If .TextMatrix(RepRow, 0) = "q" Then
                .TextMatrix(RepRow, 0) = "|fffd|"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &HE0E0E0
                Next col
            Else
                .TextMatrix(RepRow, 0) = "q"
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = &H80000005
                Next col
            End If
        End If
        
        filtro = ""
        For cont = 1 To .Rows - 1
            If filtro <> "" Then filtro = filtro & ", "
            filtro = filtro & .TextMatrix(cont, 1) & "#" & .TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 15) = filtro
        
        filtro = ""
        For cont = 1 To .Rows - 1
            If .TextMatrix(cont, 0) = "|fffd|" Then
                If filtro <> "" Then filtro = filtro & ", "
                filtro = filtro & .TextMatrix(cont, 1)
            End If
        Next cont
        
        Set rs = New ADODB.Recordset
        
        sql = "SELECT DISTINCT FB.[Set] " & _
              "FROM tab_fieldbook as FB " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.etiquetaimpressa=false and " & _
                    "FB.[plot deactivated]=false and " & _
                    "FB.[Rep#] in (" & filtro & ")"
        
        rs.Open sql, con
        
        For cont = 1 To Lista_Sets.Rows - 1
            Lista_Sets.TextMatrix(cont, 0) = "q"
            For col = 0 To Lista_Sets.Cols - 1
                Lista_Sets.Row = cont
                Lista_Sets.col = col
                Lista_Sets.CellBackColor = &H80000005
            Next col
        Next cont
        
        While Not rs.EOF
            For cont = 1 To Lista_Sets.Rows - 1
                If Lista_Sets.TextMatrix(cont, 1) = rs("Set") Then
                    Lista_Sets.TextMatrix(cont, 0) = "|fffd|"
                    For col = 0 To Lista_Sets.Cols - 1
                        Lista_Sets.Row = cont
                        Lista_Sets.col = col
                        Lista_Sets.CellBackColor = &HE0E0E0
                    Next col
                    Exit For
                End If
            Next cont
            
            rs.MoveNext
        Wend
        
        rs.Close
        
        filtro2 = ""
        For cont = 1 To Lista_Sets.Rows - 1
            If filtro2 <> "" Then filtro2 = filtro2 & ", "
            filtro2 = filtro2 & Lista_Sets.TextMatrix(cont, 1) & "#" & Lista_Sets.TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 12) = filtro2
        
        sql = "SELECT DISTINCT FB.[Grower Proj], P.CodigoPrograma " & _
              "FROM tab_fieldbook as FB " & _
              "INNER JOIN tab_programa as P on P.ID_Programa = FB.[Grower Proj] " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.etiquetaimpressa=false and " & _
                    "FB.[plot deactivated]=false and " & _
                    "FB.[Rep#] in (" & filtro & ")"
        
        rs.Open sql, con
        
        For cont = 1 To Lista_Grower.Rows - 1
            Lista_Grower.TextMatrix(cont, 0) = "q"
            For col = 0 To Lista_Grower.Cols - 1
                Lista_Grower.Row = cont
                Lista_Grower.col = col
                Lista_Grower.CellBackColor = &H80000005
            Next col
        Next cont
        
        While Not rs.EOF
            For cont = 1 To Lista_Grower.Rows - 1
                If Lista_Grower.TextMatrix(cont, 2) = rs("CodigoPrograma") Then
                    Lista_Grower.TextMatrix(cont, 0) = "|fffd|"
                    For col = 0 To Lista_Grower.Cols - 1
                        Lista_Grower.Row = cont
                        Lista_Grower.col = col
                        Lista_Grower.CellBackColor = &HE0E0E0
                    Next col
                    Exit For
                End If
            Next cont
            
            rs.MoveNext
        Wend
        
        rs.Close
        
        filtro2 = ""
        For cont = 1 To Lista_Grower.Rows - 1
            If filtro2 <> "" Then filtro2 = filtro2 & ", "
            filtro2 = filtro2 & Lista_Grower.TextMatrix(cont, 1) & "#" & Lista_Grower.TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 13) = filtro2
        
        sql = "SELECT DISTINCT FB.[Loc] " & _
              "FROM tab_fieldbook as FB " & _
              "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                    "FB.Season='" & safra & "' and " & _
                    "FB.etiquetaimpressa=false and " & _
                    "FB.[plot deactivated]=false and " & _
                    "FB.[Rep#] in (" & filtro & ")"
        
        rs.Open sql, con
        
        For cont = 1 To Lista_Location.Rows - 1
            Lista_Location.TextMatrix(cont, 0) = "q"
            For col = 0 To Lista_Location.Cols - 1
                Lista_Location.Row = cont
                Lista_Location.col = col
                Lista_Location.CellBackColor = &H80000005
            Next col
        Next cont
        
        While Not rs.EOF
            For cont = 1 To Lista_Location.Rows - 1
                If Lista_Location.TextMatrix(cont, 1) = rs("Loc") Then
                    Lista_Location.TextMatrix(cont, 0) = "|fffd|"
                    For col = 0 To Lista_Location.Cols - 1
                        Lista_Location.Row = cont
                        Lista_Location.col = col
                        Lista_Location.CellBackColor = &HE0E0E0
                    Next col
                    Exit For
                End If
            Next cont
            
            rs.MoveNext
        Wend
        
        rs.Close
        Set rs = Nothing
        
        filtro2 = ""
        For cont = 1 To Lista_Location.Rows - 1
            If filtro2 <> "" Then filtro2 = filtro2 & ", "
            filtro2 = filtro2 & Lista_Location.TextMatrix(cont, 1) & "#" & Lista_Location.TextMatrix(cont, 0)
        Next cont
        
        Lista_Retirar.TextMatrix(retirarRow, 14) = filtro2
        
    End With
    
    Calcula_Sementes
End Sub

Private Sub Lista_Reps_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    RepRow = Lista_Reps.MouseRow
    RepCol = Lista_Reps.MouseCol
End Sub

Private Sub UserForm_Initialize()
    Dim col As Integer
    
    Call AtivarBotoesMinMax(Me)
    Call Maximizar(Me)
    
    If con Is Nothing Then Conecta_Banco
'    usuario = "ROBSO"
'    CorFundoTela = RGB(229, 239, 218)
    
    safra = Pega_Safra
    Margem = Pega_Margem
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    Frame1.Height = Me.Height - Frame1.Top - 30
    Frame1.BackColor = CorFundoTela
    Frame2.BackColor = CorFundoTela
    Frame3.BackColor = CorFundoTela
    Frame4.BackColor = CorFundoTela
    Frame5.BackColor = CorFundoTela
    Frame6.BackColor = CorFundoTela
    
    Lista_Retirar.Height = Me.Height - Lista_Retirar.Top - 30
    Lista_Retirar.Width = Me.Width - Lista_Retirar.Left - 15
    
    Label4.Width = Lista_Retirar.Width
    With Label5
        .Top = Label4.Top + ((Label4.Height - .Height) / 2)
        .Left = Label4.Left + ((Label4.Width - .Width) / 2)
    End With
    
    btnFinalizar.Left = Label4.Left + Label4.Width - btnFinalizar.Width - 10
    
    With Lista_Materiais
        .Clear
        .Rows = 1
        .Cols = 6
        .Height = Frame1.Height - .Top - 10
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "ID_Material"
        .TextMatrix(0, 2) = "Material"
        .TextMatrix(0, 3) = "Inv BID"
        .TextMatrix(0, 4) = "Qtde"
        .TextMatrix(0, 5) = "Buffer"
        .FixedAlignment(1) = 7
        For col = 2 To .Cols - 1
            .FixedAlignment(col) = 4
        Next col
        .ColWidth(0) = 500
        .ColWidth(1) = 0
        .ColWidth(2) = 3100
        .ColWidth(3) = 2255
        .ColWidth(4) = 0
        .ColWidth(5) = 800
        .ColAlignment(0) = 4
        .ColAlignment(1) = 7
        .ColAlignment(2) = 1
        .ColAlignment(3) = 1
        .ColAlignment(4) = 7
        .ColAlignment(5) = 4
    End With
    
    With Lista_Sets
        .Clear
        .Rows = 1
        .Cols = 2
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Set"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 2200
        .ColAlignment(0) = 4
        .ColAlignment(1) = 1
    End With
    
    With Lista_Grower
        .Clear
        .Rows = 1
        .Cols = 3
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "ID_Grower"
        .TextMatrix(0, 2) = "Grower"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 7
        .FixedAlignment(2) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 0
        .ColWidth(2) = 800
        .ColAlignment(0) = 4
        .ColAlignment(1) = 7
        .ColAlignment(2) = 4
    End With
    
    With Lista_Location
        .Clear
        .Rows = 1
        .Cols = 2
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Location"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 800
        .ColAlignment(0) = 4
        .ColAlignment(1) = 4
    End With
    
    With Lista_Reps
        .Clear
        .Rows = 1
        .Cols = 2
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = ""
        .TextMatrix(0, 1) = "Rep"
        .FixedAlignment(0) = 4
        .FixedAlignment(1) = 4
        .ColWidth(0) = 500
        .ColWidth(1) = 500
        .ColAlignment(0) = 4
        .ColAlignment(1) = 4
    End With
    
    With Lista_Retirar
        .Clear
        .Rows = 1
        .Cols = 16
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "ID_Material"
        .TextMatrix(0, 1) = "Material"
        .TextMatrix(0, 2) = "Inv BID"
        .TextMatrix(0, 3) = "Lote"
        .TextMatrix(0, 4) = "Localiza|fffd||fffd|o"
        .TextMatrix(0, 5) = "CamaraFria"
        .TextMatrix(0, 6) = "Endere|fffd|o"
        .TextMatrix(0, 7) = "Coment|fffd|rio"
        .TextMatrix(0, 8) = "Estoque"
        .TextMatrix(0, 9) = "Necessidade"
        .TextMatrix(0, 10) = "Buffer"
        .TextMatrix(0, 11) = "ID_Retirada"
        .TextMatrix(0, 12) = "filtroSet"
        .TextMatrix(0, 13) = "filtroGrower"
        .TextMatrix(0, 14) = "filtroLoc"
        .TextMatrix(0, 15) = "filtroRep"
        
        .FixedAlignment(0) = 7
        For col = 1 To .Cols - 1
            .FixedAlignment(col) = 4
        Next col
        .FixedAlignment(11) = 7
        .FixedAlignment(12) = 7
        .FixedAlignment(13) = 7
        .FixedAlignment(14) = 7
        .FixedAlignment(15) = 7
        
        .ColWidth(0) = 0
        For col = 1 To .Cols - 1
            .ColWidth(col) = 2000
        Next col
        .ColWidth(11) = 0
        .ColWidth(12) = 0
        .ColWidth(13) = 0
        .ColWidth(14) = 0
        .ColWidth(15) = 0
        
        .ColAlignment(0) = 7
        For col = 1 To .Cols - 1
            .ColAlignment(col) = 1
        Next col
        .ColAlignment(8) = 7
        .ColAlignment(9) = 7
        .ColAlignment(11) = 7
        .ColAlignment(12) = 7
        .ColAlignment(13) = 7
        .ColAlignment(14) = 7
        .ColAlignment(15) = 7
    End With
    
    Processa = False
    
    Monta_Combo_Set
    Monta_Combo_Grower
    Monta_Combo_Loc
    
    Processa = True
    
    Mostra_Materiais
    
    Checa_RetiradaPendente
End Sub

Public Sub Monta_Combo_Set()
    Dim rs As ADODB.Recordset
    
    Set rs = New ADODB.Recordset
    
    rs.Open "SELECT DISTINCT FB.[Set] " & _
            "FROM tab_fieldbook as FB " & _
            "INNER JOIN tab_material as M on M.ID_Material = FB.ID_Material " & _
            "WHERE FB.Season='" & safra & "' and " & _
                  "FB.etiquetaimpressa=false and " & _
                  "FB.[Plot Deactivated]=false and " & _
                  "FB.[Set] is not null and " & _
                  "M.Status = 'Ativo' " & _
            "ORDER BY FB.[Set]", con
    
    With cmbSet
        .Clear
        .ColumnCount = 1
        .AddItem "Todos"
        While Not rs.EOF
            .AddItem rs("Set")
            
            rs.MoveNext
        Wend
        
        .ListIndex = 0
    End With
    
    rs.Close
    Set rs = Nothing

End Sub

Public Sub Monta_Combo_Grower()
    Dim rs As ADODB.Recordset
    
    Set rs = New ADODB.Recordset
    
    rs.Open "SELECT DISTINCT FB.[Grower Proj], P.CodigoPrograma " & _
          "FROM tab_fieldbook as FB " & _
          "INNER JOIN tab_programa as P on P.ID_Programa = FB.[Grower Proj] " & _
          "WHERE FB.Season='" & safra & "' and " & _
                "FB.etiquetaimpressa=false and " & _
                "FB.[Set] is not null and " & _
                "FB.[plot deactivated]=false " & _
          "ORDER BY P.CodigoPrograma", con
    
    With cmbGrower
        .Clear
        .ColumnCount = 2
        .ColumnWidths = "0;10"
        .AddItem 0
        .Column(1, .ListCount - 1) = "Todos"
        While Not rs.EOF
            .AddItem rs("Grower Proj")
            .Column(1, .ListCount - 1) = rs("CodigoPrograma")
            
            rs.MoveNext
        Wend
        
        .ListIndex = 0
    End With
    
    rs.Close
    Set rs = Nothing

End Sub

Public Sub Monta_Combo_Loc()
    Dim rs As ADODB.Recordset
    
    Set rs = New ADODB.Recordset
    
    rs.Open "SELECT DISTINCT FB.[Loc] " & _
            "FROM tab_fieldbook as FB " & _
            "WHERE FB.Season='" & safra & "' and " & _
                  "FB.etiquetaimpressa=false and " & _
                  "FB.[Set] is not null and " & _
                  "FB.[Plot Deactivated]=false " & _
            "ORDER BY FB.[Loc]", con
    
    With cmbLoc
        .Clear
        .ColumnCount = 1
        .AddItem "Todos"
        While Not rs.EOF
            .AddItem rs("Loc")
            
            rs.MoveNext
        Wend
        
        .ListIndex = 0
    End With
    
    rs.Close
    Set rs = Nothing

End Sub

Public Sub Mostra_Materiais()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim IDAnt As Long
    Dim IBAnt As String
    
    Set rs = New ADODB.Recordset
    
    sql = "SELECT DISTINCT FB.ID_Material, M.Pedigree, FB.[Inv bid], FB.[Set], " & _
                            "(SELECT SUM(QTDEMOVIMENTACAO) " & _
                             "FROM TAB_MATERIALMOVIMENTACAO " & _
                             "WHERE ID_MATERIAL = FB.ID_Material) AS QTDESEMENTES " & _
            "FROM tab_fieldbook as FB " & _
            "INNER JOIN tab_material as M on M.ID_Material = FB.ID_Material " & _
            "WHERE FB.Season='" & safra & "' and " & _
                  "FB.etiquetaimpressa=false and " & _
                  "M.Status = 'Ativo' "
    If cmbSet <> "Todos" Then
        sql = sql & "AND FB.[Set] = '" & cmbSet & "' "
    End If
    If cmbGrower <> 0 Then
        sql = sql & "AND FB.[Grower Proj] = " & cmbGrower & " "
    End If
    If cmbLoc <> "Todos" Then
        sql = sql & "AND FB.[Loc] = '" & cmbLoc & "' "
    End If
    
    sql = sql & "ORDER BY M.Pedigree, FB.[Inv BID]"
            
    rs.Open sql, con
                  
    With Lista_Materiais
        .Rows = 1
        
        IDAnt = 0
        IBAnt = ""
        
        .Visible = False
        
        While Not rs.EOF
            If rs("QtdeSementes") > 0 Then
                If IDAnt <> rs("ID_Material") Or _
                   IBAnt <> rs("inv bid") Then
                   
                    IDAnt = rs("ID_Material")
                    IBAnt = rs("inv bid")
                    
                    .Rows = .Rows + 1
                    
                    .col = 0
                    .Row = .Rows - 1
                    .FillStyle = flexFillRepeat
                    .CellFontName = "Wingdings"
                    .CellFontSize = 12
                    .CellAlignment = flexAlignCenterCenter
                    .FillStyle = flexFillSingle
                    .Text = "q"
                    
                    .TextMatrix(.Rows - 1, 1) = rs("ID_Material")
                    .TextMatrix(.Rows - 1, 2) = rs("Pedigree")
                    .TextMatrix(.Rows - 1, 3) = rs("Inv Bid")
                    .TextMatrix(.Rows - 1, 4) = Format(rs("QtdeSementes"), "#,##0")
                    
                    .col = 5
                    .Row = .Rows - 1
                    .FillStyle = flexFillRepeat
                    .CellFontName = "Wingdings"
                    .CellFontSize = 12
                    .CellAlignment = flexAlignCenterCenter
                    .FillStyle = flexFillSingle
                    
                    If IsNull(rs("Set")) Then
                        .Text = "|fffd|"
                    Else
                        .Text = "q"
                    End If
                End If
            End If
            
            rs.MoveNext
        Wend
        
        .Visible = True
    End With
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Lista_Materiais, 2, 5
    
End Sub

Public Sub Monta_Lista_Sets()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim filtrog As String
    Dim filtrol As String
    Dim filtror As String
    Dim lin As Long
    
    If MaterialRow < 1 Then Exit Sub
    
    Lista_Sets.Rows = 1
    
    If Lista_Materiais.TextMatrix(MaterialRow, 0) = "q" Then Exit Sub
    
    filtrog = ""
    With Lista_Grower
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtrog <> "" Then filtrog = filtrog & ","
                filtrog = filtrog & .TextMatrix(lin, 1)
            End If
        Next lin
    End With
    If Lista_Grower.Rows > 1 And filtrog = "" Then filtrog = "999"
    
    filtrol = ""
    With Lista_Location
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtrol <> "" Then filtrol = filtrol & ","
                filtrol = filtrol & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    If Lista_Location.Rows > 1 And filtrol = "" Then filtrol = "'XXX'"
    
    filtror = ""
    With Lista_Reps
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtror <> "" Then filtror = filtror & ","
                filtror = filtror & .TextMatrix(lin, 1)
            End If
        Next lin
    End With
    If Lista_Reps.Rows > 1 And filtror = "" Then filtror = "999"
    
    Set rs = New ADODB.Recordset
    
    sql = "SELECT DISTINCT FB.[Set] " & _
          "FROM tab_fieldbook as FB " & _
          "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                "FB.[Inv BID] = '" & Lista_Materiais.TextMatrix(MaterialRow, 3) & "' and " & _
                "FB.Season='" & safra & "' and " & _
                "FB.etiquetaimpressa=false and " & _
                "FB.[plot deactivated]=false and " & _
                "FB.[set] is not null"
    If filtrog <> "" Then sql = sql & " and FB.[Grower Proj] in (" & filtrog & ")"
    If filtrol <> "" Then sql = sql & " and FB.[Loc] in (" & filtrol & ")"
    If filtror <> "" Then sql = sql & " and FB.[REP#] in (" & filtror & ")"
    
    rs.Open sql, con
    
    With Lista_Sets
        .Rows = 1
        
        While Not rs.EOF
            .Rows = .Rows + 1
                
            .col = 0
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            .Text = "|fffd|"
            .BackColor = &HE0E0E0
            
            .col = 1
            .Text = rs("Set")
            .BackColor = &HE0E0E0
            
            rs.MoveNext
        Wend
    End With
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Lista_Sets, 1, 1
End Sub

Public Sub Monta_Lista_Growers()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    Dim filtros As String
    Dim filtrol As String
    Dim filtror As String
    
    Dim lin As Integer
    
    If MaterialRow < 1 Then Exit Sub
    
    Lista_Grower.Rows = 1
    
    filtros = ""
    With Lista_Sets
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtros <> "" Then filtros = filtros & ", "
                filtros = filtros & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    
    If filtros = "" Then Exit Sub
    
    filtrol = ""
    With Lista_Location
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtrol <> "" Then filtrol = filtrol & ", "
                filtrol = filtrol & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    If Lista_Location.Rows > 1 And filtrol = "" Then filtrol = "'XXX'"
    
    filtror = ""
    With Lista_Reps
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtror <> "" Then filtror = filtror & ", "
                filtror = filtror & .TextMatrix(lin, 1)
            End If
        Next lin
    End With
    If Lista_Reps.Rows > 1 And filtror = "" Then filtror = "999"
    
    Set rs = New ADODB.Recordset
    
    sql = "SELECT DISTINCT FB.[Grower Proj], P.CodigoPrograma " & _
          "FROM tab_fieldbook as FB " & _
          "INNER JOIN tab_programa as P on P.ID_Programa = FB.[Grower Proj] " & _
          "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                "FB.[Inv BID] = '" & Lista_Materiais.TextMatrix(MaterialRow, 3) & "' and " & _
                "FB.Season='" & safra & "' and " & _
                "FB.etiquetaimpressa=false and " & _
                "FB.[plot deactivated]=false and " & _
                "FB.[set] in (" & filtros & ")"
    If filtrol <> "" Then sql = sql & " and FB.[Loc] in (" & filtrol & ")"
    If filtror <> "" Then sql = sql & " and FB.[Rep#] in (" & filtror & ")"
    
    rs.Open sql, con
    
    With Lista_Grower
        While Not rs.EOF
            .Rows = .Rows + 1
                
            .col = 0
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            .Text = "|fffd|"
            .BackColor = &HE0E0E0
            
            .col = 1
            .Text = rs("Grower Proj")
            .BackColor = &HE0E0E0
            .col = 2
            .Text = rs("CodigoPrograma")
            .BackColor = &HE0E0E0
            
            rs.MoveNext
        Wend
    End With
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Lista_Grower, 2, 2
End Sub

Public Sub Monta_Lista_Loc()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim filtros As String
    Dim filtrog As String
    Dim filtror As String
    Dim lin As Integer
    
    If MaterialRow < 1 Then Exit Sub
    
    filtros = ""
    With Lista_Sets
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtros <> "" Then filtros = filtros & ", "
                filtros = filtros & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    
    Lista_Location.Rows = 1
    
    If filtros = "" Then Exit Sub
    
    filtrog = ""
    With Lista_Grower
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtrog <> "" Then filtrog = filtrog & ", "
                filtrog = filtrog & .TextMatrix(lin, 1)
            End If
        Next lin
    End With
    If Lista_Grower.Rows > 1 And filtrog = "" Then filtrog = "999"
    
    filtror = ""
    With Lista_Reps
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtror <> "" Then filtror = filtror & ", "
                filtror = filtror & .TextMatrix(lin, 1)
            End If
        Next lin
    End With
    If Lista_Reps.Rows > 1 And filtror = "" Then filtror = "999"
    
    Set rs = New ADODB.Recordset
    
    sql = "SELECT DISTINCT FB.Loc " & _
          "FROM tab_fieldbook as FB " & _
          "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                "FB.[Inv BID] = '" & Lista_Materiais.TextMatrix(MaterialRow, 3) & "' and " & _
                "FB.Season='" & safra & "' and " & _
                "FB.etiquetaimpressa=false and " & _
                "FB.[plot deactivated]=false and " & _
                "FB.[set] in (" & filtros & ")"
    If filtrog <> "" Then sql = sql & " and FB.[Grower Proj] in (" & filtrog & ")"
    If filtror <> "" Then sql = sql & " and FB.[Rep#] in (" & filtror & ")"
    
    rs.Open sql, con
    
    With Lista_Location
        While Not rs.EOF
            .Rows = .Rows + 1
            
            .col = 0
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            .Text = "|fffd|"
            .BackColor = &HE0E0E0
            
            .col = 1
            .Text = rs("Loc")
            .BackColor = &HE0E0E0
            
            rs.MoveNext
        Wend
    End With
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Lista_Location, 1, 1
End Sub

Public Sub Monta_Lista_Reps()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim filtros As String
    Dim filtrog As String
    Dim filtrol As String
    Dim lin As Integer
    
    If MaterialRow < 1 Then Exit Sub
    
    filtros = ""
    With Lista_Sets
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtros <> "" Then filtros = filtros & ", "
                filtros = filtros & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    
    Lista_Reps.Rows = 1
    
    If filtros = "" Then Exit Sub
    
    filtrog = ""
    With Lista_Grower
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtrog <> "" Then filtrog = filtrog & ", "
                filtrog = filtrog & .TextMatrix(lin, 1)
            End If
        Next lin
    End With
    If Lista_Grower.Rows > 1 And filtrog = "" Then filtrog = "999"
    
    filtrol = ""
    With Lista_Location
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtrol <> "" Then filtrol = filtrol & ", "
                filtrol = filtrol & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    If Lista_Location.Rows > 1 And filtrol = "" Then filtrol = "'XXX'"
    
    Set rs = New ADODB.Recordset
    
    sql = "SELECT DISTINCT FB.[Rep#] " & _
          "FROM tab_fieldbook as FB " & _
          "WHERE FB.ID_Material = " & Lista_Materiais.TextMatrix(MaterialRow, 1) & " and " & _
                "FB.[Inv BID] = '" & Lista_Materiais.TextMatrix(MaterialRow, 3) & "' and " & _
                "FB.Season='" & safra & "' and " & _
                "FB.etiquetaimpressa=false and " & _
                "FB.[plot deactivated]=false and " & _
                "FB.[set] in (" & filtros & ")"
    If filtrog <> "" Then sql = sql & " and FB.[Grower Proj] in (" & filtrog & ")"
    If filtrol <> "" Then sql = sql & " and FB.[Loc] in (" & filtrol & ")"
    
    rs.Open sql, con
    
    With Lista_Reps
        While Not rs.EOF
            .Rows = .Rows + 1
                
            .col = 0
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            .Text = "|fffd|"
            .BackColor = &HE0E0E0
            
            .col = 1
            .Text = rs("Rep#")
            .BackColor = &HE0E0E0
            
            rs.MoveNext
        Wend
    End With
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Lista_Reps, 1, 1
End Sub

Private Sub Monta_Relatorio()
    Dim lin As Integer
    Dim sql As String
    Dim JaTem As Boolean
    Dim rs As ADODB.Recordset
    Dim filtro As String
    Dim cont As Integer
    
    Lista_Retirar.Visible = False
    
    If Lista_Materiais.TextMatrix(MaterialRow, 0) = "|fffd|" Then
        JaTem = False
        With Lista_Retirar
            For lin = 1 To .Rows - 1
                If .TextMatrix(lin, 0) = Lista_Materiais.TextMatrix(MaterialRow, 1) And _
                   .TextMatrix(lin, 2) = Lista_Materiais.TextMatrix(MaterialRow, 3) Then
                    retirarRow = lin
                    
                    JaTem = True
                    Exit For
                End If
            Next lin
        End With
        
        If Not JaTem Then
            sql = "SELECT M.*, C.NomeCamaraFria, (E.Corredor & '-' & E.Prateleira & '-' & E.Andar & '-' & E.Numero) as Endereco, E.Comentario " & _
                  "FROM ((tab_material as M " & _
                  "LEFT JOIN tab_camarafria as C ON C.ID_CamaraFria = M.ID_CamaraFria) " & _
                  "LEFT JOIN tab_camarafriaendereco as E ON E.ID_Camarafria = M.ID_CamaraFria and E.ID_Endereco = M.ID_Endereco) " & _
                  "WHERE ID_Material=" & Lista_Materiais.TextMatrix(MaterialRow, 1)
            Set rs = New ADODB.Recordset
            rs.Open sql, con
            With Lista_Retirar
                .Rows = .Rows + 1
                retirarRow = .Rows - 1
                
                .TextMatrix(.Rows - 1, 0) = rs("ID_Material")
                .TextMatrix(.Rows - 1, 1) = rs("Pedigree")
                .TextMatrix(.Rows - 1, 2) = Lista_Materiais.TextMatrix(MaterialRow, 3)
                .TextMatrix(.Rows - 1, 3) = rs("Lote")
                .TextMatrix(.Rows - 1, 4) = rs("Localizacao")
                .TextMatrix(.Rows - 1, 5) = IIf(IsNull(rs("NomeCamaraFria")), "", rs("NomeCamaraFria"))
                .TextMatrix(.Rows - 1, 6) = IIf(IsNull(rs("Endereco")), "", rs("Endereco"))
                .TextMatrix(.Rows - 1, 7) = IIf(IsNull(rs("Comentario")), "", rs("Comentario"))
                
                filtro = ""
                For cont = 1 To Lista_Sets.Rows - 1
                    If filtro <> "" Then filtro = filtro & ", "
                    filtro = filtro & Lista_Sets.TextMatrix(cont, 1) & "#" & Lista_Sets.TextMatrix(cont, 0)
                Next cont
                .TextMatrix(.Rows - 1, 12) = filtro
                
                filtro = ""
                For cont = 1 To Lista_Grower.Rows - 1
                    If filtro <> "" Then filtro = filtro & ", "
                    filtro = filtro & Lista_Grower.TextMatrix(cont, 1) & "#" & Lista_Grower.TextMatrix(cont, 0)
                Next cont
                .TextMatrix(.Rows - 1, 13) = filtro
                
                filtro = ""
                For cont = 1 To Lista_Location.Rows - 1
                    If filtro <> "" Then filtro = filtro & ", "
                    filtro = filtro & Lista_Location.TextMatrix(cont, 1) & "#" & Lista_Location.TextMatrix(cont, 0)
                Next cont
                .TextMatrix(.Rows - 1, 14) = filtro
                
                filtro = ""
                For cont = 1 To Lista_Reps.Rows - 1
                    If filtro <> "" Then filtro = filtro & ", "
                    filtro = filtro & Lista_Reps.TextMatrix(cont, 1) & "#" & Lista_Reps.TextMatrix(cont, 0)
                Next cont
                .TextMatrix(.Rows - 1, 15) = filtro
                
                .col = 10
                .Row = .Rows - 1
                .FillStyle = flexFillRepeat
                .CellFontName = "Wingdings"
                .CellFontSize = 12
                .CellAlignment = flexAlignCenterCenter
                .FillStyle = flexFillSingle
                .Text = Lista_Materiais.TextMatrix(MaterialRow, 5)
                
            End With
            rs.Close
            Set rs = Nothing
        End If
    End If
    
    If Lista_Materiais.TextMatrix(MaterialRow, 0) = "q" Then
        With Lista_Retirar
            For lin = 1 To .Rows - 1
                If .TextMatrix(lin, 0) = Lista_Materiais.TextMatrix(MaterialRow, 1) Then
                    If .Rows = 2 Then
                        .Rows = 1
                    Else
                        .RemoveItem (lin)
                    End If
                    Exit For
                End If
            Next lin
        End With
    End If
    
    Lista_Retirar.Visible = True
    
    AutosizeGridColumns Lista_Retirar, 1, 10
    
End Sub

Private Sub Calcula_Sementes()
    Dim lin As Integer
    Dim col As Integer
    
    Dim filtroSet As String
    Dim filtroGrower As String
    Dim filtroLocation As String
    Dim filtroRep As String
    
    Dim sql As String
    
    Dim TotParcelas As Long
    Dim TotSeedPacket As Long
    Dim TotPacketParc As Long
    
    Dim TotSementes As Long
    
    Dim totEstoque As Long
    
    Dim rs As ADODB.Recordset
    
    If Lista_Materiais.TextMatrix(MaterialRow, 0) <> "|fffd|" Then Exit Sub
    
    totEstoque = Pega_Valor(Lista_Materiais.TextMatrix(MaterialRow, 4))
    
    filtroSet = ""
    With Lista_Sets
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtroSet <> "" Then filtroSet = filtroSet & ", "
                filtroSet = filtroSet & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    If filtroSet = "" Then filtroSet = "'XXX'"
    
    filtroGrower = ""
    With Lista_Grower
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtroGrower <> "" Then filtroGrower = filtroGrower & ", "
                filtroGrower = filtroGrower & .TextMatrix(lin, 1)
            End If
        Next lin
    End With
    If filtroGrower = "" Then filtroGrower = "999"
    
    filtroLocation = ""
    With Lista_Location
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtroLocation <> "" Then filtroLocation = filtroLocation & ", "
                filtroLocation = filtroLocation & "'" & .TextMatrix(lin, 1) & "'"
            End If
        Next lin
    End With
    If filtroLocation = "" Then filtroLocation = "'XXX'"
    
    filtroRep = ""
    With Lista_Reps
        For lin = 1 To .Rows - 1
            If .TextMatrix(lin, 0) = "|fffd|" Then
                If filtroRep <> "" Then filtroRep = filtroRep & ", "
                filtroRep = filtroRep & .TextMatrix(lin, 1)
            End If
        Next lin
    End With
    If filtroRep = "" Then filtroRep = "999"
    
    sql = "SELECT Count(FB.[Plot Bid]) as TotParcela, P.QtdeSaqParcela, " & _
                 "(SELECT SUM(PT.QtdeSementes) " & _
                 "FROM tab_protocolotratamento as PT " & _
                 "WHERE PT.ID_Protocolo = P.ID_Protocolo) as QtdeSemente " & _
          "FROM tab_fieldbook as FB " & _
          "LEFT JOIN tab_protocolo as P ON P.[Set] = FB.[Set] " & _
          "WHERE FB.[Season]='" & safra & "' AND " & _
                "FB.EtiquetaImpressa=false AND " & _
                "FB.ID_Material=" & Lista_Materiais.TextMatrix(MaterialRow, 1) & " AND "
    
    If Lista_Materiais.TextMatrix(MaterialRow, 5) = "q" Then
        sql = sql & "P.ID_Program = FB.[Orig Proj] and " & _
                    "FB.[Plot Deactivated]=false and " & _
                    "FB.[Set] in (" & filtroSet & ") AND " & _
                    "FB.[Grower Proj] in (" & filtroGrower & ") AND " & _
                    "FB.[Loc] in (" & filtroLocation & ") AND " & _
                    "FB.[Rep#] in (" & filtroRep & ") "
    Else
        sql = sql & "(FB.[Plot Deactivated]=true or FB.[Set] is null) and " & _
                    "FB.[Loc] in (" & filtroLocation & ") and P.ID_Program IN " & _
                    "(SELECT DISTINCT F.[ORIG PROJ] FROM TAB_FIELDBOOK as F WHERE F.[FIELD]=FB.[FIELD] AND F.[SET] IS NOT NULL)"
    
    End If
    sql = sql & "GROUP BY P.Reps, P.QtdeSaqParcela, ID_Protocolo"

    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    TotParcelas = 0
    TotPacketParc = 0
    TotSeedPacket = 0
    TotSementes = 0
    
    While Not rs.EOF
        TotParcelas = IIf(IsNull(rs("TotParcela")), 0, rs("TotParcela"))
        TotPacketParc = IIf(IsNull(rs("QtdeSaqParcela")), 0, rs("QtdeSaqParcela"))
        TotSeedPacket = IIf(IsNull(rs("QtdeSemente")), 0, rs("QtdeSemente"))
        TotSeedPacket = TotSeedPacket + WorksheetFunction.RoundUp(TotSeedPacket * (Margem / 100), 0)
        
        TotSementes = TotSementes + ((TotSeedPacket * TotPacketParc) * TotParcelas)
        
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
    
    With Lista_Retirar
        .TextMatrix(retirarRow, 8) = Format(totEstoque, "#,##0")
        .TextMatrix(retirarRow, 9) = Format(TotSementes, "#,##0")
        
        .Row = retirarRow
        
        For col = 0 To .Cols - 1
            .col = col
            If totEstoque > TotSementes Then
                .CellBackColor = &H80FF80
            Else
                .CellBackColor = &H80C0FF
            End If
        Next col
    End With
End Sub

Private Sub Imprimir_relatorio()
    Dim lin As Integer
    Dim sht As Worksheet
    
    Set sht = ThisWorkbook.Sheets("Retirar_Camara")
    With sht
        .Visible = xlSheetVisible
        .Activate
        .Select
        .Range("A1").Select
        ActiveCell.SpecialCells(xlCellTypeLastCell).Select
        .Rows("2:" & CStr(Selection.Row)).Delete
        
        For lin = 1 To Lista_Retirar.Rows - 1
            .Cells(lin + 1, 1) = Lista_Retirar.TextMatrix(lin, 1)
            .Cells(lin + 1, 2) = Lista_Retirar.TextMatrix(lin, 2)
            .Cells(lin + 1, 3) = Lista_Retirar.TextMatrix(lin, 3)
            .Cells(lin + 1, 4) = Lista_Retirar.TextMatrix(lin, 4)
            .Cells(lin + 1, 5) = Lista_Retirar.TextMatrix(lin, 5)
            .Cells(lin + 1, 6) = Lista_Retirar.TextMatrix(lin, 6)
            .Cells(lin + 1, 7) = Lista_Retirar.TextMatrix(lin, 7)
            .Range("A" & CStr(lin + 1) & ":G" & CStr(lin + 1)).Borders(xlEdgeBottom).LineStyle = xlContinuous
        Next lin
        
        Application.Dialogs(xlDialogPrint).Show
    End With
    
    Sheets("Sheet1").Select
    sht.Visible = xlSheetHidden
    
    Set sht = Nothing
End Sub

Private Sub Checa_RetiradaPendente()
    Dim rs As ADODB.Recordset
    Dim rs1 As ADODB.Recordset
    
    Dim lin As Long
    Dim col As Integer
    Dim para As Boolean
    
    dataOpen = Date
    
    Set rs = New ADODB.Recordset
    rs.Open "SELECT R.*, M.Pedigree, M.Lote, M.Localizacao, C.NomeCamaraFria, (E.Corredor & '-' & E.Prateleira & '-' & E.Andar & '-' & E.Numero) as Endereco, E.Comentario " & _
            "FROM (((tab_retirada as R " & _
            "INNER JOIN tab_material as M on M.ID_Material = R.ID_Material) " & _
            "INNER JOIN tab_camarafria as C on C.ID_CamaraFria = M.ID_CamaraFria) " & _
            "INNER JOIN tab_camarafriaEndereco as E on E.ID_CamaraFria = M.ID_CamaraFria and E.ID_Endereco = M.ID_Endereco) " & _
            "WHERE data_retirada is null", con
    
    Lista_Retirar.Visible = False
    
    While Not rs.EOF
        dataOpen = rs("Data")
        
        With Lista_Retirar
            .Rows = .Rows + 1
            
            .TextMatrix(.Rows - 1, 0) = rs("ID_Material")
            .TextMatrix(.Rows - 1, 1) = rs("Pedigree")
            .TextMatrix(.Rows - 1, 2) = rs("InvBID")
            .TextMatrix(.Rows - 1, 3) = rs("Lote")
            .TextMatrix(.Rows - 1, 4) = rs("Localizacao")
            .TextMatrix(.Rows - 1, 5) = rs("NomeCamaraFria")
            .TextMatrix(.Rows - 1, 6) = rs("Endereco")
            .TextMatrix(.Rows - 1, 7) = rs("Comentario")
            .TextMatrix(.Rows - 1, 8) = Format(rs("Estoque"), "#,##0")
            .TextMatrix(.Rows - 1, 9) = Format(rs("Necessidade"), "#,##0")
            .TextMatrix(.Rows - 1, 11) = rs("ID_Retirada")
            .TextMatrix(.Rows - 1, 12) = rs("FiltroSet")
            .TextMatrix(.Rows - 1, 13) = rs("FiltroGrower")
            .TextMatrix(.Rows - 1, 14) = rs("FiltroLoc")
            .TextMatrix(.Rows - 1, 15) = rs("FiltroRep")
            
            .col = 10
            .Row = .Rows - 1
            .FillStyle = flexFillRepeat
            .CellFontName = "Wingdings"
            .CellFontSize = 12
            .CellAlignment = flexAlignCenterCenter
            .FillStyle = flexFillSingle
            
            If rs("Buffer") Then
                .Text = "|fffd|"
            Else
                .Text = "q"
            End If
            
            .Row = .Rows - 1
            
            For col = 0 To .Cols - 1
                .col = col
                If rs("Estoque") > rs("Necessidade") Then
                    .CellBackColor = &H80FF80
                Else
                    .CellBackColor = &H80C0FF
                End If
            Next col
            
            For lin = 1 To Lista_Materiais.Rows - 1
                para = False
                
                Lista_Materiais.Row = lin
                Lista_Materiais.col = 0
                
                If Lista_Materiais.TextMatrix(lin, 1) = rs("ID_Material") Then
                    Lista_Materiais.Text = "|fffd|"
                    para = True
                End If
                
                For col = 0 To Lista_Materiais.Cols - 1
                    Lista_Materiais.col = col
                    If Lista_Materiais.TextMatrix(lin, 0) = "|fffd|" Then
                        Lista_Materiais.CellBackColor = &HE0E0E0
                    Else
                        Lista_Materiais.CellBackColor = &H80000005
                    End If
                Next col
                
                If para Then Exit For
            Next lin

        End With
        
        rs.MoveNext
    Wend
    
    Lista_Retirar.Visible = True
    
    rs.Close
    Set rs = Nothing
End Sub
Attribute VB_Name = "form_retornocamara"
Attribute VB_Base = "0{B32453F1-C077-45F1-A3AE-824AA8BAFF35}{79FF1DB3-C02E-48CB-B11D-B48769372A37}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim MaterialRow As Integer
Dim MaterialCol As Integer
Dim PrimeiraLetra As Boolean

Private Sub btnConfirmar_Click()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim lin As Integer
    Dim estoque As Long
    Dim estoqueAtual As Long
    
    Set rs = New ADODB.Recordset
    
    With Lista_Materiais
        For lin = 1 To .Rows - 1
            If IsNumeric(.TextMatrix(lin, 3)) Then
                sql = "SELECT SUM(QtdeMovimentacao) as estoque FROM tab_materialmovimentacao WHERE ID_Material = " & .TextMatrix(lin, 0)
                rs.Open sql, con
                estoque = rs("estoque")
                rs.Close
                
                estoqueAtual = Val(.TextMatrix(lin, 3)) - estoque
                
                sql = "INSERT INTO tab_materialmovimentacao (ID_Material, DataMovimentacao, HoraMovimentacao, TipoMovimentacao, QtdeMovimentacao) " & _
                              "VALUES (" & .TextMatrix(lin, 0) & ", #" & Format(Date, "yyyy/mm/dd") & "#,#" & Format(Now, "hh:mm:ss") & "#,'Consumo', " & estoqueAtual & ")"
                con.Execute sql
                
                sql = "UPDATE tab_material SET Status = '" & IIf(Abs(estoqueAtual) = estoque, "Acabou", "Ativo") & "' WHERE ID_Material = " & .TextMatrix(lin, 0)
                con.Execute sql
            End If
        Next lin
    End With
    
    Set rs = Nothing
    
    Monta_Lista_Materiais
End Sub

Private Sub edtFindMaterial_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim lin As Integer
    Dim col As Integer
    Dim achou As Boolean
    
    If KeyCode = vbKeyReturn Then
    
        If edtFindMaterial.Text = "" Then Exit Sub
        
        With Lista_Materiais
            achou = False
            MaterialRow = 0
            
            For lin = 1 To .Rows - 1
                If UCase(.TextMatrix(lin, 2)) = UCase(edtFindMaterial) Then
                    achou = True
                    MaterialRow = lin
                    MaterialCol = 3
                    
                    .Row = MaterialRow
                    .col = .Cols - 1
                    
                    .Redraw = True
                    .TopRow = MaterialRow
                    .SetFocus
                    
                    Exit For
                End If
            Next lin
            
            If Not achou Then MsgBox "Material n|fffd|o encontrado.", vbInformation, "Pesquisa"
        End With
        
        edtFindMaterial.Text = ""
        
        If Not achou Then
            edtFindMaterial.SetFocus
        End If
    End If
End Sub

Private Sub Lista_Materiais_KeyPress(KeyAscii As Integer)
    If MaterialRow <= 0 Then Exit Sub
    
    If MaterialCol = 3 Then
        With Lista_Materiais
            .col = MaterialCol
            Select Case KeyAscii
                Case vbKeyReturn, vbKeyTab
                    If .Row + 1 <= .Rows - 1 Then
                        .Row = .Row + 1
                    Else
                        .Row = 1
                    End If
                    PrimeiraLetra = True
                    
                Case vbKeyBack
                    'remove o ultimo caractere
                    If Len(.Text) Then
                        .Text = Left(.Text, Len(.Text) - 1)
                    End If
        
                Case Is < 32
        
                Case Else
                    If PrimeiraLetra Then
                        PrimeiraLetra = False
                        .Text = ""
                    End If
                    If Somente_Numeros(KeyAscii, False, True) = True Then
                        .Text = .Text & Chr(KeyAscii)
                    End If
            End Select
        End With
    End If
End Sub

Private Sub Lista_Materiais_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As stdole.OLE_XPOS_PIXELS, ByVal y As stdole.OLE_YPOS_PIXELS)
    MaterialRow = Lista_Materiais.MouseRow
    MaterialCol = Lista_Materiais.MouseCol
End Sub

Private Sub UserForm_Initialize()
    Dim col As Integer
    
    Call Centralizar(Me)
    
'    If con Is Nothing Then Conecta_Banco
'    usuario = "Robson"
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
'    Frame1.Height = Me.Height - Frame1.Top - 30
    Frame1.BackColor = CorFundoTela
    
    With Lista_Materiais
        .Clear
        .Rows = 1
        .Cols = 4
        .FixedCols = 0
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .TextMatrix(0, 0) = "ID_Material"
        .TextMatrix(0, 1) = "Material"
        .TextMatrix(0, 2) = "Inv BID"
        .TextMatrix(0, 3) = "Estoque"
        .FixedAlignment(1) = 7
        For col = 1 To .Cols - 1
            .FixedAlignment(col) = 4
        Next col
        .ColWidth(0) = 0
        .ColWidth(1) = 3100
        .ColWidth(2) = 2255
        .ColWidth(3) = 1500
        .ColAlignment(0) = 7
        .ColAlignment(1) = 1
        .ColAlignment(2) = 1
        .ColAlignment(3) = 7
    End With
    
    Monta_Lista_Materiais

End Sub

Private Sub Monta_Lista_Materiais()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    Lista_Materiais.Rows = 1
    
    sql = "SELECT M.ID_Material, M.Pedigree, R.InvBID " & _
          "FROM (((tab_retirada as R " & _
          "INNER JOIN tab_material as M ON M.ID_Material = R.ID_Material) " & _
          "INNER JOIN tab_materialprograma as MP ON MP.ID_Material = R.ID_Material and MP.InvBID = R.InvBID) " & _
          "INNER JOIN tab_contadormaterial as C ON C.ID_Material = R.ID_Material) " & _
          "WHERE R.Retirou = true and M.Status = 'Em Uso' and C.Termino is not null " & _
          "ORDER BY M.Pedigree"
    
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    While Not rs.EOF
        With Lista_Materiais
            .Rows = .Rows + 1
            
            .TextMatrix(.Rows - 1, 0) = rs("ID_Material")
            .TextMatrix(.Rows - 1, 1) = rs("Pedigree")
            .TextMatrix(.Rows - 1, 2) = rs("InvBID")
            .TextMatrix(.Rows - 1, 3) = ""
            
        End With
        
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing
    
End Sub
Attribute VB_Name = "form_statusfields"
Attribute VB_Base = "0{051CF00E-B2B8-49D4-8C67-15D56C216522}{FFD96AF2-8D4A-49CD-B297-DBC9350B62FC}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim SafraAtual As String

Private Sub UserForm_Initialize()
    Dim col As Integer
    
    If con Is Nothing Then Conecta_Banco
    
    CorFundoTela = RGB(229, 239, 218)
    
    Me.ForeColor = RGB(84, 108, 109)
    Me.BackColor = CorFundoTela
    
    SafraAtual = Pega_Safra
    
    Call Centralizar(Me)
    
    With Lista_Fields
        .Clear
        .Rows = 1
        .Cols = 11
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarBoth
        .AllowBigSelection = False
        .AllowUserResizing = flexResizeColumns
        .RowHeight(0) = 480
        .WordWrap = True
        .TextMatrix(0, 0) = "Orig Proj"
        .TextMatrix(0, 1) = "Grower Proj"
        .TextMatrix(0, 2) = "Loc"
        .TextMatrix(0, 3) = "Set"
        .TextMatrix(0, 4) = "Field"
        .TextMatrix(0, 5) = "Crop"
        .TextMatrix(0, 6) = "Total Parcelas"
        .TextMatrix(0, 7) = "Etiquetas" & vbNewLine & "Impressas"
        .TextMatrix(0, 8) = "Check" & vbNewLine & "Contagem"
        .TextMatrix(0, 9) = "Check" & vbNewLine & "Sorteio"
        .TextMatrix(0, 10) = "Previs|fffd|o" & vbNewLine & "Envio"
        
        For col = 0 To .Cols - 1
            .FixedAlignment(col) = 4
            .ColWidth(col) = 0
            If col < 6 Then
                .ColAlignment(col) = 1
            ElseIf col = 10 Then
                .ColAlignment(col) = 4
            Else
                .ColAlignment(col) = 7
            End If
        Next col
        
        .FixedCols = 0
    End With
    
    Monta_Lista_Fields

End Sub

Private Sub Monta_Lista_Fields()
    Dim sql As String
    Dim rs As ADODB.Recordset
    Dim Cor As Boolean
    Dim col As Integer
    
    sql = "SELECT OP.CodigoPrograma as [OrigProj], " & _
                 "GP.CodigoPrograma as [GrowerProj], " & _
                 "F.[Loc], " & _
                 "F.[Set], " & _
                 "F.[Field], " & _
                 "F.[Crop], " & _
                 "Count(F.[Plot BID]) as TotalParcelas, " & _
                 "Sum(IIF(F.[EtiquetaImpressa]=true,1,0)) as EtqImp, " & _
                 "Sum(IIF(F.[CheckContagem]=true,1,0)) as ChkCont, " & _
                 "Sum(IIF(F.[CheckSorteio]=true,1,0)) as ChkSort," & _
                 "Avg(F.[PrevisaoEnvio]) as Data " & _
          "FROM ((tab_fieldbook as F " & _
          "LEFT JOIN tab_programa as OP ON OP.[ID_Programa] = F.[Orig Proj]) " & _
          "LEFT JOIN tab_programa as GP ON GP.[ID_Programa] = F.[Grower Proj]) " & _
          "WHERE F.Season='" & SafraAtual & "' " & _
          "GROUP BY OP.CodigoPrograma, GP.CodigoPrograma, F.[Loc], F.[Set], F.[Field], F.[Crop]"
    Set rs = New ADODB.Recordset
    rs.Open sql, con
    
    With Lista_Fields
        .Rows = 1
        .Visible = False
        
        While Not rs.EOF
            .Rows = .Rows + 1
            
            .TextMatrix(.Rows - 1, 0) = IIf(IsNull(rs("OrigProj")), "", rs("OrigProj"))
            .TextMatrix(.Rows - 1, 1) = IIf(IsNull(rs("GrowerProj")), "", rs("GrowerProj"))
            .TextMatrix(.Rows - 1, 2) = rs("Loc")
            .TextMatrix(.Rows - 1, 3) = IIf(IsNull(rs("Set")), "", rs("Set"))
            .TextMatrix(.Rows - 1, 4) = rs("Field")
            .TextMatrix(.Rows - 1, 5) = IIf(IsNull(rs("Crop")), "", rs("Crop"))
            .TextMatrix(.Rows - 1, 6) = Format(rs("TotalParcelas"), "#,##0")
            .TextMatrix(.Rows - 1, 7) = Format(rs("EtqImp"), "#,##0")
            .TextMatrix(.Rows - 1, 8) = Format(rs("ChkCont"), "#,##0")
            .TextMatrix(.Rows - 1, 9) = Format(rs("ChkSort"), "#,##0")
            .TextMatrix(.Rows - 1, 10) = IIf(rs("Data") = 0, "", Format(rs("Data"), "dd/mmm/yyyy"))
            
            If Cor Then
                .Row = .Rows - 1
                
                For col = 0 To .Cols - 1
                    .col = col
                    .CellBackColor = RGB(221, 235, 247)
                Next col
            End If
            
            Cor = Not Cor
            
            rs.MoveNext
        Wend
        .Visible = True
    End With
    
    rs.Close
    Set rs = Nothing
    
    AutosizeGridColumns Lista_Fields, 0, 10

End Sub
Attribute VB_Name = "form_usuario"
Attribute VB_Base = "0{F2F8D61B-6CE3-4DB8-890C-68E1E1CEDE8E}{D52F9FFF-0F08-4803-8A56-6AA5833006FD}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Option Explicit

Dim LinSelect As Integer
Dim novo As Boolean

Private Sub Cadastrados_Click()
    LinSelect = Cadastrados.RowSel
    
    If LinSelect > 0 Then
        edtUsuario.Text = Cadastrados.TextMatrix(LinSelect, 0)
        edtNome.Text = Cadastrados.TextMatrix(LinSelect, 1)
        edtEmail.Text = Cadastrados.TextMatrix(LinSelect, 2)
        edtSenha.Text = Cadastrados.TextMatrix(LinSelect, 3)
        edtConfirmaSenha.Text = Cadastrados.TextMatrix(LinSelect, 3)
        chkParametro = Cadastrados.TextMatrix(LinSelect, 4)
        chkProtocolo = Cadastrados.TextMatrix(LinSelect, 5)
        chkPrograma = Cadastrados.TextMatrix(LinSelect, 6)
        chkContador = Cadastrados.TextMatrix(LinSelect, 7)
        chkCamaraFria = Cadastrados.TextMatrix(LinSelect, 8)
        chkMaterial = Cadastrados.TextMatrix(LinSelect, 9)
        chkUsuario = Cadastrados.TextMatrix(LinSelect, 10)
        chkFieldBook = Cadastrados.TextMatrix(LinSelect, 11)
        chkRetiradaCamara = Cadastrados.TextMatrix(LinSelect, 12)
        chkImprimirSaquinho = Cadastrados.TextMatrix(LinSelect, 13)
        chkIniciarContagem = Cadastrados.TextMatrix(LinSelect, 14)
        chkCheckContagem = Cadastrados.TextMatrix(LinSelect, 15)
        chkRetornoMaterial = Cadastrados.TextMatrix(LinSelect, 16)
        chkCheckSorteio = Cadastrados.TextMatrix(LinSelect, 17)
        chkImprimirBuffer = Cadastrados.TextMatrix(LinSelect, 18)
        chkMapaWinterStiger = Cadastrados.TextMatrix(LinSelect, 19)
        chkBalancoMassa = Cadastrados.TextMatrix(LinSelect, 20)
        chkStatusFields = Cadastrados.TextMatrix(LinSelect, 21)
        chkBalancoMaterial = Cadastrados.TextMatrix(LinSelect, 22)
        chkAdmin = Cadastrados.TextMatrix(LinSelect, 23)
    End If
End Sub

Private Sub edtUsuario_Change()
    edtUsuario.Text = UCase(edtUsuario.Text)
End Sub

Private Sub edtNome_Change()
    edtNome.Text = UCase(edtNome.Text)
End Sub

Private Sub edtEmail_Change()
    edtEmail.Text = LCase(edtEmail.Text)
End Sub

Private Sub Menu_ButtonClick(ByVal Button As MSComctlLib.Button)
    Select Case Button.Key
        Case Is = "Novo"
            novo = True
            Limpa_Campos
            Habilita_Campos True
            edtUsuario.SetFocus
        Case Is = "Alterar"
            If edtUsuario.Text <> "" Then
                novo = False
                Habilita_Campos True
                edtNome.SetFocus
            End If
        Case Is = "Excluir"
            Excluir_Dados
        Case Is = "Cancelar"
            Limpa_Campos
            Habilita_Campos False
        Case Is = "Salvar"
            Salvar_Dados
    End Select
End Sub

Private Sub UserForm_Initialize()
    Dim cont As Integer
    
    If con Is Nothing Then Conecta_Banco

    Me.BackColor = CorFundoTela
    Frame3.BackColor = CorFundoTela
    Frame4.BackColor = CorFundoTela
    Frame5.BackColor = CorFundoTela
    
    With Menu
        .ImageList = ImageList1
        .Buttons(1).Image = ImageList1.ListImages(1).Index
        .Buttons(3).Image = ImageList1.ListImages(2).Index
        .Buttons(5).Image = ImageList1.ListImages(3).Index
        .Buttons(7).Image = ImageList1.ListImages(4).Index
        .Buttons(9).Image = ImageList1.ListImages(5).Index
        .Left = (Me.Width - .Width) / 2
    End With
    
    With Cadastrados
        .Clear
        .Rows = 1
        .Cols = 24
        .SelectionMode = flexSelectionByRow
        .Highlight = flexHighlightWithFocus
        .ScrollBars = flexScrollBarVertical
        .AllowBigSelection = False
        .TextMatrix(0, 0) = "Usu|fffd|rio"
        .TextMatrix(0, 1) = "Nome"
        .TextMatrix(0, 2) = "E-Mail"
        .TextMatrix(0, 3) = "Senha"
        .TextMatrix(0, 4) = "Par|fffd|metros"
        .TextMatrix(0, 5) = "Protocolos"
        .TextMatrix(0, 6) = "Programas"
        .TextMatrix(0, 7) = "Contadores"
        .TextMatrix(0, 8) = "C|fffd|maras Fria"
        .TextMatrix(0, 9) = "Material"
        .TextMatrix(0, 10) = "Usu|fffd|rio"
        .TextMatrix(0, 11) = "Field Book"
        .TextMatrix(0, 12) = "Retirada Camara"
        .TextMatrix(0, 13) = "Imprimir Saquinho"
        .TextMatrix(0, 14) = "Iniciar Contagem"
        .TextMatrix(0, 15) = "Check Contagem"
        .TextMatrix(0, 16) = "Guardar Material"
        .TextMatrix(0, 17) = "Check Sorteio"
        .TextMatrix(0, 18) = "Imprimir Buffer"
        .TextMatrix(0, 19) = "Mapa WinterStiger"
        .TextMatrix(0, 20) = "Balan|fffd|o de Massa"
        .TextMatrix(0, 21) = "Status FieldBooks"
        .TextMatrix(0, 22) = "Balan|fffd|o de Materiais"
        .TextMatrix(0, 23) = "Administrador"
        For cont = 0 To .Cols - 1
            .FixedAlignment(cont) = 4
        Next cont
        .ColWidth(0) = 1200
        .ColWidth(1) = 2400
        .ColWidth(2) = 1500
        .ColAlignment(0) = 1
        .ColAlignment(1) = 1
        .ColAlignment(2) = 1
        For cont = 3 To .Cols - 1
            .ColWidth(cont) = 0
            .ColAlignment(cont) = 4
        Next cont
    End With
    
    Call Centralizar(Me)
    
    novo = False
    
    Limpa_Campos
    Habilita_Campos False
    Mostra_Cadastrados
End Sub

Private Sub Limpa_Campos()
    edtUsuario.Text = ""
    edtNome.Text = ""
    edtEmail.Text = ""
    edtSenha.Text = ""
    edtConfirmaSenha.Text = ""
    chkParametro = False
    chkProtocolo = False
    chkPrograma = False
    chkContador = False
    chkCamaraFria = False
    chkMaterial = False
    chkUsuario = False
    chkFieldBook = False
    chkRetiradaCamara = False
    chkImprimirSaquinho = False
    chkIniciarContagem = False
    chkCheckContagem = False
    chkRetornoMaterial = False
    chkCheckSorteio = False
    chkImprimirBuffer = False
    chkMapaWinterStiger = False
    chkBalancoMassa = False
    chkStatusFields = False
    chkBalancoMaterial = False
    chkAdmin = False
End Sub

Private Sub Habilita_Campos(status As Boolean)
    If edtUsuario = "" Then
        edtUsuario.Enabled = status
    Else
        edtUsuario.Enabled = False
    End If
    edtNome.Enabled = status
    edtEmail.Enabled = status
    edtSenha.Enabled = status
    edtConfirmaSenha.Enabled = status
    chkParametro.Enabled = status
    chkProtocolo.Enabled = status
    chkPrograma.Enabled = status
    chkContador.Enabled = status
    chkCamaraFria.Enabled = status
    chkMaterial.Enabled = status
    chkUsuario.Enabled = status
    chkFieldBook.Enabled = status
    chkRetiradaCamara.Enabled = status
    chkImprimirSaquinho.Enabled = status
    chkIniciarContagem.Enabled = status
    chkCheckContagem.Enabled = status
    chkRetornoMaterial.Enabled = status
    chkCheckSorteio.Enabled = status
    chkImprimirBuffer.Enabled = status
    chkMapaWinterStiger.Enabled = status
    chkBalancoMassa.Enabled = status
    chkStatusFields.Enabled = status
    chkBalancoMaterial.Enabled = status
    chkAdmin.Enabled = status
    
    With Menu
        .Buttons(1).Enabled = Not status
        .Buttons(3).Enabled = Not status
        .Buttons(5).Enabled = Not status
        .Buttons(7).Enabled = status
        .Buttons(9).Enabled = status
    End With
    
    Cadastrados.Enabled = Not status
    
End Sub

Private Sub Mostra_Cadastrados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    
    Set rs = New ADODB.Recordset
    sql = "SELECT * FROM tab_usuario ORDER BY Nome"
    rs.Open sql, con
    
    Cadastrados.Rows = 1
    
    While Not rs.EOF
        With Cadastrados
            .Rows = .Rows + 1
        
            .TextMatrix(.Rows - 1, 0) = rs("Usuario")
            .TextMatrix(.Rows - 1, 1) = rs("Nome")
            .TextMatrix(.Rows - 1, 2) = rs("EMail")
            .TextMatrix(.Rows - 1, 3) = rs("Senha")
            .TextMatrix(.Rows - 1, 4) = rs("form_parametro")
            .TextMatrix(.Rows - 1, 5) = rs("form_protocolo")
            .TextMatrix(.Rows - 1, 6) = rs("form_programa")
            .TextMatrix(.Rows - 1, 7) = rs("form_contador")
            .TextMatrix(.Rows - 1, 8) = rs("form_camarafria")
            .TextMatrix(.Rows - 1, 9) = rs("form_material")
            .TextMatrix(.Rows - 1, 10) = rs("form_usuario")
            .TextMatrix(.Rows - 1, 11) = rs("form_fieldbook")
            .TextMatrix(.Rows - 1, 12) = rs("form_retiradacamara")
            .TextMatrix(.Rows - 1, 13) = rs("form_imprimirsaquinho")
            .TextMatrix(.Rows - 1, 14) = rs("form_iniciarcontagem")
            .TextMatrix(.Rows - 1, 15) = rs("form_checkcontagem")
            .TextMatrix(.Rows - 1, 16) = rs("form_retornocamara")
            .TextMatrix(.Rows - 1, 17) = rs("form_checksorteio")
            .TextMatrix(.Rows - 1, 18) = rs("form_imprimirbuffers")
            .TextMatrix(.Rows - 1, 19) = rs("form_mapawinterstiger")
            .TextMatrix(.Rows - 1, 20) = rs("form_balancomassa")
            .TextMatrix(.Rows - 1, 21) = rs("form_statusfields")
            .TextMatrix(.Rows - 1, 22) = rs("form_balancomateriais")
            .TextMatrix(.Rows - 1, 23) = rs("Admin")
         End With
         
        rs.MoveNext
    Wend
    
    rs.Close
    Set rs = Nothing

End Sub

Private Sub Salvar_Dados()
    Dim rs As ADODB.Recordset
    Dim sql As String
    Dim cont As Integer
    
    If edtUsuario.Text = "" Or _
       edtNome.Text = "" Or _
       edtEmail.Text = "" Or _
       edtSenha.Text = "" Or _
       edtConfirmaSenha.Text = "" Then
       MsgBox "Os campos s|fffd|o obrigat|fffd|rios.", vbInformation, "Salvar"
       Exit Sub
    End If
    
    If edtSenha.Text <> edtConfirmaSenha.Text Then
        MsgBox "Os campos de senha est|fffd|o divergentes." & vbNewLine & "Favor digit|fffd|-las novamente.", vbInformation, "Salvar"
        Exit Sub
    End If
    
    If novo Then
        sql = "INSERT INTO tab_usuario (Usuario, Nome, Email, Senha, form_parametro, form_protocolo, " & _
                                        "form_programa, form_contador, form_camarafria, form_material, form_usuario, " & _
                                        "form_fieldbook, form_retiradacamara, form_imprimirsaquinho, " & _
                                        "form_iniciarcontagem, form_checkcontagem, form_retornocamara, " & _
                                        "form_checksorteio, form_imprimirbuffers, form_mapawinterstiger, " & _
                                        "form_balancomassa, form_statusfields, form_balancomateriais, Admin) " & _
                    "VALUES ('" & edtUsuario.Text & "','" & edtNome.Text & "','" & edtEmail.Text & "','" & _
                            edtSenha.Text & "'," & chkParametro & "," & chkProtocolo & ", " & chkPrograma & ", " & _
                            chkContador & "," & chkCamaraFria & "," & chkMaterial & "," & chkUsuario & "," & _
                            chkFieldBook & "," & chkRetiradaCamara & "," & chkImprimirSaquinho & "," & _
                            chkIniciarContagem & "," & chkCheckContagem & "," & chkRetornoMaterial & "," & _
                            chkCheckSorteio & "," & chkImprimirBuffer & "," & chkMapaWinterStiger & "," & _
                            chkBalancoMassa & "," & chkStatusFields & "," & chkBalancoMaterial & "," & chkAdmin & ")"
    Else
        sql = "UPDATE tab_usuario SET Nome= '" & edtNome.Text & "', " & _
                                      "Email = '" & edtEmail.Text & "', " & _
                                      "Senha = '" & edtSenha.Text & "', " & _
                                      "form_parametro = " & chkParametro & ", " & _
                                      "form_protocolo = " & chkProtocolo & ", " & _
                                      "form_programa = " & chkPrograma & ", " & _
                                      "form_contador = " & chkContador & ", " & _
                                      "form_camarafria = " & chkCamaraFria & ", " & _
                                      "form_material = " & chkMaterial & ", " & _
                                      "form_usuario = " & chkUsuario & ", " & _
                                      "form_fieldbook = " & chkFieldBook & ", " & _
                                      "form_retiradacamara = " & chkRetiradaCamara & ", " & _
                                      "form_imprimirsaquinho = " & chkImprimirSaquinho & ", " & _
                                      "form_iniciarcontagem = " & chkIniciarContagem & ", " & _
                                      "form_checkcontagem = " & chkCheckContagem & ", " & _
                                      "form_retornocamara = " & chkRetornoMaterial & ", " & _
                                      "form_checksorteio = " & chkCheckSorteio & ", " & _
                                      "form_imprimirbuffers = " & chkImprimirBuffer & ", " & _
                                      "form_mapawinterstiger = " & chkMapaWinterStiger & ", " & _
                                      "form_balancomassa = " & chkBalancoMassa & ", " & _
                                      "form_statusfields = " & chkStatusFields & ", " & _
                                      "form_balancomateriais = " & chkBalancoMaterial & ", " & _
                                      "Admin = " & chkAdmin & " " & _
              "WHERE Usuario = '" & edtUsuario.Text & "'"
    End If
    
    con.Execute sql
            
    Mostra_Cadastrados
    
    Habilita_Campos False
End Sub

Private Sub Excluir_Dados()
    Dim sql As String
    
    If edtUsuario.Text <> "" Then
        If MsgBox("Deseja realmente excluir este usu|fffd|rio ?", vbYesNo + vbInformation + vbDefaultButton2, "Exclus|fffd|o") = vbYes Then
            sql = "DELETE * FROM tab_usuario WHERE Usuario = '" & edtUsuario & "'"
            con.Execute sql
        End If
            
        Limpa_Campos
        Habilita_Campos False
        Mostra_Cadastrados
    End If
End Sub
Attribute VB_Name = "form_ususenha"
Attribute VB_Base = "0{397B1E39-ED77-48D9-A0F9-F36C3733F89A}{6F1C40B1-C4D6-4B3D-9B52-C79C5E38A52B}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = False
Private Sub btnOk_Click()
    Dim rs As ADODB.Recordset
    
    If edtUsuario = "" Then Exit Sub
    If edtSenha = "" Then Exit Sub
    
    Set rs = New ADODB.Recordset
    rs.Open "SELECT * FROM tab_usuario WHERE usuario='" & edtUsuario & "' and senha='" & edtSenha & "'", con
    
    If rs.EOF Then
        MsgBox "Usu|fffd|rio/Senha Inv|fffd|lido!", vbOKOnly + vbInformation, "Aten|fffd||fffd|o"
        form_checkcontagem.Admin = ""
    Else
        If rs("Admin") Then
            form_checkcontagem.Admin = "Sim"
        
        Else
            form_checkcontagem.Admin = "Nao"
        End If
    End If
    
    rs.Close
    Set rs = Nothing
    
    Unload Me
End Sub


INQUEST-PP=macro
