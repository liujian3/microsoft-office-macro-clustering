Attribute VB_Name = "HeatmapR"
Sub Heatmap_rischi_2()

Dim NomeLeg As String
Dim Severity As String
Dim Severity_ref As String


n = 4
k = 1
j = 1
r = 4



Severity_ref = Sheets("Assumptions").Range("Soglia_Liv_Rischio").Value
Severity_ref_val = Application.WorksheetFunction.HLookup(Severity_ref, Sheets("RECAP_scenari_rischio").Range("AK2:AO3"), 2, False) ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!

Sheets("Heatmap_scenari_rischio").Activate
Columns("AA:AC").Select
Selection.EntireColumn.Hidden = False

Range(Cells(4, 27), Cells(200, 29)).Select
Selection.ClearContents
ActiveSheet.ChartObjects("heatmap").Activate

    Do Until ActiveChart.SeriesCollection.Count = 0

         ActiveChart.SeriesCollection(1).Delete

    Loop
    
    'Copia il RECAP
    
    Sheets("RECAP_scenari_HM").Select
    Cells.Select
    Selection.Clear
    Sheets("RECAP_scenari_rischio").Select
    Cells.Select
    Selection.Copy
    Sheets("RECAP_scenari_HM").Select
    Cells.Select
    ActiveSheet.Paste


 'ESEGUE IL SORT RISPETTO AL RANK
    Range("A3").Select
    Range(Selection, Selection.End(xlToRight)).Select
    Range(Selection, Selection.End(xlDown)).Select
    ActiveWorkbook.Worksheets("RECAP_scenari_HM").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("RECAP_scenari_HM").Sort.SortFields.Add Key:=Range( _
        "A4", Range("A4").End(xlDown)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
        xlSortNormal
    With ActiveWorkbook.Worksheets("RECAP_scenari_HM").Sort
        .SetRange Range("A3", Range("AH3").End(xlDown))
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With

   'Cancella gli scenari che non rispettano i parametri
    Do Until Cells(r, 1) = ""
        Severity = Sheets("RECAP_scenari_HM").Cells(r, 30).Value
        Severity_val = Application.WorksheetFunction.HLookup(Severity, Sheets("RECAP_scenari_HM").Range("AK2:AO3"), 2, False) ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
        
        ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
        If Sheets("RECAP_scenari_HM").Cells(r, 27).Value >= Sheets("Assumptions").Range("Soglia_Imp").Value And Sheets("RECAP_scenari_HM").Cells(r, 28).Value >= Sheets("Assumptions").Range("Soglia_Prob").Value And Sheets("RECAP_scenari_HM").Cells(r, 29).Value >= Sheets("Assumptions").Range("Soglia_PRD").Value And Severity_val >= Severity_ref_val Then
        r = r + 1
        Else
        Sheets("RECAP_scenari_HM").Rows(r).EntireRow.Delete
        End If
    Loop

Sheets("Heatmap_scenari_rischio").Activate
i = 4
Do Until Sheets("RECAP_scenari_HM").Cells(i, 1).Value = ""

' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
Cells(i, 27).Formula = ("=IF(RAND()<0.5,VALUE(LEFT(RECAP_scenari_HM!T" & i & ",1))+0.35*RAND(),VALUE(LEFT(RECAP_scenari_HM!T" & i & ",1))-0.35*RAND())")
Cells(i, 28).Formula = ("=IF(RAND()<0.5,VALUE(LEFT(RECAP_scenari_HM!U" & i & ",1))+0.35*RAND(),VALUE(LEFT(RECAP_scenari_HM!U" & i & ",1))-0.35*RAND())")
Cells(i, 29).Formula = ("=VALUE(LEFT(RECAP_scenari_HM!X" & i & ",1))+1")

i = i + 1
Loop

Application.Calculate

Sheets("RECAP_scenari_HM").Activate
Do Until Cells(n, 1) = ""

Sheets("RECAP_scenari_HM").Activate

' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
NomeLeg = Cells(n, 6).Value

k = Cells(n, 1).Value
    
Sheets("Heatmap_scenari_rischio").Activate
ActiveSheet.ChartObjects("heatmap").Activate

ActiveChart.PlotArea.Select
ActiveChart.SeriesCollection.NewSeries

    With ActiveChart.SeriesCollection(j)
    
    .Name = k & " - " & NomeLeg 'Numero di riferimento + Nome della serie che serve anche alla legenda
    .XValues = Sheets("Heatmap_scenari_rischio").Cells(n, 27)
    .Values = Sheets("Heatmap_scenari_rischio").Cells(n, 28)
    .BubbleSizes = Sheets("Heatmap_scenari_rischio").Cells(n, 29)
    
    If Sheets("RECAP_scenari_HM").Cells(n, 16).Value = Sheets("Assumptions").Range("Imp_immagine").Value Then
        .Interior.Color = RGB(54, 96, 146)
        .Border.Color = RGB(150, 150, 150)
    ElseIf Sheets("RECAP_scenari_HM").Cells(n, 16).Value = Sheets("Assumptions").Range("Economico_finanziario_qualitativo").Value Then
        .Interior.Color = RGB(255, 255, 255)
        .Border.Color = RGB(150, 150, 150)
    ElseIf Sheets("RECAP_scenari_HM").Cells(n, 16).Value = Sheets("Assumptions").Range("Economico_finanziario_quantitativo").Value Then
        .Interior.Color = RGB(255, 255, 255)
        .Border.Color = RGB(150, 150, 150)
    End If
    
    .Format.Line.Weight = 2
    
    .Points(1).HasDataLabel = True 'Definizione del nome della Label
    .Points(1).DataLabel.Text = k

    End With
    

 With ActiveChart.SeriesCollection(j).DataLabels.Font
 
    If Sheets("RECAP_scenari_HM").Cells(n, 16).Value = Sheets("Assumptions").Range("Imp_immagine").Value Then
        .Color = RGB(255, 255, 255)
        .FontStyle = "Bold"
    ElseIf Sheets("RECAP_scenari_HM").Cells(n, 16).Value = Sheets("Assumptions").Range("Economico_finanziario_qualitativo").Value Then
        .Color = RGB(0, 0, 0)
        .FontStyle = "Bold"
    ElseIf Sheets("RECAP_scenari_HM").Cells(n, 16).Value = Sheets("Assumptions").Range("Economico_finanziario_quantitativo").Value Then
        .Color = RGB(0, 0, 0)
        .FontStyle = "Bold"
    End If

  End With

ActiveChart.SetElement (msoElementDataLabelCenter)

Sheets("RECAP_scenari_HM").Activate
j = j + 1
n = n + 1

Loop

Sheets("Heatmap_scenari_rischio").Activate
Columns("AA:AC").Select
Selection.EntireColumn.Hidden = True

Sheets("Heatmap_scenari_rischio").Activate
Sheets("Heatmap_scenari_rischio").Cells(1, 1).Select


End Sub

Attribute VB_Name = "HeatmapT"
Sub Heatmap_tipologie()

n = 3
j = 1
i = 3

Sheets("Tipologie").Activate
Range("A82:B115").Select
Selection.ClearContents
ActiveSheet.ChartObjects("heatmap_tipologie").Activate

    Do Until ActiveChart.SeriesCollection.Count = 0

         ActiveChart.SeriesCollection(1).Delete

    Loop
    

Sheets("Tipologie").Activate

ActiveSheet.Rows("82:115").Hidden = False

    Do Until i = 36
    Cells(i + 79, 1).Formula = ("=IF(RAND()<0.5,VALUE(LEFT(Tipologie!E" & i & ",1))+0.35*RAND(),VALUE(LEFT(Tipologie!E" & i & ",1))-0.35*RAND())")
    Cells(i + 79, 2).Formula = ("=IF(RAND()<0.5,VALUE(LEFT(Tipologie!F" & i & ",1))+0.35*RAND(),VALUE(LEFT(Tipologie!F" & i & ",1))-0.35*RAND())")
    i = i + 1
    Loop

ActiveSheet.Rows("82:115").Hidden = True

Application.Calculate


Do Until Cells(n, 1) = ""

      
ActiveSheet.ChartObjects("heatmap_tipologie").Activate
ActiveChart.PlotArea.Select
ActiveChart.SeriesCollection.NewSeries

    With ActiveChart.SeriesCollection(j)
    
    .Name = Sheets("Tipologie").Cells(n, 1)
    .XValues = Sheets("Tipologie").Cells(n + 79, 1)
    .Values = Sheets("Tipologie").Cells(n + 79, 2)
    .BubbleSizes = Sheets("Tipologie").Cells(n, 10)
    .Interior.Color = RGB(0, 102, 204)
    .Border.Color = RGB(255, 255, 255)
    .Format.Line.Weight = 2
    
    .Points(1).HasDataLabel = True 'Definizione del nome della Label
    .Points(1).DataLabel.Text = Left(Sheets("Tipologie").Cells(n, 2), 3) & vbCr & Sheets("Tipologie").Cells(n, 4)
    .DataLabels.Font.Size = 8
    .DataLabels.Font.Bold = True
    .DataLabels.Font.Color = RGB(255, 255, 255)
    .DataLabels.Position = xlLabelPositionCenter
    
    End With
    
ActiveChart.SetElement (msoElementDataLabelCenter)
    
j = j + 1
n = n + 1


Loop



End Sub
Attribute VB_Name = "Main"
 Sub Aggiornamento_assessment()

    Dim MyFile        As String
    Dim AssTool       As String
    Dim anyWS         As Worksheet
      
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    Application.DisplayAlerts = False
    AssTool = Application.ActiveWorkbook.Name
    
    'Toglie la protezione da tutti gli sheet
    Sheets("Assumptions").Unprotect Password:="123"
    Sheets("RECAP_scenari_rischio").Unprotect Password:="123"
    Sheets("RECAP_mitigazioni").Unprotect Password:="123"
    Sheets("Heatmap_scenari_rischio").Unprotect Password:="123"
    Sheets("Statistiche").Unprotect Password:="123"
    Sheets("modello_dei_rischi").Unprotect Password:="123"
    Sheets("Tipologie").Unprotect Password:="123"
    Sheets("Presidi vs Azioni").Unprotect Password:="123"
    Sheets("Impatti_categorie_tipologie").Unprotect Password:="123"
    Sheets("Impatto_atteso").Unprotect Password:="123"
    Sheets("Impatto_atteso_grafici").Unprotect Password:="123"
    Sheets("Indicatore sintetico di rischio").Unprotect Password:="123"
    Sheets("RECAP_scenari_rischio_old").Unprotect Password:="123"
        
    'Scopre tutti i fogli di supporto nascosti
    Sheets("RECAP_scenari_rischio_copia").Visible = True
    Sheets("RECAP_mitigazioni_copia").Visible = True
    Sheets("Impatto_atteso_copia").Visible = True
    Sheets("RECAP_scenari_HM").Visible = True

    'Pulisce da eventuali filtri nei DB
    Sheets("RECAP_scenari_rischio").Select
    Sheets("RECAP_scenari_rischio").Range("A3:AH3").Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Selection.AutoFilter
    Selection.AutoFilter
    
    Sheets("RECAP_mitigazioni").Select
    Sheets("RECAP_mitigazioni").Range("A3:AA3").Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Selection.AutoFilter
    Selection.AutoFilter
    
    'pulisce RECAP_scenari_rischio
    Sheets("RECAP_scenari_rischio").Select
    Sheets("RECAP_scenari_rischio").Range("5:1000").Select
    Selection.Delete
    Sheets("RECAP_scenari_rischio").Range(Cells(4, 1), Cells(4, 21)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Selection.ClearContents
    Sheets("RECAP_scenari_rischio").Range(Cells(4, 24), Cells(4, 29)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Selection.ClearContents
    Sheets("RECAP_scenari_rischio").Range(Cells(4, 31), Cells(4, 31)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Selection.ClearContents

    'pulisce RECAP_mitigazioni
    Sheets("RECAP_mitigazioni").Select
    Sheets("RECAP_mitigazioni").Range("5:1000").Select
    Selection.Delete
    Sheets("RECAP_mitigazioni").Range(Cells(4, 1), Cells(4, 16)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Selection.ClearContents
    Sheets("RECAP_mitigazioni").Range(Cells(4, 19), Cells(4, 27)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Selection.ClearContents
        
    'pulisce Impatto_atteso
    Sheets("Impatto_atteso").Select
    Sheets("Impatto_atteso").Range("5:1000").Select
    Selection.Delete
    Sheets("Impatto_atteso").Range(Cells(4, 1), Cells(4, 7)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Selection.ClearContents
    Sheets("Impatto_atteso").Range(Cells(4, 11), Cells(4, 13)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Selection.ClearContents
          
    'inizializza i contatori
    Num_ris = 0
    Num_ris_m = 0
    Num_ris_q = 0
    Num_ris_DBaz = 0

    MyFile = Dir(Application.ActiveWorkbook.Path & "\" & "*.xlsm")
        
    Do While MyFile <> ""
        A = Right(MyFile, 29)
        b = Right(MyFile, 33)
        c = Right(MyFile, 33)
         
        If A = "IGS_tool_assessment_ERM.xlsm" Or c = "IGS_tool_assessment_ERM_old.xlsm" Then
        ElseIf b = "IGS_schede_rischio_Template.xlsm" Then
        
             'Aggiorno i link cambiando la sorgente! ATTENZIONE AL NOME DEL TOOL ERM E DELLA SCHEDA TEMPLATE
            '--------------------------------------------------------------------------------------------------------------
            Workbooks.Open Filename:=ActiveWorkbook.Path & "\IGS_schede_rischio_Template.xlsm", UpdateLinks:=3
            Workbooks(MyFile).Activate
        
            vecchio_collegamento = ActiveWorkbook.LinkSources(xlExcelLinks)
            nuovo_collegamento = ActiveWorkbook.Path & "\IGS_tool_assessment_ERM.xlsm"
        
            For Each anyWS In ActiveWorkbook.Worksheets
            
                Nome = anyWS.Name
                             
                If Nome = "List" Then
                Else
                
                    Application.ActiveWorkbook.Sheets(Nome).Select
                    If ActiveSheet.ProtectContents = True Then
                        Sheets(Nome).Unprotect Password:="123"
                    End If
                End If
    
            Next
    
            ActiveWorkbook.ChangeLink Name:=vecchio_collegamento(1), NewName:=nuovo_collegamento, Type:=xlExcelLinks
            
            For Each anyWS In ActiveWorkbook.Worksheets
            
                Nome = anyWS.Name
                             
                If Nome = "List" Then
                Else
                    Application.ActiveWorkbook.Sheets(Nome).Select
                    Sheets(Nome).Protect Password:="123"
                End If
    
            Next
        
            Workbooks(MyFile).Activate
            Application.Calculation = xlCalculationAutomatic
            ActiveWorkbook.Save
            ActiveWorkbook.Close
            Application.Calculation = xlCalculationManual
            '--------------------------------------------------------------------------------------------------------------
        
        Else
            Workbooks.Open Filename:=ActiveWorkbook.Path & "\" & MyFile, UpdateLinks:=3
            Workbooks(MyFile).Activate
            
            'Aggiorno i link cambiando la sorgente! ATTENZIONE AL NOME DEL TOOL ERM
            '--------------------------------------------------------------------------------------------------------------
            vecchio_collegamento = ActiveWorkbook.LinkSources(xlExcelLinks)
            nuovo_collegamento = ActiveWorkbook.Path & "\IGS_tool_assessment_ERM.xlsm"
    
            For Each anyWS In ActiveWorkbook.Worksheets
            
                Nome = anyWS.Name
                             
                If Nome = "List" Then
                Else
                
                    Application.ActiveWorkbook.Sheets(Nome).Select
                    If ActiveSheet.ProtectContents = True Then
                        Sheets(Nome).Unprotect Password:="123"
                    End If
                End If
    
            Next
    
            ActiveWorkbook.ChangeLink Name:=vecchio_collegamento(1), NewName:=nuovo_collegamento, Type:=xlExcelLinks
            '--------------------------------------------------------------------------------------------------------------
                
            For Each anyWS In ActiveWorkbook.Worksheets
            
                Nome = anyWS.Name
                
                'Tolgo la protezione allo sheet relativo allo scenario di rischio oggetto di analisi
                               
                If Nome = "List" Then
                Else
                
                    Application.ActiveWorkbook.Sheets(Nome).Select
                    If ActiveSheet.ProtectContents = True Then
                        Sheets(Nome).Unprotect Password:="123"
                    End If
            
                    Workbooks(AssTool).Activate
                    Sheets("RECAP_scenari_rischio").Select
                    Range(Cells(4, 1), Cells(4, 34)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
                    Selection.Copy
                    Sheets("RECAP_scenari_rischio").Range(Cells(4 + Num_ris, 1), Cells(4 + Num_ris, 34)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
                    ActiveSheet.Paste
            
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 1).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Num").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 2).Value = Workbooks(AssTool).Sheets("Assumptions").Range("Anno_Assessment").Value & "_" & Workbooks(AssTool).Sheets("Assumptions").Range("Numero_Assessment").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 3).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Driver").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 4).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Categoria").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 5).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Tipo").Value
            
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 6).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Nome").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 7).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Descr").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 8).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_SocOpe").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 9).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Ambito").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 10).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_OrizzTemp").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 11).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Proc").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 12).Value = Workbooks(MyFile).Sheets(Nome).Range("ScenarioESG").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 13).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Mat").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 14).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_FocalPointERM").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 15).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_RiskOwner").Value
            
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 16).Value = Workbooks(MyFile).Sheets(Nome).Range("Impatto_Tipo").Value
            
                    If Workbooks(MyFile).Sheets(Nome).Range("Impatto_Su").Value = "" Then
                        Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 17).Value = "N/A"
                    Else
                        Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 17).Value = Workbooks(MyFile).Sheets(Nome).Range("Impatto_Su").Value
                    End If
                
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 18).Value = Workbooks(MyFile).Sheets(Nome).Range("ImpattoCum_PFN_Y4").Value  'Aggiornare sempre con l'ultimo anno cumulato di PFN
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 19).Value = Workbooks(MyFile).Sheets(Nome).Range("Prob_Quant").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 20).Value = Workbooks(MyFile).Sheets(Nome).Range("Impatto_Num").Value & " - " & Workbooks(MyFile).Sheets(Nome).Range("Impatto").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 21).Value = Workbooks(MyFile).Sheets(Nome).Range("Prob_Num").Value & " - " & Workbooks(MyFile).Sheets(Nome).Range("Prob").Value
            
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 24).Value = Workbooks(MyFile).Sheets(Nome).Range("PRD_Num").Value & " - " & Workbooks(MyFile).Sheets(Nome).Range("Presidio").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 25).Value = Workbooks(MyFile).Sheets(Nome).Range("Strategia").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 27).Value = Workbooks(MyFile).Sheets(Nome).Range("Impatto_Num").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 28).Value = Workbooks(MyFile).Sheets(Nome).Range("Prob_Num").Value
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 29).Value = Workbooks(MyFile).Sheets(Nome).Range("PRD_Num").Value
            
                    Workbooks(AssTool).Sheets("RECAP_scenari_rischio").Cells(4 + Num_ris, 26).Select
            
                    With Workbooks(AssTool).Sheets("RECAP_scenari_rischio")
                        .Hyperlinks.Add Anchor:=.Cells(4 + Num_ris, 26), _
                        Address:=MyFile, _
                        SubAddress:=Nome & "!A1", _
                        TextToDisplay:="Vai"
                    End With
            
                    'Scrive in RECAP_mitigazioni
            
                    Workbooks(AssTool).Activate
                    Sheets("RECAP_mitigazioni").Select
                    Range(Cells(4, 1), Cells(4, 27)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
                    Selection.Copy
                    Sheets("RECAP_mitigazioni").Range(Cells(4 + Num_ris_m, 1), Cells(4 + Num_ris_m, 27)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
                    ActiveSheet.Paste
            
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 1).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Num").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 2).Value = Workbooks(AssTool).Sheets("Assumptions").Range("Anno_Assessment").Value & "_" & Workbooks(AssTool).Sheets("Assumptions").Range("Numero_Assessment").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 3).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Driver").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 4).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Categoria").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 5).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Tipo").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 6).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Nome").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 7).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_SocOpe").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 8).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Ambito").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 9).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_OrizzTemp").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 10).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Proc").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 11).Value = Workbooks(MyFile).Sheets(Nome).Range("ScenarioESG").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 12).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Mat").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 13).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_FocalPointERM").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 14).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_RiskOwner").Value
            
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 15).Value = Workbooks(MyFile).Sheets(Nome).Range("Impatto_Num").Value & " - " & Workbooks(MyFile).Sheets(Nome).Range("Impatto").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 16).Value = Workbooks(MyFile).Sheets(Nome).Range("Prob_Num").Value & " - " & Workbooks(MyFile).Sheets(Nome).Range("Prob").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 19).Value = Workbooks(MyFile).Sheets(Nome).Range("PRD_Num").Value & " - " & Workbooks(MyFile).Sheets(Nome).Range("Presidio").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 20).Value = Workbooks(MyFile).Sheets(Nome).Range("Strategia").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 21).Value = Workbooks(MyFile).Sheets(Nome).Range("Azione_Num_1").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 22).Value = Workbooks(MyFile).Sheets(Nome).Range("Azione_1").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 23).Value = Workbooks(MyFile).Sheets(Nome).Range("ActOwner_1").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 24).Value = Workbooks(MyFile).Sheets(Nome).Range("StartDate_1").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 25).Value = Workbooks(MyFile).Sheets(Nome).Range("Status_1").Value
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 26).Value = Workbooks(MyFile).Sheets(Nome).Range("DueDate_1").Value
         
                    Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 27).Select
                    ' ActiveCell.Formula = "=HYPERLINK(""#" & "'[" & MyFile & "]" & Nome & "'!A1"",""Vai"")"
            
                    With Workbooks(AssTool).Sheets("RECAP_mitigazioni")
                        .Hyperlinks.Add Anchor:=.Cells(4 + Num_ris_m, 27), _
                        Address:=MyFile, _
                        SubAddress:=Nome & "!A1", _
                        TextToDisplay:="Vai"
                    End With
            
                    Num_ris_m = Num_ris_m + 1
            
                    num_act = 2
                    For num_act = 2 To 4
                
                        If Workbooks(MyFile).Sheets(Nome).Range("Azione_" & num_act).Value <> "" Then
            
                            Workbooks(AssTool).Activate
                            Sheets("RECAP_mitigazioni").Select
                            Range(Cells(4, 1), Cells(4, 27)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
                            Selection.Copy
                            Sheets("RECAP_mitigazioni").Range(Cells(4 + Num_ris_m, 1), Cells(4 + Num_ris_m, 27)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
                            ActiveSheet.Paste
            
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 1).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Num").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 2).Value = Workbooks(AssTool).Sheets("Assumptions").Range("Anno_Assessment").Value & "_" & Workbooks(AssTool).Sheets("Assumptions").Range("Numero_Assessment").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 3).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Driver").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 4).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Categoria").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 5).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Tipo").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 6).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Nome").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 7).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_SocOpe").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 8).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Ambito").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 9).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_OrizzTemp").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 10).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Proc").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 11).Value = Workbooks(MyFile).Sheets(Nome).Range("ScenarioESG").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 12).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Mat").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 13).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_FocalPointERM").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 14).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_RiskOwner").Value
            
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 15).Value = Workbooks(MyFile).Sheets(Nome).Range("Impatto_Num").Value & " - " & Workbooks(MyFile).Sheets(Nome).Range("Impatto").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 16).Value = Workbooks(MyFile).Sheets(Nome).Range("Prob_Num").Value & " - " & Workbooks(MyFile).Sheets(Nome).Range("Prob").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 19).Value = Workbooks(MyFile).Sheets(Nome).Range("PRD_Num").Value & " - " & Workbooks(MyFile).Sheets(Nome).Range("Presidio").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 20).Value = Workbooks(MyFile).Sheets(Nome).Range("Strategia").Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 21).Value = Workbooks(MyFile).Sheets(Nome).Range("Azione_Num_" & num_act).Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 22).Value = Workbooks(MyFile).Sheets(Nome).Range("Azione_" & num_act).Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 23).Value = Workbooks(MyFile).Sheets(Nome).Range("ActOwner_" & num_act).Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 24).Value = Workbooks(MyFile).Sheets(Nome).Range("StartDate_" & num_act).Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 25).Value = Workbooks(MyFile).Sheets(Nome).Range("Status_" & num_act).Value
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 26).Value = Workbooks(MyFile).Sheets(Nome).Range("DueDate_" & num_act).Value
                        
                            Workbooks(AssTool).Sheets("RECAP_mitigazioni").Cells(4 + Num_ris_m, 27).Select
                            ' ActiveCell.Formula = "=HYPERLINK(""#" & "'[" & MyFile & "]" & Nome & "'!A1"",""Vai"")"
            
                            With Workbooks(AssTool).Sheets("RECAP_mitigazioni")
                                .Hyperlinks.Add Anchor:=.Cells(4 + Num_ris_m, 27), _
                                Address:=MyFile, _
                                SubAddress:=Nome & "!A1", _
                                TextToDisplay:="Vai"
                            End With
            
                            Num_ris_m = Num_ris_m + 1
            
                        Else
                        End If
            
                    Next
            
                    'Compilo lo sheet Impatto atteso
            
                    If Workbooks(MyFile).Sheets(Nome).Range("Impatto_Tipo").Value = "Economic-financial quantitative" Then
                        Workbooks(AssTool).Activate
                        Sheets("Impatto_atteso").Select
                        Range(Cells(4, 1), Cells(4, 20)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
                        Selection.Copy
                        Sheets("Impatto_atteso").Range(Cells(4 + Num_ris_q, 1), Cells(4 + Num_ris_q, 20)).Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
                        ActiveSheet.Paste
            
                        Workbooks(AssTool).Sheets("Impatto_atteso").Cells(4 + Num_ris_q, 1).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Num").Value
                        Workbooks(AssTool).Sheets("Impatto_atteso").Cells(4 + Num_ris_q, 2).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Tipo").Value
                        Workbooks(AssTool).Sheets("Impatto_atteso").Cells(4 + Num_ris_q, 3).Value = Workbooks(MyFile).Sheets(Nome).Range("Scenario_Nome").Value
                        Workbooks(AssTool).Sheets("Impatto_atteso").Cells(4 + Num_ris_q, 4).Value = Workbooks(MyFile).Sheets(Nome).Range("Prob_Quant").Value
                        Workbooks(AssTool).Sheets("Impatto_atteso").Cells(4 + Num_ris_q, 5).Value = Workbooks(MyFile).Sheets(Nome).Range("Impatto_EBITDA_Y1").Value
                        Workbooks(AssTool).Sheets("Impatto_atteso").Cells(4 + Num_ris_q, 6).Value = Workbooks(MyFile).Sheets(Nome).Range("Impatto_EBITDA_Y2").Value
                        Workbooks(AssTool).Sheets("Impatto_atteso").Cells(4 + Num_ris_q, 7).Value = Workbooks(MyFile).Sheets(Nome).Range("Impatto_EBITDA_Y3").Value
                        Workbooks(AssTool).Sheets("Impatto_atteso").Cells(4 + Num_ris_q, 8).Value = Workbooks(MyFile).Sheets(Nome).Range("Impatto_EBITDA_Y4").Value
                         
                        Workbooks(AssTool).Sheets("Impatto_atteso").Cells(4 + Num_ris_q, 13).Value = Workbooks(MyFile).Sheets(Nome).Range("ImpattoCum_PFN_Y1").Value
                        Workbooks(AssTool).Sheets("Impatto_atteso").Cells(4 + Num_ris_q, 14).Value = Workbooks(MyFile).Sheets(Nome).Range("ImpattoCum_PFN_Y2").Value
                        Workbooks(AssTool).Sheets("Impatto_atteso").Cells(4 + Num_ris_q, 15).Value = Workbooks(MyFile).Sheets(Nome).Range("ImpattoCum_PFN_Y3").Value
                        Workbooks(AssTool).Sheets("Impatto_atteso").Cells(4 + Num_ris_q, 16).Value = Workbooks(MyFile).Sheets(Nome).Range("ImpattoCum_PFN_Y4").Value

                        Num_ris_q = Num_ris_q + 1
                    Else
                    End If
                 
                    Num_ris = Num_ris + 1
                    
                    Workbooks(MyFile).Activate
                    If ActiveSheet.ProtectContents = True Then
                        Sheets(Nome).Protect Password:="123"
                    End If
        
                End If
                
                Sheets(Nome).Protect Password:="123"
                  
            Next
            
            Workbooks(MyFile).Activate
            Application.Calculation = xlCalculationAutomatic
            ActiveWorkbook.Save
            ActiveWorkbook.Close
            Application.Calculation = xlCalculationManual
            
        End If
        
        MyFile = Dir()
    
    Loop
      
    'crea scenari rischio old
    Workbooks(AssTool).Activate
    Sheets("RECAP_scenari_rischio_old").Select
    Sheets("RECAP_scenari_rischio_old").Range("4:1000").Select
    Selection.ClearContents
        
    MyFile2 = Dir(Application.ActiveWorkbook.Path & "\" & "IGS_tool_assessment_ERM_old.xlsm")
    
    Workbooks.Open Filename:=ActiveWorkbook.Path & "\" & MyFile2
    Workbooks(MyFile2).Activate
    Sheets("RECAP_scenari_rischio").Select
    Range("4:1000").Select
    Selection.Copy
    Workbooks(AssTool).Activate
    Sheets("RECAP_scenari_rischio_old").Select
    Sheets("RECAP_scenari_rischio_old").Range("A4").Select
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    Sheets("RECAP_scenari_rischio_old").Cells(1, 1).Select
    Workbooks(MyFile2).Activate
    'ActiveWorkbook.Save
    ActiveWorkbook.Close
     
    Application.Calculation = xlCalculationAutomatic
  
    'Crea il ranking degli scenari ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Workbooks(AssTool).Activate
    Sheets("RECAP_scenari_rischio").Select

    Range("T3", Range("T3").End(xlDown)).Copy
    Range("AI3").PasteSpecial Paste:=xlPasteValues

    Range("A3:AI3").Select
    Range(Selection, Selection.End(xlDown)).Select

    ActiveWorkbook.Worksheets("RECAP_scenari_rischio").Sort.SortFields.Clear
    ActiveWorkbook.Worksheets("RECAP_scenari_rischio").Sort.SortFields.Add Key:=Range("AI4", Range("AI4").End(xlDown)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    ActiveWorkbook.Worksheets("RECAP_scenari_rischio").Sort.SortFields.Add Key:=Range("AA4", Range("AA4").End(xlDown)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    ActiveWorkbook.Worksheets("RECAP_scenari_rischio").Sort.SortFields.Add Key:=Range("AB4", Range("AB4").End(xlDown)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    ActiveWorkbook.Worksheets("RECAP_scenari_rischio").Sort.SortFields.Add Key:=Range("AC4", Range("AC4").End(xlDown)), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    With ActiveWorkbook.Worksheets("RECAP_scenari_rischio").Sort
        .SetRange Range("A3", Range("AI3").End(xlDown))
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
      
    Range("AE4").Value = 1
    
    'I due if introdotti nel seguito servono solamente per far girare il tool anche con 1 o 2 scenari. Il contenuto degli if, invece, |fffd| necessario
    'al normale funzionamento del tool (con numero di scenari a piacere)
    
    If Range("A5") <> "" Then
      
        Range("AE5").Formula = "=+IF(AND(AA5=AA4,AB5=AB4,AC5=AC4),AE4,AE4+1)"
        
        If Range("A6") <> "" Then
            Range("AE5").Select
            Selection.AutoFill Destination:=Range("AE5", Range("AE" & Num_ris + 3)), Type:=xlFillDefault
        End If
      
        Range("AE5", Range("AE" & Num_ris + 3)).Select
        Selection.Copy
        Range("AE5", Range("AE" & Num_ris + 3)).PasteSpecial Paste:=xlPasteValues
    
    End If
        
    Range("AI3", Range("AI3").End(xlDown)).ClearContents


    'Copiamo gli sheet di RECAP negli analoghi sheet per valori, ai quali punteranno le formule del tool

    'RECAP_scenari_rischio
    Sheets("RECAP_scenari_rischio_copia").Select
    Range("A4:AN4").Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Range(Selection, Selection.End(xlDown)).Select
    Selection.Clear
    Sheets("RECAP_scenari_rischio").Select
    If Range("A5") = "" Then
        Range("A4:AO4").Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
        Selection.Copy
    Else
        Range("A4:AO4").Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
        Range(Selection, Selection.End(xlDown)).Select
        Selection.Copy
    End If
    Sheets("RECAP_scenari_rischio_copia").Select
    Range("A4").Select
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    Selection.PasteSpecial Paste:=xlPasteFormats, Operation:=xlNone, _
        SkipBlanks:=False, Transpose:=False

    'RECAP_mitigazioni
    Sheets("RECAP_mitigazioni_copia").Select
    Range("A4:AB4").Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Range(Selection, Selection.End(xlDown)).Select
    Selection.Clear
    Sheets("RECAP_mitigazioni").Select
    If Range("A5") = "" Then
        Range("A4:AB4").Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
        Selection.Copy
    Else
        Range("A4:AB4").Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
        Range(Selection, Selection.End(xlDown)).Select
        Selection.Copy
    End If
    Sheets("RECAP_mitigazioni_copia").Select
    Range("A4").Select
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    Selection.PasteSpecial Paste:=xlPasteFormats, Operation:=xlNone, _
        SkipBlanks:=False, Transpose:=False

    'Impatto_atteso
    Sheets("Impatto_atteso_copia").Select
    Range("A4:T4").Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
    Range(Selection, Selection.End(xlDown)).Select
    Selection.Clear
    Sheets("Impatto_atteso").Select
    If Range("A5") = "" Then
        Range("A4:T4").Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
        Selection.Copy
    Else
        Range("A4:T4").Select ' ATTENZIONE: se si aggiungono colonne alla tabella, modificare il riferimento!!!!!
        Range(Selection, Selection.End(xlDown)).Select
        Selection.Copy
    End If
    Sheets("Impatto_atteso_copia").Select
    Range("A4").Select
    Selection.PasteSpecial Paste:=xlPasteValues, Operation:=xlNone, SkipBlanks _
        :=False, Transpose:=False
    Selection.PasteSpecial Paste:=xlPasteFormats, Operation:=xlNone, _
        SkipBlanks:=False, Transpose:=False
        
    Call Heatmap_rischi_2
    Call Heatmap_tipologie

    ' Copre tuttti i fogli di supporto
    Sheets("RECAP_scenari_rischio_copia").Visible = False
    Sheets("RECAP_mitigazioni_copia").Visible = False
    Sheets("Impatto_atteso_copia").Visible = False
    Sheets("RECAP_scenari_HM").Visible = False

    Application.Calculation = xlCalculationManual

    Sheets("RECAP_scenari_rischio").Activate
    Sheets("RECAP_scenari_rischio").Cells(1, 1).Select

    Sheets("RECAP_mitigazioni").Activate
    Sheets("RECAP_mitigazioni").Cells(1, 1).Select

    Sheets("Heatmap_scenari_rischio").Activate
    Sheets("Heatmap_scenari_rischio").Cells(1, 1).Select

    Sheets("Statistiche").Activate
    Sheets("Statistiche").Cells(1, 1).Select

    Sheets("Tipologie").Activate
    Sheets("Tipologie").Cells(1, 1).Select

    Sheets("Presidi vs Azioni").Activate
    Sheets("Presidi vs Azioni").Cells(1, 1).Select

    Sheets("Impatti_categorie_tipologie").Activate
    Sheets("Impatti_categorie_tipologie").Cells(1, 1).Select

    Sheets("Impatto_atteso").Activate
    Sheets("Impatto_atteso").Cells(1, 1).Select

    Sheets("Impatto_atteso_grafici").Activate
    Sheets("Impatto_atteso_grafici").Cells(1, 1).Select

    Sheets("Indicatore sintetico di rischio").Activate
    Sheets("Indicatore sintetico di rischio").Cells(1, 1).Select

    Sheets("RECAP_scenari_rischio_old").Activate
    Sheets("RECAP_scenari_rischio_old").Cells(1, 1).Select

    Sheets("Assumptions").Activate
    Sheets("Assumptions").Cells(1, 1).Select

    'Inserisco la protezione su tutti gli sheet
    Sheets("Assumptions").Protect Password:="123"
    Sheets("RECAP_scenari_rischio").Protect Password:="123"
    Sheets("RECAP_mitigazioni").Protect Password:="123"
    Sheets("Heatmap_scenari_rischio").Protect Password:="123", DrawingObjects:=False, Contents:=True, Scenarios:=True
    Sheets("Statistiche").Protect Password:="123", DrawingObjects:=False, Contents:=True, Scenarios:=True
    Sheets("modello_dei_rischi").Protect Password:="123"
    Sheets("Tipologie").Protect Password:="123", DrawingObjects:=False, Contents:=True, Scenarios:=True
    Sheets("Presidi vs Azioni").Protect Password:="123", DrawingObjects:=False, Contents:=True, Scenarios:=True
    Sheets("Impatti_categorie_tipologie").Protect Password:="123", DrawingObjects:=False, Contents:=True, Scenarios:=True
    Sheets("Impatto_atteso").Protect Password:="123"
    Sheets("Impatto_atteso_grafici").Protect Password:="123", DrawingObjects:=False, Contents:=True, Scenarios:=True
    Sheets("Indicatore sintetico di rischio").Protect Password:="123", DrawingObjects:=False, Contents:=True, Scenarios:=True
    Sheets("RECAP_scenari_rischio_old").Protect Password:="123"

    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    
    response = MsgBox("Elaborazione ultimata!")

End Sub
Attribute VB_Name = "Sheet1"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet10"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet11"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet13"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet14"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet15"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet16"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet17"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet2"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet3"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet30"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet4"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet5"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet6"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet7"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet8"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "Sheet9"
Attribute VB_Base = "0{00020820-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True
Attribute VB_Name = "ThisWorkbook"
Attribute VB_Base = "0{00020819-0000-0000-C000-000000000046}"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Attribute VB_TemplateDerived = False
Attribute VB_Customizable = True


INQUEST-PP=macro
